<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reputifly | Client Data Parser</title>

    <link rel="icon" type="image/png" href="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        :root {
            --bg-main: #0B0A14;
            --accent-primary: #E6397F;
            --accent-secondary: #FF8A00;
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(20, 20, 30, 0.6);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: #F0F0F0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        h1, h2, .brand-font { font-family: 'Space Grotesk', sans-serif; letter-spacing: -0.02em; }

        /* Glass Panel */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Buttons */
        .liquid-glow {
            background: radial-gradient(circle at top, rgba(255,255,255,0.4) 0%, transparent 60%),
                        linear-gradient(90deg, #E6397F, #FF8A00);
            box-shadow: 0 6px 20px rgba(230, 57, 127, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.4);
            border: none;
            color: white;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .liquid-glow:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(255, 138, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }
        .liquid-glow.disabled { filter: grayscale(1); opacity: 0.5; pointer-events: none; }

        /* Switches */
        .toggle-label { font-size: 10px; font-weight: bold; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin-right: 6px; }
        .toggle-switch {
            position: relative; display: inline-block; width: 32px; height: 18px; vertical-align: middle;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255,255,255,0.1); transition: .4s; border-radius: 34px; border: 1px solid rgba(255,255,255,0.2);
        }
        .slider:before {
            position: absolute; content: ""; height: 10px; width: 10px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--accent-secondary); border-color: var(--accent-secondary); }
        input:checked + .slider:before { transform: translateX(14px); }
        
        .ai-toggle input:checked + .slider { background-color: var(--accent-primary); border-color: var(--accent-primary); }
        .input-active-border { border: 1px solid var(--accent-secondary); }

        /* Settings Modal */
        #settingsModal {
            position: absolute; top: 60px; right: 20px; width: 320px;
            background: #181824; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; padding: 20px; z-index: 50;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: none; opacity: 0; transition: opacity 0.2s;
        }
        #settingsModal.open { display: block; opacity: 1; }

        /* Custom Select */
        .custom-select {
            appearance: none; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 8px 12px; border-radius: 6px; width: 100%; font-size: 12px;
            outline: none; cursor: pointer;
        }
        .custom-select:focus { border-color: var(--accent-secondary); }

        /* Editor */
        #dropZone { flex: 1; padding: 20px; overflow-y: auto; outline: none; color: #9ca3af; font-size: 14px; line-height: 1.6; }
        #dropZone:empty:before { content: "Paste content here (Ctrl+V)..."; color: #4b5563; }
        #dropZone img { opacity: 0.6; max-height: 60px; border: 1px solid #333; border-radius: 4px; margin: 5px 0; }

        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { text-align: left; padding: 12px 16px; background: rgba(255,255,255,0.03); color: #fff; position: sticky; top: 0; backdrop-filter: blur(10px); }
        td { padding: 10px 16px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #9ca3af; vertical-align: top; cursor: help; }
        td img { width: 40px; height: 40px; object-fit: cover; border-radius: 6px; border: 1px solid rgba(255,255,255,0.1); }
        tr:hover td { background: rgba(255,255,255,0.05); color: #fff; }
        
        /* Badges */
        .badge-simple { color: #10B981; border: 1px solid #10B981; padding: 1px 4px; border-radius: 3px; font-size: 9px; text-transform: uppercase; }
        .badge-var { color: #F59E0B; border: 1px solid #F59E0B; padding: 1px 4px; border-radius: 3px; font-size: 9px; text-transform: uppercase; }
        .badge-sale { color: #E6397F; border: 1px solid #E6397F; padding: 1px 4px; border-radius: 3px; font-size: 9px; text-transform: uppercase; margin-left: 4px; }
        .badge-ai { background: linear-gradient(90deg, #E6397F, #FF8A00); -webkit-background-clip: text; color: transparent; font-weight: 800; border: 1px solid #E6397F; padding: 2px 6px; border-radius: 4px; font-size: 10px; }

        /* Loader */
        .loader { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        #toast {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #10B981; color: white; padding: 10px 20px; border-radius: 50px;
            font-size: 12px; font-weight: bold; opacity: 0; transition: all 0.3s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); pointer-events: none; display: flex; align-items: center; gap: 8px; z-index: 100;
        }
        #toast.visible { transform: translateX(-50%) translateY(0); opacity: 1; }

        /* Hover Modal */
        #hoverModal {
            position: fixed; pointer-events: none; z-index: 1000; width: 320px;
            background: rgba(20, 20, 30, 0.95); backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px;
            padding: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            opacity: 0; transform: scale(0.95); transition: opacity 0.15s, transform 0.15s;
            display: flex; flex-direction: column; gap: 10px;
        }
        #hoverModal.visible { opacity: 1; transform: scale(1); }
        #hoverModal img { width: 100%; height: 180px; object-fit: cover; border-radius: 8px; background: #000; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .modal-label { font-size: 10px; color: #6b7280; text-transform: uppercase; font-weight: bold; letter-spacing: 0.05em; margin-bottom: 2px; }
        .modal-value { font-size: 13px; color: #fff; margin-bottom: 8px; line-height: 1.4; word-wrap: break-word; }
        .modal-value.unavailable { color: #52525b; font-style: italic; font-size: 12px; }
        .modal-desc { max-height: 100px; overflow: hidden; position: relative; }
        .modal-desc::after { content: ""; position: absolute; bottom: 0; left: 0; right: 0; height: 30px; background: linear-gradient(to top, rgba(20,20,30,0.95), transparent); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body>

    <div class="ambient-glow glow-top" style="position: absolute; width: 600px; height: 600px; background: radial-gradient(circle, rgba(230, 57, 127, 0.15) 0%, transparent 70%); border-radius: 50%; pointer-events: none; z-index: -1; filter: blur(80px); top: -200px; left: 20%;"></div>
    <div class="ambient-glow glow-bottom" style="position: absolute; width: 600px; height: 600px; background: radial-gradient(circle, rgba(255, 138, 0, 0.1) 0%, transparent 70%); border-radius: 50%; pointer-events: none; z-index: -1; filter: blur(80px); bottom: -200px; right: 20%;"></div>
    <div id="toast"><i data-feather="check" class="w-4 h-4"></i> Copied to Clipboard!</div>

    <div id="hoverModal">
        <img id="modalImg" src="" style="display:none;">
        <div id="modalImgPlaceholder" class="w-full h-32 bg-white/5 rounded flex items-center justify-center text-xs text-gray-600 italic border border-white/5 mb-2">No Image</div>
        
        <div>
            <div class="modal-label">Product Name</div>
            <div id="modalTitle" class="modal-value font-bold text-base"></div>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
            <div>
                <div class="modal-label">Price</div>
                <div id="modalPrice" class="modal-value font-mono text-accent-secondary"></div>
            </div>
            <div>
                <div class="modal-label">Type</div>
                <div id="modalType" class="modal-value"></div>
            </div>
        </div>

        <div id="modalDescContainer">
            <div class="modal-label">Description</div>
            <div id="modalDesc" class="modal-value modal-desc text-gray-400 text-xs"></div>
        </div>
    </div>

    <div id="settingsModal">
        <h4 class="text-white font-bold text-sm mb-4 flex items-center gap-2">
            <i data-feather="sliders" class="w-4 h-4 text-accent-primary"></i> Advanced Settings
        </h4>
        
        <div class="mb-4">
            <label class="block text-[10px] uppercase text-gray-500 font-bold mb-2">Gemini API Key</label>
            <input type="password" id="apiKeyInput" class="w-full bg-black/30 border border-white/10 rounded px-3 py-2 text-xs text-white focus:outline-none focus:border-accent-primary transition-colors" placeholder="Paste Key Here...">
        </div>

        <div class="mb-6">
            <label class="block text-[10px] uppercase text-gray-500 font-bold mb-2">Force Product Type</label>
            <select id="forceTypeSelect" class="custom-select" onchange="updateForceType()">
                <option value="auto">Auto Detect (Recommended)</option>
                <option value="Simple">Force All Simple</option>
                <option value="Variable">Force All Variable</option>
            </select>
            <p class="text-[10px] text-gray-600 mt-1">Overrides AI/Regex detection logic.</p>
        </div>

        <div class="flex justify-end pt-2 border-t border-white/5">
            <button onclick="saveSettings()" class="liquid-glow px-4 py-1.5 rounded-md text-xs font-bold w-full">Save Changes</button>
        </div>
    </div>

    <nav class="w-full h-16 border-b border-white/5 bg-black/20 backdrop-blur-md flex items-center justify-between px-6 z-10 shrink-0">
        <div class="flex items-center gap-4">
            <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png" class="h-6 w-auto object-contain brightness-125">
            <div class="h-4 w-px bg-white/10 mx-2"></div>
            <span class="text-sm font-medium text-gray-400">Client Extractor <span class="text-[10px] bg-accent-primary/20 text-accent-primary px-2 py-0.5 rounded-full border border-accent-primary/30 ml-2">V16</span></span>
        </div>
        
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2 border-r border-white/10 pr-4">
                <span class="toggle-label text-accent-primary">AI Mode</span>
                <label class="toggle-switch ai-toggle">
                    <input type="checkbox" id="aiModeToggle" onchange="toggleAIMode()">
                    <span class="slider"></span>
                </label>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-white ml-2 relative">
                    <i data-feather="settings" class="w-4 h-4"></i>
                    <div id="keyIndicator" class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full"></div>
                </button>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex items-center">
                    <span class="toggle-label">No Desc</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="noDescToggle" checked onchange="toggleNoDesc()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="flex items-center">
                    <span class="toggle-label text-accent-secondary">Append Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="appendModeToggle" onchange="toggleAppendMode()">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <button onclick="clearAll()" class="text-xs text-gray-500 hover:text-white ml-2">Reset</button>
            </div>
        </div>
    </nav>

    <main class="flex-1 flex gap-6 p-6 overflow-hidden">
        <div class="glass-panel flex-1 transition-all" id="inputPanel">
            <div class="h-12 border-b border-white/5 bg-black/20 flex items-center justify-between px-4">
                <span class="text-xs font-bold text-gray-300 uppercase tracking-widest flex items-center gap-2">
                    <i data-feather="download-cloud" class="w-4 h-4 text-gray-500"></i> Input Data
                </span>
                <span id="inputStatus" class="text-[10px] text-accent-secondary font-bold opacity-0 transition-opacity">BATCH READY</span>
            </div>
            <div id="dropZone" contenteditable="true"></div>
            
            <div id="appendActionBar" class="h-0 overflow-hidden transition-all bg-black/40 border-t border-white/5 flex items-center justify-between px-4">
                <span class="text-[10px] text-gray-400">Paste data above, then click Add</span>
                <button onclick="handleProcess(true)" id="appendBtn" class="liquid-glow px-6 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 my-2">
                    <i data-feather="plus-circle" class="w-3 h-3"></i> Add Batch
                </button>
            </div>
        </div>

        <div class="glass-panel flex-1 relative">
            <div class="h-12 border-b border-white/5 bg-black/20 flex items-center justify-between px-4 shrink-0">
                <span class="text-xs font-bold text-gray-300 uppercase tracking-widest flex items-center gap-2">
                    <i data-feather="table" class="w-4 h-4 text-accent-primary"></i> Master List
                </span>
                <div class="flex gap-2">
                    <button onclick="handleProcess(false)" id="manualRunBtn" class="hidden liquid-glow px-4 py-1.5 rounded-full text-xs font-bold flex items-center gap-2">
                        <i data-feather="play" class="w-3 h-3"></i> Run AI
                    </button>
                    <button onclick="copyToClipboard()" class="liquid-glow px-4 py-1.5 rounded-full text-xs font-bold flex items-center gap-2">
    <i data-feather="copy" class="w-3 h-3"></i> Copy Sheet
</button>
<button onclick="downloadCSV()" class="liquid-glow px-4 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 ml-2">
    <i data-feather="download" class="w-3 h-3"></i> Download CSV
</button>
                </div>
            </div>
            
            <div class="flex-1 overflow-auto bg-black/10 relative">
                <table id="previewTable">
                    <thead><tr><th width="50">Img</th><th>Name & Type</th><th>Desc Preview</th><th width="80">Price</th></tr></thead>
                    <tbody><tr><td colspan="4" class="text-center py-10 opacity-50">List is empty...</td></tr></tbody>
                </table>
            </div>
            <div class="h-8 border-t border-white/5 bg-black/20 flex items-center justify-between px-4 text-[10px] text-gray-500">
                <span id="countDisplay">0 items total</span>
                <span id="modeDisplay">Standard Mode</span>
            </div>
        </div>
    </main>

    <script>
        feather.replace();
        
        let masterList = [];
        let isAppendMode = false;
        let isNoDesc = true; // Default to TRUE for this client
        let isAIMode = false;
        let forceType = 'auto'; 
        let apiKey = localStorage.getItem('gemini_key') || '';
        const MODEL_NAME = "gemini-2.5-flash"; 

        const dropZone = document.getElementById('dropZone');
        const appendBar = document.getElementById('appendActionBar');
        const inputPanel = document.getElementById('inputPanel');
        const inputStatus = document.getElementById('inputStatus');
        const modeDisplay = document.getElementById('modeDisplay');
        const manualRunBtn = document.getElementById('manualRunBtn');
        const appendBtn = document.getElementById('appendBtn');
        const hoverModal = document.getElementById('hoverModal');

        if(apiKey) {
            document.getElementById('keyIndicator').classList.remove('bg-red-500');
            document.getElementById('keyIndicator').classList.add('bg-green-500');
        }

        function toggleSettings() {
            document.getElementById('settingsModal').classList.toggle('open');
            document.getElementById('apiKeyInput').value = apiKey;
            document.getElementById('forceTypeSelect').value = forceType;
        }

        function updateForceType() {
            forceType = document.getElementById('forceTypeSelect').value;
        }

        function saveSettings() {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            localStorage.setItem('gemini_key', apiKey);
            updateForceType(); 
            document.getElementById('settingsModal').classList.remove('open');
            const indicator = document.getElementById('keyIndicator');
            if(apiKey) {
                indicator.classList.remove('bg-red-500'); indicator.classList.add('bg-green-500');
                showToast("Settings Saved");
            } else {
                indicator.classList.add('bg-red-500'); indicator.classList.remove('bg-green-500');
            }
        }

        function toggleAIMode() { isAIMode = document.getElementById('aiModeToggle').checked; updateUIState(); }
        function toggleNoDesc() { isNoDesc = document.getElementById('noDescToggle').checked; renderTable(); }
        
        function toggleAppendMode() {
            isAppendMode = document.getElementById('appendModeToggle').checked;
            updateUIState();
            if(isAppendMode) { dropZone.innerHTML = ''; inputStatus.style.opacity = 0; }
        }

        function updateUIState() {
            if(isAIMode) modeDisplay.innerHTML = '<span class="badge-ai">GEMINI AI</span>';
            else modeDisplay.innerText = "Specific Client Regex"; // Updated label

            if(isAppendMode) {
                appendBar.style.height = "50px";
                inputPanel.classList.add('border', 'border-accent-secondary', 'border-opacity-30');
                manualRunBtn.classList.add('hidden');
            } else {
                appendBar.style.height = "0px";
                inputPanel.classList.remove('border', 'border-accent-secondary', 'border-opacity-30');
                if(isAIMode) manualRunBtn.classList.remove('hidden');
                else manualRunBtn.classList.add('hidden');
            }

            dropZone.removeEventListener('input', autoRunStandard);
            if (!isAIMode && !isAppendMode) dropZone.addEventListener('input', autoRunStandard);
        }

        function autoRunStandard() { setTimeout(() => handleProcess(false), 300); }

        async function handleProcess(isAppendAction) {
            const rawHTML = dropZone.innerHTML;
            const rawText = dropZone.innerText;

            if(rawText.trim().length === 0) return;

            if(isAppendAction) {
                appendBtn.innerHTML = '<div class="loader"></div> Processing...';
                appendBtn.classList.add('disabled');
            } else if (isAIMode) {
                manualRunBtn.innerHTML = '<div class="loader"></div> Analyzing...';
                manualRunBtn.classList.add('disabled');
            }

            let batch = [];
            try {
                if(isAIMode) {
                    if(!apiKey) throw new Error("Missing API Key");
                    batch = await runAI(rawText, rawHTML);
                } else {
                    batch = runRegex(rawHTML);
                }

                // APPLY FORCE TYPE OVERRIDE
                if (forceType !== 'auto') {
                    batch = batch.map(p => ({ ...p, type: forceType }));
                }

                if(isAppendMode || isAppendAction) {
                    masterList = [...masterList, ...batch];
                    dropZone.innerHTML = ''; 
                    inputStatus.style.opacity = 0;
                } else {
                    masterList = batch;
                }
                renderTable();
            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                appendBtn.innerHTML = '<i data-feather="plus-circle" class="w-3 h-3"></i> Add Batch';
                appendBtn.classList.remove('disabled');
                manualRunBtn.innerHTML = '<i data-feather="play" class="w-3 h-3"></i> Run AI';
                manualRunBtn.classList.remove('disabled');
                feather.replace();
            }
        }

        // --- SPECIFIC CLIENT REGEX LOGIC ---
        function runRegex(htmlContent) {
            const root = document.createElement('div');
            root.innerHTML = htmlContent;
            
            // 1. Flatten HTML into a stream
            let nodes = [];
            function scan(n) {
                if(n.nodeType === 3) {
                    let t = n.textContent.trim();
                    // FILTER: Ignore Buttons, discount badges, and qty inputs
                    if (t.match(/^(ADD TO CART|READ MORE|SOLD OUT|Select options|Details|View|NEW|HOT)$/i)) return; 
                    if (t.match(/^-[0-9]+%$/)) return; 
                    if (t === "+" || t === "-") return; 
                    if (t.length > 0) nodes.push({t:'txt', v: t});
                }
                if(n.tagName === 'IMG' && (n.width > 40 || !n.width)) nodes.push({t:'img', v:n.src});
                n.childNodes.forEach(scan);
            }
            scan(root);

            // 2. Group into Products
            let temp = [];
            let cur = { img: null, txt: [] };
            nodes.forEach(n => {
                if(n.t === 'img') {
                    // FIX: If we already have an image but NO text, this is a "Hover" image.
                    // We ignore it to ensure we keep the MAIN (first) image.
                    if (cur.img && cur.txt.length === 0) return; 

                    if(cur.img || cur.txt.length) temp.push(cur);
                    cur = { img: n.v, txt: [] };
                } else cur.txt.push(n.v);
            });
            if(cur.img || cur.txt.length) temp.push(cur);

            // 3. Extract Data & Apply "Simple Product" Logic
            let results = [];
            for (let i = 0; i < temp.length; i++) {
                let p = temp[i];
                if (p.txt.length === 0) continue; // FIX: Delete rows that are just images (badges/icons) with no text

                // PLACEHOLDER: Ensure Name exists
                let name = p.txt[0] || `Imported Product ${i+1}`;
                
                let fullString = p.txt.join(" "); 
                let allPrices = fullString.match(/[$€£¥₩]\s*[0-9,]+(?:\.[0-9]{2})?/g) || [];
                
                let regularPrice = "";
                let salePrice = "";

                if (allPrices.length >= 2) {
                    // Logic: If two prices, smaller is sale, larger is regular
                    let p1 = parseFloat(allPrices[0].replace(/[^0-9.]/g, ''));
                    let p2 = parseFloat(allPrices[1].replace(/[^0-9.]/g, ''));
                    
                    if (p2 < p1) {
                        regularPrice = allPrices[0];
                        salePrice = allPrices[1];
                    } else {
                        regularPrice = allPrices[0]; // Fallback
                    }
                } else if (allPrices.length === 1) {
                    regularPrice = allPrices[0];
                }

                // FORCE SIMPLE PRODUCT
                let type = "simple"; 

                let descClean = isNoDesc ? "" : p.txt.filter(l => l !== name && !l.includes('$')).join(' ');

                results.push({
                    name: name,
                    image: p.img || "", // Images allows URLs in WooCommerce
                    rawDesc: descClean,
                    regularPrice: regularPrice,
                    salePrice: salePrice,
                    type: type
                });
            }
            return results.filter(p => p.name !== "Unknown Product");
        }

        async function runAI(text, html) {
            const systemPrompt = `
                ROLE: Senior Data Architect.
                TASK: Parse product data from specific client format.
                PATTERNS:
                1. Prices often appear as "$Old $New". Extract $New.
                2. Ignore "-XX%" discount text.
                3. Ignore "ADD TO CART", "SOLD OUT", "READ MORE".
                
                OUTPUT JSON: [ { "name": "...", "price": "...", "type": "Simple/Variable", "desc": "..." } ]
                INPUT: ${text.substring(0, 15000)}
            `;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
            });

            const data = await response.json();
            if(data.error) throw new Error(data.error.message);
            
            const aiText = data.candidates[0].content.parts[0].text;
            const jsonStr = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
            const aiProducts = JSON.parse(jsonStr);

            const root = document.createElement('div');
            root.innerHTML = html;
            const domImages = Array.from(root.querySelectorAll('img')).map(img => img.src).filter(src => src.length > 0);

            return aiProducts.map((p, index) => ({
                name: p.name,
                image: domImages[index] || "", 
                rawDesc: p.desc,
                price: p.price,
                type: p.type, 
                isSale: false 
            }));
        }

        // --- HOVER MODAL LOGIC ---
        function showModal(e, index) {
            const p = masterList[index];
            const img = document.getElementById('modalImg');
            const placeholder = document.getElementById('modalImgPlaceholder');
            const title = document.getElementById('modalTitle');
            const price = document.getElementById('modalPrice');
            const type = document.getElementById('modalType');
            const desc = document.getElementById('modalDesc');
            const descContainer = document.getElementById('modalDescContainer');

            if (p.image) {
                img.src = p.image;
                img.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                img.style.display = 'none';
                placeholder.style.display = 'flex';
                placeholder.innerText = "Unavailable";
            }

            title.innerText = p.name || "Unavailable";
            
            price.innerText = p.price || "Unavailable";
            price.classList.toggle('unavailable', !p.price);

            type.innerText = p.type || "Unavailable";
            
            if (!p.rawDesc || p.rawDesc.trim().length === 0) {
                descContainer.style.display = 'none';
            } else {
                descContainer.style.display = 'block';
                desc.innerText = p.rawDesc.substring(0, 200) + (p.rawDesc.length > 200 ? "..." : "");
            }

            hoverModal.classList.add('visible');
            moveModal(e);
        }

        function hideModal() {
            hoverModal.classList.remove('visible');
        }

        function moveModal(e) {
            const offset = 20;
            let left = e.clientX + offset;
            let top = e.clientY + offset;

            if (left + 320 > window.innerWidth) left = e.clientX - 340;
            if (top + 400 > window.innerHeight) top = window.innerHeight - 400;

            hoverModal.style.left = left + 'px';
            hoverModal.style.top = top + 'px';
        }

        function renderTable() {
            const tbody = document.querySelector('#previewTable tbody');
            const count = document.getElementById('countDisplay');
            
            if(!masterList.length) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center opacity-50 py-10">List is empty...</td></tr>';
                count.innerText = "0 items total";
                return;
            }

            tbody.innerHTML = masterList.map((p, i) => {
                let displayDesc = isNoDesc ? "" : (p.rawDesc ? p.rawDesc.substring(0, 60) + "..." : "");
                let saleBadge = p.salePrice ? '<span class="badge-sale">Sale</span>' : '';
                
                return `
                <tr onmouseenter="showModal(event, ${i})" onmousemove="moveModal(event)" onmouseleave="hideModal()">
                    <td>${p.image ? `<img src="${p.image}">` : '-'}</td>
                    <td>
                        <div class="font-bold text-white text-xs">${p.name}</div>
                        <span class="badge-simple">Simple</span> ${saleBadge}
                    </td>
                    <td class="text-[10px] text-gray-500">${displayDesc || '<span class="opacity-30">-</span>'}</td>
                    <td class="text-xs font-mono">
                        ${p.salePrice ? 
                            `<span class="text-gray-500 line-through text-[10px] mr-1">${p.regularPrice}</span>
                             <span class="text-accent-secondary font-bold">${p.salePrice}</span>` 
                            : 
                            `<span class="text-gray-300">${p.regularPrice || '-'}</span>`
                        }
                    </td>
                </tr>
            `}).join('');
            
            feather.replace();
            count.innerText = `${masterList.length} items total`;
            const tableArea = document.querySelector('.overflow-auto');
            tableArea.scrollTop = tableArea.scrollHeight;
        }
        function downloadCSV() {
            if(!masterList.length) return;
            
            // 1. Define Headers for WooCommerce
            const headers = ["Type", "Name", "Regular price", "Sale price", "Images", "Description"];
            
            // 2. Build CSV Content
            const csvRows = [headers.join(",")];
            
            masterList.forEach(p => {
                // Escape quotes (") by doubling them ("") to prevent CSV breaking
                const safeName = (p.name || "").replace(/"/g, '""'); 
                const safeDesc = isNoDesc ? "" : (p.rawDesc || "").replace(/"/g, '""').replace(/\n/g, ' ');
                // Ensure pure numbers for price
                const regPrice = p.regularPrice ? p.regularPrice.replace(/[^0-9.]/g, '') : '';
                const salePrice = p.salePrice ? p.salePrice.replace(/[^0-9.]/g, '') : '';

                // Wrap text fields in quotes to handle commas inside names safely
                const row = [
                    "simple",                 
                    `"${safeName}"`,          
                    regPrice,                 
                    salePrice,                
                    p.image || "",            
                    `"${safeDesc}"`           
                ];
                csvRows.push(row.join(","));
            });

            // 3. Trigger Download
            const blob = new Blob([csvRows.join("\n")], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'reputifly_woocommerce.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast("CSV Downloaded!");
        }

        function copyToClipboard() {
            if(!masterList.length) return;
            
            // WOOCOMMERCE EXACT HEADERS
            // These headers are auto-detected by WooCommerce Importer
            let headers = "Type\tName\tRegular price\tSale price\tImages\tDescription";
            
            let tsv = masterList.map(p => {
                // CLEAN DATA FOR CSV/TSV
                const safeName = (p.name || "Unnamed Product").replace(/\t/g, ' ');
                const safeType = "simple"; 
                const regPrice = p.regularPrice ? p.regularPrice.replace(/[^0-9.]/g, '') : ''; 
                const salePrice = p.salePrice ? p.salePrice.replace(/[^0-9.]/g, '') : ''; 
                const desc = isNoDesc ? "" : (p.rawDesc || "").replace(/\t/g, ' ').replace(/\n/g, ' ');
                
                return `${safeType}\t${safeName}\t${regPrice}\t${salePrice}\t${p.image}\t${desc}`;
            }).join('\n');

            let finalOutput = headers + '\n' + tsv;
            
            navigator.clipboard.writeText(finalOutput).then(() => showToast("Copied! Paste into Excel -> Save as CSV"));
        }

        function clearAll() { dropZone.innerHTML = ''; masterList = []; renderTable(); }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerHTML = `<i data-feather="check" class="w-4 h-4"></i> ${msg}`;
            feather.replace();
            t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2500);
        }
    </script>
</body>
</html>
