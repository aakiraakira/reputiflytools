<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>

    
    <script>
        // Custom Tailwind theme configuration
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using a class
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'dark-bg': '#0F172A', // Main dark background
                        'dark-surface': '#1E293B', // Card and modal backgrounds
                        'dark-border': '#334155',
                        'dark-text-primary': '#F8FAFC',
                        'dark-text-secondary': '#94A3B8',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom styles for a polished look and feel */
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .modal { display: none; animation: fadeIn 0.3s ease-out; }
        .modal-content { animation: slideInUp 0.4s ease-out; }
        .page-view { display: none; animation: fadeIn 0.5s ease-out; }
        .page-view.active { display: block; }
        .loader { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
        th.sortable:hover { cursor: pointer; background-color: #f9fafb; }
        .dark th.sortable:hover { background-color: #334155; }
        th.sortable .sort-indicator { opacity: 0.3; transition: opacity 0.2s; }
        th.sortable:hover .sort-indicator { opacity: 0.7; }
        th.sort-asc .sort-indicator,
        th.sort-desc .sort-indicator { opacity: 1; }

        .switcher-btn { transition: background-color 0.2s, color 0.2s; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; }
        .switcher-btn.active { background-color: #3b82f6; color: white; }
        .switcher-btn:not(.active) { background-color: transparent; }
        .dark .switcher-btn:not(.active) { color: #94A3B8; }
        
        .table-tab-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            text-transform: capitalize;
        }
         .table-tab-btn.active {
            background-color: #e5e7eb;
            color: #111827;
        }
        .dark .table-tab-btn.active {
            background-color: #4b5563;
            color: #f9fafb;
        }
        
        /* Invoice specific styles */
        #invoice-preview-wrapper { font-family: 'Inter', sans-serif; }
        .invoice-box { border: 1px solid #eee; box-shadow: 0 0 10px rgba(0, 0, 0, 0.15); font-size: 16px; line-height: 24px; color: #555; }
        .dark .invoice-box { border-color: #334155; box-shadow: 0 0 10px rgba(0,0,0, .5); color: #ccc; }
        .invoice-box table { width: 100%; line-height: inherit; text-align: left; border-collapse: collapse; }
        .invoice-box table td { padding: 8px 12px; vertical-align: top; }
        .invoice-box table tr.heading td { background: #eee; border-bottom: 1px solid #ddd; font-weight: bold; }
        .dark .invoice-box table tr.heading td { background: #1E293B; border-bottom-color: #334155; }
        .invoice-box table tr.details td { padding-bottom: 20px; }
        .invoice-box table tr.item td { border-bottom: 1px solid #eee; }
        .dark .invoice-box table tr.item td { border-bottom-color: #334155; }
        .invoice-box table tr.item.last td { border-bottom: none; }
        .invoice-box table tr.total td:not(:first-child) { border-top: 2px solid #eee; font-weight: bold; }
        .dark .invoice-box table tr.total td:not(:first-child) { border-top-color: #334155; }
        .dark .invoice-box .invoice-title { color: #f1f5f9 !important; }
        .legend-item { cursor: pointer; }
        .legend-item.hidden-dataset { text-decoration: line-through; opacity: 0.5; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Hover glow effect for dashboard cards */
        .dashboard-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.07);
        }
        .dark .dashboard-card:hover {
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        /* Task & Sub-task Styles */
        .task-board-column { min-height: 400px; }
        .task-card { cursor: pointer; }
        .task-card.dragging { opacity: 0.5; cursor: grabbing; }
        .drop-zone { min-height: 100px; border: 2px dashed transparent; transition: border-color 0.2s; }
        .drop-zone.drag-over { border-color: #3b82f6; }
        
        .subtask-item-header {
            cursor: pointer;
        }
        .subtask-item-body {
            display: none;
            background-color: rgba(0,0,0,0.02);
            padding-left: 2.25rem;
        }
        .dark .subtask-item-body {
            background-color: rgba(255,255,255,0.03);
        }
        .subtask-item-body.expanded {
            display: block;
        }
        .subtask-item input[type="checkbox"]:checked + .subtask-title-input { 
            text-decoration: line-through; color: #9ca3af; 
        }
        .expand-icon { transition: transform 0.2s; }
        .expanded > .expand-icon { transform: rotate(90deg); }
        .list-view-expand-btn > svg { transition: transform 0.2s; }
        .list-view-row.expanded .list-view-expand-btn > svg { transform: rotate(90deg); }

        .subtasks-container-in-list {
            background-color: #f9fafb;
        }
        .dark .subtasks-container-in-list {
            background-color: #1a2438;
        }
        .subtasks-container-in-list .subtask-checkbox-list:checked + span {
             text-decoration: line-through;
             color: #6b7280;
        }
        .dark .subtasks-container-in-list .subtask-checkbox-list:checked + span {
             color: #4b5563;
        }


    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg font-sans text-gray-800 dark:text-dark-text-primary">
    
    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

    <div class="flex min-h-screen">
        <aside class="bg-white dark:bg-dark-surface p-4 flex flex-col items-center shadow-xl fixed h-full z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out w-64 md:w-20">
            <div id="desktop-logo" class="text-blue-600 dark:text-blue-400 font-extrabold text-3xl hidden md:block">R</div>
            <div id="mobile-logo" class="text-blue-600 dark:text-blue-400 font-extrabold text-xl md:hidden">Reputifly</div>
            <nav class="flex flex-col items-start md:items-center space-y-6 flex-grow mt-8 w-full px-4 md:px-0">
                <a href="#" data-page="dashboard" class="sidebar-link p-3 rounded-lg flex items-center gap-4 md:gap-0 w-full" title="Analytics">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 13h18"/><path d="M16 3v18"/></svg>
                    <span class="md:hidden">Analytics</span>
                </a>
                 <a href="#" data-page="tasks" class="sidebar-link p-3 rounded-lg flex items-center gap-4 md:gap-0 w-full" title="Tasks">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="m9 12 2 2 4-4" /></svg>
                    <span class="md:hidden">Tasks</span>
                </a>
                <a href="#" data-page="invoicing" class="sidebar-link p-3 rounded-lg flex items-center gap-4 md:gap-0 w-full" title="Invoicing">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2Z"/></svg>
                    <span class="md:hidden">Invoicing</span>
                </a>
            </nav>
            <div id="theme-toggle" class="p-3 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700/50 rounded-lg cursor-pointer" title="Toggle Theme"></div>
        </aside>

        <main class="flex-1 p-4 sm:p-6 lg:p-8 md:ml-20 w-full">
             <header class="md:hidden flex justify-between items-center mb-4">
                 <button id="hamburger-menu-button" class="p-2 text-gray-500">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <div class="text-blue-600 dark:text-blue-400 font-extrabold text-2xl">Reputifly</div>
                <div id="mobile-theme-toggle" class="p-3 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700/50 rounded-lg cursor-pointer"></div>
            </header>

            <div id="dashboard-page" class="page-view">
                <header class="flex flex-col md:flex-row md:justify-between items-start md:items-center gap-4 mb-8">
                    <div class="w-full md:w-auto">
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-dark-text-primary">Analytics</h1>
                        <p class="text-sm md:text-base text-gray-500 dark:text-dark-text-secondary">Dashboard / Analytics</p>
                    </div>
                    <div class="flex flex-col sm:flex-row flex-wrap items-center justify-start gap-2 w-full md:w-auto md:justify-end">
                        <div id="date-presets-container" class="flex items-center bg-gray-100 dark:bg-dark-surface rounded-lg p-1 text-sm font-semibold text-gray-600 dark:text-dark-text-secondary w-full justify-around md:w-auto">
                            <button data-range="day" class="date-preset-btn px-3 py-1.5 rounded-md transition-colors">Daily</button>
                            <button data-range="week" class="date-preset-btn px-3 py-1.5 rounded-md transition-colors">Weekly</button>
                            <button data-range="month" class="date-preset-btn px-3 py-1.5 rounded-md transition-colors">Monthly</button>
                        </div>
                        <input id="date-range-picker" class="bg-white text-gray-800 dark:bg-slate-700 dark:text-white px-4 py-2 rounded-lg shadow-sm font-semibold text-sm focus:ring-2 focus:ring-blue-500 border border-gray-200 dark:border-dark-border w-full md:w-auto" placeholder="Select Date Range">
                        <div class="flex gap-2 w-full sm:w-auto">
                            <input type="file" id="import-file-input" class="hidden" accept=".json">
                            <button id="import-data-button" class="bg-white text-gray-800 dark:bg-slate-800 dark:text-white px-4 py-2 rounded-lg shadow-sm hover:bg-gray-100 dark:hover:bg-slate-600 font-semibold flex items-center justify-center gap-2 text-sm border border-gray-200 dark:border-dark-border flex-grow sm:flex-grow-0">Import</button>
                            <button id="export-data-button" class="bg-white text-gray-800 dark:bg-slate-800 dark:text-white px-4 py-2 rounded-lg shadow-sm hover:bg-gray-100 dark:hover:bg-slate-600 font-semibold flex items-center justify-center gap-2 text-sm border border-gray-200 dark:border-dark-border flex-grow sm:flex-grow-0">Export</button>
                        </div>
                        <button id="add-entry-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 font-semibold items-center gap-2 text-sm w-full md:w-auto hidden md:flex"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Add Transaction</button>
                    </div>
                </header>
                
                <div id="loader" class="flex justify-center items-center h-64"><div class="loader h-16 w-16 border-4 border-gray-200 dark:border-gray-700 rounded-full"></div></div>
                
                <div id="dashboard-content" class="space-y-8 hidden">
                    <div id="kpi-card-container" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6"></div>

                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                        <div id="revenue-by-sector-container" class="dashboard-card xl:col-span-1 bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border flex flex-col">
                            <div class="flex flex-wrap justify-between items-center gap-4 mb-2">
                                 <h2 class="text-xl font-bold">Revenue by Sector</h2>
                            </div>
                            <div id="sector-legend-container" class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2 mb-4 text-sm"></div>
                            <div id="sector-chart-wrapper" class="flex-grow relative min-h-[300px]">
                                <canvas id="revenue-by-sector-chart"></canvas>
                            </div>
                            <div id="sector-chart-no-data" class="flex-grow flex flex-col justify-center items-center text-center min-h-[300px] hidden">
                                <p class="text-gray-500 dark:text-dark-text-secondary px-4">Add a 'sector' to a revenue transaction to see data here.</p>
                            </div>
                        </div>

                        <div class="dashboard-card xl:col-span-2 bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
                            <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                                <h2 class="text-xl font-bold">Revenue Statistics</h2>
                            </div>
                            <div class="h-80 relative"><canvas id="revenue-line-chart"></canvas></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                         <div class="dashboard-card lg:col-span-1 bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
                             <h2 class="text-xl font-bold mb-4">Revenue Breakdown</h2>
                             <div class="grid grid-cols-2 gap-x-4">
                                <div class="col-span-1 text-center">
                                    <h3 class="text-md font-bold mb-2">By Source</h3>
                                    <div class="h-40 w-full relative"><canvas id="source-pie-chart"></canvas></div>
                                </div>
                                <div class="col-span-1 text-center">
                                     <h3 class="text-md font-bold mb-2">By Business</h3>
                                    <div class="h-40 w-full relative"><canvas id="business-pie-chart"></canvas></div>
                                </div>
                             </div>
                             <div id="business-breakdown-container" class="col-span-2 mt-4 pt-4 border-t border-gray-200 dark:border-dark-border"></div>
                        </div>
                        <div class="dashboard-card lg:col-span-2 bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
                            <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                                 <h2 class="text-xl font-bold">Daily Sales Activity</h2>
                            </div>
                            <div class="h-[280px] relative"><canvas id="daily-sales-bar-chart"></canvas></div>
                        </div>
                    </div>

                    <div id="transaction-table-container" class="dashboard-card bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border"></div>
                </div>
            </div>
            
            <div id="tasks-page" class="page-view">
                 <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-dark-text-primary">Task Manager</h1>
                        <p class="text-gray-500 dark:text-dark-text-secondary">Dashboard / Tasks</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="task-view-switcher" class="flex items-center bg-gray-200 dark:bg-dark-surface rounded-lg p-1 text-sm font-semibold text-gray-600 dark:text-dark-text-secondary">
                            <button data-view="board" class="task-view-btn px-3 py-1.5 rounded-md">Board</button>
                            <button data-view="list" class="task-view-btn px-3 py-1.5 rounded-md">List</button>
                            <button data-view="calendar" class="task-view-btn px-3 py-1.5 rounded-md">Calendar</button>
                            <button data-view="analytics" class="task-view-btn px-3 py-1.5 rounded-md">Analytics</button>
                        </div>
                        <button id="add-task-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 font-semibold flex items-center gap-2 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Add Task
                        </button>
                    </div>
                </header>
                <div id="tasks-content"></div>
            </div>

            <div id="invoice-creator-page" class="page-view">
                <header class="flex flex-wrap justify-between items-center gap-4 mb-8 sticky top-0 bg-gray-100 dark:bg-dark-bg py-4 z-10 -mt-4 -mx-4 px-4 sm:-mx-6 sm:px-6">
                    <div>
                        <h1 class="text-xl md:text-3xl font-bold text-gray-900 dark:text-dark-text-primary">Invoice Creator</h1>
                        <p class="text-sm md:text-base text-gray-500 dark:text-dark-text-secondary">Create and download a new invoice.</p>
                    </div>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                         <button id="download-invoice-pdf" class="bg-green-600 text-white px-5 py-2.5 rounded-lg shadow-md hover:bg-green-700 font-semibold flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            Download PDF
                        </button>
                    </div>
                </header>
                 <div class="p-1 grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <form id="invoice-form" class="lg:col-span-2 space-y-6 bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border self-start">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="invoice-from-name" class="block text-sm font-medium dark:text-dark-text-secondary">From</label>
                                <textarea id="invoice-from-name" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg" placeholder="Your Company, Inc.&#10;123 Main Street&#10;Anytown, USA 12345"></textarea>
                            </div>
                            <div>
                                <label for="invoice-to-name" class="block text-sm font-medium dark:text-dark-text-secondary">Bill To</label>
                                <textarea id="invoice-to-name" rows="3" list="client-datalist" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg" placeholder="Client Name&#10;Client Address"></textarea>
                                <datalist id="client-datalist"></datalist>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="invoice-number" class="block text-sm font-medium dark:text-dark-text-secondary">Invoice #</label>
                                <input type="text" id="invoice-number" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg">
                            </div>
                            <div>
                                <label for="invoice-date-issued" class="block text-sm font-medium dark:text-dark-text-secondary">Date Issued</label>
                                <input type="date" id="invoice-date-issued" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg">
                            </div>
                            <div>
                                <label for="invoice-date-due" class="block text-sm font-medium dark:text-dark-text-secondary">Date Due</label>
                                <input type="date" id="invoice-date-due" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg">
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Items</h3>
                            <div id="invoice-items-container" class="space-y-2"></div>
                            <button type="button" id="add-invoice-item-btn" class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-semibold">+ Add Line Item</button>
                        </div>
                        <div class="space-y-4 pt-4 border-t dark:border-dark-border">
                             <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div>
                                    <label for="invoice-discount" class="block text-sm font-medium dark:text-dark-text-secondary">Discount (Optional)</label>
                                    <input type="number" step="0.01" id="invoice-discount" placeholder="$0.00" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border-gray-300 dark:border-dark-border rounded-lg">
                                </div>
                                <div>
                                    <label for="invoice-tax-rate" class="block text-sm font-medium dark:text-dark-text-secondary">Tax (Optional, %)</label>
                                    <input type="number" step="0.01" id="invoice-tax-rate" placeholder="0" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border-gray-300 dark:border-dark-border rounded-lg">
                                </div>
                                <div>
                                    <label for="invoice-shipping" class="block text-sm font-medium dark:text-dark-text-secondary">Shipping (Optional)</label>
                                    <input type="number" step="0.01" id="invoice-shipping" placeholder="$0.00" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border-gray-300 dark:border-dark-border rounded-lg">
                                </div>
                            </div>
                        </div>
                         <div>
                            <label for="invoice-notes" class="block text-sm font-medium dark:text-dark-text-secondary">Notes</label>
                            <textarea id="invoice-notes" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg" placeholder="e.g. Thank you for your business!"></textarea>
                        </div>
                        <div>
                            <label for="invoice-terms" class="block text-sm font-medium dark:text-dark-text-secondary">Terms</label>
                            <textarea id="invoice-terms" rows="3" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg" placeholder="e.g. Payment due within 30 days."></textarea>
                        </div>
                    </form>
                    <div id="invoice-preview-wrapper" class="lg:col-span-3">
                        <div id="invoice-preview-template" class="invoice-box bg-white dark:bg-dark-surface p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
                            </div>
                    </div>
                </div>
            </div>

            <button id="mobile-add-entry-button" class="md:hidden fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg z-20 hover:bg-blue-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
        </main>
    </div>

    <div id="add-entry-modal" class="modal fixed inset-0 bg-black/70 justify-center items-center z-50 p-4">
        <div class="modal-content bg-white dark:bg-dark-surface rounded-xl shadow-2xl w-full max-w-lg border border-gray-200 dark:border-dark-border flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-dark-border flex-shrink-0">
                <h2 class="text-2xl font-bold">New Transaction</h2>
                <button id="modal-close-button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="modal-error" class="bg-red-500/10 text-red-500 p-3 rounded-md mb-4 hidden font-medium"></div>
                <div class="flex items-center bg-gray-100 dark:bg-slate-800 rounded-lg p-1 space-x-1 mb-6">
                    <button class="switcher-btn flex-1" data-type="revenue">Revenue</button>
                    <button class="switcher-btn flex-1" data-type="expense">Expense</button>
                </div>
                <form id="add-entry-form" class="space-y-4"></form>
            </div>
        </div>
    </div>
    
    <div id="task-detail-modal" class="modal fixed inset-0 bg-black/70 justify-center items-center z-50 p-4">
        <div class="modal-content bg-white dark:bg-dark-surface rounded-xl shadow-2xl w-full max-w-5xl border border-gray-200 dark:border-dark-border flex flex-col max-h-[95vh]">
             <div class="flex justify-between items-center p-5 border-b border-gray-200 dark:border-dark-border">
                <h2 class="text-2xl font-bold">Task Details</h2>
                <button id="task-modal-close-button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="task-modal-body" class="p-6 overflow-y-auto"></div>
             <div class="flex justify-between items-center p-4 border-t border-gray-200 dark:border-dark-border bg-gray-50 dark:bg-dark-surface/50 rounded-b-xl">
                <button id="delete-task-button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm">Delete Task</button>
                <div id="task-modal-session-timer-display" class="text-lg font-bold text-blue-600 dark:text-blue-400"></div>
            </div>
        </div>
    </div>


    <div id="delete-modal" class="modal fixed inset-0 bg-black/70 justify-center items-center z-50 p-4">
        <div class="modal-content bg-white dark:bg-dark-surface rounded-xl shadow-2xl p-8 w-full max-w-md text-center border border-gray-200 dark:border-dark-border">
            <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
            <p class="dark:text-dark-text-secondary mb-8">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button type="button" id="delete-cancel-button" class="w-full px-4 py-2.5 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 dark:bg-dark-border dark:text-dark-text-primary dark:hover:bg-gray-600 font-semibold">Cancel</button>
                <button type="button" id="delete-confirm-button" class="w-full px-4 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">Delete</button>
            </div>
        </div>
    </div>
        
    <div id="move-task-modal" class="modal fixed inset-0 bg-black/70 justify-center items-center z-50 p-4">
        <div class="modal-content bg-white dark:bg-dark-surface rounded-xl shadow-2xl p-6 w-full max-w-xs text-center border border-gray-200 dark:border-dark-border">
            <h3 class="text-lg font-bold mb-4">Move Task To...</h3>
            <div id="move-task-options" class="flex flex-col space-y-2"></div>
            <button type="button" id="move-task-cancel-button" class="mt-6 w-full px-4 py-2.5 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 dark:bg-dark-border dark:text-dark-text-primary dark:hover:bg-gray-600 font-semibold">Cancel</button>
        </div>
    </div>

    <datalist id="tags-datalist"></datalist>

    <script>
    (() => {
        // To hold instances and timers globally within this IIFE
        let pickerInstance = null;
        let draggedTaskId = null;
        
        // Destructure date-fns functions for easy access
        const { parseISO, format, startOfMonth, endOfMonth, startOfWeek, endOfWeek, startOfDay, endOfDay, eachDayOfInterval, eachWeekOfInterval, eachMonthOfInterval, subDays, isAfter, addDays, isSameMonth, isSameDay, addMonths, getDaysInMonth, getDay, formatDuration, intervalToDuration } = dateFns;

        // PDF generation library
        const { jsPDF } = window.jspdf;

        // --- Data Model: Sub-tasks are now more complex objects
        const initialTasks = [
            { 
                id: 'task-1', title: 'Design new homepage mockup', status: 'In Progress', priority: 'High', projectId: 'proj-1', tags: ['client-review', 'design'], 
                subtasks: [
                    {id: 'sub-1', title: 'Create wireframe in Figma', done: true, description: 'Focus on mobile-first layout.', attachments: [{type: 'link', url: 'https://figma.com'}]}, 
                    {id: 'sub-2', title: 'Choose color palette', done: false, description: 'Get feedback from the client on the proposed palettes.', attachments: []}
                ], 
                dueDate: '2025-06-30', timeLog: [], description: 'Detailed description about the homepage mockup requirements.', timeEstimate: 240 
            },
            { id: 'task-2', title: 'Draft blog post for launch', status: 'To Do', priority: 'Medium', projectId: 'proj-2', tags: ['marketing', 'writing'], subtasks: [], dueDate: '2025-07-03', timeLog: [], description: '', timeEstimate: 120 },
            { id: 'task-3', title: 'Fix login button CSS', status: 'In Progress', priority: 'High', projectId: 'proj-1', tags: ['bug', 'css'], subtasks: [], dueDate: '2025-06-28', timeLog: [], description: 'The login button is misaligned on mobile devices.', timeEstimate: 60 },
            { id: 'task-4', title: 'Setup marketing email sequence', status: 'Done', priority: 'Low', projectId: 'proj-2', tags: ['marketing'], subtasks: [], dueDate: '2025-06-20', timeLog: [{start: '2025-06-19T10:00:00Z', end: '2025-06-19T12:30:00Z'}] , description: '', timeEstimate: 180 },
            { id: 'task-5', title: 'Develop user authentication', status: 'To Do', priority: 'High', projectId: 'proj-1', tags: ['dev'], subtasks: [], dueDate: '2025-07-10', timeLog: [], description: '', timeEstimate: 480 },
        ];
        
        const initialProjects = [
            { id: 'proj-1', name: 'Web Design Fulfillment' },
            { id: 'proj-2', name: 'Marketing Funnel' },
        ];

        const initialData = [
            { id: '7', itemName: 'Ritesh', business: 'Google Reviews', date: '2025-06-28', type: 'revenue', sector: 'Marketing', customerSource: 'Google Ads', fulfillmentExpense: 1200, status: 'Recurring', amount: 3400 },
            { id: '1', itemName: 'Alice Johnson', business: 'Web Design', date: '2025-06-26', type: 'revenue', sector: 'Services', customerSource: 'Referral', fulfillmentExpense: 300, status: 'Recurring', amount: 1500 },
        ];
        
        // --- Application State ---
        const state = {
            entries: [],
            tasks: [],
            projects: [],
            theme: 'light',
            itemToDelete: null,
            taskToMove: null,
            taskToDelete: null,
            activeSessionTimer: null, // { taskId, startTime, durationMs, intervalId, isPaused, remainingMsOnPause, notified10min }
            ui: {
                activePage: 'tasks',
                activeTableTab: 'all',
                activeTaskView: 'board',
                currentCalendarDate: new Date(),
                dateRange: { start: startOfMonth(new Date()), end: endOfMonth(new Date()) },
                sort: { key: 'date', order: 'desc' }, // for transactions
                taskSort: { key: 'dueDate', order: 'asc' }, // for tasks
                taskSearchQuery: '', // New: For task list searching
                activeTaskStatusFilter: 'all', // New: For task list status filtering
                searchQuery: '',
                activeModalForm: 'revenue',
                activeDatePreset: 'month',
                expandedSubtasks: {}, // In-modal subtask expansion state: { [subtaskId]: boolean }
                expandedListTasks: {}, // List-view task expansion state: { [taskId]: boolean }
            },
            chartInstances: {},
        };

        // --- DOM Element References ---
        const DOMElements = {
            html: document.documentElement,
            loader: document.getElementById('loader'),
            dashboardContent: document.getElementById('dashboard-content'),
            themeToggle: document.getElementById('theme-toggle'), 
            transactionTableContainer: document.getElementById('transaction-table-container'),
            businessBreakdownContainer: document.getElementById('business-breakdown-container'), 
            addEntryButton: document.getElementById('add-entry-button'),
            tagsDataList: document.getElementById('tags-datalist'),
            pages: {
                dashboard: document.getElementById('dashboard-page'),
                tasks: document.getElementById('tasks-page'),
                invoicing: document.getElementById('invoice-creator-page'),
            },
            sidebar: document.querySelector('aside'),
            sidebarLinks: document.querySelectorAll('.sidebar-link'),
            mobileMenu: {
                button: document.getElementById('hamburger-menu-button'),
                overlay: document.getElementById('mobile-menu-overlay'),
                mobileThemeToggle: document.getElementById('mobile-theme-toggle'),
                mobileAddEntryButton: document.getElementById('mobile-add-entry-button'),
            },
            dateRangePicker: document.getElementById('date-range-picker'),
            datePresetsContainer: document.getElementById('date-presets-container'),
            kpiCardContainer: document.getElementById('kpi-card-container'),
            sectorChart: {
                wrapper: document.getElementById('sector-chart-wrapper'),
                noData: document.getElementById('sector-chart-no-data'),
                legendContainer: document.getElementById('sector-legend-container')
            },
            addEntryModal: {
                modal: document.getElementById('add-entry-modal'),
                form: document.getElementById('add-entry-form'),
                closeButton: document.getElementById('modal-close-button'),
                error: document.getElementById('modal-error'),
                typeButtons: document.querySelectorAll('#add-entry-modal .switcher-btn'),
            },
            deleteModal: {
                modal: document.getElementById('delete-modal'),
                confirmButton: document.getElementById('delete-confirm-button'),
                cancelButton: document.getElementById('delete-cancel-button'),
            },
            moveTaskModal: {
                 modal: document.getElementById('move-task-modal'),
                 optionsContainer: document.getElementById('move-task-options'),
                 cancelButton: document.getElementById('move-task-cancel-button'),
            },
            invoice: {
                form: document.getElementById('invoice-form'),
                itemsContainer: document.getElementById('invoice-items-container'),
                addItemButton: document.getElementById('add-invoice-item-btn'),
                preview: document.getElementById('invoice-preview-template'),
                downloadPdfButton: document.getElementById('download-invoice-pdf'),
                clientDatalist: document.getElementById('client-datalist'),
            },
            importData: {
                button: document.getElementById('import-data-button'),
                input: document.getElementById('import-file-input'),
            },
            exportDataButton: document.getElementById('export-data-button'),
            tasks: {
                content: document.getElementById('tasks-content'),
                viewSwitcher: document.getElementById('task-view-switcher'),
                addTaskButton: document.getElementById('add-task-button'),
                detailModal: document.getElementById('task-detail-modal'),
                detailModalBody: document.getElementById('task-modal-body'),
                detailModalClose: document.getElementById('task-modal-close-button'),
                deleteTaskButton: document.getElementById('delete-task-button'),
                sessionTimerDisplay: document.getElementById('task-modal-session-timer-display'),
            }
        };

        // --- Utility Functions ---
        const formatCurrency = (v) => `$${(v || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        const formatPercent = (v) => `${(v * 100).toFixed(1)}%`;
        
        const getTagColor = (tagName) => {
            const colors = [
                { bg: '#fee2e2', text: '#b91c1c' }, { bg: '#ffedd5', text: '#c2410c' }, { bg: '#fef9c3', text: '#a16207' },
                { bg: '#dcfce7', text: '#166534' }, { bg: '#dbeafe', text: '#1d4ed8' }, { bg: '#e0e7ff', text: '#4338ca' },
                { bg: '#f3e8ff', text: '#7e22ce' }, { bg: '#fae8ff', text: '#a21caf' }, { bg: '#ffe4e6', text: '#be123c' }
            ];
            let hash = 0;
            for (let i = 0; i < tagName.length; i++) {
                hash = tagName.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash % colors.length)];
        };
        
        // --- State Management (LocalStorage) ---
        const saveState = () => {
            try {
                const stateToSave = {
                    entries: state.entries.map(({dateObj, ...rest}) => rest),
                    tasks: state.tasks,
                    projects: state.projects,
                    theme: state.theme,
                };
                localStorage.setItem('dashboardState-v22', JSON.stringify(stateToSave));
                localStorage.setItem('lastRecurringCheck-v22', new Date().toISOString());
            } catch (error) {
                console.error("Failed to save state to localStorage:", error);
            }
        };
        const loadState = () => {
            const savedStateJSON = localStorage.getItem('dashboardState-v22');
            
            if (savedStateJSON) {
                const savedState = JSON.parse(savedStateJSON);
                state.entries = (savedState.entries || initialData).map(e => ({...e, dateObj: parseISO(e.date)}));
                state.tasks = savedState.tasks || initialTasks;
                state.projects = savedState.projects || initialProjects;
                state.theme = savedState.theme || 'light';
            } else {
                 state.entries = initialData.map(e => ({...e, dateObj: parseISO(e.date)}));
                state.tasks = initialTasks;
                state.projects = initialProjects;
                state.theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
        };
        
        // --- Charting ---
        const chartStyler = {
            grid: () => state.theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)',
            labels: () => state.theme === 'dark' ? '#94A3B8' : '#64748b',
            legend: () => state.theme === 'dark' ? '#F8FAFC' : '#334155',
            sectorColors: ['#6366f1', '#ec4899', '#f97316', '#22c55e', '#facc15', '#38bdf8', '#8b5cf6', '#ef4444'],
            getColor: function(index) { return this.sectorColors[index % this.sectorColors.length]; },
        };

        const renderChart = (id, config) => {
            const ctx = document.getElementById(id)?.getContext('2d');
            if (!ctx) return;
            if (state.chartInstances[id]) state.chartInstances[id].destroy();
            state.chartInstances[id] = new Chart(ctx, config);
        };
        
        const renderAllCharts = (filteredData) => {
            renderMainRevenueChart(filteredData);
            renderDailySalesBarChart(filteredData);
            renderRevenueBySectorChart(filteredData);
            renderSourcePieChart(filteredData);
            renderBusinessPieChart(filteredData);
        };

        const renderMainRevenueChart = (data) => {
             const getGroupedData = () => {
                if (!data.length) return { labels: [], revenue: [], expenses: [] };
                
                const sorted = [...data].sort((a, b) => a.dateObj - b.dateObj);
                
                const daysInRange = (state.ui.dateRange.end - state.ui.dateRange.start) / (1000 * 60 * 60 * 24);
                let interval, fmt, periodFn;
                
                if (daysInRange < 0) return { labels: [], revenue: [], expenses: [] };
                if (daysInRange <= 31) { // Daily
                     interval = eachDayOfInterval({start:state.ui.dateRange.start, end:state.ui.dateRange.end}); 
                     fmt = 'MMM d'; periodFn = (d) => d;
                } else if (daysInRange <= 180) { // Weekly
                    interval = eachWeekOfInterval({start:state.ui.dateRange.start, end:state.ui.dateRange.end},{weekStartsOn:1}); 
                    fmt = "'Wk' w, yy"; periodFn = (d) => startOfWeek(d, {weekStartsOn:1});
                } else { // Monthly
                    interval = eachMonthOfInterval({start:state.ui.dateRange.start, end:state.ui.dateRange.end}); 
                    fmt = 'MMM yy'; periodFn = startOfMonth;
                }

                const map = new Map(interval.map(d => [format(d, fmt), { revenue: 0, expenses: 0 }]));
                for (const entry of sorted) {
                    const key = format(periodFn(entry.dateObj), fmt);
                    if (map.has(key)) {
                        const periodData = map.get(key);
                        if (entry.type === 'revenue') {
                            periodData.revenue += entry.amount;
                            periodData.expenses += (entry.fulfillmentExpense || 0);
                        } else {
                            periodData.expenses += entry.amount;
                        }
                    }
                }
                return { labels: [...map.keys()], revenue: [...map.values()].map(v => v.revenue), expenses: [...map.values()].map(v => v.expenses) };
            };
            const { labels, revenue, expenses } = getGroupedData();
            renderChart('revenue-line-chart', { type: 'line', data: { labels, datasets: [ { label: 'Revenue', data: revenue, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 6 }, { label: 'Expenses', data: expenses, borderColor: '#ec4899', backgroundColor: 'rgba(236, 72, 153, 0.1)', fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 6 } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: chartStyler.labels(), callback: v => `$${v/1000}k` }, grid: { color: chartStyler.grid() }, border: { dash: [4, 4] } }, x: { ticks: { color: chartStyler.labels() }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } } } });
        };
        
        const renderDailySalesBarChart = (data) => {
            const recentEntries = data.filter(e => e.type === 'revenue');
            
            const salesByDay = recentEntries.reduce((acc, e) => {
                const day = format(e.dateObj, 'MMM d');
                acc[day] = (acc[day] || 0) + e.amount;
                return acc;
            }, {});

            const labels = Object.keys(salesByDay);
            const salesData = Object.values(salesByDay);
            renderChart('daily-sales-bar-chart', { type: 'bar', data: { labels, datasets: [{ label: 'Sales', data: salesData, backgroundColor: '#818cf8', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: chartStyler.labels() }, grid: { color: chartStyler.grid() } }, x: { ticks: { color: chartStyler.labels() }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.dataset.label}: ${formatCurrency(c.raw)}` } } } } });
        };

        const renderRevenueBySectorChart = (data) => {
            const revenueEntriesWithSector = data.filter(e => e.type === 'revenue' && e.sector && e.sector.trim() !== '');
            const chartId = 'revenue-by-sector-chart';
            const chartInstance = state.chartInstances[chartId];

            if (revenueEntriesWithSector.length === 0) {
                DOMElements.sectorChart.wrapper.classList.add('hidden');
                DOMElements.sectorChart.legendContainer.classList.add('hidden');
                DOMElements.sectorChart.noData.classList.remove('hidden');
                if (chartInstance) {
                    chartInstance.destroy();
                    delete state.chartInstances[chartId];
                }
                return;
            }
            
            DOMElements.sectorChart.wrapper.classList.remove('hidden');
            DOMElements.sectorChart.legendContainer.classList.remove('hidden');
            DOMElements.sectorChart.noData.classList.add('hidden');

            const sectors = [...new Set(revenueEntriesWithSector.map(e => e.sector))].sort();
            const sectorColorMap = new Map(sectors.map((s, i) => [s, chartStyler.getColor(i)]));

            const daysInRange = (state.ui.dateRange.end - state.ui.dateRange.start) / (1000 * 60 * 60 * 24);
            let interval, fmt, periodFn;

            if (daysInRange < 0) return;
            if (daysInRange <= 31) { // Daily
                 interval = eachDayOfInterval({start:state.ui.dateRange.start, end:state.ui.dateRange.end}); 
                 fmt = 'MMM d'; periodFn = (d) => d;
            } else if (daysInRange <= 180) { // Weekly
                interval = eachWeekOfInterval({start:state.ui.dateRange.start, end:state.ui.dateRange.end},{weekStartsOn:1}); 
                fmt = "'Wk' w, yy"; periodFn = (d) => startOfWeek(d, {weekStartsOn:1});
            } else { // Monthly
                interval = eachMonthOfInterval({start:state.ui.dateRange.start, end:state.ui.dateRange.end}); 
                fmt = 'MMM yy'; periodFn = startOfMonth;
            }
            
            const labels = interval.map(d => format(d, fmt));
            const groupedData = new Map(labels.map(l => [l, new Map(sectors.map(s => [s, {revenue: 0, profit: 0}]))]));
            
            for (const entry of revenueEntriesWithSector) {
                const key = format(periodFn(entry.dateObj), fmt);
                if (groupedData.has(key) && entry.sector) {
                    const periodMap = groupedData.get(key);
                    if (periodMap.has(entry.sector)) {
                        const sectorData = periodMap.get(entry.sector);
                        sectorData.revenue += entry.amount;
                        sectorData.profit += (entry.amount - (entry.fulfillmentExpense || 0));
                    }
                }
            }
            
            const datasets = sectors.map(sector => {
                const data = [];
                const customData = [];
                labels.forEach(label => {
                    const dataPoint = groupedData.get(label)?.get(sector);
                    const revenue = dataPoint?.revenue || 0;
                    const profit = dataPoint?.profit || 0;
                    const margin = revenue > 0 ? profit / revenue : 0;
                    data.push(revenue);
                    customData.push({ profit, margin });
                });

                return {
                    label: sector,
                    data: data,
                    customData: customData,
                    backgroundColor: sectorColorMap.get(sector),
                    borderRadius: 2,
                    barPercentage: 0.7,
                    categoryPercentage: 0.8
                }
            });

            const legendContainer = DOMElements.sectorChart.legendContainer;
            legendContainer.innerHTML = '';
            datasets.forEach((dataset, index) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item flex items-center gap-2';
                legendItem.innerHTML = `<span class="w-3 h-3 rounded-full" style="background-color: ${dataset.backgroundColor}"></span><span>${dataset.label}</span>`;
                
                legendItem.onclick = () => {
                    const chart = state.chartInstances[chartId];
                    if (chart) {
                        const meta = chart.getDatasetMeta(index);
                        meta.hidden = meta.hidden === true ? false : true;
                        legendItem.classList.toggle('hidden-dataset', meta.hidden);
                        chart.update();
                    }
                };
                legendContainer.appendChild(legendItem);
            });

            renderChart(chartId, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, ticks: { color: chartStyler.labels(), maxRotation: 0, autoSkip: true, maxTicksLimit: 7 }, grid: { display: false } },
                        y: { stacked: true, ticks: { color: chartStyler.labels(), callback: v => `$${v/1000}k` }, grid: { color: chartStyler.grid() } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const revenue = context.parsed.y || 0;
                                    const customInfo = context.dataset.customData[context.dataIndex];
                                    
                                    if (!customInfo) {
                                        return `${label}: ${formatCurrency(revenue)}`;
                                    }

                                    const { profit, margin } = customInfo;
                                    
                                    return [
                                        `${label}: ${formatCurrency(revenue)}`,
                                        `Profit: ${formatCurrency(profit)}`,
                                        `Margin: ${formatPercent(margin)}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        };

        const createPieChartConfig = (dataMap) => ({
            type: 'doughnut',
            data: { labels: [...dataMap.keys()], datasets: [{ data: [...dataMap.values()], backgroundColor: chartStyler.sectorColors, borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.label}: ${formatCurrency(c.raw)}` } } } }
        });

        const renderSourcePieChart = (data) => {
            const sourceMap = data.filter(e => e.type === 'revenue' && e.customerSource && e.customerSource !== 'N/A').reduce((acc, e) => acc.set(e.customerSource, (acc.get(e.customerSource) || 0) + e.amount), new Map());
            renderChart('source-pie-chart', createPieChartConfig(sourceMap));
        };
        
        const renderBusinessPieChart = (data) => {
            const businessMap = data.filter(e => e.type === 'revenue' && e.business).reduce((acc, e) => acc.set(e.business, (acc.get(e.business) || 0) + e.amount), new Map());
            renderChart('business-pie-chart', createPieChartConfig(businessMap));
        };

        const renderKpiCards = (data) => {
            const revenueEntries = data.filter(e => e.type === 'revenue');
            const expenseEntries = data.filter(e => e.type === 'expense');

            const totalRevenue = revenueEntries.reduce((sum, e) => sum + e.amount, 0);
            const fulfillmentCosts = revenueEntries.reduce((sum, e) => sum + (e.fulfillmentExpense || 0), 0);
            const totalExpenses = expenseEntries.reduce((sum, e) => sum + e.amount, 0) + fulfillmentCosts;
            const netProfit = totalRevenue - totalExpenses;
            const newCustomers = new Set(revenueEntries.filter(e => e.status === 'New Customer').map(e => e.itemName)).size;
            
            const kpis = [
                { label: 'Total Revenue', value: formatCurrency(totalRevenue), icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>' },
                { label: 'Net Profit', value: formatCurrency(netProfit), icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>' },
                { label: 'Total Expenses', value: formatCurrency(totalExpenses), icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="16" height="16" x="4" y="4" rx="2"/><path d="M9 12h6"/></svg>' },
                { label: 'New Customers', value: newCustomers, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>' },
            ];

            DOMElements.kpiCardContainer.innerHTML = kpis.map(kpi => `
                <div class="dashboard-card bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border flex items-start gap-4">
                    <div class="bg-blue-100 dark:bg-blue-500/20 text-blue-600 dark:text-blue-400 p-3 rounded-lg">${kpi.icon}</div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-dark-text-secondary">${kpi.label}</p>
                        <p class="text-2xl font-bold">${kpi.value}</p>
                    </div>
                </div>
            `).join('');
        };
        
        const renderDashboard = () => {
            const { start, end } = state.ui.dateRange;
            const filteredData = state.entries.filter(e => {
                const entryDate = e.dateObj;
                return entryDate >= start && entryDate <= end;
            });
            
            renderKpiCards(filteredData);
            renderAllCharts(filteredData);
            renderBusinessBreakdown(filteredData);
            renderTransactionTable(filteredData);
        };
        
        const renderTasks = () => {
            DOMElements.tasks.viewSwitcher.querySelectorAll('.task-view-btn').forEach(btn => {
                const isActive = btn.dataset.view === state.ui.activeTaskView;
                btn.classList.toggle('bg-blue-600', isActive);
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('dark:bg-blue-500', isActive);
            });

            switch (state.ui.activeTaskView) {
                case 'board': renderTaskBoard(); break;
                case 'list': renderTaskListView(); break;
                case 'calendar': renderTaskCalendarView(); break;
                case 'analytics': renderTaskAnalytics(); break;
            }
        };

        const renderTaskBoard = () => {
            const columns = { 'To Do': [], 'In Progress': [], 'Done': [] };
            state.tasks.forEach(task => columns[task.status]?.push(task));

            DOMElements.tasks.content.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                ${Object.entries(columns).map(([status, tasks]) => `
                    <div class="bg-transparent rounded-xl">
                        <h3 class="font-semibold text-lg mb-4 text-gray-800 dark:text-gray-200 flex justify-between items-center">${status} <span class="text-sm bg-gray-200 dark:bg-dark-surface/50 px-2 py-0.5 rounded-full">${tasks.length}</span></h3>
                        <div class="space-y-4 drop-zone" data-status="${status}">
                            ${tasks.map(task => {
                                const subtasksDone = (task.subtasks || []).filter(st => st.done).length;
                                const totalSubtasks = (task.subtasks || []).length;
                                const colors = getTagColor(task.tags?.[0] || 'default');
                                return `
                                <div class="task-card bg-white dark:bg-dark-surface p-4 rounded-lg shadow-md border-l-4" style="border-left-color: ${colors.text};" draggable="true" data-task-id="${task.id}">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-semibold mb-2 flex-1">${task.title}</h4>
                                        <div class="live-timer-display text-sm font-bold text-blue-500" data-timer-for="${task.id}"></div>
                                    </div>
                                    <p class="text-sm text-gray-500 dark:text-dark-text-secondary mb-2">${state.projects.find(p => p.id === task.projectId)?.name || 'N/A'}</p>
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        ${(task.tags || []).map(tag => {
                                            const tagColors = getTagColor(tag);
                                            return `<span class="text-xs font-semibold px-2 py-1 rounded-full" style="background-color:${tagColors.bg}; color:${tagColors.text};">${tag}</span>`
                                        }).join('')}
                                    </div>
                                    <div class="flex justify-between items-center text-sm text-gray-500 dark:text-dark-text-secondary">
                                        ${task.dueDate ? `<span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline-block -mt-1 mr-1"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>${format(parseISO(task.dueDate), 'MMM d')}</span>` : '<span></span>'}
                                        ${totalSubtasks > 0 ? `<span class="flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 12 2 2 4-4" /></svg>${subtasksDone}/${totalSubtasks}</span>` : ''}
                                    </div>
                                </div>
                            `}).join('')}
                             <div class="h-2"></div>
                        </div>
                    </div>
                `).join('')}
            </div>`;
            setupDragAndDrop();
        };
        
        const renderTaskListView = () => {
            const { key, order } = state.ui.taskSort;
            const statusFilter = state.ui.activeTaskStatusFilter;
            const searchQuery = state.ui.taskSearchQuery.toLowerCase();
            const projects = state.projects;

            let filteredTasks = [...state.tasks];

            // 1. Filter by status
            if (statusFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
            }

            // 2. Filter by search query (title, description, tags, project name)
            if (searchQuery) {
                filteredTasks = filteredTasks.filter(task =>
                    task.title.toLowerCase().includes(searchQuery) ||
                    (task.description && task.description.toLowerCase().includes(searchQuery)) ||
                    (task.tags && task.tags.join(' ').toLowerCase().includes(searchQuery)) ||
                    (projects.find(p => p.id === task.projectId)?.name.toLowerCase().includes(searchQuery))
                );
            }

            // 3. Sort the remaining tasks
            const sortedTasks = filteredTasks.sort((a,b) => {
                const valA = a[key] || 0;
                const valB = b[key] || 0;
                if (!valA) return 1; // Put tasks without a value (e.g. due date) at the end
                if (!valB) return -1;
                return (valA < valB ? -1 : valA > valB ? 1 : 0) * (order === 'asc' ? 1 : -1);
            });

            const renderHeader = (k, t) => { 
                const isCurr = key === k; 
                return `<th class="p-4 font-semibold sortable" data-sort-key="${k}"><span class="flex items-center gap-2">${t}<span class="sort-indicator">${isCurr ? (order === 'asc' ? '▲' : '▼') : '▼'}</span></span></th>`; 
            };
            
            const statusFilterButtons = ['all', 'To Do', 'In Progress', 'Done'];

             DOMElements.tasks.content.innerHTML = `
                <div class="bg-white dark:bg-dark-surface rounded-xl shadow-lg border border-gray-200 dark:border-dark-border overflow-hidden">
                    <div class="p-4 border-b dark:border-dark-border flex flex-wrap items-center gap-4">
                        <div class="relative flex-grow min-w-[240px]">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                            <input id="task-search-input" type="text" placeholder="Search tasks by title, tag, project..." class="w-full pl-10 pr-4 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-dark-border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${state.ui.taskSearchQuery}">
                        </div>
                        <div id="task-status-filters" class="flex items-center border border-gray-200 dark:border-dark-border rounded-lg p-1 space-x-1">
                            ${statusFilterButtons.map(status => `<button class="table-tab-btn ${status === statusFilter ? 'active' : ''}" data-status="${status}">${status}</button>`).join('')}
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 dark:bg-dark-surface/50">
                                <tr class="text-sm dark:text-dark-text-secondary">
                                    <th class="p-4 w-10"></th>
                                    ${renderHeader('title', 'Task')}
                                    ${renderHeader('projectId', 'Project')}
                                    ${renderHeader('dueDate', 'Due Date')}
                                    ${renderHeader('priority', 'Priority')}
                                    ${renderHeader('status', 'Status')}
                                    ${renderHeader('timeEstimate', 'Estimate')}
                                    <th class="p-4 font-semibold">Time Logged</th>
                                </tr>
                            </thead>
                            <tbody id="task-list-body">
                                ${sortedTasks.map(task => {
                                    const priorityDot = { Low: 'bg-green-500', Medium: 'bg-yellow-500', High: 'bg-red-500' };
                                    const isExpanded = state.ui.expandedListTasks[task.id];
                                    return `
                                    <tr class="list-view-row border-t dark:border-dark-border hover:bg-gray-50 dark:hover:bg-gray-800/50 ${isExpanded ? 'expanded' : ''}" data-task-id="${task.id}">
                                        <td class="p-4 text-center">
                                            ${(task.subtasks || []).length > 0 ? `<button class="list-view-expand-btn p-1 rounded-full hover:bg-gray-200 dark:hover:bg-dark-border"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" /></svg></button>` : ''}
                                        </td>
                                        <td class="p-4 font-semibold task-title-cell cursor-pointer">${task.title}</td>
                                        <td class="p-4">${state.projects.find(p => p.id === task.projectId)?.name || 'N/A'}</td>
                                        <td class="p-4">${task.dueDate ? format(parseISO(task.dueDate), 'MMM d, yy') : 'N/A'}</td>
                                        <td class="p-4"><div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full ${priorityDot[task.priority]}"></div><span>${task.priority}</span></div></td>
                                        <td class="p-4">${task.status}</td>
                                        <td class="p-4">${task.timeEstimate > 0 ? `${task.timeEstimate}m` : 'N/A'}</td>
                                        <td class="p-4 font-mono">
                                            <div class="flex items-center justify-between">
                                                <span>${formatTime(calculateTotalTime(task))}</span>
                                                <div class="live-timer-display text-sm font-bold text-blue-500" data-timer-for="${task.id}"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr class="subtasks-row ${isExpanded ? '' : 'hidden'}" data-subtask-for="${task.id}">
                                        <td colspan="8" class="p-0">
                                            <div class="subtasks-container-in-list p-4 pl-16">
                                                <h4 class="font-semibold text-sm mb-2">Sub-tasks</h4>
                                                ${(task.subtasks || []).length > 0 ? (task.subtasks || []).map(st => `
                                                    <div class="flex items-center gap-2 py-1 text-sm">
                                                        <input type="checkbox" ${st.done ? 'checked' : ''} class="subtask-checkbox-list h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" data-task-id="${task.id}" data-subtask-id="${st.id}">
                                                        <span class="${st.done ? 'line-through text-gray-500' : ''}">${st.title}</span>
                                                    </div>
                                                `).join('') : '<p class="text-sm text-gray-500">No sub-tasks.</p>'}
                                            </div>
                                        </td>
                                    </tr>
                                `}).join('')}
                                ${sortedTasks.length === 0 ? `<tr><td colspan="8" class="text-center p-8 text-gray-500">No tasks match your criteria.</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            // Add listeners for search, filters, sort, and expand/open
            const searchInput = DOMElements.tasks.content.querySelector('#task-search-input');
            const statusFilterContainer = DOMElements.tasks.content.querySelector('#task-status-filters');
            
            searchInput.addEventListener('input', e => {
                state.ui.taskSearchQuery = e.target.value;
                renderTaskListView();
            });

            // Restore focus to search input after re-render to allow continuous typing
            setTimeout(() => {
                const newSearchInput = document.getElementById('task-search-input');
                if (newSearchInput && document.activeElement !== newSearchInput) {
                    const currentVal = newSearchInput.value;
                    newSearchInput.focus();
                    newSearchInput.setSelectionRange(currentVal.length, currentVal.length);
                }
            }, 0);


            statusFilterContainer.addEventListener('click', e => {
                const button = e.target.closest('[data-status]');
                if (button) {
                    state.ui.activeTaskStatusFilter = button.dataset.status;
                    renderTaskListView();
                }
            });

            DOMElements.tasks.content.querySelector('thead').addEventListener('click', e => {
                const th = e.target.closest('[data-sort-key]');
                if (!th) return;
                const newKey = th.dataset.sortKey;
                state.ui.taskSort.order = state.ui.taskSort.key === newKey && state.ui.taskSort.order === 'asc' ? 'desc' : 'asc';
                state.ui.taskSort.key = newKey;
                renderTaskListView();
            });

            DOMElements.tasks.content.querySelector('#task-list-body').addEventListener('click', e => {
                const expandBtn = e.target.closest('.list-view-expand-btn');
                const titleCell = e.target.closest('.task-title-cell');
                const row = e.target.closest('.list-view-row');

                if (expandBtn) {
                    e.stopPropagation();
                    const taskId = row.dataset.taskId;
                    state.ui.expandedListTasks[taskId] = !state.ui.expandedListTasks[taskId];
                    renderTaskListView();
                } else if (titleCell) {
                    openTaskModal(row.dataset.taskId);
                }
            });
        };

        const renderTaskCalendarView = () => {
            const date = state.ui.currentCalendarDate;
            const monthStart = startOfMonth(date);
            const monthEnd = endOfMonth(date);
            const days = eachDayOfInterval({ start: monthStart, end: monthEnd });
            const startingDayOfWeek = getDay(monthStart) === 0 ? 6 : getDay(monthStart) - 1; // 0=Mon, 6=Sun
            
            const tasksByDate = state.tasks.reduce((acc, task) => {
                if (task.dueDate) { // Check if dueDate exists
                    const parsedDate = parseISO(task.dueDate);
                    // Check if parsing was successful and resulted in a valid date
                    if (!isNaN(parsedDate)) {
                        const dateKey = format(parsedDate, 'yyyy-MM-dd');
                        if (!acc[dateKey]) acc[dateKey] = [];
                        acc[dateKey].push(task);
                    } else {
                        // Log a warning for tasks with invalid dates, but don't stop execution
                        console.warn(`Skipping task with invalid due date: "${task.title}" - "${task.dueDate}"`);
                    }
                }
                return acc;
            }, {});

            DOMElements.tasks.content.innerHTML = `
                <div class="bg-white dark:bg-dark-surface rounded-xl shadow-lg border border-gray-200 dark:border-dark-border p-4">
                    <div class="flex justify-between items-center mb-4">
                        <button id="cal-prev" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-border">&lt;</button>
                        <h3 class="text-xl font-bold">${format(date, 'MMMMopencamerastudio')}</h3>
                        <button id="cal-next" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-border">&gt;</button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center font-semibold text-sm text-gray-500 dark:text-dark-text-secondary">
                        <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
                    </div>
                    <div class="grid grid-cols-7 gap-1 mt-2">
                        ${Array(startingDayOfWeek).fill('').map(() => '<div></div>').join('')}
                        ${days.map(day => {
                            const dateKey = format(day, 'yyyy-MM-dd');
                            const tasksForDay = tasksByDate[dateKey] || [];
                            return `
                            <div class="border dark:border-dark-border rounded-md p-2 h-32 overflow-y-auto">
                                <div class="font-semibold text-sm ${isSameDay(day, new Date()) ? 'text-blue-600' : ''}">${format(day, 'd')}</div>
                                <div class="space-y-1 mt-1">
                                ${tasksForDay.map(task => {
                                    const tagColors = getTagColor(task.tags?.[0] || 'default');
                                    return `<div class="text-xs p-1 rounded-md cursor-pointer task-calendar-item" style="background-color:${tagColors.bg}; color:${tagColors.text};" data-task-id="${task.id}">${task.title}</div>`
                                }).join('')}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>`;

            document.getElementById('cal-prev').addEventListener('click', () => { state.ui.currentCalendarDate = addMonths(state.ui.currentCalendarDate, -1); renderTaskCalendarView(); });
            document.getElementById('cal-next').addEventListener('click', () => { state.ui.currentCalendarDate = addMonths(state.ui.currentCalendarDate, 1); renderTaskCalendarView(); });
        };
        
        const renderTaskAnalytics = () => {
             DOMElements.tasks.content.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="dashboard-card bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
                        <h2 class="text-xl font-bold mb-4">Time Spent Per Project</h2>
                        <div class="h-80 relative"><canvas id="time-by-project-chart"></canvas></div>
                    </div>
                    <div class="dashboard-card bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
                        <h2 class="text-xl font-bold mb-4">Tasks Completed Over Time</h2>
                        <div class="h-80 relative"><canvas id="tasks-completed-chart"></canvas></div>
                    </div>
                </div>
             `;

            renderTimeByProjectChart();
            renderTasksCompletedChart();
        }

        const renderTimeByProjectChart = () => {
            const timeByProject = state.tasks.reduce((acc, task) => {
                const projectName = state.projects.find(p => p.id === task.projectId)?.name || 'Unassigned';
                const totalTime = calculateTotalTime(task) / (1000 * 60 * 60); // in hours
                if(!acc[projectName]) acc[projectName] = 0;
                acc[projectName] += totalTime;
                return acc;
            }, {});

            renderChart('time-by-project-chart', {
                type: 'doughnut',
                data: {
                    labels: Object.keys(timeByProject),
                    datasets: [{
                        data: Object.values(timeByProject),
                        backgroundColor: chartStyler.sectorColors,
                        borderWidth: 0,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: chartStyler.legend() } },
                        tooltip: {
                            callbacks: {
                                label: c => `${c.label}: ${c.raw.toFixed(2)} hours`
                            }
                        }
                    }
                }
            });
        };
        
        const renderTasksCompletedChart = () => {
            const completedTasks = state.tasks.filter(t => t.status === 'Done' && t.timeLog.length > 0);
            const tasksByCompletionDate = completedTasks.reduce((acc, task) => {
                const completionDate = format(parseISO(task.timeLog[task.timeLog.length - 1].end), 'MMM d, yy');
                if(!acc[completionDate]) acc[completionDate] = 0;
                acc[completionDate]++;
                return acc;
            }, {});
            
            const sortedDates = Object.keys(tasksByCompletionDate).sort((a,b) => new Date(a) - new Date(b));
            
            renderChart('tasks-completed-chart', {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Tasks Completed',
                        data: sortedDates.map(date => tasksByCompletionDate[date]),
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { color: chartStyler.labels(), stepSize: 1 }, grid: { color: chartStyler.grid() } },
                        x: { ticks: { color: chartStyler.labels() }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        };

        const openTaskModal = (taskId) => {
             let task;
             if(taskId) {
                task = state.tasks.find(t => t.id === taskId);
                if (!task) { console.error("Task not found!"); return; }
             } else {
                task = { id: crypto.randomUUID(), title: '', status: 'To Do', priority: 'Medium', projectId: state.projects[0]?.id || '', tags: [], subtasks: [], dueDate: '', timeLog: [], description: '', timeEstimate: 0 };
                state.tasks.push(task);
             }
            state.taskToDelete = task.id;
            
            const projectOptions = state.projects.map(p => `<option value="${p.id}" ${p.id === task.projectId ? 'selected' : ''}>${p.name}</option>`).join('');
            const priorityOptions = ['Low', 'Medium', 'High'].map(p => `<option value="${p}" ${p === task.priority ? 'selected' : ''}>${p}</option>`).join('');
            const statusOptions = ['To Do', 'In Progress', 'Done'].map(s => `<option value="${s}" ${s === task.status ? 'selected' : ''}>${s}</option>`).join('');
            const inputStyling = "text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400";
            const selectStyling = "text-gray-900 dark:text-white";

            DOMElements.tasks.detailModalBody.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">
                    <div class="md:col-span-2 space-y-6">
                        <input type="text" id="task-title" value="${task.title}" placeholder="Task Title" class="text-2xl font-bold w-full bg-transparent focus:outline-none border-b-2 border-gray-200 dark:border-dark-border focus:border-blue-500 transition pb-2 ${inputStyling}">
                        
                        <div>
                            <label class="block text-sm font-medium dark:text-dark-text-secondary mb-1">Description</label>
                            <textarea id="task-description" rows="3" class="block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg ${inputStyling}" placeholder="Add a more detailed description...">${task.description || ''}</textarea>
                        </div>

                        <div>
                            <h4 class="font-semibold mb-2">Sub-tasks</h4>
                            <div id="subtask-list" class="space-y-1">
                                ${(task.subtasks || []).map(st => `
                                <div class="subtask-item border-t dark:border-dark-border/50">
                                    <div class="subtask-item-header flex items-center gap-2 p-2 ${state.ui.expandedSubtasks[st.id] ? 'expanded' : ''}" data-subtask-id="${st.id}">
                                        <svg class="expand-icon h-4 w-4 text-gray-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" /></svg>
                                        <input type="checkbox" class="subtask-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 flex-shrink-0" ${st.done ? 'checked' : ''}>
                                        <input type="text" value="${st.title}" class="subtask-title-input flex-grow bg-transparent focus:outline-none ${selectStyling}">
                                        <button class="remove-subtask text-gray-400 hover:text-red-500 text-lg flex-shrink-0">&times;</button>
                                    </div>
                                    <div class="subtask-item-body p-4 space-y-4 ${state.ui.expandedSubtasks[st.id] ? 'expanded' : ''}">
                                        <div>
                                            <label class="block text-xs font-medium dark:text-dark-text-secondary mb-1">Notes</label>
                                            <textarea class="subtask-description w-full text-sm p-2 bg-gray-100 dark:bg-slate-800 rounded-md ${inputStyling}" rows="2" placeholder="Add notes for this sub-task...">${st.description || ''}</textarea>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium dark:text-dark-text-secondary mb-1">Attachments</label>
                                            <div class="subtask-attachments space-y-2">
                                                ${(st.attachments || []).map((att, i) => `
                                                    <div class="flex items-center gap-2 text-sm">
                                                        <img src="${att.url}" class="w-8 h-8 object-cover rounded" alt="attachment">
                                                        <a href="${att.url}" target="_blank" class="text-blue-500 hover:underline flex-grow truncate">${att.url}</a>
                                                        <button class="remove-subtask-attachment text-gray-400 hover:text-red-500" data-index="${i}">&times;</button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <button class="add-subtask-attachment mt-2 text-xs text-blue-600 hover:text-blue-800 font-semibold">+ Add Image URL</button>
                                            <p class="text-xs text-gray-400 mt-1">Note: Use public image URLs. Pasted local/blob images cannot be saved.</p>
                                        </div>
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                            <button id="add-subtask-btn" class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-semibold">+ Add sub-task</button>
                        </div>
                    </div>

                    <div class="md:col-span-1 space-y-4">
                        <div class="bg-gray-50 dark:bg-dark-surface/50 p-4 rounded-lg space-y-4">
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Status</label>
                                <select id="task-status" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg ${selectStyling}">${statusOptions}</select>
                            </div>
                             <div>
                                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Project</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <select id="task-project" class="block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg ${selectStyling}">${projectOptions}</select>
                                    <button id="add-project-btn" class="p-2 bg-gray-200 dark:bg-slate-700 rounded-md hover:bg-gray-300 dark:hover:bg-slate-600" title="Add New Project">+</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Priority</label>
                                <select id="task-priority" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg ${selectStyling}">${priorityOptions}</select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Due Date</label>
                                <input type="date" id="task-due-date" value="${task.dueDate || ''}" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg ${selectStyling}">
                            </div>
                             <div>
                                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Tags</label>
                                <input type="text" id="task-tags" value="${(task.tags || []).join(', ')}" placeholder="e.g. marketing, bug" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg ${inputStyling}">
                            </div>
                        </div>

                        <div id="time-tracker-module" class="bg-gray-50 dark:bg-dark-surface/50 p-4 rounded-lg space-y-4">
                            <h4 class="font-semibold text-center">Time Management</h4>
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Time Estimate (minutes)</label>
                                <input type="number" id="task-time-estimate" value="${task.timeEstimate || '0'}" class="mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg ${inputStyling}">
                            </div>
                            <div class="text-center">
                                <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Total Time Logged</p>
                                <p id="total-time-display" class="font-mono text-2xl font-bold">${formatTime(calculateTotalTime(task))}</p>
                            </div>
                            <div id="session-timer-controls" class="border-t dark:border-dark-border pt-4 space-y-3">
                                <p class="text-center text-sm font-semibold">Start a Timed Session</p>
                                <div class="flex justify-center gap-2">
                                    <button data-mins="15" class="session-preset-btn text-sm px-3 py-1 bg-gray-200 dark:bg-slate-700 rounded-md">15m</button>
                                    <button data-mins="30" class="session-preset-btn text-sm px-3 py-1 bg-gray-200 dark:bg-slate-700 rounded-md">30m</button>
                                    <button data-mins="45" class="session-preset-btn text-sm px-3 py-1 bg-gray-200 dark:bg-slate-700 rounded-md">45m</button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="session-custom-mins" placeholder="Custom" class="w-full px-2 py-1 bg-gray-100 dark:bg-slate-800 border-gray-300 dark:border-dark-border rounded-md text-sm ${inputStyling}">
                                    <span class="text-sm dark:text-dark-text-secondary">min</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button id="session-toggle-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-sm">Start Session</button>
                                    <button id="session-stop-btn" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm hidden">Stop</button>
                                </div>
                                <button id="add-time-btn" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold text-sm hidden">Add 15 min</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Check timer status and update buttons
            const session = state.activeSessionTimer;
            if (session && session.taskId === task.id) {
                const modalBody = DOMElements.tasks.detailModalBody;
                const toggleBtn = modalBody.querySelector('#session-toggle-btn');
                const stopBtn = modalBody.querySelector('#session-stop-btn');
                const addTimeBtn = modalBody.querySelector('#add-time-btn');

                stopBtn.classList.remove('hidden');
                toggleBtn.textContent = session.isPaused ? 'Resume' : 'Pause';

                const remainingMs = session.isPaused
                    ? session.remainingMsOnPause
                    : Math.max(0, session.durationMs - (Date.now() - session.startTime));
                
                addTimeBtn.classList.toggle('hidden', remainingMs > 600000);
            }

            toggleModal(DOMElements.tasks.detailModal, true);
            updateTaskFromModal(task.id); // Bind events
        };
        
         const updateTaskFromModal = (taskId) => {
            const task = state.tasks.find(t => t.id === taskId);
            if (!task) return;

            const modal = DOMElements.tasks.detailModalBody;
            const save = () => {
                task.title = modal.querySelector('#task-title').value;
                task.description = modal.querySelector('#task-description').value;
                task.status = modal.querySelector('#task-status').value;
                task.projectId = modal.querySelector('#task-project').value;
                task.priority = modal.querySelector('#task-priority').value;
                task.dueDate = modal.querySelector('#task-due-date').value;
                task.timeEstimate = parseInt(modal.querySelector('#task-time-estimate').value, 10) || 0;
                task.tags = modal.querySelector('#task-tags').value.split(',').map(t => t.trim()).filter(Boolean);
                
                // Update subtasks
                task.subtasks = Array.from(modal.querySelectorAll('.subtask-item')).map(itemEl => {
                    const header = itemEl.querySelector('.subtask-item-header');
                    const body = itemEl.querySelector('.subtask-item-body');
                    const subtaskId = header.dataset.subtaskId;

                    const attachments = Array.from(body.querySelectorAll('.subtask-attachments > div')).map((attEl, index) => {
                         const link = attEl.querySelector('a');
                         return { type: 'link', url: link.href };
                    });
                    
                    return {
                        id: subtaskId,
                        title: header.querySelector('.subtask-title-input').value,
                        done: header.querySelector('.subtask-checkbox').checked,
                        description: body.querySelector('.subtask-description').value,
                        attachments: attachments
                    };
                });
                
                saveState();
                renderTasks();
            };
            
            // --- Event Listeners within the modal ---

            // General inputs
            modal.querySelectorAll('input, select, textarea').forEach(el => {
                if (!el.closest('.subtask-item')) { // Exclude subtask inputs for now
                    el.addEventListener('change', save);
                }
            });

            // Sub-task specific listeners
            modal.querySelector('#subtask-list').addEventListener('change', e => {
                 if (e.target.matches('.subtask-checkbox, .subtask-title-input, .subtask-description')) {
                     save();
                 }
            });

            modal.querySelector('#subtask-list').addEventListener('click', e => {
                const subtaskHeader = e.target.closest('.subtask-item-header');
                const removeSubtaskBtn = e.target.closest('.remove-subtask');
                const addAttachmentBtn = e.target.closest('.add-subtask-attachment');
                const removeAttachmentBtn = e.target.closest('.remove-subtask-attachment');

                if (removeSubtaskBtn) {
                    e.stopPropagation();
                    const subtaskId = subtaskHeader.dataset.subtaskId;
                    task.subtasks = task.subtasks.filter(st => st.id !== subtaskId);
                    openTaskModal(taskId);
                } 
                else if (subtaskHeader) {
                    const subtaskId = subtaskHeader.dataset.subtaskId;
                    state.ui.expandedSubtasks[subtaskId] = !state.ui.expandedSubtasks[subtaskId];
                    subtaskHeader.classList.toggle('expanded');
                    subtaskHeader.nextElementSibling.classList.toggle('expanded');
                }
                else if (addAttachmentBtn) {
                    const subtaskItem = addAttachmentBtn.closest('.subtask-item');
                    const subtaskId = subtaskItem.querySelector('.subtask-item-header').dataset.subtaskId;
                    const subtask = task.subtasks.find(st => st.id === subtaskId);
                    const url = prompt("Enter image or resource URL to attach:");
                    if (url && subtask) {
                        if (!subtask.attachments) subtask.attachments = [];
                        subtask.attachments.push({ type: 'link', url });
                        openTaskModal(taskId);
                    }
                }
                else if (removeAttachmentBtn) {
                     const subtaskItem = removeAttachmentBtn.closest('.subtask-item');
                    const subtaskId = subtaskItem.querySelector('.subtask-item-header').dataset.subtaskId;
                    const subtask = task.subtasks.find(st => st.id === subtaskId);
                    const index = parseInt(removeAttachmentBtn.dataset.index, 10);
                    if (subtask && subtask.attachments) {
                        subtask.attachments.splice(index, 1);
                        openTaskModal(taskId);
                    }
                }
            });
            
            modal.querySelector('#add-subtask-btn').onclick = () => {
                if (!task.subtasks) task.subtasks = [];
                const newSubtask = { id: crypto.randomUUID(), title: '', done: false, description: '', attachments: [] };
                task.subtasks.push(newSubtask);
                state.ui.expandedSubtasks[newSubtask.id] = true; // Auto-expand new subtask
                openTaskModal(taskId);
            };
            
            modal.querySelector('#add-project-btn').onclick = () => {
                const newProjectName = prompt("Enter new project name:");
                if (newProjectName && newProjectName.trim()) {
                    const newProject = { id: `proj-${crypto.randomUUID()}`, name: newProjectName.trim() };
                    state.projects.push(newProject);
                    task.projectId = newProject.id;
                    saveState();
                    openTaskModal(taskId);
                }
            };
            
            // Timer session listeners
            const toggleBtn = modal.querySelector('#session-toggle-btn');
            const stopBtn = modal.querySelector('#session-stop-btn');
            const addTimeBtn = modal.querySelector('#add-time-btn');

            toggleBtn.onclick = () => {
                const session = state.activeSessionTimer;
                if (session && session.taskId === taskId) {
                    session.isPaused ? resumeTimerSession() : pauseTimerSession();
                } else {
                    const customMins = parseInt(modal.querySelector('#session-custom-mins').value, 10);
                    if (customMins > 0) {
                        startTimerSession(taskId, customMins * 60 * 1000);
                    }
                }
            };
            stopBtn.onclick = () => stopTimerSession();
            addTimeBtn.onclick = () => {
                if (state.activeSessionTimer && state.activeSessionTimer.taskId === taskId) {
                    state.activeSessionTimer.durationMs += 15 * 60 * 1000;
                }
            };
            modal.querySelectorAll('.session-preset-btn').forEach(btn => {
                btn.onclick = () => {
                    const mins = parseInt(btn.dataset.mins, 10);
                    modal.querySelector('#session-custom-mins').value = mins;
                };
            });
        };
        
        const closeTaskModal = () => {
            const task = state.tasks.find(t => t.id === state.taskToDelete);
            
            if(task && !task.title.trim()) {
                state.tasks = state.tasks.filter(t => t.id !== task.id);
            }
            toggleModal(DOMElements.tasks.detailModal, false);
            state.taskToDelete = null;
            state.ui.expandedSubtasks = {}; // Clear expansion state on close
            renderTasks(); // Re-render the main view
        };

        const deleteTask = () => {
            if (state.taskToDelete) {
                if(state.activeSessionTimer && state.activeSessionTimer.taskId === state.taskToDelete) {
                    stopTimerSession();
                }
                state.tasks = state.tasks.filter(t => t.id !== state.taskToDelete);
                saveState();
                closeTaskModal();
            }
        };

        const setupDragAndDrop = () => {
            const cards = document.querySelectorAll('.task-card');
            const dropZones = document.querySelectorAll('.drop-zone');

            cards.forEach(card => {
                // Mouse-based drag and drop for desktop
                card.addEventListener('dragstart', (e) => {
                    if (e.target.matches('button, a, input')) { e.preventDefault(); return; }
                    draggedTaskId = e.target.closest('.task-card').dataset.taskId;
                    e.target.classList.add('dragging');
                });
                card.addEventListener('dragend', (e) => {
                    draggedTaskId = null;
                    e.target.classList.remove('dragging');
                });
                card.addEventListener('click', (e) => {
                     if (!e.target.closest('.task-card').classList.contains('dragging')) {
                        const taskId = e.target.closest('.task-card').dataset.taskId;
                        openTaskModal(taskId);
                    }
                });

                // Touch-based long-press for mobile
                let pressTimer;
                card.addEventListener('touchstart', (e) => {
                    if (e.touches.length > 1) return; // Ignore multi-touch gestures
                    pressTimer = window.setTimeout(() => {
                        pressTimer = null; // Prevent clear on touchend
                        openMoveTaskModal(card.dataset.taskId);
                    }, 500);
                }, { passive: true });
                card.addEventListener('touchend', () => clearTimeout(pressTimer));
                card.addEventListener('touchmove', () => clearTimeout(pressTimer));
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', (e) => { zone.classList.remove('drag-over'); });
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    const newStatus = zone.dataset.status;
                    const task = state.tasks.find(t => t.id === draggedTaskId);
                    if (task && task.status !== newStatus) {
                        task.status = newStatus;
                        saveState();
                        renderTaskBoard();
                    }
                });
            });
        };

        const openMoveTaskModal = (taskId) => {
            const task = state.tasks.find(t => t.id === taskId);
            if (!task) return;
            state.taskToMove = taskId;

            const statuses = ['To Do', 'In Progress', 'Done'];
            const optionsContainer = DOMElements.moveTaskModal.optionsContainer;
            optionsContainer.innerHTML = statuses
                .filter(s => s !== task.status)
                .map(status => `<button data-status="${status}" class="w-full px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">${status}</button>`)
                .join('');
            
            toggleModal(DOMElements.moveTaskModal.modal, true);
        };
        
        // --- Time Tracking ---
        const calculateTotalTime = (task) => {
             if (!task.timeLog) return 0;
            return task.timeLog.reduce((total, log) => {
                const end = log.end ? parseISO(log.end) : new Date();
                return total + (end - parseISO(log.start));
            }, 0);
        };
        
        const formatTime = (ms) => {
            if (ms <= 0) return '00:00:00';
            const duration = intervalToDuration({ start: 0, end: ms });
            const zeroPad = (num) => String(num).padStart(2, '0');
            const hours = (duration.days ? duration.days * 24 : 0) + (duration.hours || 0);
            return `${zeroPad(hours)}:${zeroPad(duration.minutes || 0)}:${zeroPad(duration.seconds || 0)}`;
        };

        const startTimerSession = (taskId, durationMs) => {
            if (state.activeSessionTimer) stopTimerSession();

            state.activeSessionTimer = {
                taskId,
                startTime: Date.now(),
                durationMs,
                isPaused: false,
                remainingMsOnPause: 0,
                notified10min: false,
            };

            const intervalId = setInterval(updateCountdownDisplay, 1000);
            state.activeSessionTimer.intervalId = intervalId;

            const modal = DOMElements.tasks.detailModalBody;
            if(modal) {
                modal.querySelector('#session-toggle-btn').textContent = 'Pause';
                modal.querySelector('#session-stop-btn').classList.remove('hidden');
            }
            updateCountdownDisplay();
        };
        
        const pauseTimerSession = () => {
            const session = state.activeSessionTimer;
            if (!session || session.isPaused) return;

            clearInterval(session.intervalId);
            session.isPaused = true;
            const elapsedSinceLastStart = Date.now() - session.startTime;
            session.remainingMsOnPause = session.durationMs - elapsedSinceLastStart;
            
            const modal = DOMElements.tasks.detailModalBody;
            if(modal) modal.querySelector('#session-toggle-btn').textContent = 'Resume';
        };

        const resumeTimerSession = () => {
            const session = state.activeSessionTimer;
            if (!session || !session.isPaused) return;

            session.isPaused = false;
            session.startTime = Date.now();
            session.durationMs = session.remainingMsOnPause;

            const intervalId = setInterval(updateCountdownDisplay, 1000);
            session.intervalId = intervalId;

            const modal = DOMElements.tasks.detailModalBody;
            if(modal) modal.querySelector('#session-toggle-btn').textContent = 'Pause';
        };


        const stopTimerSession = () => {
            const session = state.activeSessionTimer;
            if (!session) return;

            clearInterval(session.intervalId);

            const endTime = Date.now();
            const elapsedTime = session.isPaused 
                ? (session.durationMs - session.remainingMsOnPause)
                : endTime - session.startTime;

            const task = state.tasks.find(t => t.id === session.taskId);
            if (task && elapsedTime > 1000) {
                if (!task.timeLog) task.timeLog = [];
                const loggedStartTime = session.isPaused 
                    ? endTime - elapsedTime
                    : session.startTime;
                task.timeLog.push({
                    start: new Date(loggedStartTime).toISOString(),
                    end: new Date(endTime).toISOString(),
                });
                saveState();
            }

            DOMElements.tasks.sessionTimerDisplay.textContent = '';
            document.querySelectorAll(`[data-timer-for="${session.taskId}"]`).forEach(el => el.textContent = '');
            state.activeSessionTimer = null;

            const modal = DOMElements.tasks.detailModalBody;
            if (modal) {
                modal.querySelector('#session-toggle-btn').textContent = 'Start Session';
                modal.querySelector('#session-stop-btn').classList.add('hidden');
                modal.querySelector('#add-time-btn').classList.add('hidden');
            }
            const totalTimeDisplay = document.getElementById('total-time-display');
            if (totalTimeDisplay && task) {
                 totalTimeDisplay.textContent = formatTime(calculateTotalTime(task));
            }
            
            renderTasks();
        };

        const updateCountdownDisplay = () => {
            const session = state.activeSessionTimer;
            if (!session || session.isPaused) return;

            const now = Date.now();
            const elapsed = now - session.startTime;
            const remainingMs = Math.max(0, session.durationMs - elapsed);
            
            const display = `⏳ ${formatTime(remainingMs)}`;
            
            if (DOMElements.tasks.detailModal.style.display === 'flex' && state.taskToDelete === session.taskId) {
                DOMElements.tasks.sessionTimerDisplay.textContent = display;
            }
            document.querySelectorAll(`[data-timer-for="${session.taskId}"]`).forEach(el => el.textContent = display);

            if (!session.notified10min && session.durationMs > 600000 && remainingMs > 0 && remainingMs < 600000) {
                alert(`Task "${state.tasks.find(t => t.id === session.taskId).title}" has less than 10 minutes remaining.`);
                session.notified10min = true;
            }

            const addTimeBtn = document.getElementById('add-time-btn');
            if(addTimeBtn) {
                addTimeBtn.classList.toggle('hidden', remainingMs > 600000);
            }

            if (remainingMs === 0) {
                alert(`Session for task "${state.tasks.find(t => t.id === session.taskId).title}" has ended!`);
                stopTimerSession();
            }
        };

        const renderTheme = () => {
            DOMElements.html.classList.toggle('dark', state.theme === 'dark');
            const themeIcon = state.theme === 'dark' ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`;
            
            DOMElements.themeToggle.innerHTML = themeIcon;
            if (DOMElements.mobileMenu.mobileThemeToggle) {
                DOMElements.mobileMenu.mobileThemeToggle.innerHTML = themeIcon;
            }

            updateActivePage();
        };

        const renderBusinessBreakdown = (data) => {
            const breakdown = data.reduce((acc, e) => {
                if(!e.business) return acc;
                if(!acc[e.business]) acc[e.business] = { revenue: 0, expenses: 0 };
                if (e.type === 'revenue') {
                    acc[e.business].revenue += e.amount;
                    acc[e.business].expenses += (e.fulfillmentExpense || 0);
                }
                if (e.type === 'expense') {
                    acc[e.business].expenses += e.amount;
                }
                return acc;
            }, {});
            let content = `<h3 class="text-md font-bold mb-2">Business Summary</h3><div class="space-y-2 overflow-y-auto max-h-24 pr-4 text-sm">`;
            const sortedBusinesses = Object.entries(breakdown).sort((a,b) => b[1].revenue - a[1].revenue);
            content += sortedBusinesses.length ? sortedBusinesses.map(([b,d]) => `<div><p class="font-semibold text-gray-700 dark:text-gray-300">${b}</p><div class="flex justify-between text-xs"><span class="text-green-500">Rev: ${formatCurrency(d.revenue)}</span><span class="text-red-500">Exp: ${formatCurrency(d.expenses)}</span></div></div>`).join('') : `<p class="dark:text-dark-text-secondary">No data.</p>`;
            DOMElements.businessBreakdownContainer.innerHTML = content + `</div>`;
        };
        
        const renderTransactionTable = (data) => {
            const tableContainer = DOMElements.transactionTableContainer;
            if (!tableContainer.querySelector('table')) {
                tableContainer.innerHTML = `
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h2 class="text-xl font-bold">Recent Activity</h2>
                        <div class="relative flex-1 min-w-[240px] max-w-md">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                            <input id="search-input" type="text" placeholder="Search transactions..." class="w-full pl-10 pr-4 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-dark-border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div id="table-tabs" class="flex items-center border border-gray-200 dark:border-dark-border rounded-lg p-1 space-x-1">${['all', 'revenue', 'expense'].map(t => `<button class="table-tab-btn" data-tab="${t}">${t.charAt(0).toUpperCase() + t.slice(1)}</button>`).join('')}</div>
                    </div>
                    <div class="overflow-x-auto"><table class="w-full text-left"><thead id="table-head"></thead><tbody id="table-body"></tbody></table></div>`;
                tableContainer.querySelector('#search-input').addEventListener('input', handleSearch);
                tableContainer.querySelector('#table-tabs').addEventListener('click', handleTabClick);
                tableContainer.querySelector('#table-head').addEventListener('click', handleSortClick);
            }
            tableContainer.querySelectorAll('.table-tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === state.ui.activeTableTab));
            
            const { key, order } = state.ui.sort;
            const renderHeader = (k, t) => { const isCurr = key===k; return `<th class="p-3 font-semibold sortable ${isCurr ? `sort-${order}` : ''}" data-sort-key="${k}"><span class="flex items-center gap-2">${t}<span class="sort-indicator">${isCurr&&order==='asc'?'▲':'▼'}</span></span></th>`; };
            tableContainer.querySelector('#table-head').innerHTML = `<tr class="text-sm dark:text-dark-text-secondary border-b dark:border-dark-border">${renderHeader('itemName', 'Customer/Item')}${renderHeader('amount', 'Amount')}${renderHeader('netProfit', 'Net Profit')}${renderHeader('netMargin', 'Net Margin')}${renderHeader('date', 'Date')}${renderHeader('status', 'Status')}<th class="p-3 font-semibold">Actions</th></tr>`;
            
            const query = state.ui.searchQuery.toLowerCase();
            const filtered = data.filter(e => 
                (state.ui.activeTableTab === 'all' || e.type === state.ui.activeTableTab) && 
                (!query || [e.itemName,e.business,e.customerSource,e.status,e.sector].join(' ').toLowerCase().includes(query))
            );
            const sorted = filtered.sort((a,b) => {
                let valA, valB;
                if (key === 'netProfit') { valA = a.type==='revenue' ? a.amount - (a.fulfillmentExpense || 0) : -Infinity; valB = b.type==='revenue' ? b.amount - (b.fulfillmentExpense || 0) : -Infinity; }
                else if (key === 'netMargin') { valA = a.type==='revenue' && a.amount > 0 ? (a.amount-(a.fulfillmentExpense || 0)) / a.amount : -Infinity; valB = b.type==='revenue' && b.amount > 0 ? (b.amount - (b.fulfillmentExpense || 0)) / b.amount : -Infinity; }
                else { valA = a[key]; valB = b[key]; }
                return (valA < valB ? -1 : valA > valB ? 1 : 0) * (order === 'asc' ? 1 : -1);
            });
            
            const tbody = tableContainer.querySelector('#table-body');
            tbody.innerHTML = sorted.length ? sorted.map(renderTransactionRow).join('') : `<tr><td colspan="7" class="text-center p-8 dark:text-dark-text-secondary">No matching transactions in this date range.</td></tr>`;
            tbody.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', handleDeleteClick));
        };
        
        const renderTransactionRow = (entry) => {
            const statusColors = {'Recurring':'bg-green-500/10 text-green-400','New Customer':'bg-blue-500/10 text-blue-400','Warm Lead':'bg-yellow-500/10 text-yellow-400','Actual':'bg-gray-500/10 text-gray-400'};
            const avatarColor = (name='X') => ['bg-blue-500','bg-green-500','bg-purple-500','bg-red-500','bg-yellow-500', 'bg-pink-500'][name.charCodeAt(0) % 6];
            const netProfit = entry.type==='revenue' ? entry.amount - (entry.fulfillmentExpense || 0) : null;
            const netMargin = netProfit !== null && entry.amount > 0 ? (netProfit / entry.amount) : null;
            
            return `<tr class="border-b dark:border-dark-border hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                <td class="p-3"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-white font-bold ${avatarColor(entry.itemName)}">${(entry.itemName||'X').charAt(0).toUpperCase()}</div><div><div class="font-bold">${entry.itemName}</div><div class="text-sm dark:text-dark-text-secondary">${entry.business || ''}${entry.customerSource && entry.customerSource!=='N/A' ? ` | ${entry.customerSource}`:''}</div></div></div></td>
                <td class="p-3 font-bold ${entry.type === 'revenue' ? 'text-green-400' : 'text-red-400'}">${formatCurrency(entry.amount)}</td>
                <td class="p-3 dark:text-dark-text-secondary">${netProfit!==null?formatCurrency(netProfit):'N/A'}</td>
                <td class="p-3 dark:text-dark-text-secondary">${netMargin!==null?formatPercent(netMargin):'N/A'}</td>
                <td class="p-3 dark:text-dark-text-secondary">${format(entry.dateObj, 'MMM d, yy')}</td>
                <td class="p-3"><span class="px-2.5 py-1 text-xs font-semibold rounded-full ${statusColors[entry.status] || 'bg-gray-500/10 text-gray-400'}">${entry.status}</span></td>
                <td class="p-3"><button class="text-gray-400 hover:text-red-500 delete-btn" data-id="${entry.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></td></tr>`;
        };
        
        const renderModalForm = () => {
            const type = state.ui.activeModalForm;
            DOMElements.addEntryModal.typeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.type === type));
            const base = "mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400";
            const field = (n, l, o={}) => {
                const {t='text', p='', note='', span='md:col-span-1'} = o;
                const label = `<label for="${n}" class="block text-sm font-medium dark:text-dark-text-secondary">${l}</label>${note?`<p class="text-xs text-gray-500">${note}</p>`:''}`;
                if (t==='select') return `<div class="${span}">${label}<select name="${n}" id="${n}" class="${base}">${o.choices.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></div>`;
                if (t==='textarea') return `<div class="${span}">${label}<textarea name="${n}" id="${n}" rows="2" class="${base}" placeholder="${p}"></textarea></div>`;
                return `<div class="${span}">${label}<input type="${t}" name="${n}" id="${n}" class="${base}" placeholder="${p}" ${t==='date'?`value="${format(new Date(),'yyyy-MM-dd')}"`:''} ${o.list?`list="${o.list}"`:''} required></div>`;
            };
            const common = `${field('date','Date',{t:'date'})}${field('amount','Amount ($)',{t:'number',p:'1500.00'})}`;
            const revenue = `${field('itemName','Customer Name',{p:'John Doe'})}${field('business','Business',{p:'Web Design'})}${field('fulfillmentExpense','Fulfillment Cost ($)',{t:'number',p:'250.00'})}${field('sector','Sector/Tag',{p:'Services',list:'tags-datalist'})}${field('customerSource','Source',{p:'Referral'})}${field('status','Status',{t:'select',choices:['New Customer','Warm Lead','Recurring','N/A']})}`;
            const expense = `${field('itemName','Item/Service',{p:'Office Supplies'})}${field('business','Category',{p:'Software, Overhead'})}${field('sector','Tag',{p:'Tools, Marketing',list:'tags-datalist'})}${field('status','Status',{t:'select',choices:['Actual','Recurring','N/A']})}`;
            const fields = type==='revenue' ? `${common}${revenue}` : `${common}${expense}`;
            DOMElements.addEntryModal.form.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${fields}${field('notes','Notes',{t:'textarea',p:'Optional details...',span:'md:col-span-2'})}</div><div class="flex justify-end space-x-3 pt-4"><button type="button" class="modal-cancel px-5 py-2.5 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 dark:bg-dark-border dark:text-dark-text-primary dark:hover:bg-gray-600 font-semibold">Cancel</button><button type="submit" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Save Transaction</button></div>`;
            DOMElements.addEntryModal.form.querySelector('.modal-cancel').addEventListener('click', () => toggleModal(DOMElements.addEntryModal.modal, false));
        };
        
        const switchPage = (pageId) => {
            state.ui.activePage = pageId;
            updateActivePage();
        };

        const updateActivePage = () => {
            Object.values(DOMElements.pages).forEach(page => page.classList.remove('active'));
            if (DOMElements.pages[state.ui.activePage]) {
                DOMElements.pages[state.ui.activePage].classList.add('active');
            }
            DOMElements.sidebarLinks.forEach(link => {
                const isActive = link.dataset.page === state.ui.activePage;
                link.classList.toggle('bg-blue-100', isActive);
                link.classList.toggle('dark:bg-blue-500/20', isActive);
                link.classList.toggle('text-blue-600', isActive);
                link.classList.toggle('dark:text-blue-400', isActive);
                link.classList.toggle('text-gray-500', !isActive);
                link.classList.toggle('hover:bg-gray-100', !isActive);
                link.classList.toggle('dark:hover:bg-gray-700/50', !isActive);
            });

            Object.values(state.chartInstances).forEach(chart => chart.destroy());
            state.chartInstances = {};

            if (state.ui.activePage === 'invoicing') {
                initInvoice();
            } else if (state.ui.activePage === 'tasks') {
                renderTasks();
            } 
            else {
                renderDashboard();
            }
        };

        const initInvoice = () => {
            DOMElements.invoice.form.reset();
            document.getElementById('invoice-date-issued').value = format(new Date(), 'yyyy-MM-dd');
            document.getElementById('invoice-date-due').value = format(addDays(new Date(), 30), 'yyyy-MM-dd');
            DOMElements.invoice.itemsContainer.innerHTML = '';
            addInvoiceItem();
            updateInvoicePreview();

            const clientNames = [...new Set(state.entries.filter(e => e.type === 'revenue').map(e => e.itemName))];
            DOMElements.invoice.clientDatalist.innerHTML = clientNames.map(name => `<option value="${name}"></option>`).join('');
        };

        const addInvoiceItem = () => {
            const itemHtml = `
                <div class="grid grid-cols-12 gap-2 items-center invoice-item-row">
                    <div class="col-span-12 sm:col-span-5"><input type="text" placeholder="Item Description" class="invoice-item-desc w-full px-2 py-1 bg-gray-50 dark:bg-slate-900/50 border-gray-300 dark:border-dark-border rounded"></div>
                    <div class="col-span-4 sm:col-span-2"><input type="number" value="1" min="0" placeholder="Qty" class="invoice-item-qty w-full px-2 py-1 bg-gray-50 dark:bg-slate-900/50 border-gray-300 dark:border-dark-border rounded"></div>
                    <div class="col-span-4 sm:col-span-2"><input type="number" value="0" min="0" step="0.01" placeholder="Rate" class="invoice-item-rate w-full px-2 py-1 bg-gray-50 dark:bg-slate-900/50 border-gray-300 dark:border-dark-border rounded"></div>
                    <div class="col-span-3 sm:col-span-2 text-right dark:text-dark-text-secondary"><span class="invoice-item-total">$0.00</span></div>
                    <div class="col-span-1 text-right"><button type="button" class="text-red-500 hover:text-red-700 remove-invoice-item-btn font-bold text-lg">&times;</button></div>
                </div>
            `;
            DOMElements.invoice.itemsContainer.insertAdjacentHTML('beforeend', itemHtml);
        };
        
        const updateInvoicePreview = () => {
            const form = DOMElements.invoice.form;
            const fromText = form.querySelector('#invoice-from-name').value.replace(/\n/g, '<br>') || 'Your Company, Inc.<br>123 Main Street<br>Anytown, USA 12345';
            const toText = form.querySelector('#invoice-to-name').value.replace(/\n/g, '<br>') || 'Client Name<br>Client Address';
            const invoiceNum = form.querySelector('#invoice-number').value || 'INV-001';
            const dateIssued = form.querySelector('#invoice-date-issued').value;
            const dateDue = form.querySelector('#invoice-date-due').value;
            const notes = form.querySelector('#invoice-notes').value.replace(/\n/g, '<br>');
            const terms = form.querySelector('#invoice-terms').value.replace(/\n/g, '<br>');
            
            const discount = parseFloat(form.querySelector('#invoice-discount').value) || 0;
            const taxRate = parseFloat(form.querySelector('#invoice-tax-rate').value) || 0;
            const shipping = parseFloat(form.querySelector('#invoice-shipping').value) || 0;

            let subtotal = 0;
            const itemRows = Array.from(DOMElements.invoice.itemsContainer.children).map(itemEl => {
                const desc = itemEl.querySelector('.invoice-item-desc').value || 'Service/Product';
                const qty = parseFloat(itemEl.querySelector('.invoice-item-qty').value) || 0;
                const rate = parseFloat(itemEl.querySelector('.invoice-item-rate').value) || 0;
                const total = qty * rate;
                subtotal += total;
                itemEl.querySelector('.invoice-item-total').textContent = formatCurrency(total);
                return `<tr class="item"><td>${desc}</td><td style="text-align: center;">${qty}</td><td style="text-align: right;">${formatCurrency(rate)}</td><td style="text-align: right;">${formatCurrency(total)}</td></tr>`;
            }).join('');

            const subtotalAfterDiscount = subtotal - discount;
            const tax = subtotalAfterDiscount * (taxRate / 100);
            const total = subtotalAfterDiscount + tax + shipping;

            const previewHTML = `
                <table cellpadding="0" cellspacing="0">
                    <tr class="top"><td colspan="4">
                        <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 20px;">
                            <div class="invoice-title" style="font-size: 40px; line-height: 1; color: #333; font-weight: bold; margin-bottom:10px;">INVOICE</div>
                            <div style="text-align: left; font-size: 14px; line-height: 1.5; min-width: 150px; text-align:right;">
                                <strong>Invoice #:</strong> ${invoiceNum}<br />
                                <strong>Created:</strong> ${dateIssued ? format(parseISO(dateIssued), 'MMM d, yy') : ''}<br />
                                <strong>Due:</strong> ${dateDue ? format(parseISO(dateDue), 'MMM d, yy') : ''}
                            </div>
                        </div>
                    </td></tr>
                    <tr class="information"><td colspan="4">
                         <div style="display: flex; flex-wrap: wrap; justify-content: space-between; margin-top: 30px; margin-bottom: 40px; font-size: 14px; line-height: 1.5;">
                            <div style="margin-bottom:20px;"><strong>From:</strong><br>${fromText}</div>
                            <div style="text-align: right;"><strong>To:</strong><br>${toText}</div>
                        </div>
                    </td></tr>
                    <tr class="heading"><td>Item</td><td style="text-align: center;">Quantity</td><td style="text-align: right;">Rate</td><td style="text-align: right;">Price</td></tr>
                    ${itemRows}
                </table>
                <table cellpadding="0" cellspacing="0" style="width: 50%; max-width: 250px; margin-left: auto; margin-top: 20px;">
                    <tr class="total"><td style="text-align: right;">Subtotal:</td><td style="text-align: right;">${formatCurrency(subtotal)}</td></tr>
                    ${discount > 0 ? `<tr class="total"><td style="text-align: right;">Discount:</td><td style="text-align: right;">-${formatCurrency(discount)}</td></tr>` : ''}
                    ${tax > 0 ? `<tr class="total"><td style="text-align: right;">Tax (${taxRate}%):</td><td style="text-align: right;">${formatCurrency(tax)}</td></tr>` : ''}
                    ${shipping > 0 ? `<tr class="total"><td style="text-align: right;">Shipping:</td><td style="text-align: right;">${formatCurrency(shipping)}</td></tr>` : ''}
                    <tr class="total" style="font-size: 18px; font-weight: bold;"><td style="text-align: right;">Total:</td><td style="text-align: right;">${formatCurrency(total)}</td></tr>
                </table>
                ${notes ? `<div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; font-size: 13px;"><strong>Notes:</strong><br>${notes}</div>` : ''}
                ${terms ? `<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; font-size: 13px;"><strong>Terms:</strong><br>${terms}</div>` : ''}
            `;
            DOMElements.invoice.preview.innerHTML = previewHTML;
        };

        const handleDownloadPDF = async () => {
            const invoiceTemplate = DOMElements.invoice.preview;
            const canvas = await html2canvas(invoiceTemplate, { scale: 3, useCORS: true, backgroundColor: null });
            const imgData = canvas.toDataURL('image/png');
            
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const bgColor = state.theme === 'dark' ? '#1E293B' : '#FFFFFF';
            pdf.setFillColor(bgColor);
            pdf.rect(0, 0, pdfWidth, pdfHeight, 'F');
            
            const canvasAspectRatio = canvas.width / canvas.height;
            const imgWidth = pdfWidth - 20; // Add some margin
            const imgHeight = imgWidth / canvasAspectRatio;
            const x = 10;
            const y = (pdfHeight > imgHeight) ? (pdfHeight - imgHeight) / 2 : 10;
            pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
            
            const invoiceNum = document.getElementById('invoice-number').value || 'invoice';
            pdf.save(`invoice-${invoiceNum}.pdf`);
        };

        // --- Event Handlers ---
        const toggleTheme = () => { 
            state.theme = state.theme === 'light' ? 'dark' : 'light'; 
            saveState();
            renderTheme(); 
        };
        const handleTabClick = (e) => { if (e.target.matches('[data-tab]')) { state.ui.activeTableTab = e.target.dataset.tab; renderDashboard(); }};
        const handleSortClick = (e) => {
            const th = e.target.closest('[data-sort-key]'); if(!th) return;
            const newKey = th.dataset.sortKey;
            state.ui.sort.order = state.ui.sort.key === newKey && state.ui.sort.order === 'desc' ? 'asc' : 'desc';
            state.ui.sort.key = newKey; renderDashboard();
        };
        const handleDeleteClick = (e) => {
            state.itemToDelete = e.target.closest('[data-id]').dataset.id;
            toggleModal(DOMElements.deleteModal.modal, true);
        };
        const confirmDelete = () => {
            state.entries = state.entries.filter(e => e.id !== state.itemToDelete);
            state.itemToDelete = null;
            toggleModal(DOMElements.deleteModal.modal, false);
            renderDashboard();
            saveState();
        };
        const handleFormSubmit = (e) => {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            if (!data.amount || !data.itemName) {
                DOMElements.addEntryModal.error.textContent = 'Please fill out at least the name and amount fields.';
                DOMElements.addEntryModal.error.classList.remove('hidden');
                return;
            }
            const newEntry = {
                id: crypto.randomUUID(),
                type: state.ui.activeModalForm,
                ...data,
                amount: parseFloat(data.amount),
                fulfillmentExpense: parseFloat(data.fulfillmentExpense || 0),
                dateObj: parseISO(data.date)
            };
            if (newEntry.type === 'expense') {
                newEntry.customerSource = 'N/A';
                newEntry.fulfillmentExpense = 0;
            }
            state.entries.unshift(newEntry);
            const newRangeStart = startOfMonth(newEntry.dateObj);
            const newRangeEnd = endOfMonth(newEntry.dateObj);
            state.ui.dateRange = { start: newRangeStart, end: newRangeEnd };
            const now = new Date();
            if (isSameDay(newRangeStart, startOfMonth(now)) && isSameDay(newRangeEnd, endOfMonth(now))) {
                state.ui.activeDatePreset = 'month';
            } else {
                state.ui.activeDatePreset = null;
            }
            if (pickerInstance) {
                pickerInstance.setDateRange(newRangeStart, newRangeEnd);
            }
            updateActiveDatePresetButtons();
            toggleModal(DOMElements.addEntryModal.modal, false);
            form.reset();
            renderDashboard();
            saveState();
        };
        const handleSearch = (e) => { state.ui.searchQuery = e.target.value; renderDashboard(); };
        const toggleModal = (modal, show) => {
            if (!modal) return;
            modal.style.display = show ? 'flex' : 'none';
            if(show && modal.id === 'add-entry-modal'){
                DOMElements.addEntryModal.error.classList.add('hidden');
                renderModalForm();
            }
        };
        
        const updateActiveDatePresetButtons = () => {
            DOMElements.datePresetsContainer.querySelectorAll('.date-preset-btn').forEach(btn => {
                const isActive = btn.dataset.range === state.ui.activeDatePreset;
                btn.classList.toggle('bg-white', isActive);
                btn.classList.toggle('dark:bg-slate-800', isActive);
                btn.classList.toggle('shadow-sm', isActive);
                btn.classList.toggle('text-gray-900', isActive);
                btn.classList.toggle('dark:text-white', isActive);
                btn.classList.toggle('text-gray-600', !isActive);
                btn.classList.toggle('dark:text-dark-text-secondary', !isActive);
            });
        };
        
        const handleDatePresetClick = (picker) => (e) => {
            const button = e.target.closest('.date-preset-btn');
            if (!button) return;

            const range = button.dataset.range;
            const now = new Date();
            let start, end;

            switch(range) {
                case 'day': start = startOfDay(now); end = endOfDay(now); break;
                case 'week': start = startOfWeek(now, { weekStartsOn: 1 }); end = endOfWeek(now, { weekStartsOn: 1 }); break;
                case 'month': start = startOfMonth(now); end = endOfMonth(now); break;
                default: return;
            }

            state.ui.dateRange = { start, end };
            state.ui.activeDatePreset = range;
            picker.setDateRange(start, end);
            updateActiveDatePresetButtons();
            renderDashboard();
        }

        const handleExportData = () => {
            const dataToExport = JSON.stringify(state, null, 2);
            const blob = new Blob([dataToExport], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard-backup-${format(new Date(), 'yyyy-MM-dd')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const handleImportData = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedState = JSON.parse(e.target.result);
                    if (!importedState.tasks || !importedState.entries) {
                        throw new Error('Invalid backup file structure.');
                    }
                    
                    state.entries = (importedState.entries || []).map(entry => ({...entry, dateObj: parseISO(entry.date)}));
                    state.tasks = importedState.tasks || [];
                    state.projects = importedState.projects || [];
                    state.theme = importedState.theme || 'light';

                    updateActivePage();
                    saveState();
                    alert('Data imported successfully!');
                } catch (error) {
                    console.error('Failed to import data:', error);
                    alert(`Import failed: ${error.message}`);
                }
            };
            reader.onerror = () => alert('Failed to read the file.');
            reader.readAsText(file);
            event.target.value = '';
        };

        const processRecurringEntries = () => {
            const now = new Date();
            const lastCheck = localStorage.getItem('lastRecurringCheck-v22');
            if (lastCheck && isSameDay(parseISO(lastCheck), now)) return false;

            const recurringEntries = state.entries.filter(e => e.status === 'Recurring');
            const newEntries = [];
            const groups = recurringEntries.reduce((acc, entry) => {
                const key = `${entry.itemName}-${entry.business}-${entry.type}`;
                if (!acc[key]) acc[key] = [];
                acc[key].push(entry);
                return acc;
            }, {});

            Object.values(groups).forEach(group => {
                const latestEntry = group.sort((a,b) => b.dateObj - a.dateObj)[0];
                if (!isSameMonth(latestEntry.dateObj, now)) {
                    let newDate = addMonths(latestEntry.dateObj, 1);
                    if (isAfter(newDate, now)) return;
                    const newEntry = {...latestEntry, id: crypto.randomUUID(), date: format(newDate, 'yyyy-MM-dd'), dateObj: newDate, status: 'Recurring'};
                    newEntries.push(newEntry);
                }
            });

            if (newEntries.length > 0) {
                state.entries.unshift(...newEntries);
                return true;
            }
            return false;
        };

        const toggleMobileMenu = () => {
            DOMElements.sidebar.classList.toggle('-translate-x-full');
            DOMElements.mobileMenu.overlay.classList.toggle('hidden');
        };
        
        const init = () => {
            loadState();
            
            DOMElements.themeToggle.addEventListener('click', toggleTheme);
            DOMElements.addEntryButton.addEventListener('click', () => toggleModal(DOMElements.addEntryModal.modal, true));
            DOMElements.addEntryModal.closeButton.addEventListener('click', () => toggleModal(DOMElements.addEntryModal.modal, false));
            DOMElements.addEntryModal.typeButtons.forEach(btn => btn.addEventListener('click', (e) => {
                if(e.target.matches('[data-type]')){ state.ui.activeModalForm = e.target.dataset.type; renderModalForm(); }
            }));
            DOMElements.addEntryModal.form.addEventListener('submit', handleFormSubmit);
            
            DOMElements.deleteModal.confirmButton.addEventListener('click', confirmDelete);
            DOMElements.deleteModal.cancelButton.addEventListener('click', () => toggleModal(DOMElements.deleteModal.modal, false));
            
            DOMElements.moveTaskModal.cancelButton.addEventListener('click', () => toggleModal(DOMElements.moveTaskModal.modal, false));
            DOMElements.moveTaskModal.optionsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('[data-status]');
                if(button && state.taskToMove) {
                    const task = state.tasks.find(t => t.id === state.taskToMove);
                    if (task) {
                        task.status = button.dataset.status;
                        saveState();
                        renderTaskBoard();
                    }
                    toggleModal(DOMElements.moveTaskModal.modal, false);
                    state.taskToMove = null;
                }
            });

            DOMElements.sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchPage(link.dataset.page);
                    if (window.innerWidth < 768) toggleMobileMenu();
                });
            });

            DOMElements.mobileMenu.button.addEventListener('click', toggleMobileMenu);
            DOMElements.mobileMenu.overlay.addEventListener('click', toggleMobileMenu);
            DOMElements.mobileMenu.mobileThemeToggle.addEventListener('click', toggleTheme);
            DOMElements.mobileMenu.mobileAddEntryButton.addEventListener('click', () => {
                 if (state.ui.activePage === 'tasks') {
                    openTaskModal();
                } else {
                    toggleModal(DOMElements.addEntryModal.modal, true);
                }
            });
            
            DOMElements.tasks.addTaskButton.addEventListener('click', () => openTaskModal());
            DOMElements.tasks.detailModalClose.addEventListener('click', closeTaskModal);
            DOMElements.tasks.deleteTaskButton.addEventListener('click', deleteTask);
            DOMElements.tasks.viewSwitcher.addEventListener('click', (e) => {
                const view = e.target.dataset.view;
                if(view) {
                    state.ui.activeTaskView = view;
                    state.ui.expandedListTasks = {};
                    renderTasks();
                }
            });
            
            // Delegated event listeners for dynamic content
            DOMElements.tasks.content.addEventListener('click', e => {
                const calendarItem = e.target.closest('.task-calendar-item');
                if (calendarItem) openTaskModal(calendarItem.dataset.taskId);
            });
            DOMElements.tasks.content.addEventListener('change', e => {
                if (e.target.matches('.subtask-checkbox-list')) {
                    const taskId = e.target.dataset.taskId;
                    const subtaskId = e.target.dataset.subtaskId;
                    const task = state.tasks.find(t => t.id === taskId);
                    if (task && task.subtasks) {
                        const subtask = task.subtasks.find(st => st.id === subtaskId);
                        if (subtask) {
                            subtask.done = e.target.checked;
                            saveState();
                            const span = e.target.nextElementSibling;
                            if (span) {
                                span.classList.toggle('line-through', e.target.checked);
                                span.classList.toggle('text-gray-500', e.target.checked);
                                if(document.documentElement.classList.contains('dark')){
                                     span.classList.toggle('text-gray-400', !e.target.checked);
                                     span.classList.toggle('text-gray-600', e.target.checked);
                                }
                            }
                        }
                    }
                }
            });

            DOMElements.invoice.addItemButton.addEventListener('click', addInvoiceItem);
            DOMElements.invoice.form.addEventListener('input', updateInvoicePreview);
            DOMElements.invoice.itemsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-invoice-item-btn')) {
                    e.target.closest('.invoice-item-row').remove();
                    updateInvoicePreview();
                }
            });
            DOMElements.invoice.downloadPdfButton.addEventListener('click', handleDownloadPDF);
            
            DOMElements.exportDataButton.addEventListener('click', handleExportData);
            DOMElements.importData.button.addEventListener('click', () => DOMElements.importData.input.click());
            DOMElements.importData.input.addEventListener('change', handleImportData);

            const picker = new Litepicker({
                element: DOMElements.dateRangePicker, singleMode: false, format: 'MMM D, YYYY',
                startDate: state.ui.dateRange.start, endDate: state.ui.dateRange.end,
                setup: (p) => {
                    p.on('selected', (d1, d2) => {
                        state.ui.dateRange.start = d1.dateInstance;
                        state.ui.dateRange.end = d2.dateInstance;
                        state.ui.activeDatePreset = null;
                        updateActiveDatePresetButtons();
                        renderDashboard();
                    });
                },
            });
            pickerInstance = picker;
            DOMElements.datePresetsContainer.addEventListener('click', handleDatePresetClick(picker));
            
            DOMElements.loader.style.display = 'none';
            DOMElements.dashboardContent.classList.remove('hidden');
            
            if (processRecurringEntries()) saveState();
            
            renderTheme();
            updateActivePage();
            updateActiveDatePresetButtons();
        };
        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>
