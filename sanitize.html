<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reputifly | Sanitizer Pro</title>
    
    <link rel="icon" type="image/png" href="https://reputifly.com/wp-content/uploads/2026/01/IMG_2123.jpg">    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --bg-main: #0B0A14;
            --accent-primary: #E6397F;
            --accent-secondary: #FF8A00;
            --glass-border: rgba(255, 255, 255, 0.08);
            --card-bg: #121218;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* --- CUSTOM SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.02); }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(230, 57, 127, 0.5); }
        * { scrollbar-width: thin; scrollbar-color: rgba(255, 255, 255, 0.15) rgba(255, 255, 255, 0.02); }

        /* --- UI COMPONENTS --- */
        .liquid-glow {
            background: radial-gradient(circle at top, rgba(255,255,255,0.4) 0%, transparent 60%),
                        linear-gradient(90deg, #E6397F, #FF8A00);
            box-shadow: 
                0 6px 20px rgba(230, 57, 127, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            border: none; position: relative; overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            color: white; font-weight: 700; border-radius: 9999px;
            display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;
        }
        .liquid-glow:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 15px 30px rgba(255, 138, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.6); }
        .liquid-glow.outline { background: transparent; border: 1px solid rgba(255,255,255,0.2); box-shadow: none; }
        .liquid-glow.outline:hover { background: rgba(255,255,255,0.05); border-color: white; }

        .btn-glass { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #ccc; 
            border-radius: 9999px; transition: all 0.2s ease; font-weight: 600; font-size: 13px;
            display: flex; align-items: center; justify-content: center; gap: 6px; padding: 0 18px; cursor: pointer;
        }
        .btn-glass:hover { background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.3); }

        .card {
            background: var(--card-bg); border: 1px solid var(--glass-border);
            border-radius: 20px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        .code-block {
            background: #050505; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px; color: #a5b3ce; padding: 20px;
            width: 100%; height: 400px; resize: none; outline: none;
            line-height: 1.6;
            white-space: pre; overflow-wrap: normal; overflow-x: auto;
        }
        .code-block:focus { border-color: var(--accent-primary); color: white; }

        /* --- DRAG DROP --- */
        .drop-zone {
            border: 2px dashed rgba(255,255,255,0.1); border-radius: 24px;
            background: rgba(255,255,255,0.02); transition: all 0.3s ease;
            cursor: pointer; position: relative; overflow: hidden;
        }
        .drop-zone:hover, .drop-zone.drag-over { 
            border-color: var(--accent-primary); background: rgba(230, 57, 127, 0.05); 
        }
        
        .image-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px;
        }
        .image-card {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px; overflow: hidden; position: relative; group;
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
        }
        .image-card img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; transition: 0.3s; }
        .image-card:hover img { opacity: 1; transform: scale(1.1); }
        .image-card .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.6);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: 0.2s; gap: 8px;
        }
        .image-card:hover .overlay { opacity: 1; }
        
        .size-tag {
            position: absolute; top: 6px; right: 6px; 
            background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
            color: #fff; font-size: 9px; padding: 2px 6px; border-radius: 4px;
            font-family: monospace; pointer-events: none; z-index: 10;
        }

        /* --- TOGGLE SWITCH --- */
        .toggle-switch {
            position: relative; width: 44px; height: 24px;
            background: rgba(255,255,255,0.1); border-radius: 99px;
            cursor: pointer; transition: 0.3s;
        }
        .toggle-switch::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 20px; height: 20px; background: white;
            border-radius: 50%; transition: 0.3s;
        }
        .toggle-switch.active { background: #E6397F; }
        .toggle-switch.active::after { left: 22px; }

        /* --- LOADING --- */
        .loader { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .log-box {
            background: #000; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; padding: 10px; font-family: monospace; font-size: 10px;
            height: 100px; overflow-y: auto; color: #aaa; margin-top: 10px;
        }
        .log-item { border-bottom: 1px solid rgba(255,255,255,0.05); padding: 2px 0; }
        .log-warn { color: #F59E0B; }
        .log-ok { color: #10B981; }

        .hidden { display: none !important; }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    </style>
</head>
<body class="p-6 md:p-12">

    <nav class="flex items-center justify-between mb-12 max-w-6xl mx-auto w-full">
        <div class="flex items-center gap-3">
            <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png" class="h-8 w-auto brightness-125">
            <div class="h-6 w-px bg-white/10 mx-2"></div>
            <span class="text-sm font-bold text-gray-400 font-['Space_Grotesk'] tracking-wide">SANITIZER PRO</span>
        </div>
        <button onclick="resetApp()" class="text-xs text-gray-500 hover:text-white transition-colors">Reset Tool</button>
    </nav>

    <main class="max-w-6xl mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-8 relative">
        
        <div id="domainSection" class="hidden col-span-12 slide-up">
            <div class="card p-6 flex flex-col md:flex-row items-center gap-4 border-l-4 border-l-pink-500">
                <div class="flex items-center gap-3 min-w-[150px]">
                    <div class="w-10 h-10 rounded-lg bg-pink-500/10 flex items-center justify-center text-pink-500">
                        <i data-feather="globe" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h2 class="text-sm font-bold text-white">Domain</h2>
                        <p class="text-[10px] text-gray-500">Check for Typos</p>
                    </div>
                </div>
                <div class="flex-grow w-full">
                    <input type="text" id="domainInput" class="bg-[#050505] border border-white/10 rounded-lg px-4 py-2 w-full text-sm text-white focus:border-pink-500 outline-none" placeholder="e.g. client-site.com">
                </div>
                <button onclick="updateDomainInCode()" id="domainBtn" class="liquid-glow outline px-6 py-2 text-xs h-10 whitespace-nowrap">
                    Update Code
                </button>
            </div>
        </div>

        <div id="uploadSection" class="col-span-12 card p-12 text-center drop-zone min-h-[400px] flex flex-col items-center justify-center"
             onclick="document.getElementById('fileInput').click()"
             ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
            
            <div class="w-20 h-20 rounded-full bg-white/5 flex items-center justify-center mb-6 border border-white/10 shadow-2xl">
                <i data-feather="package" class="w-10 h-10 text-pink-500"></i>
            </div>
            <h1 class="text-3xl font-bold font-['Space_Grotesk'] mb-3 text-white">Upload Project ZIP</h1>
            <p class="text-gray-400 text-sm mb-8">Drag and drop the ZIP file exported from the Reputifly Editor.</p>
            
            <button class="liquid-glow px-8 py-3 text-sm shadow-lg">
                <i data-feather="upload-cloud" class="w-4 h-4"></i> Select File
            </button>
            <input type="file" id="fileInput" accept=".zip" class="hidden" onchange="handleFileSelect(event)">
            
            <p id="errorMsg" class="text-red-500 text-xs mt-6 hidden font-mono bg-red-500/10 px-4 py-2 rounded-lg border border-red-500/20"></p>
        </div>

        <div id="codeSection" class="hidden col-span-12 lg:col-span-7 slide-up">
            <div class="card p-6 h-full flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-orange-500/10 flex items-center justify-center text-orange-500">
                            <i data-feather="code" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold font-['Space_Grotesk'] text-white">Source Code</h2>
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">index.html</p>
                        </div>
                    </div>
                    <button onclick="copyCode()" id="copyBtn" class="btn-glass h-9 text-xs">
                        <i data-feather="copy" class="w-3 h-3"></i> Copy HTML
                    </button>
                </div>
                
                <textarea id="codeDisplay" class="code-block flex-grow" readonly spellcheck="false"></textarea>
                
                <div class="mt-4 flex gap-2">
                    <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3 w-full">
                        <div class="flex gap-2 items-center mb-2">
                             <i data-feather="info" class="w-4 h-4 text-blue-400"></i>
                             <p class="text-xs font-bold text-blue-200">System Log</p>
                        </div>
                        <div id="systemLog" class="log-box custom-scrollbar"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="mediaSection" class="hidden col-span-12 lg:col-span-5 slide-up">
            <div class="card p-6 h-full flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-pink-500/10 flex items-center justify-center text-pink-500">
                            <i data-feather="image" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold font-['Space_Grotesk'] text-white">Assets</h2>
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold" id="assetCount">0 Images Found</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center justify-between bg-white/5 rounded-xl p-3 mb-4 border border-white/5">
                    <div class="flex items-center gap-2">
                        <i data-feather="zap" class="w-4 h-4 text-yellow-400"></i>
                        <div class="text-left">
                            <p class="text-xs font-bold text-white">Crunch Mode</p>
                            <p class="text-[10px] text-gray-400">Compress & Resize (WebP)</p>
                        </div>
                    </div>
                    <div class="toggle-switch" id="crunchToggle" onclick="toggleCrunch()"></div>
                </div>

                <div id="noImagesState" class="hidden flex flex-col items-center justify-center py-12 text-gray-600 border border-dashed border-white/5 rounded-xl bg-white/[0.02]">
                    <i data-feather="slash" class="w-8 h-8 mb-2 opacity-50"></i>
                    <span class="text-xs">No local images found</span>
                    <span class="text-[10px] opacity-50 mt-1">(External URLs are preserved)</span>
                </div>

                <div id="imageGrid" class="image-grid content-start overflow-y-auto max-h-[400px] custom-scrollbar pr-2 mb-6">
                </div>

                <div class="mt-auto pt-4 border-t border-white/5 flex flex-col gap-2">
                    <button onclick="downloadImagesZip()" id="zipBtn" class="liquid-glow w-full py-3 text-sm shadow-lg">
                        <i data-feather="archive" class="w-4 h-4"></i> Download ZIP
                    </button>
                    <button onclick="downloadAllIndividual()" id="multiBtn" class="liquid-glow outline w-full py-3 text-sm">
                        <i data-feather="layers" class="w-4 h-4"></i> Download All (Individual)
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script>
        feather.replace();
        let originalBlobs = []; // { name, blob, sizeString, originalSize }
        let crunchedBlobs = []; 
        let isCrunchMode = false;
        let currentDomain = "";
        let rawHtml = "";
        const WP_BIG_IMAGE_THRESHOLD = 2560;

        // --- DRAG & DROP HANDLERS ---
        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadSection').classList.add('drag-over');
        }
        function handleDragLeave(e) {
            e.preventDefault();
            document.getElementById('uploadSection').classList.remove('drag-over');
        }
        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('uploadSection').classList.remove('drag-over');
            if (e.dataTransfer.items && e.dataTransfer.items[0].kind === 'file') {
                processZip(e.dataTransfer.items[0].getAsFile());
            }
        }
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if(file) processZip(file);
        }

        function log(msg, type='normal') {
            const box = document.getElementById('systemLog');
            const el = document.createElement('div');
            el.className = 'log-item';
            if(type==='warn') el.className += ' log-warn';
            if(type==='ok') el.className += ' log-ok';
            el.innerText = "> " + msg;
            box.appendChild(el);
            box.scrollTop = box.scrollHeight;
        }

        // --- MAIN LOGIC ---
        async function processZip(file) {
            const uploadSec = document.getElementById('uploadSection');
            const errorEl = document.getElementById('errorMsg');
            const codeSec = document.getElementById('codeSection');
            const mediaSec = document.getElementById('mediaSection');
            const domainSec = document.getElementById('domainSection');
            
            errorEl.classList.add('hidden');
            document.getElementById('systemLog').innerHTML = ""; // Clear log

            // Loading UI
            const originalHtml = uploadSec.innerHTML;
            uploadSec.innerHTML = `<div class="loader mb-4" style="width:40px;height:40px;"></div><h2 class="text-xl font-bold">Unpacking...</h2>`;

            try {
                if (!file.name.endsWith('.zip')) throw new Error("Please upload a .zip file");

                const zip = await JSZip.loadAsync(file);
                originalBlobs = [];
                crunchedBlobs = [];
                isCrunchMode = false;
                document.getElementById('crunchToggle').classList.remove('active');

                // 1. Get HTML
                const htmlFile = Object.values(zip.files).find(f => f.name.endsWith('index.html'));
                if (htmlFile) {
                    rawHtml = await htmlFile.async("string");
                } else {
                    throw new Error("No index.html found in ZIP.");
                }

                // 2. DETECT DOMAIN
                const domainMatch = rawHtml.match(/https?:\/\/([^\/]+)\/wp-content/);
                currentDomain = domainMatch ? domainMatch[1] : "";
                document.getElementById('domainInput').value = currentDomain;
                log(`Detected Domain: ${currentDomain || 'None'}`, currentDomain ? 'ok' : 'warn');

                // 3. PROCESS IMAGES (HASHING + WP LOGIC)
                const imgPromises = [];
                zip.forEach((relativePath, zipEntry) => {
                    if (!zipEntry.dir && relativePath.includes('images_to_upload/')) {
                        const p = zipEntry.async("blob").then(async blob => {
                            const fileName = relativePath.split('/').pop();
                            if(fileName.startsWith('.') || !fileName || fileName.includes('__MACOSX')) return; 

                            // --- A. SEO HASHING ---
                            // Rename 'image.jpg' to 'image-x9d2.jpg'
                            const hash = Math.random().toString(36).substring(2, 6);
                            const parts = fileName.split('.');
                            const ext = parts.pop();
                            const baseName = parts.join('.');
                            const hashedName = `${baseName}-${hash}.${ext}`;

                            // --- B. WP BIG IMAGE CHECK ---
                            const dims = await getImageDimensions(blob);
                            let htmlLinkName = hashedName;
                            
                            if (dims.w > WP_BIG_IMAGE_THRESHOLD || dims.h > WP_BIG_IMAGE_THRESHOLD) {
                                htmlLinkName = `${baseName}-${hash}-scaled.${ext}`;
                                log(`Big Image (${dims.w}px): ${fileName} linked to -scaled version`, 'warn');
                            } else {
                                log(`Renamed: ${fileName} -> ${hashedName}`);
                            }

                            // --- C. UPDATE HTML ---
                            // Replace all instances of original filename with new Logic Name
                            const regex = new RegExp(fileName, 'g');
                            rawHtml = rawHtml.replace(regex, htmlLinkName);

                            originalBlobs.push({
                                name: hashedName, // File on disk uses Hashed Name (WP adds -scaled later if needed)
                                blob: blob,
                                originalSize: blob.size,
                                sizeString: formatBytes(blob.size)
                            });
                        });
                        imgPromises.push(p);
                    }
                });

                await Promise.all(imgPromises);

                // 4. Render
                document.getElementById('codeDisplay').value = rawHtml;
                renderGrid(originalBlobs);
                
                uploadSec.classList.add('hidden');
                domainSec.classList.remove('hidden');
                codeSec.classList.remove('hidden');
                mediaSec.classList.remove('hidden');

            } catch (e) {
                console.error(e);
                uploadSec.innerHTML = originalHtml;
                errorEl.innerText = e.message;
                errorEl.classList.remove('hidden');
                feather.replace();
            }
        }

        // --- HELPERS ---
        function getImageDimensions(blob) {
            return new Promise(resolve => {
                const img = new Image();
                img.src = URL.createObjectURL(blob);
                img.onload = () => {
                    resolve({ w: img.width, h: img.height });
                    URL.revokeObjectURL(img.src);
                };
                img.onerror = () => resolve({ w: 0, h: 0 }); 
            });
        }

        function updateDomainInCode() {
            const newDomain = document.getElementById('domainInput').value.trim();
            const btn = document.getElementById('domainBtn');
            
            if(!newDomain || !currentDomain) {
                log("Cannot update: No domain detected or input empty", 'warn');
                return;
            }

            const escapedOldDomain = currentDomain.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(escapedOldDomain, 'g');
            
            rawHtml = rawHtml.replace(regex, newDomain);
            document.getElementById('codeDisplay').value = rawHtml;
            
            log(`Domain updated: ${currentDomain} -> ${newDomain}`, 'ok');
            currentDomain = newDomain; 

            const originalText = btn.innerText;
            btn.innerText = "Updated!";
            btn.classList.add('border-green-500', 'text-green-500');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('border-green-500', 'text-green-500');
            }, 2000);
        }

        function formatBytes(bytes, decimals = 1) {
            if (!+bytes) return '0 B';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        function renderGrid(dataList) {
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = "";
            document.getElementById('assetCount').innerText = `${dataList.length} IMAGES FOUND`;

            if(dataList.length === 0) {
                document.getElementById('noImagesState').classList.remove('hidden');
                document.getElementById('zipBtn').classList.add('hidden');
                document.getElementById('multiBtn').classList.add('hidden');
                return;
            } else {
                document.getElementById('noImagesState').classList.add('hidden');
                document.getElementById('zipBtn').classList.remove('hidden');
                document.getElementById('multiBtn').classList.remove('hidden');
            }

            dataList.forEach(item => {
                const url = URL.createObjectURL(item.blob);
                const div = document.createElement('div');
                div.className = 'image-card';
                div.innerHTML = `
                    <div class="size-tag">${item.sizeString}</div>
                    <img src="${url}">
                    <div class="overlay">
                        <button onclick="downloadSingle('${item.name}')" class="w-8 h-8 bg-white text-black rounded-full flex items-center justify-center hover:scale-110 transition-transform" title="Download This">
                            <i data-feather="arrow-down" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;
                grid.appendChild(div);
            });
            feather.replace();
        }

        // --- CRUNCH LOGIC ---
        async function toggleCrunch() {
            const toggle = document.getElementById('crunchToggle');
            const grid = document.getElementById('imageGrid');
            
            isCrunchMode = !isCrunchMode;
            toggle.classList.toggle('active', isCrunchMode);

            if(isCrunchMode) {
                if(crunchedBlobs.length === 0) {
                    grid.innerHTML = '<div class="col-span-full flex flex-col items-center py-10"><div class="loader mb-2"></div><span class="text-xs text-gray-500">Compressing images...</span></div>';
                    
                    try {
                        crunchedBlobs = await Promise.all(originalBlobs.map(async (item) => {
                            const compressedBlob = await compressImage(item.blob);
                            const percentSaved = Math.round(((item.originalSize - compressedBlob.size) / item.originalSize) * 100);
                            return {
                                name: item.name, 
                                blob: compressedBlob,
                                originalSize: compressedBlob.size,
                                sizeString: `${formatBytes(compressedBlob.size)} (-${percentSaved}%)`
                            };
                        }));
                        log("Crunch complete. All images compressed.", 'ok');
                    } catch(e) {
                        console.error(e);
                        alert("Compression failed.");
                        isCrunchMode = false;
                        toggle.classList.remove('active');
                        renderGrid(originalBlobs);
                        return;
                    }
                }
                renderGrid(crunchedBlobs);
            } else {
                renderGrid(originalBlobs);
            }
        }

        function compressImage(fileBlob) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = URL.createObjectURL(fileBlob);
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width;
                    let h = img.height;
                    
                    const MAX = 1920; 
                    if (w > MAX || h > MAX) {
                        if (w > h) { h *= MAX/w; w = MAX; }
                        else { w *= MAX/h; h = MAX; }
                    }

                    canvas.width = w;
                    canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    
                    canvas.toBlob((blob) => {
                        resolve(blob);
                        URL.revokeObjectURL(img.src);
                    }, 'image/webp', 0.7);
                };
            });
        }

        // --- DOWNLOADS ---
        function getActiveList() {
            return isCrunchMode ? crunchedBlobs : originalBlobs;
        }

        function downloadSingle(name) {
            const list = getActiveList();
            const item = list.find(i => i.name === name);
            if(item) saveAs(item.blob, item.name);
        }

        async function downloadImagesZip() {
            const list = getActiveList();
            if(list.length === 0) return;

            const btn = document.getElementById('zipBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div> Zipping...';

            const zip = new JSZip();
            const folder = zip.folder("images_to_upload");
            
            list.forEach(item => {
                folder.file(item.name, item.blob);
            });

            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, isCrunchMode ? "images_optimized.zip" : "images_original.zip");

            btn.innerHTML = originalText;
            feather.replace();
        }

        async function downloadAllIndividual() {
            const list = getActiveList();
            if(list.length === 0) return;

            const btn = document.getElementById('multiBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Downloading...';
            
            for (let i = 0; i < list.length; i++) {
                saveAs(list[i].blob, list[i].name);
                await new Promise(r => setTimeout(r, 300)); 
            }

            btn.innerHTML = originalText;
            feather.replace();
        }

        function copyCode() {
            const box = document.getElementById('codeDisplay');
            box.select();
            document.execCommand('copy');
            const btn = document.getElementById('copyBtn');
            btn.innerHTML = `<i data-feather="check" class="w-3 h-3 text-green-400"></i> Copied!`;
            btn.classList.add('border-green-500', 'text-white');
            feather.replace();
            setTimeout(() => {
                btn.innerHTML = `<i data-feather="copy" class="w-3 h-3"></i> Copy HTML`;
                btn.classList.remove('border-green-500', 'text-white');
                feather.replace();
            }, 2000);
        }

        function resetApp() {
            window.location.reload();
        }
    </script>
</body>
</html>
