<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reputifly | Client Portal</title>

    <link rel="icon" type="image/png"
        href="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug">
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(20, 20, 30, 0.6);
        }

        body {
            background: linear-gradient(90deg, #050505 0%, #111018 50%, #050505 100%);
            color: #F0F0F0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        h1,
        h2,
        h3,
        .brand-font {
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -0.02em;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .mask-gradient {
            -webkit-mask-image: linear-gradient(to right, black 90%, transparent 100%);
            mask-image: linear-gradient(to right, black 90%, transparent 100%);
        }

        html,
        body {
            -ms-overflow-style: none;
        }

        /* Tooltip */
        .has-tooltip {
            position: relative;
            cursor: help;
        }

        .has-tooltip .tooltip-content {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 4px 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            /* Position above */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 10px;
            white-space: nowrap;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .has-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        /* Auth Gate */
        #auth-gate {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: linear-gradient(90deg, #050505 0%, #111018 50%, #050505 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gate-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #E6397F;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Glass */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-top: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
            border-radius: 16px;
        }

        /* Buttons */
        .btn-hero-glass {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
            border-radius: 9999px;
            color: #ccc;
            font-weight: 600;
            font-size: 13px;
            padding: 8px 20px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .btn-hero-glass:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* Filter Btn (Custom) */
        .filter-btn {
            padding: 6px 16px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(255, 255, 255, 0.02);
            color: #888;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .filter-btn:hover {
            color: #ccc;
            border-color: rgba(255, 255, 255, 0.12);
        }

        .filter-btn.active {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.18);
            color: #fff;
        }

        /* Nav Tabs */
        .nav-tab {
            padding: 8px 16px;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            color: #888;
            background: transparent;
        }

        .nav-tab:hover {
            color: #ccc;
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.12);
            color: #fff;
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table th {
            text-align: left;
            padding: 14px 20px;
            color: #6b7280;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            border-bottom: 1px solid var(--glass-border);
            white-space: nowrap;
        }

        .data-table td {
            padding: 14px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 14px;
            color: #e0e0e0;
            vertical-align: middle;
        }

        .data-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* Badges */
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-new {
            background: rgba(16, 185, 129, 0.1);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .badge-junk {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .badge-contacted {
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .badge-click {
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .badge-click:hover {
            filter: brightness(1.3);
            transform: scale(1.05);
        }

        .badge-click:active {
            transform: scale(0.95);
        }

        /* Filter pills/badges count */
        .count-badge {
            font-size: 10px;
            font-weight: 800;
            padding: 1px 7px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.06);
            color: inherit;
            font-family: 'Space Grotesk', sans-serif;
            margin-left: 4px;
        }

        .gradient-text {
            background: linear-gradient(90deg, #E6397F, #FF8A00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .note-input {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid transparent;
            border-radius: 8px;
            color: #ccc;
            font-size: 12px;
            padding: 6px 10px;
            width: 100%;
            min-width: 140px;
            max-width: 220px;
            outline: none;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .note-input:hover {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .note-input:focus {
            border-color: rgba(230, 57, 127, 0.4);
            background: rgba(255, 255, 255, 0.06);
            color: #fff;
        }

        .note-input::placeholder {
            color: #555;
        }

        /* Stat cards (compact) */
        .stat-mini {
            text-align: center;
        }

        .stat-mini-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -0.03em;
            line-height: 1;
        }

        .stat-mini-label {
            font-size: 10px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            margin-top: 4px;
        }

        /* Calendar */
        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }

        .cal-day-label {
            font-size: 10px;
            color: #555;
            text-align: center;
            font-weight: 600;
            padding: 4px 0;
            text-transform: uppercase;
        }

        .cal-cell {
            aspect-ratio: 1;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #666;
            transition: all 0.2s ease;
            cursor: default;
            position: relative;
            border: 1px solid transparent;
        }

        .cal-cell.has-leads {
            color: #fff;
        }

        .cal-cell.today {
            border-color: rgba(230, 57, 127, 0.5);
        }

        .cal-cell .cal-count {
            font-size: 9px;
            font-weight: 700;
            font-family: 'Space Grotesk', sans-serif;
            margin-top: 1px;
        }

        .cal-cell:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .cal-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cal-nav button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s;
        }

        .cal-nav button:hover {
            color: #fff;
        }

        /* Chart containers */
        .chart-wrap {
            position: relative;
        }

        /* View sections */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }


        .blur-content {
            filter: blur(5px);
            pointer-events: none;
            user-select: none;
            opacity: 0.6;
        }

        .paywall-overlay {
            position: absolute;
            inset: 0;
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 50;
            background: rgba(5, 5, 10, 0.3);
            backdrop-filter: grayscale(100%);
        }

        .paywall-card {
            background: rgba(11, 10, 20, 0.95);
            border: 1px solid rgba(255, 50, 50, 0.2);
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            max-width: 320px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <!-- AUTH GATE -->
    <div id="auth-gate">
        <div class="text-center">
            <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png"
                class="h-8 mx-auto mb-6 brightness-125">
            <div class="gate-spinner mx-auto"></div>
            <p class="text-gray-500 text-xs mt-4">Verifying access...</p>
        </div>
    </div>

    <!-- NAV -->
    <nav class="border-b border-white/5 bg-black/20 backdrop-blur-md sticky top-0 z-40">
        <div class="w-full max-w-[95%] mx-auto h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png"
                    class="h-6 w-auto brightness-125" alt="Reputifly">
                <div class="h-5 w-px bg-white/10"></div>
                <div class="flex items-center gap-1.5">
                    <button id="tab-leads" class="nav-tab active" onclick="window.switchTab('leads')">
                        <i data-feather="inbox" class="w-3.5 h-3.5 inline -mt-0.5 md:mr-1"></i><span
                            class="hidden sm:inline">Leads</span>
                    </button>
                    <button id="tab-analytics" class="nav-tab" onclick="window.switchTab('analytics')">
                        <i data-feather="bar-chart-2" class="w-3.5 h-3.5 inline -mt-0.5 md:mr-1"></i><span
                            class="hidden sm:inline">Analytics</span>
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="hidden sm:flex items-center gap-2">
                    <div class="h-1.5 w-1.5 rounded-full bg-green-500 animate-pulse"></div>
                    <span id="nav-email" class="text-[11px] text-gray-500 font-mono"></span>
                </div>
                <button onclick="window.clientLogout()" class="btn-hero-glass text-xs py-1.5 px-4" title="Sign Out">
                    <i data-feather="log-out" class="w-3.5 h-3.5"></i>
                    <span class="hidden sm:inline">Sign Out</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- CONTENT -->
    <main class="w-full max-w-[95%] mx-auto py-6 relative z-10">

        <!-- ==================== LEADS TAB ==================== -->
        <div id="view-leads" class="view-section active">

            <!-- HEADER -->
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-5">
                <div>
                    <h1 id="welcome-name" class="text-2xl font-bold text-white brand-font">Your Leads</h1>
                    <p class="text-gray-500 text-sm mt-1">Real-time view of all your incoming leads.</p>
                </div>
                <div class="flex items-center gap-5">
                    <div class="hidden sm:block">
                        <div class="stat-mini-value text-sm text-gray-400" id="stat-last-active" style="font-size:15px">
                            —</div>
                        <div class="stat-mini-label">Recent Activity</div>
                    </div>
                </div>
            </div>

            <!-- FILTER BAR + TABLE -->
            <div class="glass-panel overflow-hidden flex flex-col relative">

                <div id="paywall-overlay" class="paywall-overlay">
                    <div class="paywall-card">
                        <div
                            class="mx-auto w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center mb-4 border border-red-500/20">
                            <i data-feather="lock" class="w-5 h-5 text-red-400"></i>
                        </div>
                        <h3 class="text-white font-bold text-lg mb-2">Account Paused</h3>
                        <p class="text-gray-400 text-xs mb-5 leading-relaxed">
                            Your lead access is temporarily suspended.<br>
                            You have <span class="text-white font-bold" id="hidden-lead-count">incoming</span> leads
                            waiting.
                        </p>
                        <div class="text-[10px] text-gray-600 font-mono bg-black/30 p-2 rounded">
                            STATUS: RESTRICTED
                        </div>
                    </div>
                </div>

                <div class="px-5 py-3 border-b border-white/5">
                    <!-- Filter Scroll Container -->
                    <div class="flex items-center gap-2 overflow-x-auto no-scrollbar w-full pb-1">
                        <button class="filter-btn active flex-shrink-0" id="btn-all" onclick="setFilter('all')">All
                            <span class="count-badge" id="count-all">0</span></button>
                        <button class="filter-btn flex-shrink-0" id="btn-new" onclick="setFilter('new')">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span> New <span class="count-badge"
                                id="count-new">0</span></button>
                        <button class="filter-btn flex-shrink-0" id="btn-contacted" onclick="setFilter('contacted')">
                            <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span> Contacted <span
                                class="count-badge" id="count-contacted">0</span></button>
                        <button class="filter-btn flex-shrink-0" id="btn-junk" onclick="setFilter('junk')">
                            <span class="w-1.5 h-1.5 rounded-full bg-red-400"></span> Junk <span class="count-badge"
                                id="count-junk">0</span></button>

                        <!-- Dynamic Filter Add Button -->
                        <div class="relative inline-block ml-2 flex-shrink-0">
                            <button class="filter-btn" id="btn-add-filter" onclick="openFilterModal()"
                                style="padding: 6px 10px;">
                                <i data-feather="plus" class="w-4 h-4"></i>
                            </button>
                        </div>

                        <!-- Active Filter Pill (Hidden by default) -->
                        <div id="active-filter-pill"
                            class="hidden flex items-center gap-2 bg-purple-500/20 text-purple-300 px-3 py-1 rounded-full text-xs border border-purple-500/30 ml-2 flex-shrink-0">
                            <span id="active-filter-text"></span>
                            <button onclick="clearCustomFilter()" class="hover:text-white"><i data-feather="x"
                                    class="w-3 h-3"></i></button>
                        </div>

                        <!-- Export Button (Now Scrollable) -->
                        <button id="btn-export"
                            class="btn-hero-glass text-xs py-1.5 px-4 flex-shrink-0 ml-auto sm:ml-2">
                            <i data-feather="download" class="w-3 h-3 mr-1 inline"></i> Export CSV
                        </button>
                    </div>
                </div>

                <!-- NEW DAILY CAP PROGRESS (Minimalistic) -->
                <div id="daily-cap-container"
                    class="px-5 py-2 border-b border-white/5 bg-white/0 flex items-center gap-3 text-xs">
                    <div class="flex flex-col sm:flex-row sm:items-center gap-1">
                        <span class="text-gray-400 font-medium whitespace-nowrap">Emails Sent Today</span>
                        <span class="text-[10px] text-gray-600 whitespace-nowrap">(Includes Auto-Replies)</span>
                    </div>
                    <div class="flex-grow h-1.5 bg-white/5 rounded-full overflow-hidden relative mx-2">
                        <div id="usage-progress-bar" class="h-full bg-purple-500 transition-all duration-500 relative"
                            style="width: 0%">
                        </div>
                    </div>
                    <div class="text-[10px] font-mono text-gray-400 whitespace-nowrap">
                        <span id="stat-usage-current" class="text-white font-bold">0</span> / <span
                            id="stat-usage-limit">...</span>
                    </div>
                </div>
                <div class="overflow-x-auto flex-grow min-h-[500px]">
                    <table class="data-table">
                        <thead id="leads-table-head"></thead>
                        <tbody id="leads-table-body">
                            <tr>
                                <td colspan="5" class="text-center py-20 text-gray-500">Loading your leads...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- FILTER MODAL (New Polish) -->
            <div id="filter-modal"
                class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
                <!-- Modal Content -->
                <div class="glass-panel w-full max-w-sm mx-4 overflow-hidden shadow-2xl transform transition-all scale-100"
                    id="filter-modal-content">

                    <!-- Header -->
                    <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between bg-white/5">
                        <h3 class="text-white font-bold brand-font text-lg" id="filter-modal-title">Filter Leads</h3>
                        <button onclick="closeFilterModal()" class="text-gray-400 hover:text-white transition">
                            <i data-feather="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Step 1: Select Field -->
                    <div id="filter-step-fields" class="p-2 max-h-[60vh] overflow-y-auto">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Step 2: Select Value -->
                    <div id="filter-step-values" class="hidden p-2 max-h-[60vh] overflow-y-auto">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Footer (Back button for Step 2) -->
                    <div id="filter-modal-footer" class="hidden border-t border-white/10 p-3 bg-white/5">
                        <button onclick="backToFilterFields()"
                            class="text-xs text-gray-400 hover:text-white flex items-center gap-1">
                            <i data-feather="arrow-left" class="w-3 h-3"></i> Back to Fields
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- ==================== ANALYTICS TAB ==================== -->
        <div id="view-analytics" class="view-section">

            <!-- KPI Row -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="glass-panel p-5 text-center">
                    <div class="stat-mini-value text-white" id="kpi-total">0</div>
                    <div class="stat-mini-label">Total Leads</div>
                </div>
                <div class="glass-panel p-5 text-center">
                    <div class="stat-mini-value text-emerald-400" id="kpi-this-month">0</div>
                    <div class="stat-mini-label">This Month</div>
                </div>
                <div class="glass-panel p-5 text-center">
                    <div class="stat-mini-value text-blue-400" id="kpi-conversion">0%</div>
                    <div class="stat-mini-label">Contacted Rate</div>
                </div>
                <div class="glass-panel p-5 text-center">
                    <div class="stat-mini-value text-orange-400" id="kpi-response-time">—</div>
                    <div class="stat-mini-label">Avg Response</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                <!-- Lead Volume Chart (2/3) -->
                <div class="glass-panel p-5 lg:col-span-2">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-bold text-gray-300 uppercase tracking-wider">Lead Volume</h3>
                        <div class="flex gap-1">
                            <button onclick="window.setChartRange('7d')" id="btn-7d"
                                class="filter-pill text-[10px] py-1 px-3 active">7D</button>
                            <button onclick="window.setChartRange('30d')" id="btn-30d"
                                class="filter-pill text-[10px] py-1 px-3">30D</button>
                            <button onclick="window.setChartRange('90d')" id="btn-90d"
                                class="filter-pill text-[10px] py-1 px-3">90D</button>
                        </div>
                    </div>
                    <div class="chart-wrap" style="height: 220px;">
                        <canvas id="chart-volume"></canvas>
                    </div>
                </div>
                <!-- Status Breakdown Donut (1/3) -->
                <div class="glass-panel p-5">
                    <h3 class="text-sm font-bold text-gray-300 uppercase tracking-wider mb-4">Status Breakdown</h3>
                    <div class="chart-wrap flex items-center justify-center" style="height: 220px;">
                        <canvas id="chart-status"></canvas>
                    </div>
                </div>
            </div>

            <!-- Calendar -->
            <div class="glass-panel p-5">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-gray-300 uppercase tracking-wider">Lead Calendar</h3>
                    <div class="cal-nav">
                        <button onclick="window.calPrev()"><i data-feather="chevron-left" class="w-4 h-4"></i></button>
                        <span id="cal-month-label"
                            class="text-sm font-semibold text-gray-300 brand-font min-w-[120px] text-center"></span>
                        <button onclick="window.calNext()"><i data-feather="chevron-right" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <div class="cal-grid mb-1">
                    <div class="cal-day-label">Sun</div>
                    <div class="cal-day-label">Mon</div>
                    <div class="cal-day-label">Tue</div>
                    <div class="cal-day-label">Wed</div>
                    <div class="cal-day-label">Thu</div>
                    <div class="cal-day-label">Fri</div>
                    <div class="cal-day-label">Sat</div>
                </div>
                <div id="cal-body" class="cal-grid"></div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="text-center mt-8 pb-6">
            <p class="text-[11px] text-gray-600">Securely processed by <span
                    class="gradient-text font-bold">Reputifly</span></p>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, where, doc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC9eUHEdAmV9qzHxpQe2en5WeOeRXiq10A",
            authDomain: "b2b-software.firebaseapp.com",
            projectId: "b2b-software",
            storageBucket: "b2b-software.firebasestorage.app",
            messagingSenderId: "231187362713",
            appId: "1:231187362713:web:07f2f24b3c79557f7a9908"
        };

        const app = initializeApp(firebaseConfig);
        const authInstance = getAuth(app);
        const db = getFirestore(app);

        const SUPER_ADMIN_EMAIL = "realjuliantung@gmail.com";
        let clientEmail = null;
        let clientLeads = [];
        let activeFilter = 'all'; // all, new, contacted, junk
        let customFilter = null; // { field: 'Source', value: 'Footer' }
        let sortOrder = 'desc'; // desc or asc
        let volumeChart = null;
        let statusChart = null;
        let chartRange = '7d';
        let calDate = new Date(); // Analytics calendar

        // ==========================================
        // AUTH GATE
        // ==========================================
        onAuthStateChanged(authInstance, (user) => {
            const gate = document.getElementById('auth-gate');
            if (!user) { window.location.href = 'index.html'; return; }
            if (user.email === SUPER_ADMIN_EMAIL) { window.location.href = 'dashboard.html'; return; }

            clientEmail = user.email;
            gate.style.display = 'none';
            document.getElementById('nav-email').textContent = clientEmail;
            const name = clientEmail.split('@')[0].replace(/[._-]/g, ' ');
            document.getElementById('welcome-name').textContent =
                name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') + "'s Leads";

            startLeadsListener();
            startClientStatusListener(user.uid); // <--- Listen for Pause Status
            feather.replace();
        });

        // ==========================================
        // TAB SWITCHING
        // ==========================================
        window.switchTab = (tab) => {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById('tab-leads').classList.remove('active');
            document.getElementById('tab-analytics').classList.remove('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.getElementById(`view-${tab}`).classList.add('active');
            if (tab === 'analytics') renderAnalytics();
        };

        // ==========================================
        // LOGOUT
        // ==========================================
        window.clientLogout = () => {
            signOut(authInstance).then(() => window.location.href = 'index.html');
        };

        // ==========================================
        // CLIENT STATUS LISTENER (Pause/Access Control)
        // ==========================================
        function startClientStatusListener(uid) {
            const userDocRef = doc(db, 'clients', uid);

            onSnapshot(userDocRef, (docSnap) => {
                const container = document.getElementById('daily-cap-container');
                const overlay = document.getElementById('paywall-overlay');
                const content = document.querySelector('.data-table');

                if (docSnap.exists()) {
                    const data = docSnap.data();

                    // 1. PAUSE CHECK
                    if (data.status === 'paused') {
                        if (overlay) overlay.style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                        if (content) content.classList.add('blur-content');
                        if (document.getElementById('hidden-lead-count')) {
                            document.getElementById('hidden-lead-count').textContent = clientLeads.length;
                        }
                    } else {
                        if (overlay) overlay.style.display = 'none';
                        document.body.style.overflow = 'auto';
                        if (content) content.classList.remove('blur-content');
                    }

                    // 2. USAGE STATS
                    const today = new Date().toLocaleDateString("en-CA", { timeZone: "Asia/Singapore" });
                    let used = 0;
                    if (data.usageStats && data.usageStats.date === today) {
                        used = data.usageStats.count || 0;
                    }

                    const limit = data.customDailyLimit || 50;

                    // Update UI
                    const currentEl = document.getElementById('stat-usage-current');
                    const limitEl = document.getElementById('stat-usage-limit');
                    const bar = document.getElementById('usage-progress-bar');

                    if (currentEl) currentEl.textContent = used;
                    if (limitEl) limitEl.textContent = limit;

                    if (bar) {
                        const pct = Math.min((used / limit) * 100, 100);
                        bar.style.width = `${pct}%`;

                        // Color coding
                        if (pct >= 100) {
                            bar.className = "h-full bg-red-500 transition-all duration-500 relative";
                        } else if (pct >= 80) {
                            bar.className = "h-full bg-orange-500 transition-all duration-500 relative";
                        } else {
                            bar.className = "h-full bg-purple-500 transition-all duration-500 relative";
                        }
                    }

                    if (container) container.classList.remove('hidden');

                } else {
                    console.warn("Client doc not found");
                }
            }, (error) => {
                console.error("Error listening to client status:", error);
            });
        }

        // ==========================================
        // LEADS LISTENER
        // ==========================================
        function startLeadsListener() {
            const q = query(
                collection(db, "leads"),
                where("clientId", "==", clientEmail),
                orderBy("createdAt", "desc")
            );

            onSnapshot(q, (snapshot) => {
                clientLeads = [];
                snapshot.forEach((docSnap) => {
                    clientLeads.push({ id: docSnap.id, ...docSnap.data() });
                });
                updateCounts();
                renderTable();
                // If analytics tab is visible, refresh
                if (document.getElementById('view-analytics').classList.contains('active')) renderAnalytics();
            });
        }

        // ==========================================
        // COUNTS (Reduced logic for simplified UI)
        // ==========================================
        function updateCounts() {
            const total = clientLeads.length;
            const newCount = clientLeads.filter(l => l.status === 'new' || !l.status).length;
            const contacted = clientLeads.filter(l => l.status === 'contacted').length;
            const junk = clientLeads.filter(l => l.status === 'junk').length;

            document.getElementById('count-all').textContent = total;
            document.getElementById('count-new').textContent = newCount;
            document.getElementById('count-contacted').textContent = contacted;
            document.getElementById('count-junk').textContent = junk;

            if (total > 0 && clientLeads[0].createdAt) {
                const d = new Date(clientLeads[0].createdAt.seconds * 1000);
                // Last active: "Oct 24, 2:30 PM"
                document.getElementById('stat-last-active').textContent = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) + ', ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            } else {
                document.getElementById('stat-last-active').textContent = '—';
            }
        }

        // --- FILTER LOGIC ---
        function setFilter(status) {
            activeFilter = status;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            // Keep the custom filter active visually if distinct
            if (['all', 'new', 'contacted', 'junk'].includes(status)) {
                document.getElementById(`btn-${status}`).classList.add('active');
            }
            renderTable();
        }

        function getFilteredLeads() {
            let filtered = clientLeads;

            // 1. Status Filter
            if (activeFilter !== 'all') {
                filtered = filtered.filter(l => (l.status || 'new') === activeFilter);
            }

            // 2. Custom Field Filter
            if (customFilter) {
                filtered = filtered.filter(l => {
                    const val = l.lead && l.lead[customFilter.field];
                    return String(val) === String(customFilter.value);
                });
            }

            // 3. Sorting
            filtered.sort((a, b) => {
                const dateA = a.createdAt ? a.createdAt.seconds : 0;
                const dateB = b.createdAt ? b.createdAt.seconds : 0;
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
            return filtered;
        }

        // ==========================================
        // TABLE
        // ==========================================
        function renderTable() {
            const thead = document.getElementById('leads-table-head');
            const tbody = document.getElementById('leads-table-body');
            thead.innerHTML = ''; tbody.innerHTML = '';
            const filtered = getFilteredLeads();

            if (filtered.length === 0) {
                const msg = activeFilter === 'all' ? "When your forms start generating leads, they'll appear here." : `No leads with status "${activeFilter}".`;
                tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><div class="empty-icon"><i data-feather="inbox" class="w-6 h-6 text-gray-600"></i></div><h3 class="text-base font-bold text-gray-400 brand-font mb-1">No Leads Found</h3><p class="text-sm text-gray-500 max-w-xs mx-auto">${msg}</p></div></td></tr>`;
                feather.replace(); return;
            }

            // Dynamic Columns
            let columns = new Set();
            clientLeads.forEach(lead => { if (lead.lead) Object.keys(lead.lead).forEach(k => columns.add(k)); });
            let colArray = Array.from(columns);
            const priority = ['name', 'email', 'phone'];
            colArray.sort((a, b) => {
                const aP = priority.indexOf(a.toLowerCase()), bP = priority.indexOf(b.toLowerCase());
                if (aP !== -1 && bP !== -1) return aP - bP;
                if (aP !== -1) return -1; if (bP !== -1) return 1;
                return a.localeCompare(b);
            });

            const arrow = sortOrder === 'desc' ? '<i data-feather="arrow-down" class="w-3 h-3 ml-1 inline text-gray-400"></i>' : '<i data-feather="arrow-up" class="w-3 h-3 ml-1 inline text-gray-400"></i>';
            let headerHTML = `<tr><th onclick="window.toggleSort()" class="cursor-pointer hover:text-white transition select-none flex items-center gap-1 group">Date ${arrow}</th>`;
            colArray.forEach(col => { headerHTML += `<th>${col.charAt(0).toUpperCase() + col.slice(1)}</th>`; });
            headerHTML += `<th>Status</th><th>Notes</th></tr>`;
            thead.innerHTML = headerHTML;

            filtered.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "transition-colors duration-200";
                let dateStr = 'N/A';
                if (item.createdAt) {
                    const d = new Date(item.createdAt.seconds * 1000);
                    dateStr = `<div class="text-xs text-white font-medium">${d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}</div><div class="text-[10px] text-gray-500">${d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
                }

                let rowHTML = `<td>${dateStr}</td>`;
                colArray.forEach(col => {
                    let val = item.lead ? (item.lead[col] || '-') : '-';
                    if (col.toLowerCase() === 'email') val = `<span class="text-white">${val}</span>`;
                    if (col.toLowerCase() === 'name') val = `<span class="font-semibold text-white">${val}</span>`;
                    rowHTML += `<td class="text-sm text-gray-400">${val}</td>`;
                });

                let currentStatus = (item.status || 'new').toUpperCase();
                let badgeClass = 'badge-new';
                let nextStatus = 'contacted';

                if (currentStatus === 'CONTACTED') { badgeClass = 'badge-contacted'; nextStatus = 'junk'; }
                else if (currentStatus === 'JUNK') { badgeClass = 'badge-junk'; nextStatus = 'new'; }

                // Auto-Reply Indicator (Subtle Green Dot)
                let autoReplyIcon = '';
                if (item.autoReplySent) {
                    autoReplyIcon = `
                        <span class="ml-2 inline-block has-tooltip">
                            <span class="block w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_rgba(16,185,129,0.5)]"></span>
                            <span class="tooltip-content">Auto-Reply Sent</span>
                        </span>`;
                }

                rowHTML += `<td><span class="badge badge-click ${badgeClass}" onclick="window.updateStatus('${item.id}', '${nextStatus}')" title="Click to mark as ${nextStatus}">${currentStatus}</span>${autoReplyIcon}</td>`;
                rowHTML += `<td><input type="text" class="note-input" placeholder="Add note..." value="${(item.note || '').replace(/"/g, '&quot;')}" onblur="window.saveNote('${item.id}', this.value)" /></td>`;

                tr.innerHTML = rowHTML;
                tbody.appendChild(tr);
            });
            feather.replace();
        }

        // ==========================================
        // ACTIONS
        // ==========================================
        window.updateStatus = async (id, status) => {
            const row = document.querySelector(`span[onclick*="${id}"]`).closest('tr');
            row.style.opacity = '0.5';
            await updateDoc(doc(db, "leads", id), { status: status });
        };

        window.saveNote = async (id, note) => {
            await updateDoc(doc(db, "leads", id), { note: note });
        };

        // Sorting
        window.toggleSort = () => {
            sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
            renderTable();
        };

        // --- DYNAMIC FILTER MODAL (Polished) ---
        window.openFilterModal = () => {
            const modal = document.getElementById('filter-modal');
            modal.classList.remove('hidden');
            renderFilterFields();
        };

        window.closeFilterModal = () => {
            document.getElementById('filter-modal').classList.add('hidden');
        };

        // Render Step 1: Fields
        function renderFilterFields() {
            document.getElementById('filter-modal-title').textContent = "Filter by...";
            document.getElementById('filter-step-fields').classList.remove('hidden');
            document.getElementById('filter-step-values').classList.add('hidden');
            document.getElementById('filter-modal-footer').classList.add('hidden');

            const container = document.getElementById('filter-step-fields');
            container.innerHTML = '';

            // Get Fields
            const fields = new Set();
            clientLeads.forEach(l => {
                if (l.lead) Object.keys(l.lead).forEach(k => fields.add(k));
            });

            if (fields.size === 0) {
                container.innerHTML = `<div class="p-8 text-center text-gray-500 text-sm">No data found to filter.</div>`;
                return;
            }

            Array.from(fields).sort().forEach(field => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left px-4 py-3 rounded-lg hover:bg-white/10 text-gray-300 hover:text-white transition flex items-center justify-between group mb-1";
                btn.innerHTML = `
                    <span class="font-medium capitalization">${field}</span>
                    <i data-feather="chevron-right" class="w-4 h-4 text-gray-600 group-hover:text-white transition"></i>
                `;
                btn.onclick = () => selectFilterField(field);
                container.appendChild(btn);
            });
            feather.replace();
        }

        // Render Step 2: Values
        window.selectFilterField = (field) => {
            document.getElementById('filter-modal-title').textContent = `Filter by ${field}`;
            document.getElementById('filter-step-fields').classList.add('hidden');
            document.getElementById('filter-step-values').classList.remove('hidden');
            document.getElementById('filter-modal-footer').classList.remove('hidden');

            const container = document.getElementById('filter-step-values');
            container.innerHTML = '';

            // Get Values
            const values = new Set();
            clientLeads.forEach(l => {
                if (l.lead && l.lead[field]) values.add(l.lead[field]);
            });

            if (values.size === 0) {
                container.innerHTML = `<div class="p-8 text-center text-gray-500 text-sm">No values found.</div>`;
                return;
            }

            Array.from(values).sort().forEach(val => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left px-4 py-3 rounded-lg hover:bg-white/10 text-gray-300 hover:text-white transition flex items-center gap-3 mb-1";
                btn.innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-purple-500/50"></div>
                    <span class="font-medium truncate">${val}</span>
                `;
                btn.onclick = () => window.applyCustomFilter(field, val);
                container.appendChild(btn);
            });
        };

        window.backToFilterFields = () => {
            renderFilterFields();
        };

        window.applyCustomFilter = (field, value) => {
            customFilter = { field, value };

            // Update UI
            const pill = document.getElementById('active-filter-pill');
            const text = document.getElementById('active-filter-text');
            text.textContent = `${field}: ${value}`;
            pill.classList.remove('hidden');

            window.closeFilterModal();
            renderTable();
        };

        window.clearCustomFilter = () => {
            customFilter = null;
            document.getElementById('active-filter-pill').classList.add('hidden');
            renderTable();
        };

        // Close when clicking overlay
        document.getElementById('filter-modal').addEventListener('click', (e) => {
            if (e.target.id === 'filter-modal') window.closeFilterModal();
        });

        // Initialize Global Expose (since module scope)
        window.setFilter = setFilter;
        // setChartRange, calPrev, calNext used in HTLM onclicks
        window.setChartRange = setChartRange;
        window.calPrev = () => { calDate.setMonth(calDate.getMonth() - 1); renderCalendar(); };
        window.calNext = () => { calDate.setMonth(calDate.getMonth() + 1); renderCalendar(); };


        // ==========================================
        // ANALYTICS & CHARTS
        // ==========================================
        function renderAnalytics() {
            // KPI Calculations
            const total = clientLeads.length;
            const now = new Date();
            const thisMonth = clientLeads.filter(l => {
                if (!l.createdAt) return false;
                const d = new Date(l.createdAt.seconds * 1000);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            }).length;

            const contacted = clientLeads.filter(l => l.status === 'contacted').length;
            const rate = total > 0 ? Math.round((contacted / total) * 100) : 0;

            document.getElementById('kpi-total').textContent = total;
            document.getElementById('kpi-this-month').textContent = thisMonth;
            document.getElementById('kpi-conversion').textContent = rate + '%';

            // Charts (Destroy old first)
            if (volumeChart) volumeChart.destroy();
            if (statusChart) statusChart.destroy();

            renderVolumeChart(chartRange);
            renderStatusChart();
            renderCalendar();
        }

        function setChartRange(range) {
            chartRange = range;
            document.querySelectorAll('#view-analytics .filter-pill').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${range}`).classList.add('active');
            // Re-render only volume chart
            if (volumeChart) volumeChart.destroy();
            renderVolumeChart(range);
        }

        function renderVolumeChart(range) {
            const days = range === '7d' ? 7 : (range === '30d' ? 30 : 90);
            const labels = [];
            const data = new Array(days).fill(0);

            for (let i = days - 1; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('en-US', { day: 'numeric', month: 'short' }));
            }

            clientLeads.forEach(l => {
                if (!l.createdAt) return;
                const d = new Date(l.createdAt.seconds * 1000);
                const diffTime = Math.abs(new Date() - d);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays <= days) {
                    data[days - diffDays]++; // simplified logic
                }
            });

            // Adjust simplified logic above to align exact dates
            // (Re-calculate strictly for better accuracy)
            const map = {};
            labels.forEach(l => map[l] = 0);
            clientLeads.forEach(l => {
                if (!l.createdAt) return;
                const d = new Date(l.createdAt.seconds * 1000);
                const k = d.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                if (map[k] !== undefined) map[k]++;
            });
            const finalData = labels.map(l => map[l]);

            const ctx = document.getElementById('chart-volume').getContext('2d');
            volumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Leads',
                        data: finalData,
                        backgroundColor: '#a855f7',
                        borderRadius: 4,
                        hoverBackgroundColor: '#d8b4fe'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#666', font: { size: 10 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#666', font: { size: 10 }, maxTicksLimit: 7 }
                        }
                    }
                }
            });
        }

        function renderStatusChart() {
            const ctx = document.getElementById('chart-status').getContext('2d');
            const counts = [
                clientLeads.filter(l => l.status === 'new' || !l.status).length,
                clientLeads.filter(l => l.status === 'contacted').length,
                clientLeads.filter(l => l.status === 'junk').length
            ];

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['New', 'Contacted', 'Junk'],
                    datasets: [{
                        data: counts,
                        backgroundColor: ['#34d399', '#60a5fa', '#f87171'], // New (Green), Contacted (Blue), Junk (Red)
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { position: 'right', labels: { color: '#ccc', font: { size: 11 }, boxWidth: 10 } }
                    }
                }
            });
        }

        // ==========================================
        // CALENDAR
        // ==========================================
        function renderCalendar() {
            const container = document.getElementById('cal-body');
            container.innerHTML = '';

            const year = calDate.getFullYear();
            const month = calDate.getMonth();
            document.getElementById('cal-month-label').textContent = calDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            // Empty cells for padding
            for (let i = 0; i < firstDay; i++) {
                container.appendChild(document.createElement('div'));
            }

            // Days
            for (let d = 1; d <= daysInMonth; d++) {
                const cellDate = new Date(year, month, d);
                const div = document.createElement('div');
                div.className = 'cal-cell';

                // Check if today
                if (cellDate.toDateString() === today.toDateString()) div.classList.add('today');

                // Count leads for this day
                const count = clientLeads.filter(l => {
                    if (!l.createdAt) return false;
                    const ld = new Date(l.createdAt.seconds * 1000);
                    return ld.toDateString() === cellDate.toDateString();
                }).length;

                if (count > 0) {
                    div.classList.add('has-leads');
                    div.style.background = `rgba(168, 85, 247, ${Math.min(0.2 + (count * 0.1), 0.8)})`; // Purple opacity based on volume
                    div.style.borderColor = `rgba(168, 85, 247, 0.3)`;
                } else {
                    div.style.background = 'rgba(255,255,255,0.02)';
                }

                div.innerHTML = `<div>${d}</div>${count > 0 ? `<div class="cal-count">${count}</div>` : ''}`;
                container.appendChild(div);
            }
        }

    </script>
</body>

</html>
