<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reputifly | Client Portal</title>

    <link rel="icon" type="image/png"
        href="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug">
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(20, 20, 30, 0.6);
        }

        body {
            background: linear-gradient(90deg, #050505 0%, #111018 50%, #050505 100%);
            color: #F0F0F0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        h1,
        h2,
        h3,
        .brand-font {
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -0.02em;
        }

        ::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .mask-gradient {
            -webkit-mask-image: linear-gradient(to right, black 90%, transparent 100%);
            mask-image: linear-gradient(to right, black 90%, transparent 100%);
        }

        html,
        body {
            -ms-overflow-style: none;
        }

        /* Tooltip */
        .has-tooltip {
            position: relative;
            cursor: help;
        }

        .has-tooltip .tooltip-content {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 4px 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            /* Position above */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 10px;
            white-space: nowrap;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        select.form-input option,
        select#tabs-dropdown option,
        optgroup {
            background-color: #111018;
            /* Deep dark bg */
            color: #ffffff;
            padding: 10px;
        }

        /* Fix for Table Visibility - ensure empty cells don't collapse */
        .data-table td {
            min-height: 40px;
        }

        .has-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        /* Auth Gate */
        #auth-gate {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: linear-gradient(90deg, #050505 0%, #111018 50%, #050505 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gate-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #E6397F;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @media print {
            body * {
                visibility: hidden !important;
            }

            .no-print {
                display: none !important;
            }
        }

        /* Modal Overlay */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .modal-backdrop.open {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: #111018;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            padding: 24px;
            transform: scale(0.95);
            transition: transform 0.25s ease;
            box-shadow: 0 25px 60px -12px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .modal-backdrop.open .modal-content {
            transform: scale(1);
        }

        /* Glass */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-top: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
            border-radius: 20px;
        }

        /* Buttons */
        .btn-hero-glass {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
            border-radius: 9999px;
            color: #ccc;
            font-weight: 600;
            font-size: 13px;
            padding: 8px 20px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .btn-hero-glass:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* Filter Btn (Custom) */
        .filter-btn {
            padding: 6px 16px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(255, 255, 255, 0.02);
            color: #888;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .filter-btn:hover {
            color: #ccc;
            border-color: rgba(255, 255, 255, 0.12);
        }

        .filter-btn.active {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.18);
            color: #fff;
        }

        /* Nav Tabs */
        .nav-tab {
            padding: 8px 16px;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            color: #888;
            background: transparent;
        }

        .nav-tab:hover {
            color: #ccc;
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.12);
            color: #fff;
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table th {
            text-align: left;
            padding: 14px 20px;
            color: #6b7280;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            border-bottom: 1px solid var(--glass-border);
            white-space: nowrap;
        }

        .data-table td {
            padding: 14px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 14px;
            color: #e0e0e0;
            vertical-align: middle;
        }

        .data-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* Badges */
        .badge {
            padding: 4px 10px;
            border-radius: 30px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-new {
            background: rgba(16, 185, 129, 0.1);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .badge-junk {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .badge-contacted {
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .badge-click {
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .badge-click:hover {
            filter: brightness(1.3);
            transform: scale(1.05);
        }

        .badge-click:active {
            transform: scale(0.95);
        }

        /* Filter pills/badges count */
        .count-badge {
            font-size: 10px;
            font-weight: 800;
            padding: 1px 7px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.06);
            color: inherit;
            font-family: 'Space Grotesk', sans-serif;
            margin-left: 4px;
        }

        .gradient-text {
            background: linear-gradient(90deg, #E6397F, #FF8A00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .note-input {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid transparent;
            border-radius: 12px;
            color: #ccc;
            font-size: 12px;
            padding: 6px 10px;
            width: 100%;
            min-width: 140px;
            max-width: 220px;
            outline: none;
            transition: all 0.2s ease;
            font-family: 'Inter', sans-serif;
        }

        .note-input:hover {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .note-input:focus {
            border-color: rgba(230, 57, 127, 0.4);
            background: rgba(255, 255, 255, 0.06);
            color: #fff;
        }

        .note-input::placeholder {
            color: #555;
        }

        /* Stat cards (compact) */
        .stat-mini {
            text-align: center;
        }

        .stat-mini-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -0.03em;
            line-height: 1;
        }

        .stat-mini-label {
            font-size: 10px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            margin-top: 4px;
        }

        /* Calendar */
        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }

        .cal-day-label {
            font-size: 10px;
            color: #555;
            text-align: center;
            font-weight: 600;
            padding: 4px 0;
            text-transform: uppercase;
        }

        .cal-cell {
            aspect-ratio: 1;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #666;
            transition: all 0.2s ease;
            cursor: default;
            position: relative;
            border: 1px solid transparent;
        }

        .cal-cell.has-leads {
            color: #fff;
        }

        .cal-cell.today {
            border-color: rgba(230, 57, 127, 0.5);
        }

        .cal-cell .cal-count {
            font-size: 9px;
            font-weight: 700;
            font-family: 'Space Grotesk', sans-serif;
            margin-top: 1px;
        }

        .cal-cell:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .cal-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cal-nav button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s;
        }

        .cal-nav button:hover {
            color: #fff;
        }

        /* Chart containers */
        .chart-wrap {
            position: relative;
        }

        /* View sections */
        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }


        .blur-content {
            filter: blur(5px);
            pointer-events: none;
            user-select: none;
            opacity: 0.6;
        }

        .paywall-overlay {
            position: absolute;
            inset: 0;
            display: none;
            /* Hidden by default */
            align-items: center;
            justify-content: center;
            z-index: 50;
            background: rgba(5, 5, 10, 0.3);
            backdrop-filter: grayscale(100%);
        }

        .paywall-card {
            background: rgba(11, 10, 20, 0.95);
            border: 1px solid rgba(255, 50, 50, 0.2);
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            max-width: 320px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.9);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* AI Icon Gradient Shimmer */
        .ai-icon-gradient svg {
            stroke: url(#ai-grad) !important;
        }

        .ai-icon-gradient {
            position: relative;
        }

        .ai-icon-gradient::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(236, 72, 153, 0.1), rgba(168, 85, 247, 0.05));
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .ai-icon-gradient:hover::after {
            opacity: 1;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <!-- AUTH GATE -->
    <div id="auth-gate">
        <div class="text-center">
            <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png"
                class="h-8 mx-auto mb-6 brightness-125">
            <div class="gate-spinner mx-auto"></div>
            <p class="text-gray-500 text-xs mt-4">Verifying access...</p>
        </div>
    </div>

    <!-- NAV -->
    <nav class="border-b border-white/5 bg-black/20 backdrop-blur-md sticky top-0 z-40">
        <div class="w-full max-w-[95%] mx-auto h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png"
                    class="h-6 w-auto brightness-125" alt="Reputifly">
                <div class="h-5 w-px bg-white/10"></div>

                <div class="flex items-center gap-2 relative">
                    <button onclick="window.toggleTabsPopup()"
                        class="flex items-center gap-2 sm:gap-3 bg-[#0B0A14] hover:bg-[#1A1A24] border border-white/20 text-white text-xs sm:text-sm font-bold py-2 px-3 sm:py-2.5 sm:px-5 rounded-full shadow-lg transition group min-w-[130px] sm:min-w-[200px] justify-between relative">
                        <span id="current-tab-label" class="truncate">Select Data Source</span>
                        <!-- Global Red Dot (Hidden if current tab has new leads, handled in JS) -->
                        <div id="global-new-indicator"
                            class="hidden absolute top-0 right-0 -mt-1 -mr-1 w-3 h-3 bg-red-500 border-2 border-[#0B0A14] rounded-full animate-pulse">
                        </div>
                        <i data-feather="chevron-down"
                            class="w-4 h-4 text-gray-500 group-hover:text-purple-400 transition"></i>
                    </button>

                    <div id="tabs-popup"
                        class="hidden absolute top-full left-0 mt-3 w-72 bg-[#111018] border border-white/10 rounded-3xl shadow-[0_20px_50px_rgba(0,0,0,0.6)] backdrop-blur-xl z-50 overflow-hidden transform origin-top-left transition-all duration-200">

                        <div class="p-3 border-b border-white/5 bg-white/5 flex items-center justify-between">
                            <span class="text-[10px] uppercase font-bold text-gray-500 tracking-wider pl-2">Data
                                Sources</span>
                            <button onclick="window.promptNewTab()"
                                class="p-1.5 rounded-lg hover:bg-purple-500/20 text-purple-400 transition"
                                title="New Folder">
                                <i data-feather="plus" class="w-4 h-4"></i>
                            </button>
                        </div>

                        <div id="tabs-popup-list" class="max-h-[300px] overflow-y-auto p-2 space-y-1">
                        </div>
                    </div>
                </div>

                <div class="h-5 w-px bg-white/10 mx-3"></div>

                <div class="flex items-center gap-1.5">
                    <button id="tab-analytics" class="nav-tab" onclick="window.switchTab('analytics')">
                        <i data-feather="bar-chart-2" class="w-3.5 h-3.5 inline -mt-0.5 md:mr-1"></i><span
                            class="hidden sm:inline">Analytics</span>
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="hidden sm:flex items-center gap-2">
                    <div class="h-1.5 w-1.5 rounded-full bg-green-500 animate-pulse"></div>
                    <span id="nav-email" class="text-[11px] text-gray-500 font-mono"></span>
                </div>
                <button onclick="window.clientLogout()" class="btn-hero-glass text-xs py-1.5 px-4 rounded-full"
                    title="Sign Out">
                    <i data-feather="log-out" class="w-3.5 h-3.5"></i>
                    <span class="hidden sm:inline">Sign Out</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- CONTENT -->
    <main class="w-full max-w-[95%] mx-auto py-6 relative z-10">

        <!-- ==================== LEADS TAB ==================== -->
        <div id="view-leads" class="view-section active">

            <!-- HEADER -->
            <div class="flex flex-col gap-6 mb-6">
                <div class="flex items-center gap-3">
                    <div id="folder-icon-container"
                        class="w-10 h-10 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center flex-shrink-0">
                        <i data-feather="inbox" class="w-5 h-5 text-purple-400"></i>
                    </div>
                    <div class="min-w-0 flex-1">
                        <h1 id="current-tab-title" class="text-2xl font-bold text-white brand-font truncate">All Leads
                        </h1>
                        <div class="flex items-center gap-2 text-sm text-gray-500">
                            <span id="current-tab-desc" class="truncate max-w-[280px] sm:max-w-xl block">Master view of
                                all data sources</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FILTER BAR + TABLE -->
            <div class="glass-panel overflow-hidden flex flex-col relative">

                <div id="paywall-overlay" class="paywall-overlay">
                    <div class="paywall-card">
                        <div
                            class="mx-auto w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center mb-4 border border-red-500/20">
                            <i data-feather="lock" class="w-5 h-5 text-red-400"></i>
                        </div>
                        <h3 class="text-white font-bold text-lg mb-2">Account Paused</h3>
                        <p class="text-gray-400 text-xs mb-5 leading-relaxed">
                            Your lead access is temporarily suspended.<br>
                            You have <span class="text-white font-bold" id="hidden-lead-count">incoming</span> leads
                            waiting.
                        </p>
                        <div class="text-[10px] text-gray-600 font-mono bg-black/30 p-2 rounded">
                            STATUS: RESTRICTED
                        </div>
                    </div>
                </div>

                <div
                    class="px-6 py-4 border-b border-white/5 flex items-center justify-between gap-4 overflow-visible relative z-30 flex-wrap sm:flex-nowrap">

                    <div class="flex items-center gap-3 flex-shrink-0">
                        <button class="filter-btn gap-2" id="btn-add-filter" onclick="openFilterModal()">
                            <i data-feather="filter" class="w-3 h-3"></i> Filter
                        </button>

                        <div id="active-filter-pill"
                            class="hidden flex items-center gap-2 bg-purple-500/20 text-purple-300 px-3 py-1 rounded-full text-xs border border-purple-500/30 animate-fade-in whitespace-nowrap">
                            <span id="active-filter-text" class="font-medium max-w-[100px] truncate"></span>
                            <button onclick="clearCustomFilter()"
                                class="hover:text-white flex items-center justify-center p-0.5 rounded-full hover:bg-white/10 transition">
                                <i data-feather="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 flex-shrink-0">

                        <button id="btn-ai-insights" onclick="generateInsights()"
                            class="btn-hero-glass px-3 bg-white/5 hover:bg-white/10 border-white/10 text-gray-400 hover:text-white relative hidden ai-icon-gradient"
                            title="AI Insights">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <defs>
                                    <linearGradient id="ai-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" stop-color="#a855f7" />
                                        <stop offset="50%" stop-color="#ec4899" />
                                        <stop offset="100%" stop-color="#f97316" />
                                    </linearGradient>
                                </defs>
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" stroke="url(#ai-grad)" />
                            </svg>
                        </button>

                        <div class="relative">
                            <button id="btn-archive-toggle" onclick="window.toggleArchiveMode()"
                                class="btn-hero-glass px-3 bg-white/5 hover:bg-white/10 border-white/10 text-gray-400 hover:text-white relative"
                                title="View Archive">
                                <i data-feather="archive" class="w-4 h-4"></i>
                                <div id="archive-indicator"
                                    class="hidden absolute top-2 right-2 w-1.5 h-1.5 bg-red-500 rounded-full ring-2 ring-[#111018]">
                                </div>
                            </button>
                        </div>

                        <div class="relative">
                            <button onclick="document.getElementById('settings-dropdown').classList.toggle('hidden')"
                                class="btn-hero-glass px-3 bg-white/5 hover:bg-white/10 border-white/10 text-gray-400 hover:text-white"
                                title="Data Settings">
                                <i data-feather="settings" class="w-4 h-4"></i>
                            </button>


                            <div id="settings-dropdown"
                                class="hidden absolute right-0 top-full mt-2 w-48 bg-[#111018] border border-white/10 rounded-2xl shadow-[0_10px_40px_rgba(0,0,0,0.8)] backdrop-blur-xl z-50 overflow-hidden py-1">
                                <button
                                    onclick="window.exportCSV(); document.getElementById('settings-dropdown').classList.add('hidden')"
                                    class="w-full text-left px-4 py-2.5 text-xs font-medium text-gray-300 hover:text-white hover:bg-white/5 flex items-center gap-2 transition">
                                    <i data-feather="download" class="w-3.5 h-3.5"></i> Export CSV
                                </button>
                                <button
                                    onclick="window.openImportModal(); document.getElementById('settings-dropdown').classList.add('hidden')"
                                    class="w-full text-left px-4 py-2.5 text-xs font-medium text-gray-300 hover:text-white hover:bg-white/5 flex items-center gap-2 transition">
                                    <i data-feather="upload" class="w-3.5 h-3.5"></i> Import CSV
                                </button>
                                <div class="h-px bg-white/10 my-1 mx-2"></div>
                                <button
                                    onclick="window.clearCurrentTab(); document.getElementById('settings-dropdown').classList.add('hidden')"
                                    class="w-full text-left px-4 py-2.5 text-xs font-medium text-red-400 hover:text-red-300 hover:bg-red-500/10 flex items-center gap-2 transition">
                                    <i data-feather="trash-2" class="w-3.5 h-3.5"></i> Clear Current Tab
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW DAILY CAP PROGRESS (Minimalistic) -->
                <div id="daily-cap-container"
                    class="px-5 py-2 border-b border-white/5 bg-white/0 flex items-center gap-3 text-xs">
                    <div class="flex flex-col sm:flex-row sm:items-center gap-1">
                        <span class="text-gray-400 font-medium whitespace-nowrap">Emails Sent Today</span>
                        <span class="text-[10px] text-gray-600 whitespace-nowrap">(Includes Auto-Replies)</span>
                    </div>
                    <div class="flex-grow h-1.5 bg-white/5 rounded-full overflow-hidden relative mx-2">
                        <div id="usage-progress-bar" class="h-full bg-purple-500 transition-all duration-500 relative"
                            style="width: 0%">
                        </div>
                    </div>
                    <div class="text-[10px] font-mono text-gray-400 whitespace-nowrap">
                        <span id="stat-usage-current" class="text-white font-bold">0</span> / <span
                            id="stat-usage-limit">...</span>
                    </div>
                </div>
                <div class="overflow-x-auto flex-grow min-h-[500px]">
                    <table class="data-table">
                        <thead id="leads-table-head"></thead>
                        <tbody id="leads-table-body">
                            <tr>
                                <td colspan="5" class="text-center py-20 text-gray-500">Loading your leads...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- LOAD MORE BUTTON -->
                <div class="mt-8 mb-12 text-center border-t border-white/5 pt-6">
                    <button id="btn-load-more" onclick="window.loadMoreLeads()"
                        class="group relative inline-flex items-center gap-2 px-6 py-2.5 bg-[#1A1A24] hover:bg-[#252532] border border-white/10 hover:border-white/20 text-gray-400 hover:text-white text-xs font-bold rounded-full transition-all shadow-lg hover:shadow-purple-500/10 hidden transform active:scale-95">
                        <span>Load Older Leads</span>
                        <i data-feather="arrow-down-circle"
                            class="w-4 h-4 text-gray-500 group-hover:text-purple-400 transition-colors"></i>
                    </button>

                    <div id="leads-end-msg" class="hidden flex flex-col items-center gap-2 mt-2 opacity-50">
                        <div class="w-1 h-1 rounded-full bg-gray-700"></div>
                        <span class="text-[10px] text-gray-500 font-mono uppercase tracking-widest">End of
                            History</span>
                    </div>
                </div>
            </div>

            <!-- FILTER MODAL (New Polish) -->
            <div id="filter-modal"
                class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
                <!-- Modal Content -->
                <div class="glass-panel w-full max-w-sm mx-4 overflow-hidden shadow-2xl transform transition-all scale-100"
                    id="filter-modal-content">

                    <!-- Header -->
                    <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between bg-white/5">
                        <h3 class="text-white font-bold brand-font text-lg" id="filter-modal-title">Filter Leads
                        </h3>
                        <button onclick="closeFilterModal()" class="text-gray-400 hover:text-white transition">
                            <i data-feather="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Step 1: Select Field -->
                    <div id="filter-step-fields" class="p-2 max-h-[60vh] overflow-y-auto">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Step 2: Select Value -->
                    <div id="filter-step-values" class="hidden p-2 max-h-[60vh] overflow-y-auto">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Footer (Back button for Step 2) -->
                    <div id="filter-modal-footer" class="hidden border-t border-white/10 p-3 bg-white/5">
                        <button onclick="backToFilterFields()"
                            class="text-xs text-gray-400 hover:text-white flex items-center gap-1">
                            <i data-feather="arrow-left" class="w-3 h-3"></i> Back to Fields
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- ==================== ANALYTICS TAB ==================== -->
        <div id="view-analytics" class="view-section">

            <!-- KPI Row -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="glass-panel p-5 text-center">
                    <div class="stat-mini-value text-white" id="kpi-total">0</div>
                    <div class="stat-mini-label">Total Leads</div>
                </div>
                <div class="glass-panel p-5 text-center">
                    <div class="stat-mini-value text-emerald-400" id="kpi-this-month">0</div>
                    <div class="stat-mini-label">This Month</div>
                </div>
                <div class="glass-panel p-5 text-center">
                    <div class="stat-mini-value text-blue-400" id="kpi-conversion">0%</div>
                    <div class="stat-mini-label">Contacted Rate</div>
                </div>
                <div class="glass-panel p-5 text-center">
                    <div class="stat-mini-value text-orange-400" id="kpi-response-time">â€”</div>
                    <div class="stat-mini-label">Avg Response</div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                <!-- Lead Volume Chart (2/3) -->
                <div class="glass-panel p-5 lg:col-span-2">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-bold text-gray-300 uppercase tracking-wider">Lead Volume</h3>
                        <div class="flex gap-1">
                            <button onclick="window.setChartRange('7d')" id="btn-7d"
                                class="filter-pill text-[10px] py-1 px-3 active">7D</button>
                            <button onclick="window.setChartRange('30d')" id="btn-30d"
                                class="filter-pill text-[10px] py-1 px-3">30D</button>
                            <button onclick="window.setChartRange('90d')" id="btn-90d"
                                class="filter-pill text-[10px] py-1 px-3">90D</button>
                        </div>
                    </div>
                    <div class="chart-wrap" style="height: 220px;">
                        <canvas id="chart-volume"></canvas>
                    </div>
                </div>
                <!-- Status Breakdown Donut (1/3) -->
                <div class="glass-panel p-5">
                    <h3 class="text-sm font-bold text-gray-300 uppercase tracking-wider mb-4">Status Breakdown</h3>
                    <div class="chart-wrap flex items-center justify-center" style="height: 220px;">
                        <canvas id="chart-status"></canvas>
                    </div>
                </div>
            </div>

            <!-- Source Breakdown (REMOVED) -->

            <!-- Detailed Analytics Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- Top Sources (Progress Bars) -->
                <div class="glass-panel p-5">
                    <h3 class="text-sm font-bold text-gray-300 uppercase tracking-wider mb-4">Top Data Sources</h3>
                    <div id="analytics-sources" class="space-y-4">
                        <!-- Dynamic Content -->
                    </div>
                </div>

                <!-- Anomalies (Top 3 Spikes) -->
                <div class="glass-panel p-5">
                    <div class="flex items-center gap-2 mb-4">
                        <i data-feather="activity" class="w-4 h-4 text-purple-400"></i>
                        <h3 class="text-sm font-bold text-gray-300 uppercase tracking-wider">Volume Spikes</h3>
                    </div>
                    <div id="analytics-anomalies" class="space-y-3">
                        <!-- Dynamic Content -->
                    </div>
                </div>
            </div>

            <!-- Calendar -->
            <div class="glass-panel p-5">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-sm font-bold text-gray-300 uppercase tracking-wider">Lead Calendar</h3>
                    <div class="cal-nav">
                        <button onclick="window.calPrev()"><i data-feather="chevron-left" class="w-4 h-4"></i></button>
                        <span id="cal-month-label"
                            class="text-sm font-semibold text-gray-300 brand-font min-w-[120px] text-center"></span>
                        <button onclick="window.calNext()"><i data-feather="chevron-right" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <div class="cal-grid mb-1">
                    <div class="cal-day-label">Sun</div>
                    <div class="cal-day-label">Mon</div>
                    <div class="cal-day-label">Tue</div>
                    <div class="cal-day-label">Wed</div>
                    <div class="cal-day-label">Thu</div>
                    <div class="cal-day-label">Fri</div>
                    <div class="cal-day-label">Sat</div>
                </div>
                <div id="cal-body" class="cal-grid"></div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="text-center mt-8 pb-6">
            <p class="text-[11px] text-gray-600">Securely processed by <span
                    class="gradient-text font-bold">Reputifly</span></p>
        </div>
    </main>
    <div id="confirmModal"
        class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity"
        onclick="closeConfirmModal(event)">
        <div class="bg-[#111018] rounded-3xl max-w-sm w-full mx-4 border border-white/10 shadow-[0_20px_50px_rgba(0,0,0,0.5)] p-6 transform transition-all"
            onclick="event.stopPropagation()">
            <div class="text-center">
                <div
                    class="w-16 h-16 rounded-full bg-yellow-500/10 border border-yellow-500/20 flex items-center justify-center mx-auto mb-4 shadow-[0_0_20px_rgba(234,179,8,0.2)]">
                    <i data-feather="star" class="w-8 h-8 text-yellow-400 fill-current"></i>
                </div>
                <h3 id="confirmTitle" class="text-xl font-bold text-white mb-2 font-['Space_Grotesk']">Send Review
                    Request?</h3>
                <p id="confirmMessage" class="text-sm text-gray-400 mb-6 leading-relaxed">Are you sure?</p>
                <div class="flex gap-3">
                    <button id="confirmCancelBtn"
                        class="flex-1 py-3 px-4 bg-white/5 hover:bg-white/10 text-white text-sm font-bold rounded-full transition border border-white/5">Cancel</button>
                    <button id="confirmProceedBtn"
                        class="flex-1 py-3 px-4 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-400 hover:to-orange-400 text-white text-sm font-bold rounded-full shadow-lg transition transform hover:-translate-y-0.5">Send
                        Request</button>
                </div>
            </div>
        </div>
    </div>
    <div id="feedbackModal"
        class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity"
        onclick="closeFeedbackModal(event)">
        <div class="bg-[#111018] rounded-3xl max-w-md w-full mx-4 border border-red-500/20 shadow-[0_20px_50px_rgba(239,68,68,0.15)] p-6 transform transition-all"
            onclick="event.stopPropagation()">
            <div class="flex items-center gap-3 mb-4 pb-4 border-b border-white/5">
                <div
                    class="w-10 h-10 rounded-full bg-red-500/10 border border-red-500/20 flex items-center justify-center">
                    <i data-feather="alert-triangle" class="w-5 h-5 text-red-400"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white font-['Space_Grotesk']">Private Feedback</h3>
                    <p class="text-xs text-gray-500" id="feedbackDate">Submitted recently</p>
                </div>
            </div>
            <div class="bg-black/30 rounded-2xl p-4 border border-white/5 mb-6">
                <p id="feedbackContent" class="text-sm text-gray-300 leading-relaxed italic">"..."</p>
            </div>
            <button onclick="closeFeedbackModal()"
                class="w-full py-3 bg-white/5 hover:bg-white/10 text-white text-sm font-bold rounded-full transition border border-white/5">Close</button>
        </div>
    </div>
    <div id="create-folder-modal"
        class="fixed inset-0 z-[10000] hidden items-center justify-center bg-black/90 backdrop-blur-md transition-opacity"
        onclick="if(event.target === this) window.closeCreateFolderModal()">

        <div
            class="glass-panel w-full max-w-[340px] mx-6 p-1 transform transition-all scale-100 shadow-2xl rounded-3xl overflow-hidden relative">
            <div
                class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-purple-500/10 to-blue-500/10 pointer-events-none">
            </div>

            <div class="bg-[#0B0A14]/90 backdrop-blur-xl p-6 rounded-[20px] relative z-10">
                <div class="text-center mb-6">
                    <div
                        class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-purple-500/20 to-blue-500/20 border border-white/10 flex items-center justify-center mx-auto mb-3 shadow-[0_0_15px_rgba(168,85,247,0.15)]">
                        <i data-feather="folder-plus" class="w-6 h-6 text-purple-300"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white font-['Space_Grotesk']">New Folder</h3>
                    <p class="text-xs text-gray-500 mt-1">Organize your leads</p>
                </div>

                <div class="space-y-4">
                    <div class="relative group">
                        <input type="text" id="create-folder-input"
                            class="w-full bg-white/5 border border-white/10 rounded-2xl px-4 py-3 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-purple-500/50 focus:bg-white/10 transition-all text-center group-hover:border-white/20"
                            placeholder="e.g. VIP Clients" autocomplete="off"
                            onkeyup="if(event.key === 'Enter') window.confirmCreateFolder()">
                    </div>

                    <div class="grid grid-cols-2 gap-3 mt-2">
                        <button onclick="window.closeCreateFolderModal()"
                            class="py-3 bg-white/5 hover:bg-white/10 border border-white/5 text-gray-400 hover:text-white text-xs font-bold rounded-full transition-all">
                            Cancel
                        </button>
                        <button onclick="window.confirmCreateFolder()"
                            class="py-3 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white text-xs font-bold rounded-full shadow-lg shadow-purple-900/20 transition-all transform active:scale-95">
                            Create
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- IMPORT MODAL -->
    <div id="import-modal"
        class="fixed inset-0 z-[9999] hidden flex items-center justify-center bg-black/90 backdrop-blur-md transition-opacity">

        <div class="glass-panel w-full max-w-[420px] mx-6 p-1 transform transition-all scale-100 shadow-2xl rounded-3xl overflow-hidden relative"
            id="import-modal-content">

            <div
                class="absolute top-0 right-0 w-full h-full bg-gradient-to-bl from-purple-500/5 to-blue-500/5 pointer-events-none">
            </div>

            <div class="bg-[#0B0A14]/95 backdrop-blur-xl p-8 rounded-[20px] relative z-10">

                <button onclick="window.closeImportModal()"
                    class="absolute top-4 right-4 p-2 rounded-full hover:bg-white/5 text-gray-500 hover:text-white transition-colors">
                    <i data-feather="x" class="w-4 h-4"></i>
                </button>

                <div class="text-center mb-8">
                    <div
                        class="w-14 h-14 rounded-2xl bg-gradient-to-tr from-emerald-500/20 to-teal-500/20 border border-white/10 flex items-center justify-center mx-auto mb-4 shadow-[0_0_20px_rgba(16,185,129,0.15)]">
                        <i data-feather="upload-cloud" class="w-6 h-6 text-emerald-400"></i>
                    </div>
                    <h2 class="text-xl font-bold brand-font text-white">Import Data</h2>
                    <p class="text-xs text-gray-500 mt-1">Supports CSV files (Max 500 rows)</p>
                </div>

                <div class="group relative border border-dashed border-white/10 bg-white/5 rounded-2xl p-8 text-center hover:border-emerald-500/30 hover:bg-white/10 transition-all cursor-pointer overflow-hidden"
                    onclick="document.getElementById('csv-file').click()">

                    <div id="upload-placeholder" class="space-y-3">
                        <div
                            class="mx-auto w-10 h-10 rounded-full bg-[#111018] border border-white/10 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i data-feather="plus" class="w-5 h-5 text-gray-400 group-hover:text-emerald-400"></i>
                        </div>
                        <div class="space-y-1">
                            <p class="text-sm text-gray-200 font-semibold">Tap to Upload CSV</p>
                            <p class="text-[10px] text-gray-500 uppercase tracking-wider">or drag and drop</p>
                        </div>
                    </div>

                    <div id="upload-preview" class="hidden space-y-3">
                        <div
                            class="mx-auto w-10 h-10 rounded-full bg-emerald-500/10 border border-emerald-500/20 flex items-center justify-center">
                            <i data-feather="check" class="w-5 h-5 text-emerald-400"></i>
                        </div>
                        <div>
                            <p id="file-name" class="text-sm text-white font-medium truncate px-4">filename.csv</p>
                            <p id="row-count" class="text-xs text-emerald-400 mt-1 font-mono">0 rows ready</p>
                        </div>
                    </div>

                    <input type="file" id="csv-file" class="hidden" accept=".csv" multiple
                        onchange="window.handleFileSelect(this)">
                </div>

                <div class="mt-8">
                    <button id="btn-process-import"
                        class="w-full py-3.5 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white text-sm font-bold rounded-full shadow-lg shadow-emerald-900/20 transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center gap-2"
                        onclick="window.processImport()" disabled>
                        <span>Start Import</span>
                        <i data-feather="arrow-right" class="w-4 h-4"></i>
                    </button>
                    <p id="import-msg" class="text-xs text-center mt-3 hidden"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- STATUS MODAL -->
    <div id="status-modal"
        class="fixed inset-0 z-[9999] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity"
        onclick="if(event.target === this) window.closeStatusModal()">

        <div
            class="glass-panel w-full max-w-sm mx-4 p-1 transform transition-all scale-100 shadow-2xl rounded-3xl overflow-hidden relative">
            <div
                class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-purple-500/10 to-blue-500/10 pointer-events-none">
            </div>

            <div class="bg-[#0B0A14]/90 backdrop-blur-xl p-6 rounded-[20px] relative z-10">
                <div class="text-center mb-6">
                    <div
                        class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-purple-500/20 to-blue-500/20 border border-white/10 flex items-center justify-center mx-auto mb-3 shadow-[0_0_15px_rgba(168,85,247,0.15)]">
                        <i data-feather="tag" class="w-6 h-6 text-purple-300"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white font-['Space_Grotesk']">Update Status</h3>
                    <p class="text-xs text-gray-500 mt-1">Select a new status for this lead</p>
                </div>

                <div class="space-y-2" id="status-options-container">
                    <!-- Options injected by JS -->
                </div>

                <button onclick="window.closeStatusModal()"
                    class="mt-4 w-full py-3 bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white text-xs font-bold rounded-full transition border border-white/5">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        import { getFirestore, collection, onSnapshot, query, orderBy, where, doc, updateDoc, deleteDoc, Timestamp, addDoc, limit, startAfter, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC9eUHEdAmV9qzHxpQe2en5WeOeRXiq10A",
            authDomain: "b2b-software.firebaseapp.com",
            projectId: "b2b-software",
            storageBucket: "b2b-software.firebasestorage.app",
            messagingSenderId: "231187362713",
            appId: "1:231187362713:web:07f2f24b3c79557f7a9908"
        };

        const app = initializeApp(firebaseConfig);
        const authInstance = getAuth(app);
        const db = getFirestore(app);

        const SUPER_ADMIN_EMAIL = "realjuliantung@gmail.com";
        const API_BASE = "https://asia-southeast1-b2b-software.cloudfunctions.net";
        let clientEmail = null;
        let clientLeads = [];
        let clientTabs = ['General']; // Import Folders
        let clientStats = { totalLeads: 0, unreadCount: 0, sources: {} }; // New: Scalable Stats
        let lastVisibleLead = null; // New: For Pagination
        let leadsUnsubscribe = null; // New: To manage listeners
        let formAliases = {}; // New: Store custom names for forms
        let activeTab = null; // Current "Folder" or "Form Signature"
        let activeFilter = 'all'; // all, new, contacted, junk, archived
        let customFilter = null; // { field: 'city', value: 'Singapore' }
        let sortOrder = 'desc'; // desc or asc
        let reviewFeatureEnabled = false; // Added Review State
        let volumeChart = null;
        let statusChart = null;
        let chartRange = '7d';
        let calDate = new Date(); // Analytics calendar

        // CSV Import State
        let activeSource = 'api'; // 'api' or 'imported'
        let csvData = [];

        // ==========================================
        // AUTH GATE
        // ==========================================
        onAuthStateChanged(authInstance, (user) => {
            const gate = document.getElementById('auth-gate');
            if (!user) { window.location.href = 'index.html'; return; }
            if (user.email === SUPER_ADMIN_EMAIL) { window.location.href = 'dashboard.html'; return; }

            clientEmail = user.email;
            gate.style.display = 'none';
            document.getElementById('nav-email').textContent = clientEmail;

            // Name setting removed (now handled by Tab Title logic)

            subscribeToLeads();
            startClientStatusListener(user.uid); // <--- Listen for Pause Status
            feather.replace();
        });
        // ==========================================
        // RENAME & DELETE LOGIC (MISSING FUNCTIONS)
        // ==========================================

        // 1. Rename Web Forms (Aliases)
        // 1. Rename Web Forms (Aliases)
        window.renameForm = async (signature) => {
            // FIX: Use new helper to get current name (e.g. "Form 1")
            const currentName = getFormDisplayName(signature);

            const newName = await window.customPrompt("Rename Data Source", currentName);
            if (!newName || newName === currentName) return;

            try {
                const user = authInstance.currentUser;
                if (!user) return;

                // Update Firestore (Uses dot notation to update specific Map key)
                await updateDoc(doc(db, "clients", user.uid), {
                    [`formAliases.${signature}`]: newName
                });

            } catch (e) {
                console.error(e);
                alert("Error renaming form: " + e.message);
            }
        };

        // 2. Rename Custom Folders
        window.renameFolder = async (oldName) => {
            const newName = await window.customPrompt("Rename Folder", oldName);
            if (!newName || newName === oldName) return;

            if (clientTabs.includes(newName)) {
                alert("A folder with this name already exists.");
                return;
            }

            try {
                const user = authInstance.currentUser;
                if (!user) return;

                // A. Update the Tabs List in Client Settings
                const newTabsList = clientTabs.map(t => t === oldName ? newName : t);

                await updateDoc(doc(db, "clients", user.uid), {
                    tabs: newTabsList
                });

                // B. Batch Update: Move all leads from Old Name to New Name
                const q = query(collection(db, "leads"), where("clientId", "==", clientEmail), where("tabName", "==", oldName));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(docSnap => {
                        batch.update(docSnap.ref, { tabName: newName });
                    });
                    await batch.commit();
                }

                // If we were looking at the old folder, switch to the new one
                if (activeTab === oldName) {
                    window.switchTab(newName);
                }

            } catch (e) {
                console.error(e);
                alert("Error renaming folder: " + e.message);
            }
        };

        // 3. Delete Custom Folders
        window.deleteFolder = async (folderName) => {
            const confirmed = await window.customConfirm(
                `Delete folder "<b>${folderName}</b>"?<br>The leads inside will NOT be deleted, but they will be hidden from this view.`,
                "Delete Folder"
            );

            if (!confirmed) return;

            try {
                const user = authInstance.currentUser;
                if (!user) return;

                // Remove from tabs array
                const newTabsList = clientTabs.filter(t => t !== folderName);

                await updateDoc(doc(db, "clients", user.uid), {
                    tabs: newTabsList
                });

                // If we were looking at this folder, go back to General or first available
                if (activeTab === folderName) {
                    window.switchTab('General'); // Or your default view
                }

            } catch (e) {
                console.error(e);
                alert("Error deleting folder: " + e.message);
            }
        };

        // ==========================================
        // TAB SWITCHING
        // ==========================================
        // ==========================================
        // TAB SWITCHING (Updated for Form 1, Form 2...)
        // ==========================================
        window.switchTab = (tabName) => {
            // 1. Analytics View Switch
            if (tabName === 'analytics') {
                document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
                const analyticsView = document.getElementById('view-analytics');
                if (analyticsView) analyticsView.classList.add('active');
                const analyticsTab = document.getElementById('tab-analytics');
                if (analyticsTab) analyticsTab.classList.add('active');
                if (typeof renderAnalytics === 'function') renderAnalytics();
                return;
            }

            // 2. Data View Switch
            activeTab = tabName;

            // Reset Arrays/UI
            clientLeads = [];
            document.getElementById('leads-table-body').innerHTML = `<tr><td colspan="5" class="text-center py-20 text-gray-500">Loading ${getFormDisplayName(tabName)}...</td></tr>`;

            subscribeToLeads(); // Fetch new data

            // UI Updates
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            const leadsView = document.getElementById('view-leads');
            if (leadsView) leadsView.classList.add('active');

            const analyticsTab = document.getElementById('tab-analytics');
            if (analyticsTab) analyticsTab.classList.remove('active');

            // --- UPDATE HEADINGS ---
            const titleEl = document.getElementById('current-tab-title');
            const descEl = document.getElementById('current-tab-desc');
            const folderIcon = document.getElementById('folder-icon-container');
            const labelEl = document.getElementById('current-tab-label');

            let displayText = "Loading...";

            if (clientTabs.includes(tabName)) {
                // Custom Folder
                displayText = tabName;
                if (titleEl) titleEl.textContent = tabName;
                if (descEl) descEl.textContent = 'Imported Lead Batch';
                if (folderIcon) folderIcon.innerHTML = '<i data-feather="folder" class="w-5 h-5 text-blue-400"></i>';
            }
            else {
                // Form Signature
                const name = getFormDisplayName(tabName); // Uses the new helper
                displayText = name;
                if (titleEl) titleEl.textContent = name;

                // Show fields in description so they know which form it is
                const fields = tabName.split(',').join(', ');
                if (descEl) descEl.textContent = 'Fields: ' + fields;

                if (folderIcon) folderIcon.innerHTML = '<i data-feather="layout" class="w-5 h-5 text-purple-400"></i>';
            }

            // Update Popup Button Text
            if (labelEl) labelEl.textContent = displayText;

            if (activeFilter === 'archived' && typeof window.toggleArchiveMode === 'function') window.toggleArchiveMode();

            if (typeof renderTabsUI === 'function') renderTabsUI();
            if (window.feather) feather.replace();
        };

        // ==========================================
        // LOGOUT
        // ==========================================
        window.clientLogout = () => {
            signOut(authInstance).then(() => window.location.href = 'index.html');
        };

        // ==========================================
        // CLIENT STATUS LISTENER (Pause/Access Control)
        // ==========================================
        function startClientStatusListener(uid) {
            const userDocRef = doc(db, 'clients', uid);
            onSnapshot(userDocRef, (docSnap) => {
                const container = document.getElementById('daily-cap-container');
                const overlay = document.getElementById('paywall-overlay');
                const content = document.querySelector('.data-table');

                if (docSnap.exists()) {
                    const data = docSnap.data();

                    // 0. LOAD STATS (Scalability)
                    if (data.stats) {
                        clientStats = data.stats;
                    }

                    // AI INSIGHTS TOGGLE
                    const aiBtn = document.getElementById('btn-ai-insights');
                    if (aiBtn) {
                        if (data.aiInsightsEnabled) {
                            aiBtn.classList.remove('hidden');
                        } else {
                            aiBtn.classList.add('hidden');
                        }
                    }

                    // 1. TABS CONFIG
                    if (data.tabs && Array.isArray(data.tabs)) {
                        clientTabs = ['General', ...data.tabs.filter(t => t !== 'General')];
                    }
                    if (data.formAliases) {
                        formAliases = data.formAliases;
                    }
                    renderTabsUI(); // Now uses clientStats + aliases

                    // 2. PAUSE CHECK
                    if (data.status === 'paused') {
                        if (overlay) overlay.style.display = 'flex';
                        document.body.style.overflow = 'hidden';
                        if (content) content.classList.add('blur-content');
                        if (document.getElementById('hidden-lead-count')) {
                            document.getElementById('hidden-lead-count').textContent = clientStats.totalLeads || 0;
                        }
                    } else {
                        if (overlay) overlay.style.display = 'none';
                        document.body.style.overflow = 'auto';
                        if (content) content.classList.remove('blur-content');
                    }

                    // 3. USAGE STATS
                    const today = new Date().toLocaleDateString("en-CA", { timeZone: "Asia/Singapore" });
                    let used = 0;
                    if (data.usageStats && data.usageStats.date === today) {
                        used = data.usageStats.count || 0;
                    }

                    const limit = data.customDailyLimit || 50;

                    // 4. REVIEW FEATURE
                    reviewFeatureEnabled = !!data.reviewFeatureEnabled;
                    if (typeof renderTable === 'function') renderTable();

                    // Update UI
                    const currentEl = document.getElementById('stat-usage-current');
                    const limitEl = document.getElementById('stat-usage-limit');
                    const bar = document.getElementById('usage-progress-bar');

                    if (currentEl) currentEl.textContent = used;
                    if (limitEl) limitEl.textContent = limit;

                    if (bar) {
                        const pct = Math.min((used / limit) * 100, 100);
                        bar.style.width = `${pct}%`;
                        if (pct >= 100) bar.className = "h-full bg-red-500 transition-all duration-500 relative";
                        else if (pct >= 80) bar.className = "h-full bg-orange-500 transition-all duration-500 relative";
                        else bar.className = "h-full bg-purple-500 transition-all duration-500 relative";
                    }

                    if (container) container.classList.remove('hidden');

                } else {
                    console.warn("Client doc not found");
                }
            }, (error) => {
                console.error("Error listening to client status:", error);
            });
        }

        // ==========================================
        // LEADS LISTENER
        // ==========================================
        // ==========================================
        // SCALABLE LEADS LISTENER (Pagination)
        // ==========================================
        // ==========================================
        // SCALABLE LEADS LISTENER (Fixed: Client-Side Filtering)
        // ==========================================
        function subscribeToLeads(append = false) {
            if (leadsUnsubscribe && !append) {
                leadsUnsubscribe();
                leadsUnsubscribe = null;
            }

            // Reset if not appending (refreshing view)
            if (!append) {
                clientLeads = [];
                lastVisibleLead = null;
                if (typeof renderTable === 'function') renderTable();
            }

            // 1. BASE QUERY: Fetch ALL leads for this client (ordered by date)
            // We removed the 'where("source"...)' clause because it hides untagged leads.
            let q = query(
                collection(db, "leads"),
                where("clientId", "==", clientEmail),
                orderBy("createdAt", "desc"),
                limit(50) // Increased limit slightly to ensure we catch the right ones
            );

            // 2. Status Filter (Keep this, it's reliable)
            if (activeFilter !== 'all') {
                q = query(q, where("status", "==", activeFilter));
            }

            // 3. Pagination
            if (append && lastVisibleLead) {
                q = query(q, startAfter(lastVisibleLead));
            }

            const unsubscribe = onSnapshot(q, (snapshot) => {
                if (!append) {
                    clientLeads = [];
                }

                if (!snapshot.empty) {
                    lastVisibleLead = snapshot.docs[snapshot.docs.length - 1];
                }

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();

                    // --- ROBUST FILTERING FIX ---
                    // Instead of trusting the DB query, we calculate the signature right here.
                    let shouldInclude = true;

                    if (activeTab && activeTab !== 'analytics' && activeTab !== 'all_leads') {
                        if (clientTabs.includes(activeTab)) {
                            // Case A: Custom Folder (Check 'tabName' field)
                            if (data.tabName !== activeTab) shouldInclude = false;
                        } else {
                            // Case B: Web Form (Check calculated signature)
                            const signature = getFormSignature(data.lead); // Calculate signature on the fly
                            if (signature !== activeTab) shouldInclude = false;
                        }
                    }

                    if (shouldInclude) {
                        const existingIdx = clientLeads.findIndex(l => l.id === docSnap.id);
                        if (existingIdx !== -1) {
                            clientLeads[existingIdx] = { id: docSnap.id, ...data };
                        } else {
                            clientLeads.push({ id: docSnap.id, ...data });
                        }
                    }
                });

                // Sort in Memory (Newest First) to ensure correct order after filtering
                clientLeads.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                if (typeof renderTable === 'function') renderTable();

            }, (error) => {
                console.error("Error listening to leads:", error);
                // Error handling...
            });

            if (!append) leadsUnsubscribe = unsubscribe;
        }

        // Exposed for Load More Button
        window.loadMoreLeads = () => {
            subscribeToLeads(true);
        };

        // ==========================================
        // COUNTS (Reduced logic for simplified UI)
        // ==========================================
        // ==========================================
        // COUNTS (Reduced logic for simplified UI)
        // ==========================================
        function updateCounts() {
            // SAFE UPDATE: Check if element exists before setting text
            const lastActiveEl = document.getElementById('stat-last-active');
            if (lastActiveEl) {
                if (clientLeads.length > 0 && clientLeads[0].createdAt) {
                    const d = new Date(clientLeads[0].createdAt.seconds * 1000);
                    lastActiveEl.textContent = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) + ', ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                } else {
                    lastActiveEl.textContent = 'â€”';
                }
            }
        }

        // --- FILTER LOGIC ---
        function setFilter(status) {
            activeFilter = status;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            // Keep the custom filter active visually if distinct
            if (['all', 'new', 'contacted', 'junk', 'archived'].includes(status)) {
                document.getElementById(`btn-${status}`).classList.add('active');
            }
            subscribeToLeads(); // Fetch new data for this filter
        }

        function getFilteredLeads() {
            let filtered = clientLeads;

            // 1. TABS LOGIC MOVED TO QUERY
            // 2. ARCHIVE STATUS MOVED TO QUERY



            // 3. CUSTOM FIELD FILTER (Popups)
            if (customFilter) {
                filtered = filtered.filter(l => {
                    const val = l.lead && l.lead[customFilter.field];
                    return String(val) === String(customFilter.value);
                });
            }

            // 4. SORTING
            filtered.sort((a, b) => {
                const dateA = a.createdAt ? a.createdAt.seconds : 0;
                const dateB = b.createdAt ? b.createdAt.seconds : 0;
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });

            return filtered;
        }
        // ==========================================
        // TABLE
        // ==========================================
        function renderTable() {
            const thead = document.getElementById('leads-table-head');
            const tbody = document.getElementById('leads-table-body');
            const loadMoreBtn = document.getElementById('btn-load-more');
            const leadsEndMsg = document.getElementById('leads-end-msg');

            thead.innerHTML = ''; tbody.innerHTML = '';

            const filtered = getFilteredLeads();

            if (filtered.length === 0) {
                const msg = activeFilter === 'all' ? "When your forms start generating leads, they'll appear here." : "No archived leads found.";
                tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state"><div class="empty-icon"><i data-feather="inbox" class="w-6 h-6 text-gray-600"></i></div><h3 class="text-base font-bold text-gray-400 brand-font mb-1">No Leads Found</h3><p class="text-sm text-gray-500 max-w-xs mx-auto">${msg}</p></div></td></tr>`;
                loadMoreBtn.classList.add('hidden');
                leadsEndMsg.classList.remove('hidden'); // Show "No more leads"
                feather.replace(); return;
            }

            // Dynamic Columns (Based on FILTERED data only)
            let columns = new Set();
            // FIX: Use 'filtered' instead of 'clientLeads' to ensure columns match the current tab
            filtered.forEach(lead => { if (lead.lead) Object.keys(lead.lead).forEach(k => columns.add(k)); });
            let colArray = Array.from(columns);
            const priority = ['name', 'email', 'phone'];
            colArray.sort((a, b) => {
                const aP = priority.indexOf(a.toLowerCase()), bP = priority.indexOf(b.toLowerCase());
                if (aP !== -1 && bP !== -1) return aP - bP;
                if (aP !== -1) return -1; if (bP !== -1) return 1;
                return a.localeCompare(b);
            });

            const arrow = sortOrder === 'desc' ? '<i data-feather="arrow-down" class="w-3 h-3 ml-1 inline text-gray-400"></i>' : '<i data-feather="arrow-up" class="w-3 h-3 ml-1 inline text-gray-400"></i>';
            let headerHTML = `<tr><th onclick="window.toggleSort()" class="cursor-pointer hover:text-white transition select-none flex items-center gap-1 group w-32">Date ${arrow}</th>`;
            colArray.forEach(col => { headerHTML += `<th>${col.charAt(0).toUpperCase() + col.slice(1)}</th>`; });
            headerHTML += `<th>Notes</th><th class="text-center w-32">Status</th></tr>`; // Renamed Actions to Status
            thead.innerHTML = headerHTML;

            filtered.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "transition-colors duration-200";
                let dateStr = 'N/A';
                if (item.createdAt) {
                    const d = new Date(item.createdAt.seconds * 1000);
                    dateStr = `<div class="text-xs text-white font-medium">${d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}</div><div class="text-[10px] text-gray-500">${d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
                }

                let rowHTML = `<td>${dateStr}</td>`;
                colArray.forEach(col => {
                    let val = item.lead ? (item.lead[col] || '-') : '-';
                    // Escape HTML first to prevent XSS, then linkify
                    val = val.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
                    val = linkify(val);

                    if (col.toLowerCase() === 'email') {
                        val = `<span class="text-white block min-w-[120px]">${val}</span>`;
                    }
                    else if (col.toLowerCase() === 'name') {
                        let nameHtml = `<span class="font-semibold text-white whitespace-nowrap">${val}</span>`;
                        if (item.negativeFeedback) {
                            nameHtml += `<button onclick="window.viewFeedback('${item.id}')" class="flex-shrink-0 inline-flex items-center justify-center w-6 h-6 bg-red-500/10 border border-red-500/20 text-red-400 rounded-md hover:bg-red-500/20 transition animate-pulse" title="View Negative Feedback"><i data-feather="alert-triangle" class="w-3 h-3"></i></button>`;
                        }
                        val = `<div class="flex items-center gap-2 min-w-[140px]">${nameHtml}</div>`;
                    }
                    else {
                        // MOBILE TRUNCATION LOGIC:
                        // Show shortened text on mobile, click to expand. Desktop shows full.
                        // We use group to make the whole cell interactive if needed
                        val = `<div class="truncate max-w-[120px] sm:max-w-none cursor-pointer transition-all hover:text-white" onclick="this.classList.toggle('truncate'); this.classList.toggle('whitespace-normal');" title="Tap to read more">
                                ${val}
                               </div>`;
                    }
                    rowHTML += `<td class="text-sm text-gray-400">${val}</td>`;
                });

                if (item.status === 'archived') {
                    rowHTML += `<td><input type="text" class="note-input" placeholder="Add note..." value="${(item.note || '').replace(/"/g, '&quot;')}" onblur="window.saveNote('${item.id}', this.value)" disabled /></td>`;
                } else {
                    rowHTML += `<td><input type="text" class="note-input" placeholder="Add note..." value="${(item.note || '').replace(/"/g, '&quot;')}" onblur="window.saveNote('${item.id}', this.value)" /></td>`;
                }

                // --- STATUS COLUMN (Renamed from Actions) ---
                const statusMap = {
                    'new': { label: 'New', color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20' },
                    'contacted': { label: 'Contacted', color: 'text-blue-400', bg: 'bg-blue-500/10', border: 'border-blue-500/20' },
                    'qualified': { label: 'Qualified', color: 'text-purple-400', bg: 'bg-purple-500/10', border: 'border-purple-500/20' },
                    'junk': { label: 'Junk', color: 'text-red-400', bg: 'bg-red-500/10', border: 'border-red-500/20' },
                    'archived': { label: 'Archived', color: 'text-gray-400', bg: 'bg-gray-500/10', border: 'border-white/10' },
                    'review_sent': { label: 'Review Sent', color: 'text-yellow-400', bg: 'bg-yellow-500/10', border: 'border-yellow-500/20' }
                };

                const s = statusMap[item.status || 'new'] || statusMap['new'];

                rowHTML += `
                    <td class="text-center">
                         <button onclick="window.openLeadActions('${item.id}', '${item.status || 'new'}')"
                            class="group relative inline-flex items-center gap-2 px-3 py-1.5 rounded-full border transition-all hover:scale-105 active:scale-95 w-full justify-between ${s.bg} ${s.border}">
                            <div class="flex items-center gap-1.5 overflow-hidden">
                                <div class="w-1.5 h-1.5 rounded-full ${s.color.replace('text', 'bg')} flex-shrink-0"></div>
                                <span class="text-[10px] font-bold uppercase tracking-wider ${s.color} truncate">${s.label}</span>
                            </div>
                            <i data-feather="edit-2" class="w-3 h-3 ${s.color} opacity-50 group-hover:opacity-100 transition-opacity"></i>
                         </button>
                    </td>
                </tr>`;

                tbody.innerHTML += rowHTML;
            });
            feather.replace();

            // Update Load More button visibility
            if (filtered.length < 20) { // Assuming 20 is the limit per fetch
                loadMoreBtn.classList.add('hidden');
                leadsEndMsg.classList.remove('hidden');
            } else {
                loadMoreBtn.classList.remove('hidden');
                leadsEndMsg.classList.add('hidden');
            }
        }

        // ==========================================
        // ACTIONS
        // ==========================================
        window.updateStatus = async (id, status) => {
            const row = document.querySelector(`button[onclick*="openLeadActions('${id}')"]`);
            if (row) row.closest('tr').style.opacity = '0.5';

            const updateData = { status: status };

            // Capture response time if moving to contacted/qualified for the first time
            if (['contacted', 'qualified'].includes(status)) {
                // We verify if it was already set to avoid overwriting (optional, but good practice)
                const lead = clientLeads.find(l => l.id === id);
                if (lead && !lead.contactedAt) {
                    updateData.contactedAt = Timestamp.now();
                }
            }

            await updateDoc(doc(db, "leads", id), updateData);
        };

        // --- STATUS/ACTIONS MODAL LOGIC ---
        let activeLeadIdForStatus = null;

        window.openLeadActions = (id, currentStatus) => {
            activeLeadIdForStatus = id;
            const modal = document.getElementById('status-modal');
            const container = document.getElementById('status-options-container');
            container.innerHTML = '';

            // Find Lead Data for Context
            const leadObj = clientLeads.find(l => l.id === id);
            const isArchived = leadObj && leadObj.status === 'archived';
            const isReviewSent = leadObj && leadObj.lead && leadObj.lead.reviewSent; // Check lead.reviewSent

            // 1. STATUS SECTION
            const header = document.createElement('div');
            header.className = "text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2";
            header.textContent = "Set Status";
            container.appendChild(header);

            const statuses = [
                { val: 'new', label: 'New', color: 'text-emerald-400', bg: 'bg-emerald-500/10', border: 'border-emerald-500/20' },
                { val: 'contacted', label: 'Contacted', color: 'text-blue-400', bg: 'bg-blue-500/10', border: 'border-blue-500/20' },
                { val: 'qualified', label: 'Qualified', color: 'text-purple-400', bg: 'bg-purple-500/10', border: 'border-purple-500/20' },
                { val: 'junk', label: 'Junk', color: 'text-red-400', bg: 'bg-red-500/10', border: 'border-red-500/20' }
            ];

            statuses.forEach(s => {
                const isActive = currentStatus === s.val;
                const btn = document.createElement('button');
                btn.className = `w-full flex items-center justify-between px-4 py-3 rounded-2xl border transition group mb-1 ${isActive ? s.bg + ' ' + s.border : 'bg-white/5 border-white/5 hover:bg-white/10'}`;
                btn.onclick = () => window.confirmStatusUpdate(s.val);

                btn.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full ${s.color.replace('text', 'bg')}"></div>
                        <span class="font-bold text-sm ${isActive ? 'text-white' : 'text-gray-400 group-hover:text-white'}">${s.label}</span>
                    </div>
                    ${isActive ? `<i data-feather="check" class="w-4 h-4 text-white"></i>` : ''}
                `;
                container.appendChild(btn);
            });

            // 2. ACTIONS SECTION
            const actionHeader = document.createElement('div');
            actionHeader.className = "text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2 mt-4";
            actionHeader.textContent = "Actions";
            container.appendChild(actionHeader);

            // Review Request (Check Global State)
            // We use the local module variable 'reviewFeatureEnabled'
            if (reviewFeatureEnabled && !isArchived) {
                const reviewBtn = document.createElement('button');
                reviewBtn.className = `w-full flex items-center justify-between px-4 py-3 rounded-2xl border border-white/5 hover:bg-yellow-500/10 hover:border-yellow-500/20 hover:text-yellow-400 transition group mb-1 ${isReviewSent ? 'opacity-50' : 'bg-white/5'}`;
                reviewBtn.onclick = () => { window.closeStatusModal(); window.triggerReviewRequest(id); };
                reviewBtn.innerHTML = `
                    <div class="flex items-center gap-3">
                         <i data-feather="star" class="w-4 h-4 text-yellow-500"></i>
                         <span class="font-bold text-sm text-gray-300 group-hover:text-yellow-400">${isReviewSent ? 'Review Request Sent' : 'Send Review Request'}</span>
                    </div>
                `;
                container.appendChild(reviewBtn);
            }

            // Archive / Restore
            if (isArchived) {
                const restoreBtn = document.createElement('button');
                restoreBtn.className = "w-full flex items-center justify-between px-4 py-3 rounded-2xl border border-white/5 bg-white/5 hover:bg-emerald-500/10 hover:border-emerald-500/20 hover:text-emerald-400 transition group";
                restoreBtn.onclick = () => { window.closeStatusModal(); window.restoreLead(id); };
                restoreBtn.innerHTML = `
                    <div class="flex items-center gap-3">
                         <i data-feather="refresh-cw" class="w-4 h-4 text-gray-500 group-hover:text-emerald-400"></i>
                         <span class="font-bold text-sm text-gray-400 group-hover:text-emerald-400">Restore Lead</span>
                    </div>
                `;
                container.appendChild(restoreBtn);
            } else {
                const archiveBtn = document.createElement('button');
                archiveBtn.className = "w-full flex items-center justify-between px-4 py-3 rounded-2xl border border-white/5 bg-white/5 hover:bg-red-500/10 hover:border-red-500/20 hover:text-red-400 transition group";
                archiveBtn.onclick = () => window.confirmStatusUpdate('archived');
                archiveBtn.innerHTML = `
                    <div class="flex items-center gap-3">
                         <i data-feather="archive" class="w-4 h-4 text-gray-500 group-hover:text-red-400"></i>
                         <span class="font-bold text-sm text-gray-400 group-hover:text-red-400">Archive Lead</span>
                    </div>
                `;
                container.appendChild(archiveBtn);
            }

            // Check title
            document.querySelector('#status-modal h3').textContent = "Manage Lead";
            document.querySelector('#status-modal p').textContent = "Update status or perform actions";

            if (window.feather) feather.replace();
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.closeStatusModal = () => {
            const modal = document.getElementById('status-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            activeLeadIdForStatus = null;
        };

        window.confirmStatusUpdate = async (newStatus) => {
            const id = activeLeadIdForStatus;
            if (!id) return;
            window.closeStatusModal();
            await window.updateStatus(id, newStatus);
        };

        window.archiveLead = async (id) => {
            const btn = document.querySelector(`button[onclick*="archiveLead('${id}')"]`);
            if (btn) btn.closest('tr').style.opacity = '0.5';
            await updateDoc(doc(db, "leads", id), { status: 'archived' });
        };

        window.restoreLead = async (id) => {
            const btn = document.querySelector(`button[onclick*="restoreLead('${id}')"]`);
            if (btn) btn.closest('tr').style.opacity = '0.5';
            await updateDoc(doc(db, "leads", id), { status: 'new' });
        };

        window.saveNote = async (id, note) => {
            await updateDoc(doc(db, "leads", id), { note: note });
        };

        // --- VIEW NEGATIVE FEEDBACK ---
        window.viewFeedback = (id) => {
            const leadObj = clientLeads.find(l => l.id === id);
            if (!leadObj || !leadObj.negativeFeedback) return;

            // Insert text
            document.getElementById('feedbackContent').textContent = `"${leadObj.negativeFeedback}"`;

            // Format Date
            let dateStr = "Recently";
            if (leadObj.feedbackSubmittedAt) {
                const d = new Date(leadObj.feedbackSubmittedAt.seconds * 1000);
                dateStr = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            }
            document.getElementById('feedbackDate').textContent = dateStr;

            // Open Modal
            const modal = document.getElementById('feedbackModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            feather.replace();
        };

        window.closeFeedbackModal = (e) => {
            const modal = document.getElementById('feedbackModal');
            if (!e || e.target === modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        };

        // --- TRIGGER REVIEW REQUEST ---
        window.triggerReviewRequest = async (id) => {
            // Find the lead data
            const leadObj = clientLeads.find(l => l.id === id);
            if (!leadObj || !leadObj.lead) return;

            // Extract Email (case-insensitive check)
            const emailKey = Object.keys(leadObj.lead).find(k => k.toLowerCase() === 'email');
            const leadEmail = emailKey ? leadObj.lead[emailKey] : null;

            if (!leadEmail) {
                // We don't have an email to send it to. Show a custom alert using your existing modal.
                window.customAlert ? window.customAlert("Cannot send review request: This lead did not provide an email address.", "No Email Found") : alert("No email provided by this lead.");
                return;
            }

            // Extract Name (for personalization)
            const nameKey = Object.keys(leadObj.lead).find(k => k.toLowerCase() === 'name');
            const leadName = nameKey ? leadObj.lead[nameKey] : 'Valued Customer';

            // Extract Page Source (for internal feedback routing)
            const pageSource = leadObj.lead['_page_source'] || leadObj.lead['source'] || 'Website';

            // Confirm Action
            const confirmed = window.customConfirm ?
                await window.customConfirm(`Send a 5-Star Review Request to <br><b class="text-white">${leadEmail}</b>?<br><br><span class="text-xs text-gray-500">This will deduct 1 email credit from your daily limit.</span>`, "Send Review Request") :
                confirm("Send review request to " + leadEmail + "?");

            if (!confirmed) return;

            // Visual Loading State (Find row via the main table button)
            const tableBtn = document.querySelector(`button[onclick*="openLeadActions('${id}')"]`);
            // Check if button exists before accessing .closest()
            const row = tableBtn ? tableBtn.closest('tr') : null;

            if (row) {
                row.style.opacity = '0.5';
                row.style.pointerEvents = 'none';
            }

            try {
                // Get Auth Token
                const idToken = await authInstance.currentUser.getIdToken(true);

                // Hit the Backend
                const response = await fetch(`${API_BASE}/sendReviewRequest`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        leadId: id,
                        leadEmail: leadEmail,
                        leadName: leadName,
                        pageSource: pageSource
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Success! Firestore listener will automatically update the row to REVIEW_SENT and restore opacity.
                    // We can show a toast here if you have a toast function, or just let the UI update silently.
                } else {
                    // Revert opacity on failure
                    if (row) { row.style.opacity = '1'; row.style.pointerEvents = 'auto'; }
                    window.customAlert ? window.customAlert(data.error || "Failed to send request.", "Error") : alert(data.error);
                }
            } catch (error) {
                if (row) { row.style.opacity = '1'; row.style.pointerEvents = 'auto'; }
                window.customAlert ? window.customAlert("Network error: " + error.message, "Error") : alert(error.message);
            }
        };

        // Sorting
        window.toggleSort = () => {
            sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
            renderTable();
        };

        // --- DYNAMIC FILTER MODAL (Polished) ---
        window.openFilterModal = () => {
            const modal = document.getElementById('filter-modal');
            modal.classList.remove('hidden');
            renderFilterFields();
        };

        window.closeFilterModal = () => {
            document.getElementById('filter-modal').classList.add('hidden');
        };

        // Render Step 1: Fields
        // Render Step 1: Fields (Updated with Search)
        // Render Step 1: Fields (Updated with Counts)
        function renderFilterFields() {
            document.getElementById('filter-modal-title').textContent = "Filter by...";
            const containerDisplay = document.getElementById('filter-step-fields');
            containerDisplay.classList.remove('hidden');
            document.getElementById('filter-step-values').classList.add('hidden');
            document.getElementById('filter-modal-footer').classList.add('hidden');

            // Add Search Bar + Container
            containerDisplay.innerHTML = `
                <div class="sticky top-0 bg-[#16161f] z-10 pb-2 mb-2 pt-1 border-b border-white/5">
                    <div class="relative">
                        <i data-feather="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500"></i>
                        <input type="text" id="field-search" placeholder="Search fields..."
                            class="w-full bg-white/5 border border-white/10 rounded-lg pl-10 pr-3 py-2 text-sm text-white focus:outline-none focus:border-purple-500/50 transition placeholder-gray-600"
                            onkeyup="window.filterFieldList(this.value)">
                    </div>
                </div>
                <div id="field-list-container" class="space-y-1"></div>
            `;

            const listContainer = document.getElementById('field-list-container');

            // Get Fields and Counts
            const fieldCounts = {};
            clientLeads.forEach(l => {
                if (l.lead) {
                    Object.keys(l.lead).forEach(k => {
                        fieldCounts[k] = (fieldCounts[k] || 0) + 1;
                    });
                }
            });

            const fields = Object.keys(fieldCounts);

            if (fields.length === 0) {
                listContainer.innerHTML = `<div class="p-8 text-center text-gray-500 text-sm">No data found to filter.</div>`;
                return;
            }

            fields.sort().forEach(field => {
                const count = fieldCounts[field];
                const btn = document.createElement('button');
                btn.className = "w-full text-left px-4 py-3 rounded-lg hover:bg-white/10 text-gray-300 hover:text-white transition flex items-center justify-between group";
                btn.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="font-medium capitalization text-sm">${field}</span>
                        <span class="text-[10px] text-gray-500 bg-white/5 px-2 py-0.5 rounded-md group-hover:bg-white/10 transition-colors">${count}</span>
                    </div>
                    <i data-feather="chevron-right" class="w-4 h-4 text-gray-600 group-hover:text-white transition"></i>
                `;
                btn.onclick = () => window.selectFilterField(field);
                listContainer.appendChild(btn);
            });
            feather.replace();
        }

        window.filterFieldList = (query) => {
            const term = query.toLowerCase();
            const buttons = document.querySelectorAll('#field-list-container button');
            buttons.forEach(btn => {
                const text = btn.innerText.toLowerCase();
                if (text.includes(term)) {
                    btn.classList.remove('hidden');
                } else {
                    btn.classList.add('hidden');
                }
            });
        };

        // Render Step 2: Values
        // Render Step 2: Values (Updated with Counts & Sorting)
        window.selectFilterField = (field) => {
            document.getElementById('filter-modal-title').textContent = `Filter by ${field}`;
            document.getElementById('filter-step-fields').classList.add('hidden');
            document.getElementById('filter-step-values').classList.remove('hidden');
            document.getElementById('filter-modal-footer').classList.remove('hidden');

            const container = document.getElementById('filter-step-values');
            container.innerHTML = '';

            // Get Values and Counts
            const valueCounts = {};
            clientLeads.forEach(l => {
                if (l.lead && l.lead[field]) {
                    const val = String(l.lead[field]).trim();
                    if (val) valueCounts[val] = (valueCounts[val] || 0) + 1;
                }
            });

            const uniqueValues = Object.keys(valueCounts);

            if (uniqueValues.length === 0) {
                container.innerHTML = `<div class="p-8 text-center text-gray-500 text-sm">No values found for this field.</div>`;
                return;
            }

            // Sort by Popularity (High to Low), then Alphabetical
            uniqueValues.sort((a, b) => {
                const diff = valueCounts[b] - valueCounts[a];
                if (diff !== 0) return diff;
                return a.localeCompare(b);
            });

            uniqueValues.forEach(val => {
                const count = valueCounts[val];
                const btn = document.createElement('button');
                btn.className = "w-full text-left px-4 py-3 rounded-lg hover:bg-white/10 text-gray-300 hover:text-white transition flex items-center justify-between gap-3 mb-1 group";
                btn.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-2 h-2 rounded-full bg-purple-500/50 flex-shrink-0"></div>
                        <span class="font-medium truncate">${val}</span>
                    </div>
                    <span class="text-xs font-bold text-gray-500 group-hover:text-white bg-white/5 px-2 py-1 rounded-md transition-colors">${count}</span>
                `;
                btn.onclick = () => window.applyCustomFilter(field, val);
                container.appendChild(btn);
            });
        };

        window.backToFilterFields = () => {
            renderFilterFields();
        };

        window.applyCustomFilter = (field, value) => {
            customFilter = { field, value };

            // Update UI
            const pill = document.getElementById('active-filter-pill');
            const text = document.getElementById('active-filter-text');
            text.textContent = `${field}: ${value}`;
            pill.classList.remove('hidden');

            window.closeFilterModal();
            renderTable();
        };

        window.clearCustomFilter = () => {
            customFilter = null;
            document.getElementById('active-filter-pill').classList.add('hidden');
            renderTable();
        };

        // Close when clicking overlay
        document.getElementById('filter-modal').addEventListener('click', (e) => {
            if (e.target.id === 'filter-modal') window.closeFilterModal();
        });

        // Initialize Global Expose (since module scope)
        window.setFilter = setFilter;
        // setChartRange, calPrev, calNext used in HTLM onclicks
        window.setChartRange = setChartRange;
        window.calPrev = () => { calDate.setMonth(calDate.getMonth() - 1); renderCalendar(); };
        window.calNext = () => { calDate.setMonth(calDate.getMonth() + 1); renderCalendar(); };


        // ==========================================
        // ANALYTICS & CHARTS
        // ==========================================
        async function renderAnalytics() {
            console.log("Rendering Analytics...");

            // 1. GLOBAL KPIs (From Stats)
            const total = clientStats.totalLeads || 0;

            if (document.getElementById('kpi-total')) {
                document.getElementById('kpi-total').textContent = total;
            }

            // 2. FETCH RECENT DATA FOR CHARTS (Last 300)
            let recentLeads = [];
            try {
                // FIX: Query ONLY by clientId to avoid "Missing Index" errors
                const q = query(
                    collection(db, "leads"),
                    where("clientId", "==", clientEmail)
                );

                const snap = await getDocs(q);

                // Convert to array
                let allLeads = snap.docs.map(d => d.data());

                // Sort in Memory (Newest First)
                allLeads.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                // Slice top 300 for performance
                recentLeads = allLeads.slice(0, 300);

            } catch (e) {
                console.error("Analytics Query Error:", e);
                // recentLeads remains [] if error, preventing crash
            }

            // 3. CALCULATE TIME-BASED KPIs
            const now = new Date();
            const thisMonth = recentLeads.filter(l => {
                if (!l.createdAt) return false;
                const d = new Date(l.createdAt.seconds * 1000);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            }).length;

            const contacted = recentLeads.filter(l => ['contacted', 'qualified'].includes(l.status));

            // Calculate conversion based on the recent batch
            const conversionRate = recentLeads.length > 0 ? Math.round((contacted.length / recentLeads.length) * 100) : 0;

            // 4. AVG RESPONSE TIME (From Recent)
            let totalResponseTimeMs = 0;
            let responseCount = 0;
            contacted.forEach(l => {
                if (l.createdAt && l.contactedAt) {
                    const diff = (l.contactedAt.seconds * 1000) - (l.createdAt.seconds * 1000);
                    if (diff > 0) { totalResponseTimeMs += diff; responseCount++; }
                }
            });
            const avgResponseStr = responseCount > 0 ? formatDuration(totalResponseTimeMs / responseCount) : 'â€”';

            // Update DOM
            if (document.getElementById('kpi-this-month')) document.getElementById('kpi-this-month').textContent = thisMonth;
            if (document.getElementById('kpi-conversion')) document.getElementById('kpi-conversion').textContent = conversionRate + '%';
            if (document.getElementById('kpi-response-time')) document.getElementById('kpi-response-time').textContent = avgResponseStr;

            // 5. UPDATE CHARTS
            // Temporarily swap clientLeads with recentLeads so charts use the analytics data
            // instead of the currently viewed page data
            const originalLeads = clientLeads;
            clientLeads = recentLeads;

            if (volumeChart) volumeChart.destroy();
            if (statusChart) statusChart.destroy();

            // Render Charts using the temporary data
            if (typeof renderVolumeChart === 'function') renderVolumeChart(chartRange);
            if (typeof renderStatusChart === 'function') renderStatusChart();


            // Restore Global Leads variable
            // 6. RENDER LISTS & CALENDAR (Run this BEFORE restoring the original view's leads)
            // This ensures we use the 'recentLeads' data we just fetched for calculations
            if (typeof renderDetailedAnalytics === 'function') renderDetailedAnalytics();
            if (typeof renderCalendar === 'function') renderCalendar();

            // Restore Global Leads variable
            clientLeads = originalLeads;
        }

        function renderDetailedAnalytics() {
            // 1. TOP SOURCES
            const container = document.getElementById('analytics-sources');
            if (container) {
                container.innerHTML = '';
                const sources = clientStats.sources || {};
                const sortedSources = Object.entries(sources)
                    .sort(([, a], [, b]) => b.count - a.count)
                    .slice(0, 5);

                const colors = ['bg-blue-500', 'bg-purple-500', 'bg-pink-500', 'bg-orange-500', 'bg-emerald-500'];

                if (sortedSources.length === 0) {
                    container.innerHTML = '<div class="text-xs text-gray-500 text-center py-4">No data available</div>';
                }

                sortedSources.forEach(([sig, stat], index) => {
                    // FIX: Use the new helper that handles "Form 1", "Form 2", etc.
                    const name = getFormDisplayName(sig);
                    const percent = clientStats.totalLeads > 0 ? Math.round((stat.count / clientStats.totalLeads) * 100) : 0;
                    const colorClass = colors[index % colors.length];

                    // FIX: Create DIV rows instead of TR (Table Rows) to match your HTML
                    const row = document.createElement('div');
                    row.className = "flex items-center justify-between text-xs";
                    row.innerHTML = `
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div class="w-2 h-2 rounded-full ${colorClass} flex-shrink-0"></div>
                            <span class="text-gray-300 truncate">${name}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-white font-bold">${stat.count}</span>
                            <span class="text-gray-500 w-8 text-right">${percent}%</span>
                        </div>
                    `;
                    container.appendChild(row);
                });
            }

            // 2. VOLUME SPIKES (Added Missing Logic)
            const anomaliesContainer = document.getElementById('analytics-anomalies');
            if (anomaliesContainer) {
                anomaliesContainer.innerHTML = '';

                // Group leads by date
                const dateMap = {};
                clientLeads.forEach(l => {
                    if (!l.createdAt) return;
                    const d = new Date(l.createdAt.seconds * 1000).toDateString();
                    dateMap[d] = (dateMap[d] || 0) + 1;
                });

                // Find top 3 days
                const sortedDays = Object.entries(dateMap)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 3);

                if (sortedDays.length === 0) {
                    anomaliesContainer.innerHTML = '<div class="text-xs text-gray-500 text-center py-4">No spikes detected</div>';
                }

                sortedDays.forEach(([dateStr, count]) => {
                    const d = new Date(dateStr);
                    const formattedDate = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                    const row = document.createElement('div');
                    row.className = "flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/5";
                    row.innerHTML = `
                        <div class="flex items-center gap-3">
                            <i data-feather="trending-up" class="w-4 h-4 text-purple-400"></i>
                            <span class="text-xs text-gray-300 font-medium">${formattedDate}</span>
                        </div>
                        <span class="text-xs font-bold text-white bg-purple-500/20 px-2 py-1 rounded text-purple-300">+${count} Leads</span>
                    `;
                    anomaliesContainer.appendChild(row);
                });

                if (window.feather) feather.replace();
            }
        }

        function formatDuration(ms) {
            if (!ms || ms === 0) return "N/A";
            const minutes = Math.floor(ms / 60000);
            if (minutes < 60) return `${minutes}m`;
            const hours = Math.floor(minutes / 60);
            return `${hours}h ${minutes % 60}m`;
        }

        function setChartRange(range) {
            chartRange = range;
            document.querySelectorAll('#view-analytics .filter-pill').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${range}`).classList.add('active');
            // Re-render only volume chart
            if (volumeChart) volumeChart.destroy();
            renderVolumeChart(range);
        }

        function renderVolumeChart(range) {
            const days = range === '7d' ? 7 : (range === '30d' ? 30 : 90);
            const labels = [];

            // 1. Generate Labels
            for (let i = days - 1; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('en-US', { day: 'numeric', month: 'short' }));
            }

            // 2. Map Data correctly
            const map = {};
            labels.forEach(l => map[l] = 0);

            clientLeads.forEach(l => {
                if (!l.createdAt) return;
                const d = new Date(l.createdAt.seconds * 1000);
                const dateKey = d.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });

                // Only count if this date exists in our range labels
                if (map[dateKey] !== undefined) {
                    map[dateKey]++;
                }
            });

            // FIX: Ensure we use 'l' here (labels)
            const finalData = labels.map(l => map[l]);

            const ctx = document.getElementById('chart-volume').getContext('2d');
            if (volumeChart) volumeChart.destroy();

            volumeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Leads',
                        data: finalData,
                        backgroundColor: '#a855f7',
                        borderRadius: 4,
                        hoverBackgroundColor: '#d8b4fe'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#666', font: { size: 10 }, precision: 0 }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#666', font: { size: 10 }, maxTicksLimit: 7 }
                        }
                    }
                }
            });
        }

        function renderStatusChart() {
            const ctx = document.getElementById('chart-status').getContext('2d');

            // Calculate dynamically from the loaded leads
            let newCount = 0, contactedCount = 0, qualifiedCount = 0, junkCount = 0;

            clientLeads.forEach(l => {
                const st = l.status || 'new';
                if (st === 'new') newCount++;
                else if (st === 'contacted') contactedCount++;
                else if (st === 'qualified') qualifiedCount++;
                else if (st === 'junk') junkCount++;
            });

            const counts = [newCount, contactedCount, qualifiedCount, junkCount];

            if (statusChart) statusChart.destroy();

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['New', 'Contacted', 'Qualified', 'Junk'],
                    datasets: [{
                        data: counts,
                        backgroundColor: ['#34d399', '#60a5fa', '#a855f7', '#f87171'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { position: 'right', labels: { color: '#ccc', font: { size: 11 }, boxWidth: 10 } }
                    }
                }
            });
        }



        // ==========================================
        // CALENDAR
        // ==========================================
        function renderCalendar() {
            const container = document.getElementById('cal-body');
            container.innerHTML = '';

            const year = calDate.getFullYear();
            const month = calDate.getMonth();
            document.getElementById('cal-month-label').textContent = calDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            // Empty cells for padding
            for (let i = 0; i < firstDay; i++) {
                container.appendChild(document.createElement('div'));
            }

            // Days
            for (let d = 1; d <= daysInMonth; d++) {
                const cellDate = new Date(year, month, d);
                const div = document.createElement('div');
                div.className = 'cal-cell';

                // Check if today
                if (cellDate.toDateString() === today.toDateString()) div.classList.add('today');

                // Count leads for this day
                const count = clientLeads.filter(l => {
                    if (!l.createdAt) return false;
                    const ld = new Date(l.createdAt.seconds * 1000);
                    return ld.toDateString() === cellDate.toDateString();
                }).length;

                if (count > 0) {
                    div.classList.add('has-leads');
                    div.style.background = `rgba(168, 85, 247, ${Math.min(0.2 + (count * 0.1), 0.8)})`; // Purple opacity based on volume
                    div.style.borderColor = `rgba(168, 85, 247, 0.3)`;
                } else {
                    div.style.background = 'rgba(255,255,255,0.02)';
                }

                div.innerHTML = `<div>${d}</div>${count > 0 ? `<div class="cal-count">${count}</div>` : ''}`;
                container.appendChild(div);
            }
        }

        // ==========================================
        // HELPERS
        // ==========================================

        // Custom Confirmation Promise Modal
        window.customConfirm = (message, title) => {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const titleEl = document.getElementById('confirmTitle');
                const msgEl = document.getElementById('confirmMessage');
                const btnCancel = document.getElementById('confirmCancelBtn');
                const btnProceed = document.getElementById('confirmProceedBtn');

                if (title) titleEl.innerHTML = title;
                if (message) msgEl.innerHTML = message;

                // Reset handlers
                const newCancel = btnCancel.cloneNode(true);
                const newProceed = btnProceed.cloneNode(true);
                btnCancel.parentNode.replaceChild(newCancel, btnCancel);
                btnProceed.parentNode.replaceChild(newProceed, btnProceed);

                modal.classList.remove('hidden');
                modal.classList.add('flex');

                const cleanup = (result) => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    resolve(result);
                };

                newCancel.addEventListener('click', () => cleanup(false));
                newProceed.addEventListener('click', () => cleanup(true));

                // Allow clicking outside
                window.closeConfirmModal = (e) => {
                    if (e.target === modal) cleanup(false);
                };
            });
        };

        // ==========================================
        // CSV IMPORT LOGIC
        // ==========================================
        // Custom Prompt Promise Modal (Dynamic)
        window.customPrompt = (title, defaultValue) => {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = "fixed inset-0 z-[10000] flex items-center justify-center bg-black/90 backdrop-blur-md transition-opacity";

                modal.innerHTML = `
                    <div class="glass-panel w-full max-w-[340px] mx-6 p-1 shadow-2xl rounded-3xl overflow-hidden relative transform transition-all scale-100" onclick="event.stopPropagation()">
                        <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-blue-500/10 to-purple-500/10 pointer-events-none"></div>
                        <div class="bg-[#0B0A14]/90 backdrop-blur-xl p-6 rounded-[20px] relative z-10">
                            <div class="text-center mb-6">
                                <div class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-blue-500/20 to-purple-500/20 border border-white/10 flex items-center justify-center mx-auto mb-3 shadow-[0_0_15px_rgba(59,130,246,0.15)]">
                                    <i data-feather="edit-2" class="w-6 h-6 text-blue-300"></i>
                                </div>
                                <h3 class="text-lg font-bold text-white font-['Space_Grotesk']">${title}</h3>
                            </div>
                            <div class="space-y-4">
                                <input type="text" id="custom-prompt-input" value="${defaultValue}"
                                    class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-white placeholder-gray-600 focus:outline-none focus:border-blue-500/50 focus:bg-white/10 transition-all text-center"
                                    autocomplete="off">
                                <div class="grid grid-cols-2 gap-3 mt-2">
                                    <button id="prompt-cancel" class="py-3 bg-white/5 hover:bg-white/10 border border-white/5 text-gray-400 hover:text-white text-xs font-bold rounded-xl transition-all">Cancel</button>
                                    <button id="prompt-confirm" class="py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white text-xs font-bold rounded-xl shadow-lg shadow-blue-900/20 transition-all transform active:scale-95">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                if (window.feather) feather.replace();

                const input = modal.querySelector('#custom-prompt-input');
                setTimeout(() => { input.focus(); input.select(); }, 50);

                const cleanup = (val) => {
                    document.body.removeChild(modal);
                    resolve(val);
                };

                modal.querySelector('#prompt-cancel').onclick = () => cleanup(null);
                modal.querySelector('#prompt-confirm').onclick = () => cleanup(input.value);
                input.onkeyup = (e) => { if (e.key === 'Enter') cleanup(input.value); };
                modal.onclick = (e) => { if (e.target === modal) cleanup(null); };
            });
        };
        window.activeSource = 'api';

        window.switchSource = (source) => {
            activeSource = source;

            // Toggle Tab UI
            const btnApi = document.getElementById('source-api');
            const btnImport = document.getElementById('source-imported');

            if (source === 'api') {
                btnApi.classList.remove('text-gray-500', 'hover:text-gray-300', 'hover:bg-white/5', 'border-transparent');
                btnApi.classList.add('bg-white/10', 'text-white', 'border-white/10');

                btnImport.classList.add('text-gray-500', 'hover:text-gray-300', 'hover:bg-white/5', 'border-transparent');
                btnImport.classList.remove('bg-white/10', 'text-white', 'border-white/10');
            } else {
                btnImport.classList.remove('text-gray-500', 'hover:text-gray-300', 'hover:bg-white/5', 'border-transparent');
                btnImport.classList.add('bg-white/10', 'text-white', 'border-white/10');

                btnApi.classList.add('text-gray-500', 'hover:text-gray-300', 'hover:bg-white/5', 'border-transparent');
                btnApi.classList.remove('bg-white/10', 'text-white', 'border-white/10');
            }

            setFilter('all');
            renderTable();
        };

        window.openImportModal = () => {
            document.getElementById('import-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('import-modal').classList.remove('opacity-0'), 10);
        };

        window.closeImportModal = () => {
            document.getElementById('import-modal').classList.add('opacity-0');
            setTimeout(() => {
                document.getElementById('import-modal').classList.add('hidden');
                resetImportModal();
            }, 300);
        };

        function resetImportModal() {
            document.getElementById('csv-file').value = '';
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('upload-preview').classList.add('hidden');
            document.getElementById('btn-process-import').disabled = true;
            document.getElementById('import-msg').classList.add('hidden');
            csvData = [];
        }

        window.handleFileSelect = (input) => {
            const files = input.files;
            if (!files || files.length === 0) return;

            // Multiple Files Handler
            csvData = []; // Reset global data
            let filesProcessed = 0;
            const totalFiles = files.length;

            document.getElementById('upload-placeholder').classList.add('hidden');
            document.getElementById('upload-preview').classList.remove('hidden');
            document.getElementById('file-name').innerHTML = `<span class="spinner inline-block w-4 h-4 mr-2"></span>Processing ${totalFiles} files...`;
            document.getElementById('row-count').textContent = '';

            Array.from(files).forEach(file => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function (results) {
                        // STRICT LIMIT CHECK
                        let newData = results.data;
                        const currentTotal = csvData.length + newData.length;

                        if (currentTotal > 500) {
                            alert(`Limit Exceeded: Imports are capped at 500 rows.\nOnly the first ${500 - csvData.length} rows of this file will be added.`);
                            const remainingSpace = 500 - csvData.length;
                            if (remainingSpace > 0) {
                                newData = newData.slice(0, remainingSpace);
                            } else {
                                newData = [];
                            }
                        }

                        // Append data
                        csvData = [...csvData, ...newData];
                        filesProcessed++;

                        if (filesProcessed === totalFiles) {
                            // All done
                            document.getElementById('file-name').textContent = `${totalFiles} File(s) Selected`;
                            document.getElementById('row-count').textContent = `${csvData.length} / 500 rows ready`;

                            // Disable if max reached to prevent further confusion, or if empty
                            document.getElementById('btn-process-import').disabled = (csvData.length === 0);

                            if (csvData.length >= 500) {
                                document.getElementById('row-count').classList.add('text-orange-400');
                                document.getElementById('row-count').textContent += " (Max Reached)";
                            }
                        }
                    },
                    error: function (err) {
                        console.error("Parse Error", err);
                        // Continue anyway
                        filesProcessed++;
                        if (filesProcessed === totalFiles) {
                            document.getElementById('btn-process-import').disabled = (csvData.length === 0);
                        }
                    }
                });
            });
        };

        window.processImport = async () => {
            // PROMPT FOR FOLDER NAME
            // Check if we are currently in a Custom Folder. If so, use that. If "All Leads" or "API", ask for new.
            let targetFolder = activeTab;

            if (activeTab === 'all_leads' || activeTab === 'api_stream') {
                const newName = prompt("Name this import batch (e.g., 'July Event List'):");
                if (!newName) return; // Cancelled
                targetFolder = newName;

                // Add to client tabs if not exists
                if (!clientTabs.includes(targetFolder)) {
                    // Update Firestore with new tab
                    const user = authInstance.currentUser;
                    const newTabsList = [...clientTabs, targetFolder];
                    await updateDoc(doc(db, "clients", user.uid), { tabs: newTabsList });
                }
            }

            const btn = document.getElementById('btn-process-import');

            btn.disabled = true;
            btn.innerHTML = '<div class="spinner"></div> Importing...';

            const msg = document.getElementById('import-msg');
            msg.classList.add('hidden');

            try {
                let successCount = 0;
                const batchSize = 400;
                for (let i = 0; i < csvData.length; i += batchSize) {
                    const chunk = csvData.slice(i, i + batchSize);

                    const promises = chunk.map(row => {
                        return addDoc(collection(db, "leads"), {
                            clientId: clientEmail,
                            lead: row,
                            source: 'import',
                            tabName: targetFolder, // <--- SAVES TO TARGET FOLDER
                            status: 'new',
                            createdAt: Timestamp.now(),
                            importedAt: Timestamp.now()
                        });
                    });

                    await Promise.all(promises);
                    successCount += chunk.length;
                }

                msg.textContent = `Successfully imported ${successCount} leads!`;
                msg.className = "text-xs text-center mt-4 text-emerald-400";
                msg.classList.remove('hidden');

                setTimeout(() => {
                    window.closeImportModal();
                    window.switchTab(targetFolder); // Switch to the newly imported tab
                }, 1500);

            } catch (err) {
                console.error(err);
                msg.textContent = "Import failed: " + err.message;
                msg.className = "text-xs text-center mt-4 text-red-400";
                msg.classList.remove('hidden');
                btn.disabled = false;
                btn.innerHTML = '<span>Import Data</span>';
            }
        };

        // ==========================================
        // EXPORT CSV (Current Tab Only)
        // ==========================================
        window.exportCSV = () => {
            // 1. Get data specifically for the current view
            const dataToExport = getFilteredLeads();

            if (!dataToExport || dataToExport.length === 0) {
                alert("No leads found in the current tab to export.");
                return;
            }

            // 2. Flatten the object structure for CSV
            const flatData = dataToExport.map(item => {
                // Base fields
                let row = {
                    Date: item.createdAt ? new Date(item.createdAt.seconds * 1000).toLocaleString() : 'N/A',
                    Status: item.status || 'new',
                };

                // Merge dynamic form fields (lead object)
                if (item.lead) {
                    row = { ...row, ...item.lead };
                }

                // Exclude internal system fields if any (start with _)
                return row;
            });

            // 3. Generate CSV using PapaParse
            const csv = Papa.unparse(flatData);

            // 4. Download Trigger
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);

            // Filename based on active tab
            const safeName = (activeTab || 'leads').replace(/[^a-z0-9]/gi, '_').toLowerCase();
            link.setAttribute("download", `${safeName}_export.csv`);

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        function linkify(text) {
            if (!text) return text;
            var urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, function (url) {
                return '<a href="' + url + '" target="_blank" class="text-blue-400 hover:text-blue-300 underline">' + url + '</a>';
            });
        }

        // ==========================================
        // TABS LOGIC
        // ==========================================
        // ==========================================
        // LOGIC: EXACT FORM SIGNATURES
        // ==========================================
        function getFormSignature(leadObj) {
            if (!leadObj) return 'unknown';
            // Get keys, filter system keys, sort alphabetically
            const keys = Object.keys(leadObj).filter(k => !k.startsWith('_')).sort();
            return keys.join(',');
        }

        // ==========================================
        // LOGIC: EXACT FORM SIGNATURES (ROBUST)
        // ==========================================
        // ==========================================
        // HELPER: GET DYNAMIC FORM NAME (Form 1, Form 2...)
        // ==========================================
        function getFormDisplayName(signature) {
            // 1. Check for User-Defined Alias
            if (formAliases && formAliases[signature]) return formAliases[signature];

            // 2. Auto-Numbering (Robust)
            // We sort the keys exactly like the UI does to ensure "Form 1" is always "Form 1"
            const sources = clientStats.sources || {};
            const apiSignatures = Object.keys(sources).filter(k => !clientTabs.includes(k)).sort();

            const index = apiSignatures.indexOf(signature);
            if (index !== -1) return `Form ${index + 1}`;

            return "Unknown Form";
        }

        // ==========================================
        // TABS UI RENDERER (SCALABLE)
        // ==========================================
        // ==========================================
        // TABS UI RENDERER (ROBUST AUTO-NUMBERING)
        // ==========================================
        // ==========================================
        // UI RENDERER (No "View All" + Auto-Select)
        // ==========================================
        function renderTabsUI() {
            const listContainer = document.getElementById('tabs-popup-list');
            if (!listContainer) return;

            listContainer.innerHTML = ''; // Clear

            const sources = clientStats.sources || {};
            // Get API Forms and Custom Folders
            const apiSignatures = Object.keys(sources).filter(k => !clientTabs.includes(k)).sort();
            const allAvailable = [...apiSignatures, ...clientTabs];

            // --- CRITICAL: AUTO-SELECT DEFAULT VIEW ---
            // If we are on "All Leads" (default) or nothing is selected, FORCE switch to the first available form.
            // --- CRITICAL: AUTO-SELECT DEFAULT VIEW ---
            // Fix: Prioritize tabs that actually have data (count > 0)
            if ((!activeTab || activeTab === 'all_leads') && allAvailable.length > 0) {
                // 1. Try to find a form/folder with leads > 0
                let target = allAvailable.find(sig => (sources[sig]?.count || 0) > 0);

                // 2. If all are empty, fallback to the first available form
                if (!target) target = allAvailable[0];

                console.log("Auto-selecting tab with data:", target);
                window.switchTab(target);
                return; // Stop rendering, wait for switchTab to call us back
            }
            // --- 1. DETECTED WEB FORMS ---
            if (apiSignatures.length > 0) {
                const header = document.createElement('div');
                header.className = "px-3 py-2 text-[10px] font-bold text-gray-600 uppercase tracking-widest";
                header.textContent = "Forms";
                listContainer.appendChild(header);
            }

            apiSignatures.forEach((sig) => {
                const stat = sources[sig];
                const displayName = getFormDisplayName(sig); // Robust naming
                const isActive = activeTab === sig;
                const showDot = stat.newCount > 0 && !isActive;

                const row = document.createElement('div');
                row.className = `group w-full flex items-center justify-between px-3 py-2.5 rounded-xl text-left text-xs font-medium transition mb-1 cursor-pointer ${isActive ? 'bg-purple-500/10 text-purple-300 border border-purple-500/20' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`;

                // Clicking the row switches tab
                row.onclick = () => { window.switchTab(sig); window.toggleTabsPopup(false); };

                row.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i data-feather="layout" class="w-4 h-4 flex-shrink-0 ${isActive ? 'text-purple-400' : 'text-gray-600'}"></i>
                        <span class="truncate font-semibold">${displayName}</span>
                        ${showDot ? '<div class="w-2 h-2 rounded-full bg-red-500 animate-pulse ml-2 flex-shrink-0"></div>' : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="event.stopPropagation(); window.renameForm('${sig}')" class="p-1 opacity-0 group-hover:opacity-100 hover:text-white text-gray-500 transition" title="Rename"><i data-feather="edit-2" class="w-3 h-3"></i></button>
                        <span class="bg-white/5 px-1.5 py-0.5 rounded text-[10px] text-gray-500">${stat.count || 0}</span>
                    </div>
                `;
                listContainer.appendChild(row);
            });

            // --- 2. CUSTOM FOLDERS ---
            if (clientTabs.length > 0) {
                const header = document.createElement('div');
                header.className = "px-3 py-2 text-[10px] font-bold text-gray-600 uppercase tracking-widest mt-2";
                header.textContent = "Folders";
                listContainer.appendChild(header);

                clientTabs.forEach(tab => {
                    if (tab === 'General') return;
                    const stat = sources[tab] || { count: 0, newCount: 0 };
                    const isActive = activeTab === tab;

                    const row = document.createElement('div');
                    row.className = `group w-full flex items-center justify-between px-3 py-2.5 rounded-xl text-left text-xs font-medium transition mb-1 cursor-pointer ${isActive ? 'bg-blue-500/10 text-blue-300 border border-blue-500/20' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`;
                    row.onclick = () => { window.switchTab(tab); window.toggleTabsPopup(false); };

                    row.innerHTML = `
                        <div class="flex items-center gap-3 overflow-hidden">
                            <i data-feather="folder" class="w-4 h-4 flex-shrink-0 ${isActive ? 'text-blue-400' : 'text-gray-600'}"></i>
                            <span class="truncate">${tab}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="event.stopPropagation(); window.renameFolder('${tab}')" class="p-1 opacity-0 group-hover:opacity-100 hover:text-white text-gray-500 transition"><i data-feather="edit-2" class="w-3 h-3"></i></button>
                            <button onclick="event.stopPropagation(); window.deleteFolder('${tab}')" class="p-1 opacity-0 group-hover:opacity-100 hover:text-red-400 text-gray-500 transition"><i data-feather="trash" class="w-3 h-3"></i></button>
                            <span class="bg-white/5 px-1.5 py-0.5 rounded text-[10px] text-gray-500">${stat.count || 0}</span>
                        </div>
                    `;
                    listContainer.appendChild(row);
                });
            }

            if (window.feather) feather.replace();
        }
        window.toggleTabsPopup = (forceState = null) => {
            const popup = document.getElementById('tabs-popup');
            if (forceState !== null) {
                forceState ? popup.classList.remove('hidden') : popup.classList.add('hidden');
            } else {
                popup.classList.toggle('hidden');
            }
        };

        // Close popup when clicking outside
        document.addEventListener('click', (e) => {
            const popup = document.getElementById('tabs-popup');
            const trigger = document.querySelector('button[onclick="window.toggleTabsPopup()"]');
            if (!popup || !trigger) return;
            if (!popup.contains(e.target) && !trigger.contains(e.target)) {
                popup.classList.add('hidden');
            }
        });




        // ARCHIVE TOGGLE
        // ARCHIVE TOGGLE (FIXED)
        window.toggleArchiveMode = () => {
            const btn = document.getElementById('btn-archive-toggle');
            const ind = document.getElementById('archive-indicator');
            const desc = document.getElementById('current-tab-desc');

            // Safety Check
            if (!btn || !ind || !desc) return;

            if (activeFilter === 'all') {
                // --- ENABLE ARCHIVE MODE ---
                activeFilter = 'archived';

                // UI Updates
                btn.classList.add('text-red-400', 'bg-red-500/10', 'border-red-500/20');
                ind.classList.remove('hidden');
                desc.innerHTML = '<span class="text-red-400 font-bold">VIEWING ARCHIVED LEADS</span>';

                // CRITICAL FIX: Fetch archived data from DB instead of just re-rendering
                subscribeToLeads();
            } else {
                // --- DISABLE ARCHIVE MODE ---
                activeFilter = 'all';

                // UI Reset
                btn.classList.remove('text-red-400', 'bg-red-500/10', 'border-red-500/20');
                ind.classList.add('hidden');

                // Restore original view (Refetches normal leads)
                window.switchTab(activeTab);
            }
        };

        // ==========================================
        // CREATE FOLDER LOGIC (MODAL)
        // ==========================================
        window.promptNewTab = () => {
            document.getElementById('create-folder-modal').classList.remove('hidden');
            document.getElementById('create-folder-modal').classList.add('flex');
            setTimeout(() => document.getElementById('create-folder-input').focus(), 100);
        };

        window.closeCreateFolderModal = () => {
            const modal = document.getElementById('create-folder-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('create-folder-input').value = ''; // Reset
        };

        window.confirmCreateFolder = async () => {
            const input = document.getElementById('create-folder-input');
            const name = input.value.trim();

            if (!name) return;
            if (clientTabs.includes(name)) {
                alert("A folder with this name already exists.");
                return;
            }

            window.closeCreateFolderModal(); // Close immediately for better UX

            // Save to Firestore
            const newTabs = [...clientTabs, name].filter(t => t !== 'General');

            try {
                const user = authInstance.currentUser;
                if (!user) return;

                // Optimistic UI Update
                clientTabs.push(name);
                renderTabsUI();

                await updateDoc(doc(db, "clients", user.uid), {
                    tabs: newTabs
                });

                // Switch to new tab
                window.switchTab(name);

            } catch (e) {
                console.error(e);
                alert("Error creating folder: " + e.message);
                // Revert on failure
                clientTabs = clientTabs.filter(t => t !== name);
                renderTabsUI();
            }
        };
        // ==========================================
        // EMERGENCY CLEAR ALL
        // ==========================================
        // ==========================================
        // CLEAR DATA (CURRENT TAB ONLY)
        // ==========================================
        window.clearCurrentTab = async () => {
            // 1. Identify what we are deleting
            const leadsToDelete = getFilteredLeads(); // Reuses the current view/filter logic
            const count = leadsToDelete.length;

            if (count === 0) {
                alert("No leads found in this view to delete.");
                return;
            }

            let confirmMsg = "";
            let confirmTitle = "";

            if (activeTab && clientTabs.includes(activeTab)) {
                confirmTitle = `Clear Folder "${activeTab}"?`;
                confirmMsg = `This will permanently delete <b class="text-white">${count} leads</b> from this folder.<br>This cannot be undone.`;
            } else {
                confirmTitle = "Clear Current View?";
                confirmMsg = `This will permanently delete <b class="text-white">${count} leads</b> visible in this view.<br>This cannot be undone.`;
            }

            // 2. Double Confirmation
            const confirm1 = await window.customConfirm(confirmMsg, confirmTitle);
            if (!confirm1) return;

            // 3. UI Loading State
            const content = document.querySelector('.data-table');
            if (content) content.style.opacity = '0.3';

            try {
                // Delete in batches (Firestore limit 500)
                const batchSize = 400;
                let deleted = 0;

                for (let i = 0; i < count; i += batchSize) {
                    const chunk = leadsToDelete.slice(i, i + batchSize);
                    const promises = chunk.map(l => deleteDoc(doc(db, "leads", l.id)));
                    await Promise.all(promises);
                    deleted += chunk.length;
                }

                // Removed the alert for smoother UX, just refresh
                // alert(`Successfully cleared ${deleted} leads.`);
            } catch (err) {
                console.error(err);
                alert("Error clearing data: " + err.message);
            } finally {
                if (content) content.style.opacity = '1';
                // Close dropdown if open
                const dropdown = document.getElementById('settings-dropdown');
                if (dropdown) dropdown.classList.add('hidden');
            }
        };

        // Close settings dropdown on click outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('settings-dropdown');
            const trigger = document.querySelector('button[title="Data Settings"]');
            if (dropdown && !dropdown.classList.contains('hidden')) {
                if (!dropdown.contains(e.target) && (!trigger || !trigger.contains(e.target))) {
                    dropdown.classList.add('hidden');
                }
            }
        });

        // ADMIN TOOL: TRIGGER MIGRATION
        window.triggerMigration = async () => {
            const user = authInstance.currentUser;
            if (!user) { console.error("Not logged in"); return; }
            const token = await user.getIdToken();
            console.log("Starting Migration...");
            try {
                // Added ?secret=ReputiflyFastFix for temporary auth bypass
                const res = await fetch(`${API_BASE}/migrateData?secret=ReputiflyFastFix`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                const data = await res.json();
                console.log("Migration Result:", data);
                alert("Migration Completed: " + JSON.stringify(data));
            } catch (e) {
                console.error(e);
                alert("Migration Failed: " + e.message);
            }
        };


        // ==========================================
        // AI INSIGHTS (Reputifly AI)
        // ==========================================
        window.generateInsights = async () => {
            if (!clientLeads || clientLeads.length === 0) {
                alert('No leads loaded yet.');
                return;
            }

            const modal = document.getElementById('ai-insights-modal');
            const contentEl = document.getElementById('ai-insights-content');
            const loadingEl = document.getElementById('ai-insights-loading');

            modal.classList.add('open');
            loadingEl.classList.remove('hidden');
            contentEl.classList.add('hidden');
            contentEl.innerHTML = '';

            try {
                const leadSummary = clientLeads.map(l => {
                    const clean = {};
                    Object.entries(l).forEach(([k, v]) => {
                        if (['id', 'clientId', 'uid'].includes(k)) return;
                        if (k === 'createdAt' && v?.seconds) {
                            clean[k] = new Date(v.seconds * 1000).toISOString();
                        } else if (k === 'metadata') {
                            clean[k] = v;
                        } else {
                            clean[k] = v;
                        }
                    });
                    return clean;
                });

                const user = authInstance.currentUser;
                const token = await user.getIdToken();
                const resp = await fetch(`${API_BASE}/analyzeLeads`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        leads: leadSummary,
                        context: {
                            clientEmail: clientEmail || 'Unknown',
                            totalLeads: clientLeads.length,
                            activeSource: activeTab || 'all',
                            sources: clientStats?.sources || {}
                        }
                    })
                });

                const data = await resp.json();
                if (!resp.ok || !data.success) {
                    throw new Error(data.error || 'Failed to generate insights');
                }

                const { insights } = data;
                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');

                const typeStyles = {
                    positive: { bg: 'bg-emerald-500/10', border: 'border-emerald-500/20', icon: 'trending-up', iconColor: 'text-emerald-400' },
                    warning: { bg: 'bg-amber-500/10', border: 'border-amber-500/20', icon: 'alert-triangle', iconColor: 'text-amber-400' },
                    info: { bg: 'bg-blue-500/10', border: 'border-blue-500/20', icon: 'info', iconColor: 'text-blue-400' }
                };

                contentEl.innerHTML = `
                    <div class="text-center mb-8">
                        <h2 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-purple-400 via-pink-400 to-orange-400 bg-clip-text text-transparent brand-font leading-relaxed">
                            ${insights.headline}
                        </h2>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-8">
                        ${insights.keyMetrics.map(m => `
                            <div class="bg-white/5 border border-white/10 rounded-2xl p-4 text-center hover:bg-white/10 transition-all duration-300 hover:scale-[1.02]">
                                <i data-feather="${m.icon}" class="w-5 h-5 text-purple-400 mx-auto mb-2"></i>
                                <div class="text-lg font-bold text-white mb-1">${m.value}</div>
                                <div class="text-[10px] text-gray-500 uppercase tracking-wider font-semibold">${m.label}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="space-y-3 mb-8">
                        ${insights.insights.map(i => {
                    const s = typeStyles[i.type] || typeStyles.info;
                    return `
                                <div class="${s.bg} border ${s.border} rounded-2xl p-3.5">
                                    <div class="flex items-start gap-3">
                                        <div>
                                            <h4 class="text-sm font-bold text-white mb-0.5">${i.title}</h4>
                                            <p class="text-xs text-gray-400 leading-relaxed">${i.body}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                    <div class="bg-gradient-to-br from-purple-500/10 to-pink-500/10 border border-purple-500/20 rounded-2xl p-5">
                        <h4 class="text-xs font-bold text-purple-300 uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i data-feather="target" class="w-3.5 h-3.5"></i> Recommended Actions
                        </h4>
                        <ul class="space-y-2">
                            ${insights.recommendations.map((r, idx) => `
                                <li class="flex items-start gap-2.5 text-xs text-gray-300">
                                    <span class="flex-shrink-0 mt-1.5 w-1.5 h-1.5 rounded-full bg-purple-400"></span>
                                    <span class="leading-relaxed">${r}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>

                `;
                feather.replace();
                // Show download button now that report is ready
                const pdfBtn = document.getElementById('header-pdf-btn');
                if (pdfBtn) pdfBtn.classList.remove('hidden');
            } catch (err) {
                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
                contentEl.innerHTML = `
                    <div class="text-center py-12">
                        <i data-feather="alert-circle" class="w-10 h-10 text-red-400 mx-auto mb-4"></i>
                        <h3 class="text-white font-bold mb-2">Analysis Failed</h3>
                        <p class="text-xs text-gray-500 mb-4">${err.message}</p>
                        <button onclick="generateInsights()" class="px-4 py-2 rounded-full bg-white/10 text-xs text-white hover:bg-white/20 transition">Try Again</button>
                    </div>
                `;
                feather.replace();
            }
        };

        window.closeInsightsModal = () => {
            document.getElementById('ai-insights-modal').classList.remove('open');
        };

        window.downloadInsightsPDF = async () => {
            const contentEl = document.getElementById('ai-insights-content');
            if (!contentEl || contentEl.classList.contains('hidden')) return;

            const btn = document.getElementById('header-pdf-btn');
            const origText = btn ? btn.innerHTML : '';
            if (btn) btn.innerHTML = '<span class="spinner w-3 h-3 border-2"></span>';

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageW = 210, pageH = 297, margin = 15;
                const contentW = pageW - margin * 2;
                const dateStr = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

                // Pre-load logo
                let logoImg = null;
                try {
                    const img = new Image(); img.crossOrigin = 'anonymous';
                    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = '/nexus/image.png'; });
                    logoImg = img;
                } catch (e) { console.warn('Logo load failed, continuing without'); }

                // --- Clone & prep content for capture ---
                const clone = contentEl.cloneNode(true);
                // Remove headline & download buttons
                const headline = clone.querySelector('.text-center.mb-8');
                if (headline) headline.remove();
                clone.querySelectorAll('button').forEach(b => { const p = b.closest('div.mt-8, div.flex.justify-center'); if (p) p.remove(); else b.remove(); });

                // Fix stat cards layout
                const grid = clone.querySelector('.grid');
                if (grid) {
                    grid.style.cssText = 'display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;';
                    Array.from(grid.children).forEach(card => {
                        card.style.cssText = 'background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:16px 12px;text-align:center;box-sizing:border-box;';
                    });
                }

                // Remove ALL icons from the entire clone (they don't render well in html2canvas)
                clone.querySelectorAll('svg, i[data-feather]').forEach(icon => icon.remove());

                // Fix flex containers that had icons â€” tighten gaps
                clone.querySelectorAll('.flex.items-start.gap-3').forEach(el => { el.style.gap = '0'; });

                // Build wrapper at exact A4 content width
                const wrapper = document.createElement('div');
                wrapper.style.cssText = 'position:fixed;top:-9999px;left:-9999px;width:794px;background:#0B0A14;color:#F0F0F0;font-family:Inter,sans-serif;padding:0 30px 30px;box-sizing:border-box;z-index:-1;';
                wrapper.appendChild(clone);
                document.body.appendChild(wrapper);

                // Capture full content
                const canvas = await html2canvas(wrapper, { backgroundColor: '#0B0A14', scale: 2, useCORS: true, logging: false });
                document.body.removeChild(wrapper);

                // --- Smart multi-page rendering ---
                const headerH = 22;  // mm for logo header
                const footerH = 12;  // mm for footer
                const usableH = pageH - margin - headerH - footerH;
                const imgTotalH = (canvas.height * contentW) / canvas.width;
                const scale = contentW / canvas.width;

                const drawHeader = (p) => {
                    p.setFillColor(11, 10, 20);
                    p.rect(0, 0, pageW, pageH, 'F');
                    // Logo image
                    if (logoImg) {
                        try { p.addImage(logoImg, 'PNG', margin, margin + 1, 26, 9); } catch (e) { }
                    } else {
                        // Fallback: text brand
                        p.setFontSize(14); p.setTextColor(230, 230, 235);
                        p.setFont('helvetica', 'bold');
                        p.text('Reputifly', margin, margin + 10);
                    }
                    // Date subtitle
                    p.setFontSize(7); p.setTextColor(120, 120, 130);
                    p.setFont('helvetica', 'normal');
                    p.text('AI Insights Report  Â·  ' + dateStr, pageW - margin, margin + 9, { align: 'right' });
                };

                const drawFooter = (p, pageNum, totalPages) => {
                    p.setFontSize(7); p.setTextColor(100, 100, 110);
                    p.text('Generated by Reputifly', margin, pageH - 8);
                    p.text('Page ' + pageNum + ' of ' + totalPages, pageW - margin, pageH - 8, { align: 'right' });
                    // Subtle line
                    p.setDrawColor(50, 50, 60); p.setLineWidth(0.2);
                    p.line(margin, pageH - 12, pageW - margin, pageH - 12);
                };

                // Calculate pages needed
                const totalPages = Math.max(1, Math.ceil(imgTotalH / usableH));
                const srcPxPerPage = usableH / scale; // source px per page

                for (let i = 0; i < totalPages; i++) {
                    if (i > 0) pdf.addPage();

                    drawHeader(pdf);

                    // Slice the canvas for this page
                    const srcY = Math.round(i * srcPxPerPage);
                    const srcH = Math.min(Math.round(srcPxPerPage), canvas.height - srcY);
                    if (srcH <= 0) break;

                    const sliceCanvas = document.createElement('canvas');
                    sliceCanvas.width = canvas.width;
                    sliceCanvas.height = srcH;
                    const ctx = sliceCanvas.getContext('2d');
                    ctx.drawImage(canvas, 0, srcY, canvas.width, srcH, 0, 0, canvas.width, srcH);

                    const sliceData = sliceCanvas.toDataURL('image/png');
                    const sliceH = srcH * scale;
                    pdf.addImage(sliceData, 'PNG', margin, margin + headerH, contentW, sliceH);

                    drawFooter(pdf, i + 1, totalPages);
                }

                pdf.save('Reputifly_AI_Report_' + new Date().toISOString().slice(0, 10) + '.pdf');

            } catch (err) {
                console.error('PDF generation error:', err);
                alert('Failed to generate PDF: ' + err.message);
            } finally {
                if (btn) btn.innerHTML = origText;
            }
        };


    </script>

    <!-- AI INSIGHTS MODAL -->
    <div id="ai-insights-modal" class="modal-backdrop" style="z-index: 10005;">
        <div class="modal-content" style="max-width: 900px; max-height: 85vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white brand-font flex items-center gap-2">
                    <i data-feather="zap" class="w-5 h-5 text-purple-400"></i> AI Insights
                </h3>
                <div class="flex items-center gap-1">
                    <button id="header-pdf-btn" onclick="downloadInsightsPDF()"
                        class="hidden w-8 h-8 rounded-lg flex items-center justify-center text-gray-500 hover:text-purple-400 hover:bg-white/5 transition-all duration-200"
                        title="Download PDF">
                        <i data-feather="download" class="w-4 h-4"></i>
                    </button>
                    <button onclick="closeInsightsModal()"
                        class="w-8 h-8 rounded-lg flex items-center justify-center text-gray-500 hover:text-white hover:bg-white/5 transition-all duration-200">
                        <i data-feather="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
            <div id="ai-insights-loading" class="hidden">
                <div class="text-center py-8">
                    <div
                        class="inline-flex items-center gap-3 bg-purple-500/10 border border-purple-500/20 rounded-full px-5 py-2.5 mb-6">
                        <div class="w-4 h-4 border-2 border-purple-400 border-t-transparent rounded-full animate-spin">
                        </div>
                        <span class="text-xs text-purple-300 font-semibold">Analyzing with Reputifly AI...</span>
                    </div>
                </div>
                <div class="space-y-4 animate-pulse">
                    <div class="h-8 bg-white/5 rounded-xl w-3/4 mx-auto"></div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div class="h-20 bg-white/5 rounded-2xl"></div>
                        <div class="h-20 bg-white/5 rounded-2xl"></div>
                        <div class="h-20 bg-white/5 rounded-2xl"></div>
                        <div class="h-20 bg-white/5 rounded-2xl"></div>
                    </div>
                    <div class="h-24 bg-white/5 rounded-2xl"></div>
                    <div class="h-24 bg-white/5 rounded-2xl"></div>
                    <div class="h-32 bg-white/5 rounded-2xl"></div>
                </div>
            </div>
            <div id="ai-insights-content" class="hidden"></div>
        </div>
    </div>
</body>

</html>
