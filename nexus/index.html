<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reputifly | Master Nexus</title>
    
    <link rel="icon" type="image/png" href="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        :root {
            --bg-deep: #0B0A14;
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(20, 20, 30, 0.6);
        }

        /* --- OPTIMIZED BACKGROUND --- */
        body {
            /* Slick Dark Linear Gradient (Horizontal/X-Axis) */
            background: linear-gradient(90deg, #050505 0%, #111018 50%, #050505 100%);
            color: #F0F0F0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3, .brand-font { font-family: 'Space Grotesk', sans-serif; letter-spacing: -0.02em; }

        /* --- HIDE SCROLLBAR (BUT KEEP SCROLLING) --- */
        /* Chrome, Safari and Opera */
        ::-webkit-scrollbar {
            display: none;
        }
        /* IE, Edge and Firefox */
        html, body {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* --- COMPONENTS --- */
        .glass-panel {
            background: var(--glass-bg);
            /* Minimal blur for performance */
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
            border-radius: 16px;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        /* Primary Button */
        .btn-liquid-glow {
            background: linear-gradient(90deg, #E6397F, #FF8A00);
            box-shadow: 0 4px 15px rgba(230, 57, 127, 0.4);
            border: none; position: relative; overflow: hidden;
            transition: all 0.2s ease;
            border-radius: 9999px;
            color: white; font-weight: 700; font-size: 13px;
            padding: 10px 24px;
            display: inline-flex; align-items: center; gap: 8px; cursor: pointer;
        }
        .btn-liquid-glow:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(230, 57, 127, 0.5);
            filter: brightness(1.1);
        }

        /* Secondary Button */
        .btn-hero-glass {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
            border-radius: 9999px;
            color: #ccc; font-weight: 600; font-size: 13px;
            padding: 8px 20px;
            display: inline-flex; align-items: center; gap: 6px; cursor: pointer;
        }
        .btn-hero-glass:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* --- TABLE STYLES --- */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .data-table th {
            text-align: left; padding: 16px 24px;
            color: #6b7280; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600;
            border-bottom: 1px solid var(--glass-border);
            white-space: nowrap;
        }
        .data-table td {
            padding: 16px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            font-size: 14px; color: #e0e0e0; vertical-align: middle;
        }
        .data-table tr:hover td { background: rgba(255,255,255,0.02); }
        .data-table tr:last-child td { border-bottom: none; }

        /* Badges */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge-new { background: rgba(16, 185, 129, 0.1); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2); }
        .badge-junk { background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }
        .badge-contacted { background: rgba(59, 130, 246, 0.1); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.2); }

        .view-section { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .view-section.active { display: block; opacity: 1; }
    </style>
</head>
<body>

    <nav class="border-b border-white/5 bg-black/20 backdrop-blur-md sticky top-0 z-40">
        <div class="w-full max-w-[95%] mx-auto h-20 flex items-center justify-between">
            <div class="flex items-center gap-4 cursor-pointer" onclick="showOverview()">
                 <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png" class="h-8 w-auto brightness-125 hover:scale-105 transition-transform" alt="Reputifly Logo">
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="window.location.reload()" class="btn-hero-glass p-2"><i data-feather="refresh-cw" class="w-4 h-4"></i></button>
                <div class="h-2 w-2 rounded-full bg-green-500 animate-pulse"></div>
            </div>
        </div>
    </nav>

    <main class="w-full max-w-[95%] mx-auto py-12 relative z-10">

        <div id="view-overview" class="view-section active">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-white mb-2 brand-font">Client Portfolio</h1>
                    <p class="text-gray-400 text-sm">Overview of all connected client databases.</p>
                </div>
                <button onclick="exportAllCSV()" class="btn-hero-glass">
                    <i data-feather="download-cloud" class="w-4 h-4"></i> Export All Data
                </button>
            </div>

            <div class="glass-panel overflow-hidden min-h-[600px] flex flex-col">
                <div class="overflow-x-auto flex-grow">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Client Identity</th>
                                <th>Total Leads</th>
                                <th>Last Active</th>
                                <th class="text-right">Manage</th>
                            </tr>
                        </thead>
                        <tbody id="overview-table-body">
                            <tr><td colspan="4" class="text-center py-20 text-gray-500">Connecting...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-detail" class="view-section">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                <div>
                    <button onclick="showOverview()" class="text-xs text-gray-500 hover:text-white flex items-center gap-1 mb-2 transition-colors">
                        <i data-feather="arrow-left" class="w-3 h-3"></i> Back to Overview
                    </button>
                    <h1 class="text-2xl font-bold text-white flex items-center gap-3 brand-font">
                        <span id="detail-client-name">Client Name</span>
                    </h1>
                </div>
                <button id="btn-export-single" class="btn-liquid-glow">
                    <i data-feather="download" class="w-4 h-4"></i> Export CSV
                </button>
            </div>

            <div class="glass-panel overflow-hidden min-h-[600px] flex flex-col">
                <div class="overflow-x-auto flex-grow">
                    <table class="data-table">
                        <thead id="detail-table-head">
                            </thead>
                        <tbody id="detail-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyC9eUHEdAmV9qzHxpQe2en5WeOeRXiq10A",
            authDomain: "b2b-software.firebaseapp.com",
            projectId: "b2b-software",
            storageBucket: "b2b-software.firebasestorage.app",
            messagingSenderId: "231187362713",
            appId: "1:231187362713:web:07f2f24b3c79557f7a9908"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // STATE
        let allLeads = [];
        let clientMap = {}; 
        let currentClient = null;

        // --- CORE LOGIC ---
        const q = query(collection(db, "leads"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            allLeads = [];
            clientMap = {};

            snapshot.forEach((doc) => {
                const data = doc.data();
                const lead = { id: doc.id, ...data };
                const cId = lead.clientId || lead.to || 'Unknown';
                
                lead.clientId = cId; 
                allLeads.push(lead);

                if (!clientMap[cId]) clientMap[cId] = [];
                clientMap[cId].push(lead);
            });

            renderOverview();
            if (currentClient) renderDetail(currentClient);
        });

        // 1. OVERVIEW
        function renderOverview() {
            const tbody = document.getElementById('overview-table-body');
            tbody.innerHTML = '';
            
            const clients = Object.keys(clientMap);

            if (clients.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-20 text-gray-500">No data found.</td></tr>`;
                return;
            }

            clients.forEach(cId => {
                const leads = clientMap[cId];
                const lastLead = leads[0]; 
                const dateStr = lastLead.createdAt ? new Date(lastLead.createdAt.seconds * 1000).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : 'N/A';

                const tr = document.createElement('tr');
                tr.className = "transition-colors duration-200 group hover:bg-white/5 cursor-pointer";
                tr.onclick = (e) => {
                    if(e.target.closest('button')) return;
                    window.viewClient(cId);
                };

                tr.innerHTML = `
                    <td>
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-gray-800 to-black flex items-center justify-center text-xs font-bold text-white border border-white/10 shadow-inner">
                                ${cId.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div class="text-sm font-bold text-white">${cId}</div>
                                <div class="text-[10px] text-gray-500 font-mono">ID: ${cId}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="bg-white/5 border border-white/5 text-gray-300 px-3 py-1 rounded text-xs font-mono font-bold">${leads.length}</span></td>
                    <td class="text-sm text-gray-400">${dateStr}</td>
                    <td class="text-right">
                        <div class="flex items-center justify-end gap-2">
                            <button onclick="window.viewClient('${cId}')" class="btn-hero-glass">View</button>
                            <button onclick="window.exportSingle('${cId}')" class="p-2 hover:bg-white/10 rounded-full text-gray-400 hover:text-white transition"><i data-feather="download" class="w-4 h-4"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            feather.replace();
        }

        // 2. DYNAMIC DETAIL TABLE
        function renderDetail(clientId) {
            const tbody = document.getElementById('detail-table-body');
            const thead = document.getElementById('detail-table-head');
            const title = document.getElementById('detail-client-name');
            const leads = clientMap[clientId] || [];

            title.innerText = clientId;
            tbody.innerHTML = '';
            thead.innerHTML = '';

            if (leads.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-20 text-gray-500">No leads found.</td></tr>`;
                return;
            }

            // A. DISCOVER ALL KEYS
            let columns = new Set();
            leads.forEach(lead => {
                if(lead.lead) {
                    Object.keys(lead.lead).forEach(k => columns.add(k));
                }
            });
            let colArray = Array.from(columns);
            const priority = ['name', 'email', 'phone'];
            colArray.sort((a, b) => {
                const aP = priority.indexOf(a.toLowerCase());
                const bP = priority.indexOf(b.toLowerCase());
                if(aP !== -1 && bP !== -1) return aP - bP;
                if(aP !== -1) return -1;
                if(bP !== -1) return 1;
                return a.localeCompare(b);
            });

            // B. BUILD HEADER
            let headerHTML = `<tr><th>Date</th>`;
            colArray.forEach(col => {
                headerHTML += `<th>${col.charAt(0).toUpperCase() + col.slice(1)}</th>`;
            });
            headerHTML += `<th>Status</th><th class="text-right">Actions</th></tr>`;
            thead.innerHTML = headerHTML;

            // C. BUILD ROWS
            leads.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "transition-colors duration-200 group";
                
                const dateStr = item.createdAt ? new Date(item.createdAt.seconds * 1000).toLocaleDateString('en-GB') : 'N/A';
                
                let badgeClass = 'badge-new';
                if(item.status === 'junk') badgeClass = 'badge-junk';
                if(item.status === 'contacted') badgeClass = 'badge-contacted';

                let rowHTML = `<td class="font-mono text-[11px] text-gray-500">${dateStr}</td>`;
                
                colArray.forEach(col => {
                    let val = item.lead ? (item.lead[col] || '-') : '-';
                    if(col.toLowerCase() === 'email') val = `<span class="text-white">${val}</span>`;
                    if(col.toLowerCase() === 'name') val = `<span class="font-bold text-white">${val}</span>`;
                    rowHTML += `<td class="text-sm text-gray-400">${val}</td>`;
                });

                rowHTML += `
                    <td><span class="badge ${badgeClass}">${item.status || 'new'}</span></td>
                    <td class="text-right">
                        <div class="flex items-center justify-end gap-2 opacity-60 group-hover:opacity-100 transition">
                            <button onclick="window.updateStatus('${item.id}', 'junk')" class="p-2 hover:bg-red-500/10 rounded-lg text-gray-500 hover:text-red-400 transition"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                            <button onclick="window.updateStatus('${item.id}', 'contacted')" class="p-2 hover:bg-blue-500/10 rounded-lg text-gray-500 hover:text-blue-400 transition"><i data-feather="check-square" class="w-4 h-4"></i></button>
                            <button onclick="window.deleteLead('${item.id}')" class="p-2 hover:bg-white/10 rounded-lg text-gray-500 hover:text-white transition"><i data-feather="x" class="w-4 h-4"></i></button>
                        </div>
                    </td>`;
                
                tr.innerHTML = rowHTML;
                tbody.appendChild(tr);
            });
            feather.replace();
        }

        // --- GLOBAL ACTIONS ---
        window.viewClient = (cId) => {
            currentClient = cId;
            document.getElementById('view-overview').classList.remove('active');
            setTimeout(() => {
                document.getElementById('view-detail').classList.add('active');
                renderDetail(cId);
            }, 100);
        };

        window.showOverview = () => {
            currentClient = null;
            document.getElementById('view-detail').classList.remove('active');
            setTimeout(() => {
                document.getElementById('view-overview').classList.add('active');
                renderOverview();
            }, 100);
        };

        window.updateStatus = async (docId, newStatus) => {
            try { await updateDoc(doc(db, "leads", docId), { status: newStatus }); } catch (e) { alert("Error: " + e.message); }
        };

        window.deleteLead = async (docId) => {
            if(!confirm("Permanently delete?")) return;
            try { await deleteDoc(doc(db, "leads", docId)); } catch(e) { alert("Error: " + e.message); }
        };

        const generateCSV = (data, filename) => {
            if(!data.length) return;
            
            let columns = new Set();
            data.forEach(d => d.lead && Object.keys(d.lead).forEach(k => columns.add(k)));
            let colArray = Array.from(columns);

            let csv = "Date,Client ID," + colArray.join(",") + ",Status\n";

            data.forEach(row => {
                const date = row.createdAt ? new Date(row.createdAt.seconds * 1000).toISOString() : '';
                let line = [date, row.clientId];
                
                colArray.forEach(col => {
                    const val = row.lead ? (row.lead[col] || '') : '';
                    line.push(`"${val.replace(/"/g, '""')}"`);
                });
                
                line.push(row.status);
                csv += line.join(",") + "\n";
            });

            const link = document.createElement("a");
            link.href = encodeURI("data:text/csv;charset=utf-8," + csv);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.exportSingle = (cId) => {
            const data = clientMap[cId] || [];
            if(!data.length) return alert("No data.");
            generateCSV(data, `Reputifly_${cId}.csv`);
        };

        window.exportAllCSV = () => {
            if(!allLeads.length) return alert("No data.");
            generateCSV(allLeads, "Reputifly_Master.csv");
        };

        document.getElementById('btn-export-single').onclick = () => {
            if(currentClient) window.exportSingle(currentClient);
        };

        feather.replace();
    </script>
</body>
</html>
