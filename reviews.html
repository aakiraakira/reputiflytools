<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner AI Review Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXdjRQZJd9ySH5mxql4tlXCEVpDH9GGbI&libraries=places&callback=initOwnerPortal"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; overflow-x: hidden; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 50% { opacity: .5; } }
        @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideOutDown { to { transform: translateY(100%); opacity: 0; } }

        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .spinner { animation: spin 1s linear infinite; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .slide-in-up { animation: slideInUp 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .slide-out-down { animation: slideOutDown 0.5s cubic-bezier(0.5, 0, 0.75, 0) forwards; }

        .pac-container { background-color: #1f2937; border: 1px solid #4b5563; border-radius: 0.5rem; color: #d1d5db; z-index: 10000 !important; font-family: 'Inter', sans-serif; }
        .pac-item { padding: 0.75rem; cursor: pointer; border-top: 1px solid #374151; }
        .pac-item:first-child { border-top: none; }
        .pac-item:hover { background-color: #374151; }
        .pac-item-query { font-weight: 500; color: #f9fafb; }
        
        #map { height: 350px; border-radius: 0.75rem; background-color: #374151; }
        .hidden { display: none; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Chatbot Styles */
        #chatbot-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 1000; }
        #chatbot-popup { position: fixed; bottom: 6rem; right: 2rem; width: 90vw; max-width: 400px; height: 70vh; max-height: 600px; background-color: #1f2937; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); display: flex; flex-direction: column; overflow: hidden; border: 1px solid #374151; transform-origin: bottom right; }
        .chat-message { max-width: 85%; padding: 0.75rem 1rem; border-radius: 1rem; word-wrap: break-word; }
        .chat-message.user { background-color: #3b82f6; color: white; border-bottom-right-radius: 0.25rem; align-self: flex-end; }
        .chat-message.ai { background-color: #374151; color: #d1d5db; border-bottom-left-radius: 0.25rem; align-self: flex-start; }
    </style>
</head>
<body class="text-gray-200">

    <div id="app" class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
        <div id="owner-view"></div>
    </div>

    <div id="chatbot-container">
        <button id="chatbot-toggle" class="w-16 h-16 bg-teal-600 rounded-full flex items-center justify-center text-white shadow-lg hover:bg-teal-500 transition-transform transform hover:scale-110">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5z" clip-rule="evenodd" /><path d="M6 8a1 1 0 011-1h1a1 1 0 110 2H7a1 1 0 01-1-1zm5 0a1 1 0 011-1h1a1 1 0 110 2h-1a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
        </button>
        <div id="chatbot-popup" class="hidden">
            <header class="p-4 bg-gray-800 border-b border-gray-700 flex justify-between items-center"><h3 class="font-bold text-white">AI Review Assistant</h3><button id="chatbot-close" class="text-gray-400 hover:text-white">&times;</button></header>
            <div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-auto"><div class="chat-message ai">Hello! Ask me to generate some reviews.</div></div>
            <footer class="p-4 bg-gray-800 border-t border-gray-700"><div class="flex gap-2"><input type="text" id="chat-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg" placeholder="e.g., Craft 5 reviews..."><button id="chat-send" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg">Send</button></div></footer>
        </div>
    </div>
    
    <div id="notification" class="hidden fixed bottom-5 right-5 bg-gray-800 border border-gray-700 text-white py-3 px-5 rounded-lg shadow-xl z-[10001]"></div>
    
    <script>
        function initOwnerPortal() {
            document.dispatchEvent(new Event('google-maps-loaded'));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                state: {
                    mapsInitialized: false,
                    ownerState: {
                        activeTab: 'submitter',
                        selectedPlace: { name: '', address: '', reviewLink: '', startingCount: 0, reviews: [], placeId: '' },
                        reviews: [], // User-processed reviews for submitter tab
                        bulkText: '',
                        promptGenerator: {
                            reviewPoints: '', 
                            geminiApiKey: localStorage.getItem('geminiApiKey') || '',
                            isGenerating: false,
                            generatedReviews: ''
                        },
                        sheetRow: { dailyReviews: '', reviewsOrdered: '', output: '' },
                        chatbot: {
                           isOpen: false,
                           messages: [{role: 'ai', content: 'Hello! Ask me to generate some reviews.'}]
                        }
                    }
                },
                elements: {
                    ownerView: document.getElementById('owner-view'),
                    notification: document.getElementById('notification'),
                    chatbotToggle: document.getElementById('chatbot-toggle'),
                    chatbotPopup: document.getElementById('chatbot-popup'),
                    chatbotClose: document.getElementById('chatbot-close'),
                    chatMessages: document.getElementById('chat-messages'),
                    chatInput: document.getElementById('chat-input'),
                    chatSend: document.getElementById('chat-send'),
                },
                
                init() {
                    this.renderOwnerView(); // Load owner view directly
                    this.attachListeners();
                    document.addEventListener('google-maps-loaded', () => {
                        this.state.mapsInitialized = true;
                        this.initializeOwnerViewMaps(); // Initialize maps for the visible tabs
                    });
                },

                attachListeners() {
                    this.elements.ownerView.addEventListener('click', this.handleOwnerClick.bind(this));
                    this.elements.ownerView.addEventListener('input', this.handleOwnerInput.bind(this));
                    this.elements.chatbotToggle.addEventListener('click', this.toggleChatbot.bind(this));
                    this.elements.chatbotClose.addEventListener('click', this.toggleChatbot.bind(this));
                    this.elements.chatSend.addEventListener('click', this.handleChatSend.bind(this));
                    this.elements.chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.handleChatSend();
                    });
                },

                // --- Google Maps Integration ---
                initializeOwnerViewMaps() {
                    if (!this.state.mapsInitialized) return;
                    setTimeout(() => {
                        if (this.state.ownerState.activeTab === 'submitter') {
                            this.initAutocomplete('owner-link-input', this.handleOwnerPlaceSelection.bind(this));
                        }
                        if (this.state.ownerState.activeTab === 'tools') {
                            this.initPlaceIdFinderMap();
                        }
                    }, 100);
                },

                initAutocomplete(inputId, callback) {
                    const input = document.getElementById(inputId);
                    if (!input || input.dataset.acAttached) return;
                    const autocomplete = new google.maps.places.Autocomplete(input, {
                        fields: ["place_id", "name", "formatted_address", "reviews", "user_ratings_total", "url"],
                        types: ["establishment"]
                    });
                    input.dataset.acAttached = 'true';
                    autocomplete.addListener('place_changed', () => callback(autocomplete.getPlace()));
                },
                 
                initPlaceIdFinderMap() {
                    if (!this.state.mapsInitialized) return;
                    const mapEl = document.getElementById("map");
                    const inputEl = document.getElementById("pac-input");
                    if (!mapEl || !inputEl || inputEl.dataset.acAttached || mapEl.firstChild) return;

                    const map = new google.maps.Map(mapEl, { center: { lat: 1.3521, lng: 103.8198 }, zoom: 11 });
                    const autocomplete = new google.maps.places.Autocomplete(inputEl, { fields: ["place_id", "geometry", "name", "reviews", "user_ratings_total"] });
                    autocomplete.bindTo("bounds", map);
                    inputEl.dataset.acAttached = 'true';
                    const marker = new google.maps.Marker({ map: map });
                    autocomplete.addListener("place_changed", () => {
                        marker.setVisible(false);
                        const place = autocomplete.getPlace();
                        if (place.geometry) {
                           if (place.geometry.viewport) map.fitBounds(place.geometry.viewport);
                           else { map.setCenter(place.geometry.location); map.setZoom(17); }
                           marker.setPosition(place.geometry.location);
                           marker.setVisible(true);
                        }
                        this.handleOwnerPlaceSelection(place); 
                    });
                },

                handleOwnerPlaceSelection(place) {
                    if (!place || !place.place_id) {
                        this.showNotification("Could not retrieve details.", "error");
                        return;
                    }
                    const { ownerState } = this.state;
                    ownerState.selectedPlace.name = place.name || '';
                    ownerState.selectedPlace.address = place.formatted_address || '';
                    ownerState.selectedPlace.placeId = place.place_id;
                    ownerState.selectedPlace.reviewLink = `https://search.google.com/local/writereview?placeid=${place.place_id}`;
                    ownerState.selectedPlace.startingCount = place.user_ratings_total || 0;
                    
                    if (place.reviews && place.reviews.length > 0) {
                        const positiveReviews = place.reviews.filter(r => r.rating >= 4).map(r => r.text);
                        ownerState.selectedPlace.reviews = positiveReviews;
                        ownerState.promptGenerator.reviewPoints = positiveReviews.join('\n\n---\n\n');
                    } else {
                        ownerState.selectedPlace.reviews = [];
                        ownerState.promptGenerator.reviewPoints = 'No recent positive reviews found. You can paste your own points manually.';
                    }
                    
                    this.showNotification(`Selected: ${place.name}`, "success");
                    this.renderOwnerView();
                },

                // --- Gemini AI Integration ---
                async callGeminiApi(prompt, model = 'gemini-1.5-flash-latest') {
                    const apiKey = this.state.ownerState.promptGenerator.geminiApiKey;
                    if (!apiKey) {
                        this.showNotification("Please enter your AI API Key.", "error");
                        return null;
                    }
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        return data.candidates[0].content.parts[0].text;
                    } catch (error) {
                        this.showNotification(`AI Error: ${error.message}`, "error");
                        return null;
                    }
                },
                
                async handleGenerateReviews() {
                    const { promptGenerator, selectedPlace } = this.state.ownerState;
                    if (promptGenerator.isGenerating) return;

                    const quantity = document.getElementById('review-quantity')?.value || 10;
                    const model = document.getElementById('ai-model')?.value === 'pro' ? 'gemini-1.5-pro-latest' : 'gemini-1.5-flash-latest';
                    
                    this.state.ownerState.promptGenerator.isGenerating = true;
                    this.state.ownerState.promptGenerator.generatedReviews = '';
                    this.renderOwnerView();

                    let keywords = [selectedPlace.name, ...selectedPlace.address.split(',').map(s => s.trim())].filter(Boolean);
                    if(selectedPlace.reviews.length > 0) {
                        const reviewText = selectedPlace.reviews.join(' ');
                        const commonWords = reviewText.toLowerCase().match(/\b(\w+)\b/g) || [];
                        const wordCounts = commonWords.reduce((acc, word) => {
                            if(word.length > 4) acc[word] = (acc[word] || 0) + 1;
                            return acc;
                        }, {});
                        const sortedKeywords = Object.keys(wordCounts).sort((a,b) => wordCounts[b] - wordCounts[a]).slice(0, 5);
                        keywords.push(...sortedKeywords);
                    }
                    keywords = [...new Set(keywords)].join(', ');

                    let finalPrompt = `Based on the following points, craft ${quantity} positive reviews.
                    Business Name: ${selectedPlace.name || 'the business'}
                    Location context: ${selectedPlace.address || 'the local area'}
                    Key SEO Terms to include naturally: ${keywords || 'good service, great experience'}
                    Review points to expand on:\n- ${promptGenerator.reviewPoints || 'General positive experience'}
                    
                    Strict requirements:
                    - Vary review length: some short, some medium, some long and detailed.
                    - Vary sentence structure and tone to sound like different people.
                    - Do NOT number the reviews. Separate each review with a new line.`;
                    
                    const generatedText = await this.callGeminiApi(finalPrompt, model);

                    this.state.ownerState.promptGenerator.isGenerating = false;
                    this.state.ownerState.promptGenerator.generatedReviews = generatedText || '';
                    this.renderOwnerView();
                },

                // --- Chatbot Logic ---
                toggleChatbot() {
                    const { chatbot } = this.state.ownerState;
                    chatbot.isOpen = !chatbot.isOpen;
                    if (chatbot.isOpen) {
                        this.elements.chatbotPopup.classList.remove('hidden');
                        this.elements.chatbotPopup.classList.remove('slide-out-down');
                        this.elements.chatbotPopup.classList.add('slide-in-up');
                    } else {
                        this.elements.chatbotPopup.classList.remove('slide-in-up');
                        this.elements.chatbotPopup.classList.add('slide-out-down');
                        setTimeout(() => this.elements.chatbotPopup.classList.add('hidden'), 500);
                    }
                },

                async handleChatSend() {
                    const userInput = this.elements.chatInput.value.trim();
                    if (!userInput || this.state.ownerState.promptGenerator.isGenerating) return;
                    this.addChatMessage('user', userInput);
                    this.elements.chatInput.value = '';
                    this.state.ownerState.promptGenerator.isGenerating = true;
                    this.renderChatMessages();

                    const chatPrompt = `The user wants reviews based on this request: "${userInput}".
                    If a business is selected, use its details.
                    Business Name: ${this.state.ownerState.selectedPlace.name || 'Not specified'}
                    Business Address: ${this.state.ownerState.selectedPlace.address || 'Not specified'}
                    Generate the reviews directly.`;

                    const aiResponse = await this.callGeminiApi(chatPrompt);
                    this.addChatMessage('ai', aiResponse || "Sorry, I couldn't generate a response.");
                    this.state.ownerState.promptGenerator.isGenerating = false;
                    this.renderChatMessages();
                },

                addChatMessage(role, content) {
                    this.state.ownerState.chatbot.messages.push({ role, content });
                    this.renderChatMessages();
                },

                renderChatMessages() {
                    this.elements.chatMessages.innerHTML = this.state.ownerState.chatbot.messages.map(msg => `
                        <div class="chat-message ${msg.role} fade-in">${msg.content.replace(/\n/g, '<br>')}</div>
                    `).join('');
                    if(this.state.ownerState.promptGenerator.isGenerating) {
                        this.elements.chatMessages.innerHTML += `<div class="chat-message ai pulse">Generating...</div>`;
                    }
                    this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
                },

                // --- Event Handlers ---
                handleOwnerClick(e) {
                    const target = e.target.closest('button');
                    if (!target) return;
                    
                    const { ownerState } = this.state;

                    if (target.classList.contains('owner-tab-btn')) {
                        ownerState.activeTab = target.dataset.tab;
                        this.renderOwnerView();
                        this.initializeOwnerViewMaps();
                        return;
                    }
                    
                    // --- Submitter Tab ---
                    if (target.id === 'set-owner-link-btn') this.handleManualLinkSet();
                    if (target.id === 'process-bulk-reviews-btn') this.processBulkReviews();
                    if (target.id === 'reset-owner-reviews-btn') { ownerState.reviews = []; ownerState.bulkText = ''; this.renderOwnerView(); }
                    if (target.id === 'download-owner-file-btn') this.downloadSubmissionFile();
                    if (target.classList.contains('remove-review-btn')) { ownerState.reviews.splice(target.dataset.index, 1); this.renderOwnerView(); }
                    
                    // --- Prompt Generator Tab ---
                    if (target.id === 'save-api-key-btn') {
                        const key = document.getElementById('gemini-api-key')?.value || '';
                        localStorage.setItem('geminiApiKey', key);
                        ownerState.promptGenerator.geminiApiKey = key;
                        this.showNotification('API Key saved to browser storage.');
                    }
                    if (target.id === 'clear-api-key-btn') {
                        localStorage.removeItem('geminiApiKey');
                        ownerState.promptGenerator.geminiApiKey = '';
                        this.renderOwnerView();
                        this.showNotification('API Key cleared.');
                    }
                    if (target.id === 'generate-reviews-btn') this.handleGenerateReviews();
                    if (target.id === 'copy-reviews-btn') this.copyToClipboard(ownerState.promptGenerator.generatedReviews, 'Reviews copied!');
                    
                    // --- Tools Tab ---
                    if (target.id === 'copy-place-link-btn') this.copyToClipboard(ownerState.selectedPlace.reviewLink, "Place link copied!");
                    if (target.id === 'generate-sheet-row-btn') this.generateSheetRow();
                    if (target.id === 'copy-sheet-row-btn') this.copyToClipboard(ownerState.sheetRow.output, "Sheet row copied!");
                },

                handleOwnerInput(e) {
                    const { ownerState } = this.state;
                    const { id, value, dataset } = e.target;
                    
                    if (id === 'owner-bulk-textarea') ownerState.bulkText = value;
                    if (id === 'prompt-generator-input') ownerState.promptGenerator.reviewPoints = value;
                    if (id === 'generated-reviews-textarea') ownerState.promptGenerator.generatedReviews = value;
                    if (id === 'daily-reviews') ownerState.sheetRow.dailyReviews = value;
                    if (id === 'reviews-ordered') ownerState.sheetRow.reviewsOrdered = value;
                    if (dataset.view === 'owner' && e.target.classList.contains('content-input')) ownerState.reviews[dataset.index].text = value;
                },

                // --- Original Feature Methods ---
                handleManualLinkSet() {
                    const input = document.getElementById('owner-link-input');
                    if (input && input.value.trim() !== '') {
                        const { ownerState } = this.state;
                        ownerState.selectedPlace.name = input.value.trim();
                        ownerState.selectedPlace.placeId = 'manual_entry';
                        ownerState.selectedPlace.reviewLink = this.validateLink(input.value) ? input.value : '';
                        this.renderOwnerView();
                        this.showNotification(`Manually set location: ${ownerState.selectedPlace.name}`);
                    }
                },
                processBulkReviews() {
                    const { ownerState } = this.state;
                    const lines = ownerState.bulkText.split('\n').map(line => line.trim()).filter(Boolean);
                    ownerState.reviews = [...new Set(lines)].map(line => ({ text: line }));
                    this.showNotification(`${ownerState.reviews.length} unique reviews processed.`);
                    this.renderOwnerView();
                },
                downloadSubmissionFile() {
                    this.showPromptModal('Enter a filename', 'e.g., company_reviews', (filename) => {
                        if (!filename) { this.showNotification('Download cancelled.', 'error'); return; }
                        const data = { link: this.state.ownerState.selectedPlace.reviewLink, reviews: this.state.ownerState.reviews };
                        const dataBlob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        const a = document.createElement('a');
                        a.href = url; a.download = `${filename.replace(/\s+/g, '_')}.json`;
                        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                        this.showNotification('File downloaded!');
                    });
                },
                 generateSheetRow() {
                    const { name, startingCount } = this.state.ownerState.selectedPlace;
                    if (!name) { this.showNotification("Please select a company first.", "error"); return; }
                    const { sheetRow } = this.state.ownerState;
                    const daily = parseInt(sheetRow.dailyReviews, 10) || 0;
                    const ordered = parseInt(sheetRow.reviewsOrdered, 10) || 0;
                    const endingCount = startingCount + ordered;
                    sheetRow.output = `${name}\t${daily}\t0\t${ordered}\t${startingCount}\t${endingCount}\t\t${ordered}`;
                    this.renderOwnerView();
                    this.showNotification("Sheet row generated!");
                },

                // --- Rendering ---
                renderOwnerView() {
                    const { activeTab } = this.state.ownerState;
                    this.elements.ownerView.innerHTML = `
                        <header class="text-center mb-10 fade-in">
                            <h1 class="text-4xl sm:text-5xl font-bold text-white">Owner AI Portal</h1>
                            <p class="text-gray-400 mt-2">Find a business, craft a prompt, and generate reviews with AI.</p>
                        </header>
                        <div class="border-b border-gray-600 mb-6">
                            <nav class="-mb-px flex gap-4 overflow-x-auto" aria-label="Tabs">
                                <button data-tab="submitter" class="owner-tab-btn ${activeTab === 'submitter' ? 'border-teal-500 text-teal-400' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Review Submitter</button>
                                <button data-tab="promptGenerator" class="owner-tab-btn ${activeTab === 'promptGenerator' ? 'border-teal-500 text-teal-400' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">AI Prompt Studio</button>
                                <button data-tab="tools" class="owner-tab-btn ${activeTab === 'tools' ? 'border-teal-500 text-teal-400' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Place ID & Sheet Row</button>
                            </nav>
                        </div>
                        <div class="${activeTab !== 'submitter' ? 'hidden' : ''}">${this.renderOwnerSubmitterView()}</div>
                        <div class="${activeTab !== 'promptGenerator' ? 'hidden' : ''}">${this.renderOwnerPromptGeneratorView()}</div>
                        <div class="${activeTab !== 'tools' ? 'hidden' : ''}">${this.renderOwnerToolsView()}</div>`;
                },
                
                renderOwnerSubmitterView() {
                    const { selectedPlace, reviews, bulkText } = this.state.ownerState;
                    const isPlaceSelected = !!selectedPlace.placeId;
                    const areReviewsProcessed = reviews.length > 0;
                    return `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl">
                                     <h2 class="text-xl font-semibold text-white mb-4">Step 1: Find Business</h2>
                                     <div class="flex flex-col sm:flex-row gap-3">
                                         <input type="text" id="owner-link-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg" placeholder="Search or paste link..." value="${selectedPlace.name || ''}">
                                         <button id="set-owner-link-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg whitespace-nowrap">Set</button>
                                     </div>
                                </div>
                                <div class="mt-8 p-6 bg-gray-800 border border-gray-700 rounded-xl ${!isPlaceSelected || areReviewsProcessed ? 'hidden' : ''}">
                                    <h2 class="text-xl font-semibold text-white mb-4">Step 2: Paste All Reviews</h2>
                                    <textarea id="owner-bulk-textarea" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg h-60 resize-y" placeholder="Paste reviews here...">${bulkText}</textarea>
                                    <button id="process-bulk-reviews-btn" class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg">Process Reviews</button>
                                </div>
                            </div>
                            <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl ${!isPlaceSelected || !areReviewsProcessed ? 'hidden' : ''}">
                                <div class="mb-6 flex justify-between items-center">
                                    <h2 class="text-xl font-semibold text-white">Step 3: Manage Reviews (${reviews.length})</h2>
                                    <button id="reset-owner-reviews-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">Reset</button>
                                </div>
                                <div id="owner-reviews-container" class="max-h-[400px] overflow-y-auto pr-2">${this.renderReviewCards()}</div>
                                <div class="mt-8 pt-6 border-t border-gray-700"> <button id="download-owner-file-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg" ${reviews.length === 0 ? 'disabled' : ''}>Download Submission File</button> </div>
                            </div>
                        </div>`;
                },
                
                renderReviewCards() {
                    const { reviews } = this.state.ownerState;
                    if (reviews.length === 0) return '<p class="text-gray-400 text-center py-4">No reviews processed yet.</p>';
                    return reviews.map((review, index) => `
                        <div class="review-item bg-gray-900 p-4 rounded-lg mb-3">
                            <div class="flex justify-between items-start">
                                <textarea data-view="owner" data-index="${index}" class="content-input w-full p-2 bg-gray-800 border border-gray-700 rounded-lg h-24 resize-none">${review.text}</textarea>
                                <button data-view="owner" data-index="${index}" class="remove-review-btn text-gray-500 hover:text-red-500 font-bold text-2xl ml-2">&times;</button>
                            </div>
                        </div>
                    `).join('');
                },

                renderOwnerPromptGeneratorView() {
                    const { reviewPoints, geminiApiKey, isGenerating, generatedReviews } = this.state.ownerState.promptGenerator;
                     return `
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                             <div class="lg:col-span-1 space-y-8 fade-in">
                                <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl">
                                    <h2 class="text-xl font-semibold text-white mb-4">AI Configuration</h2>
                                    <div class="space-y-4">
                                        <div><label class="block text-sm mb-1">Your AI API Key</label><input type="password" id="gemini-api-key" class="w-full p-2 bg-gray-900 rounded-lg" value="${geminiApiKey}" placeholder="Paste key here"></div>
                                        <div class="flex gap-2"><button id="save-api-key-btn" class="flex-1 bg-teal-600 text-white py-2 rounded-lg text-sm">Save</button><button id="clear-api-key-btn" class="flex-1 bg-gray-600 text-white py-2 rounded-lg text-sm">Clear</button></div>
                                        <div><label class="block text-sm mb-1">AI Model</label><select id="ai-model" class="w-full p-2 bg-gray-900 rounded-lg"><option value="normal">Normal (Fast)</option><option value="pro">Pro (Advanced)</option></select></div>
                                        <div><label class="block text-sm mb-1">Quantity</label><input type="number" id="review-quantity" class="w-full p-2 bg-gray-900 rounded-lg" value="10" min="1"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="lg:col-span-2 space-y-8 fade-in" style="animation-delay: 0.1s;">
                                <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl h-full flex flex-col">
                                    <h2 class="text-xl font-semibold text-white mb-4">AI Review Studio</h2>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1">
                                        <div><label class="block text-sm mb-2">1. Review Points (Auto-filled from Business Finder)</label><textarea id="prompt-generator-input" class="w-full p-3 bg-gray-900 rounded-lg flex-1 resize-y h-64">${reviewPoints}</textarea></div>
                                        <div><label class="block text-sm mb-2">2. Generated Reviews</label>
                                            <div class="relative flex-1 h-64">
                                                <textarea id="generated-reviews-textarea" class="w-full h-full p-3 bg-gray-900 rounded-lg resize-y" placeholder="AI reviews appear here...">${generatedReviews}</textarea>
                                                ${isGenerating ? `<div class="absolute inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center rounded-lg"><div class="spinner h-8 w-8 border-4 border-teal-400 border-t-transparent rounded-full"></div></div>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-6 flex gap-4"><button id="generate-reviews-btn" class="w-full bg-teal-600 hover:bg-teal-500 text-white py-3 rounded-lg" ${isGenerating ? 'disabled' : ''}>AI-Powered Generate</button><button id="copy-reviews-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white py-3 rounded-lg" ${!generatedReviews ? 'disabled' : ''}>Copy</button></div>
                                </div>
                            </div>
                        </div>`;
                },
                renderOwnerToolsView() {
                    const { selectedPlace, sheetRow } = this.state.ownerState;
                    return `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="p-6 bg-gray-800 border-gray-700 rounded-xl space-y-4"><h2 class="text-xl font-semibold">Place ID Finder</h2><input type="text" id="pac-input" class="w-full p-3 bg-gray-900 rounded-lg" placeholder="Enter a location..."><div id="map"></div><div class="relative mt-4"><pre class="w-full p-3 pr-16 bg-gray-900 rounded-lg whitespace-pre-wrap overflow-x-auto">${selectedPlace.reviewLink || 'Link...'}</pre><button id="copy-place-link-btn" class="absolute top-1/2 right-3 -translate-y-1/2 bg-gray-600 py-1 px-3 rounded-lg text-sm" ${!selectedPlace.reviewLink ? 'disabled' : ''}>Copy</button></div></div>
                            <div class="p-6 bg-gray-800 border-gray-700 rounded-xl space-y-4 self-start"><h2 class="text-xl font-semibold">Sheet Row Generator</h2><div><label class="block text-sm mb-1">Name</label><input type="text" value="${selectedPlace.name}" class="w-full p-2 bg-gray-900 rounded-lg" readonly></div><div><label class="block text-sm mb-1">Start Count</label><input type="text" value="${selectedPlace.startingCount}" class="w-full p-2 bg-gray-900 rounded-lg" readonly></div><div><label class="block text-sm mb-1">Daily</label><input type="number" id="daily-reviews" value="${sheetRow.dailyReviews}" class="w-full p-2 bg-gray-900 rounded-lg"></div><div><label class="block text-sm mb-1">Ordered</label><input type="number" id="reviews-ordered" value="${sheetRow.reviewsOrdered}" class="w-full p-2 bg-gray-900 rounded-lg"></div><button id="generate-sheet-row-btn" class="w-full bg-teal-600 py-2 rounded-lg">Generate</button><div class="relative"><pre class="w-full p-3 pr-16 bg-gray-900 rounded-lg whitespace-pre-wrap overflow-x-auto">${sheetRow.output || 'Row...'}</pre><button id="copy-sheet-row-btn" class="absolute top-1/2 right-3 -translate-y-1/2 bg-gray-600 py-1 px-3 rounded-lg text-sm" ${!sheetRow.output ? 'disabled' : ''}>Copy</button></div></div>
                        </div>`;
                },

                // --- UTILITIES ---
                validateLink(link) { return link && (link.startsWith('http://') || link.startsWith('https://')); },
                copyToClipboard(text, message) { if (!text) return; navigator.clipboard.writeText(text).then(() => this.showNotification(message), () => this.showNotification("Failed to copy.", 'error')); },
                showNotification(message, type = 'success') {
                    const el = this.elements.notification;
                    el.textContent = message;
                    el.className = `notification-toast fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl z-[10001] ${type === 'info' ? 'bg-blue-600' : type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
                    el.classList.remove('hidden');
                    el.style.animation = 'none';
                    el.offsetHeight; /* trigger reflow */
                    el.style.animation = null; 
                    setTimeout(() => el.classList.add('hidden'), 3900);
                },
                 showPromptModal(title, placeholder, onSubmit) {
                     const modalContainer = document.createElement('div');
                     modalContainer.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10000] p-4"><form id="prompt-form" class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md"><h2 class="text-2xl font-bold mb-4">${title}</h2><input type="text" id="modal-input" class="w-full p-3 bg-gray-900 rounded-lg mb-6" placeholder="${placeholder}"><div class="flex justify-end gap-4"><button type="button" id="modal-cancel" class="bg-gray-600 py-2 px-6 rounded-lg">Cancel</button><button type="submit" class="bg-green-600 py-2 px-6 rounded-lg">Submit</button></div></form></div>`;
                     document.body.appendChild(modalContainer);
                     const form = modalContainer.querySelector('#prompt-form');
                     const input = modalContainer.querySelector('#modal-input');
                     input.focus();
                     const close = () => document.body.removeChild(modalContainer);
                     modalContainer.querySelector('#modal-cancel').onclick = close;
                     form.onsubmit = (e) => { e.preventDefault(); onSubmit(input.value); close(); };
                },
            };
            
            app.init();
        });
    </script>
</body>
</html>
