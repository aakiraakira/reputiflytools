<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Review Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXdjRQZJd9ySH5mxql4tlXCEVpDH9GGbI&libraries=places&callback=initializeGoogleMaps"></script>
    <style>
        /* Base styling for the page, using the Inter font */
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        /* Custom scrollbar for a better look in dark mode */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        /* Custom styles for buttons and interactive elements */
        .file-input-button, .view-button { cursor: pointer; }
        .review-item { transition: all 0.3s ease-in-out; }
        /* Animation for the notification toast */
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        .notification-toast { animation: fadeInOut 4s ease-in-out forwards; }
        /* Styling for disabled elements */
        button:disabled, input:disabled, textarea:disabled { opacity: 0.5; cursor: not-allowed; }
        /* Styling for the Google Places Autocomplete dropdown */
        .pac-container { background-color: #1f2937; border: 1px solid #4b5563; border-radius: 0.5rem; color: #d1d5db; z-index: 10000 !important; font-family: 'Inter', sans-serif; }
        .pac-item { padding: 0.75rem; cursor: pointer; border-top: 1px solid #374151; }
        .pac-item:first-child { border-top: none; }
        .pac-item:hover { background-color: #374151; }
        .pac-item-query { font-weight: 500; color: #f9fafb; }
        /* Utility class to hide elements */
        .hidden { display: none; }
        #map { height: 350px; border-radius: 0.75rem; background-color: #374151; }
        .pac-target-input { padding: 0.75rem; width: 100%; }
        /* Added for AI loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #34D399; /* teal-400 */
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-200">

    <div id="app" class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
        <div id="owner-view"></div>
    </div>
    
    <div id="generic-modal-container"></div>
    <div id="notification" class="hidden fixed bottom-5 right-5 bg-gray-800 border border-gray-700 text-white py-3 px-5 rounded-lg shadow-xl z-[10001]"></div>
    
    <script>
        // Global function called by the Google Maps script once it's loaded.
        function initializeGoogleMaps() {
            if (window.reviewApp) {
                window.reviewApp.mapsApiLoaded();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Main application object
            const app = {
                // --- STATE ---
                state: {
                    mapsInitialized: false,
                    ownerState: {
                        activeTab: 'submitter',
                        geminiApiKey: localStorage.getItem('geminiApiKey') || '',
                        geminiModel: 'normal',
                        isAiGenerating: false,
                        selectedPlace: {
                            name: '',
                            reviewLink: '',
                            startingCount: 0,
                            reviews: [],
                            placeId: '',
                            details: null 
                        },
                        reviews: [],
                        bulkText: '',
                        promptGenerator: { input: '', output: '' },
                        sheetRow: { dailyReviews: '', reviewsOrdered: '', output: '' }
                    }
                },
                // --- DOM ELEMENTS ---
                elements: {
                    app: document.getElementById('app'),
                    ownerView: document.getElementById('owner-view'),
                    genericModalContainer: document.getElementById('generic-modal-container'),
                    notification: document.getElementById('notification'),
                },
                
                // --- INITIALIZATION ---
                init() {
                    // Make the app instance globally accessible for the Maps callback.
                    window.reviewApp = this; 
                    this.attachListeners();
                    this.render();
                },
                
                // This function is called by the global initializeGoogleMaps callback.
                mapsApiLoaded() {
                    this.state.mapsInitialized = true;
                    // Now that the API is definitely loaded, initialize maps for the current view.
                    this.initializeMapsForCurrentView();
                },

                initializeMapsForCurrentView() {
                     if (!this.state.mapsInitialized) return;
                    
                    if (this.state.ownerState.activeTab === 'submitter') {
                        this.initAutocomplete('owner-link-input', this.handleOwnerPlaceSelection.bind(this));
                    }
                    if (this.state.ownerState.activeTab === 'tools') {
                        this.initPlaceIdFinderMap();
                    }
                },

                // --- GOOGLE MAPS & PLACES INTEGRATION ---
                // FIX: Simplified and made more robust. It's called after the view is rendered.
                initAutocomplete(inputId, callback) {
                    if (!this.state.mapsInitialized) return;
                    const input = document.getElementById(inputId);
                    // Ensure the input exists in the DOM and hasn't already been initialized.
                    if (!input || input.dataset.acAttached) return;

                    const autocompleteOptions = {
                        fields: ["place_id", "name", "reviews", "user_ratings_total", "url", "types", "website", "formatted_address"],
                        types: ["establishment"]
                    };
                    const autocomplete = new google.maps.places.Autocomplete(input, autocompleteOptions);
                    input.dataset.acAttached = 'true'; // Mark as initialized

                    autocomplete.addListener('place_changed', () => {
                        const place = autocomplete.getPlace();
                        callback(place);
                    });
                },
                
                initPlaceIdFinderMap() {
                    if (!this.state.mapsInitialized) return;
                    const mapEl = document.getElementById("map");
                    const inputEl = document.getElementById("pac-input");
                    
                    if (!mapEl || !inputEl || inputEl.dataset.acAttached) return;
                    // Clear any previous map instance to prevent errors
                    mapEl.innerHTML = ''; 

                    const map = new google.maps.Map(mapEl, { center: { lat: 1.3521, lng: 103.8198 }, zoom: 11 });
                    const autocomplete = new google.maps.places.Autocomplete(inputEl, { fields: ["place_id", "geometry", "name", "reviews", "user_ratings_total", "url", "types", "website", "formatted_address"] });
                    autocomplete.bindTo("bounds", map);
                    inputEl.dataset.acAttached = 'true';
                    const marker = new google.maps.Marker({ map: map });

                    autocomplete.addListener("place_changed", () => {
                        marker.setVisible(false);
                        const place = autocomplete.getPlace();
                        if (place.geometry) {
                           if (place.geometry.viewport) map.fitBounds(place.geometry.viewport);
                           else { map.setCenter(place.geometry.location); map.setZoom(17); }
                           marker.setPosition(place.geometry.location);
                           marker.setVisible(true);
                        }
                        this.handleOwnerPlaceSelection(place); 
                    });
                },

                handleOwnerPlaceSelection(place) {
                    if (!place || !place.place_id) {
                        this.showNotification("Could not retrieve company details. Please try again.", "error");
                        return;
                    }

                    const { ownerState } = this.state;
                    ownerState.selectedPlace.name = place.name || '';
                    ownerState.selectedPlace.placeId = place.place_id;
                    ownerState.selectedPlace.reviewLink = `https://search.google.com/local/writereview?placeid=${place.place_id}`;
                    ownerState.selectedPlace.startingCount = place.user_ratings_total || 0;
                    ownerState.selectedPlace.details = {
                        types: place.types || [],
                        address: place.formatted_address || '',
                        website: place.website || ''
                    };
                    
                    if (place.reviews && place.reviews.length > 0) {
                        const positiveReviews = place.reviews.filter(r => r.rating >= 4).map(r => r.text);
                        ownerState.selectedPlace.reviews = positiveReviews;
                        ownerState.promptGenerator.input = positiveReviews.join('\n\n---\n\n');
                    } else {
                        ownerState.selectedPlace.reviews = [];
                        ownerState.promptGenerator.input = 'No recent positive reviews found. You can paste your own points manually.';
                    }
                    
                    this.showNotification(`Selected: ${place.name}`, "success");
                    this.render();
                },

                // --- RENDERING ---
                render() {
                    this.renderOwnerView();
                    // FIX: Defer map initialization until after rendering is complete
                    // to ensure the input elements exist in the DOM.
                    setTimeout(() => this.initializeMapsForCurrentView(), 0);
                },
                
                renderOwnerView() {
                    const { activeTab } = this.state.ownerState;
                    this.elements.ownerView.innerHTML = `
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl sm:text-4xl font-bold text-white text-center">Owner Portal</h1>
                            <button id="settings-btn" class="text-gray-400 hover:text-white">‚öôÔ∏è Settings</button>
                        </div>
                        <div class="border-b border-gray-600 mb-6">
                            <nav class="-mb-px flex gap-4 overflow-x-auto" aria-label="Tabs">
                                <button data-tab="submitter" class="owner-tab-btn ${activeTab === 'submitter' ? 'border-teal-500 text-teal-400' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Review Submitter</button>
                                <button data-tab="promptGenerator" class="owner-tab-btn ${activeTab === 'promptGenerator' ? 'border-teal-500 text-teal-400' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">AI Prompt & Generation</button>
                                <button data-tab="tools" class="owner-tab-btn ${activeTab === 'tools' ? 'border-teal-500 text-teal-400' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Place ID & Sheet Row</button>
                            </nav>
                        </div>
                        <div id="owner-submitter-view" class="${activeTab !== 'submitter' ? 'hidden' : ''}">${this.renderOwnerSubmitterView()}</div>
                        <div id="owner-prompt-generator-view" class="${activeTab !== 'promptGenerator' ? 'hidden' : ''}">${this.renderOwnerPromptGeneratorView()}</div>
                        <div id="owner-tools-view" class="${activeTab !== 'tools' ? 'hidden' : ''}">${this.renderOwnerToolsView()}</div>
                    `;
                },
                
                renderOwnerSubmitterView() {
                    const { selectedPlace, reviews, bulkText } = this.state.ownerState;
                    const isPlaceSelected = !!selectedPlace.placeId;
                    const areReviewsProcessed = reviews.length > 0;
                    return `
                        <div id="owner-link-section" class="p-6 bg-gray-800 border border-gray-700 rounded-xl">
                             <h2 class="text-xl font-semibold text-white mb-4">Step 1: Find Business</h2>
                             <div class="flex flex-col sm:flex-row gap-3">
                                 <input type="text" id="owner-link-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg" placeholder="Search with Google OR paste link & click 'Set Link'" value="${selectedPlace.name || ''}">
                                 <button id="set-owner-link-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg whitespace-nowrap">Set Link</button>
                             </div>
                             ${isPlaceSelected && selectedPlace.reviewLink ? `<p class="text-sm text-green-400 mt-2">Review Link: <a href="${selectedPlace.reviewLink}" target="_blank" class="underline">${selectedPlace.reviewLink}</a></p>` : ''}
                        </div>
                        <div id="owner-bulk-section" class="mt-8 p-6 bg-gray-800 border border-gray-700 rounded-xl ${!isPlaceSelected || areReviewsProcessed ? 'hidden' : ''}">
                            <h2 class="text-xl font-semibold text-white mb-4">Step 2: Paste or Generate Reviews</h2>
                            <p class="text-sm text-gray-400 mb-3">You can paste reviews here, or go to the "AI Prompt & Generation" tab to craft them with AI.</p>
                            <textarea id="owner-bulk-textarea" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg h-60 resize-y" placeholder="Paste reviews here, one per line...">${bulkText}</textarea>
                            <button id="process-bulk-reviews-btn" class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg">Process Reviews</button>
                        </div>
                        <div id="owner-reviews-section" class="mt-8 ${!isPlaceSelected || !areReviewsProcessed ? 'hidden' : ''}">
                            <div class="mb-6 flex justify-between items-center">
                                <h2 class="text-xl font-semibold text-white">Step 3: Manage Reviews (${reviews.length})</h2>
                                <button id="reset-owner-reviews-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">Start Over</button>
                            </div>
                            <div id="owner-reviews-container">${this.renderReviewCards()}</div>
                            <div class="mt-8 pt-6 border-t border-gray-700"> <button id="download-owner-file-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg" ${reviews.length === 0 ? 'disabled' : ''}>Download Submission File</button> </div>
                        </div>`;
                },
                
                renderOwnerPromptGeneratorView() {
                    const { input, output } = this.state.ownerState.promptGenerator;
                    const { geminiModel, geminiApiKey, isAiGenerating } = this.state.ownerState;
                    const isPlaceSelected = !!this.state.ownerState.selectedPlace.placeId;

                    return `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl">
                                <h2 class="text-xl font-semibold text-white mb-4">1. Review Points & Keywords</h2>
                                <p class="text-sm text-gray-400 mb-3">These points are auto-filled from the selected company's recent Google reviews. Add or edit them manually to guide the AI.</p>
                                <textarea id="prompt-generator-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg h-80 resize-y" ${!isPlaceSelected ? 'disabled' : ''}>${input}</textarea>
                            </div>
                            <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl">
                                <h2 class="text-xl font-semibold text-white mb-4">2. Generate Master Prompt</h2>
                                <p class="text-sm text-gray-400 mb-3">Click to create a detailed prompt for the AI based on the points and business info.</p>
                                <button id="generate-prompt-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg" ${!isPlaceSelected ? 'disabled' : ''}>Generate Master Prompt</button>
                                <div class="relative mt-4 h-80">
                                    <pre id="prompt-generator-output" class="w-full h-full p-3 bg-gray-900 border border-gray-600 rounded-lg whitespace-pre-wrap overflow-y-auto">${output || 'Your master prompt will appear here...'}</pre>
                                    <button id="copy-prompt-btn" class="absolute top-3 right-3 bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded-lg text-sm" ${!output ? 'disabled' : ''}>Copy</button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 p-6 bg-gray-800 border border-gray-700 rounded-xl">
                             <h2 class="text-xl font-semibold text-white mb-4">3. Craft Reviews with Gemini AI</h2>
                             <div class="flex flex-col sm:flex-row gap-6 items-center">
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Select AI Model:</label>
                                    <div class="flex items-center gap-6">
                                        <label class="flex items-center"><input type="radio" name="gemini-model" value="normal" class="accent-teal-500 mr-2" ${geminiModel === 'normal' ? 'checked' : ''}>Normal Mode</label>
                                        <label class="flex items-center"><input type="radio" name="gemini-model" value="pro" class="accent-teal-500 mr-2" ${geminiModel === 'pro' ? 'checked' : ''}>Pro Mode</label>
                                    </div>
                                </div>
                                <button id="craft-ai-reviews-btn" class="flex-1 w-full flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg" ${!output || !geminiApiKey || isAiGenerating ? 'disabled' : ''}>
                                    ${isAiGenerating ? '<div class="spinner"></div><span class="ml-3">Generating...</span>' : 'Craft Reviews with AI'}
                                </button>
                             </div>
                             ${!geminiApiKey ? '<p class="text-yellow-400 text-sm mt-3">Missing Gemini API Key. Please add it in the <button id="settings-btn-inline" class="underline hover:text-yellow-200">Settings</button>.</p>' : ''}
                        </div>`;
                },
                renderOwnerToolsView() {
                    const { selectedPlace, sheetRow } = this.state.ownerState;
                    return `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl space-y-4">
                                <h2 class="text-xl font-semibold text-white">Place ID Finder</h2>
                                <input type="text" id="pac-input" class="pac-target-input bg-gray-900 border border-gray-600 rounded-lg" placeholder="Enter a location to find its review link">
                                <div id="map"></div>
                                <div class="relative mt-4">
                                    <pre class="w-full p-3 pr-16 bg-gray-900 border border-gray-600 rounded-lg whitespace-pre-wrap overflow-x-auto">${selectedPlace.reviewLink || 'Review link will appear here...'}</pre>
                                    <button id="copy-place-link-btn" class="absolute top-1/2 right-3 -translate-y-1/2 bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded-lg text-sm" ${!selectedPlace.reviewLink ? 'disabled' : ''}>Copy</button>
                                </div>
                            </div>
                            <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl space-y-4 self-start">
                                <h2 class="text-xl font-semibold text-white">Google Sheet Row Generator</h2>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Company Name</label>
                                    <input type="text" value="${selectedPlace.name}" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Starting Review Count</label>
                                    <input type="text" value="${selectedPlace.startingCount}" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Reviews Done</label>
                                    <input type="text" value="0" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg" readonly>
                                </div>
                                <div>
                                    <label for="daily-reviews" class="block text-sm font-medium text-gray-300 mb-1">Daily Reviews</label>
                                    <input type="number" id="daily-reviews" value="${sheetRow.dailyReviews}" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg">
                                </div>
                                <div>
                                    <label for="reviews-ordered" class="block text-sm font-medium text-gray-300 mb-1">Reviews Ordered</label>
                                    <input type="number" id="reviews-ordered" value="${sheetRow.reviewsOrdered}" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg">
                                </div>
                                <button id="generate-sheet-row-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Generate Row</button>
                                <div class="relative">
                                    <pre id="sheet-output" class="w-full p-3 pr-16 bg-gray-900 border border-gray-600 rounded-lg whitespace-pre-wrap overflow-x-auto">${sheetRow.output || 'Sheet row will appear here...'}</pre>
                                    <button id="copy-sheet-row-btn" class="absolute top-1/2 right-3 -translate-y-1/2 bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded-lg text-sm" ${!sheetRow.output ? 'disabled' : ''}>Copy</button>
                                </div>
                            </div>
                        </div>`;
                },

                renderReviewCards() {
                    const { reviews } = this.state.ownerState;

                    if (reviews.length === 0) {
                        return '<p class="text-gray-400 text-center py-4">No reviews processed yet. Paste reviews in the box above and click "Process Reviews".</p>';
                    }

                    return reviews.map((review, index) => `
                        <div class="review-item bg-gray-800 p-6 rounded-xl mb-6 border border-gray-700">
                            <div class="flex justify-between items-start mb-4">
                                <span class="text-2xl font-bold text-teal-400">#${index + 1}</span>
                                <button data-index="${index}" class="remove-review-btn text-gray-500 hover:text-red-500 font-bold text-2xl">√ó</button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="font-semibold text-gray-300 mb-2 block">Review Content</label>
                                    <textarea data-index="${index}" class="content-input w-full p-3 bg-gray-900 border border-gray-600 rounded-lg h-40 resize-none">${review.text}</textarea>
                                </div>
                                <div>
                                    <div class="mb-2">
                                        <label class="font-semibold text-gray-300 cursor-pointer">
                                            <input type="checkbox" data-index="${index}" class="image-required-toggle mr-2 accent-teal-500" ${review.requiresImage ? 'checked' : ''}>
                                            This review requires image(s)
                                        </label>
                                    </div>
                                    <div class="image-upload-section ${review.requiresImage ? '' : 'hidden'}">
                                        <label class="font-semibold text-gray-300 mb-2 block">Images</label>
                                        <div class="image-previews-container grid grid-cols-3 gap-2 mb-2">
                                            ${(review.imageDataUrls || []).map((url, imgIndex) => `
                                                <div class="relative group">
                                                    <img src="${url}" class="w-full h-24 object-cover rounded-lg">
                                                    <button data-review-index="${index}" data-image-index="${imgIndex}" class="remove-image-btn absolute top-1 right-1 bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">√ó</button>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <label class="file-input-button w-full h-12 bg-gray-900 border-2 border-dashed border-gray-600 rounded-lg flex items-center justify-center text-sm text-gray-500 hover:bg-gray-700 hover:text-white">
                                            Click to upload images
                                            <input type="file" data-index="${index}" class="image-input hidden" accept="image/*" multiple>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                },
                
                // --- EVENT LISTENERS & HANDLERS ---
                attachListeners() {
                    this.elements.app.addEventListener('click', e => this.handleClick(e));
                    this.elements.app.addEventListener('input', e => this.handleInput(e));
                    this.elements.app.addEventListener('change', e => this.handleChange(e));
                },
                
                handleTabClick(tab) {
                    this.state.ownerState.activeTab = tab;
                    this.render();
                },

                handleClick(e) {
                    const target = e.target;
                    
                    if (target.closest('.owner-tab-btn')) { this.handleTabClick(target.closest('.owner-tab-btn').dataset.tab); return; }
                    if (target.closest('#settings-btn') || target.closest('#settings-btn-inline')) { this.showApiKeyModal(); return; }

                    if (target.id === 'set-owner-link-btn') {
                        const input = document.getElementById('owner-link-input');
                        if (input && input.value.trim() !== '') {
                            const isLink = this.validateLink(input.value);
                            const { ownerState } = this.state;

                            ownerState.selectedPlace.name = input.value.trim();
                            ownerState.selectedPlace.placeId = 'manual_entry';
                            ownerState.selectedPlace.reviewLink = isLink ? input.value.trim() : `https://www.google.com/search?q=${encodeURIComponent(input.value.trim())}`;
                            ownerState.selectedPlace.startingCount = 0; 
                            ownerState.selectedPlace.reviews = [];
                            ownerState.selectedPlace.details = null;
                            ownerState.promptGenerator.input = 'No recent positive reviews found (manual entry). You can paste your own points manually.';
                            
                            this.render();
                            this.showNotification(`Manually set location: ${ownerState.selectedPlace.name}`, "success");
                        } else {
                            this.showNotification('Please enter a business name or a valid URL.', 'error');
                        }
                    }
                    if (target.id === 'process-bulk-reviews-btn') this.processBulkReviews();
                    if (target.id === 'reset-owner-reviews-btn') { this.state.ownerState.reviews = []; this.state.ownerState.bulkText = ''; this.render(); }
                    if (target.id === 'generate-prompt-btn') this.generateOwnerPrompt();
                    if (target.id === 'copy-prompt-btn') this.copyToClipboard(this.state.ownerState.promptGenerator.output, "Prompt copied!");
                    if (target.id === 'craft-ai-reviews-btn') this.craftAiReviews();
                    if (target.id === 'copy-place-link-btn') this.copyToClipboard(this.state.ownerState.selectedPlace.reviewLink, "Place link copied!");
                    if (target.id === 'generate-sheet-row-btn') this.generateSheetRow();
                    if (target.id === 'copy-sheet-row-btn') this.copyToClipboard(this.state.ownerState.sheetRow.output, "Sheet row copied!");
                    if (target.id === 'download-owner-file-btn') {
                        this.showPromptModal('Enter a filename', 'e.g., company_reviews', (filename) => {
                            if (!filename) { this.showNotification('Download cancelled.', 'error'); return; }
                            const data = { link: this.state.ownerState.selectedPlace.reviewLink, reviews: this.state.ownerState.reviews };
                            const dataBlob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(dataBlob);
                            const a = document.createElement('a');
                            a.href = url; a.download = `${filename.replace(/\s+/g, '_')}.json`;
                            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                            this.showNotification('File downloaded!');
                        });
                    }

                    if (target.closest('.remove-review-btn')) {
                        this.state.ownerState.reviews.splice(target.closest('.remove-review-btn').dataset.index, 1);
                        this.render();
                    }
                     if (target.closest('.remove-image-btn')) {
                        const btn = target.closest('.remove-image-btn');
                        this.state.ownerState.reviews[btn.dataset.reviewIndex].imageDataUrls.splice(btn.dataset.imageIndex, 1);
                        this.render();
                    }
                },

                handleInput(e) {
                    const target = e.target;
                    if (target.id === 'owner-bulk-textarea') this.state.ownerState.bulkText = target.value;
                    if (target.id === 'prompt-generator-input') this.state.ownerState.promptGenerator.input = target.value;
                    if (['daily-reviews', 'reviews-ordered'].includes(target.id)) {
                        const key = {'daily-reviews': 'dailyReviews', 'reviews-ordered': 'reviewsOrdered'}[target.id];
                        this.state.ownerState.sheetRow[key] = target.value;
                    }
                    if(target.classList.contains('content-input')) {
                        this.state.ownerState.reviews[target.dataset.index].text = target.value;
                    }
                },

                async handleChange(e) {
                    const target = e.target;
                    const index = target.dataset.index;

                    if(target.name === 'gemini-model') {
                        this.state.ownerState.geminiModel = target.value;
                        this.render();
                    }
                    if (target.classList.contains('image-required-toggle')) {
                        this.state.ownerState.reviews[index].requiresImage = target.checked;
                        if (!target.checked) this.state.ownerState.reviews[index].imageDataUrls = [];
                        this.render();
                    }
                    if (target.classList.contains('image-input')) {
                        const files = target.files;
                        if (files.length > 0) {
                            this.showNotification(`Compressing ${files.length} image(s)...`, 'info');
                            for (const file of files) {
                                try {
                                    const compressedDataUrl = await this.compressImage(file);
                                    this.state.ownerState.reviews[index].imageDataUrls.push(compressedDataUrl);
                                } catch (err) { this.showNotification(`Could not process ${file.name}.`, 'error'); }
                            }
                            this.render();
                            this.showNotification('Images added successfully.');
                        }
                    }
                },

                processBulkReviews() {
                    const { bulkText } = this.state.ownerState;
                    const lines = bulkText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                    const uniqueLines = [...new Set(lines)];
                    if (uniqueLines.length === 0) { 
                        this.showNotification("No reviews found to process.", "error"); 
                        return; 
                    }
                    this.state.ownerState.reviews = uniqueLines.map(line => ({ text: line, requiresImage: false, imageDataUrls: [] }));
                    this.showNotification(`${uniqueLines.length} unique reviews processed.`, "success");
                    this.render();
                },

                generateOwnerPrompt() {
                    const { selectedPlace, promptGenerator } = this.state.ownerState;
                    let context = `Key Positive Points from Customers:\n${promptGenerator.input.trim()}`;
                    const promptText = `CONTEXT:\n${context}\n\nTASK:\nBased on the context and key points above, craft 50 positive, detailed, and highly realistic Google reviews. Strictly follow all requirements below:\n\nREQUIREMENTS:\n1.  **Natural Language:** Reviews must sound like they were written by 50 different, real people. Vary tone, style, emotion (grateful, excited, relaxed), and sentence structure extensively. Mix short, snappy sentences with longer, more descriptive ones.\n\n2.  **Randomized Lengths & Order:** Do not follow any pattern. Some reviews should be very short (5-10 words), some medium (2-4 sentences), and a few long and detailed (5-8+ sentences). The order of lengths must be completely random.\n\n3.  **Company Name Usage (Strict):** Mention the specific company name, "${selectedPlace.name}", in only a small, random subset of the reviews (e.g., 5 out of 50). For all other reviews, use general terms like "this place," "the team," "the service," "they," or just describe the experience.\n\n4.  **Keyword Integration:** Subtly weave in keywords from the business context (like business type, location hints, or specific services mentioned in the points) into a few reviews where it feels natural. Do not force them in.\n\n5.  **Authenticity & Realism:** To enhance credibility, a couple of reviews can mention a minor, neutral point before giving praise (e.g., "It was a bit busy, but the service was still excellent" or "I had to wait a few minutes, but it was so worth it.").\n\n6.  **Varied Writing Voice & Demographics:** Write from different perspectives. Hint at different customer types (e.g., "brought my family," "perfect for a quick work lunch," "came here on a date night"). Use different capitalization styles (some proper, some all-lowercase, some with mobile auto-capitalization). Use emojis (like üòä, üëç, ‚≠ê) very sparingly‚Äîmaybe in 1 of every 10 reviews.\n\n7.  **Time References:** Casually include a soft time reference in about 3-5 reviews (e.g., "visited last week," "came here yesterday morning").\n\n8.  **Formatting:** Separate each review with a new line. DO NOT number the reviews.`;
                    promptGenerator.output = promptText;
                    this.render();
                    this.showNotification("Master prompt generated!");
                },

                async craftAiReviews() {
                    const { geminiApiKey, geminiModel, promptGenerator } = this.state.ownerState;
                    if (!geminiApiKey) { this.showNotification("Gemini API key is not set.", 'error'); return; }
                    if (!promptGenerator.output) { this.showNotification("Please generate a master prompt first.", 'error'); return; }

                    this.state.ownerState.isAiGenerating = true;
                    this.render();

                    const model = geminiModel === 'pro' ? 'gemini-1.5-pro-latest' : 'gemini-1.5-flash-latest';
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${geminiApiKey}`;

                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: promptGenerator.output }] }] })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        const aiReviews = data.candidates[0]?.content?.parts[0]?.text || '';
                        
                        this.state.ownerState.bulkText = aiReviews.trim();
                        this.state.ownerState.activeTab = 'submitter';
                        this.showNotification("AI reviews generated successfully! Now process them.", "success");
                        
                    } catch (error) {
                        this.showNotification(`AI generation failed: ${error.message}`, 'error');
                    } finally {
                        this.state.ownerState.isAiGenerating = false;
                        this.render();
                    }
                },

                generateSheetRow() {
                    const { name, startingCount } = this.state.ownerState.selectedPlace;
                    if (!name) { this.showNotification("Please search and select a company first.", "error"); return; }
                    const daily = parseInt(this.state.ownerState.sheetRow.dailyReviews, 10) || 0;
                    const ordered = parseInt(this.state.ownerState.sheetRow.reviewsOrdered, 10) || 0;
                    const done = 0;
                    const endingCount = startingCount + ordered;
                    const reviewsLeft = ordered - done;
                    const output = `${name}\t${daily}\t${done}\t${ordered}\t${startingCount}\t${endingCount}\t\t${reviewsLeft}`;
                    this.state.ownerState.sheetRow.output = output;
                    this.render();
                    this.showNotification("Sheet row generated!");
                },

                // --- UTILITIES & MODALS ---
                compressImage(file, quality = 0.7, maxWidth = 1024) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = (event) => {
                            const img = new Image();
                            img.src = event.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const scaleRatio = maxWidth / img.width;
                                canvas.width = scaleRatio < 1 ? maxWidth : img.width;
                                canvas.height = scaleRatio < 1 ? img.height * scaleRatio : img.height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                resolve(ctx.canvas.toDataURL('image/jpeg', quality));
                            };
                            img.onerror = (error) => reject(error);
                        };
                        reader.onerror = (error) => reject(error);
                    });
                },
                
                showApiKeyModal() {
                    const currentKey = this.state.ownerState.geminiApiKey;
                     this.elements.genericModalContainer.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10000] p-4"><form id="api-key-form" class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-700"><h2 class="text-2xl font-bold text-white mb-4">Gemini API Key</h2><p class="text-gray-400 mb-4">Please enter your Gemini API key to enable AI features. Your key is saved locally in your browser.</p><input type="password" id="modal-api-key-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg mb-6" placeholder="Enter your API key..." value="${currentKey}"><div class="flex justify-end gap-4"><button type="button" id="modal-cancel" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Cancel</button><button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-lg">Save Key</button></div></form></div>`;
                    const input = document.getElementById('modal-api-key-input');
                    input.focus();
                    document.getElementById('modal-cancel').onclick = () => this.elements.genericModalContainer.innerHTML = '';
                    document.getElementById('api-key-form').onsubmit = (e) => {
                        e.preventDefault();
                        const newKey = input.value.trim();
                        if (newKey) {
                            this.state.ownerState.geminiApiKey = newKey;
                            localStorage.setItem('geminiApiKey', newKey);
                            this.showNotification('API Key saved successfully!');
                            this.elements.genericModalContainer.innerHTML = '';
                            this.render();
                        } else {
                            this.showNotification('API Key cannot be empty.', 'error');
                        }
                    };
                },

                showPromptModal(title, placeholder, onSubmit) {
                     this.elements.genericModalContainer.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10000] p-4"><form id="prompt-form" class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-700"><h2 class="text-2xl font-bold text-white mb-4">${title}</h2><input type="text" id="modal-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg mb-6" placeholder="${placeholder}"><div class="flex justify-end gap-4"><button type="button" id="modal-cancel" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg">Cancel</button><button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Submit</button></div></form></div>`;
                    const input = document.getElementById('modal-input');
                    input.focus();
                    document.getElementById('modal-cancel').onclick = () => this.elements.genericModalContainer.innerHTML = '';
                    document.getElementById('prompt-form').onsubmit = (e) => { e.preventDefault(); onSubmit(input.value); this.elements.genericModalContainer.innerHTML = ''; };
                },

                validateLink(link) { return link && (link.startsWith('http://') || link.startsWith('https://')); },
                
                copyToClipboard(text, message = "Copied to clipboard!") {
                    if (!navigator.clipboard) { 
                        const textArea = document.createElement("textarea");
                        textArea.value = text; document.body.appendChild(textArea);
                        textArea.focus(); textArea.select();
                        try { document.execCommand('copy'); this.showNotification(message); } 
                        catch (err) { this.showNotification("Failed to copy.", 'error'); }
                        document.body.removeChild(textArea);
                        return;
                    }
                    navigator.clipboard.writeText(text).then(() => { this.showNotification(message); }, () => { this.showNotification("Failed to copy.", 'error'); });
                },

                showNotification(message, type = 'success') {
                    const el = this.elements.notification;
                    el.textContent = message;
                    el.className = `notification-toast fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl z-[10001] ${type === 'info' ? 'bg-blue-600' : type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
                    el.classList.remove('hidden');
                    el.style.animation = 'none';
                    el.offsetHeight; /* trigger reflow */
                    el.style.animation = null; 
                    setTimeout(() => el.classList.add('hidden'), 3900);
                }
            };
            
            app.init();
        });
    </script>
</body>
</html>
