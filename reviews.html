<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner AI Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXdjRQZJd9ySH5mxql4tlXCEVpDH9GGbI&libraries=places&callback=initMaps"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #d1d5db; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .spinner { display: inline-block; width: 1.25rem; height: 1.25rem; border: 2px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
        .pac-container { background-color: #1f2937; border: 1px solid #4b5563; border-radius: 0.5rem; color: #d1d5db; z-index: 10000 !important; font-family: 'Inter', sans-serif; }
        .pac-item { padding: 0.75rem; cursor: pointer; border-top: 1px solid #374151; }
        .pac-item:first-child { border-top: none; }
        .pac-item:hover { background-color: #374151; }
        .pac-item-query { font-weight: 500; color: #f9fafb; }
        #map { height: 350px; border-radius: 0.75rem; background-color: #374151; }
        .hidden { display: none; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="text-gray-200">

    <div id="app" class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
        <div id="owner-view">
            </div>
    </div>
    
    <div id="modal-container"></div>
    <div id="notification" class="hidden fixed bottom-5 right-5 bg-gray-800 border border-gray-700 text-white py-3 px-5 rounded-lg shadow-xl z-[10001]"></div>
    
    <script>
        function initMaps() {
            document.dispatchEvent(new Event('google-maps-loaded'));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                state: {
                    mapsInitialized: false,
                    ownerState: {
                        activeTab: 'submitter',
                        selectedPlace: { name: '', address: '', reviewLink: '', startingCount: 0, reviews: [], placeId: '' },
                        reviews: [], 
                        bulkText: '',
                        promptGenerator: {
                            reviewPoints: '', 
                            geminiApiKey: localStorage.getItem('geminiApiKey') || '',
                            isGenerating: false,
                            generatedReviews: ''
                        },
                        sheetRow: { dailyReviews: '', reviewsOrdered: '', output: '' },
                    }
                },
                elements: {
                    ownerView: document.getElementById('owner-view'),
                    modalContainer: document.getElementById('modal-container'),
                    notification: document.getElementById('notification'),
                },
                
                init() {
                    this.renderOwnerView();
                    this.attachListeners();
                    document.addEventListener('google-maps-loaded', () => {
                        this.state.mapsInitialized = true;
                        this.initializeOwnerViewMaps();
                    });

                    // On initial load, check for the API key and show popup if it's missing.
                    if (!this.state.ownerState.promptGenerator.geminiApiKey) {
                        this.showApiKeyModal();
                    }
                },

                attachListeners() {
                    this.elements.ownerView.addEventListener('click', this.handleOwnerClick.bind(this));
                    this.elements.ownerView.addEventListener('input', this.handleOwnerInput.bind(this));
                },

                // --- Google Maps Integration ---
                initializeOwnerViewMaps() {
                    if (!this.state.mapsInitialized) return;
                    setTimeout(() => {
                        if (this.state.ownerState.activeTab === 'submitter') {
                            this.initAutocomplete('owner-link-input', this.handleOwnerPlaceSelection.bind(this));
                        }
                        if (this.state.ownerState.activeTab === 'tools') {
                            this.initPlaceIdFinderMap();
                        }
                    }, 150); // Increased timeout slightly for stability
                },

                initAutocomplete(inputId, callback) {
                    const input = document.getElementById(inputId);
                    if (!input || input.dataset.acAttached) return;
                    const autocomplete = new google.maps.places.Autocomplete(input, {
                        fields: ["place_id", "name", "formatted_address", "reviews", "user_ratings_total", "url"],
                        types: ["establishment"]
                    });
                    input.dataset.acAttached = 'true';
                    autocomplete.addListener('place_changed', () => callback(autocomplete.getPlace()));
                },
                 
                initPlaceIdFinderMap() {
                    if (!this.state.mapsInitialized) return;
                    const mapEl = document.getElementById("map");
                    const inputEl = document.getElementById("pac-input");
                    // Guard against re-initialization if map already exists
                    if (!mapEl || !inputEl || inputEl.dataset.acAttached || mapEl.firstChild) return;

                    const map = new google.maps.Map(mapEl, { center: { lat: 1.3521, lng: 103.8198 }, zoom: 11 });
                    const autocomplete = new google.maps.places.Autocomplete(inputEl, { fields: ["place_id", "geometry", "name"] });
                    autocomplete.bindTo("bounds", map);
                    inputEl.dataset.acAttached = 'true';
                    const marker = new google.maps.Marker({ map: map });
                    autocomplete.addListener("place_changed", () => {
                        marker.setVisible(false);
                        const place = autocomplete.getPlace();
                        if (place.geometry) {
                           if (place.geometry.viewport) map.fitBounds(place.geometry.viewport);
                           else { map.setCenter(place.geometry.location); map.setZoom(17); }
                           marker.setPosition(place.geometry.location);
                           marker.setVisible(true);
                        }
                        // For this tool, just update the link in state for copying
                        this.state.ownerState.selectedPlace.reviewLink = `https://search.google.com/local/writereview?placeid=${place.place_id}`;
                        this.renderOwnerView();
                    });
                },

                handleOwnerPlaceSelection(place) {
                    if (!place || !place.place_id) { return; }
                    const { ownerState } = this.state;
                    ownerState.selectedPlace.name = place.name || '';
                    ownerState.selectedPlace.address = place.formatted_address || '';
                    ownerState.selectedPlace.placeId = place.place_id;
                    ownerState.selectedPlace.reviewLink = `https://search.google.com/local/writereview?placeid=${place.place_id}`;
                    ownerState.selectedPlace.startingCount = place.user_ratings_total || 0;
                    
                    if (place.reviews && place.reviews.length > 0) {
                        const positiveReviews = place.reviews.filter(r => r.rating >= 4).map(r => r.text);
                        ownerState.promptGenerator.reviewPoints = positiveReviews.join('\n\n---\n\n');
                    } else {
                        ownerState.promptGenerator.reviewPoints = 'No recent positive reviews found. You can paste your own points manually.';
                    }
                    
                    this.showNotification(`Selected: ${place.name}`, "success");
                    this.renderOwnerView();
                },

                // --- Gemini AI Integration ---
                async callGeminiApi(prompt, model = 'gemini-1.5-flash-latest') {
                    const apiKey = this.state.ownerState.promptGenerator.geminiApiKey;
                    if (!apiKey) {
                        this.showNotification("API Key is missing. Please set it in the AI Prompt Studio.", "error");
                        return null;
                    }
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                        }
                        const data = await response.json();
                        return data.candidates[0].content.parts[0].text;
                    } catch (error) {
                        this.showNotification(`AI Error: ${error.message}`, "error");
                        return null;
                    }
                },
                
                async handleGenerateReviews() {
                    const { promptGenerator, selectedPlace } = this.state.ownerState;
                    if (promptGenerator.isGenerating) return;

                    const quantity = document.getElementById('review-quantity')?.value || 10;
                    const model = document.getElementById('ai-model')?.value === 'pro' ? 'gemini-1.5-pro-latest' : 'gemini-1.5-flash-latest';
                    
                    promptGenerator.isGenerating = true;
                    promptGenerator.generatedReviews = '';
                    this.renderOwnerView();

                    let finalPrompt = `Based on the following points, craft ${quantity} positive reviews.
                    Business Name: ${selectedPlace.name || 'the business'}
                    Review points to expand on:\n- ${promptGenerator.reviewPoints || 'General positive experience'}
                    Strict requirements:
                    - Vary review length and tone to sound like different people.
                    - Do NOT number the reviews. Separate each review with a new line.`;
                    
                    const generatedText = await this.callGeminiApi(finalPrompt, model);

                    promptGenerator.isGenerating = false;
                    promptGenerator.generatedReviews = generatedText || '';
                    this.renderOwnerView();
                },

                // --- Event Handlers ---
                handleOwnerClick(e) {
                    const target = e.target.closest('button');
                    if (!target) return;
                    
                    const { ownerState } = this.state;

                    if (target.classList.contains('owner-tab-btn')) {
                        ownerState.activeTab = target.dataset.tab;
                        this.renderOwnerView();
                        this.initializeOwnerViewMaps(); // Re-init maps on tab change
                        return;
                    }
                    if (target.id === 'change-api-key-btn') this.showApiKeyModal();
                    if (target.id === 'generate-reviews-btn') this.handleGenerateReviews();
                    if (target.id === 'copy-reviews-btn') this.copyToClipboard(ownerState.promptGenerator.generatedReviews, 'Reviews copied!');
                    if (target.id === 'process-bulk-reviews-btn') this.processBulkReviews();
                    if (target.id === 'reset-owner-reviews-btn') { ownerState.reviews = []; ownerState.bulkText = ''; this.renderOwnerView(); }
                    if (target.id === 'download-owner-file-btn') this.downloadSubmissionFile();
                    if (target.id === 'copy-place-link-btn') this.copyToClipboard(ownerState.selectedPlace.reviewLink, "Place link copied!");
                    if (target.id === 'generate-sheet-row-btn') this.generateSheetRow();
                    if (target.id === 'copy-sheet-row-btn') this.copyToClipboard(ownerState.sheetRow.output, "Sheet row copied!");
                },

                handleOwnerInput(e) {
                    const { ownerState } = this.state;
                    const { id, value } = e.target;
                    
                    if (id === 'owner-bulk-textarea') ownerState.bulkText = value;
                    if (id === 'prompt-generator-input') ownerState.promptGenerator.reviewPoints = value;
                    if (id === 'daily-reviews') ownerState.sheetRow.dailyReviews = value;
                    if (id === 'reviews-ordered') ownerState.sheetRow.reviewsOrdered = value;
                },

                // --- Original Feature Methods ---
                processBulkReviews() {
                    const { ownerState } = this.state;
                    const lines = ownerState.bulkText.split('\n').map(line => line.trim()).filter(Boolean);
                    ownerState.reviews = [...new Set(lines)].map(line => ({ text: line, requiresImage: false, imageDataUrls: [] }));
                    this.showNotification(`${ownerState.reviews.length} unique reviews processed.`);
                    this.renderOwnerView();
                },
                downloadSubmissionFile() {
                     this.showPromptModal('Enter a filename', 'e.g., company_reviews.json', (filename) => {
                        if (!filename) { this.showNotification('Download cancelled.', 'error'); return; }
                        const data = { link: this.state.ownerState.selectedPlace.reviewLink, reviews: this.state.ownerState.reviews };
                        const dataBlob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        const a = document.createElement('a');
                        a.href = url; a.download = filename.endsWith('.json') ? filename : `${filename}.json`;
                        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                    });
                },
                 generateSheetRow() {
                    const { name, startingCount } = this.state.ownerState.selectedPlace;
                    if (!name) { this.showNotification("Please select a company first.", "error"); return; }
                    const { sheetRow } = this.state.ownerState;
                    const daily = parseInt(sheetRow.dailyReviews, 10) || 0;
                    const ordered = parseInt(sheetRow.reviewsOrdered, 10) || 0;
                    const endingCount = (Number(startingCount) || 0) + ordered;
                    sheetRow.output = `${name}\t${daily}\t0\t${ordered}\t${startingCount}\t${endingCount}\t\t${ordered}`;
                    this.renderOwnerView();
                },

                // --- Rendering ---
                renderOwnerView() {
                    const { activeTab } = this.state.ownerState;
                    this.elements.ownerView.innerHTML = `
                        <header class="text-center mb-10 fade-in">
                            <h1 class="text-4xl sm:text-5xl font-bold text-white">Owner AI Portal</h1>
                            <p class="text-gray-400 mt-2">The original toolkit, boosted with AI.</p>
                        </header>
                        <div class="border-b border-gray-600 mb-6">
                            <nav class="-mb-px flex gap-4 overflow-x-auto" aria-label="Tabs">
                                <button data-tab="submitter" class="owner-tab-btn ${activeTab === 'submitter' ? 'border-teal-500 text-teal-400' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Review Submitter</button>
                                <button data-tab="promptGenerator" class="owner-tab-btn ${activeTab === 'promptGenerator' ? 'border-teal-500 text-teal-400' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">AI Prompt Studio</button>
                                <button data-tab="tools" class="owner-tab-btn ${activeTab === 'tools' ? 'border-teal-500 text-teal-400' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Place ID & Sheet Row</button>
                            </nav>
                        </div>
                        <div class="${activeTab !== 'submitter' ? 'hidden' : ''}">${this.renderOwnerSubmitterView()}</div>
                        <div class="${activeTab !== 'promptGenerator' ? 'hidden' : ''}">${this.renderOwnerPromptGeneratorView()}</div>
                        <div class="${activeTab !== 'tools' ? 'hidden' : ''}">${this.renderOwnerToolsView()}</div>`;
                },
                
                renderOwnerSubmitterView() {
                    const { selectedPlace, reviews, bulkText } = this.state.ownerState;
                    const isPlaceSelected = !!selectedPlace.placeId;
                    const areReviewsProcessed = reviews.length > 0;
                    return `
                        <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl">
                             <h2 class="text-xl font-semibold text-white mb-4">Step 1: Find Business</h2>
                             <div class="flex flex-col sm:flex-row gap-3">
                                 <input type="text" id="owner-link-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg" placeholder="Search for a business by name..." value="${selectedPlace.name || ''}">
                             </div>
                             ${isPlaceSelected ? `<p class="text-sm text-green-400 mt-2">Review Link: <a href="${selectedPlace.reviewLink}" target="_blank" class="underline">${selectedPlace.reviewLink}</a></p>` : ''}
                        </div>
                        <div class="mt-8 p-6 bg-gray-800 border border-gray-700 rounded-xl ${!isPlaceSelected || areReviewsProcessed ? 'hidden' : ''}">
                            <h2 class="text-xl font-semibold text-white mb-4">Step 2: Paste All Reviews</h2>
                            <textarea id="owner-bulk-textarea" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg h-60 resize-y" placeholder="Paste reviews here, one per line...">${bulkText}</textarea>
                            <button id="process-bulk-reviews-btn" class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg">Process Reviews</button>
                        </div>
                        <div class="mt-8 p-6 bg-gray-800 border border-gray-700 rounded-xl ${!isPlaceSelected || !areReviewsProcessed ? 'hidden' : ''}">
                            <div class="mb-6 flex justify-between items-center">
                                <h2 class="text-xl font-semibold text-white">Step 3: Manage Reviews (${reviews.length})</h2>
                                <button id="reset-owner-reviews-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">Start Over</button>
                            </div>
                            <div class="max-h-80 overflow-y-auto pr-2">${this.renderReviewCards()}</div>
                            <div class="mt-8 pt-6 border-t border-gray-700"> <button id="download-owner-file-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg" ${reviews.length === 0 ? 'disabled' : ''}>Download Submission File</button> </div>
                        </div>`;
                },
                
                renderReviewCards() {
                    const { reviews } = this.state.ownerState;
                    if (reviews.length === 0) return '<p class="text-gray-400 text-center py-4">No reviews processed yet.</p>';
                    return reviews.map((review, index) => `
                        <div class="bg-gray-900 p-4 rounded-lg mb-3">
                           <textarea class="w-full p-2 bg-gray-800 border border-gray-700 rounded-lg h-24 resize-none">${review.text}</textarea>
                        </div>
                    `).join('');
                },

                renderOwnerPromptGeneratorView() {
                    const { reviewPoints, isGenerating, generatedReviews } = this.state.ownerState.promptGenerator;
                     return `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl space-y-6">
                                <div>
                                    <h2 class="text-xl font-semibold text-white mb-2">1. Review Points</h2>
                                    <p class="text-sm text-gray-400 mb-4">Auto-filled from the Business Finder, or you can paste your own.</p>
                                    <textarea id="prompt-generator-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg h-60 resize-y">${reviewPoints}</textarea>
                                </div>
                                <div>
                                    <h2 class="text-xl font-semibold text-white mb-2">2. AI Controls</h2>
                                    <div class="space-y-4">
                                        <div><label for="ai-model" class="block text-sm font-medium text-gray-300 mb-1">AI Model</label><select id="ai-model" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg"><option value="normal">Normal (Fast)</option><option value="pro">Pro (Advanced)</option></select></div>
                                        <div><label for="review-quantity" class="block text-sm font-medium text-gray-300 mb-1">Quantity to Generate</label><input type="number" id="review-quantity" class="w-full p-2 bg-gray-900 border border-gray-600 rounded-lg" value="10" min="1"></div>
                                        <button id="change-api-key-btn" class="w-full text-sm text-center text-teal-400 hover:underline">Change API Key</button>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl flex flex-col">
                                <h2 class="text-xl font-semibold text-white mb-4">3. Generated Reviews</h2>
                                <div class="relative flex-1">
                                    <textarea id="generated-reviews-textarea" class="w-full h-full p-3 bg-gray-900 border border-gray-600 rounded-lg resize-y min-h-[300px]" placeholder="AI-generated reviews will appear here...">${generatedReviews}</textarea>
                                    ${isGenerating ? `<div class="absolute inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center rounded-lg"><div class="spinner"></div><p class="mt-2">Generating...</p></div>` : ''}
                                </div>
                                <div class="mt-6 flex gap-4">
                                    <button id="generate-reviews-btn" class="w-full bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-2" ${isGenerating ? 'disabled' : ''}>${isGenerating ? '<span class="spinner !w-5 !h-5"></span>' : ''}Generate with AI</button>
                                    <button id="copy-reviews-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg" ${!generatedReviews ? 'disabled' : ''}>Copy</button>
                                </div>
                            </div>
                        </div>`;
                },
                renderOwnerToolsView() {
                    const { selectedPlace, sheetRow } = this.state.ownerState;
                    return `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl space-y-4"><h2 class="text-xl font-semibold">Place ID Finder</h2><input type="text" id="pac-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg" placeholder="Enter a location to find its review link"><div id="map"></div><div class="relative mt-4"><pre class="w-full p-3 pr-16 bg-gray-900 rounded-lg whitespace-pre-wrap overflow-x-auto">${selectedPlace.reviewLink || 'Review link will appear here...'}</pre><button id="copy-place-link-btn" class="absolute top-1/2 right-3 -translate-y-1/2 bg-gray-600 text-white font-bold py-1 px-3 rounded-lg text-sm" ${!selectedPlace.reviewLink ? 'disabled' : ''}>Copy</button></div></div>
                            <div class="p-6 bg-gray-800 border border-gray-700 rounded-xl space-y-4 self-start"><h2 class="text-xl font-semibold">Sheet Row Generator</h2><div><label class="block text-sm font-medium mb-1">Company Name</label><input type="text" value="${selectedPlace.name}" class="w-full p-2 bg-gray-900 rounded-lg" readonly></div><div><label class="block text-sm font-medium mb-1">Starting Count</label><input type="text" value="${selectedPlace.startingCount}" class="w-full p-2 bg-gray-900 rounded-lg" readonly></div><div><label class="block text-sm font-medium mb-1">Daily Reviews</label><input type="number" id="daily-reviews" value="${sheetRow.dailyReviews}" class="w-full p-2 bg-gray-900 rounded-lg"></div><div><label class="block text-sm font-medium mb-1">Reviews Ordered</label><input type="number" id="reviews-ordered" value="${sheetRow.reviewsOrdered}" class="w-full p-2 bg-gray-900 rounded-lg"></div><button id="generate-sheet-row-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Generate Row</button><div class="relative mt-4"><pre class="w-full p-3 pr-16 bg-gray-900 rounded-lg whitespace-pre-wrap overflow-x-auto">${sheetRow.output || 'Sheet row will appear here...'}</pre><button id="copy-sheet-row-btn" class="absolute top-1/2 right-3 -translate-y-1/2 bg-gray-600 text-white font-bold py-1 px-3 rounded-lg text-sm" ${!sheetRow.output ? 'disabled' : ''}>Copy</button></div></div>
                        </div>`;
                },

                // --- UTILITIES ---
                showApiKeyModal() {
                    this.elements.modalContainer.innerHTML = `<div id="api-key-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10000] p-4">
                        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-700 fade-in">
                            <h2 class="text-2xl font-bold text-white mb-4">Enter Access Key</h2>
                            <p class="text-gray-400 mb-6">Please enter your Gemini API key to enable AI features. The key will be saved in your browser for future use.</p>
                            <input type="password" id="modal-api-key-input" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg mb-6" placeholder="Paste your key here">
                            <div class="flex justify-end gap-4">
                                <button id="modal-save-key-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-lg">Save Key</button>
                            </div>
                        </div>
                    </div>`;
                    
                    document.getElementById('modal-save-key-btn').onclick = () => {
                        const key = document.getElementById('modal-api-key-input').value;
                        if (key) {
                            localStorage.setItem('geminiApiKey', key);
                            this.state.ownerState.promptGenerator.geminiApiKey = key;
                            this.elements.modalContainer.innerHTML = '';
                            this.showNotification('API Key Saved!');
                        } else {
                            this.showNotification('Please enter a valid key.', 'error');
                        }
                    };
                },
                showPromptModal(title, placeholder, onSubmit) {
                     this.elements.modalContainer.innerHTML = `<div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10000] p-4"><form id="prompt-form" class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md"><h2 class="text-2xl font-bold mb-4">${title}</h2><input type="text" id="modal-input" class="w-full p-3 bg-gray-900 rounded-lg mb-6" placeholder="${placeholder}"><div class="flex justify-end gap-4"><button type="button" id="modal-cancel" class="bg-gray-600 py-2 px-6 rounded-lg">Cancel</button><button type="submit" class="bg-green-600 py-2 px-6 rounded-lg">Submit</button></div></form></div>`;
                     const form = this.elements.modalContainer.querySelector('#prompt-form');
                     const input = form.querySelector('#modal-input');
                     input.focus();
                     const close = () => this.elements.modalContainer.innerHTML = '';
                     this.elements.modalContainer.querySelector('#modal-cancel').onclick = close;
                     form.onsubmit = (e) => { e.preventDefault(); onSubmit(input.value); close(); };
                },
                copyToClipboard(text, message) { if (!text) return; navigator.clipboard.writeText(text).then(() => this.showNotification(message), () => this.showNotification("Failed to copy.", 'error')); },
                showNotification(message, type = 'success') {
                    const el = this.elements.notification;
                    el.textContent = message;
                    el.className = `fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl z-[10001] fade-in ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
                    setTimeout(() => { el.className = el.className.replace('fade-in', ''); }, 3500);
                },
            };
            
            app.init();
        });
    </script>
</body>
</html>
