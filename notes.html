<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reputifly | Note Taker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/feather-icons"></script>

    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js' defer></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
      // Initialize Tailwind CSS custom theme
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'accent-primary': 'var(--accent-primary)',
              'accent-primary-dark': 'var(--accent-primary-dark)',
              'bg-main': 'var(--bg-main)',
              'bg-pane-light': 'var(--bg-pane-light)',
              'bg-pane-dark': 'var(--bg-pane-dark)',
              'text-primary': 'var(--text-primary)',
              'text-secondary': 'var(--text-secondary)',
              'text-tertiary': 'var(--text-tertiary)',
              'border-color': 'var(--border-color)',
            }
          }
        }
      }
    </script>

    <style type="text/tailwindcss">
        /* --- Base & Color Variables --- */
        :root {
            --bg-main: #FFFFFF;
            --bg-pane-light: #F9F9F9;
            --bg-pane-dark: #F4F4F4;
            --text-primary: #1a1a1a;
            --text-secondary: #555555;
            --text-tertiary: #888888;
            --accent-primary: #007aff; /* New Accent Blue */
            --accent-primary-dark: #007aff;
            --border-color: #EAEAEA;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        .dark {
            --bg-main: #111827; /* Charcoal */
            --bg-pane-light: #1f2937;
            --bg-pane-dark: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --accent-primary: #3898ff; /* Lighter blue for dark mode */
            --accent-primary-dark: #007aff;
            --border-color: #374151;
            --shadow-color: rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* --- UI Polish & Animations --- */
        .pane-resizer { transition: background-color 0.2s ease; }
        .pane-resizer:hover, .pane-resizer.dragging { background-color: var(--accent-primary); }

        .collection-item .chevron { transition: transform 0.15s ease; }
        .collection-item.open > .chevron { transform: rotate(90deg); }
        .collection-item-wrapper.drop-target-folder { background-color: rgba(0, 122, 255, 0.1); }
        .dark .collection-item-wrapper.drop-target-folder { background-color: rgba(56, 152, 255, 0.15); }
        
        .kanban-card {
            height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .kanban-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -4px var(--shadow-color); }
        .kanban-card.dragging { opacity: 0.5; transform: rotate(3deg); }

        /* Pinned Card Style */
        .kanban-card.pinned, .list-note-item.pinned {
            border-color: var(--accent-primary);
            box-shadow: 0 0 8px -2px var(--accent-primary);
        }
        .kanban-card.pinned {
            transform: scale(1.02);
        }
        .kanban-card.pinned:hover {
             transform: scale(1.02) translateY(-4px);
        }
        
        .drop-target-column { background-color: var(--accent-primary) !important; opacity: 0.2; }
        .drop-indicator { height: 2px; background-color: var(--accent-primary); margin: -1px 0; }
        
        .context-menu, .dropdown-menu { transition: opacity 100ms ease, transform 100ms ease; }
        
        /* Note Editor Placeholders & Content Styling */
        #note-editor-body:empty:before {
            content: attr(data-placeholder);
            color: var(--text-tertiary);
            pointer-events: none;
            display: block;
        }
        #note-editor-body a, #markdown-preview a {
            color: var(--accent-primary-dark);
            text-decoration: underline;
            cursor: pointer;
        }
        .dark #note-editor-body a, .dark #markdown-preview a {
            color: var(--accent-primary);
        }
        #note-editor-body ul, #markdown-preview ul { list-style: disc; padding-left: 2rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        #note-editor-body ol, #markdown-preview ol { list-style: decimal; padding-left: 2rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        #note-editor-body h1, #note-editor-body h2, #note-editor-body h3,
        #markdown-preview h1, #markdown-preview h2, #markdown-preview h3 {
             font-weight: 700;
             line-height: 1.2;
             margin-top: 1em;
             margin-bottom: 0.5em;
             padding-bottom: 0.3em;
             border-bottom: 1px solid var(--border-color);
        }
        #note-editor-body h1, #markdown-preview h1 { font-size: 2.25rem; }
        #note-editor-body h2, #markdown-preview h2 { font-size: 1.875rem; }
        #note-editor-body h3, #markdown-preview h3 { font-size: 1.5rem; }
        #note-editor-body img, #markdown-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 0.5em 0;
            cursor: default;
        }
        #markdown-preview blockquote {
            border-left: 4px solid var(--border-color);
            padding-left: 1em;
            margin-left: 0;
            color: var(--text-secondary);
        }
        #markdown-preview code {
            background-color: var(--bg-pane-dark);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
        }
        #markdown-preview pre {
            background-color: var(--bg-pane-dark);
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
        }
        #markdown-preview pre code {
            padding: 0;
            background-color: transparent;
        }

        /* Hide scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Search Results Highlighting */
        #search-results-view mark {
            background-color: #ffde59;
            border-radius: 3px;
            padding: 1px 2px;
        }
        .dark #search-results-view mark {
            background-color: #ffde59;
            color: #111827;
        }
        
        .column-header:hover .delete-column-btn { opacity: 1; }

        /* Mobile specific styles */
        @media (max-width: 768px) {
            #app-container {
                flex-direction: column;
            }
            #notes-list-pane {
                width: 100% !important; /* Override inline style */
                height: 100%;
                border-right: none;
            }
            #editor-pane {
                 width: 100%;
                 height: 100%;
            }
            #pane-resizer { display: none; }
            #desktop-new-note-btn { display: none; }
            #mobile-new-note-fab { display: flex; }
        }
    </style>
    
    <script>
      // Avoids FOUC (Flash of Unstyled Content) for dark mode
      try {
        const theme = localStorage.getItem('codex-notes-theme') || 'light';
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        }
      } catch (e) {}
    </script>
</head>
<body class="overflow-hidden">

    <div id="app-container" class="flex h-screen bg-bg-main">

        <aside id="notes-list-pane" class="w-[280px] bg-bg-pane-light border-r border-border-color flex flex-col flex-shrink-0 relative">
            <header class="flex justify-between items-center p-4 border-b border-border-color flex-shrink-0">
                <h1 class="font-bold text-lg">Collections</h1>
                <button id="new-collection-btn" class="text-text-secondary hover:text-accent-primary transition-colors" title="New Collection"><i data-feather="plus"></i></button>
            </header>
            <div id="collections-list-container" class="flex-grow p-2 overflow-y-auto"></div>
            <div id="pane-resizer" class="pane-resizer w-1.5 absolute top-0 right-[-3px] bottom-0 cursor-col-resize z-10 hidden md:block"></div>
        </aside>

        <main id="editor-pane" class="flex-grow bg-bg-main flex-col md:flex hidden">
           <header class="flex justify-between items-center p-4 border-b border-border-color flex-shrink-0 gap-4">
              <div class="flex items-center gap-2 flex-1 min-w-0">
                <button id="mobile-back-button" class="md:hidden p-1 -ml-2"><i data-feather="arrow-left"></i></button>
                <h2 id="current-view-title" class="text-lg font-semibold truncate"></h2>
              </div>
              
              <div id="main-header-controls" class="flex items-center gap-2 md:gap-3">
                  <div id="list-view-controls" class="hidden items-center gap-2">
                    <label for="sort-order" class="text-sm text-text-secondary hidden md:inline">Sort by:</label>
                    <select id="sort-order" class="bg-bg-pane-dark text-text-primary text-sm rounded-md p-1 border-0 focus:ring-2 focus:ring-accent-primary">
                        <option value="modifiedAt-desc">Last Modified</option>
                        <option value="createdAt-desc">Date Created</option>
                        <option value="name-asc">Title (A-Z)</option>
                    </select>
                  </div>
                  
                  <div id="view-switcher-container" class="view-switcher bg-bg-pane-dark p-1 rounded-lg hidden md:flex">
                      <button class="view-btn active px-3 py-1 rounded-md" title="Board View" data-view="board"><i data-feather="trello"></i></button>
                      <button class="view-btn px-3 py-1 rounded-md" title="List View" data-view="list"><i data-feather="list"></i></button>
                  </div>
                  
                  <div class="w-px h-6 bg-border-color hidden md:block mx-1"></div>

                  <button id="editor-mode-toggle" class="p-2 hover:bg-bg-pane-dark rounded editor-only-control hidden" title="Toggle Markdown Preview"><i data-feather="eye" class="w-5 h-5"></i></button>
                  <button data-command="ocr" class="p-2 hover:bg-bg-pane-dark rounded editor-only-control hidden" title="Scan Image for Text"><i data-feather="camera" class="w-5 h-5"></i></button>
                  <input type="file" id="ocr-file-input" class="hidden" accept="image/*">

                   <button id="search-icon" class="p-2 hover:bg-bg-pane-dark rounded-full" title="Search (Cmd+F)"><i data-feather="search" class="text-text-secondary"></i></button>
                  <button id="theme-toggle" class="p-2 hover:bg-bg-pane-dark rounded-full" title="Toggle Theme">
                   <i data-feather="sun" id="theme-sun-icon" class="text-text-secondary"></i>
                   <i data-feather="moon" id="theme-moon-icon" class="hidden text-text-secondary"></i>
                  </button>
                 <div class="relative">
                    <div id="avatar" class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 text-white flex items-center justify-center font-bold cursor-pointer">
                        <span>A</span>
                    </div>
                    <div id="settings-menu" class="dropdown-menu hidden absolute top-full right-0 mt-2 w-48 bg-bg-pane-light shadow-2xl rounded-md p-2 border border-border-color origin-top-right scale-95 opacity-0 z-20">
                        <button data-action="import" class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2"><i data-feather="upload" class="w-4 h-4"></i>Import Data</button>
                        <button data-action="export" class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2"><i data-feather="download" class="w-4 h-4"></i>Export Data</button>
                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                    </div>
                 </div>
                 <button id="desktop-new-note-btn" class="bg-accent-primary text-white px-4 py-2 rounded-lg font-semibold text-sm items-center gap-2 hover:opacity-90 transition-opacity hidden md:flex" title="New Note (Cmd+N)">New Note</button>
              </div>
           </header>
           
           <div id="main-content-area" class="flex-grow overflow-y-auto relative">
                <div id="board-view" class="notes-view active flex-grow p-5 overflow-x-auto no-scrollbar h-full">
                    <div id="kanban-board" class="flex gap-5 min-h-full"></div>
                </div>

                <div id="list-view" class="notes-view hidden p-5">
                    <div id="notes-list-content" class="space-y-3"></div>
                </div>
               
                <div id="note-editor-view" class="notes-view hidden flex-grow flex flex-col overflow-y-auto">
                     <div class="p-8 pb-4">
                        <input id="note-editor-title" type="text" placeholder="Untitled Note" class="text-4xl font-bold bg-transparent focus:outline-none mb-4 w-full">
                    </div>
                    <div id="note-editor-body" contenteditable="true" class="flex-grow text-lg leading-relaxed focus:outline-none p-8 pt-0" data-placeholder="Start writing or drop an image..."></div>
                    <div id="markdown-preview" class="hidden flex-grow text-lg leading-relaxed focus:outline-none p-8 pt-0 prose"></div>
                </div>

                <div id="search-results-view" class="notes-view hidden p-8">
                    <h2 class="text-2xl font-bold mb-6">Search Results</h2>
                    <div id="search-results-list"></div>
                </div>
           </div>
        </main>
    </div>
    
    <button id="mobile-new-note-fab" class="hidden fixed bottom-6 right-6 bg-accent-primary text-white w-14 h-14 rounded-full shadow-lg items-center justify-center z-20 hover:opacity-90 transition-opacity">
        <i data-feather="plus" class="w-8 h-8"></i>
    </button>
    
    <div id="modal-backdrop" class="fixed inset-0 bg-black/30 z-40 hidden transition-opacity duration-300"></div>
    
    <div id="prompt-modal" class="modal fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-bg-pane-light p-6 rounded-lg shadow-2xl w-full max-w-md z-50 hidden transition-all duration-300 transform scale-95 opacity-0">
        <h3 id="prompt-title" class="text-lg font-semibold mb-4">Input Required</h3>
        <p id="prompt-message" class="text-sm text-text-secondary mb-3"></p>
        <input id="prompt-input" type="text" class="w-full bg-bg-pane-dark border border-border-color rounded-md p-2 focus:ring-2 focus:ring-accent-primary focus:outline-none">
        <p id="prompt-error" class="text-red-500 text-sm mt-1 h-5"></p>
        <div class="flex justify-end gap-3 mt-4">
            <button id="prompt-cancel-btn" class="px-4 py-2 rounded-md bg-bg-pane-dark hover:opacity-80">Cancel</button>
            <button id="prompt-confirm-btn" class="px-4 py-2 rounded-md bg-accent-primary text-white hover:opacity-90">Confirm</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-bg-pane-light p-6 rounded-lg shadow-2xl w-full max-w-md z-50 hidden transition-all duration-300 transform scale-95 opacity-0">
        <h3 id="confirm-title" class="text-lg font-semibold mb-4">Are you sure?</h3>
        <p id="confirm-message" class="text-sm text-text-secondary mb-6"></p>
        <div class="flex justify-end gap-3 mt-4">
            <button id="confirm-cancel-btn" class="px-4 py-2 rounded-md bg-bg-pane-dark hover:opacity-80">Cancel</button>
            <button id="confirm-confirm-btn" class="px-4 py-2 rounded-md bg-red-600 text-white hover:opacity-90">Delete</button>
        </div>
    </div>
    
    <div id="search-bar-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 transition-all duration-300 ease-in-out origin-top" style="transform: scale(0.5); opacity: 0; pointer-events: none;">
        <div class="w-[95vw] max-w-[500px] bg-bg-pane-dark rounded-full shadow-lg flex items-center px-4">
            <i data-feather="search" class="text-text-tertiary"></i>
            <input id="search-input" type="text" placeholder="Search notes and folders..." class="w-full bg-transparent p-3 focus:outline-none text-text-primary">
            <button id="search-close-btn" class="text-text-tertiary text-xs">ESC</button>
        </div>
    </div>

    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] transition-all duration-300 ease-in-out origin-top flex flex-col items-center gap-2" style="pointer-events: none;"></div>
    
    <div id="inline-toolbar" class="absolute z-30 bg-bg-pane-dark p-1 rounded-lg shadow-md flex items-center gap-1 transition-all duration-150 transform scale-95 opacity-0" style="pointer-events: none;">
        <button data-command="bold" class="p-2 hover:bg-bg-main rounded"><i data-feather="bold" class="w-4 h-4"></i></button>
        <button data-command="italic" class="p-2 hover:bg-bg-main rounded"><i data-feather="italic" class="w-4 h-4"></i></button>
        <button data-command="createLink" class="p-2 hover:bg-bg-main rounded"><i data-feather="link" class="w-4 h-4"></i></button>
        <button data-command="insertImage" class="p-2 hover:bg-bg-main rounded"><i data-feather="image" class="w-4 h-4"></i></button>
        <button data-command="insertUnorderedList" class="p-2 hover:bg-bg-main rounded"><i data-feather="list" class="w-4 h-4"></i></button>
        <div class="w-px h-5 bg-border-color mx-1"></div>
        <button data-command="formatBlock" data-value="h1" class="p-2 hover:bg-bg-main rounded font-bold text-sm">H1</button>
        <button data-command="formatBlock" data-value="h2" class="p-2 hover:bg-bg-main rounded font-bold text-sm">H2</button>
        <button data-command="formatBlock" data-value="h3" class="p-2 hover:bg-bg-main rounded font-bold text-sm">H3</button>
    </div>

    <div id="context-menu" class="context-menu fixed z-50 bg-bg-pane-light shadow-2xl rounded-md p-2 w-48 border border-border-color hidden origin-top-left scale-95 opacity-0">
        <button data-action="new-note" class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2"><i data-feather="file-plus" class="w-4 h-4"></i>New Note</button>
        <button data-action="new-folder" class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2"><i data-feather="folder-plus" class="w-4 h-4"></i>New Folder</button>
        <hr class="my-1 border-border-color">
        <button data-action="toggle-pin" class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2"><i data-feather="paperclip" class="w-4 h-4"></i><span id="pin-action-text">Pin</span></button>
        <button data-action="duplicate" class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2"><i data-feather="copy" class="w-4 h-4"></i>Duplicate</button>
        <button data-action="rename" class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2"><i data-feather="edit-2" class="w-4 h-4"></i>Rename</button>
        <button data-action="delete" class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark text-red-500 rounded flex items-center gap-2"><i data-feather="trash-2" class="w-4 h-4"></i>Delete</button>
    </div>


    <script>
        // --- Feather Icons Initialization ---
        feather.replace();

        // --- MAIN APP SCRIPT ---
        document.addEventListener('DOMContentLoaded', () => {

            // =================================================================
            // 1. DOM ELEMENT SELECTORS
            // =================================================================
            const app = {
                containers: {
                    app: document.getElementById('app-container'),
                    collectionsList: document.getElementById('collections-list-container'),
                    kanbanBoard: document.getElementById('kanban-board'),
                    notesListContent: document.getElementById('notes-list-content'),
                    noteEditor: document.getElementById('note-editor-view'),
                    toast: document.getElementById('toast-container'),
                    mainContentArea: document.getElementById('main-content-area'),
                    searchResultsList: document.getElementById('search-results-list'),
                },
                elements: {
                    notesListPane: document.getElementById('notes-list-pane'),
                    editorPane: document.getElementById('editor-pane'),
                    paneResizer: document.getElementById('pane-resizer'),
                    themeToggle: document.getElementById('theme-toggle'),
                    themeSunIcon: document.getElementById('theme-sun-icon'),
                    themeMoonIcon: document.getElementById('theme-moon-icon'),
                    newCollectionBtn: document.getElementById('new-collection-btn'),
                    desktopNewNoteBtn: document.getElementById('desktop-new-note-btn'),
                    mobileNewNoteFab: document.getElementById('mobile-new-note-fab'),
                    currentViewTitle: document.getElementById('current-view-title'),
                    noteEditorTitle: document.getElementById('note-editor-title'),
                    noteEditorBody: document.getElementById('note-editor-body'),
                    markdownPreview: document.getElementById('markdown-preview'),
                    mobileBackButton: document.getElementById('mobile-back-button'),
                    sortOrderSelect: document.getElementById('sort-order'),
                    listViewControls: document.getElementById('list-view-controls'),
                    viewSwitcher: document.getElementById('view-switcher-container'),
                    avatar: document.getElementById('avatar'),
                    settingsMenu: document.getElementById('settings-menu'),
                    importFileInput: document.getElementById('import-file-input'),
                },
                modals: {
                    backdrop: document.getElementById('modal-backdrop'),
                    prompt: document.getElementById('prompt-modal'),
                    promptTitle: document.getElementById('prompt-title'),
                    promptMessage: document.getElementById('prompt-message'),
                    promptInput: document.getElementById('prompt-input'),
                    promptError: document.getElementById('prompt-error'),
                    promptConfirmBtn: document.getElementById('prompt-confirm-btn'),
                    promptCancelBtn: document.getElementById('prompt-cancel-btn'),
                    confirm: document.getElementById('confirm-modal'),
                    confirmTitle: document.getElementById('confirm-title'),
                    confirmMessage: document.getElementById('confirm-message'),
                    confirmConfirmBtn: document.getElementById('confirm-confirm-btn'),
                    confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
                },
                search: {
                    icon: document.getElementById('search-icon'),
                    container: document.getElementById('search-bar-container'),
                    input: document.getElementById('search-input'),
                    closeBtn: document.getElementById('search-close-btn'),
                },
                toolbar: {
                    inline: document.getElementById('inline-toolbar'),
                    editorModeToggle: document.getElementById('editor-mode-toggle'),
                    ocrBtn: document.querySelector('[data-command="ocr"]'),
                    ocrFileInput: document.getElementById('ocr-file-input'),
                },
                views: {
                    board: document.getElementById('board-view'),
                    list: document.getElementById('list-view'),
                    searchResults: document.getElementById('search-results-view'),
                },
                contextMenu: {
                    menu: document.getElementById('context-menu'),
                    targetId: null,
                    targetIsContainer: false,
                    pinActionText: document.getElementById('pin-action-text'),
                    togglePinBtn: document.querySelector('[data-action="toggle-pin"]'),
                    renameBtn: document.querySelector('[data-action="rename"]'),
                    deleteBtn: document.querySelector('[data-action="delete"]'),
                    duplicateBtn: document.querySelector('[data-action="duplicate"]'),
                }
            };

            // =================================================================
            // 2. STATE MANAGEMENT & DATA MODEL
            // =================================================================
            let state = {};
            let isSearchActive = false;

            const defaultState = {
                collections: [
                    { id: 'c1', name: 'Product Design', type: 'folder', children: [
                        { id: 'n1', name: 'UI/UX Principles', type: 'note', content: '<h1>Hick\'s Law</h1><p>The time it takes to make a decision increases with the number and complexity of choices. Also known as the Hick–Hyman law.</p>', status: 'col1', pinned: true, createdAt: new Date(Date.now() - 86400000 * 2).toISOString(), modifiedAt: new Date(Date.now() - 86400000 * 2).toISOString() },
                        { id: 'n2', name: 'Inspiration', type: 'note', content: 'Check out Dribbble, Awwwards, and Behance for design inspiration.', status: 'col2', pinned: false, createdAt: new Date(Date.now() - 86400000).toISOString(), modifiedAt: new Date().toISOString() },
                    ], expanded: true },
                    { id: 'c2', name: 'Marketing', type: 'folder', children: [], expanded: false },
                    { id: 'n3', name: 'Standalone Note', type: 'note', content: 'A standalone note, not in any project.', status: null, pinned: false, createdAt: new Date(Date.now() - 86400000 * 3).toISOString(), modifiedAt: new Date(Date.now() - 86400000).toISOString() },
                ],
                settings: {
                    theme: 'light',
                    activeCollectionId: null,
                    activeNoteId: null,
                    paneWidth: 280,
                    activeView: 'board', // 'board' or 'list'
                    listSortOrder: 'modifiedAt-desc',
                    editorMode: 'editor', // 'editor' or 'preview'
                    mobileView: 'collections' // 'collections' or 'main'
                },
                kanbanColumns: {
                    'c1': [ { id: 'col1', title: 'To Do' }, { id: 'col2', title: 'In Progress' } ],
                    'c2': [ { id: 'ideas', title: 'Ideas' } ],
                }
            };

            function saveState() {
                try {
                    localStorage.setItem('codex-notes-appState-v3', JSON.stringify(state));
                } catch (error) {
                    console.error("Failed to save state:", error);
                    showToast("Error saving data. Storage might be full.", 'error');
                }
            }
            
            function migrateState(loadedState) {
                // This function can be expanded to handle future state migrations
                const migrateNode = (node) => {
                    if (node.type === 'note') {
                        if (typeof node.pinned === 'undefined') node.pinned = false;
                        const now = new Date().toISOString();
                        if (typeof node.createdAt === 'undefined') node.createdAt = now;
                        if (typeof node.modifiedAt === 'undefined') node.modifiedAt = node.createdAt;
                    }
                    if (node.children) {
                        node.children.forEach(migrateNode);
                    }
                };
                if (!loadedState.settings) loadedState.settings = {};
                if (!loadedState.settings.listSortOrder) loadedState.settings.listSortOrder = 'modifiedAt-desc';
                if (!loadedState.settings.editorMode) loadedState.settings.editorMode = 'editor';
                if (!loadedState.settings.mobileView) loadedState.settings.mobileView = 'collections';

                if (!loadedState.collections) loadedState.collections = [];
                if (!loadedState.kanbanColumns) loadedState.kanbanColumns = {};

                loadedState.collections.forEach(migrateNode);
                return loadedState;
            }

            function loadState() {
                const savedState = localStorage.getItem('codex-notes-appState-v3');
                let parsedState = savedState ? JSON.parse(savedState) : JSON.parse(JSON.stringify(defaultState));
                state = migrateState(parsedState);
                state.settings.theme = localStorage.getItem('codex-notes-theme') || 'light';
            }

            // =================================================================
            // 3. UTILITY & HELPER FUNCTIONS
            // =================================================================
            const generateId = (prefix = 'id') => `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            function findItem(itemId, tree = state.collections) {
                for (let i = 0; i < tree.length; i++) {
                    const item = tree[i];
                    if (item.id === itemId) return {item, parent: tree, index: i};
                    if (item.children) {
                        const { item: foundItem, parent: foundParent, index: foundIndex } = findItem(itemId, item.children) || {};
                        if(foundItem) return { item: foundItem, parent: item, index: foundIndex };
                    }
                }
                return null;
            }
            
            const getAllNotes = (items) => {
                let notes = [];
                for (const item of items) {
                    if (item.type === 'note') {
                        notes.push(item);
                    }
                    if (item.type === 'folder' && item.children) {
                        notes = notes.concat(getAllNotes(item.children));
                    }
                }
                return notes;
            };

            const debounce = (func, delay) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            };
            
            const showToast = (message, type = 'info') => {
                const id = generateId('toast');
                const toast = document.createElement('div');
                const colors = {
                    info: 'bg-bg-pane-dark text-text-primary',
                    success: 'bg-green-500 text-white',
                    error: 'bg-red-500 text-white',
                    loading: 'bg-blue-500 text-white animate-pulse'
                }
                toast.id = id;
                toast.className = `toast-item ${colors[type]} rounded-full px-4 py-2 text-sm shadow-lg transition-all duration-300 transform translate-y-[-20px] opacity-0`;
                toast.textContent = message;
                
                app.containers.toast.appendChild(toast);
                app.containers.toast.style.pointerEvents = 'auto';

                setTimeout(() => {
                    toast.classList.remove('translate-y-[-20px]', 'opacity-0');
                }, 10);
                
                if (type !== 'loading') {
                    setTimeout(() => {
                        toast.classList.add('opacity-0', 'scale-90');
                        toast.addEventListener('transitionend', () => {
                             if(toast.parentElement) toast.parentElement.removeChild(toast);
                             if (app.containers.toast.childElementCount === 0) {
                                app.containers.toast.style.pointerEvents = 'none';
                             }
                        });
                    }, 3000);
                }
                return id; // Return ID to allow for manual dismissal
            };
            
            const dismissToast = (toastId) => {
                const toast = document.getElementById(toastId);
                if (toast) {
                    toast.classList.add('opacity-0', 'scale-90');
                    toast.addEventListener('transitionend', () => {
                         if(toast.parentElement) toast.parentElement.removeChild(toast);
                         if (app.containers.toast.childElementCount === 0) {
                            app.containers.toast.style.pointerEvents = 'none';
                         }
                    });
                }
            };

            const highlightText = (text, query) => {
                if (!query || !text) return text;
                const regex = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                return text.replace(regex, `<mark>$1</mark>`);
            };
            
            const formatDateTime = (isoString) => {
                 return new Date(isoString).toLocaleString(undefined, {
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: 'numeric', minute: '2-digit', hour12: true
                 }).replace(/, /g, ', ');
            };
            
            const isMobile = () => window.innerWidth <= 768;


            // =================================================================
            // 4. MODAL & DIALOG SYSTEM
            // =================================================================
            const openModal = (modal) => {
                app.modals.backdrop.classList.remove('hidden');
                modal.classList.remove('hidden');
                setTimeout(() => {
                    app.modals.backdrop.style.opacity = '1';
                    modal.classList.remove('scale-95', 'opacity-0');
                }, 10);
            };

            const closeModal = (modal) => {
                app.modals.backdrop.style.opacity = '0';
                modal.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    app.modals.backdrop.classList.add('hidden');
                    modal.classList.add('hidden');
                }, 300);
            };

            const showPrompt = ({ title, message, initialValue = '', placeholder = '' }) => {
                return new Promise((resolve) => {
                    app.modals.promptTitle.textContent = title;
                    app.modals.promptMessage.textContent = message;
                    app.modals.promptInput.value = initialValue;
                    app.modals.promptInput.placeholder = placeholder;
                    app.modals.promptError.textContent = '';
                    
                    openModal(app.modals.prompt);
                    app.modals.promptInput.focus();
                    app.modals.promptInput.select();

                    const confirmHandler = () => {
                        const value = app.modals.promptInput.value.trim();
                        if (value) {
                            cleanup();
                            resolve(value);
                        } else {
                            app.modals.promptError.textContent = 'Input cannot be empty.';
                        }
                    };

                    const cancelHandler = () => {
                        cleanup();
                        resolve(null);
                    };

                    const cleanup = () => {
                        app.modals.promptConfirmBtn.removeEventListener('click', confirmHandler);
                        app.modals.promptCancelBtn.removeEventListener('click', cancelHandler);
                        app.modals.backdrop.removeEventListener('click', backdropHandler);
                        closeModal(app.modals.prompt);
                    };
                    
                    const backdropHandler = () => cancelHandler();

                    app.modals.promptConfirmBtn.addEventListener('click', confirmHandler);
                    app.modals.promptCancelBtn.addEventListener('click', cancelHandler);
                    app.modals.backdrop.addEventListener('click', backdropHandler);
                });
            };
            
            const showConfirm = ({ title, message, confirmText = 'Confirm', confirmClass = 'bg-red-600' }) => {
                 return new Promise((resolve) => {
                    app.modals.confirmTitle.textContent = title;
                    app.modals.confirmMessage.innerHTML = message;
                    app.modals.confirmConfirmBtn.textContent = confirmText;
                    app.modals.confirmConfirmBtn.className = `px-4 py-2 rounded-md text-white hover:opacity-90 ${confirmClass}`;

                    openModal(app.modals.confirm);

                    const confirmHandler = () => { cleanup(); resolve(true); };
                    const cancelHandler = () => { cleanup(); resolve(false); };
                    const backdropHandler = () => cancelHandler();

                    const cleanup = () => {
                        app.modals.confirmConfirmBtn.removeEventListener('click', confirmHandler);
                        app.modals.confirmCancelBtn.removeEventListener('click', cancelHandler);
                        app.modals.backdrop.removeEventListener('click', backdropHandler);
                        closeModal(app.modals.confirm);
                    };

                    app.modals.confirmConfirmBtn.addEventListener('click', confirmHandler);
                    app.modals.confirmCancelBtn.addEventListener('click', cancelHandler);
                    app.modals.backdrop.addEventListener('click', backdropHandler);
                });
            };

            // =================================================================
            // 5. RENDERING FUNCTIONS
            // =================================================================
            function render() {
                renderLayout();
                renderTheme();
                renderCollectionsList();
                renderMainView();
                renderMobileFab();
                feather.replace(); 
            }
            
            function renderLayout() {
                if (isMobile()) {
                    if (state.settings.mobileView === 'collections') {
                        app.elements.notesListPane.classList.remove('hidden');
                        app.elements.editorPane.classList.add('hidden');
                        app.elements.mobileBackButton.classList.add('hidden');
                    } else { // 'main' view
                        app.elements.notesListPane.classList.add('hidden');
                        app.elements.editorPane.classList.remove('hidden');
                        app.elements.editorPane.classList.add('flex'); // ensure flex is on
                        app.elements.mobileBackButton.classList.remove('hidden');
                    }
                } else { // Desktop
                    app.elements.notesListPane.classList.remove('hidden');
                    app.elements.editorPane.classList.remove('hidden');
                    app.elements.editorPane.classList.add('flex');
                    app.elements.mobileBackButton.classList.add('hidden');
                }
            }
            
            function renderTheme() {
                if (state.settings.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    app.elements.themeSunIcon.classList.add('hidden');
                    app.elements.themeMoonIcon.classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    app.elements.themeSunIcon.classList.remove('hidden');
                    app.elements.themeMoonIcon.classList.add('hidden');
                }
            }

            function renderCollectionsList(collections = state.collections, level = 0) {
                const createItemHTML = (item, currentLevel) => {
                    const isActive = item.id === state.settings.activeCollectionId || item.id === state.settings.activeNoteId;
                    const isFolder = item.type === 'folder';
                    
                    if (isFolder && item.children) {
                        item.children.sort((a, b) => (b.pinned || 0) - (a.pinned || 0) || a.name.localeCompare(b.name));
                    }

                    return `
                        <li data-id="${item.id}" draggable="true" class="collection-item-wrapper rounded-md">
                            <a href="#" class="collection-item flex items-center gap-2 p-2 rounded-md hover:bg-bg-pane-dark ${isActive ? 'bg-bg-pane-dark font-semibold' : ''}" style="padding-left: ${8 + currentLevel * 16}px;">
                                ${isFolder ? `<i data-feather="chevron-right" class="chevron w-4 h-4 flex-shrink-0 text-text-tertiary ${item.expanded ? 'open' : ''}"></i>` : ''}
                                <i data-feather="${isFolder ? 'folder' : (item.pinned ? 'paperclip' : 'file-text')}" class="w-4 h-4 flex-shrink-0 text-text-secondary ${item.pinned ? 'text-accent-primary': ''}"></i>
                                <span class="truncate flex-grow">${item.name}</span>
                            </a>
                            ${isFolder && item.expanded && item.children ? `<ul class="collection-children">${renderCollectionsList(item.children, currentLevel + 1)}</ul>` : ''}
                        </li>
                    `;
                };
                
                collections.sort((a, b) => {
                    const aIsFolder = a.type === 'folder';
                    const bIsFolder = b.type === 'folder';
                    if (aIsFolder !== bIsFolder) {
                        return aIsFolder ? -1 : 1;
                    }
                    return a.name.localeCompare(b.name);
                });
                const listHTML = collections.map(item => createItemHTML(item, level)).join('');
                
                if (level === 0) {
                    app.containers.collectionsList.innerHTML = `<ul class="space-y-1">${listHTML}</ul>`;
                }
                return listHTML;
            }

            function renderMainView() {
                if (isSearchActive) {
                    renderSearchResults(app.search.input.value);
                    return;
                }
                
                const activeCollection = findItem(state.settings.activeCollectionId)?.item;
                app.elements.currentViewTitle.textContent = activeCollection?.name || (isMobile() ? "" : "All Notes");

                const isNoteActive = !!state.settings.activeNoteId;
                
                // Show/hide editor-specific controls in the new header
                document.querySelectorAll('.editor-only-control').forEach(el => {
                    el.classList.toggle('hidden', !isNoteActive);
                });

                app.elements.desktopNewNoteBtn.style.display = isNoteActive ? 'none' : 'flex';
                app.elements.viewSwitcher.style.display = isNoteActive || !activeCollection ? 'none' : 'flex';
                app.elements.listViewControls.style.display = !isNoteActive && state.settings.activeView === 'list' ? 'flex' : 'none';

                document.querySelectorAll('.notes-view').forEach(v => v.classList.add('hidden'));

                if (isNoteActive) {
                    renderNoteEditor();
                } else if (activeCollection) {
                     document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                     document.querySelector(`.view-btn[data-view="${state.settings.activeView}"]`)?.classList.add('active');
                    
                    if (state.settings.activeView === 'board') {
                        app.views.board.classList.remove('hidden');
                        renderKanbanView();
                    } else {
                        app.views.list.classList.remove('hidden');
                        renderListView();
                    }
                } else { // No collection or note selected (e.g. "All Notes" view)
                     app.views.list.classList.remove('hidden');
                     renderListView();
                }
            }
            
            function renderMobileFab() {
                if (!isMobile()) {
                    app.elements.mobileNewNoteFab.classList.add('hidden');
                    return;
                }
                app.elements.mobileNewNoteFab.classList.remove('hidden');
            }

            function renderKanbanView() {
                const collectionId = state.settings.activeCollectionId;
                const collection = findItem(collectionId)?.item;

                if (!collection || collection.type !== 'folder') {
                    app.containers.kanbanBoard.innerHTML = `<div class="text-center p-10 text-text-secondary"><i data-feather="trello" class="w-12 h-12 mx-auto mb-4"></i><h3 class="font-semibold">Board View</h3><p>This view is only available for project folders.</p></div>`;
                    feather.replace();
                    return;
                }
                
                const columns = state.kanbanColumns[collectionId] || [];
                const notes = collection.children.filter(c => c.type === 'note') || [];
                
                const columnsHTML = columns.map(column => {
                    const cardsHTML = notes
                        .filter(note => note.status === column.id)
                        .sort((a, b) => (b.pinned || 0) - (a.pinned || 0))
                        .map(note => {
                            const date = formatDateTime(note.modifiedAt);
                            const pinnedClass = note.pinned ? 'pinned' : '';
                            return `
                                <div class="kanban-card bg-bg-main p-3 rounded-md shadow-sm border border-border-color mb-3 cursor-pointer hover:shadow-lg transition-all ${pinnedClass}" draggable="true" data-note-id="${note.id}">
                                    <div class="pointer-events-none">
                                        <h4 class="font-semibold pointer-events-none">${note.name}</h4>
                                        <p class="text-sm text-text-secondary mt-1 pointer-events-none overflow-hidden text-ellipsis">${note.content.replace(/<[^>]*>?/gm, '').substring(0, 50)}...</p>
                                    </div>
                                    <div class="text-xs text-text-tertiary mt-2 pointer-events-none">Modified: ${date}</div>
                                </div>
                            `;
                        }).join('');

                    return `
                        <div class="kanban-column w-[300px] flex-shrink-0 bg-bg-pane-dark p-3 rounded-lg" data-column-id="${column.id}">
                            <div class="column-header flex justify-between items-center font-semibold mb-3 text-text-primary">
                                <span class="rename-column-btn cursor-pointer flex-grow p-1">${column.title}</span>
                                <button class="delete-column-btn text-text-tertiary hover:text-red-500 opacity-0 transition-opacity p-1"><i data-feather="x" class="w-4 h-4"></i></button>
                            </div>
                            <div class="cards-container min-h-[100px]">${cardsHTML}</div>
                        </div>
                    `;
                }).join('');
                
                const addColumnBtnHTML = columns.length < 5 ? `
                     <div class="w-[300px] flex-shrink-0">
                        <button id="add-column-btn" class="w-full bg-bg-pane-dark p-3 rounded-lg text-text-secondary hover:bg-bg-main hover:text-accent-primary transition-colors">
                            <i data-feather="plus" class="inline-block mr-2"></i>Add Column
                        </button>
                    </div>` : '';

                app.containers.kanbanBoard.innerHTML = columnsHTML + addColumnBtnHTML;
            }

            function renderListView() {
                 const collectionId = state.settings.activeCollectionId;
                 const collection = findItem(collectionId)?.item;
                 const notes = collection 
                    ? collection.children.filter(c => c.type === 'note') 
                    : getAllNotes(state.collections);

                 if (notes.length === 0) {
                     app.containers.notesListContent.innerHTML = `<div class="text-center p-10 text-text-secondary"><i data-feather="inbox" class="w-12 h-12 mx-auto mb-4"></i><h3 class="font-semibold">No Notes Here</h3><p>Create a new note to get started.</p></div>`;
                     feather.replace();
                     return;
                 }
                 
                 const sortOrder = state.settings.listSortOrder;
                 const [key, direction] = sortOrder.split('-');

                 notes.sort((a,b) => {
                     let valA = a[key];
                     let valB = b[key];
                     if(key === 'name') {
                         return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                     } else {
                         return direction === 'desc' ? new Date(valB) - new Date(valA) : new Date(valA) - new Date(valB);
                     }
                 });

                 app.containers.notesListContent.innerHTML = notes.map(note => {
                    const date = formatDateTime(note.modifiedAt);
                    const pinnedClass = note.pinned ? 'pinned' : '';
                    return `
                        <div class="list-note-item bg-bg-main p-4 rounded-lg shadow-sm border border-border-color cursor-pointer hover:shadow-md transition-all ${pinnedClass}" data-note-id="${note.id}">
                            <h3 class="font-semibold text-lg">${note.name}</h3>
                            <p class="text-sm text-text-secondary mt-1 truncate">${note.content.replace(/<[^>]*>?/gm, '')}</p>
                            <p class="text-xs text-text-tertiary mt-3">Last Modified: ${date}</p>
                        </div>`
                 }).join('');
            }
            
            function renderNoteEditor() {
                app.containers.noteEditor.classList.remove('hidden');
                
                const note = findItem(state.settings.activeNoteId)?.item;
                if (!note) {
                    state.settings.activeNoteId = null;
                    renderMainView();
                    return;
                }

                app.elements.noteEditorTitle.value = note.name;

                if(state.settings.editorMode === 'preview') {
                    app.elements.noteEditorBody.classList.add('hidden');
                    app.elements.markdownPreview.classList.remove('hidden');
                    app.elements.markdownPreview.innerHTML = marked.parse(note.content || '');
                    app.toolbar.editorModeToggle.classList.add('bg-accent-primary', 'text-white');
                } else {
                    app.elements.noteEditorBody.classList.remove('hidden');
                    app.elements.markdownPreview.classList.add('hidden');
                    app.elements.noteEditorBody.innerHTML = note.content || '';
                    app.toolbar.editorModeToggle.classList.remove('bg-accent-primary', 'text-white');
                }
            }
            
            function renderSearchResults(query) {
                document.querySelectorAll('.notes-view').forEach(v => v.classList.add('hidden'));
                app.views.searchResults.classList.remove('hidden');

                if (!query) {
                    app.containers.searchResultsList.innerHTML = `<p class="text-text-secondary text-center"><i data-feather="search" class="w-12 h-12 mx-auto mb-4"></i><br>Start typing to search for notes.</p>`;
                    feather.replace();
                    return;
                }

                const results = [];
                const searchPool = (items, parentName = null) => {
                    for (const item of items) {
                        if (item.type === 'note') {
                            const noteName = item.name || '';
                            const noteContent = item.content || '';
                            const plainContent = noteContent.replace(/<[^>]*>?/gm, '');
                            
                            const queryRegex = new RegExp(query, 'i');
                            if (queryRegex.test(noteName) || queryRegex.test(plainContent)) {
                                const excerptMatch = plainContent.match(new RegExp(`.{0,50}${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}.{0,50}`, 'i'));
                                const excerpt = excerptMatch ? `...${highlightText(excerptMatch[0], query)}...` : highlightText(plainContent.substring(0, 100) + '...', query);
                                results.push({
                                    noteId: item.id,
                                    projectName: parentName,
                                    noteName: noteName,
                                    excerpt: excerpt
                                });
                            }
                        }
                        if (item.type === 'folder' && item.children) {
                            searchPool(item.children, item.name);
                        }
                    }
                };

                searchPool(state.collections);
                
                if(results.length === 0) {
                     app.containers.searchResultsList.innerHTML = `<p class="text-text-secondary text-center"><i data-feather="x-circle" class="w-12 h-12 mx-auto mb-4"></i><br>No results found for "${query}".</p>`;
                     feather.replace();
                     return;
                }

                app.containers.searchResultsList.innerHTML = results.map(res => `
                    <div class="search-result-item p-4 mb-3 rounded-lg hover:bg-bg-pane-dark cursor-pointer border border-border-color" data-note-id="${res.noteId}">
                        <div class="font-semibold text-text-secondary text-sm">
                            ${res.projectName ? `${highlightText(res.projectName, query)} / ` : ''}<span class="text-text-primary">${highlightText(res.noteName, query)}</span>
                        </div>
                        <p class="text-text-primary mt-2">${res.excerpt}</p>
                    </div>
                `).join('');
            }


            // =================================================================
            // 6. EVENT HANDLERS & INITIALIZATION
            // =================================================================
            function init() {
                loadState();
                
                app.elements.notesListPane.style.width = `${state.settings.paneWidth}px`;
                app.elements.sortOrderSelect.value = state.settings.listSortOrder;
                
                app.elements.themeToggle.addEventListener('click', () => {
                    state.settings.theme = state.settings.theme === 'light' ? 'dark' : 'light';
                    localStorage.setItem('codex-notes-theme', state.settings.theme); 
                    saveState();
                    renderTheme();
                });

                app.elements.paneResizer.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    app.elements.paneResizer.classList.add('dragging');
                    document.body.style.cursor = 'col-resize';
                    const startX = e.clientX;
                    const startWidth = app.elements.notesListPane.offsetWidth;
                    const doDrag = (e) => {
                        let newWidth = startWidth + e.clientX - startX;
                        newWidth = Math.max(240, Math.min(newWidth, 500)); 
                        app.elements.notesListPane.style.width = `${newWidth}px`;
                    };
                    const stopDrag = () => {
                        app.elements.paneResizer.classList.remove('dragging');
                        document.body.style.cursor = 'default';
                        state.settings.paneWidth = app.elements.notesListPane.offsetWidth;
                        saveState();
                        document.removeEventListener('mousemove', doDrag);
                        document.removeEventListener('mouseup', stopDrag);
                    };
                    document.addEventListener('mousemove', doDrag);
                    document.addEventListener('mouseup', stopDrag);
                });

                // --- Mobile Back Button ---
                app.elements.mobileBackButton.addEventListener('click', () => {
                    if (state.settings.activeNoteId) {
                        state.settings.activeNoteId = null; // Go back from note to list
                    } else if (state.settings.activeCollectionId) {
                        state.settings.activeCollectionId = null; // Go back from list to all notes (or collections)
                        state.settings.mobileView = 'collections'; // Go back to collections pane
                    } else {
                        state.settings.mobileView = 'collections';
                    }
                    saveState();
                    render();
                });
                

                // --- Collections List (Event Delegation) ---
                app.containers.collectionsList.addEventListener('click', (e) => {
                    const itemLink = e.target.closest('.collection-item');
                    if (!itemLink) return;
                    e.preventDefault();

                    const wrapper = itemLink.closest('.collection-item-wrapper');
                    const id = wrapper.dataset.id;
                    const { item } = findItem(id);

                    if (item.type === 'folder') {
                        state.settings.activeCollectionId = id;
                        state.settings.activeNoteId = null;
                        item.expanded = !item.expanded;
                    } else if (item.type === 'note') {
                         state.settings.activeNoteId = id;
                         const { parent } = findItem(id);
                         state.settings.activeCollectionId = (parent && parent.id) ? parent.id : null;
                    }
                    
                    if (isMobile()) {
                        state.settings.mobileView = 'main';
                    }
                    
                    saveState();
                    render();
                });

                // --- Collection Drag & Drop ---
                let draggedItemId = null;
                app.containers.collectionsList.addEventListener('dragstart', (e) => {
                    const wrapper = e.target.closest('.collection-item-wrapper');
                    if(wrapper) {
                        draggedItemId = wrapper.dataset.id;
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', draggedItemId);
                        setTimeout(() => wrapper.classList.add('opacity-50'), 0);
                    }
                });

                app.containers.collectionsList.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.drop-target-folder').forEach(el => el.classList.remove('drop-target-folder'));
                    document.querySelectorAll('.drop-indicator').forEach(el => el.remove());

                    const targetWrapper = e.target.closest('.collection-item-wrapper');
                    if (!targetWrapper || targetWrapper.dataset.id === draggedItemId) return;
                    
                    const { item: targetItem } = findItem(targetWrapper.dataset.id);
                    if (targetItem.type === 'folder') {
                        targetWrapper.classList.add('drop-target-folder');
                    } else {
                        const indicator = document.createElement('div');
                        indicator.className = 'drop-indicator';
                        targetWrapper.insertAdjacentElement('beforebegin', indicator);
                    }
                });

                app.containers.collectionsList.addEventListener('dragleave', (e) => {
                    e.target.closest('.collection-item-wrapper')?.classList.remove('drop-target-folder');
                });


                app.containers.collectionsList.addEventListener('dragend', (e) => {
                    document.querySelectorAll('.collection-item-wrapper.opacity-50').forEach(el => el.classList.remove('opacity-50'));
                    document.querySelectorAll('.drop-indicator, .drop-target-folder').forEach(el => {
                        el.classList.remove('drop-target-folder');
                        if (el.classList.contains('drop-indicator')) el.remove();
                    });
                    draggedItemId = null;
                });

                app.containers.collectionsList.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const droppedOnWrapper = e.target.closest('.collection-item-wrapper');
                    if (!draggedItemId || !droppedOnWrapper) return;

                    const { item: draggedItem, parent: originalParent, index: originalIndex } = findItem(draggedItemId);
                    const droppedOnId = droppedOnWrapper.dataset.id;
                    const { item: droppedOnItem } = findItem(droppedOnId);

                    if (draggedItem.id === droppedOnItem.id || findItem(droppedOnItem.id, [draggedItem])) return;

                    const sourceArray = Array.isArray(originalParent) ? originalParent : originalParent.children;
                    sourceArray.splice(originalIndex, 1);
                    
                    if (droppedOnItem.type === 'folder') {
                        if (!droppedOnItem.children) droppedOnItem.children = [];
                        droppedOnItem.children.unshift(draggedItem);
                        droppedOnItem.expanded = true;
                        if (draggedItem.type === 'note') {
                            const newProjectColumns = state.kanbanColumns[droppedOnItem.id];
                            if (newProjectColumns && newProjectColumns.length > 0) draggedItem.status = newProjectColumns[0].id;
                        }
                    } else {
                        const { parent: newParent, index: newIndex } = findItem(droppedOnId);
                        const destArray = Array.isArray(newParent) ? newParent : newParent.children;
                        destArray.splice(newIndex, 0, draggedItem);
                        if (draggedItem.type === 'note' && newParent.id) {
                            const newProjectColumns = state.kanbanColumns[newParent.id];
                            if (newProjectColumns && newProjectColumns.length > 0) draggedItem.status = newProjectColumns[0].id;
                        }
                    }

                    saveState();
                    render();
                });
                
                // --- Kanban Board and Column Management Click Handler ---
                app.containers.kanbanBoard.addEventListener('click', async e => {
                    const addBtn = e.target.closest('#add-column-btn');
                    const renameBtn = e.target.closest('.rename-column-btn');
                    const deleteBtn = e.target.closest('.delete-column-btn');

                    const collectionId = state.settings.activeCollectionId;
                    if (!collectionId) return;

                    if (addBtn) {
                        const newName = await showPrompt({ title: 'New Column', message: 'Enter a name for the new column:', placeholder: 'e.g. Done' });
                        if (newName) {
                            if(!state.kanbanColumns[collectionId]) state.kanbanColumns[collectionId] = [];
                            state.kanbanColumns[collectionId].push({ id: generateId('col'), title: newName });
                            saveState();
                            render();
                        }
                    } else if (renameBtn) {
                        const columnEl = renameBtn.closest('.kanban-column');
                        const columnId = columnEl.dataset.columnId;
                        const column = state.kanbanColumns[collectionId].find(c => c.id === columnId);
                        const newName = await showPrompt({ title: 'Rename Column', message: `Enter a new name for "${column.title}":`, initialValue: column.title });
                        if(newName) {
                            column.title = newName;
                            saveState();
                            render();
                        }
                    } else if (deleteBtn) {
                        const columnEl = deleteBtn.closest('.kanban-column');
                        const columnId = columnEl.dataset.columnId;
                        const confirmed = await showConfirm({ title: 'Delete Column', message: 'Are you sure you want to delete this column? Notes inside will be moved to the first column.', confirmText: 'Delete' });
                        if (confirmed) {
                            const columns = state.kanbanColumns[collectionId];
                            const columnIndex = columns.findIndex(c => c.id === columnId);
                            const notesToMove = findItem(collectionId).item.children.filter(n => n.status === columnId);
                            
                            columns.splice(columnIndex, 1);

                            if(columns.length > 0) {
                                notesToMove.forEach(n => n.status = columns[0].id);
                            } else {
                                notesToMove.forEach(n => n.status = null);
                            }

                            saveState();
                            render();
                        }
                    }
                });
                
                // --- Kanban Notes Drag & Drop ---
                app.containers.kanbanBoard.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('kanban-card')) {
                        e.dataTransfer.setData('text/plain', e.target.dataset.noteId);
                        setTimeout(() => e.target.classList.add('dragging'), 0);
                    }
                });

                app.containers.kanbanBoard.addEventListener('dragend', (e) => {
                    if (e.target.classList.contains('kanban-card')) {
                        e.target.classList.remove('dragging');
                    }
                });

                app.containers.kanbanBoard.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const column = e.target.closest('.kanban-column');
                    if (column) {
                        column.classList.add('drop-target-column');
                    }
                });
                
                app.containers.kanbanBoard.addEventListener('dragleave', (e) => {
                     const column = e.target.closest('.kanban-column');
                     if(column) column.classList.remove('drop-target-column');
                });

                app.containers.kanbanBoard.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const columnEl = e.target.closest('.kanban-column');
                    if (columnEl) {
                        columnEl.classList.remove('drop-target-column');
                        const noteId = e.dataTransfer.getData('text/plain');
                        const columnId = columnEl.dataset.columnId;
                        const { item: note } = findItem(noteId);
                        if (note) {
                            note.status = columnId;
                            note.modifiedAt = new Date().toISOString();
                            saveState();
                            renderKanbanView();
                            feather.replace();
                        }
                    }
                });
                
                app.elements.viewSwitcher.addEventListener('click', (e) => {
                    const button = e.target.closest('.view-btn');
                    if(button && !button.classList.contains('active')) {
                        state.settings.activeView = button.dataset.view;
                        saveState();
                        renderMainView();
                    }
                });
                
                app.elements.sortOrderSelect.addEventListener('change', (e) => {
                    state.settings.listSortOrder = e.target.value;
                    saveState();
                    renderListView();
                });

                app.containers.mainContentArea.addEventListener('click', (e) => {
                    const card = e.target.closest('.kanban-card, .list-note-item, .search-result-item');
                    if (card) {
                        isSearchActive = false;
                        state.settings.activeNoteId = card.dataset.noteId;
                        const { parent } = findItem(state.settings.activeNoteId);
                        state.settings.activeCollectionId = parent.id || null;
                        
                        if (isMobile()) {
                            state.settings.mobileView = 'main';
                        }

                        saveState();
                        render();
                        return;
                    }
                    
                    const link = e.target.closest('a');
                    if (link && (app.elements.noteEditorBody.contains(link) || app.elements.markdownPreview.contains(link))) {
                        e.preventDefault();
                        window.open(link.href, '_blank');
                    }
                });

                const saveNoteContent = debounce(() => {
                    if (!state.settings.activeNoteId) return;
                    const {item: note} = findItem(state.settings.activeNoteId);
                    if(note) {
                        const newName = app.elements.noteEditorTitle.value;
                        const newContent = app.elements.noteEditorBody.innerHTML;
                        
                        if(note.name !== newName || note.content !== newContent) {
                            note.name = newName;
                            note.content = newContent;
                            note.modifiedAt = new Date().toISOString();
                            saveState();
                            showToast("Note saved!", 'success');
                            renderCollectionsList(); // Update list in case name changed
                            feather.replace();
                        }
                    }
                }, 500);

                app.elements.noteEditorTitle.addEventListener('input', saveNoteContent);
                app.elements.noteEditorBody.addEventListener('input', saveNoteContent);
                
                // --- Note Editor Image Pasting/Dropping & OCR ---
                const handleImageFile = (file) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const imgHTML = `<img src="${e.target.result}" alt="Pasted image">`;
                            document.execCommand('insertHTML', false, imgHTML);
                            saveNoteContent();
                        };
                        reader.readAsDataURL(file);
                        return true;
                    }
                    return false;
                };

                app.elements.noteEditorBody.addEventListener('paste', (e) => {
                    const files = e.clipboardData.files;
                    for (const file of files) {
                        if (handleImageFile(file)) {
                            e.preventDefault();
                        }
                    }
                });

                app.elements.noteEditorBody.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const files = e.dataTransfer.files;
                    for (const file of files) {
                        handleImageFile(file);
                    }
                });
                
                app.elements.noteEditorBody.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                app.toolbar.ocrBtn.addEventListener('click', () => app.toolbar.ocrFileInput.click());
                app.toolbar.ocrFileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const toastId = showToast('Recognizing text...', 'loading');
                    try {
                        const { data: { text } } = await Tesseract.recognize(file, 'eng', {
                            logger: m => console.log(m) 
                        });
                        const formattedText = `<p>${text.replace(/\n/g, '</p><p>')}</p>`;
                        app.elements.noteEditorBody.focus();
                        document.execCommand('insertHTML', false, formattedText);
                        saveNoteContent();
                        showToast('Text inserted!', 'success');
                    } catch (err) {
                        console.error(err);
                        showToast('Could not recognize text.', 'error');
                    } finally {
                        dismissToast(toastId);
                        app.toolbar.ocrFileInput.value = ''; // Reset input
                    }
                });

                // --- New Collection (Desktop) ---
                app.elements.newCollectionBtn.addEventListener('click', async () => {
                    const name = await showPrompt({ title: 'New Collection', message: 'Enter a name for your new collection:', placeholder: 'e.g. Project Phoenix' });
                    if (name) {
                        const newCollection = {
                            id: generateId('c'), name, type: 'folder', children: [], expanded: true
                        };
                        state.collections.push(newCollection);
                        state.kanbanColumns[newCollection.id] = [{ id: generateId('col'), title: 'To Do' }];
                        state.settings.activeCollectionId = newCollection.id;
                        saveState();
                        render();
                    }
                });

                // --- New Note Button (for desktop button) ---
                const createNewNote = () => {
                    let parentCollection;
                    let targetArray;
                    let parentId = state.settings.activeCollectionId;

                    if (parentId) {
                        const parentResult = findItem(parentId);
                        if (parentResult && parentResult.item.type === 'folder') {
                            parentCollection = parentResult.item;
                            targetArray = parentCollection.children;
                            parentCollection.expanded = true;
                        } else {
                           parentId = null;
                           targetArray = state.collections;
                        }
                    } else {
                        targetArray = state.collections;
                    }

                    const now = new Date().toISOString();
                    const newNote = {
                        id: generateId('n'), name: 'Untitled Note', type: 'note', content: '',
                        status: parentId ? state.kanbanColumns[parentId]?.[0]?.id || null : null,
                        createdAt: now,
                        modifiedAt: now,
                        pinned: false
                    };
                    targetArray.unshift(newNote);
                    state.settings.activeNoteId = newNote.id;
                    if (isMobile()) state.settings.mobileView = 'main';
                    saveState();
                    render();
                };
                
                // --- Mobile FAB handler ---
                const handleFabClick = async () => {
                    if (state.settings.mobileView === 'collections' || !state.settings.activeCollectionId) {
                         // In collections view OR "All Notes", FAB makes a new collection
                        const name = await showPrompt({ title: 'New Collection', message: 'Enter a name for your new collection:', placeholder: 'e.g. Project Phoenix' });
                        if (name) {
                            const newCollection = {
                                id: generateId('c'), name, type: 'folder', children: [], expanded: true
                            };
                            state.collections.push(newCollection);
                            state.kanbanColumns[newCollection.id] = [{ id: generateId('col'), title: 'To Do' }];
                            state.settings.activeCollectionId = newCollection.id;
                            state.settings.mobileView = 'main'; // Switch to the new collection view
                            saveState();
                            render();
                        }
                    } else {
                        // In a specific collection view, FAB makes a new note
                        createNewNote();
                    }
                }

                app.elements.desktopNewNoteBtn.addEventListener('click', createNewNote);
                app.elements.mobileNewNoteFab.addEventListener('click', handleFabClick);


                // --- Search ---
                const openSearch = () => {
                    app.search.container.style.pointerEvents = 'auto';
                    app.search.container.style.transform = 'scale(1) translateY(0)';
                    app.search.container.style.opacity = '1';
                    app.search.input.focus();
                }

                const closeSearch = () => {
                    app.search.container.style.transform = 'scale(0.5)';
                    app.search.container.style.opacity = '0';
                    app.search.container.style.pointerEvents = 'none';
                    app.search.input.value = '';
                    isSearchActive = false;
                    render();
                }

                app.search.icon.addEventListener('click', openSearch);
                app.search.closeBtn.addEventListener('click', closeSearch);
                app.search.input.addEventListener('input', () => {
                    isSearchActive = app.search.input.value.length > 0;
                    if (isMobile() && isSearchActive) {
                         state.settings.mobileView = 'main';
                    }
                    render();
                });

                // --- Inline Formatting Toolbar & Editor Mode ---
                app.toolbar.editorModeToggle.addEventListener('click', () => {
                    state.settings.editorMode = state.settings.editorMode === 'editor' ? 'preview' : 'editor';
                    saveState();
                    renderNoteEditor();
                });

                document.addEventListener('selectionchange', () => {
                    if (state.settings.editorMode === 'preview') return;
                    const selection = window.getSelection();
                    if (selection.isCollapsed || !app.elements.noteEditorBody.contains(selection.anchorNode)) {
                        app.toolbar.inline.style.opacity = '0';
                        app.toolbar.inline.style.pointerEvents = 'none';
                        return;
                    }
                    const range = selection.getRangeAt(0);
                    const rect = range.getBoundingClientRect();
                    const toolbarRect = app.toolbar.inline.getBoundingClientRect();
                    const editorPaneRect = app.elements.editorPane.getBoundingClientRect();
                    
                    app.toolbar.inline.style.top = `${rect.top - editorPaneRect.top - toolbarRect.height - 8}px`;
                    app.toolbar.inline.style.left = `${rect.left - editorPaneRect.left + (rect.width / 2) - (toolbarRect.width / 2)}px`;
                    app.toolbar.inline.style.opacity = '1';
                    app.toolbar.inline.style.transform = 'scale(1)';
                    app.toolbar.inline.style.pointerEvents = 'auto';
                });
                
                app.toolbar.inline.addEventListener('mousedown', async (e) => {
                    e.preventDefault();
                    const button = e.target.closest('button');
                    if(!button) return;
                    
                    const command = button.dataset.command;
                    const value = button.dataset.value;

                    if (command === 'createLink') {
                        const url = await showPrompt({ title: 'Insert Link', message: 'Enter the URL:', placeholder: 'https://example.com' });
                        if (url) document.execCommand(command, false, url);
                    } else if (command === 'insertImage') {
                        const url = await showPrompt({ title: 'Insert Image', message: 'Enter the image URL:', placeholder: 'https://example.com/image.png' });
                        if (url) document.execCommand('insertHTML', false, `<img src="${url}" alt="Image">`);
                    } else if (command === 'formatBlock') {
                        document.execCommand(command, false, value);
                    } else {
                        document.execCommand(command, false, null);
                    }
                    saveNoteContent();
                });

                // --- Context Menu ---
                app.containers.collectionsList.addEventListener('contextmenu', e => {
                    const itemWrapper = e.target.closest('.collection-item-wrapper');
                    
                    app.contextMenu.togglePinBtn.style.display = 'none';
                    app.contextMenu.renameBtn.style.display = 'none';
                    app.contextMenu.deleteBtn.style.display = 'none';
                    app.contextMenu.duplicateBtn.style.display = 'none';

                    if (!itemWrapper && e.target.closest('#collections-list-container')) {
                        app.contextMenu.targetId = null;
                        app.contextMenu.targetIsContainer = true;
                    } else if (itemWrapper) {
                        e.preventDefault();
                        app.contextMenu.targetId = itemWrapper.dataset.id;
                        app.contextMenu.targetIsContainer = false;
                        const { item } = findItem(app.contextMenu.targetId);
                        
                        app.contextMenu.renameBtn.style.display = 'flex';
                        app.contextMenu.deleteBtn.style.display = 'flex';
                        app.contextMenu.duplicateBtn.style.display = 'flex';

                        if (item && item.type === 'note') {
                            app.contextMenu.togglePinBtn.style.display = 'flex';
                            app.contextMenu.pinActionText.textContent = item.pinned ? 'Unpin' : 'Pin';
                        }
                    } else {
                        return;
                    }

                    app.contextMenu.menu.style.top = `${e.clientY}px`;
                    app.contextMenu.menu.style.left = `${e.clientX}px`;
                    app.contextMenu.menu.classList.remove('hidden');
                    setTimeout(() => app.contextMenu.menu.classList.remove('scale-95', 'opacity-0'), 10);
                    feather.replace();
                });

                const duplicateItem = (sourceItem) => {
                    const newItem = JSON.parse(JSON.stringify(sourceItem));
                    newItem.id = generateId(sourceItem.type[0]);
                    newItem.name = `${sourceItem.name} (copy)`;
                    
                    const now = new Date().toISOString();
                    if (newItem.type === 'note') {
                        newItem.createdAt = now;
                        newItem.modifiedAt = now;
                    }

                    if (newItem.type === 'folder' && newItem.children) {
                        newItem.children = newItem.children.map(child => duplicateItem(child));
                        if (state.kanbanColumns[sourceItem.id]) {
                            state.kanbanColumns[newItem.id] = JSON.parse(JSON.stringify(state.kanbanColumns[sourceItem.id]));
                        }
                    }
                    return newItem;
                };

                app.contextMenu.menu.addEventListener('click', async e => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const action = button.dataset.action;
                    const id = app.contextMenu.targetId;
                    
                    let findResult, targetItem, parent, parentArray;

                    if (id) {
                        findResult = findItem(id);
                        targetItem = findResult.item;
                        parent = findResult.parent;
                        parentArray = Array.isArray(parent) ? parent : parent.children;
                    }

                    const createNewItem = (type) => {
                        const name = type === 'note' ? 'Untitled Note' : 'New Folder';
                        const now = new Date().toISOString();
                        const newItem = {
                            id: generateId(type[0]), name, type,
                            ...(type === 'note' && { content: '', status: null, createdAt: now, modifiedAt: now, pinned: false }),
                            ...(type === 'folder' && { children: [], expanded: true })
                        };

                        let destinationArray = state.collections;
                        let parentFolder = null;
                        
                        if (targetItem) {
                            if (targetItem.type === 'folder') {
                                destinationArray = targetItem.children;
                                targetItem.expanded = true;
                                parentFolder = targetItem;
                            } else {
                                destinationArray = parentArray;
                                parentFolder = parent;
                            }
                        }
                        
                        if (newItem.type === 'note' && parentFolder?.id) {
                            newItem.status = state.kanbanColumns[parentFolder.id]?.[0]?.id || null;
                        }
                        
                        destinationArray.unshift(newItem);
                        
                        if (type === 'note') {
                            state.settings.activeNoteId = newItem.id;
                        } else {
                           state.kanbanColumns[newItem.id] = [{ id: generateId('col'), title: 'To Do' }];
                        }
                        
                        saveState();
                        render();
                    };

                    switch(action) {
                        case 'new-note': createNewItem('note'); break;
                        case 'new-folder': createNewItem('folder'); break;
                        case 'delete':
                            const confirmed = await showConfirm({ title: `Delete "${targetItem.name}"`, message: 'This action cannot be undone.', confirmText: 'Delete' });
                            if (confirmed) {
                               const index = parentArray.findIndex(i => i.id === id);
                               parentArray.splice(index, 1);
                               showToast(`"${targetItem.name}" deleted.`);
                               if (state.settings.activeNoteId === id) state.settings.activeNoteId = null;
                               if (state.settings.activeCollectionId === id) state.settings.activeCollectionId = null;
                               if (isMobile()) state.settings.mobileView = 'collections'; // Go back after delete
                               saveState();
                               render();
                            }
                            break;
                        case 'rename':
                            const newName = await showPrompt({ title: 'Rename', message: `Enter a new name for "${targetItem.name}":`, initialValue: targetItem.name });
                            if (newName) {
                                targetItem.name = newName;
                                saveState();
                                render();
                            }
                            break;
                        case 'toggle-pin':
                            if(targetItem && targetItem.type === 'note') {
                                targetItem.pinned = !targetItem.pinned;
                                showToast(targetItem.pinned ? `Pinned "${targetItem.name}"` : `Unpinned "${targetItem.name}"`);
                                saveState();
                                render();
                            }
                            break;
                        case 'duplicate':
                            if (!targetItem) return;
                            const newItem = duplicateItem(targetItem);
                            parentArray.splice(findResult.index + 1, 0, newItem);
                            showToast(`Duplicated "${targetItem.name}"`);
                            saveState();
                            render();
                            break;
                    }
                    closeContextMenu();
                });
                
                const closeContextMenu = () => {
                    app.contextMenu.menu.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => app.contextMenu.menu.classList.add('hidden'), 100);
                };
                
                // --- Settings Menu & Data Portability ---
                app.elements.avatar.addEventListener('click', () => {
                    const menu = app.elements.settingsMenu;
                    const isHidden = menu.classList.contains('hidden');
                    if (isHidden) {
                        menu.classList.remove('hidden');
                        setTimeout(() => menu.classList.remove('scale-95', 'opacity-0'), 10);
                    } else {
                        menu.classList.add('scale-95', 'opacity-0');
                        setTimeout(() => menu.classList.add('hidden'), 100);
                    }
                });

                app.elements.settingsMenu.addEventListener('click', async e => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const action = button.dataset.action;

                    if (action === 'export') {
                        const dataStr = JSON.stringify(state, null, 2);
                        const dataBlob = new Blob([dataStr], {type: "application/json"});
                        const url = URL.createObjectURL(dataBlob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `codex-notes-backup-${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        showToast('Data exported successfully!', 'success');
                    } else if (action === 'import') {
                        app.elements.importFileInput.click();
                    }
                });

                app.elements.importFileInput.addEventListener('change', async e => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const confirmed = await showConfirm({
                        title: 'Import Data',
                        message: 'This will <strong>overwrite all current data</strong> in the app. Are you sure you want to continue?',
                        confirmText: 'Overwrite and Import',
                        confirmClass: 'bg-orange-500'
                    });
                    if (!confirmed) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const importedState = JSON.parse(event.target.result);
                            state = migrateState(importedState);
                            saveState();
                            showToast('Data imported successfully!', 'success');
                            render();
                        } catch (err) {
                            console.error("Import error:", err);
                            showToast('Invalid or corrupted data file.', 'error');
                        }
                    };
                    reader.readAsText(file);
                    app.elements.importFileInput.value = ''; // Reset for next import
                });
                
                // --- Global Keydowns & Clicks ---
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeSearch();
                        closeContextMenu();
                    }
                    if ((e.metaKey || e.ctrlKey) && !e.shiftKey) {
                        if (e.key === 'f') { e.preventDefault(); openSearch(); }
                        if (e.key === 'n') { e.preventDefault(); createNewNote(); }
                    }
                });
                
                document.addEventListener('click', (e) => {
                    if(!app.contextMenu.menu.contains(e.target)) closeContextMenu();
                    if(!app.elements.settingsMenu.contains(e.target) && !app.elements.avatar.contains(e.target)) {
                         app.elements.settingsMenu.classList.add('scale-95', 'opacity-0');
                         setTimeout(() => app.elements.settingsMenu.classList.add('hidden'), 100);
                    }
                });
                
                window.addEventListener('resize', debounce(render, 150));

                render();
            }

            init();
        });
    </script>

</body>
</html>
