<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reputifly | Image Extractor V3</title>

    <link rel="icon" type="image/png"
        href="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug">
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- V2 Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --bg-deep: #0B0A14;
            --accent-primary: #E6397F;
            --accent-secondary: #FF8A00;
            --text-main: #F0F0F0;
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(20, 20, 30, 0.6);
        }

        /* --- GLOBAL LAYOUT & TEXTURE --- */
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        ::selection {
            background: var(--accent-primary);
            color: white;
        }

        h1,
        h2,
        h3,
        .brand-font {
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -0.02em;
        }

        /* Liquid Mesh Background */
        .mesh-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -2;
            background:
                radial-gradient(at 0% 0%, hsla(336, 83%, 56%, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, hsla(28, 100%, 50%, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, hsla(336, 83%, 56%, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, hsla(240, 100%, 70%, 0.05) 0px, transparent 50%);
            background-size: 150% 150%;
            animation: fluidBackground 20s ease infinite;
            filter: blur(60px);
        }

        @keyframes fluidBackground {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.03;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            transition: background 0.3s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* --- COMPONENTS --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), border-color 0.3s ease;
        }

        .glass-panel:hover {
            border-color: rgba(255, 255, 255, 0.2);
        }

        .btn-liquid-glow {
            background: radial-gradient(circle at top, rgba(255, 255, 255, 0.4) 0%, transparent 60%),
                linear-gradient(90deg, #E6397F, #FF8A00);
            box-shadow:
                0 10px 30px -10px rgba(230, 57, 127, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -2px 0 rgba(0, 0, 0, 0.2);
            border: none;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 9999px;
            color: white;
            font-weight: 700;
            padding: 10px 24px;
            font-size: 13px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn-liquid-glow:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow:
                0 20px 40px -10px rgba(255, 138, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .btn-hero-glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            border-radius: 9999px;
            color: #ccc;
            font-weight: 600;
            padding: 10px 24px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn-hero-glass:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            color: white;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        /* Toggles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #E6397F;
            border-color: #E6397F;
        }

        input:checked+.slider.wp-slider {
            background-color: #FF8A00;
            border-color: #FF8A00;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        .image-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .image-card:hover {
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.05);
            z-index: 10;
        }

        .context-header {
            grid-column: 1 / -1;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #E6397F;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-header:first-of-type {
            margin-top: 0;
        }

        /* Toast */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #0B0A14;
            border: 1px solid #E6397F;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0 0 20px rgba(230, 57, 127, 0.4);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s, visibility 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        .wp-badge {
            background: #FF8A00;
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 4px;
        }
    </style>
</head>

<body>

    <div class="mesh-bg"></div>
    <div class="noise-overlay"></div>
    <div id="toast"><i data-feather="check-circle" class="inline w-4 h-4 mr-2"></i><span>Action Completed</span></div>

    <div class="max-w-7xl mx-auto px-6 py-12 relative z-10">

        <!-- HEADER -->
        <header class="flex flex-col md:flex-row items-center justify-between mb-12 gap-6">
            <div class="flex items-center gap-6">
                <div class="relative group">
                    <div
                        class="absolute -inset-2 bg-pink-500 rounded-full blur-lg opacity-20 group-hover:opacity-40 transition duration-500">
                    </div>
                    <img src="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug"
                        class="relative w-16 h-16 rounded-full border border-white/10 shadow-2xl" alt="Reputifly Icon">
                </div>
                <div>
                    <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png"
                        class="h-6 w-auto brightness-125 mb-1" alt="Reputifly Logo">
                    <h1 class="text-xl font-bold text-white">Image Extractor</h1>
                </div>
            </div>

            <div class="flex gap-4 items-center">
                <a href="#bookmarklet-section" class="btn-hero-glass">
                    <i data-feather="bookmark" class="w-4 h-4"></i> Bookmarklet
                </a>
            </div>
        </header>

        <!-- MAIN LAYOUT -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- LEFT COL: CONTROLS & PASTE -->
            <div class="lg:col-span-12">
                <section class="glass-panel p-6 mb-8">
                    <div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-6">
                        <div>
                            <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                                <i data-feather="layers" class="text-pink-500"></i> Paste Content
                            </h2>
                            <p class="text-gray-400 text-sm mt-1">Copy rich text (Ctrl+A), Paste below (Ctrl+V).</p>
                        </div>

                        <!-- TOOLBAR -->
                        <div class="flex flex-wrap items-center gap-4 bg-white/5 p-3 rounded-2xl border border-white/5">
                            <!-- Toggle: Context -->
                            <label class="flex items-center gap-3 cursor-pointer group px-2">
                                <div class="toggle-switch">
                                    <input type="checkbox" id="contextToggle" checked>
                                    <span class="slider"></span>
                                </div>
                                <div class="text-sm">
                                    <span
                                        class="block font-bold text-white group-hover:text-pink-400 transition">Context</span>
                                    <span class="block text-[10px] text-gray-500">Groups</span>
                                </div>
                            </label>

                            <div class="w-px h-8 bg-white/10"></div>

                            <!-- Toggle: WordPress -->
                            <label class="flex items-center gap-3 cursor-pointer group px-2">
                                <div class="toggle-switch">
                                    <input type="checkbox" id="wpToggle">
                                    <span class="slider wp-slider"></span>
                                </div>
                                <div class="text-sm">
                                    <span
                                        class="block font-bold text-white group-hover:text-[#FF8A00] transition">WordPress</span>
                                    <span class="block text-[10px] text-gray-500">Sanitize</span>
                                </div>
                            </label>

                            <div class="w-px h-8 bg-white/10 mx-2"></div>

                            <button id="resetAction"
                                class="p-2 hover:bg-white/10 rounded-full text-gray-400 hover:text-white transition"
                                title="Clear All">
                                <i data-feather="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <div id="pasteZone"
                        class="w-full bg-black/20 border border-white/10 rounded-xl min-h-[160px] p-6 text-gray-500 text-center flex flex-col items-center justify-center cursor-text transition focus-within:border-pink-500/50 focus-within:bg-black/30 outline-none"
                        contenteditable="true">
                        <i data-feather="download-cloud" class="w-10 h-10 mb-4 opacity-50"></i>
                        <p class="font-medium">Click here & Press <span
                                class="text-white font-mono bg-white/10 px-2 py-1 rounded">Ctrl + V</span></p>
                    </div>
                </section>
            </div>

            <!-- RESULTS -->
            <div class="lg:col-span-12">
                <div id="resultsContainer" class="hidden">
                    <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            Extracted Content <span id="countBadge"
                                class="bg-pink-500 text-white text-xs px-2 py-0.5 rounded-full ml-2">0</span>
                        </h3>

                        <div class="flex gap-3 relative">
                            <!-- EXPORT DROPDOWN -->
                            <div class="relative">
                                <button onclick="toggleExportMenu()" class="btn-hero-glass">
                                    <i data-feather="file-text" class="w-4 h-4"></i> Export List <i
                                        data-feather="chevron-down" class="w-3 h-3 ml-1"></i>
                                </button>
                                <div id="exportMenu"
                                    class="hidden absolute top-full right-0 mt-2 w-48 bg-[#1a1a2e] border border-white/10 rounded-xl shadow-xl overflow-hidden z-50 backdrop-blur-xl">
                                    <button onclick="downloadText()"
                                        class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-white/10 hover:text-white transition flex items-center gap-2">
                                        <i data-feather="align-left" class="w-4 h-4"></i> Text File (.txt)
                                    </button>
                                    <button onclick="downloadJson()"
                                        class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-white/10 hover:text-white transition flex items-center gap-2 border-t border-white/5">
                                        <i data-feather="code" class="w-4 h-4"></i> JSON Data (.json)
                                    </button>
                                </div>
                            </div>

                            <button onclick="copyAllUrls()" class="btn-hero-glass">
                                <i data-feather="copy" class="w-4 h-4"></i> Copy URLs
                            </button>
                            <button onclick="downloadZip()" class="btn-liquid-glow">
                                <i data-feather="package" class="w-4 h-4"></i> Download ZIP
                            </button>
                        </div>
                    </div>

                    <div id="gridOutput" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        <!-- Cards injected here -->
                    </div>
                </div>
            </div>

            <!-- BOOKMARKLET SECTION -->
            <div id="bookmarklet-section" class="lg:col-span-12 mt-12 pb-20">
                <section class="glass-panel p-8 border-pink-500/20 relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 p-32 bg-pink-500/10 blur-[100px] rounded-full pointing-events-none">
                    </div>

                    <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-8">
                        <div class="max-w-xl">
                            <h2 class="text-2xl font-bold text-white mb-2">Magic Bookmarklet</h2>
                            <p class="text-gray-400 leading-relaxed">
                                Drag this button to your bookmarks bar. Click it on ANY website to extract images
                                without pasting.
                            </p>
                        </div>

                        <div>
                            <a id="repBookmarklet" href="#"
                                class="btn-liquid-glow px-8 py-4 text-lg shadow-[0_0_40px_-5px_rgba(230,57,127,0.5)]">
                                <i data-feather="aperture"></i> Reputifly Extractor
                            </a>
                        </div>
                    </div>
                </section>
            </div>

        </div>

    </div>

    <!-- LOGIC -->
    <script>
        // Init Icons
        feather.replace();

        // Refs
        const pasteZone = document.getElementById('pasteZone');
        const resultsContainer = document.getElementById('resultsContainer');
        const gridOutput = document.getElementById('gridOutput');
        const countBadge = document.getElementById('countBadge');
        const contextToggle = document.getElementById('contextToggle');
        const wpToggle = document.getElementById('wpToggle');
        const resetAction = document.getElementById('resetAction');
        const toast = document.getElementById('toast');

        // State
        let extractedData = [];

        // --- EVENTS ---
        contextToggle.addEventListener('change', () => rerenderIfData());
        wpToggle.addEventListener('change', () => rerenderIfData());

        function rerenderIfData() {
            if (extractedData.length > 0) renderGrid();
        }

        // --- 1. UTILS ---
        function showToast(msg) {
            const span = toast.querySelector('span');
            span.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function cleanString(str) {
            return str ? str.trim() : '';
        }

        function sanitizeSlug(str) {
            return str.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        function inferAltFromSrc(src) {
            try {
                const url = new URL(src, window.location.href);
                const pathname = url.pathname;
                const filename = pathname.substring(pathname.lastIndexOf('/') + 1);
                // Remove extension
                let clean = filename.split('.')[0]
                    .replace(/[-_]/g, ' ')
                    .replace(/%20/g, ' ');
                return clean.charAt(0).toUpperCase() + clean.slice(1) || 'Image Asset';
            } catch (e) {
                return 'Image Asset';
            }
        }

        function getDatedFolder() {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            return `wp-content/uploads/${y}/${m}/`;
        }

        // --- 2. CORE LOGIC ---
        pasteZone.addEventListener('paste', (e) => {
            e.preventDefault();
            const html = e.clipboardData.getData('text/html');
            pasteZone.innerHTML = '<div class="flex flex-col items-center"><div class="w-8 h-8 border-4 border-pink-500 border-t-transparent rounded-full animate-spin mb-4"></div><p class="animate-pulse">Analyzing Content...</p></div>';

            setTimeout(() => {
                processHTML(html);
            }, 100);
        });

        function processHTML(htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');

            extractedData = [];
            gridOutput.innerHTML = '';

            // CONTEXT LOGIC (Always capture context, toggle controls display)
            let currentHeader = 'Uncategorized';
            const seen = new Set();
            const walker = document.createTreeWalker(doc.body, NodeFilter.SHOW_ELEMENT, null);

            while (walker.nextNode()) {
                const node = walker.currentNode;
                const tag = node.tagName.toLowerCase();

                if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tag)) {
                    const text = node.textContent.trim();
                    if (text && text.length < 100) currentHeader = text;
                } else if (tag === 'img') {
                    const src = node.src || node.getAttribute('data-src');
                    if (isValidImg(src, seen)) {
                        extractedData.push({
                            src: src,
                            alt: cleanString(node.alt) || inferAltFromSrc(src),
                            context: currentHeader
                        });
                        seen.add(src);
                    }
                }
            }
            // Fallback if 0 images found via tree walker (sometimes structure is flat)
            if (extractedData.length === 0) {
                const images = doc.querySelectorAll('img');
                images.forEach(img => {
                    const src = img.src || img.getAttribute('data-src');
                    if (isValidImg(src, seen)) {
                        extractedData.push({ src, alt: img.alt || inferAltFromSrc(src), context: 'Uncategorized' });
                        seen.add(src);
                    }
                });
            }

            renderGrid();
        }

        function isValidImg(src, seenSet) {
            if (!src || src.startsWith('data:') || src.length < 5) return false;
            // if (seenSet.has(src)) return false; // Global Dedupe
            if (seenSet.has(src)) return false;
            return true;
        }

        function renderGrid() {
            if (extractedData.length === 0) {
                pasteZone.innerHTML = '<p class="text-red-400">No images found. Try selecting more content.</p>';
                return;
            }

            gridOutput.innerHTML = '';
            const isContext = contextToggle.checked;
            const isWP = wpToggle.checked;

            // Grouping logic
            let grouped = {};
            if (isContext) {
                grouped = extractedData.reduce((acc, item) => {
                    (acc[item.context] = acc[item.context] || []).push(item);
                    return acc;
                }, {});
            } else {
                grouped = { "All Images": extractedData };
            }

            // Render Groups
            for (const [header, items] of Object.entries(grouped)) {

                if (isContext) {
                    const headerEl = document.createElement('div');
                    headerEl.className = 'context-header';
                    headerEl.innerHTML = `<i data-feather="hash" class="w-4 h-4"></i> ${header} <span class="bg-white/10 text-white text-[10px] px-2 rounded-full ml-auto">${items.length}</span>`;
                    gridOutput.appendChild(headerEl);
                }

                items.forEach(data => {
                    // Prepare preview name
                    let displayName = data.alt;
                    if (isWP) {
                        displayName = sanitizeSlug(data.alt); // Preview the slug
                    }

                    const card = document.createElement('div');
                    card.className = 'image-card p-3 flex flex-col gap-3 group relative';
                    card.innerHTML = `
                        <div class="relative aspect-square bg-black/50 rounded-lg overflow-hidden flex items-center justify-center">
                            <img src="${data.src}" class="max-w-full max-h-full object-contain" loading="lazy">
                            
                            <!-- Hover Overlay -->
                            <div class="absolute inset-0 bg-black/80 opacity-0 group-hover:opacity-100 transition flex flex-col items-center justify-center gap-2 p-4 text-center">
                                <p class="text-[10px] text-gray-400 font-mono break-all line-clamp-2 mb-2">${data.src.substring(0, 50)}...</p>
                                <div class="flex gap-2">
                                    <a href="${data.src}" target="_blank" class="p-2 bg-white/10 hover:bg-pink-500 rounded-full text-white transition" title="Open">
                                        <i data-feather="external-link" class="w-4 h-4"></i>
                                    </a>
                                    <button onclick="copyLink('${data.src}')" class="p-2 bg-white/10 hover:bg-pink-500 rounded-full text-white transition" title="Copy URL">
                                        <i data-feather="copy" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-gray-300 line-clamp-2" title="${data.alt}">
                                ${isWP ? '<span class="wp-badge">WP</span> ' : ''}${displayName}
                            </p>
                        </div>
                    `;
                    gridOutput.appendChild(card);
                });
            }

            // UI Update
            countBadge.innerText = extractedData.length;
            resultsContainer.classList.remove('hidden');

            // Reset Paste Zone
            pasteZone.innerHTML = `<i data-feather="check-circle" class="w-8 h-8 text-green-500 mb-2"></i>
                <p class="text-green-400">Found ${extractedData.length} images</p>
                <p class="text-xs text-gray-500 mt-2">Paste again to replace</p>`;

            feather.replace();
        }

        // --- 3. ACTIONS ---

        // RESET
        resetAction.addEventListener('click', () => {
            extractedData = [];
            resultsContainer.classList.add('hidden');
            pasteZone.innerHTML = `<i data-feather="download-cloud" class="w-10 h-10 mb-4 opacity-50"></i><p class="font-medium">Click here & Press <span class="text-white font-mono bg-white/10 px-2 py-1 rounded">Ctrl + V</span></p>`;
        });

        // COPY SINGLE
        window.copyLink = (url) => {
            navigator.clipboard.writeText(url);
            showToast('URL Copied!');
        };

        // COPY ALL
        window.copyAllUrls = () => {
            if (!extractedData.length) return;
            const text = extractedData.map(i => i.src).join('\n');
            navigator.clipboard.writeText(text);
            showToast('All URLs Copied!');
        };

        // EXPORT MENU
        const exportMenu = document.getElementById('exportMenu');
        window.toggleExportMenu = () => {
            exportMenu.classList.toggle('hidden');
        };
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) exportMenu.classList.add('hidden');
        });

        // DOWNLOAD TEXT
        window.downloadText = () => {
            if (!extractedData.length) return;
            const text = extractedData.map(i => i.src).join('\n');
            const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            saveAs(blob, "image_list.txt");
            showToast('Downloaded TEXT List!');
            exportMenu.classList.add('hidden');
        };

        // DOWNLOAD JSON
        window.downloadJson = () => {
            if (!extractedData.length) return;
            const json = JSON.stringify(extractedData, null, 2);
            const blob = new Blob([json], { type: "application/json;charset=utf-8" });
            saveAs(blob, "image_data.json");
            showToast('Downloaded JSON Data!');
            exportMenu.classList.add('hidden');
        };

        // DOWNLOAD ZIP
        window.downloadZip = async () => {
            if (!extractedData.length) return;

            showToast('Preparing ZIP...');
            const zip = new JSZip();

            // Folder Logic
            let rootFolder = zip.folder("reputifly_images");
            if (wpToggle.checked) {
                // WordPress structure
                const pathName = getDatedFolder(); // e.g., "wp-content/uploads/2026/05/"
                // We typically just want the images. But if user wants structure:
                // Let's make the root of the zip contain the structure
                rootFolder = zip.folder(pathName);
            }

            let successCount = 0;
            let failCount = 0;

            const promises = extractedData.map(async (item, index) => {
                try {
                    const response = await fetch(item.src);
                    if (!response.ok) throw new Error('Network error');
                    const blob = await response.blob();

                    let ext = blob.type.split('/')[1] || 'jpg';
                    if (ext.includes('+')) ext = ext.split('+')[0];

                    // Name Logic
                    let filename = "";
                    if (wpToggle.checked) {
                        // WP Sanitized
                        let slug = sanitizeSlug(item.alt);
                        if (!slug) slug = `image-${index}`;
                        filename = `${slug}.${ext}`;
                    } else {
                        // Regular
                        let safeName = item.alt.replace(/[^a-z0-9]/gi, '_').substring(0, 50);
                        if (!safeName) safeName = `image_${index}`;
                        filename = `${safeName}.${ext}`;
                    }

                    rootFolder.file(filename, blob);
                    successCount++;
                } catch (e) {
                    console.warn('Failed', item.src);
                    failCount++;
                }
            });

            await Promise.all(promises);

            zip.generateAsync({ type: "blob" }).then(function (content) {
                saveAs(content, wpToggle.checked ? "wordpress-uploads.zip" : "reputifly_images.zip");
                showToast(`Done! ${successCount} saved, ${failCount} failed.`);
            });
        };

        // BOOKMARKLET
        const bmCode = `javascript:(function(){const i=Array.from(document.images).map(n=>({s:n.src,a:n.alt||'Asset'}));const u=[...new Set(i.map(x=>x.s))];if(!u.length)return alert('No images!');const w=window.open('','_blank');w.document.write('<html><body style="background:#111;color:#eee;font-family:sans-serif;padding:20px"><h1>'+u.length+' Images</h1><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px">'+u.map(s=>'<img src="'+s+'" style="max-width:100%;border:1px solid #333">').join('')+'</div></body></html>');})();`;
        document.getElementById('repBookmarklet').href = bmCode;

        // Auto Focus
        window.addEventListener('load', () => pasteZone.focus());

    </script>
</body>

</html>
