<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reputifly | Image Extractor V3</title>

    <link rel="icon" type="image/png"
        href="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug">
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- V2 Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --bg-deep: #0B0A14;
            --accent-primary: #E6397F;
            --accent-secondary: #FF8A00;
            --text-main: #F0F0F0;
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(20, 20, 30, 0.6);
        }

        /* --- GLOBAL LAYOUT & TEXTURE --- */
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        ::selection {
            background: var(--accent-primary);
            color: white;
        }

        h1,
        h2,
        h3,
        .brand-font {
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -0.02em;
        }

        /* Liquid Mesh Background */
        .mesh-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -2;
            background:
                radial-gradient(at 0% 0%, hsla(336, 83%, 56%, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, hsla(28, 100%, 50%, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, hsla(336, 83%, 56%, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, hsla(240, 100%, 70%, 0.05) 0px, transparent 50%);
            background-size: 150% 150%;
            animation: fluidBackground 20s ease infinite;
            filter: blur(60px);
        }

        @keyframes fluidBackground {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.03;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            transition: background 0.3s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* --- COMPONENTS --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), border-color 0.3s ease;
        }

        .glass-panel:hover {
            border-color: rgba(255, 255, 255, 0.2);
        }

        .btn-liquid-glow {
            background: radial-gradient(circle at top, rgba(255, 255, 255, 0.4) 0%, transparent 60%),
                linear-gradient(90deg, #E6397F, #FF8A00);
            box-shadow:
                0 10px 30px -10px rgba(230, 57, 127, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -2px 0 rgba(0, 0, 0, 0.2);
            border: none;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 9999px;
            color: white;
            font-weight: 700;
            padding: 10px 24px;
            font-size: 13px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn-liquid-glow:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow:
                0 20px 40px -10px rgba(255, 138, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .btn-hero-glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            border-radius: 9999px;
            color: #ccc;
            font-weight: 600;
            padding: 10px 24px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn-hero-glass:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            color: white;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        /* Toggles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 34px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #E6397F;
            border-color: #E6397F;
        }

        input:checked+.slider.wp-slider {
            background-color: #FF8A00;
            border-color: #FF8A00;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        .image-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .image-card:hover {
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.05);
            z-index: 10;
        }

        .context-header {
            grid-column: 1 / -1;
            margin-top: 2rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #E6397F;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-header:first-of-type {
            margin-top: 0;
        }

        /* Toast */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #0B0A14;
            border: 1px solid #E6397F;
            color: #fff;
            text-align: center;
            border-radius: 50px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0 0 20px rgba(230, 57, 127, 0.4);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s, visibility 0.3s;
        }

        #toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }

        .wp-badge {
            background: #FF8A00;
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 4px;
        }
    </style>
</head>

<body>

    <div class="mesh-bg"></div>
    <div class="noise-overlay"></div>
    <div id="toast"><i data-feather="check-circle" class="inline w-4 h-4 mr-2"></i><span>Action Completed</span></div>

    <div class="max-w-7xl mx-auto px-6 py-12 relative z-10">

        <!-- HEADER -->
        <header class="flex flex-col md:flex-row items-center justify-between mb-12 gap-6">
            <div class="flex items-center gap-6">
                <div class="relative group">
                    <div
                        class="absolute -inset-2 bg-pink-500 rounded-full blur-lg opacity-20 group-hover:opacity-40 transition duration-500">
                    </div>
                    <img src="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug"
                        class="relative w-16 h-16 rounded-full border border-white/10 shadow-2xl" alt="Reputifly Icon">
                </div>
                <div>
                    <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png"
                        class="h-6 w-auto brightness-125 mb-1" alt="Reputifly Logo">
                    <h1 class="text-xl font-bold text-white">Image Extractor</h1>
                </div>
            </div>

            <div class="flex gap-4 items-center">
                <button onclick="toggleSettings()"
                    class="p-2 hover:bg-white/10 rounded-full text-gray-400 hover:text-white transition"
                    title="Settings">
                    <i data-feather="settings" class="w-5 h-5"></i>
                </button>
                <a href="#bookmarklet-section" class="btn-hero-glass">
                    <i data-feather="bookmark" class="w-4 h-4"></i> Bookmarklet
                </a>
            </div>
        </header>

        <!-- MAIN LAYOUT -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- LEFT COL: CONTROLS & PASTE -->
            <div class="lg:col-span-12">
                <section class="glass-panel p-6 mb-8">
                    <div class="flex flex-col md:flex-row items-center justify-between mb-6 gap-6">
                        <div>
                            <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                                <i data-feather="layers" class="text-pink-500"></i> Paste Content
                            </h2>
                            <p class="text-gray-400 text-sm mt-1">Copy rich text (Ctrl+A), Paste below (Ctrl+V).</p>
                        </div>

                        <!-- TOOLBAR -->
                        <div class="flex flex-wrap items-center gap-4 bg-white/5 p-3 rounded-2xl border border-white/5">
                            <!-- Toggle: Context -->
                            <label class="flex items-center gap-3 cursor-pointer group px-2">
                                <div class="toggle-switch">
                                    <input type="checkbox" id="contextToggle" checked>
                                    <span class="slider"></span>
                                </div>
                                <div class="text-sm">
                                    <span
                                        class="block font-bold text-white group-hover:text-pink-400 transition">Context</span>
                                    <span class="block text-[10px] text-gray-500">Groups</span>
                                </div>
                            </label>

                            <div class="w-px h-8 bg-white/10"></div>

                            <!-- Toggle: WordPress -->
                            <label class="flex items-center gap-3 cursor-pointer group px-2">
                                <div class="toggle-switch">
                                    <input type="checkbox" id="wpToggle">
                                    <span class="slider wp-slider"></span>
                                </div>
                                <div class="text-sm">
                                    <span
                                        class="block font-bold text-white group-hover:text-[#FF8A00] transition">WordPress</span>
                                    <span class="block text-[10px] text-gray-500">Sanitize</span>
                                </div>
                            </label>

                            <div class="w-px h-8 bg-white/10 mx-2"></div>

                            <button id="resetAction"
                                class="p-2 hover:bg-white/10 rounded-full text-gray-400 hover:text-white transition"
                                title="Clear All">
                                <i data-feather="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <div id="pasteZone"
                        class="w-full bg-black/20 border border-white/10 rounded-xl min-h-[160px] p-6 text-gray-500 text-center flex flex-col items-center justify-center cursor-text transition focus-within:border-pink-500/50 focus-within:bg-black/30 outline-none"
                        contenteditable="true">
                        <i data-feather="download-cloud" class="w-10 h-10 mb-4 opacity-50"></i>
                        <p class="font-medium">Click here & Press <span
                                class="text-white font-mono bg-white/10 px-2 py-1 rounded">Ctrl + V</span></p>
                    </div>
                </section>
            </div>

            <!-- RESULTS -->
            <div class="lg:col-span-12">
                <div id="resultsContainer" class="hidden">
                    <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            Extracted Content <span id="countBadge"
                                class="bg-pink-500 text-white text-xs px-2 py-0.5 rounded-full ml-2">0</span>
                        </h3>

                        <div class="flex gap-3 relative">
                            <!-- EXPORT DROPDOWN -->
                            <div class="relative">
                                <button onclick="toggleExportMenu()" class="btn-hero-glass">
                                    <i data-feather="file-text" class="w-4 h-4"></i> Export List <i
                                        data-feather="chevron-down" class="w-3 h-3 ml-1"></i>
                                </button>
                                <div id="exportMenu"
                                    class="hidden absolute top-full right-0 mt-2 w-48 bg-[#1a1a2e] border border-white/10 rounded-xl shadow-xl overflow-hidden z-50 backdrop-blur-xl">
                                    <button onclick="downloadText()"
                                        class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-white/10 hover:text-white transition flex items-center gap-2">
                                        <i data-feather="align-left" class="w-4 h-4"></i> Text File (.txt)
                                    </button>
                                    <button onclick="downloadJson()"
                                        class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-white/10 hover:text-white transition flex items-center gap-2 border-t border-white/5">
                                        <i data-feather="code" class="w-4 h-4"></i> JSON Data (.json)
                                    </button>
                                </div>
                            </div>

                            <!-- AI TRIGGER BUTTON -->
                            <button onclick="toggleStyleModal()" class="btn-hero-glass group">
                                <i data-feather="pen-tool" class="w-4 h-4 group-hover:text-orange-500 transition"></i>
                                <span class="group-hover:text-white transition">Styles</span>
                            </button>

                            <button onclick="toggleAiModal()" class="btn-liquid-glow">
                                <i data-feather="cpu" class="w-4 h-4"></i> Deep Context AI
                            </button>

                            <button onclick="copyAllUrls()" class="btn-hero-glass">
                                <i data-feather="copy" class="w-4 h-4"></i> Copy URLs
                            </button>
                            <button onclick="downloadZip()" class="btn-liquid-glow">
                                <i data-feather="package" class="w-4 h-4"></i> Download ZIP
                            </button>
                        </div>
                    </div>

                    <div id="gridOutput" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        <!-- Cards injected here -->
                    </div>
                </div>
            </div>

            <!-- BOOKMARKLET SECTION -->
            <div id="bookmarklet-section" class="lg:col-span-12 mt-12 pb-20">
                <section class="glass-panel p-8 border-pink-500/20 relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 p-32 bg-pink-500/10 blur-[100px] rounded-full pointing-events-none">
                    </div>

                    <div class="relative z-10 flex flex-col md:flex-row items-center justify-between gap-8">
                        <div class="max-w-xl">
                            <h2 class="text-2xl font-bold text-white mb-2">Magic Bookmarklet</h2>
                            <p class="text-gray-400 leading-relaxed">
                                Drag this button to your bookmarks bar. Click it on ANY website to extract images
                                without pasting.
                            </p>
                        </div>

                        <div>
                            <a id="repBookmarklet" href="#"
                                class="btn-liquid-glow px-8 py-4 text-lg shadow-[0_0_40px_-5px_rgba(230,57,127,0.5)]">
                                <i data-feather="aperture"></i> Reputifly Extractor
                            </a>
                        </div>
                    </div>
                </section>
            </div>

        </div>

    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-md" onclick="toggleSettings()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md">
            <div class="glass-panel p-8 relative">
                <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i
                        data-feather="x"></i></button>
                <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2"><i data-feather="settings"></i>
                    Settings</h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Gemini API Key</label>
                        <input type="password" id="apiKeyInput"
                            class="w-full bg-black/20 border border-white/10 rounded-lg p-3 text-white focus:border-pink-500/50 outline-none transition"
                            placeholder="Enter your API Key">
                        <p class="text-[10px] text-gray-500 mt-1">Key is stored locally in your browser.</p>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Model</label>
                        <select id="modelInput"
                            class="w-full bg-black/20 border border-white/10 rounded-lg p-3 text-white focus:border-pink-500/50 outline-none transition [&>option]:bg-[#0B0A14]">
                            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                            <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                        </select>
                    </div>
                    <button onclick="saveSettings()" class="w-full btn-liquid-glow justify-center mt-2">Save
                        Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI MODAL -->
    <div id="aiModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="toggleAiModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-4xl h-[80vh] flex flex-col">
            <div class="glass-panel p-6 relative flex flex-col h-full border-pink-500/30">

                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-6 shrink-0">
                    <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                        <i data-feather="cpu" class="text-pink-500"></i> Deep Context AI
                    </h2>
                    <div class="flex gap-3">
                        <button onclick="generateDeepContext()" id="btnGenerate" class="btn-liquid-glow">
                            <i data-feather="zap" class="w-4 h-4"></i> Generate
                        </button>
                        <button onclick="downloadAiContext()" class="btn-hero-glass">
                            <i data-feather="download" class="w-4 h-4"></i> Save .txt
                        </button>
                        <button onclick="toggleAiModal()"
                            class="p-2 hover:bg-white/10 rounded-full text-gray-400 hover:text-white transition">
                            <i data-feather="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="relative group grow flex flex-col min-h-0">
                    <div id="aiLoading"
                        class="hidden absolute inset-0 bg-black/60 backdrop-blur-lg z-20 rounded-xl flex flex-col items-center justify-center text-center">
                        <div
                            class="w-12 h-12 border-4 border-pink-500 border-t-transparent rounded-full animate-spin mb-4">
                        </div>
                        <span class="text-pink-400 font-mono text-lg animate-pulse">Analyzing page structure...</span>
                        <p class="text-gray-400 text-sm mt-2">Connecting to Gemini...</p>
                    </div>
                    <textarea id="aiOutput"
                        class="w-full h-full bg-black/30 border border-white/10 rounded-xl p-6 text-gray-300 font-mono text-sm resize-none focus:border-pink-500/50 focus:bg-black/40 outline-none leading-relaxed"
                        placeholder="Click 'Generate' to analyze the current content..."></textarea>
                </div>

            </div>
        </div>
    </div>

    <!-- STYLE INSPECTOR MODAL -->
    <div id="styleModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md" onclick="toggleStyleModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-4xl max-h-[85vh] flex flex-col">
            <div
                class="glass-panel p-8 relative flex flex-col h-full border-orange-500/30 overflow-y-auto custom-scrollbar">

                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                        <i data-feather="pen-tool" class="text-orange-500"></i> Page Styles
                    </h2>
                    <button onclick="toggleStyleModal()"
                        class="p-2 hover:bg-white/10 rounded-full text-gray-400 hover:text-white transition">
                        <i data-feather="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Typography Section -->
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-4 border-b border-white/10 pb-2">
                        <h3 class="text-lg font-bold text-gray-200">Typography</h3>
                        <button onclick="copyStyles('fonts')"
                            class="text-xs text-orange-400 hover:text-white transition uppercase font-bold tracking-wide">Copy
                            Fonts</button>
                    </div>
                    <div id="styleFonts" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-400 font-mono">
                        <!-- Fonts Injected Here -->
                        <p class="italic opacity-50">No fonts detected.</p>
                    </div>
                </div>

                <!-- Colors Section -->
                <div>
                    <div class="flex items-center justify-between mb-4 border-b border-white/10 pb-2">
                        <h3 class="text-lg font-bold text-gray-200">Color Palette</h3>
                        <button onclick="copyStyles('colors')"
                            class="text-xs text-orange-400 hover:text-white transition uppercase font-bold tracking-wide">Copy
                            Colors</button>
                    </div>
                    <div id="styleColors" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        <!-- Colors Injected Here -->
                        <p class="italic opacity-50 col-span-full">No colors detected.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // Init Icons
        feather.replace();

        // Refs
        const pasteZone = document.getElementById('pasteZone');
        const resultsContainer = document.getElementById('resultsContainer');
        const gridOutput = document.getElementById('gridOutput');
        const countBadge = document.getElementById('countBadge');
        const contextToggle = document.getElementById('contextToggle');
        const wpToggle = document.getElementById('wpToggle');
        const resetAction = document.getElementById('resetAction');
        const toast = document.getElementById('toast');

        // AI Refs
        const settingsModal = document.getElementById('settingsModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const modelInput = document.getElementById('modelInput');
        const aiModal = document.getElementById('aiModal');
        const aiOutput = document.getElementById('aiOutput');
        const aiLoading = document.getElementById('aiLoading');

        // State
        let extractedData = [];
        let rawTextContent = ""; // For AI

        // --- EVENTS ---
        contextToggle.addEventListener('change', () => rerenderIfData());
        wpToggle.addEventListener('change', () => rerenderIfData());

        // PERSISTENCE: LOAD
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('reputifly_data');
            if (saved) {
                try {
                    extractedData = JSON.parse(saved);
                    if (extractedData.length > 0) {
                        renderGrid();
                        showToast('Restored previous session');
                    }
                } catch (e) { console.error('Save Corrupt'); }
            }

            // Load Settings
            const key = localStorage.getItem('reputifly_api_key');
            if (key) apiKeyInput.value = key;

            pasteZone.focus();
        });

        // PERSISTENCE: SAVE
        function saveState() {
            localStorage.setItem('reputifly_data', JSON.stringify(extractedData));
        }

        // SETTINGS LOGIC
        window.toggleSettings = () => {
            settingsModal.classList.toggle('hidden');
        };

        window.toggleAiModal = () => {
            if (extractedData.length === 0 && !rawTextContent && aiModal.classList.contains('hidden')) {
                showToast('Paste content first!');
                return;
            }
            aiModal.classList.toggle('hidden');
        };

        window.saveSettings = () => {
            localStorage.setItem('reputifly_api_key', apiKeyInput.value);
            localStorage.setItem('reputifly_model', modelInput.value);
            showToast('Settings Saved!');
            toggleSettings();
        };

        // AI LOGIC
        // AI LOGIC
        window.generateDeepContext = async () => {
            const key = localStorage.getItem('reputifly_api_key');
            if (!key) {
                showToast('Please set API Key in Settings first');
                toggleSettings();
                return;
            }

            if (!rawTextContent && extractedData.length === 0) {
                showToast('Paste content first!');
                return;
            }

            aiLoading.classList.remove('hidden');

            // Build Context
            let contextPrompt = "Here is the raw text content of a webpage, followed by a list of images found on it. \\n\\n";
            contextPrompt += "=== RAW TEXT CONTENT ===\\n" + rawTextContent.substring(0, 20000) + "\\n\\n"; // Limit for safety
            contextPrompt += "=== IMAGE DATA ===\\n" + extractedData.map(i => `- [Image: ${i.alt}] (Context: ${i.context})`).join('\\n') + "\\n\\n";
            contextPrompt += "=== TASK ===\\nAnalyze this content deeply. Provide a structure breakdown of the page. Explain the context of the images. Output a detailed design brief and content summary that could be used to re-create or understand this page deeply. Format in Markdown.";

            const model = localStorage.getItem('reputifly_model') || 'gemini-2.5-flash';

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: contextPrompt }]
                        }]
                    })
                });

                const data = await response.json();

                if (data.error) throw new Error(data.error.message);

                const text = data.candidates[0].content.parts[0].text;
                aiOutput.value = text;
                showToast('Context Generated!');

            } catch (e) {
                console.error(e);
                aiOutput.value = "Error generating context: " + e.message;
                showToast('Generation Failed');
            } finally {
                aiLoading.classList.add('hidden');
            }
        };

        // STYLE INSPECTOR LOGIC
        window.toggleStyleModal = () => {
            if (extractedStyles.fonts.size === 0 && extractedStyles.colors.size === 0 && styleModal.classList.contains('hidden')) {
                showToast('Paste content first!');
                return;
            }
            renderStyles();
            styleModal.classList.toggle('hidden');
        };

        function extractStyles(doc) {
            extractedStyles = { fonts: new Set(), colors: new Set() };
            const walker = document.createTreeWalker(doc.body, NodeFilter.SHOW_ELEMENT, null);
            while (walker.nextNode()) {
                const node = walker.currentNode;
                if (node.style) {
                    if (node.style.fontFamily) extractedStyles.fonts.add(node.style.fontFamily);
                    if (node.style.color) extractedStyles.colors.add(node.style.color);
                    if (node.style.backgroundColor) extractedStyles.colors.add(node.style.backgroundColor);
                }
                // Try reading attributes for old emails/legacy html
                if (node.getAttribute('color')) extractedStyles.colors.add(node.getAttribute('color'));
                if (node.getAttribute('bgcolor')) extractedStyles.colors.add(node.getAttribute('bgcolor'));
                if (node.getAttribute('face')) extractedStyles.fonts.add(node.getAttribute('face'));
            }
        }

        function renderStyles() {
            // Render Fonts
            if (extractedStyles.fonts.size > 0) {
                styleFonts.innerHTML = Array.from(extractedStyles.fonts).map(f =>
                    `<div class="p-3 bg-white/5 rounded-lg border border-white/5 flex flex-col justify-center">
                        <span style="font-family: ${f}" class="text-lg text-white mb-1 truncate">${f}</span>
                        <span class="text-xs text-gray-500">${f}</span>
                     </div>`
                ).join('');
            }

            // Render Colors
            if (extractedStyles.colors.size > 0) {
                // Filter invalid colors/transparent
                const validColors = Array.from(extractedStyles.colors).filter(c => c && c !== 'transparent' && c !== 'initial' && c !== 'inherit');

                styleColors.innerHTML = validColors.map(c => `
                    <div class="group cursor-pointer relative" onclick="copyLink('${c}')">
                        <div class="h-20 w-full rounded-xl shadow-lg mb-2 border border-white/10 transition group-hover:scale-105" style="background-color: ${c}"></div>
                        <p class="text-[10px] font-mono text-center text-gray-400 group-hover:text-white uppercase truncate">${c}</p>
                         <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 pointer-events-none">
                            <span class="bg-black/80 text-white text-[10px] px-2 py-1 rounded backdrop-blur-md">COPY</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        window.copyStyles = (type) => {
            let text = "";
            if (type === 'fonts') text = "FONTS:\n" + Array.from(extractedStyles.fonts).join('\n');
            if (type === 'colors') text = "PALETTE:\n" + Array.from(extractedStyles.colors).join('\n');
            navigator.clipboard.writeText(text);
            showToast('Copied to Clipboard!');
        };

        window.downloadAiContext = () => {
            if (!aiOutput.value) return;
            const blob = new Blob([aiOutput.value], { type: "text/plain;charset=utf-8" });
            saveAs(blob, "deep_context_analysis.txt");
            showToast('Downloaded Analysis');
        };

        function rerenderIfData() {
            if (extractedData.length > 0) renderGrid();
        }

        // --- 1. UTILS ---
        function showToast(msg) {
            const span = toast.querySelector('span');
            span.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function cleanString(str) {
            return str ? str.trim() : '';
        }

        function sanitizeSlug(str) {
            return str.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        function inferAltFromSrc(src) {
            try {
                const url = new URL(src, window.location.href);
                const pathname = url.pathname;
                const filename = pathname.substring(pathname.lastIndexOf('/') + 1);
                // Remove extension
                let clean = filename.split('.')[0]
                    .replace(/[-_]/g, ' ')
                    .replace(/%20/g, ' ');
                return clean.charAt(0).toUpperCase() + clean.slice(1) || 'Image Asset';
            } catch (e) {
                return 'Image Asset';
            }
        }

        function getDatedFolder() {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            return `wp-content/uploads/${y}/${m}/`;
        }

        // --- 2. CORE LOGIC ---
        pasteZone.addEventListener('paste', (e) => {
            e.preventDefault();
            const html = e.clipboardData.getData('text/html');
            const plainText = e.clipboardData.getData('text/plain'); // Capture plain text for AI

            // Fallback if no HTML but text usually happens
            rawTextContent = plainText; // Store for AI logic

            pasteZone.innerHTML = '<div class="flex flex-col items-center"><div class="w-8 h-8 border-4 border-pink-500 border-t-transparent rounded-full animate-spin mb-4"></div><p class="animate-pulse">Analyzing Content...</p></div>';

            setTimeout(() => {
                processHTML(html || plainText);
            }, 100);
        });

        function processHTML(htmlString) {
            const parser = new DOMParser();

            // Enhance Raw Text capture from the parsed HTML for better structure if possible
            const doc = parser.parseFromString(htmlString, 'text/html');
            if (doc.body.textContent.trim().length > rawTextContent.length) {
                rawTextContent = doc.body.innerText; // Prefer innerText from DOM
            }

            // Extract Styles
            extractStyles(doc);

            extractedData = [];
            gridOutput.innerHTML = '';

            // CONTEXT LOGIC (Always capture context, toggle controls display)
            let currentHeader = 'Uncategorized';
            const seen = new Set();
            const walker = document.createTreeWalker(doc.body, NodeFilter.SHOW_ELEMENT, null);

            while (walker.nextNode()) {
                const node = walker.currentNode;
                const tag = node.tagName.toLowerCase();

                if (['h1', 'h2', 'h3', 'h4', 'h5', 'h6'].includes(tag)) {
                    const text = node.textContent.trim();
                    if (text && text.length < 100) currentHeader = text;
                } else if (tag === 'img') {
                    const src = node.src || node.getAttribute('data-src');
                    if (isValidImg(src, seen)) {
                        extractedData.push({
                            src: src,
                            alt: cleanString(node.alt) || inferAltFromSrc(src),
                            context: currentHeader
                        });
                        seen.add(src);
                    }
                }
            }
            // Fallback if 0 images found via tree walker (sometimes structure is flat)
            if (extractedData.length === 0) {
                const images = doc.querySelectorAll('img');
                images.forEach(img => {
                    const src = img.src || img.getAttribute('data-src');
                    if (isValidImg(src, seen)) {
                        extractedData.push({ src, alt: img.alt || inferAltFromSrc(src), context: 'Uncategorized' });
                        seen.add(src);
                    }
                });
            }

            saveState(); // SAVE ON NEW PASTE
            renderGrid();
        }

        function isValidImg(src, seenSet) {
            if (!src || src.startsWith('data:') || src.length < 5) return false;
            // if (seenSet.has(src)) return false; // Global Dedupe
            if (seenSet.has(src)) return false;
            return true;
        }

        function renderGrid() {
            if (extractedData.length === 0) {
                pasteZone.innerHTML = '<p class="text-red-400">No images found. Try selecting more content.</p>';
                return;
            }

            gridOutput.innerHTML = '';
            const isContext = contextToggle.checked;
            const isWP = wpToggle.checked;

            // Grouping logic
            let grouped = {};
            if (isContext) {
                grouped = extractedData.reduce((acc, item) => {
                    (acc[item.context] = acc[item.context] || []).push(item);
                    return acc;
                }, {});
            } else {
                grouped = { "All Images": extractedData };
            }

            // Render Groups
            for (const [header, items] of Object.entries(grouped)) {

                if (isContext) {
                    const headerEl = document.createElement('div');
                    headerEl.className = 'context-header';
                    headerEl.innerHTML = `<i data-feather="hash" class="w-4 h-4"></i> ${header} <span class="bg-white/10 text-white text-[10px] px-2 rounded-full ml-auto">${items.length}</span>`;
                    gridOutput.appendChild(headerEl);
                }

                items.forEach(data => {
                    // Find actual index in main array for deletion
                    // This is simple since objects are references, but let's store the source index or use ID? 
                    // Simpler: find index of this object in extractedData
                    const realIndex = extractedData.indexOf(data);

                    // Prepare preview name
                    let displayName = data.alt;
                    if (isWP) {
                        displayName = sanitizeSlug(data.alt); // Preview the slug
                    }

                    const card = document.createElement('div');
                    card.className = 'image-card p-3 flex flex-col gap-3 group relative';
                    card.innerHTML = `
                        <div class="relative aspect-square bg-black/50 rounded-lg overflow-hidden flex items-center justify-center">
                            <img src="${data.src}" class="max-w-full max-h-full object-contain" loading="lazy">
                            
                            <!-- ACTIONS OVERLAY -->
                            <div class="absolute inset-0 bg-black/80 opacity-0 group-hover:opacity-100 transition flex flex-col items-center justify-center gap-2 p-4 text-center">
                                
                                <!-- Delete Button (Top Right) -->
                                <button onclick="deleteImage(${realIndex})" class="absolute top-2 right-2 p-1.5 bg-red-500/20 hover:bg-red-500 text-red-500 hover:text-white rounded-lg transition" title="Remove">
                                    <i data-feather="x" class="w-4 h-4"></i>
                                </button>
                                
                                <p class="text-[10px] text-gray-400 font-mono break-all line-clamp-2 mb-2 mt-4">${data.src.substring(0, 50)}...</p>
                                <div class="flex gap-2">
                                    <a href="${data.src}" target="_blank" class="p-2 bg-white/10 hover:bg-pink-500 rounded-full text-white transition" title="Open">
                                        <i data-feather="external-link" class="w-4 h-4"></i>
                                    </a>
                                    <button onclick="copyLink('${data.src}')" class="p-2 bg-white/10 hover:bg-pink-500 rounded-full text-white transition" title="Copy URL">
                                        <i data-feather="copy" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <p class="text-xs text-gray-300 line-clamp-2" title="${data.alt}">
                                ${isWP ? '<span class="wp-badge">WP</span> ' : ''}${displayName}
                            </p>
                        </div>
                    `;
                    gridOutput.appendChild(card);
                });
            }

            // UI Update
            countBadge.innerText = extractedData.length;
            resultsContainer.classList.remove('hidden');

            // Reset Paste Zone
            pasteZone.innerHTML = `<i data-feather="check-circle" class="w-8 h-8 text-green-500 mb-2"></i>
                <p class="text-green-400">Found ${extractedData.length} images</p>
                <p class="text-xs text-gray-500 mt-2">Paste again to replace</p>`;

            feather.replace();
        }

        // --- 3. ACTIONS ---

        // RESET
        resetAction.addEventListener('click', () => {
            if (!confirm('Clear all extracted images?')) return;
            extractedData = [];
            rawTextContent = "";
            saveState();
            resultsContainer.classList.add('hidden');
            aiOutput.value = ""; // Clear AI
            pasteZone.innerHTML = `<i data-feather="download-cloud" class="w-10 h-10 mb-4 opacity-50"></i><p class="font-medium">Click here & Press <span class="text-white font-mono bg-white/10 px-2 py-1 rounded">Ctrl + V</span></p>`;
        });

        // DELETE SINGLE
        window.deleteImage = (index) => {
            extractedData.splice(index, 1);
            saveState();
            if (extractedData.length === 0) {
                resetAction.click(); // Trigger reset UI if empty
            } else {
                renderGrid();
            }
        }

        // COPY SINGLE
        window.copyLink = (url) => {
            navigator.clipboard.writeText(url);
            showToast('URL Copied!');
        };

        // HELPER: GET TEXT CONTENT
        function getExportContent() {
            if (contextToggle.checked) {
                // Context Mode: Grouped
                const grouped = extractedData.reduce((acc, item) => {
                    (acc[item.context] = acc[item.context] || []).push(item.src);
                    return acc;
                }, {});

                let output = "";
                for (const [header, urls] of Object.entries(grouped)) {
                    output += `## ${header}\n`;
                    output += urls.join('\n') + "\n\n";
                }
                return output.trim();
            } else {
                // Flat Mode
                return extractedData.map(i => i.src).join('\n');
            }
        }

        // COPY ALL (Context Aware)
        window.copyAllUrls = () => {
            if (!extractedData.length) return;
            const text = getExportContent();
            navigator.clipboard.writeText(text);
            showToast(contextToggle.checked ? 'Context Copied!' : 'List Copied!');
        };

        // EXPORT MENU
        const exportMenu = document.getElementById('exportMenu');
        window.toggleExportMenu = () => {
            exportMenu.classList.toggle('hidden');
        };
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) exportMenu.classList.add('hidden');
        });

        // DOWNLOAD TEXT (Context Aware)
        window.downloadText = () => {
            if (!extractedData.length) return;
            const text = getExportContent();
            const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            saveAs(blob, contextToggle.checked ? "image_context_list.txt" : "image_list.txt");
            showToast('Downloaded TEXT List!');
            exportMenu.classList.add('hidden');
        };

        // DOWNLOAD JSON
        window.downloadJson = () => {
            if (!extractedData.length) return;
            const json = JSON.stringify(extractedData, null, 2);
            const blob = new Blob([json], { type: "application/json;charset=utf-8" });
            saveAs(blob, "image_data.json");
            showToast('Downloaded JSON Data!');
            exportMenu.classList.add('hidden');
        };

        // DOWNLOAD ZIP
        window.downloadZip = async () => {
            if (!extractedData.length) return;

            showToast('Preparing ZIP...');
            const zip = new JSZip();

            // Folder Logic
            let rootFolder = zip.folder("reputifly_images");
            if (wpToggle.checked) {
                // WordPress structure
                const pathName = getDatedFolder(); // e.g., "wp-content/uploads/2026/05/"
                // We typically just want the images. But if user wants structure:
                // Let's make the root of the zip contain the structure
                rootFolder = zip.folder(pathName);
            }

            let successCount = 0;
            let failCount = 0;

            const promises = extractedData.map(async (item, index) => {
                try {
                    const response = await fetch(item.src);
                    if (!response.ok) throw new Error('Network error');
                    const blob = await response.blob();

                    let ext = blob.type.split('/')[1] || 'jpg';
                    if (ext.includes('+')) ext = ext.split('+')[0];

                    // Name Logic
                    let filename = "";
                    if (wpToggle.checked) {
                        // WP Sanitized
                        let slug = sanitizeSlug(item.alt);
                        if (!slug) slug = `image-${index}`;
                        filename = `${slug}.${ext}`;
                    } else {
                        // Regular
                        let safeName = item.alt.replace(/[^a-z0-9]/gi, '_').substring(0, 50);
                        if (!safeName) safeName = `image_${index}`;
                        filename = `${safeName}.${ext}`;
                    }

                    rootFolder.file(filename, blob);
                    successCount++;
                } catch (e) {
                    console.warn('Failed', item.src);
                    failCount++;
                }
            });

            await Promise.all(promises);

            zip.generateAsync({ type: "blob" }).then(function (content) {
                saveAs(content, wpToggle.checked ? "wordpress-uploads.zip" : "reputifly_images.zip");
                showToast(`Done! ${successCount} saved, ${failCount} failed.`);
            });
        };

        // BOOKMARKLET
        const bmCode = `javascript:(function(){const i=Array.from(document.images).map(n=>({s:n.src,a:n.alt||'Asset'}));const u=[...new Set(i.map(x=>x.s))];if(!u.length)return alert('No images!');const w=window.open('','_blank');w.document.write('<html><body style="background:#111;color:#eee;font-family:sans-serif;padding:20px"><h1>'+u.length+' Images</h1><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px">'+u.map(s=>'<img src="'+s+'" style="max-width:100%;border:1px solid #333">').join('')+'</div></body></html>');})();`;
        document.getElementById('repBookmarklet').href = bmCode;

        // Auto Focus
        window.addEventListener('load', () => pasteZone.focus());

    </script>
</body>

</html>
