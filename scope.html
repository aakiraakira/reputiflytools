<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reputifly | Scope Manager</title>

    <link rel="icon" type="image/png" href="https://reputifly.com/wp-content/uploads/2026/01/IMG_2123.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, getDoc, addDoc, serverTimestamp, query, orderBy, deleteDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, listAll, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDqpzqEVtrEtQvvmcMie_Et7xiNh8QU_Ao",
            authDomain: "reputifly-editor.firebaseapp.com",
            projectId: "reputifly-editor",
            storageBucket: "reputifly-editor.firebasestorage.app",
            messagingSenderId: "455384979132",
            appId: "1:455384979132:web:9079ec81182115b16622b9"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.storage = getStorage(app);
        window.storageRef = ref;
        window.listAll = listAll;
        window.deleteObject = deleteObject;
        window.collection = collection;
        window.onSnapshot = onSnapshot;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
        window.query = query;
        window.orderBy = orderBy;
        window.deleteDoc = deleteDoc;
        window.getDocs = getDocs;
        window.where = where;

        window.dispatchEvent(new Event('firebaseReady'));
    </script>

    <style>
        :root {
            --bg-deep: #050507;
            --accent: #E6397F;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
        }

        body {
            background-color: var(--bg-deep);
            color: #F0F0F0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            background-image:
                radial-gradient(at 0% 0%, rgba(230, 57, 127, 0.08) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.08) 0px, transparent 50%);
            background-attachment: fixed;
        }

        .brand-font {
            font-family: 'Space Grotesk', sans-serif;
        }

        /* UI CARDS */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(24px);
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6);
            border-radius: 24px;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* BUTTONS */
        .btn-primary {
            background: var(--accent);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            transition: 0.2s;
            box-shadow: 0 10px 20px -5px rgba(230, 57, 127, 0.4);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 15px 30px -5px rgba(230, 57, 127, 0.5);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: 1px solid var(--border);
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: 0.2s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-ai {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            color: white;
            border: none;
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.4);
        }

        .btn-ai:hover {
            box-shadow: 0 0 25px rgba(168, 85, 247, 0.6);
            transform: scale(1.02);
        }

        .input-field {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: white;
            border-radius: 12px;
            padding: 12px 16px;
            width: 100%;
            outline: none;
            transition: 0.2s;
            font-size: 14px;
        }

        .input-field:focus {
            border-color: var(--accent);
            background: rgba(0, 0, 0, 0.5);
        }

        /* STATUS BADGE */
        .status-badge {
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-signed {
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-draft {
            background: rgba(255, 255, 255, 0.05);
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-card {
            background: #121218;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 32px;
            width: 90%;
            max-width: 500px;
            transform: scale(0.95);
            transition: 0.3s;
        }

        .modal-overlay.active .modal-card {
            transform: scale(1);
        }

        /* TOAST */
        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1a1a24;
            border: 1px solid #E6397F;
            padding: 12px 24px;
            border-radius: 99px;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 200;
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* SECTION ITEM HOVER */
        .section-item:hover .action-btns {
            opacity: 1;
        }

        .action-btns {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .purpose-input {
            background: transparent;
            border: none;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
            color: #888;
            font-size: 11px;
            width: 100%;
            padding: 4px 0;
            outline: none;
            transition: 0.2s;
        }

        .purpose-input:focus {
            border-color: var(--accent);
            color: #ccc;
        }

        .purpose-input::placeholder {
            color: #444;
            font-style: italic;
        }

        /* CHECKLIST STYLES */
        .checklist-item {
            transition: all 0.2s;
        }
        .checklist-item.completed {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }
        .checklist-item.completed .section-name {
            text-decoration: line-through;
            color: #4ade80;
        }
        .checkbox-custom {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #555;
            border-radius: 6px;
            cursor: pointer;
            display: grid;
            place-content: center;
            transition: 0.2s;
        }
        .checkbox-custom::before {
            content: "";
            width: 10px;
            height: 10px;
            background: #E6397F;
            transform: scale(0);
            transition: 0.2s;
            border-radius: 2px;
        }
        .checkbox-custom:checked {
            border-color: #E6397F;
        }
        .checkbox-custom:checked::before {
            transform: scale(1);
        }
    </style>
</head>

<body class="antialiased">

    <canvas id="exportCanvas" style="display: none;"></canvas>

    <div id="authScreen"
        class="fixed inset-0 z-50 flex items-center justify-center bg-[#050507] p-4 transition-opacity duration-500">
        <div class="glass-panel p-8 w-full max-w-sm text-center">
            <div
                class="w-16 h-16 rounded-full bg-pink-500/10 flex items-center justify-center mx-auto mb-6 border border-pink-500/20">
                <i data-feather="lock" class="w-6 h-6 text-pink-500"></i>
            </div>
            <h1 class="text-2xl font-bold brand-font text-white mb-2">Scope Manager</h1>
            <p class="text-gray-500 text-sm mb-6">Enter admin access code</p>
            <input type="password" id="passcodeInput"
                class="input-field text-center text-lg tracking-[5px] font-bold mb-4" placeholder="••••••">
            <button onclick="authenticate()" class="btn-primary w-full">Unlock</button>
        </div>
    </div>

    <div id="appContainer" class="hidden min-h-screen pb-20">
        <header class="border-b border-white/5 bg-[#050507]/80 backdrop-blur-xl sticky top-0 z-40">
            <div class="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png"
                        class="h-8 brightness-125">
                    <span
                        class="text-xs font-bold bg-white/5 px-2 py-1 rounded text-gray-400 border border-white/5 hidden md:inline-block">SCOPE
                        & CONTRACTS</span>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="openCleanerModal()"
                        class="text-gray-400 hover:text-red-400 p-2 rounded-lg hover:bg-red-500/10 transition mr-1"
                        title="Storage Janitor"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                    <button onclick="openSettings()"
                        class="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-white/5 transition"
                        title="Settings"><i data-feather="settings" class="w-4 h-4"></i></button>
                    <button onclick="showDashboard()" id="dashBtn"
                        class="text-sm font-bold text-gray-400 hover:text-white transition hidden">Dashboard</button>
                    <button onclick="createNewProjectModal()" id="newProjBtn" class="btn-primary py-2 px-4 text-xs"><i
                            data-feather="plus" class="w-3 h-3"></i> New Project</button>
                </div>
            </div>
        </header>

        <main id="dashboardView" class="max-w-6xl mx-auto px-6 py-10 animate-in">
            <div id="projectsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
        </main>

        <main id="editorView" class="hidden max-w-5xl mx-auto px-6 py-10 animate-in">
            <div class="flex items-center justify-between mb-6">
                <button onclick="showDashboard()"
                    class="text-gray-500 hover:text-white flex items-center gap-2 text-sm font-bold"><i
                        data-feather="arrow-left" class="w-4 h-4"></i> Back</button>
                <div class="flex gap-3">
                    <button onclick="openAIModal()" class="btn-primary btn-ai py-2 px-4 text-xs"><i data-feather="zap"
                            class="w-3 h-3"></i> Auto-Generate with AI</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 space-y-6">
                    <div>
                        <h1 class="text-2xl font-bold brand-font text-white mb-1" id="editProjectTitle">...</h1>
                        <p class="text-xs text-gray-500 font-mono" id="editProjectDomain">...</p>
                    </div>

                    <div class="glass-panel p-6">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4">Actions</h3>
                        <div class="space-y-3">
                            <button onclick="addPage()" class="btn-secondary w-full justify-start text-sm"><i
                                    data-feather="plus-square" class="w-4 h-4 text-pink-500"></i> Add Page</button>
                            <button onclick="deleteCurrentProject()"
                                class="btn-secondary w-full justify-start text-sm text-red-400 border-red-500/20 hover:bg-red-500/10"><i
                                    data-feather="trash-2" class="w-4 h-4"></i> Delete Project</button>
                            <button onclick="saveScope()" id="saveScopeBtn"
                                class="btn-primary w-full justify-start text-sm"><i data-feather="save"
                                    class="w-4 h-4"></i> Save Draft</button>

                            <button onclick="exportSitemapImage()"
                                class="btn-secondary w-full justify-start text-sm text-green-400 border-green-500/20 hover:bg-green-500/10"><i
                                    data-feather="download" class="w-4 h-4"></i> Download Sitemap</button>

                            <div class="h-px bg-white/10 my-2"></div>
                            <button onclick="copyClientLink()"
                                class="btn-secondary w-full justify-start text-sm text-blue-400 border-blue-500/20 hover:bg-blue-500/10"><i
                                    data-feather="link" class="w-4 h-4"></i> Copy Client Link</button>
                            <button onclick="copyEmployeeLink()"
                                class="btn-secondary w-full justify-start text-sm text-purple-400 border-purple-500/20 hover:bg-purple-500/10"><i
                                    data-feather="check-square" class="w-4 h-4"></i> Copy Employee Link</button>
                        </div>
                    </div>

                    <div id="signatureStatusCard" class="glass-panel p-6 hidden border-green-500/30 bg-green-500/5">
                        <div class="flex items-center gap-3 text-green-400 mb-2">
                            <i data-feather="check-circle" class="w-5 h-5"></i>
                            <span class="font-bold">Signed & Approved</span>
                        </div>
                        <p class="text-xs text-gray-400 mb-1">Approved by:</p>
                        <p class="text-white font-bold" id="signerNameDisplay">...</p>
                        <p class="text-xs text-gray-500 mt-1" id="signDateDisplay">...</p>
                    </div>
                </div>

                <div class="md:col-span-2">
                    <div id="scopeBuilderArea" class="space-y-6"></div>

                    <div id="emptyState"
                        class="text-center py-16 border-2 border-dashed border-white/10 rounded-2xl hidden">
                        <div
                            class="w-12 h-12 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-500">
                            <i data-feather="map" class="w-6 h-6"></i></div>
                        <p class="text-gray-500 text-sm mb-4">No pages defined yet.</p>
                        <button onclick="openAIModal()" class="text-purple-400 font-bold text-sm hover:underline">✨
                            Generate with AI</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="clientView" class="hidden min-h-screen bg-[#050507] py-12 px-4 animate-in">
        <div class="max-w-2xl mx-auto">
            <div class="text-center mb-10">
                <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png"
                    class="h-10 mx-auto mb-6 brightness-125">
                <div
                    class="inline-block bg-white/5 border border-white/10 px-3 py-1 rounded-full text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4">
                    Project Approval</div>
                <h1 class="text-3xl md:text-4xl font-bold brand-font text-white mb-3" id="clientProjectTitle">Loading...
                </h1>
            </div>

            <div class="glass-panel p-1 border-t-4 border-t-pink-500 mb-8 shadow-2xl shadow-pink-900/20">
                <div class="bg-[#0A0A0F] rounded-xl p-8">
                    <h2 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                        <i data-feather="map" class="w-4 h-4 text-pink-500"></i> Scope of Work
                    </h2>
                    <div id="clientScopeList" class="space-y-8">
                        <div class="text-center py-10 text-gray-500">Loading scope details...</div>
                    </div>
                </div>
            </div>

            <div id="signForm" class="glass-panel p-8">
                <h3 class="text-xl font-bold text-white mb-2">Digital Signature</h3>
                <p class="text-sm text-gray-500 mb-6">By signing below, you approve the Website Structure (sitemap,
                    pages, and included sections) and <a href="https://reputifly.org/terms" target="_blank"
                        class="text-pink-500 hover:text-pink-400 underline decoration-pink-500/30">Terms and
                        Conditions</a>. <span class="text-pink-500">New sections or pages requested after approval will
                        be billed separately.</span></p>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Full Name</label>
                    <input type="text" id="clientNameInput" class="input-field text-lg"
                        placeholder="Type your full name...">
                </div>
                <div class="flex items-start gap-3 mb-6">
                    <input type="checkbox" id="confirmCheck" class="mt-1 w-4 h-4 accent-pink-500 cursor-pointer">
                    <label for="confirmCheck" class="text-sm text-gray-400 cursor-pointer">I confirm that this sitemap
                        includes all required pages and sections.</label>
                </div>
                <button onclick="submitClientSignature()" class="btn-primary w-full py-4 text-lg shadow-lg">Approve &
                    Sign Project</button>
            </div>

            <div id="signSuccess" class="hidden glass-panel p-10 text-center border-green-500/30 bg-green-900/10">
                <div
                    class="w-20 h-20 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-green-500/20">
                    <i data-feather="check" class="w-10 h-10 text-green-500"></i></div>
                <h2 class="text-2xl font-bold text-white mb-2">Project Approved</h2>
                <div
                    class="bg-white/5 inline-block px-6 py-3 rounded-lg text-xs font-mono text-gray-500 border border-white/5">
                    Signed by <span id="successSigner" class="text-white font-bold">...</span><br>
                    <span id="successDate">...</span>
                </div>
            </div>
        </div>
    </div>

    <div id="employeeView" class="hidden min-h-screen bg-[#050507] py-12 px-4 animate-in">
        <div class="max-w-3xl mx-auto">
            <div class="flex items-center justify-between mb-8">
                <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png" class="h-8 brightness-125">
                <div class="bg-purple-500/10 text-purple-400 px-3 py-1 rounded-full text-xs font-bold border border-purple-500/20">
                    DEV CHECKLIST
                </div>
            </div>

            <div class="glass-panel p-8 mb-8">
                <h1 class="text-2xl font-bold text-white mb-2" id="empProjectTitle">Loading...</h1>
                <p class="text-gray-500 text-sm mb-6">Check off sections as you complete them. Save your progress regularly.</p>
                
                <div id="employeeChecklistArea" class="space-y-8"></div>
            </div>

            <div class="sticky bottom-6 z-50">
                <button onclick="saveEmployeeProgress()" id="empSaveBtn" class="btn-primary w-full py-4 text-lg shadow-2xl shadow-purple-900/50 flex items-center justify-center gap-3">
                    <i data-feather="save" class="w-5 h-5"></i> Update Progress
                </button>
            </div>
        </div>
    </div>

    <div id="newProjectModal" class="modal-overlay">
        <div class="modal-card">
            <h2 class="text-xl font-bold text-white mb-6">Create New Project</h2>
            <div class="space-y-4 text-left">
                <div><label class="text-xs font-bold text-gray-500 uppercase">Project Name</label><input type="text"
                        id="newProjName" class="input-field mt-1" placeholder="e.g. My Hands Therapy"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase">Domain</label><input type="text"
                        id="newProjDomain" class="input-field mt-1" placeholder="e.g. myhands.com"></div>
            </div>
            <div class="grid grid-cols-2 gap-3 mt-8">
                <button onclick="closeModal('newProjectModal')" class="btn-secondary justify-center">Cancel</button>
                <button onclick="createNewProject()" class="btn-primary justify-center">Create</button>
            </div>
        </div>
    </div>

    <div id="aiModal" class="modal-overlay">
        <div class="modal-card">
            <div
                class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4 text-white shadow-lg shadow-purple-500/30">
                <i data-feather="zap" class="w-6 h-6"></i></div>
            <h2 class="text-xl font-bold text-white mb-2">AI Sitemap Generator</h2>
            <p class="text-gray-400 text-sm mb-6">Describe the business (e.g., Dentist, Plumber) and AI will build the
                structure with explanations.</p>
            <textarea id="aiPrompt" class="input-field h-32 resize-none mb-4"
                placeholder="e.g. A dental clinic. Needs braces, invisalign pages."></textarea>
            <button onclick="generateWithAI()" id="aiGenBtn" class="btn-primary btn-ai w-full justify-center">Generate
                Structure</button>
            <button onclick="closeModal('aiModal')" class="mt-4 text-xs text-gray-500 hover:text-white">Cancel</button>
        </div>
    </div>
    <div id="cleanerModal" class="modal-overlay">
        <div class="modal-card" style="max-width: 600px;">
            <div
                class="w-12 h-12 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20">
                <i data-feather="database" class="w-6 h-6 text-red-500"></i>
            </div>
            <h2 class="text-xl font-bold text-white mb-2 text-center">Global Media Cleanup</h2>
            <p class="text-gray-400 text-sm mb-6 text-center">
                This option deletes <strong>ALL images and HTML files</strong> for ALL projects.<br>
                <span class="text-green-400">Sitemaps and Links will NOT be deleted.</span>
            </p>

            <div id="cleanerStatus"
                class="bg-black/30 rounded-xl p-6 mb-6 border border-white/5 text-center min-h-[100px] flex flex-col justify-center items-center">
                <span class="text-gray-500 text-sm">Ready to scan storage...</span>
            </div>

            <div id="cleanerFileList" class="text-left mb-6 max-h-40 overflow-y-auto space-y-1 hidden"></div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeModal('cleanerModal')" class="btn-secondary justify-center">Close</button>
                <button onclick="runStorageScan()" id="scanBtn"
                    class="btn-primary justify-center bg-blue-600 hover:bg-blue-500 border-none">Scan Files</button>
                <button onclick="nukeStorageFiles()" id="nukeBtn"
                    class="hidden btn-primary justify-center bg-red-600 hover:bg-red-500 border-none col-span-2">DELETE
                    ALL FILES</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-card">
            <h2 class="text-xl font-bold text-white mb-6">Settings</h2>
            <div class="space-y-4 text-left">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Gemini API Key</label>
                    <input type="password" id="apiKeyInput" class="input-field mt-1" placeholder="AIzaSy...">
                </div>
            </div>
            <button onclick="saveSettings()" class="btn-primary w-full justify-center mt-6">Save Settings</button>
            <button onclick="closeModal('settingsModal')"
                class="mt-4 text-xs text-gray-500 hover:text-white">Close</button>
        </div>
    </div>

    <div id="toast"><i data-feather="info" class="w-4 h-4 text-pink-500"></i><span id="toastMsg">...</span></div>

    <script>
        const ADMIN_PASS = "738081";
        let projects = [];
        let metaMap = {};
        let currentProjectID = null;
        let currentDocID = null; // NEW: Tracks the specific Firebase Document ID
        let scopeData = [];

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();

            const urlParams = new URLSearchParams(window.location.search);
            const clientProject = urlParams.get('client_view');
            const employeeProject = urlParams.get('employee_view');

            if (clientProject || employeeProject) {
                const auth = document.getElementById('authScreen');
                if (auth) auth.remove();
                const app = document.getElementById('appContainer');
                if (app) app.remove();
                
                if (clientProject) initClientView(clientProject);
                if (employeeProject) initEmployeeView(employeeProject);
                return;
            }

            const savedPass = localStorage.getItem('scope_admin_auth');
            if (savedPass === ADMIN_PASS) {
                const authScreen = document.getElementById('authScreen');
                if (authScreen) authScreen.classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                initFirebaseListeners();
            }
        });

        function authenticate() {
            const val = document.getElementById('passcodeInput').value;
            if (val === ADMIN_PASS) {
                localStorage.setItem('scope_admin_auth', ADMIN_PASS);
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                initFirebaseListeners();
            } else {
                showToast("Incorrect Code");
            }
        }

        // --- FIREBASE ---
        function initFirebaseListeners() {
            const q = window.query(window.collection(window.db, "projects"), window.orderBy("createdAt", "desc"));
            window.onSnapshot(q, (snapshot) => {
                projects = [];
                snapshot.forEach(doc => projects.push({ id: doc.id, ...doc.data() }));
                renderDashboard();
            });
        }

        window.deleteCurrentProject = async () => {
            if (!confirm("⚠️ PERMANENT DELETE\n\nThis will delete:\n1. The Project & Sitemap\n2. The Shared Link\n3. All Associated Images & HTML\n\nAre you sure?")) return;

            // Visual Feedback
            const allBtns = document.querySelectorAll('#editorView button');
            allBtns.forEach(b => b.disabled = true);
            showToast("Deleting Project & Media...");

            try {
                // 1. DELETE STORAGE FILES (Media & HTML)
                if (currentDocID) {
                    // Delete the specific HTML file
                    const htmlRef = window.storageRef(window.storage, `project-files/${currentDocID}.html`);
                    try { await window.deleteObject(htmlRef); } catch (e) { console.log("No HTML file to delete"); }

                    // Delete the specific Assets Folder
                    const assetsRef = window.storageRef(window.storage, `project-assets/${currentDocID}`);
                    try {
                        const assetsList = await window.listAll(assetsRef);
                        // Delete all images inside this specific project folder
                        await Promise.all(assetsList.items.map(item => window.deleteObject(item)));
                    } catch (e) { console.log("No assets folder to delete"); }
                }

                // 2. DELETE FIRESTORE DATA (The Link/Metadata)
                const q = window.query(window.collection(window.db, "projects"), window.where("projectName", "==", currentProjectID));
                const snapshot = await window.getDocs(q);
                const deletePromises = [];
                snapshot.forEach((doc) => deletePromises.push(window.deleteDoc(doc.ref)));
                await Promise.all(deletePromises);

                await window.deleteDoc(window.doc(window.db, "project_metadata", currentProjectID));

                showToast("✅ Project Completely Deleted");
                setTimeout(() => location.reload(), 1500);

            } catch (e) {
                console.error(e);
                showToast("Error: " + e.message);
                allBtns.forEach(b => b.disabled = false);
            }
        };

        function renderDashboard() {
            const grid = document.getElementById('projectsGrid');
            if (!grid) return;

            grid.innerHTML = `
                <div onclick="createNewProjectModal()" class="glass-panel p-6 flex flex-col items-center justify-center cursor-pointer border-dashed border-2 border-white/10 hover:border-pink-500/50 hover:bg-pink-500/5 min-h-[200px] group transition-all">
                    <div class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center group-hover:scale-110 transition mb-3">
                        <i data-feather="plus" class="w-6 h-6 text-gray-400 group-hover:text-pink-500"></i>
                    </div>
                    <span class="font-bold text-gray-400 group-hover:text-white">Create New Project</span>
                </div>
            `;

            const uniqueProjects = {};
            projects.forEach(p => {
                const name = p.projectName || "Untitled";
                if (!uniqueProjects[name]) { uniqueProjects[name] = p; }
            });

            Object.values(uniqueProjects).forEach(p => {
                const card = document.createElement('div');
                card.className = "glass-panel p-6 cursor-pointer hover:border-white/20 relative overflow-hidden group";
                card.onclick = () => openEditor(p);
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-10 h-10 rounded-lg bg-white/5 flex items-center justify-center text-gray-400 group-hover:text-white group-hover:bg-white/10 transition"><i data-feather="layout" class="w-5 h-5"></i></div>
                        <span class="status-badge status-draft">Edit</span>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-1 truncate">${p.projectName || 'Untitled'}</h3>
                    <p class="text-xs text-gray-500 font-mono mb-6 truncate">${p.domain || 'No Domain'}</p>
                `;
                grid.appendChild(card);
            });
            feather.replace();
        }

        async function openEditor(project) {
            currentProjectID = project.projectName;
            currentDocID = project.id; // NEW: Capture the exact document ID for storage deletion
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('editorView').classList.remove('hidden');
            document.getElementById('dashBtn').classList.remove('hidden');
            document.getElementById('newProjBtn').classList.add('hidden');
            document.getElementById('editProjectTitle').innerText = project.projectName;
            document.getElementById('editProjectDomain').innerText = project.domain;
            document.getElementById('scopeBuilderArea').innerHTML = '<div class="text-center p-10 text-gray-500">Loading scope data...</div>';

            try {
                const docSnap = await window.getDoc(window.doc(window.db, "project_metadata", currentProjectID));
                if (docSnap.exists()) {
                    const meta = docSnap.data();
                    scopeData = (meta.scope && meta.scope.pages) ? meta.scope.pages : [];
                    const sigCard = document.getElementById('signatureStatusCard');
                    if (meta.scope && meta.scope.signature) {
                        sigCard.classList.remove('hidden');
                        document.getElementById('signerNameDisplay').innerText = meta.scope.signature.name;
                        document.getElementById('signDateDisplay').innerText = new Date(meta.scope.signature.timestamp.toDate()).toLocaleString();
                    } else {
                        sigCard.classList.add('hidden');
                    }
                } else {
                    scopeData = [];
                }
                renderScopeBuilder();
            } catch (e) {
                console.error("Error loading scope:", e);
                showToast("Could not load scope data");
            }
        }

        function renderScopeBuilder() {
            const container = document.getElementById('scopeBuilderArea');
            container.innerHTML = "";

            if (scopeData.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            scopeData.forEach((page, pIdx) => {
                const el = document.createElement('div');
                el.className = "glass-panel p-6 relative animate-in mb-6";
                const sectionsHtml = page.sections.map((sec, sIdx) => {
                    const secName = typeof sec === 'string' ? sec : sec.name;
                    const secDesc = typeof sec === 'string' ? '' : (sec.description || '');

                    return `
                    <div class="section-item flex flex-col gap-2 mb-2 bg-black/30 p-3 rounded-lg group border border-transparent hover:border-white/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-1.5 h-1.5 bg-pink-500 rounded-full flex-shrink-0"></div>
                            <input type="text" value="${secName}" onchange="updateSectionName(${pIdx}, ${sIdx}, this.value)" class="bg-transparent text-sm text-gray-300 w-full outline-none font-medium" placeholder="Section Name">
                            
                            <div class="action-btns flex gap-1">
                                <button onclick="moveSection(${pIdx}, ${sIdx}, -1)" class="text-gray-600 hover:text-white p-1" title="Move Up"><i data-feather="arrow-up" class="w-3 h-3"></i></button>
                                <button onclick="moveSection(${pIdx}, ${sIdx}, 1)" class="text-gray-600 hover:text-white p-1" title="Move Down"><i data-feather="arrow-down" class="w-3 h-3"></i></button>
                                <button onclick="removeSection(${pIdx}, ${sIdx})" class="text-gray-600 hover:text-red-500 p-1" title="Remove"><i data-feather="x" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                        <input type="text" value="${secDesc}" onchange="updateSectionDesc(${pIdx}, ${sIdx}, this.value)" class="purpose-input ml-4" placeholder="Purpose (e.g. Explains benefits to client)">
                    </div>
                `}).join('');

                el.innerHTML = `
                    <div class="flex justify-between items-center mb-4 pb-4 border-b border-white/5">
                        <input type="text" value="${page.name}" onchange="updatePageName(${pIdx}, this.value)" class="bg-transparent text-lg font-bold text-white outline-none w-full placeholder-gray-600" placeholder="Page Name">
                        <button onclick="removePage(${pIdx})" class="text-gray-500 hover:text-red-500 p-2"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <div class="space-y-1 pl-1">
                        ${sectionsHtml}
                    </div>
                    <div class="mt-4 flex gap-2">
                        <input type="text" id="newSecInput-${pIdx}" placeholder="Add section (e.g. Testimonials)" class="bg-white/5 border border-white/10 rounded px-3 py-2 text-sm text-white w-full outline-none focus:border-pink-500 transition-colors" onkeydown="if(event.key==='Enter') addSection(${pIdx})">
                        <button onclick="addSection(${pIdx})" class="bg-white/10 hover:bg-white/20 text-white rounded px-3"><i data-feather="plus" class="w-4 h-4"></i></button>
                    </div>
                `;
                container.appendChild(el);
            });
            feather.replace();
        }

        // --- SCOPE ACTIONS ---
        window.addPage = () => { scopeData.push({ name: "New Page", sections: [] }); renderScopeBuilder(); };
        window.removePage = (idx) => { scopeData.splice(idx, 1); renderScopeBuilder(); };
        window.updatePageName = (idx, val) => { scopeData[idx].name = val; };

        window.addSection = (idx) => {
            const input = document.getElementById(`newSecInput-${idx}`);
            if (input.value.trim()) {
                scopeData[idx].sections.push({ name: input.value.trim(), description: "" });
                input.value = ""; renderScopeBuilder();
                setTimeout(() => document.getElementById(`newSecInput-${idx}`).focus(), 50);
            }
        };

        window.removeSection = (pIdx, sIdx) => { scopeData[pIdx].sections.splice(sIdx, 1); renderScopeBuilder(); };

        window.updateSectionName = (pIdx, sIdx, val) => {
            const sec = scopeData[pIdx].sections[sIdx];
            if (typeof sec === 'string') scopeData[pIdx].sections[sIdx] = { name: val, description: "" };
            else sec.name = val;
        };

        window.updateSectionDesc = (pIdx, sIdx, val) => {
            const sec = scopeData[pIdx].sections[sIdx];
            if (typeof sec === 'string') scopeData[pIdx].sections[sIdx] = { name: sec, description: val };
            else sec.description = val;
        };

        window.moveSection = (pIdx, sIdx, direction) => {
            const sections = scopeData[pIdx].sections;
            const newIndex = sIdx + direction;
            if (newIndex >= 0 && newIndex < sections.length) {
                [sections[sIdx], sections[newIndex]] = [sections[newIndex], sections[sIdx]];
                renderScopeBuilder();
            }
        };

        window.saveScope = async () => {
            const btn = document.getElementById('saveScopeBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "Saving...";

            try {
                const existingRef = window.doc(window.db, "project_metadata", currentProjectID);
                const existingSnap = await window.getDoc(existingRef);
                let existingData = existingSnap.exists() ? existingSnap.data() : {};
                let sig = (existingData.scope && existingData.scope.signature) ? existingData.scope.signature : null;

                await window.setDoc(existingRef, {
                    scope: { pages: scopeData, signature: sig }
                }, { merge: true });

                showToast("Scope Saved Successfully!");
            } catch (e) { console.error("Save Error:", e); showToast("Error Saving. See Console."); }
            btn.innerHTML = originalText;
        };

        window.copyClientLink = () => {
            const url = `${window.location.origin}${window.location.pathname}?client_view=${encodeURIComponent(currentProjectID)}`;
            navigator.clipboard.writeText(url);
            showToast("Client Link Copied!");
        };

        window.showDashboard = () => {
            document.getElementById('editorView').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');
            document.getElementById('dashBtn').classList.add('hidden');
            document.getElementById('newProjBtn').classList.remove('hidden');
        };

        window.openSettings = () => {
            const key = localStorage.getItem('reputifly_gemini_key');
            if (key) document.getElementById('apiKeyInput').value = key;
            openModal('settingsModal');
        }
        window.saveSettings = () => {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) localStorage.setItem('reputifly_gemini_key', key);
            closeModal('settingsModal');
            showToast("Settings Saved");
        }

        function openAIModal() {
            const key = localStorage.getItem('reputifly_gemini_key');
            if (!key) { alert("Please add API Key in settings"); openSettings(); return; }
            openModal('aiModal');
        }

        async function generateWithAI() {
            const promptText = document.getElementById('aiPrompt').value;
            if (!promptText) return showToast("Describe the project");

            const btn = document.getElementById('aiGenBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "Thinking...";
            btn.disabled = true;

            const apiKey = localStorage.getItem('reputifly_gemini_key');
            const sysPrompt = `You are a professional website architect. Create a complete sitemap. For EACH section, provide a short 1-sentence description of its purpose to educate the client. Output JSON ONLY format: { "pages": [{ "name": "Home", "sections": [{ "name": "Hero Section", "description": "High impact banner." }] }] }`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: sysPrompt + "\nClient Request: " + promptText }] }] })
                });

                const data = await response.json();
                let rawText = data.candidates[0].content.parts[0].text;
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                const json = JSON.parse(rawText);
                if (json.pages) { scopeData = json.pages; renderScopeBuilder(); saveScope(); closeModal('aiModal'); showToast("Sitemap Generated! ✨"); }
            } catch (e) { console.error(e); alert("AI Error."); }

            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        async function initClientView(projectName) {
            document.getElementById('clientView').classList.remove('hidden');
            currentProjectID = decodeURIComponent(projectName);
            document.getElementById('clientProjectTitle').innerText = currentProjectID;

            try {
                const docSnap = await window.getDoc(window.doc(window.db, "project_metadata", currentProjectID));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.scope && data.scope.pages) { renderClientScope(data.scope); }
                    else { document.getElementById('clientScopeList').innerHTML = "<div class='text-center p-8 text-gray-500'>Scope pending...</div>"; }
                }
            } catch (e) { console.error(e); }
        }

        function renderClientScope(scope) {
            const container = document.getElementById('clientScopeList');
            container.innerHTML = "";
            const isSigned = !!scope.signature;

            if (isSigned) {
                document.getElementById('signForm').classList.add('hidden');
                document.getElementById('signSuccess').classList.remove('hidden');
                document.getElementById('successSigner').innerText = scope.signature.name;
                document.getElementById('successDate').innerText = new Date(scope.signature.timestamp.toDate()).toLocaleString();
            }

            scope.pages.forEach(page => {
                const sectionsHtml = page.sections.map(sec => {
                    const name = typeof sec === 'string' ? sec : sec.name;
                    const desc = (typeof sec === 'object' && sec.description) ? sec.description : '';
                    return `
                    <div class="flex flex-col p-4 rounded-xl border ${isSigned ? "bg-green-900/10 border-green-500/20 text-green-400" : "bg-white/5 border-white/5 text-gray-300"} transition-all duration-300">
                        <div class="flex items-center gap-4">
                            ${isSigned ? '<i data-feather="check-circle" class="w-5 h-5 text-green-500 flex-shrink-0"></i>' : '<div class="w-2 h-2 rounded-full bg-pink-500 shadow-[0_0_8px_rgba(230,57,127,0.5)] flex-shrink-0"></div>'}
                            <span class="text-base font-bold tracking-tight">${name}</span>
                        </div>
                        ${desc ? `<p class="text-xs text-gray-500 mt-2 ml-6 pl-1 border-l-2 border-white/10 italic">${desc}</p>` : ''}
                    </div>
                `}).join('');

                container.innerHTML += `
                    <div class="mb-12 animate-in">
                        <h3 class="text-xl font-bold text-white mb-5 pb-3 border-b border-white/10 flex items-center gap-3">${page.name}</h3>
                        <div class="flex flex-col gap-3">${sectionsHtml}</div>
                    </div>
                `;
            });
            feather.replace();
        }

        window.submitClientSignature = async () => {
            const name = document.getElementById('clientNameInput').value.trim();
            const checked = document.getElementById('confirmCheck').checked;
            
            if (!name || !checked) return showToast("Please fill all fields");
            
            const btn = document.querySelector('#signForm button');
            const originalText = btn.innerText;
            btn.innerText = "Securing Signature..."; 
            btn.disabled = true;

            try {
                // 1. CAPTURE DIGITAL FINGERPRINT (Evidence)
                const metadata = {
                    project: currentProjectID,
                    signer_name: name,
                    signed_at_iso: new Date().toISOString(),
                    url: window.location.href,
                    user_agent: navigator.userAgent || 'Unknown',
                    screen_res: `${window.screen.width}x${window.screen.height}`,
                    window_size: `${window.innerWidth}x${window.innerHeight}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: navigator.language || 'en-US',
                    platform: navigator.platform || 'Unknown',
                    referrer: document.referrer || 'Direct Access'
                };

                // 2. UPDATE FIRESTORE (The Legal Record)
                const docRef = window.doc(window.db, "project_metadata", currentProjectID);
                const docSnap = await window.getDoc(docRef);
                const data = docSnap.data();
                
                // Save signature + metadata to database
                await window.setDoc(docRef, { 
                    scope: { 
                        ...data.scope, 
                        signature: { 
                            name: name, 
                            timestamp: window.serverTimestamp(),
                            ...metadata 
                        } 
                    } 
                }, { merge: true });

                // 3. API NOTIFICATION (Instant Alert to Tracking)
                try {
                    // Using your existing Reputifly Cloud Function
                    await fetch("https://asia-southeast1-b2b-software.cloudfunctions.net/reputifly", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            _to: "julian@reputifly.com",
                            _subject: `✍️ CONTRACT SIGNED: ${currentProjectID}`,
                            _sender_name: "Scope Manager",
                            // Data Fields for Email Body
                            "Project Name": currentProjectID,
                            "Signer Name": name,
                            "Signed At": new Date().toLocaleString('en-SG', { timeZone: 'Asia/Singapore' }),
                            "Device": metadata.platform,
                            "Browser Agent": metadata.user_agent,
                            "Screen Res": metadata.screen_res,
                            "Location/Timezone": metadata.timezone,
                            "Signature Link": window.location.href
                        })
                    });
                } catch (apiErr) {
                    console.warn("API Log Failed (Non-fatal):", apiErr);
                    // We continue because the Firestore save was successful
                }

                // 4. SUCCESS STATE
                showToast("Signature Secured! Redirecting...");
                setTimeout(() => location.reload(), 1500);

            } catch (e) { 
                console.error(e); 
                showToast("Error Signing: " + e.message); 
                btn.innerText = originalText;
                btn.disabled = false; 
            }
        };

        window.createNewProjectModal = () => openModal('newProjectModal');
        window.closeModal = (id, e) => { if (e && e.target !== document.getElementById(id)) return; document.getElementById(id).classList.remove('active'); };
        window.openModal = (id) => document.getElementById(id).classList.add('active');

        window.createNewProject = async () => {
            const name = document.getElementById('newProjName').value.trim();
            const domain = document.getElementById('newProjDomain').value.trim();
            if (!name) return showToast("Name required");
            try {
                await window.addDoc(window.collection(window.db, "projects"), { projectName: name, domain: domain, createdAt: window.serverTimestamp(), last_active: window.serverTimestamp() });
                await window.setDoc(window.doc(window.db, "project_metadata", name), { scope: { pages: [{ name: "Home", sections: [{ name: "Hero Section", description: "Top banner area" }] }], signature: null } });
                closeModal('newProjectModal'); showToast("Created!");
            } catch (e) { console.error(e); showToast("Error"); }
        };
        // --- STORAGE JANITOR LOGIC ---
        let filesToDelete = [];

        window.openCleanerModal = () => {
            document.getElementById('cleanerStatus').innerHTML = '<span class="text-gray-500 text-sm">Ready to scan storage...</span>';
            document.getElementById('cleanerFileList').classList.add('hidden');
            document.getElementById('nukeBtn').classList.add('hidden');
            document.getElementById('scanBtn').innerHTML = "Scan Files";
            document.getElementById('scanBtn').disabled = false;
            openModal('cleanerModal');
        };

        window.runStorageScan = async () => {
            const status = document.getElementById('cleanerStatus');
            const list = document.getElementById('cleanerFileList');
            const scanBtn = document.getElementById('scanBtn');
            const nukeBtn = document.getElementById('nukeBtn');

            scanBtn.innerHTML = "Scanning...";
            scanBtn.disabled = true;
            status.innerHTML = '<span class="text-blue-400 font-bold animate-pulse">Scanning buckets...</span>';
            filesToDelete = [];
            list.innerHTML = "";

            try {
                // 1. Scan HTML Backups
                const htmlRef = window.storageRef(window.storage, 'project-files');
                const htmlRes = await window.listAll(htmlRef);
                htmlRes.items.forEach(i => filesToDelete.push(i));

                // 2. Scan Project Assets (Nested Folders)
                const assetsRef = window.storageRef(window.storage, 'project-assets');
                const assetsRes = await window.listAll(assetsRef);

                for (const folder of assetsRes.prefixes) {
                    const folderRes = await window.listAll(folder);
                    folderRes.items.forEach(i => filesToDelete.push(i));
                }

                if (filesToDelete.length > 0) {
                    status.innerHTML = `<span class="text-white font-bold text-3xl">${filesToDelete.length}</span><span class="text-gray-500 text-xs uppercase tracking-widest block mt-1">Files Found</span>`;

                    list.classList.remove('hidden');
                    filesToDelete.slice(0, 5).forEach(f => {
                        list.innerHTML += `<div class="text-xs text-gray-500 font-mono truncate border-b border-white/5 py-1">${f.fullPath}</div>`;
                    });
                    if (filesToDelete.length > 5) list.innerHTML += `<div class="text-xs text-gray-600 italic mt-2 text-center">...and ${filesToDelete.length - 5} more</div>`;

                    nukeBtn.classList.remove('hidden');
                    nukeBtn.innerHTML = `DELETE ${filesToDelete.length} FILES`;
                } else {
                    status.innerHTML = `<span class="text-green-500 font-bold text-xl flex items-center gap-2"><i data-feather="check"></i> System Clean</span><span class="text-gray-500 text-xs mt-1 block">0 bytes used</span>`;
                }
            } catch (e) {
                console.error(e);
                status.innerHTML = `<span class="text-red-500">Error: ${e.message}</span>`;
            }
            scanBtn.innerHTML = "Rescan";
            scanBtn.disabled = false;
        };

        window.nukeStorageFiles = async () => {
            if (!confirm("⚠️ FINAL WARNING: This will delete ALL uploaded images and HTML backups from the cloud. Sitemaps will stay safe. Continue?")) return;

            const nukeBtn = document.getElementById('nukeBtn');
            const status = document.getElementById('cleanerStatus');
            nukeBtn.innerHTML = "DELETING...";
            nukeBtn.disabled = true;

            let deleted = 0;
            const batchSize = 5;

            for (let i = 0; i < filesToDelete.length; i += batchSize) {
                const batch = filesToDelete.slice(i, i + batchSize);
                await Promise.all(batch.map(f => window.deleteObject(f)));
                deleted += batch.length;
                status.innerHTML = `<span class="text-red-400 font-bold">Deleted ${deleted} / ${filesToDelete.length}...</span>`;
            }

            status.innerHTML = `<span class="text-green-500 font-bold text-xl">All Files Deleted</span>`;
            nukeBtn.classList.add('hidden');
            document.getElementById('cleanerFileList').innerHTML = "";
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // --- NEW: EXPORT SITEMAP IMAGE FUNCTION ---
        window.exportSitemapImage = () => {
            const canvas = document.getElementById('exportCanvas');
            const ctx = canvas.getContext('2d');

            // 1. Calculate Dimensions based on scopeData
            // Max height depends on number of sections. Max width depends on number of pages.
            // Using Gloopmap style layout logic

            const pages = scopeData;
            const maxSections = Math.max(...pages.map(p => p.sections.length), 0);

            const nodeHeight = 40;
            const nodeGap = 15;
            const headerHeight = 150;
            const colWidth = 220; // Width allocated per page column
            const canvasWidth = Math.max(1200, pages.length * colWidth + 100);
            const canvasHeight = headerHeight + (maxSections * (nodeHeight + nodeGap)) + 150;

            canvas.width = canvasWidth;
            canvas.height = canvasHeight;

            // 2. Clear & Background (White for clean export)
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 3. Draw Project Name (Root)
            const rootX = canvasWidth / 2;
            const rootY = 50;
            const brandColor = '#2563eb'; // Blue export theme
            const textColor = '#1e293b';

            ctx.textAlign = 'center';
            ctx.lineWidth = 2;
            ctx.font = 'bold 16px Inter, sans-serif';

            // Draw Root
            ctx.fillStyle = '#1e293b'; // Dark bg for root
            ctx.strokeStyle = '#0f172a';
            ctx.fillRect(rootX - 100, rootY, 200, 50);
            ctx.strokeRect(rootX - 100, rootY, 200, 50);
            ctx.fillStyle = '#ffffff';
            ctx.fillText(currentProjectID || 'WEBSITE PROJECT', rootX, rootY + 30);

            // 4. Draw Pages & Sections
            const pageY = 150;
            // Center the pages block
            const totalPagesW = pages.length * colWidth;
            const startX = (canvasWidth - totalPagesW) / 2 + (colWidth / 2);

            pages.forEach((page, i) => {
                const x = startX + (i * colWidth);

                // Connector from Root
                ctx.beginPath();
                ctx.strokeStyle = '#94a3b8';
                ctx.moveTo(rootX, rootY + 50);
                ctx.lineTo(rootX, (rootY + 50 + pageY) / 2);
                ctx.lineTo(x, (rootY + 50 + pageY) / 2);
                ctx.lineTo(x, pageY);
                ctx.stroke();

                // Page Node
                ctx.fillStyle = brandColor;
                ctx.strokeStyle = brandColor;
                ctx.fillRect(x - 90, pageY, 180, 45);
                ctx.strokeRect(x - 90, pageY, 180, 45);
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 14px Inter, sans-serif';
                ctx.fillText(page.name.toUpperCase(), x, pageY + 28);

                // Child Sections
                let currentY = pageY + 45 + 20;

                if (page.sections.length > 0) {
                    // Vertical Line
                    ctx.beginPath();
                    ctx.strokeStyle = '#cbd5e1';
                    ctx.moveTo(x, pageY + 45);
                    ctx.lineTo(x, currentY + ((page.sections.length - 1) * 55));
                    ctx.stroke();

                    page.sections.forEach(sect => {
                        const secName = typeof sect === 'string' ? sect : sect.name;

                        // Section Box (White Pill)
                        ctx.fillStyle = '#f8fafc';
                        ctx.strokeStyle = '#cbd5e1';
                        ctx.fillRect(x - 80, currentY, 160, 40);
                        ctx.strokeRect(x - 80, currentY, 160, 40);

                        ctx.fillStyle = '#334155';
                        ctx.font = '500 12px Inter, sans-serif';
                        let displayName = secName.length > 22 ? secName.substring(0, 20) + '...' : secName;
                        ctx.fillText(displayName, x, currentY + 25);

                        currentY += 55;
                    });
                }
            });

            // 5. Download
            canvas.toBlob(function (blob) {
                saveAs(blob, `${currentProjectID}_sitemap.png`);
            });
        };

        // --- EMPLOYEE & EXCLUSION LOGIC ---

        // 1. Updated Render Scope Builder to Include Exclusion Toggle
        const originalRender = renderScopeBuilder; 
        renderScopeBuilder = () => {
            const container = document.getElementById('scopeBuilderArea');
            container.innerHTML = "";

            if (scopeData.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            scopeData.forEach((page, pIdx) => {
                const el = document.createElement('div');
                // Visual indicator if excluded
                const isExcluded = page.exclude === true;
                el.className = `glass-panel p-6 relative animate-in mb-6 ${isExcluded ? 'border-dashed border-gray-600 opacity-75' : ''}`;
                
                const sectionsHtml = page.sections.map((sec, sIdx) => {
                    const secName = typeof sec === 'string' ? sec : sec.name;
                    const secDesc = typeof sec === 'string' ? '' : (sec.description || '');

                    return `
                    <div class="section-item flex flex-col gap-2 mb-2 bg-black/30 p-3 rounded-lg group border border-transparent hover:border-white/10 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-1.5 h-1.5 bg-pink-500 rounded-full flex-shrink-0"></div>
                            <input type="text" value="${secName}" onchange="updateSectionName(${pIdx}, ${sIdx}, this.value)" class="bg-transparent text-sm text-gray-300 w-full outline-none font-medium" placeholder="Section Name">
                            
                            <div class="action-btns flex gap-1">
                                <button onclick="moveSection(${pIdx}, ${sIdx}, -1)" class="text-gray-600 hover:text-white p-1" title="Move Up"><i data-feather="arrow-up" class="w-3 h-3"></i></button>
                                <button onclick="moveSection(${pIdx}, ${sIdx}, 1)" class="text-gray-600 hover:text-white p-1" title="Move Down"><i data-feather="arrow-down" class="w-3 h-3"></i></button>
                                <button onclick="removeSection(${pIdx}, ${sIdx})" class="text-gray-600 hover:text-red-500 p-1" title="Remove"><i data-feather="x" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                        <input type="text" value="${secDesc}" onchange="updateSectionDesc(${pIdx}, ${sIdx}, this.value)" class="purpose-input ml-4" placeholder="Purpose">
                    </div>
                `}).join('');

                el.innerHTML = `
                    <div class="flex flex-col gap-2 mb-4 pb-4 border-b border-white/5">
                        <div class="flex justify-between items-center">
                            <input type="text" value="${page.name}" onchange="updatePageName(${pIdx}, this.value)" class="bg-transparent text-lg font-bold text-white outline-none w-full placeholder-gray-600" placeholder="Page Name">
                            <button onclick="removePage(${pIdx})" class="text-gray-500 hover:text-red-500 p-2"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        <div class="flex items-center gap-2">
                             <input type="checkbox" id="exclude-${pIdx}" ${isExcluded ? 'checked' : ''} onchange="togglePageExclusion(${pIdx})" class="accent-pink-500 w-4 h-4 cursor-pointer">
                             <label for="exclude-${pIdx}" class="text-xs text-gray-400 cursor-pointer hover:text-white">Exclude from Employee Checklist (e.g. Terms)</label>
                        </div>
                    </div>
                    <div class="space-y-1 pl-1">
                        ${sectionsHtml}
                    </div>
                    <div class="mt-4 flex gap-2">
                        <input type="text" id="newSecInput-${pIdx}" placeholder="Add section..." class="bg-white/5 border border-white/10 rounded px-3 py-2 text-sm text-white w-full outline-none focus:border-pink-500 transition-colors" onkeydown="if(event.key==='Enter') addSection(${pIdx})">
                        <button onclick="addSection(${pIdx})" class="bg-white/10 hover:bg-white/20 text-white rounded px-3"><i data-feather="plus" class="w-4 h-4"></i></button>
                    </div>
                `;
                container.appendChild(el);
            });
            feather.replace();
        }

        window.togglePageExclusion = (idx) => {
            scopeData[idx].exclude = !scopeData[idx].exclude;
            renderScopeBuilder(); // Re-render to show visual feedback
        }

        window.copyEmployeeLink = () => {
            const url = `${window.location.origin}${window.location.pathname}?employee_view=${encodeURIComponent(currentProjectID)}`;
            navigator.clipboard.writeText(url);
            showToast("Employee Checklist Link Copied!");
        };

        // --- EMPLOYEE VIEW FUNCTIONS ---
        async function initEmployeeView(projectName) {
            document.getElementById('employeeView').classList.remove('hidden');
            currentProjectID = decodeURIComponent(projectName);
            document.getElementById('empProjectTitle').innerText = currentProjectID;

            try {
                const docSnap = await window.getDoc(window.doc(window.db, "project_metadata", currentProjectID));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.scope && data.scope.pages) { 
                        scopeData = data.scope.pages;
                        renderEmployeeScope(); 
                    }
                }
            } catch (e) { console.error(e); }
        }

        function renderEmployeeScope() {
            const container = document.getElementById('employeeChecklistArea');
            container.innerHTML = "";

            let totalTasks = 0;
            let completedTasks = 0;

            scopeData.forEach((page, pIdx) => {
                const isExcluded = page.exclude === true;
                
                // If excluded, render simple read-only list
                if (isExcluded) {
                    const sectionsHtml = page.sections.map(sec => {
                         const name = typeof sec === 'string' ? sec : sec.name;
                         return `<div class="text-gray-600 text-sm py-1 ml-4">• ${name}</div>`
                    }).join('');
                    
                    container.innerHTML += `
                        <div class="opacity-50 border border-dashed border-gray-700 rounded-xl p-6">
                            <h3 class="text-lg font-bold text-gray-500 mb-2 flex items-center gap-2"><i data-feather="eye-off" class="w-4 h-4"></i> ${page.name} <span class="text-xs bg-gray-800 px-2 py-0.5 rounded ml-2">For Client Reference Only</span></h3>
                            ${sectionsHtml}
                        </div>`;
                    return;
                }

                // If not excluded, render checklist
                const sectionsHtml = page.sections.map((sec, sIdx) => {
                    const name = typeof sec === 'string' ? sec : sec.name;
                    const desc = (typeof sec === 'object' && sec.description) ? sec.description : '';
                    const isDone = (typeof sec === 'object' && sec.completed) === true;
                    
                    if (!isExcluded) totalTasks++;
                    if (isDone) completedTasks++;

                    return `
                    <label class="checklist-item flex items-start gap-4 p-4 rounded-xl bg-white/5 border border-white/5 cursor-pointer hover:bg-white/10 ${isDone ? 'completed' : ''}">
                        <input type="checkbox" class="checkbox-custom mt-1" ${isDone ? 'checked' : ''} onchange="toggleTask(${pIdx}, ${sIdx})">
                        <div class="flex-1">
                            <span class="section-name font-bold text-gray-200 block ${isDone ? 'line-through text-gray-500' : ''}">${name}</span>
                            ${desc ? `<p class="text-xs text-gray-500 mt-1">${desc}</p>` : ''}
                        </div>
                    </label>
                `}).join('');

                container.innerHTML += `
                    <div class="animate-in">
                        <h3 class="text-xl font-bold text-white mb-4 pl-1 border-l-4 border-purple-500 ml-1">${page.name}</h3>
                        <div class="flex flex-col gap-3">${sectionsHtml}</div>
                    </div>
                `;
            });
            
            // Update Save Button Text with Stats
            const pct = totalTasks === 0 ? 100 : Math.round((completedTasks/totalTasks)*100);
            document.getElementById('empSaveBtn').innerHTML = `<i data-feather="save" class="w-5 h-5"></i> Update Progress (${pct}% Complete)`;
            feather.replace();
        }

        window.toggleTask = (pIdx, sIdx) => {
            const sec = scopeData[pIdx].sections[sIdx];
            
            // Convert string to object if needed to store state
            if (typeof sec === 'string') {
                scopeData[pIdx].sections[sIdx] = { name: sec, description: "", completed: true };
            } else {
                sec.completed = !sec.completed;
            }
            renderEmployeeScope();
        }

        window.saveEmployeeProgress = async () => {
            const btn = document.getElementById('empSaveBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "Saving...";
            
            try {
                // Determine if we need to preserve signature
                const existingRef = window.doc(window.db, "project_metadata", currentProjectID);
                const existingSnap = await window.getDoc(existingRef);
                const existingData = existingSnap.exists() ? existingSnap.data() : {};
                const sig = (existingData.scope && existingData.scope.signature) ? existingData.scope.signature : null;

                await window.setDoc(existingRef, {
                    scope: { pages: scopeData, signature: sig }
                }, { merge: true });

                showToast("Progress Saved! ✅");
            } catch(e) { console.error(e); showToast("Error Saving"); }
            
            setTimeout(() => btn.innerHTML = originalText, 1000);
        };
    </script>
</body>

</html>
