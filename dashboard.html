<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Functional Analytics Dashboard</title>
    <link rel="icon" type="image/png" href="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>

    
    <script>
        // Custom Tailwind theme configuration
        tailwind.config = {
            darkMode: 'class', // Enable dark mode using a class
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'dark-bg': '#0F172A', // Main dark background
                        'dark-surface': '#1E293B', // Card and modal backgrounds
                        'dark-border': '#334155',
                        'dark-text-primary': '#F8FAFC',
                        'dark-text-secondary': '#94A3B8',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom styles for a polished look and feel */
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .modal { display: none; animation: fadeIn 0.3s ease-out; }
        .modal-content { animation: slideInUp 0.4s ease-out; }
        .page-view { display: none; animation: fadeIn 0.5s ease-out; }
        .page-view.active { display: block; }
        .loader { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
        th.sortable:hover { cursor: pointer; background-color: #f9fafb; }
        .dark th.sortable:hover { background-color: #334155; }
        th.sortable .sort-indicator { opacity: 0.3; transition: opacity 0.2s; }
        th.sortable:hover .sort-indicator { opacity: 0.7; }
        th.sort-asc .sort-indicator,
        th.sort-desc .sort-indicator { opacity: 1; }

        .switcher-btn { transition: background-color 0.2s, color 0.2s; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; }
        .switcher-btn.active { background-color: #3b82f6; color: white; }
        .switcher-btn:not(.active) { background-color: transparent; }
        .dark .switcher-btn:not(.active) { color: #94A3B8; }
        
        .table-tab-btn {
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            text-transform: capitalize;
        }
         .table-tab-btn.active {
            background-color: #e5e7eb;
            color: #111827;
        }
        .dark .table-tab-btn.active {
            background-color: #4b5563;
            color: #f9fafb;
        }
        
        .legend-item { cursor: pointer; }
        .legend-item.hidden-dataset { text-decoration: line-through; opacity: 0.5; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Hover glow effect for dashboard cards */
        .dashboard-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.07);
        }
        .dark .dashboard-card:hover {
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        /* Task & Sub-task Styles */
        .task-board-column { min-height: 400px; }
        .task-card { cursor: pointer; }
        .task-card:active { cursor: grabbing; }
        .task-card.dragging { opacity: 0.5; cursor: grabbing; box-shadow: 0 15px 30px rgba(0,0,0,0.2); transform: scale(1.05); }
        .drop-zone { min-height: 100px; border: 2px dashed transparent; transition: border-color 0.2s; }
        .drop-zone.drag-over { border-color: #3b82f6; background-color: rgba(59, 130, 246, 0.05); }
        .drop-placeholder { height: 50px; background-color: rgba(59, 130, 246, 0.2); border: 2px dashed #3b82f6; border-radius: 0.5rem; margin-bottom: 1rem; }
        
        .subtask-item-header {
            cursor: pointer;
        }
        .subtask-item-body {
            display: none;
            background-color: rgba(0,0,0,0.02);
            padding-left: 2.25rem;
        }
        .dark .subtask-item-body {
            background-color: rgba(255,255,255,0.03);
        }
        .subtask-item-body.expanded {
            display: block;
        }
        .subtask-item input[type="checkbox"]:checked + .subtask-title-input { 
            text-decoration: line-through; color: #9ca3af; 
        }
        .expand-icon { transition: transform 0.2s; }
        .subtask-item-header.expanded > .expand-icon { transform: rotate(90deg); }

        .list-view-expand-btn > svg { transition: transform 0.2s; }
        .list-view-row.expanded .list-view-expand-btn > svg { transform: rotate(90deg); }

        .subtasks-container-in-list {
            background-color: #f9fafb;
        }
        .dark .subtasks-container-in-list {
            background-color: #1a2438;
        }
        .subtasks-container-in-list .subtask-checkbox-list:checked + span {
             text-decoration: line-through;
             color: #6b7280;
        }
        .dark .subtasks-container-in-list .subtask-checkbox-list:checked + span {
             color: #4b5563;
        }
        
        /* Subtask in board view */
        .subtasks-board-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .subtasks-board-container.expanded {
            max-height: 200px; /* Adjust as needed */
        }
        .subtask-checkbox-board:checked + span {
             text-decoration: line-through;
             color: #9ca3af;
        }
        .dark .subtask-checkbox-board:checked + span {
             color: #4b5563;
        }
        .expand-subtasks-btn svg {
            transition: transform 0.2s;
        }
        .expand-subtasks-btn.expanded svg {
            transform: rotate(90deg);
        }
        
        /* Calendar View */
        .time-slot-grid {
             background-image: linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
             background-size: 100% 60px; /* 60px per hour */
        }
        .dark .time-slot-grid {
             background-image: linear-gradient(to bottom, #334155 1px, transparent 1px);
        }
        .time-slot {
            position: relative;
            height: 60px; /* Corresponds to background-size */
            cursor: pointer;
        }
        .time-slot:hover {
             background-color: rgba(59, 130, 246, 0.05);
        }
       
        .calendar-task-item {
            position: absolute;
            left: 4.5rem; /* width of time label */
            right: 0.5rem;
            background-color: #bfdbfe;
            border-left: 4px solid #3b82f6;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 13px;
            cursor: grab;
            overflow: hidden;
            z-index: 10;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
         .dark .calendar-task-item {
            background-color: #1e3a8a;
             box-shadow: 0 2px 5px rgba(0,0,0,0.4);
        }
        .calendar-task-item.dragging {
            opacity: 0.7;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            z-index: 20;
        }
        .all-day-task-item {
             background-color: #dbeafe;
             padding: 4px 8px;
             border-radius: 6px;
             cursor: pointer;
        }
        .dark .all-day-task-item {
            background-color: #1e40af;
        }
        .calendar-month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            height: 100%;
        }
        .calendar-day-cell {
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            padding: 8px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dark .calendar-day-cell {
             border-right-color: #334155;
             border-bottom-color: #334155;
        }
        .calendar-day-cell:nth-child(7n) { border-right: none; }
        .calendar-day-cell.other-month { background-color: #f9fafb; color: #9ca3af; }
        .dark .calendar-day-cell.other-month { background-color: #1a2438; color: #6b7280; }
        .calendar-day-cell.is-today { background-color: #eff6ff; }
        .dark .calendar-day-cell.is-today { background-color: #1e3a8a; }
        .calendar-day-cell:hover { background-color: #f0f9ff; }
        .dark .calendar-day-cell:hover { background-color: #172554; }
        .month-task-item {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg font-sans text-gray-800 dark:text-dark-text-primary">
    
    <div id="mobile-menu-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

    <div class="flex min-h-screen">
        <aside class="bg-white dark:bg-dark-surface p-4 flex flex-col items-center shadow-xl fixed h-full z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out w-64 md:w-20">
            <div id="desktop-logo" class="text-blue-600 dark:text-blue-400 font-extrabold text-3xl hidden md:block">R</div>
            <div id="mobile-logo" class="text-blue-600 dark:text-blue-400 font-extrabold text-xl md:hidden">Reputifly</div>
            <nav class="flex flex-col items-start md:items-center space-y-6 flex-grow mt-8 w-full px-4 md:px-0">
                <a href="#" data-page="dashboard" class="sidebar-link p-3 rounded-lg flex items-center gap-4 md:gap-0 w-full" title="Analytics">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 13h18"/><path d="M16 3v18"/></svg>
                    <span class="md:hidden">Analytics</span>
                </a>
                 <a href="#" data-page="tasks" class="sidebar-link p-3 rounded-lg flex items-center gap-4 md:gap-0 w-full" title="Tasks">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1" /><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><path d="m9 12 2 2 4-4" /></svg>
                    <span class="md:hidden">Tasks</span>
                </a>
            </nav>
            <div id="theme-toggle" class="p-3 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700/50 rounded-lg cursor-pointer" title="Toggle Theme"></div>
        </aside>

        <main class="flex-1 p-4 sm:p-6 lg:p-8 md:ml-20 w-full">
             <header class="md:hidden flex justify-between items-center mb-4">
                 <button id="hamburger-menu-button" class="p-2 text-gray-500">
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
                <div class="text-blue-600 dark:text-blue-400 font-extrabold text-2xl">Reputifly</div>
                <div id="mobile-theme-toggle" class="p-3 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700/50 rounded-lg cursor-pointer"></div>
            </header>

            <div id="dashboard-page" class="page-view">
                <header class="flex flex-col md:flex-row md:justify-between items-start md:items-center gap-4 mb-8">
                    <div class="w-full md:w-auto">
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-dark-text-primary">Financial Analytics</h1>
                        <p class="text-sm md:text-base text-gray-500 dark:text-dark-text-secondary">Dashboard / Financials</p>
                    </div>
                    <div class="flex flex-col sm:flex-row flex-wrap items-center justify-start gap-2 w-full md:w-auto md:justify-end">
                        <div id="date-presets-container" class="flex items-center bg-gray-100 dark:bg-dark-surface rounded-lg p-1 text-sm font-semibold text-gray-600 dark:text-dark-text-secondary w-full justify-around md:w-auto">
                            <button data-range="day" class="date-preset-btn px-3 py-1.5 rounded-md transition-colors">Daily</button>
                            <button data-range="week" class="date-preset-btn px-3 py-1.5 rounded-md transition-colors">Weekly</button>
                            <button data-range="month" class="date-preset-btn px-3 py-1.5 rounded-md transition-colors">Monthly</button>
                        </div>
                        <input id="date-range-picker" class="bg-white text-gray-800 dark:bg-slate-700 dark:text-white px-4 py-2 rounded-lg shadow-sm font-semibold text-sm focus:ring-2 focus:ring-blue-500 border border-gray-200 dark:border-dark-border w-full md:w-auto" placeholder="Select Date Range">
                        <div class="flex gap-2 w-full sm:w-auto">
                            <input type="file" id="import-file-input" class="hidden" accept=".json">
                            <button id="import-data-button" class="bg-white text-gray-800 dark:bg-slate-800 dark:text-white px-4 py-2 rounded-lg shadow-sm hover:bg-gray-100 dark:hover:bg-slate-600 font-semibold flex items-center justify-center gap-2 text-sm border border-gray-200 dark:border-dark-border flex-grow sm:flex-grow-0">Import</button>
                            <button id="export-data-button" class="bg-white text-gray-800 dark:bg-slate-800 dark:text-white px-4 py-2 rounded-lg shadow-sm hover:bg-gray-100 dark:hover:bg-slate-600 font-semibold flex items-center justify-center gap-2 text-sm border border-gray-200 dark:border-dark-border flex-grow sm:flex-grow-0">Export</button>
                        </div>
                        <button id="add-entry-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 font-semibold items-center gap-2 text-sm w-full md:w-auto hidden md:flex"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Add Transaction</button>
                    </div>
                </header>
                
                <div id="loader" class="flex justify-center items-center h-64"><div class="loader h-16 w-16 border-4 border-gray-200 dark:border-gray-700 rounded-full"></div></div>
                
                <div id="dashboard-content" class="space-y-8 hidden">
                    <div id="kpi-card-container" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6"></div>

                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                        <div id="revenue-by-sector-container" class="dashboard-card xl:col-span-1 bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border flex flex-col">
                            <div class="flex flex-wrap justify-between items-center gap-4 mb-2">
                                 <h2 class="text-xl font-bold">Revenue by Sector</h2>
                            </div>
                            <div id="sector-legend-container" class="flex flex-wrap items-center justify-center gap-x-4 gap-y-2 mb-4 text-sm"></div>
                            <div id="sector-chart-wrapper" class="flex-grow relative min-h-[300px]">
                                <canvas id="revenue-by-sector-chart"></canvas>
                            </div>
                            <div id="sector-chart-no-data" class="flex-grow flex flex-col justify-center items-center text-center min-h-[300px] hidden">
                                <p class="text-gray-500 dark:text-dark-text-secondary px-4">Add a 'sector' to a revenue transaction to see data here.</p>
                            </div>
                        </div>

                        <div class="dashboard-card xl:col-span-2 bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
                            <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                                <h2 class="text-xl font-bold">Revenue Statistics</h2>
                            </div>
                            <div class="h-80 relative"><canvas id="revenue-line-chart"></canvas></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                         <div class="dashboard-card lg:col-span-1 bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
                             <h2 class="text-xl font-bold mb-4">Revenue Breakdown</h2>
                             <div class="grid grid-cols-2 gap-x-4">
                                <div class="col-span-1 text-center">
                                    <h3 class="text-md font-bold mb-2">By Source</h3>
                                    <div class="h-40 w-full relative"><canvas id="source-pie-chart"></canvas></div>
                                </div>
                                <div class="col-span-1 text-center">
                                     <h3 class="text-md font-bold mb-2">By Business</h3>
                                    <div class="h-40 w-full relative"><canvas id="business-pie-chart"></canvas></div>
                                </div>
                             </div>
                             <div id="business-breakdown-container" class="col-span-2 mt-4 pt-4 border-t border-gray-200 dark:border-dark-border"></div>
                        </div>
                        <div class="dashboard-card lg:col-span-2 bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
                            <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                                 <h2 class="text-xl font-bold">Daily Sales Activity</h2>
                            </div>
                            <div class="h-[280px] relative"><canvas id="daily-sales-bar-chart"></canvas></div>
                        </div>
                    </div>

                    <div id="transaction-table-container" class="dashboard-card bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border"></div>
                </div>
            </div>
            
            <div id="tasks-page" class="page-view">
                 <header class="flex flex-wrap justify-between items-center gap-4 mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-dark-text-primary">Task Manager</h1>
                        <p class="text-gray-500 dark:text-dark-text-secondary">Dashboard / Tasks</p>
                    </div>
                    <div class="flex items-center flex-wrap gap-4">
                        <div id="task-view-switcher" class="flex items-center bg-gray-200 dark:bg-dark-surface rounded-lg p-1 text-sm font-semibold text-gray-600 dark:text-dark-text-secondary">
                            <button data-view="board" class="task-view-btn px-3 py-1.5 rounded-md">Board</button>
                            <button data-view="list" class="task-view-btn px-3 py-1.5 rounded-md">List</button>
                            <button data-view="calendar" class="task-view-btn px-3 py-1.5 rounded-md">Calendar</button>
                            <button data-view="analytics" class="task-view-btn px-3 py-1.5 rounded-md">Analytics</button>
                        </div>
                         <div class="flex gap-2">
                            <input type="file" id="import-tasks-input" class="hidden" accept=".json">
                            <button id="import-tasks-button" class="bg-white text-gray-800 dark:bg-slate-800 dark:text-white px-3 py-2 rounded-lg shadow-sm hover:bg-gray-100 dark:hover:bg-slate-600 font-semibold flex items-center justify-center gap-2 text-sm border border-gray-200 dark:border-dark-border">Import Tasks</button>
                            <button id="export-tasks-button" class="bg-white text-gray-800 dark:bg-slate-800 dark:text-white px-3 py-2 rounded-lg shadow-sm hover:bg-gray-100 dark:hover:bg-slate-600 font-semibold flex items-center justify-center gap-2 text-sm border border-gray-200 dark:border-dark-border">Export Tasks</button>
                        </div>
                        <button id="add-task-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-700 font-semibold flex items-center gap-2 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>Add Task
                        </button>
                    </div>
                </header>
                <div id="tasks-content"></div>
            </div>

            <button id="mobile-add-entry-button" class="md:hidden fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg z-20 hover:bg-blue-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
        </main>
    </div>

    <div id="add-entry-modal" class="modal fixed inset-0 bg-black/70 justify-center items-center z-50 p-4">
        <div class="modal-content bg-white dark:bg-dark-surface rounded-xl shadow-2xl w-full max-w-lg border border-gray-200 dark:border-dark-border flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-dark-border flex-shrink-0">
                <h2 class="text-2xl font-bold">New Transaction</h2>
                <button id="modal-close-button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="modal-error" class="bg-red-500/10 text-red-500 p-3 rounded-md mb-4 hidden font-medium"></div>
                <div class="flex items-center bg-gray-100 dark:bg-slate-800 rounded-lg p-1 space-x-1 mb-6">
                    <button class="switcher-btn flex-1" data-type="revenue">Revenue</button>
                    <button class="switcher-btn flex-1" data-type="expense">Expense</button>
                </div>
                <form id="add-entry-form" class="space-y-4"></form>
            </div>
        </div>
    </div>
    
    <div id="task-detail-modal" class="modal fixed inset-0 bg-black/70 justify-center items-center z-50 p-4">
        <div class="modal-content bg-white dark:bg-dark-surface rounded-xl shadow-2xl w-full max-w-5xl border border-gray-200 dark:border-dark-border flex flex-col max-h-[95vh]">
             <div class="flex justify-between items-center p-5 border-b border-gray-200 dark:border-dark-border">
                <h2 class="text-2xl font-bold">Task Details</h2>
                <button id="task-modal-close-button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="task-modal-body" class="p-6 overflow-y-auto"></div>
             <div class="flex justify-between items-center p-4 border-t border-gray-200 dark:border-dark-border bg-gray-50 dark:bg-dark-surface/50 rounded-b-xl">
                 <div class="flex items-center gap-2">
                    <button id="delete-task-button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm">Delete Task</button>
                    <button id="unarchive-task-button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold text-sm hidden">Unarchive</button>
                 </div>
                <div id="task-modal-session-timer-display" class="text-lg font-bold text-blue-600 dark:text-blue-400"></div>
            </div>
        </div>
    </div>


    <div id="delete-modal" class="modal fixed inset-0 bg-black/70 justify-center items-center z-50 p-4">
        <div class="modal-content bg-white dark:bg-dark-surface rounded-xl shadow-2xl p-8 w-full max-w-md text-center border border-gray-200 dark:border-dark-border">
            <h3 class="text-xl font-bold mb-4">Confirm Deletion</h3>
            <p class="dark:text-dark-text-secondary mb-8">This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button type="button" id="delete-cancel-button" class="w-full px-4 py-2.5 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 dark:bg-dark-border dark:text-dark-text-primary dark:hover:bg-gray-600 font-semibold">Cancel</button>
                <button type="button" id="delete-confirm-button" class="w-full px-4 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold">Delete</button>
            </div>
        </div>
    </div>
        
    <div id="move-task-modal" class="modal fixed inset-0 bg-black/70 justify-center items-center z-50 p-4">
        <div class="modal-content bg-white dark:bg-dark-surface rounded-xl shadow-2xl p-6 w-full max-w-xs text-center border border-gray-200 dark:border-dark-border">
            <h3 class="text-lg font-bold mb-4">Move Task To...</h3>
            <div id="move-task-options" class="flex flex-col space-y-2"></div>
            <button type="button" id="move-task-cancel-button" class="mt-6 w-full px-4 py-2.5 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 dark:bg-dark-border dark:text-dark-text-primary dark:hover:bg-gray-600 font-semibold">Cancel</button>
        </div>
    </div>

    <datalist id="tags-datalist"></datalist>

    <script>
    (() => {
        // To hold instances and timers globally within this IIFE
        let pickerInstance = null;
        let draggedTaskId = null; // For board view drag-and-drop
        let calendarDraggedTaskId = null; // For calendar view drag-and-drop
        
        // Destructure date-fns functions for easy access
        const { parseISO, format, startOfMonth, endOfMonth, startOfWeek, endOfWeek, startOfDay, endOfDay, eachDayOfInterval, eachWeekOfInterval, eachMonthOfInterval, subDays, addDays, isSameMonth, isSameDay, addMonths, addWeeks, getDaysInMonth, getDay, formatDuration, intervalToDuration, isToday, isTomorrow, isWithinInterval, differenceInHours, isBefore, set, getHours, getMinutes, addMinutes, roundToNearestMinutes } = dateFns;

        // --- Data Model: Sub-tasks are now more complex objects
        const initialTasks = [
            { 
                id: 'task-1', title: 'Design new homepage mockup', status: 'In Progress', priority: 'High', projectId: 'proj-1', tags: ['client-review', 'design'], 
                subtasks: [
                    {id: 'sub-1', title: 'Create wireframe in Figma', done: true, description: 'Focus on mobile-first layout.'}, 
                    {id: 'sub-2', title: 'Choose color palette', done: false, description: 'Get feedback from the client on the proposed palettes.'}
                ], 
                dueDate: '2025-07-15T14:00:00Z', createdAt: '2025-06-25T09:00:00Z', timeLog: [{start: '2025-06-28T10:00:00Z', end: '2025-06-28T11:30:00Z'}], description: 'Detailed description about the homepage mockup requirements.', timeEstimate: 240, completedAt: null 
            },
            { id: 'task-2', title: 'Draft blog post for launch', status: 'To Do', priority: 'Medium', projectId: 'proj-2', tags: ['marketing', 'writing'], subtasks: [], dueDate: '2025-07-03T10:30:00Z', createdAt: '2025-06-26T14:00:00Z', timeLog: [], description: '', timeEstimate: 120, completedAt: null },
            { id: 'task-3', title: 'Fix login button CSS', status: 'In Progress', priority: 'High', projectId: 'proj-1', tags: ['bug', 'css'], subtasks: [], dueDate: '2025-06-29T17:00:00Z', createdAt: '2025-06-28T11:00:00Z', timeLog: [{start: '2025-06-28T15:00:00Z', end: '2025-06-28T16:15:00Z'}], description: 'The login button is misaligned on mobile devices.', timeEstimate: 60, completedAt: null },
            { id: 'task-4', title: 'Setup marketing email sequence', status: 'Done', priority: 'Low', projectId: 'proj-2', tags: ['marketing'], subtasks: [], dueDate: '2025-06-20T12:00:00Z', createdAt: '2025-06-18T16:00:00Z', timeLog: [{start: '2025-06-19T10:00:00Z', end: '2025-06-19T12:00:00Z'}], description: '', timeEstimate: 180, completedAt: '2025-06-20T12:00:00Z' },
            { id: 'task-5', title: 'Develop user authentication', status: 'To Do', priority: 'High', projectId: 'proj-1', tags: ['dev'], subtasks: [], dueDate: '2025-07-10T09:00:00Z', createdAt: '2025-06-27T10:00:00Z', timeLog: [], description: '', timeEstimate: 480, completedAt: null },
            { id: 'task-today', title: 'Follow up with leads', status: 'To Do', priority: 'Medium', projectId: 'proj-2', tags: ['sales'], subtasks: [], dueDate: set(new Date(), { hours: 11, minutes: 0, seconds: 0, milliseconds: 0 }).toISOString(), createdAt: '2025-06-28T09:30:00Z', timeLog: [], description: '', timeEstimate: 90, completedAt: null },
            { id: 'task-tomorrow', title: 'Prepare for weekly meeting', status: 'To Do', priority: 'Medium', projectId: 'proj-1', tags: [], subtasks: [], dueDate: set(addDays(new Date(), 1), { hours: 15, minutes: 0, seconds: 0, milliseconds: 0 }).toISOString(), createdAt: '2025-06-28T13:00:00Z', timeLog: [], description: '', timeEstimate: 60, completedAt: null },
            { id: 'task-archived', title: 'Review Q2 Financials', status: 'Archived', priority: 'Medium', projectId: 'proj-1', tags: ['finance'], subtasks: [], dueDate: '2025-06-15T12:00:00Z', createdAt: '2025-06-10T10:00:00Z', timeLog: [], description: '', timeEstimate: 120, completedAt: '2025-06-15T11:00:00Z' }
        ];
        
        const initialProjects = [
            { id: 'proj-1', name: 'Web Design Fulfillment' },
            { id: 'proj-2', name: 'Marketing Funnel' },
        ];

        const initialData = [
            { id: '7', itemName: 'Ritesh', business: 'Google Reviews', date: '2025-06-28', type: 'revenue', sector: 'Marketing', customerSource: 'Google Ads', fulfillmentExpense: 1200, status: 'Recurring', amount: 3400 },
            { id: '1', itemName: 'Alice Johnson', business: 'Web Design', date: '2025-06-26', type: 'revenue', sector: 'Services', customerSource: 'Referral', fulfillmentExpense: 300, status: 'Recurring', amount: 1500 },
        ];
        
        // --- Application State ---
        const state = {
            entries: [],
            tasks: [],
            projects: [],
            theme: 'light',
            itemToDelete: null,
            taskToDelete: null,
            activeSessionTimer: null,
            ui: {
                activePage: 'tasks',
                activeTableTab: 'all',
                activeTaskView: 'board',
                activeCalendarView: 'month',
                todoFilter: 'all',
                currentCalendarDate: new Date(),
                dateRange: { start: startOfMonth(new Date()), end: endOfMonth(new Date()) },
                sort: { key: 'date', order: 'desc' }, 
                taskSort: { key: 'dueDate', order: 'asc' },
                taskSearchQuery: '', 
                activeTaskStatusFilter: 'all',
                showArchived: false,
                searchQuery: '',
                activeModalForm: 'revenue',
                activeDatePreset: 'month',
                expandedSubtasks: {}, 
                expandedListTasks: {},
                expandedBoardTasks: {},
            },
            chartInstances: {},
        };

        // --- DOM Element References ---
        const DOMElements = {
            html: document.documentElement,
            loader: document.getElementById('loader'),
            dashboardContent: document.getElementById('dashboard-content'),
            themeToggle: document.getElementById('theme-toggle'), 
            transactionTableContainer: document.getElementById('transaction-table-container'),
            businessBreakdownContainer: document.getElementById('business-breakdown-container'), 
            addEntryButton: document.getElementById('add-entry-button'),
            tagsDataList: document.getElementById('tags-datalist'),
            pages: {
                dashboard: document.getElementById('dashboard-page'),
                tasks: document.getElementById('tasks-page'),
            },
            sidebar: document.querySelector('aside'),
            sidebarLinks: document.querySelectorAll('.sidebar-link'),
            mobileMenu: {
                button: document.getElementById('hamburger-menu-button'),
                overlay: document.getElementById('mobile-menu-overlay'),
                mobileThemeToggle: document.getElementById('mobile-theme-toggle'),
                mobileAddEntryButton: document.getElementById('mobile-add-entry-button'),
            },
            dateRangePicker: document.getElementById('date-range-picker'),
            datePresetsContainer: document.getElementById('date-presets-container'),
            kpiCardContainer: document.getElementById('kpi-card-container'),
            sectorChart: {
                wrapper: document.getElementById('sector-chart-wrapper'),
                noData: document.getElementById('sector-chart-no-data'),
                legendContainer: document.getElementById('sector-legend-container')
            },
            addEntryModal: {
                modal: document.getElementById('add-entry-modal'),
                form: document.getElementById('add-entry-form'),
                closeButton: document.getElementById('modal-close-button'),
                error: document.getElementById('modal-error'),
                typeButtons: document.querySelectorAll('#add-entry-modal .switcher-btn'),
            },
            deleteModal: {
                modal: document.getElementById('delete-modal'),
                confirmButton: document.getElementById('delete-confirm-button'),
                cancelButton: document.getElementById('delete-cancel-button'),
            },
            moveTaskModal: {
                 modal: document.getElementById('move-task-modal'),
                 optionsContainer: document.getElementById('move-task-options'),
                 cancelButton: document.getElementById('move-task-cancel-button'),
            },
            importData: {
                button: document.getElementById('import-data-button'),
                input: document.getElementById('import-file-input'),
            },
            exportDataButton: document.getElementById('export-data-button'),
            tasks: {
                content: document.getElementById('tasks-content'),
                viewSwitcher: document.getElementById('task-view-switcher'),
                addTaskButton: document.getElementById('add-task-button'),
                importTasksButton: document.getElementById('import-tasks-button'),
                importTasksInput: document.getElementById('import-tasks-input'),
                exportTasksButton: document.getElementById('export-tasks-button'),
                detailModal: document.getElementById('task-detail-modal'),
                detailModalBody: document.getElementById('task-modal-body'),
                detailModalClose: document.getElementById('task-modal-close-button'),
                deleteTaskButton: document.getElementById('delete-task-button'),
                unarchiveTaskButton: document.getElementById('unarchive-task-button'),
                sessionTimerDisplay: document.getElementById('task-modal-session-timer-display'),
            }
        };

        // --- Utility Functions ---
        const formatCurrency = (v) => `$${(v || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        const formatPercent = (v) => `${(v * 100).toFixed(1)}%`;
        const formatTimeEstimate = (minutes) => {
            if (!minutes && minutes !== 0) return 'N/A';
            if (minutes <= 0) return '0m';
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            let result = '';
            if (h > 0) result += `${h}h `;
            if (m > 0) result += `${m}m`;
            return result.trim() || '0m';
        };
        const formatHours = (ms) => {
             if (ms <= 0) return '0h 0m';
             const totalMinutes = ms / (1000 * 60);
             const hours = Math.floor(totalMinutes / 60);
             const minutes = Math.round(totalMinutes % 60);
             return `${hours}h ${minutes}m`;
        };
        
        const getTagColor = (tagName) => {
            const colors = [
                { bg: '#fee2e2', text: '#b91c1c', border: 'border-red-500' }, 
                { bg: '#ffedd5', text: '#c2410c', border: 'border-orange-500' }, 
                { bg: '#fef9c3', text: '#a16207', border: 'border-yellow-500' },
                { bg: '#dcfce7', text: '#166534', border: 'border-green-500' }, 
                { bg: '#dbeafe', text: '#1d4ed8', border: 'border-blue-500' }, 
                { bg: '#e0e7ff', text: '#4338ca', border: 'border-indigo-500' },
                { bg: '#f3e8ff', text: '#7e22ce', border: 'border-purple-500' }, 
                { bg: '#fae8ff', text: '#a21caf', border: 'border-fuchsia-500' }, 
                { bg: '#ffe4e6', text: '#be123c', border: 'border-pink-500' }
            ];
            let hash = 0;
            if (!tagName) return colors[0];
            for (let i = 0; i < tagName.length; i++) {
                hash = tagName.charCodeAt(i) + ((hash << 5) - hash);
            }
            return colors[Math.abs(hash % colors.length)];
        };

        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        };
        
        // --- State Management (LocalStorage) ---
        const saveState = () => {
            try {
                const stateToSave = {
                    entries: state.entries.map(({dateObj, ...rest}) => rest),
                    tasks: state.tasks,
                    projects: state.projects,
                    theme: state.theme,
                };
                localStorage.setItem('dashboardState-v27', JSON.stringify(stateToSave));
                localStorage.setItem('lastRecurringCheck-v27', new Date().toISOString());
            } catch (error) {
                console.error("Failed to save state to localStorage:", error);
            }
        };

        const loadState = () => {
            const savedStateJSON = localStorage.getItem('dashboardState-v27');
            
            if (savedStateJSON) {
                const savedState = JSON.parse(savedStateJSON);
                state.entries = (savedState.entries || initialData).map(e => ({...e, dateObj: parseISO(e.date)}));
                state.tasks = (savedState.tasks || initialTasks).map(t => ({...t, createdAt: t.createdAt || new Date().toISOString()}));
                state.projects = savedState.projects || initialProjects;
                state.theme = savedState.theme || 'light';
            } else {
                 state.entries = initialData.map(e => ({...e, dateObj: parseISO(e.date)}));
                state.tasks = initialTasks.map(t => ({...t, createdAt: t.createdAt || new Date().toISOString()}));
                state.projects = initialProjects;
                state.theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
        };
        
        // --- Charting ---
        const chartStyler = {
            grid: () => state.theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)',
            labels: () => state.theme === 'dark' ? '#94A3B8' : '#64748b',
            legend: () => state.theme === 'dark' ? '#F8FAFC' : '#334155',
            sectorColors: ['#6366f1', '#ec4899', '#f97316', '#22c55e', '#facc15', '#38bdf8', '#8b5cf6', '#ef4444'],
            priorityColors: {'High': '#ef4444', 'Medium': '#f97316', 'Low': '#22c55e'},
            getColor: function(index) { return this.sectorColors[index % this.sectorColors.length]; },
        };

        const renderChart = (id, config) => {
            const ctx = document.getElementById(id)?.getContext('2d');
            if (!ctx) return;
            if (state.chartInstances[id]) state.chartInstances[id].destroy();
            state.chartInstances[id] = new Chart(ctx, config);
        };
        
        const renderAllCharts = (filteredData) => {
            renderMainRevenueChart(filteredData);
            renderDailySalesBarChart(filteredData);
            renderRevenueBySectorChart(filteredData);
            renderSourcePieChart(filteredData);
            renderBusinessPieChart(filteredData);
        };

        const renderMainRevenueChart = (data) => {
             const getGroupedData = () => {
                if (!data.length) return { labels: [], revenue: [], expenses: [] };
                
                const sorted = [...data].sort((a, b) => a.dateObj - b.dateObj);
                
                const daysInRange = (state.ui.dateRange.end - state.ui.dateRange.start) / (1000 * 60 * 60 * 24);
                let interval, fmt, periodFn;
                
                if (daysInRange < 0) return { labels: [], revenue: [], expenses: [] };
                if (daysInRange <= 31) { // Daily
                     interval = eachDayOfInterval({start:state.ui.dateRange.start, end:state.ui.dateRange.end}); 
                     fmt = 'MMM d'; periodFn = (d) => d;
                } else if (daysInRange <= 180) { // Weekly
                    interval = eachWeekOfInterval({start:state.ui.dateRange.start, end:state.ui.dateRange.end},{weekStartsOn:1}); 
                    fmt = "'Wk' w, yy"; periodFn = (d) => startOfWeek(d, {weekStartsOn:1});
                } else { // Monthly
                    interval = eachMonthOfInterval({start:state.ui.dateRange.start, end:state.ui.dateRange.end}); 
                    fmt = 'MMM yy'; periodFn = startOfMonth;
                }

                const map = new Map(interval.map(d => [format(d, fmt), { revenue: 0, expenses: 0 }]));
                for (const entry of sorted) {
                    const key = format(periodFn(entry.dateObj), fmt);
                    if (map.has(key)) {
                        const periodData = map.get(key);
                        if (entry.type === 'revenue') {
                            periodData.revenue += entry.amount;
                            periodData.expenses += (entry.fulfillmentExpense || 0);
                        } else {
                            periodData.expenses += entry.amount;
                        }
                    }
                }
                return { labels: [...map.keys()], revenue: [...map.values()].map(v => v.revenue), expenses: [...map.values()].map(v => v.expenses) };
            };
            const { labels, revenue, expenses } = getGroupedData();
            renderChart('revenue-line-chart', { type: 'line', data: { labels, datasets: [ { label: 'Revenue', data: revenue, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 6 }, { label: 'Expenses', data: expenses, borderColor: '#ec4899', backgroundColor: 'rgba(236, 72, 153, 0.1)', fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 6 } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: chartStyler.labels(), callback: v => `$${v/1000}k` }, grid: { color: chartStyler.grid() }, border: { dash: [4, 4] } }, x: { ticks: { color: chartStyler.labels() }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } } } });
        };
        
        const renderDailySalesBarChart = (data) => {
            const recentEntries = data.filter(e => e.type === 'revenue');
            
            const salesByDay = recentEntries.reduce((acc, e) => {
                const day = format(e.dateObj, 'MMM d');
                acc[day] = (acc[day] || 0) + e.amount;
                return acc;
            }, {});

            const labels = Object.keys(salesByDay);
            const salesData = Object.values(salesByDay);
            renderChart('daily-sales-bar-chart', { type: 'bar', data: { labels, datasets: [{ label: 'Sales', data: salesData, backgroundColor: '#818cf8', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: chartStyler.labels() }, grid: { color: chartStyler.grid() } }, x: { ticks: { color: chartStyler.labels() }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.dataset.label}: ${formatCurrency(c.raw)}` } } } } });
        };

        const renderRevenueBySectorChart = (data) => {
            const revenueEntriesWithSector = data.filter(e => e.type === 'revenue' && e.sector && e.sector.trim() !== '');
            const chartId = 'revenue-by-sector-chart';
            const chartInstance = state.chartInstances[chartId];

            if (revenueEntriesWithSector.length === 0) {
                DOMElements.sectorChart.wrapper.classList.add('hidden');
                DOMElements.sectorChart.legendContainer.classList.add('hidden');
                DOMElements.sectorChart.noData.classList.remove('hidden');
                if (chartInstance) {
                    chartInstance.destroy();
                    delete state.chartInstances[chartId];
                }
                return;
            }
            
            DOMElements.sectorChart.wrapper.classList.remove('hidden');
            DOMElements.sectorChart.legendContainer.classList.remove('hidden');
            DOMElements.sectorChart.noData.classList.add('hidden');

            const sectors = [...new Set(revenueEntriesWithSector.map(e => e.sector))].sort();
            const sectorColorMap = new Map(sectors.map((s, i) => [s, chartStyler.getColor(i)]));

            const daysInRange = (state.ui.dateRange.end - state.ui.dateRange.start) / (1000 * 60 * 60 * 24);
            let interval, fmt, periodFn;

            if (daysInRange < 0) return;
            if (daysInRange <= 31) { // Daily
                 interval = eachDayOfInterval({start:state.ui.dateRange.start, end:state.ui.dateRange.end}); 
                 fmt = 'MMM d'; periodFn = (d) => d;
            } else if (daysInRange <= 180) { // Weekly
                interval = eachWeekOfInterval({start:state.ui.dateRange.start, end:state.ui.dateRange.end},{weekStartsOn:1}); 
                fmt = "'Wk' w, yy"; periodFn = (d) => startOfWeek(d, {weekStartsOn:1});
            } else { // Monthly
                interval = eachMonthOfInterval({start:state.ui.dateRange.start, end:state.ui.dateRange.end}); 
                fmt = 'MMM yy'; periodFn = startOfMonth;
            }
            
            const labels = interval.map(d => format(d, fmt));
            const groupedData = new Map(labels.map(l => [l, new Map(sectors.map(s => [s, {revenue: 0, profit: 0}]))]));
            
            for (const entry of revenueEntriesWithSector) {
                const key = format(periodFn(entry.dateObj), fmt);
                if (groupedData.has(key) && entry.sector) {
                    const periodMap = groupedData.get(key);
                    if (periodMap.has(entry.sector)) {
                        const sectorData = periodMap.get(entry.sector);
                        sectorData.revenue += entry.amount;
                        sectorData.profit += (entry.amount - (entry.fulfillmentExpense || 0));
                    }
                }
            }
            
            const datasets = sectors.map(sector => {
                const data = [];
                const customData = [];
                labels.forEach(label => {
                    const dataPoint = groupedData.get(label)?.get(sector);
                    const revenue = dataPoint?.revenue || 0;
                    const profit = dataPoint?.profit || 0;
                    const margin = revenue > 0 ? profit / revenue : 0;
                    data.push(revenue);
                    customData.push({ profit, margin });
                });

                return {
                    label: sector,
                    data: data,
                    customData: customData,
                    backgroundColor: sectorColorMap.get(sector),
                    borderRadius: 2,
                    barPercentage: 0.7,
                    categoryPercentage: 0.8
                }
            });

            const legendContainer = DOMElements.sectorChart.legendContainer;
            legendContainer.innerHTML = '';
            datasets.forEach((dataset, index) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item flex items-center gap-2';
                legendItem.innerHTML = `<span class="w-3 h-3 rounded-full" style="background-color: ${dataset.backgroundColor}"></span><span>${dataset.label}</span>`;
                
                legendItem.onclick = () => {
                    const chart = state.chartInstances[chartId];
                    if (chart) {
                        const meta = chart.getDatasetMeta(index);
                        meta.hidden = meta.hidden === true ? false : true;
                        legendItem.classList.toggle('hidden-dataset', meta.hidden);
                        chart.update();
                    }
                };
                legendContainer.appendChild(legendItem);
            });

            renderChart(chartId, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, ticks: { color: chartStyler.labels(), maxRotation: 0, autoSkip: true, maxTicksLimit: 7 }, grid: { display: false } },
                        y: { stacked: true, ticks: { color: chartStyler.labels(), callback: v => `$${v/1000}k` }, grid: { color: chartStyler.grid() } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const revenue = context.parsed.y || 0;
                                    const customInfo = context.dataset.customData[context.dataIndex];
                                    
                                    if (!customInfo) {
                                        return `${label}: ${formatCurrency(revenue)}`;
                                    }

                                    const { profit, margin } = customInfo;
                                    
                                    return [
                                        `${label}: ${formatCurrency(revenue)}`,
                                        `Profit: ${formatCurrency(profit)}`,
                                        `Margin: ${formatPercent(margin)}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        };

        const createPieChartConfig = (dataMap) => ({
            type: 'doughnut',
            data: { labels: [...dataMap.keys()], datasets: [{ data: [...dataMap.values()], backgroundColor: chartStyler.sectorColors, borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.label}: ${formatCurrency(c.raw)}` } } } }
        });

        const renderSourcePieChart = (data) => {
            const sourceMap = data.filter(e => e.type === 'revenue' && e.customerSource && e.customerSource !== 'N/A').reduce((acc, e) => acc.set(e.customerSource, (acc.get(e.customerSource) || 0) + e.amount), new Map());
            renderChart('source-pie-chart', createPieChartConfig(sourceMap));
        };
        
        const renderBusinessPieChart = (data) => {
            const businessMap = data.filter(e => e.type === 'revenue' && e.business).reduce((acc, e) => acc.set(e.business, (acc.get(e.business) || 0) + e.amount), new Map());
            renderChart('business-pie-chart', createPieChartConfig(businessMap));
        };

        const renderKpiCards = (data) => {
            const revenueEntries = data.filter(e => e.type === 'revenue');
            const expenseEntries = data.filter(e => e.type === 'expense');

            const totalRevenue = revenueEntries.reduce((sum, e) => sum + e.amount, 0);
            const fulfillmentCosts = revenueEntries.reduce((sum, e) => sum + (e.fulfillmentExpense || 0), 0);
            const totalExpenses = expenseEntries.reduce((sum, e) => sum + e.amount, 0) + fulfillmentCosts;
            const netProfit = totalRevenue - totalExpenses;
            const newCustomers = new Set(revenueEntries.filter(e => e.status === 'New Customer').map(e => e.itemName)).size;
            
            const kpis = [
                { label: 'Total Revenue', value: formatCurrency(totalRevenue), icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>' },
                { label: 'Net Profit', value: formatCurrency(netProfit), icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>' },
                { label: 'Total Expenses', value: formatCurrency(totalExpenses), icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="16" height="16" x="4" y="4" rx="2"/><path d="M9 12h6"/></svg>' },
                { label: 'New Customers', value: newCustomers, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>' },
            ];

            DOMElements.kpiCardContainer.innerHTML = kpis.map(kpi => `
                <div class="dashboard-card bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border flex items-start gap-4">
                    <div class="bg-blue-100 dark:bg-blue-500/20 text-blue-600 dark:text-blue-400 p-3 rounded-lg">${kpi.icon}</div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-dark-text-secondary">${kpi.label}</p>
                        <p class="text-2xl font-bold">${kpi.value}</p>
                    </div>
                </div>
            `).join('');
        };
        
        const renderDashboard = () => {
            const { start, end } = state.ui.dateRange;
            const filteredData = state.entries.filter(e => {
                const entryDate = e.dateObj;
                return entryDate >= start && entryDate <= end;
            });
            
            renderKpiCards(filteredData);
            renderAllCharts(filteredData);
            renderBusinessBreakdown(filteredData);
            renderTransactionTable(filteredData);
        };
        
        const renderTasks = () => {
            DOMElements.tasks.viewSwitcher.querySelectorAll('.task-view-btn').forEach(btn => {
                const isActive = btn.dataset.view === state.ui.activeTaskView;
                btn.classList.toggle('bg-blue-600', isActive);
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('dark:bg-blue-500', isActive);
            });

            switch (state.ui.activeTaskView) {
                case 'board': renderTaskBoard(); break;
                case 'list': renderTaskListView(); break;
                case 'calendar': renderTaskCalendarView(); break;
                case 'analytics': renderTaskAnalytics(); break;
            }
        };

        const renderTaskBoard = () => {
            const columns = { 'To Do': [], 'In Progress': [], 'Done': [] };
            const tasksToDisplay = state.tasks.filter(task => task.status !== 'Archived' || state.ui.showArchived);
            tasksToDisplay.forEach(task => {
                if(columns[task.status]) {
                    columns[task.status].push(task)
                } else if (task.status === 'Archived') {
                    // This logic is handled in getTasksForColumn
                }
            });

            let todoTasks = columns['To Do'];
            if (state.ui.todoFilter === 'today') {
                todoTasks = todoTasks.filter(t => t.dueDate && isToday(parseISO(t.dueDate)));
            } else if (state.ui.todoFilter === 'tomorrow') {
                todoTasks = todoTasks.filter(t => t.dueDate && isTomorrow(parseISO(t.dueDate)));
            }

            const getHeaderHTML = (status) => {
                let headerContent;
                if (status === 'To Do') {
                    headerContent = `
                    <div class="flex justify-between items-center">
                        <h3 class="font-semibold text-lg text-gray-800 dark:text-gray-200">${status}</h3>
                        <div class="flex items-center gap-3">
                             <div class="flex items-center gap-2 text-xs font-medium text-gray-500 dark:text-dark-text-secondary">
                                <button class="todo-filter-btn hover:text-blue-500 ${state.ui.todoFilter === 'all' ? 'font-bold text-blue-500' : ''}" data-filter="all">All</button>
                                <button class="todo-filter-btn hover:text-blue-500 ${state.ui.todoFilter === 'today' ? 'font-bold text-blue-500' : ''}" data-filter="today">Today</button>
                                <button class="todo-filter-btn hover:text-blue-500 ${state.ui.todoFilter === 'tomorrow' ? 'font-bold text-blue-500' : ''}" data-filter="tomorrow">Tomorrow</button>
                            </div>
                            <span class="text-sm bg-gray-200 dark:bg-dark-surface/50 px-2 py-0.5 rounded-full">${todoTasks.length}</span>
                        </div>
                    </div>`;
                } else if (status === 'Done') {
                    const archivedCount = state.tasks.filter(t=>t.status==='Archived').length;
                    headerContent = `
                     <div class="flex justify-between items-center">
                        <h3 class="font-semibold text-lg text-gray-800 dark:text-gray-200">${status}</h3>
                        <div class="flex items-center gap-3 text-xs font-medium text-gray-500 dark:text-dark-text-secondary">
                           ${archivedCount > 0 ? `<button id="view-archived-btn" class="hover:text-blue-500">${state.ui.showArchived ? 'Hide' : `View`} Archived</button><span>|</span>` : ''}
                           <button id="archive-all-done-btn" class="hover:text-blue-500">Archive All</button>
                           <span class="text-sm bg-gray-200 dark:bg-dark-surface/50 px-2 py-0.5 rounded-full ml-2">${columns[status].length}</span>
                        </div>
                    </div>`;
                }
                else {
                    const taskCount = columns[status].length;
                    headerContent = `<h3 class="font-semibold text-lg text-gray-800 dark:text-gray-200 flex justify-between items-center">${status} <span class="text-sm bg-gray-200 dark:bg-dark-surface/50 px-2 py-0.5 rounded-full">${taskCount}</span></h3>`;
                }
                 return headerContent;
            }

            const getTasksForColumn = (status) => {
                if (status === 'To Do') return todoTasks;
                if (status === 'Done' && state.ui.showArchived) {
                    return [...columns['Done'], ...state.tasks.filter(t => t.status === 'Archived')];
                }
                return columns[status] || [];
            }

            DOMElements.tasks.content.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                ${Object.keys(columns).map(status => `
                    <div class="bg-transparent rounded-xl">
                        <div class="mb-4">${getHeaderHTML(status)}</div>
                        <div class="space-y-4 drop-zone task-board-column" data-status="${status}">
                            ${getTasksForColumn(status).map(task => {
                                const subtasks = task.subtasks || [];
                                const subtasksDone = subtasks.filter(st => st.done).length;
                                const totalSubtasks = subtasks.length;
                                const progress = totalSubtasks > 0 ? (subtasksDone / totalSubtasks) * 100 : 0;
                                const colors = getTagColor(task.tags?.[0] || 'default');
                                const isExpanded = !!state.ui.expandedBoardTasks[task.id];
                                const isArchived = task.status === 'Archived';
                                let dueDateText = '';
                                if(task.dueDate) {
                                    const date = parseISO(task.dueDate);
                                    dueDateText = format(date, 'MMM d') + (format(date, 'HH:mm') !== '00:00' ? `, ${format(date, 'p')}` : '');
                                }
                                return `
                                <div class="task-card-wrapper">
                                <div class="task-card bg-white dark:bg-dark-surface p-4 rounded-lg shadow-md border-l-4 ${isArchived ? 'opacity-60' : ''}" style="border-left-color: ${isArchived ? '#6b7280' : colors.text};" draggable="${!isArchived}" data-task-id="${task.id}">
                                    <div class="flex justify-between items-start">
                                        <h4 class="font-semibold mb-2 flex-1">${task.title}</h4>
                                        <div class="flex flex-col items-end">
                                            <div class="live-timer-display text-sm font-bold text-blue-500" data-timer-for="${task.id}"></div>
                                            ${isArchived ? `<button class="unarchive-from-board-btn text-xs text-blue-500 hover:underline" data-task-id="${task.id}">Unarchive</button>` : ''}
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-500 dark:text-dark-text-secondary mb-2">${state.projects.find(p => p.id === task.projectId)?.name || 'N/A'}</p>
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        ${(task.tags || []).map(tag => {
                                            const tagColors = getTagColor(tag);
                                            return `<span class="text-xs font-semibold px-2 py-1 rounded-full" style="background-color:${tagColors.bg}; color:${tagColors.text};">${tag}</span>`
                                        }).join('')}
                                    </div>

                                    ${totalSubtasks > 0 ? `
                                    <div class="my-3">
                                        <div class="flex justify-between mb-1 text-xs font-medium text-gray-500 dark:text-dark-text-secondary">
                                            <span>Subtasks</span>
                                            <span>${subtasksDone} / ${totalSubtasks}</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700">
                                            <div class="bg-blue-600 h-1.5 rounded-full" style="width: ${progress}%"></div>
                                        </div>
                                    </div>
                                    ` : ''}

                                    <div class="flex justify-between items-center text-sm text-gray-500 dark:text-dark-text-secondary mt-3 pt-3 border-t border-gray-100 dark:border-dark-border/50">
                                        <div class="flex items-center gap-2 text-xs">
                                            ${dueDateText ? `
                                                <span class="flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline-block"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> ${dueDateText}</span>
                                            ` : ''}
                                            ${dueDateText && formatTimeEstimate(task.timeEstimate) ? '<span class="text-gray-300 dark:text-gray-600">|</span>' : ''}
                                            ${formatTimeEstimate(task.timeEstimate) ? `
                                                <span class="flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> ${formatTimeEstimate(task.timeEstimate)}</span>
                                            ` : ''}
                                        </div>
                                        ${totalSubtasks > 0 ? `
                                            <button class="expand-subtasks-btn p-1 rounded-full hover:bg-gray-200 dark:hover:bg-dark-border ${isExpanded ? 'expanded' : ''}" data-task-id="${task.id}">
                                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" /></svg>
                                            </button>
                                        ` : ''}
                                    </div>
                                    
                                    ${totalSubtasks > 0 ? `
                                    <div class="subtasks-board-container mt-2 pt-2 border-t dark:border-dark-border/50 ${isExpanded ? 'expanded' : ''}">
                                       <div class="space-y-2 max-h-32 overflow-y-auto pr-2">
                                         ${subtasks.map(st => `
                                            <div class="flex items-center gap-2 text-sm">
                                                <input type="checkbox" ${st.done ? 'checked' : ''} class="subtask-checkbox-board h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" data-task-id="${task.id}" data-subtask-id="${st.id}">
                                                <span class="flex-grow">${st.title}</span>
                                            </div>
                                        `).join('')}
                                       </div>
                                    </div>
                                    ` : ''}
                                </div>
                                </div>
                            `}).join('')}
                             <div class="h-2"></div>
                        </div>
                    </div>
                `).join('')}
            </div>`;
            setupDragAndDrop();
        };
        
        const renderTaskListView = () => {
            const { key, order } = state.ui.taskSort;
            let statusFilter = state.ui.activeTaskStatusFilter;
            const searchQuery = state.ui.taskSearchQuery.toLowerCase();
            const projects = state.projects;

            let filteredTasks = [...state.tasks];
            
            if (statusFilter === 'all' && !state.ui.showArchived) {
                 filteredTasks = filteredTasks.filter(task => task.status !== 'Archived');
            } else if (statusFilter !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
            }

            if (searchQuery) {
                filteredTasks = filteredTasks.filter(task =>
                    task.title.toLowerCase().includes(searchQuery) ||
                    (task.description && task.description.toLowerCase().includes(searchQuery)) ||
                    (task.tags && task.tags.join(' ').toLowerCase().includes(searchQuery)) ||
                    (projects.find(p => p.id === task.projectId)?.name.toLowerCase().includes(searchQuery))
                );
            }

            const sortedTasks = filteredTasks.sort((a,b) => {
                const valA = a[key] || 0;
                const valB = b[key] || 0;
                if (!valA) return 1;
                if (!valB) return -1;
                return (valA < valB ? -1 : valA > valB ? 1 : 0) * (order === 'asc' ? 1 : -1);
            });

            const renderHeader = (k, t) => { 
                const isCurr = key === k; 
                return `<th class="p-4 font-semibold sortable" data-sort-key="${k}"><span class="flex items-center gap-2">${t}<span class="sort-indicator">${isCurr ? (order === 'asc' ? '▲' : '▼') : '▼'}</span></span></th>`; 
            };
            
            const statusFilterButtons = ['all', 'To Do', 'In Progress', 'Done', 'Archived'];

             DOMElements.tasks.content.innerHTML = `
                <div class="bg-white dark:bg-dark-surface rounded-xl shadow-lg border border-gray-200 dark:border-dark-border overflow-hidden">
                    <div class="p-4 border-b dark:border-dark-border flex flex-wrap items-center gap-4">
                        <div class="relative flex-grow min-w-[240px]">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                            <input id="task-search-input" type="text" placeholder="Search tasks by title, tag, project..." class="w-full pl-10 pr-4 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-dark-border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value="${state.ui.taskSearchQuery}">
                        </div>
                        <div id="task-status-filters" class="flex items-center border border-gray-200 dark:border-dark-border rounded-lg p-1 space-x-1">
                            ${statusFilterButtons.map(status => `<button class="table-tab-btn ${status === statusFilter ? 'active' : ''}" data-status="${status}">${status}</button>`).join('')}
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 dark:bg-dark-surface/50">
                                <tr class="text-sm dark:text-dark-text-secondary">
                                    <th class="p-4 w-10"></th>
                                    ${renderHeader('title', 'Task')}
                                    ${renderHeader('projectId', 'Project')}
                                    ${renderHeader('dueDate', 'Due Date')}
                                    ${renderHeader('priority', 'Priority')}
                                    ${renderHeader('status', 'Status')}
                                    ${renderHeader('timeEstimate', 'Estimate')}
                                    <th class="p-4 font-semibold">Time Logged</th>
                                </tr>
                            </thead>
                            <tbody id="task-list-body">
                                ${sortedTasks.map(task => {
                                    const priorityDot = { Low: 'bg-green-500', Medium: 'bg-yellow-500', High: 'bg-red-500' };
                                    const isExpanded = state.ui.expandedListTasks[task.id];
                                    const isArchived = task.status === 'Archived';
                                    let dueDateText = 'N/A';
                                    if(task.dueDate) {
                                        const date = parseISO(task.dueDate);
                                        dueDateText = format(date, 'MMM d, yy') + (format(date, 'HH:mm') !== '00:00' ? `, ${format(date, 'p')}` : '');
                                    }
                                    return `
                                    <tr class="list-view-row border-t dark:border-dark-border hover:bg-gray-50 dark:hover:bg-gray-800/50 ${isExpanded ? 'expanded' : ''} ${isArchived ? 'opacity-60' : ''}" data-task-id="${task.id}">
                                        <td class="p-4 text-center">
                                            ${(task.subtasks || []).length > 0 ? `<button class="list-view-expand-btn p-1 rounded-full hover:bg-gray-200 dark:hover:bg-dark-border"><svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" /></svg></button>` : ''}
                                        </td>
                                        <td class="p-4 font-semibold task-title-cell cursor-pointer">${task.title}</td>
                                        <td class="p-4">${state.projects.find(p => p.id === task.projectId)?.name || 'N/A'}</td>
                                        <td class="p-4">${dueDateText}</td>
                                        <td class="p-4"><div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full ${priorityDot[task.priority]}"></div><span>${task.priority}</span></div></td>
                                        <td class="p-4">${task.status}</td>
                                        <td class="p-4">${task.timeEstimate > 0 ? `${task.timeEstimate}m` : 'N/A'}</td>
                                        <td class="p-4 font-mono">
                                            <div class="flex items-center justify-between">
                                                <span>${formatTime(calculateTotalTime(task))}</span>
                                                <div class="live-timer-display text-sm font-bold text-blue-500" data-timer-for="${task.id}"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr class="subtasks-row ${isExpanded ? '' : 'hidden'}" data-subtask-for="${task.id}">
                                        <td colspan="8" class="p-0">
                                            <div class="subtasks-container-in-list p-4 pl-16">
                                                <h4 class="font-semibold text-sm mb-2">Sub-tasks</h4>
                                                ${(task.subtasks || []).length > 0 ? (task.subtasks || []).map(st => `
                                                    <div class="flex items-center gap-2 py-1 text-sm">
                                                        <input type="checkbox" ${st.done ? 'checked' : ''} class="subtask-checkbox-list h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" data-task-id="${task.id}" data-subtask-id="${st.id}">
                                                        <span class="${st.done ? 'line-through text-gray-500' : ''}">${st.title}</span>
                                                    </div>
                                                `).join('') : '<p class="text-sm text-gray-500">No sub-tasks.</p>'}
                                            </div>
                                        </td>
                                    </tr>
                                `}).join('')}
                                ${sortedTasks.length === 0 ? `<tr><td colspan="8" class="text-center p-8 text-gray-500">No tasks match your criteria.</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            // Add listeners
            const searchInput = DOMElements.tasks.content.querySelector('#task-search-input');
            const statusFilterContainer = DOMElements.tasks.content.querySelector('#task-status-filters');
            
            searchInput.addEventListener('input', debounce(e => {
                state.ui.taskSearchQuery = e.target.value;
                renderTaskListView();
            }, 300));

            statusFilterContainer.addEventListener('click', e => {
                const button = e.target.closest('[data-status]');
                if (button) {
                    state.ui.activeTaskStatusFilter = button.dataset.status;
                     state.ui.showArchived = button.dataset.status === 'Archived';
                    renderTaskListView();
                }
            });

            DOMElements.tasks.content.querySelector('thead').addEventListener('click', e => {
                const th = e.target.closest('[data-sort-key]');
                if (!th) return;
                const newKey = th.dataset.sortKey;
                state.ui.taskSort.order = state.ui.taskSort.key === newKey && state.ui.taskSort.order === 'asc' ? 'desc' : 'asc';
                state.ui.taskSort.key = newKey;
                renderTaskListView();
            });

            DOMElements.tasks.content.querySelector('#task-list-body').addEventListener('click', e => {
                const expandBtn = e.target.closest('.list-view-expand-btn');
                const titleCell = e.target.closest('.task-title-cell');
                const row = e.target.closest('.list-view-row');

                if (expandBtn) {
                    e.stopPropagation();
                    const taskId = row.dataset.taskId;
                    state.ui.expandedListTasks[taskId] = !state.ui.expandedListTasks[taskId];
                    renderTaskListView();
                } else if (titleCell) {
                    openTaskModal(row.dataset.taskId);
                }
            });
        };

        const renderTaskCalendarView = () => {
            const date = state.ui.currentCalendarDate;
            const view = state.ui.activeCalendarView;
            let title = '';
            if (view === 'day') title = format(date, 'MMMM d, yyyy');
            if (view === 'week') {
                const start = startOfWeek(date, { weekStartsOn: 1 });
                const end = endOfWeek(date, { weekStartsOn: 1 });
                title = `${format(start, 'MMM d')} - ${format(end, 'MMM d, yyyy')}`;
            }
            if (view === 'month') title = format(date, 'MMMM yyyy');

            const viewSwitcherButtons = ['day', 'week', 'month'].map(v => 
                `<button data-view="${v}" class="calendar-view-btn table-tab-btn ${view === v ? 'active' : ''}">${v.charAt(0).toUpperCase() + v.slice(1)}</button>`
            ).join('');

            DOMElements.tasks.content.innerHTML = `
                <div class="bg-white dark:bg-dark-surface rounded-xl shadow-lg border border-gray-200 dark:border-dark-border p-4 flex flex-col h-[85vh]">
                    <div class="flex-shrink-0">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                            <div class="flex items-center gap-4">
                                <button id="cal-prev" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-border">&lt;</button>
                                <h3 class="text-xl font-bold">${title}</h3>
                                <button id="cal-next" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-border">&gt;</button>
                                <button id="cal-today" class="text-sm font-semibold px-3 py-1 bg-gray-200 dark:bg-dark-border rounded-md">Today</button>
                            </div>
                             <div id="calendar-view-switcher" class="flex items-center border border-gray-200 dark:border-dark-border rounded-lg p-1 space-x-1">
                                ${viewSwitcherButtons}
                            </div>
                        </div>
                    </div>
                    <div id="calendar-view-container" class="flex-grow overflow-auto"></div>
                </div>`;
            
            renderCalendar();

            document.getElementById('cal-prev').addEventListener('click', () => { 
                const view = state.ui.activeCalendarView;
                if(view === 'day') state.ui.currentCalendarDate = addDays(state.ui.currentCalendarDate, -1); 
                if(view === 'week') state.ui.currentCalendarDate = addWeeks(state.ui.currentCalendarDate, -1); 
                if(view === 'month') state.ui.currentCalendarDate = addMonths(state.ui.currentCalendarDate, -1); 
                renderTaskCalendarView(); 
            });
            document.getElementById('cal-next').addEventListener('click', () => { 
                const view = state.ui.activeCalendarView;
                if(view === 'day') state.ui.currentCalendarDate = addDays(state.ui.currentCalendarDate, 1); 
                if(view === 'week') state.ui.currentCalendarDate = addWeeks(state.ui.currentCalendarDate, 1); 
                if(view === 'month') state.ui.currentCalendarDate = addMonths(state.ui.currentCalendarDate, 1); 
                renderTaskCalendarView(); 
            });
            document.getElementById('cal-today').addEventListener('click', () => {
                state.ui.currentCalendarDate = new Date();
                renderTaskCalendarView();
            });
            document.getElementById('calendar-view-switcher').addEventListener('click', e => {
                 const button = e.target.closest('.calendar-view-btn');
                if (button && button.dataset.view) {
                    state.ui.activeCalendarView = button.dataset.view;
                    renderTaskCalendarView();
                }
            });
        }
        
        const renderCalendar = () => {
             const view = state.ui.activeCalendarView;
             if (view === 'day') renderDayCalendar(state.ui.currentCalendarDate);
             if (view === 'week') renderWeekCalendar(state.ui.currentCalendarDate);
             if (view === 'month') renderMonthCalendar(state.ui.currentCalendarDate);
        }

        const renderDayCalendar = (date) => {
             const allDayTasks = state.tasks.filter(task => {
                if (!task.dueDate) return false;
                const dueDate = parseISO(task.dueDate);
                return isSameDay(dueDate, date) && format(dueDate, 'HH:mm') === '00:00';
            });
            const timedTasks = state.tasks.filter(task => {
                if (!task.dueDate) return false;
                const dueDate = parseISO(task.dueDate);
                return isSameDay(dueDate, date) && format(dueDate, 'HH:mm') !== '00:00';
            }).sort((a,b) => parseISO(a.dueDate) - parseISO(b.dueDate));
            
            const container = DOMElements.tasks.content.querySelector('#calendar-view-container');
            container.innerHTML = `
                <div class="flex flex-col h-full">
                    <div id="all-day-container" class="border-b dark:border-dark-border pb-2 mb-2 flex-shrink-0">
                         <div class="flex items-center">
                            <div class="w-16 text-center pr-4 text-xs font-semibold text-gray-500">All-day</div>
                            <div class="flex-1 pl-2 grid grid-cols-1 gap-1">
                                ${allDayTasks.length > 0 ? allDayTasks.map(task => {
                                    const colors = getTagColor(task.tags?.[0]);
                                    return `<div class="all-day-task-item text-sm font-semibold p-1 rounded" style="background-color: ${colors.bg}; color: ${colors.text}" data-task-id="${task.id}">${task.title}</div>`;
                                }).join('') : `<div class="text-sm text-gray-400 h-6"></div>`}
                            </div>
                        </div>
                    </div>
                    <div id="calendar-scroll-container" class="flex-grow overflow-y-auto relative"></div>
                </div>
            `;
            
            const scrollContainer = container.querySelector('#calendar-scroll-container');
            let timeSlotsHTML = '';
            for (let i = 0; i < 24; i++) {
                const hour = i.toString().padStart(2, '0');
                 timeSlotsHTML += `<div class="flex">
                            <div class="w-16 text-right pr-4 text-xs text-gray-400 dark:text-dark-text-secondary -mt-2">${i === 0 ? '' : `${hour}:00`}</div>
                            <div class="time-slot flex-1 border-t dark:border-dark-border/50" data-hour="${i}"></div>
                        </div>`;
            }

            const taskItemsHTML = timedTasks.map(task => {
                const dueDate = parseISO(task.dueDate);
                const startHour = getHours(dueDate);
                const startMinute = getMinutes(dueDate);
                let durationMinutes = task.timeEstimate || 60;
                
                const top = ((startHour * 60 + startMinute) / 60) * 60;
                const height = Math.max((durationMinutes / 60) * 60, 30); // Min height of 30px
                
                const tagColors = getTagColor(task.tags?.[0] || 'default');

                return `<div class="calendar-task-item" draggable="true" 
                                style="top: ${top}px; height: ${height}px; background-color:${tagColors.bg}; border-left-color:${tagColors.text}; color:${tagColors.text};"
                                data-task-id="${task.id}">
                                <strong>${format(dueDate, 'p')}</strong> ${task.title}
                         </div>`;
            }).join('');
            
            scrollContainer.innerHTML = `<div class="time-slot-grid relative">${timeSlotsHTML}${taskItemsHTML}</div>`;
            
            setTimeout(() => { scrollContainer.scrollTop = 8 * 60; }, 0);
        }

        const renderWeekCalendar = (date) => {
             const container = DOMElements.tasks.content.querySelector('#calendar-view-container');
             const start = startOfWeek(date, { weekStartsOn: 1 });
             const end = endOfWeek(date, { weekStartsOn: 1 });
             const days = eachDayOfInterval({start, end});

             container.innerHTML = `
                <div class="grid grid-cols-7 h-full">
                 ${days.map(day => `
                    <div class="flex flex-col border-r dark:border-dark-border">
                        <div class="text-center font-semibold p-2 border-b dark:border-dark-border ${isToday(day) ? 'bg-blue-100 dark:bg-blue-900' : ''}">
                             <span class="text-sm text-gray-500 dark:text-gray-400">${format(day, 'E')}</span>
                             <div class="text-2xl">${format(day, 'd')}</div>
                        </div>
                        <div class="day-column flex-grow overflow-y-auto relative p-1 space-y-1" data-date="${format(day, 'yyyy-MM-dd')}">
                             ${state.tasks.filter(t => t.dueDate && isSameDay(parseISO(t.dueDate), day)).map(task => {
                                 const colors = getTagColor(task.tags?.[0]);
                                 return `<div class="month-task-item p-2 cursor-pointer" style="background-color:${colors.bg}; color:${colors.text}" data-task-id="${task.id}">${task.title}</div>`;
                             }).join('')}
                        </div>
                    </div>
                 `).join('')}
                </div>
             `;
        }

        const renderMonthCalendar = (date) => {
             const container = DOMElements.tasks.content.querySelector('#calendar-view-container');
             const monthStart = startOfMonth(date);
             const monthEnd = endOfMonth(date);
             const gridStart = startOfWeek(monthStart, { weekStartsOn: 1 });
             const gridEnd = endOfWeek(monthEnd, { weekStartsOn: 1 });
             const days = eachDayOfInterval({start: gridStart, end: gridEnd});
            
             const headerDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(d => `<div class="text-center font-bold text-sm p-2 text-gray-500 dark:text-dark-text-secondary">${d}</div>`).join('');

             container.innerHTML = `
                <div class="flex flex-col h-full">
                    <div class="grid grid-cols-7 border-b border-l border-r dark:border-dark-border">${headerDays}</div>
                    <div class="calendar-month-grid flex-grow border-l dark:border-dark-border">
                        ${days.map(day => {
                            const tasksForDay = state.tasks.filter(t => t.dueDate && isSameDay(parseISO(t.dueDate), day)).sort((a,b) => parseISO(a.dueDate) - parseISO(b.dueDate));
                            const isCurrentMonth = isSameMonth(day, date);
                            return `
                                <div class="calendar-day-cell ${isCurrentMonth ? '' : 'other-month'} ${isToday(day) ? 'is-today' : ''}" data-date="${format(day, 'yyyy-MM-dd')}">
                                    <span class="font-semibold">${format(day, 'd')}</span>
                                    <div class="flex flex-col gap-1 overflow-hidden">
                                        ${tasksForDay.slice(0, 3).map(task => {
                                            const colors = getTagColor(task.tags?.[0] || 'default');
                                            return `<div class="month-task-item" style="background-color: ${colors.bg}; color: ${colors.text};" data-task-id="${task.id}">${task.title}</div>`;
                                        }).join('')}
                                        ${tasksForDay.length > 3 ? `<div class="text-xs font-semibold text-blue-500 mt-1">+ ${tasksForDay.length - 3} more</div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
             `;
        };
        
        const renderTaskAnalytics = () => {
             DOMElements.tasks.content.innerHTML = `
                <div class="space-y-8">
                    <div id="task-analytics-kpis" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6"></div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="dashboard-card bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
                            <h2 class="text-xl font-bold mb-4">Workload by Priority (Open Tasks)</h2>
                            <div class="h-64 relative"><canvas id="workload-by-priority-chart"></canvas></div>
                        </div>
                        <div class="dashboard-card bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
                            <h2 class="text-xl font-bold mb-4">Task Completion Velocity (by Tag)</h2>
                            <div class="h-64 relative"><canvas id="task-velocity-chart"></canvas></div>
                        </div>
                    </div>

                     <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                        <div class="dashboard-card lg:col-span-2 bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
                            <h2 class="text-xl font-bold mb-4">Time Distribution by Project</h2>
                            <div class="h-80 relative"><canvas id="time-by-project-chart"></canvas></div>
                        </div>
                        <div class="dashboard-card lg:col-span-3 bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
                            <h2 class="text-xl font-bold mb-4">Tasks Created vs. Completed (Last 30 Days)</h2>
                            <div class="h-80 relative"><canvas id="tasks-completed-chart"></canvas></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <div id="due-date-performance-container" class="dashboard-card bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
        <h2 class="text-xl font-bold mb-4">On-Time Completion Rate</h2>
        <div class="h-64 relative"><canvas id="due-date-chart"></canvas></div>
    </div>
    <div id="project-summary-container" class="dashboard-card bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border">
        <h2 class="text-xl font-bold mb-4">Project Summary</h2>
        <div id="project-summary-table" class="overflow-x-auto"></div>
    </div>
</div>

<div class="dashboard-card bg-white dark:bg-dark-surface p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-dark-border mt-8">
    <h2 class="text-xl font-bold mb-4">Time Efficiency Breakdown (Completed Tasks)</h2>
    <div id="time-efficiency-container" class="space-y-4 max-h-[400px] overflow-y-auto pr-2"></div>
</div>
                </div>
             `;
            
            updateTaskAnalyticsView();
        }

        const updateTaskAnalyticsView = () => {
            const allTasks = state.tasks;
            const completedOrArchivedTasks = allTasks.filter(t => (t.status === 'Done' || t.status === 'Archived') && t.completedAt);
            
            renderAnalyticsKPIs(allTasks, completedOrArchivedTasks);
            renderTimeByProjectPieChart(allTasks);
            renderCreatedVsCompletedChart(allTasks);
            renderWorkloadByPriorityChart(allTasks);
            renderTaskVelocityChart(completedOrArchivedTasks);
            renderTimeEfficiencyBreakdown(completedOrArchivedTasks);
            renderDueDatePerformanceChart(completedOrArchivedTasks);
            renderProjectSummaryTable(allTasks);
        }

        const renderAnalyticsKPIs = (allTasks, completedTasks) => {
            const totalTasksCompleted = completedTasks.length;
            const totalTimeLoggedMs = allTasks.reduce((sum, task) => sum + calculateTotalTime(task), 0);
            
            const efficiencyData = completedTasks.reduce((acc, task) => {
                 if (task.timeEstimate > 0) {
                     const loggedMinutes = calculateTotalTime(task) / (1000 * 60);
                     acc.totalSavedMinutes += (task.timeEstimate - loggedMinutes);
                 }
                 return acc;
            }, { totalSavedMinutes: 0 });

            const openTasks = allTasks.filter(t => t.status === 'To Do' || t.status === 'In Progress').length;

            const kpis = [
                { label: 'Tasks Completed', value: totalTasksCompleted, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 12 2 2 4-4" /><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" /></svg>' },
                { label: 'Hours Logged (All Time)', value: formatHours(totalTimeLoggedMs), icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>' },
                { label: 'Net Time Saved', value: `${Math.round(efficiencyData.totalSavedMinutes)} min`, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>' },
                { label: 'Open Tasks', value: openTasks, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12V8a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8"/><path d="m18 18 4 4m0-4-4 4"/></svg>'}
            ];

            document.getElementById('task-analytics-kpis').innerHTML = kpis.map(kpi => `
                <div class="dashboard-card bg-white dark:bg-dark-surface p-5 rounded-xl shadow-lg border border-gray-200 dark:border-dark-border flex items-start gap-4">
                     <div class="bg-blue-100 dark:bg-blue-500/20 text-blue-600 dark:text-blue-400 p-3 rounded-lg">${kpi.icon}</div>
                     <div>
                        <p class="text-sm text-gray-500 dark:text-dark-text-secondary">${kpi.label}</p>
                        <p class="text-2xl font-bold">${kpi.value}</p>
                    </div>
                </div>
            `).join('');
        };
        
        const renderTimeByProjectPieChart = (tasks) => {
            const timeByProject = tasks.reduce((acc, task) => {
                const totalTime = calculateTotalTime(task);
                if (totalTime > 0) {
                    const projectName = state.projects.find(p => p.id === task.projectId)?.name || 'No Project';
                    if (!acc[projectName]) acc[projectName] = 0;
                    acc[projectName] += totalTime;
                }
                return acc;
            }, {});

            const sortedProjects = Object.entries(timeByProject).sort(([,a], [,b]) => b - a);
            const labels = sortedProjects.map(([label]) => label);
            const data = sortedProjects.map(([, value]) => value / (1000 * 60 * 60)); // in hours

            renderChart('time-by-project-chart', {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: labels.map((_, i) => chartStyler.getColor(i)),
                        borderColor: state.theme === 'dark' ? '#1E293B' : '#FFFFFF',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: chartStyler.legend(), boxWidth: 12, padding: 15 } },
                        tooltip: { callbacks: { label: c => `${c.label}: ${c.raw.toFixed(2)} hours` } }
                    }
                }
            });
        };
        
        const renderCreatedVsCompletedChart = (allTasks) => {
             const now = new Date();
             const thirtyDaysAgo = subDays(now, 29);
             const interval = { start: startOfDay(thirtyDaysAgo), end: endOfDay(now) };
            
            const dayLabels = eachDayOfInterval(interval);
            const labels = dayLabels.map(d => format(d, 'd MMM'));
            
            let createdData = new Array(labels.length).fill(0);
            let completedData = new Array(labels.length).fill(0);

            allTasks.forEach(task => {
                if(task.createdAt) {
                    const createdDate = parseISO(task.createdAt);
                     if (isWithinInterval(createdDate, interval)) {
                        const dayIndex = dayLabels.findIndex(d => isSameDay(d, createdDate));
                        if(dayIndex > -1) createdData[dayIndex]++;
                    }
                }
                 if(task.completedAt) {
                    const completedDate = parseISO(task.completedAt);
                     if (isWithinInterval(completedDate, interval)) {
                        const dayIndex = dayLabels.findIndex(d => isSameDay(d, completedDate));
                        if(dayIndex > -1) completedData[dayIndex]++;
                    }
                }
            });

            renderChart('tasks-completed-chart', {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Created', data: createdData, backgroundColor: '#60a5fa', borderRadius: 4, },
                        { label: 'Completed', data: completedData, backgroundColor: '#4ade80', borderRadius: 4, }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: chartStyler.labels(), stepSize: 1 }, grid: { color: chartStyler.grid() } },
                        x: { ticks: { color: chartStyler.labels() }, grid: { display: false } }
                    },
                    plugins: { legend: { position: 'top', labels: { color: chartStyler.legend() } } }
                }
            });
        };
        
        const renderTimeEfficiencyBreakdown = (completedTasks) => {
            const container = document.getElementById('time-efficiency-container');
            
            const efficiencyData = completedTasks.map(task => {
                const timeEstimate = task.timeEstimate || 0;
                const timeLogged = calculateTotalTime(task) / (1000 * 60); // in minutes
                const difference = timeEstimate - timeLogged;
                return { ...task, difference, timeLogged };
            }).filter(task => task.timeEstimate > 0).sort((a,b) => b.completedAt.localeCompare(a.completedAt));

            if (efficiencyData.length === 0) {
                container.innerHTML = `<div class="text-center p-8 text-gray-500 dark:text-dark-text-secondary">No completed tasks with time estimates found.</div>`;
                return;
            }

            container.innerHTML = efficiencyData.map(task => {
                const isSaved = task.difference >= 0;
                const diffMinutes = Math.abs(Math.round(task.difference));
                const diffFormatted = formatTimeEstimate(diffMinutes);
                
                const maxVal = Math.max(task.timeEstimate, task.timeLogged);
                const loggedPercent = maxVal > 0 ? (task.timeLogged / maxVal) * 100 : 0;
                const estimatePercent = maxVal > 0 ? (task.timeEstimate / maxVal) * 100 : 0;
                
                const diffText = isSaved ? `${diffFormatted} Saved` : `${diffFormatted} Over`;
                const diffColor = isSaved ? 'text-green-500' : 'text-red-500';

                return `
                <div class="bg-gray-50 dark:bg-dark-surface/50 p-4 rounded-lg border-l-4 ${isSaved ? 'border-green-500' : 'border-red-500'} cursor-pointer efficiency-row" data-task-id="${task.id}">
                    <div class="flex flex-wrap justify-between items-center gap-2">
                        <div class="flex-grow">
                            <p class="font-bold">${task.title}</p>
                            <p class="text-xs text-gray-500 dark:text-dark-text-secondary">${state.projects.find(p=>p.id === task.projectId)?.name || 'No Project'} &bull; Completed on ${format(parseISO(task.completedAt), 'MMM d, yyyy')}</p>
                        </div>
                        <div class="font-bold text-lg ${diffColor}">${diffText}</div>
                    </div>
                    <div class="mt-3 space-y-2 text-sm">
                        <div class="flex items-center gap-4">
                            <span class="w-20 font-semibold text-gray-600 dark:text-dark-text-secondary">Logged</span>
                            <div class="flex-grow bg-gray-200 dark:bg-dark-border rounded-full h-2.5">
                                <div class="bg-blue-500 h-2.5 rounded-full" style="width: ${loggedPercent}%"></div>
                            </div>
                            <span class="w-20 text-right font-mono">${formatTimeEstimate(task.timeLogged)}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="w-20 font-semibold text-gray-600 dark:text-dark-text-secondary">Estimated</span>
                            <div class="flex-grow bg-gray-200 dark:bg-dark-border rounded-full h-2.5">
                                <div class="bg-gray-400 dark:bg-gray-500 h-2.5 rounded-full" style="width: ${estimatePercent}%"></div>
                            </div>
                             <span class="w-20 text-right font-mono">${formatTimeEstimate(task.timeEstimate)}</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        };
        
        const renderWorkloadByPriorityChart = (allTasks) => {
             const openTasks = allTasks.filter(t => t.status === 'To Do' || t.status === 'In Progress');
             const workload = openTasks.reduce((acc, task) => {
                 acc[task.priority] = (acc[task.priority] || 0) + 1;
                 return acc;
             }, { High: 0, Medium: 0, Low: 0 });

             renderChart('workload-by-priority-chart', {
                type: 'doughnut',
                data: {
                    labels: Object.keys(workload),
                    datasets: [{
                        data: Object.values(workload),
                        backgroundColor: [chartStyler.priorityColors.High, chartStyler.priorityColors.Medium, chartStyler.priorityColors.Low],
                        borderColor: state.theme === 'dark' ? '#1E293B' : '#FFFFFF',
                        borderWidth: 4,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom', labels: { color: chartStyler.legend(), boxWidth: 12, padding: 20 } },
                        tooltip: { callbacks: { label: c => `${c.label}: ${c.raw} tasks` } }
                    }
                }
            });
        };

        const renderTaskVelocityChart = (completedTasks) => {
            const velocityByTag = completedTasks.reduce((acc, task) => {
                if(!task.createdAt || !task.completedAt) return acc;
                const velocityHours = differenceInHours(parseISO(task.completedAt), parseISO(task.createdAt));
                (task.tags.length ? task.tags : ['Uncategorized']).forEach(tag => {
                    if (!acc[tag]) acc[tag] = { totalHours: 0, count: 0 };
                    acc[tag].totalHours += velocityHours;
                    acc[tag].count++;
                });
                return acc;
            }, {});
            
            const labels = Object.keys(velocityByTag);
            const data = labels.map(tag => (velocityByTag[tag].totalHours / velocityByTag[tag].count).toFixed(2));

            renderChart('task-velocity-chart', {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Avg. Completion Time (Hours)',
                        data: data,
                        fill: true,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { color: chartStyler.labels(), callback: v => `${v}h` } } , x: { ticks: { color: chartStyler.labels() } } },
                    plugins: { legend: { display: false } }
                }
            });
        };
        
        const renderDueDatePerformanceChart = (completedTasks) => {
            const performance = completedTasks.reduce((acc, task) => {
                if (!task.dueDate || !task.completedAt) return acc;
                try {
                    const dueDate = parseISO(task.dueDate);
                    const completedAt = parseISO(task.completedAt);
                    if (isBefore(completedAt, dueDate) || isSameDay(completedAt, dueDate)) {
                        acc.onTime++;
                    } else {
                        acc.overdue++;
                    }
                } catch(e) { /* ignore invalid dates */ }
                return acc;
            }, { onTime: 0, overdue: 0 });

            renderChart('due-date-chart', {
                type: 'doughnut',
                data: {
                    labels: ['On Time', 'Overdue'],
                    datasets: [{
                        data: [performance.onTime, performance.overdue],
                        backgroundColor: ['#22c55e', '#ef4444'],
                        borderColor: state.theme === 'dark' ? '#1E293B' : '#FFFFFF',
                        borderWidth: 4,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom', labels: { color: chartStyler.legend(), boxWidth: 12, padding: 20 } },
                        tooltip: { callbacks: { label: c => `${c.label}: ${c.raw} tasks` } }
                    }
                }
            });
        };
        
    const renderProjectSummaryTable = (allTasks) => {
        const container = document.getElementById('project-summary-table');
        const projectsMap = new Map(state.projects.map(p => [p.id, { ...p, tasks: [], completed: 0, timeLogged: 0, timeEstimate: 0 }]));

        allTasks.forEach(task => {
            const project = projectsMap.get(task.projectId);
            if (project) {
                project.tasks.push(task);
                if (task.status === 'Done') {
                    project.completed++;
                }
                project.timeLogged += calculateTotalTime(task);
                project.timeEstimate += (task.timeEstimate || 0);
            }
        });

        const projectsData = [...projectsMap.values()].filter(p => p.tasks.length > 0);
    
        if (projectsData.length === 0) {
             container.innerHTML = `<div class="text-center py-8 text-gray-500 dark:text-dark-text-secondary">No tasks assigned to projects.</div>`;
            return;
        }

        container.innerHTML = `
            <table class="w-full text-left text-sm">
            <thead class="text-xs text-gray-500 dark:text-dark-text-secondary uppercase bg-gray-50 dark:bg-dark-surface/50">
                <tr>
                    <th class="p-2">Project</th>
                    <th class="p-2 text-center">Progress</th>
                    <th class="p-2 text-center">Time Logged</th>
                    <th class="p-2 text-center">Efficiency</th>
                </tr>
            </thead>
            <tbody>
                ${projectsData.map(p => {
                    const completionRate = p.tasks.length > 0 ? (p.completed / p.tasks.length) * 100 : 0;
                    const efficiency = p.timeEstimate > 0 ? (p.timeEstimate - (p.timeLogged / 60000)) / p.timeEstimate : 0;
                    const efficiencyText = p.timeEstimate > 0 ? `${(efficiency * 100).toFixed(0)}%` : 'N/A';
                    const efficiencyColor = efficiency >= 0 ? 'text-green-500' : 'text-red-500';

                    return `
                    <tr class="border-b dark:border-dark-border/50">
                        <td class="p-2 font-bold">${p.name}</td>
                        <td class="p-2 align-middle">
                            <div class="flex items-center justify-center gap-2">
                                <div class="w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-700">
                                    <div class="bg-blue-600 h-1.5 rounded-full" style="width: ${completionRate}%"></div>
                                </div>
                                <span class="text-xs w-12 text-right">${completionRate.toFixed(0)}%</span>
                            </div>
                        </td>
                        <td class="p-2 text-center font-mono">${formatHours(p.timeLogged)}</td>
                        <td class="p-2 text-center font-bold ${efficiencyColor}">${efficiencyText}</td>
                    </tr>
                    `;
                }).join('')}
            </tbody>
            </table>
        `;
    };
        const openTaskModal = (taskId, prefillDate = null) => {
             let task;
             if(taskId) {
                task = state.tasks.find(t => t.id === taskId);
                if (!task) { console.error("Task not found!"); return; }
             } else {
                task = { id: `task-${crypto.randomUUID()}`, title: '', status: 'To Do', priority: 'Medium', projectId: state.projects[0]?.id || '', tags: [], subtasks: [], dueDate: null, timeLog: [], description: '', timeEstimate: 0, createdAt: new Date().toISOString(), completedAt: null };
                if (prefillDate) {
                    task.dueDate = prefillDate.toISOString();
                }
                state.tasks.push(task);
             }
            state.taskToDelete = task.id; // For deletion logic
            
            const projectOptions = state.projects.map(p => `<option value="${p.id}" ${p.id === task.projectId ? 'selected' : ''}>${p.name}</option>`).join('');
            const priorityOptions = ['Low', 'Medium', 'High'].map(p => `<option value="${p}" ${p === task.priority ? 'selected' : ''}>${p}</option>`).join('');
            const statusOptions = ['To Do', 'In Progress', 'Done', 'Archived'].map(s => `<option value="${s}" ${s === task.status ? 'selected' : ''}>${s}</option>`).join('');
            const inputStyling = "text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400";
            const selectStyling = "text-gray-900 dark:text-white";
            const baseInputClasses = `block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg ${selectStyling} focus:ring-2 focus:ring-blue-500 focus:outline-none`;

            let dueDate = '';
            let dueTime = '';
            if (task.dueDate) {
                const dateObj = parseISO(task.dueDate);
                dueDate = format(dateObj, 'yyyy-MM-dd');
                dueTime = format(dateObj, 'HH:mm');
            }


            DOMElements.tasks.detailModalBody.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">
                    <div class="md:col-span-2 space-y-6">
                        <input type="text" id="task-title" value="${task.title}" placeholder="Task Title" class="text-2xl font-bold w-full bg-transparent focus:outline-none border-b-2 border-gray-200 dark:border-dark-border focus:border-blue-500 transition pb-2 ${inputStyling}">
                        
                        <div>
                            <label class="block text-sm font-medium dark:text-dark-text-secondary mb-1">Description</label>
                            <textarea id="task-description" rows="3" class="${baseInputClasses}" placeholder="Add a more detailed description...">${task.description || ''}</textarea>
                        </div>

                        <div>
                            <h4 class="font-semibold mb-2">Sub-tasks</h4>
                            <div id="subtask-list" class="space-y-1">
                                ${(task.subtasks || []).map(st => `
                                <div class="subtask-item border-t dark:border-dark-border/50">
                                    <div class="subtask-item-header flex items-center gap-2 p-2 ${state.ui.expandedSubtasks[st.id] ? 'expanded' : ''}" data-subtask-id="${st.id}">
                                        <svg class="expand-icon h-4 w-4 text-gray-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7" /></svg>
                                        <input type="checkbox" class="subtask-checkbox h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 flex-shrink-0" ${st.done ? 'checked' : ''}>
                                        <input type="text" value="${st.title}" class="subtask-title-input flex-grow bg-transparent focus:outline-none ${selectStyling}">
                                        <button class="remove-subtask text-gray-400 hover:text-red-500 text-lg flex-shrink-0">&times;</button>
                                    </div>
                                    <div class="subtask-item-body p-4 pt-2 space-y-4 ${state.ui.expandedSubtasks[st.id] ? 'expanded' : ''}">
                                        <div>
                                            <label class="block text-xs font-medium dark:text-dark-text-secondary mb-1">Notes</label>
                                            <textarea class="subtask-description w-full text-sm p-2 bg-gray-50 dark:bg-slate-900/50 rounded-md ${inputStyling}" rows="2" placeholder="Add notes for this sub-task...">${st.description || ''}</textarea>
                                        </div>
                                    </div>
                                </div>
                                `).join('')}
                            </div>
                            <button id="add-subtask-btn" class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-semibold">+ Add sub-task</button>
                        </div>
                    </div>

                    <div class="md:col-span-1 space-y-4">
                        <div class="bg-gray-50 dark:bg-dark-surface/50 p-4 rounded-lg space-y-4">
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Status</label>
                                <select id="task-status" class="${baseInputClasses} mt-1">${statusOptions}</select>
                            </div>
                             <div>
                                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Project</label>
                                <div class="flex items-center gap-2 mt-1">
                                    <select id="task-project" class="${baseInputClasses} w-full">${projectOptions}</select>
                                    <button id="add-project-btn" class="p-2.5 bg-gray-200 dark:bg-slate-700 rounded-lg hover:bg-gray-300 dark:hover:bg-slate-600 flex-shrink-0" title="Add New Project">+</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Priority</label>
                                <select id="task-priority" class="${baseInputClasses} mt-1">${priorityOptions}</select>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Due Date</label>
                                    <input type="date" id="task-due-date" value="${dueDate}" class="${baseInputClasses} mt-1">
                                </div>
                                 <div>
                                    <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Time</label>
                                    <input type="time" id="task-due-time" value="${dueTime}" class="${baseInputClasses} mt-1">
                                </div>
                            </div>
                             <div>
                                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Tags</label>
                                <input type="text" id="task-tags" value="${(task.tags || []).join(', ')}" placeholder="e.g. marketing, bug" class="${baseInputClasses} mt-1">
                            </div>
                        </div>

                        <div id="time-tracker-module" class="bg-gray-50 dark:bg-dark-surface/50 p-4 rounded-lg space-y-4">
                            <h4 class="font-semibold text-center">Time Management</h4>
                            <div>
                                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Time Estimate (minutes)</label>
                                <input type="number" id="task-time-estimate" value="${task.timeEstimate || '0'}" class="${baseInputClasses} mt-1">
                            </div>
                            <div class="text-center">
                                <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-dark-text-secondary">Total Time Logged</p>
                                <p id="total-time-display" class="font-mono text-2xl font-bold">${formatTime(calculateTotalTime(task))}</p>
                            </div>
                            <div id="session-timer-controls" class="border-t dark:border-dark-border pt-4 space-y-3">
                                </div>
                        </div>
                    </div>
                </div>
            `;
            
            DOMElements.tasks.unarchiveTaskButton.classList.toggle('hidden', task.status !== 'Archived');
            
            updateTimerControlsUI(task.id);
            toggleModal(DOMElements.tasks.detailModal, true);
            updateTaskFromModal(task.id);
        };
        
         const updateTaskFromModal = (taskId) => {
            const task = state.tasks.find(t => t.id === taskId);
            if (!task) return;

            const modal = DOMElements.tasks.detailModalBody;
            const save = debounce(() => {
                const currentTask = state.tasks.find(t => t.id === taskId);
                if (!currentTask) return;

                const oldStatus = currentTask.status;
                currentTask.title = modal.querySelector('#task-title').value;
                currentTask.description = modal.querySelector('#task-description').value;
                currentTask.status = modal.querySelector('#task-status').value;
                currentTask.projectId = modal.querySelector('#task-project').value;
                currentTask.priority = modal.querySelector('#task-priority').value;
                currentTask.timeEstimate = parseInt(modal.querySelector('#task-time-estimate').value, 10) || 0;
                currentTask.tags = modal.querySelector('#task-tags').value.split(',').map(t => t.trim()).filter(Boolean);
                
                const datePart = modal.querySelector('#task-due-date').value;
                const timePart = modal.querySelector('#task-due-time').value;

                if (datePart) {
                    const timeString = timePart || '00:00';
                    currentTask.dueDate = `${datePart}T${timeString}:00`;
                } else {
                    currentTask.dueDate = null;
                }
                
                if ((oldStatus !== 'Done' && oldStatus !== 'Archived') && (currentTask.status === 'Done' || currentTask.status === 'Archived')) {
                    currentTask.completedAt = new Date().toISOString();
                } else if ((oldStatus === 'Done' || oldStatus === 'Archived') && (currentTask.status !== 'Done' && currentTask.status !== 'Archived')) {
                    currentTask.completedAt = null;
                }
                
                currentTask.subtasks = Array.from(modal.querySelectorAll('.subtask-item')).map(itemEl => {
                    const header = itemEl.querySelector('.subtask-item-header');
                    const body = itemEl.querySelector('.subtask-item-body');
                    return {
                        id: header.dataset.subtaskId,
                        title: header.querySelector('.subtask-title-input').value,
                        done: header.querySelector('.subtask-checkbox').checked,
                        description: body.querySelector('.subtask-description').value
                    };
                });
                
                DOMElements.tasks.unarchiveTaskButton.classList.toggle('hidden', currentTask.status !== 'Archived');
                saveState();
                renderTasks();
            }, 500);
            
            modal.querySelectorAll('input, select, textarea').forEach(el => {
                 if (!el.closest('.subtask-item')) {
                    el.addEventListener('input', save);
                }
            });

            modal.querySelector('#subtask-list').addEventListener('input', e => {
                 if (e.target.matches('.subtask-checkbox, .subtask-title-input, .subtask-description')) {
                     save();
                 }
            });

            modal.querySelector('#subtask-list').addEventListener('click', e => {
                const subtaskHeader = e.target.closest('.subtask-item-header');
                const removeSubtaskBtn = e.target.closest('.remove-subtask');

                if (removeSubtaskBtn) {
                    e.stopPropagation();
                    const subtaskItem = removeSubtaskBtn.closest('.subtask-item');
                    subtaskItem.remove();
                    save();
                } else if (subtaskHeader) {
                    e.stopPropagation();
                    const subtaskId = subtaskHeader.dataset.subtaskId;
                    state.ui.expandedSubtasks[subtaskId] = !state.ui.expandedSubtasks[subtaskId];
                    subtaskHeader.classList.toggle('expanded');
                    subtaskHeader.nextElementSibling.classList.toggle('expanded');
                }
            });
            
            modal.querySelector('#add-subtask-btn').onclick = () => {
                const currentTask = state.tasks.find(t => t.id === taskId);
                if (!currentTask) return;
                if (!currentTask.subtasks) currentTask.subtasks = [];
                const newSubtask = { id: `sub-${crypto.randomUUID()}`, title: '', done: false, description: '' };
                currentTask.subtasks.push(newSubtask);
                openTaskModal(taskId); // Re-render modal to show new subtask
            };
            
            modal.querySelector('#add-project-btn').onclick = () => {
                const newProjectName = prompt("Enter new project name:");
                if (newProjectName && newProjectName.trim()) {
                    const newProject = { id: `proj-${crypto.randomUUID()}`, name: newProjectName.trim() };
                    state.projects.push(newProject);
                    task.projectId = newProject.id;
                    saveState();
                    openTaskModal(taskId);
                }
            };
        };
        
        const closeTaskModal = () => {
            const task = state.tasks.find(t => t.id === state.taskToDelete);
            
            if(task && !task.title.trim()) {
                state.tasks = state.tasks.filter(t => t.id !== task.id);
            }
            toggleModal(DOMElements.tasks.detailModal, false);
            state.taskToDelete = null;
            state.ui.expandedSubtasks = {};
            renderTasks();
            saveState();
        };

        const deleteTask = () => {
            if (state.taskToDelete) {
                if(state.activeSessionTimer && state.activeSessionTimer.taskId === state.taskToDelete) {
                    stopTimerSession(false); // Stop without saving log
                }
                state.tasks = state.tasks.filter(t => t.id !== state.taskToDelete);
                saveState();
                closeTaskModal();
            }
        };

        const unarchiveTask = () => {
            const task = state.tasks.find(t => t.id === state.taskToDelete);
            if(task && task.status === 'Archived') {
                task.status = 'Done';
                saveState();
                closeTaskModal();
            }
        };

        const archiveAllDoneTasks = () => {
            let changed = false;
            state.tasks.forEach(task => {
                if(task.status === 'Done') {
                    task.status = 'Archived';
                    changed = true;
                }
            });
            if (changed) {
                saveState();
                renderTasks();
            }
        }

        const setupDragAndDrop = () => {
            const cards = document.querySelectorAll('.task-card');
            const dropZones = document.querySelectorAll('.drop-zone');

            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    if (e.target.matches('button, a, input, .subtasks-board-container, .subtasks-board-container *')) { e.preventDefault(); return; }
                    draggedTaskId = e.currentTarget.dataset.taskId;
                    setTimeout(() => e.currentTarget.classList.add('dragging'), 0);
                });

                card.addEventListener('dragend', (e) => {
                    draggedTaskId = null;
                    e.currentTarget.classList.remove('dragging');
                    document.querySelectorAll('.drop-placeholder').forEach(p => p.remove());
                });
                
                card.addEventListener('click', (e) => {
                     if (!e.currentTarget.classList.contains('dragging') && !e.target.closest('.subtasks-board-container, .expand-subtasks-btn, .unarchive-from-board-btn')) {
                        const taskId = e.currentTarget.dataset.taskId;
                        openTaskModal(taskId);
                    }
                });
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                    const placeholder = document.querySelector('.drop-placeholder') || document.createElement('div');
                    placeholder.className = 'drop-placeholder';
                    const afterElement = getDragAfterElement(zone, e.clientY);
                    if (afterElement == null) {
                        zone.appendChild(placeholder);
                    } else {
                        zone.insertBefore(placeholder, afterElement.closest('.task-card-wrapper'));
                    }
                });

                zone.addEventListener('dragleave', (e) => { zone.classList.remove('drag-over'); });
                
                zone.addEventListener('drop', (e) => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    document.querySelectorAll('.drop-placeholder').forEach(p => p.remove());

    const newStatus = zone.dataset.status;
    const draggedTask = state.tasks.find(t => t.id === draggedTaskId);
    if (!draggedTask) return;

    // --- Start of Fix ---
    // This corrected logic handles reordering by updating the underlying data array.

    // 1. Find the original position of the task and remove it from the array.
    const originalIndex = state.tasks.findIndex(t => t.id === draggedTaskId);
    if (originalIndex > -1) {
        state.tasks.splice(originalIndex, 1);
    }

    // 2. Update the task's status and completion date if necessary.
    const oldStatus = draggedTask.status;
    draggedTask.status = newStatus;

    if ((oldStatus !== 'Done' && oldStatus !== 'Archived') && (newStatus === 'Done' || newStatus === 'Archived')) {
        draggedTask.completedAt = new Date().toISOString();
    } else if ((oldStatus === 'Done' || oldStatus === 'Archived') && (newStatus !== 'Done' && newStatus !== 'Archived')) {
        draggedTask.completedAt = null;
    }

    // 3. Find where to insert the task in the array based on the drop position.
    const afterElement = getDragAfterElement(zone, e.clientY);
    if (afterElement) {
        // If dropped before another task, find that task's index.
        const referenceTaskId = afterElement.dataset.taskId;
        const targetIndex = state.tasks.findIndex(t => t.id === referenceTaskId);
        if (targetIndex > -1) {
            // Insert the dragged task before the reference task.
            state.tasks.splice(targetIndex, 0, draggedTask);
        } else {
            state.tasks.push(draggedTask); // Fallback if target not found
        }
    } else {
        // If dropped at the bottom of the column, add it to the end of the array.
        state.tasks.push(draggedTask);
    }
    // --- End of Fix ---

    saveState();
    renderTaskBoard();
});
            });
        };
        
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        const setupCalendarDragAndDrop = () => {
            const container = DOMElements.tasks.content.querySelector('#calendar-scroll-container');
            if(!container) return;

            container.addEventListener('dragstart', e => {
                if (e.target.classList.contains('calendar-task-item')) {
                    calendarDraggedTaskId = e.target.dataset.taskId;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });

            container.addEventListener('dragend', e => {
                 if (e.target.classList.contains('calendar-task-item')) {
                    calendarDraggedTaskId = null;
                    e.target.classList.remove('dragging');
                }
            });

            container.addEventListener('dragover', e => {
                e.preventDefault(); 
            });

            container.addEventListener('drop', e => {
                e.preventDefault();
                if (!calendarDraggedTaskId) return;

                const task = state.tasks.find(t => t.id === calendarDraggedTaskId);
                if (!task) return;

                const grid = e.currentTarget.querySelector('.time-slot-grid');
                const gridRect = grid.getBoundingClientRect();
                const y = e.clientY - gridRect.top;
                
                const hour = Math.floor(y / 60);
                const minutes = roundToNearestMinutes((y % 60) / 60 * 60, { nearestTo: 15 });

                const newDueDate = set(parseISO(task.dueDate), { hours: hour, minutes: minutes });
                
                task.dueDate = newDueDate.toISOString();
                calendarDraggedTaskId = null;
                saveState();
                renderTaskCalendarView();
            });
        }
        
        // --- Time Tracking ---
        const calculateTotalTime = (task) => {
             if (!task.timeLog) return 0;
            return task.timeLog.reduce((total, log) => {
                const end = log.end ? parseISO(log.end) : new Date();
                try {
                    return total + (parseISO(log.start) ? (end - parseISO(log.start)) : 0);
                } catch(e) { return total; }
            }, 0);
        };
        
        const formatTime = (ms) => {
            if (ms <= 0) return '00:00:00';
            const duration = intervalToDuration({ start: 0, end: ms });
            const zeroPad = (num) => String(num).padStart(2, '0');
            const hours = (duration.days ? duration.days * 24 : 0) + (duration.hours || 0);
            return `${zeroPad(hours)}:${zeroPad(duration.minutes || 0)}:${zeroPad(duration.seconds || 0)}`;
        };

        const startTimerSession = (taskId, durationMins) => {
            if (state.activeSessionTimer) stopTimerSession(true); // Stop and save any previous timer

            const session = {
                taskId,
                startTime: Date.now(),
                durationMs: durationMins * 60 * 1000,
                isPaused: false,
                remainingMsOnPause: 0,
            };
            
            session.intervalId = setInterval(updateCountdownDisplay, 1000);
            state.activeSessionTimer = session;
            
            updateTimerControlsUI(taskId);
        };
        
        const stopTimerSession = (saveLog = true) => {
            const session = state.activeSessionTimer;
            if (!session) return;
        
            clearInterval(session.intervalId);
            const endTime = Date.now();
        
            if (saveLog) {
                const task = state.tasks.find(t => t.id === session.taskId);
                if (task) {
                    if (!task.timeLog) task.timeLog = [];
                    const timeToLog = {
                        start: new Date(session.startTime).toISOString(),
                        end: new Date(endTime).toISOString(),
                    };
                    task.timeLog.push(timeToLog);
                    saveState();
                    const totalTimeDisplay = document.getElementById('total-time-display');
                    if (totalTimeDisplay) {
                        totalTimeDisplay.textContent = formatTime(calculateTotalTime(task));
                    }
                }
            }
        
            const taskId = session.taskId;
            state.activeSessionTimer = null;
        
            // Clear display on board/list
             document.querySelectorAll(`[data-timer-for="${taskId}"]`).forEach(el => el.textContent = '');
             // Clear display in modal footer
             DOMElements.tasks.sessionTimerDisplay.textContent = '';
        
            updateTimerControlsUI(taskId);
            renderTasks();
        };

        const pauseTimerSession = () => {
            const session = state.activeSessionTimer;
            if (!session || session.isPaused) return;

            session.isPaused = true;
            const elapsed = Date.now() - session.startTime;
            session.remainingMsOnPause = Math.max(0, session.durationMs - elapsed);

            updateTimerControlsUI(session.taskId);
        }

        const resumeTimerSession = () => {
             const session = state.activeSessionTimer;
            if (!session || !session.isPaused) return;

            session.isPaused = false;
            session.durationMs = session.remainingMsOnPause; // The new duration is the time that was left
            session.startTime = Date.now(); // Start new countdown from now
            session.remainingMsOnPause = 0;

            updateTimerControlsUI(session.taskId);
        }

        const updateCountdownDisplay = () => {
            const session = state.activeSessionTimer;
            if (!session) return;
            
            let remainingMs;
            if (session.isPaused) {
                remainingMs = session.remainingMsOnPause;
            } else {
                 const elapsed = Date.now() - session.startTime;
                 remainingMs = Math.max(0, session.durationMs - elapsed);
            }
            
            const display = `⏳ ${formatTime(remainingMs)}`;
            
            // Update display in modal footer if open
            if (DOMElements.tasks.detailModal.style.display === 'flex' && state.taskToDelete === session.taskId) {
                DOMElements.tasks.sessionTimerDisplay.textContent = display;
            }
            // Update display on board/list view
            document.querySelectorAll(`[data-timer-for="${session.taskId}"]`).forEach(el => el.textContent = display);

            if (remainingMs === 0 && !session.isPaused) {
                stopTimerSession(true);
            }
        };
        
        const updateTimerControlsUI = (taskId) => {
            const modal = DOMElements.tasks.detailModalBody;
            if (!modal) return;
            
            const controlsContainer = modal.querySelector('#session-timer-controls');
            if(!controlsContainer) return;

            const session = state.activeSessionTimer;
            let html = '';

            if(session && session.taskId === taskId) {
                // Timer is active for this task
                if (session.isPaused) {
                     html = `
                        <p class="text-center text-sm font-semibold">Session Paused</p>
                        <div class="flex items-center gap-2">
                            <button id="session-resume-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-sm">Resume</button>
                            <button id="session-stop-btn" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm">Stop & Save</button>
                        </div>
                    `;
                } else {
                    html = `
                        <p class="text-center text-sm font-semibold">Session in Progress</p>
                        <div class="flex items-center gap-2">
                            <button id="session-pause-btn" class="w-full px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold text-sm">Pause</button>
                             <button id="session-stop-btn" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold text-sm">Stop & Save</button>
                        </div>
                    `;
                }

            } else {
                // No active timer for this task, show start controls
                const inputStyling = "text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400";
                html = `
                    <p class="text-center text-sm font-semibold">Start a Timed Session</p>
                    <div class="flex justify-center gap-2">
                        <button data-mins="15" class="session-preset-btn text-sm px-3 py-1 bg-gray-200 dark:bg-slate-700 rounded-md">15m</button>
                        <button data-mins="30" class="session-preset-btn text-sm px-3 py-1 bg-gray-200 dark:bg-slate-700 rounded-md">30m</button>
                        <button data-mins="45" class="session-preset-btn text-sm px-3 py-1 bg-gray-200 dark:bg-slate-700 rounded-md">45m</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" id="session-custom-mins" placeholder="Custom" class="w-full px-2 py-1 bg-white dark:bg-slate-900 border-gray-300 dark:border-dark-border border rounded-md text-sm ${inputStyling}">
                        <span class="text-sm dark:text-dark-text-secondary">min</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="session-start-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold text-sm">Start Session</button>
                    </div>
                `;
            }
            controlsContainer.innerHTML = html;
        }

        const renderTheme = () => {
            DOMElements.html.classList.toggle('dark', state.theme === 'dark');
            const themeIcon = state.theme === 'dark' ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`;
            
            DOMElements.themeToggle.innerHTML = themeIcon;
            if (DOMElements.mobileMenu.mobileThemeToggle) {
                DOMElements.mobileMenu.mobileThemeToggle.innerHTML = themeIcon;
            }

            updateActivePage();
        };

        const renderBusinessBreakdown = (data) => {
            const breakdown = data.reduce((acc, e) => {
                if(!e.business) return acc;
                if(!acc[e.business]) acc[e.business] = { revenue: 0, expenses: 0 };
                if (e.type === 'revenue') {
                    acc[e.business].revenue += e.amount;
                    acc[e.business].expenses += (e.fulfillmentExpense || 0);
                }
                if (e.type === 'expense') {
                    acc[e.business].expenses += e.amount;
                }
                return acc;
            }, {});
            let content = `<h3 class="text-md font-bold mb-2">Business Summary</h3><div class="space-y-2 overflow-y-auto max-h-24 pr-4 text-sm">`;
            const sortedBusinesses = Object.entries(breakdown).sort((a,b) => b[1].revenue - a[1].revenue);
            content += sortedBusinesses.length ? sortedBusinesses.map(([b,d]) => `<div><p class="font-semibold text-gray-700 dark:text-gray-300">${b}</p><div class="flex justify-between text-xs"><span class="text-green-500">Rev: ${formatCurrency(d.revenue)}</span><span class="text-red-500">Exp: ${formatCurrency(d.expenses)}</span></div></div>`).join('') : `<p class="dark:text-dark-text-secondary">No data.</p>`;
            DOMElements.businessBreakdownContainer.innerHTML = content + `</div>`;
        };
        
        const renderTransactionTable = (data) => {
            const tableContainer = DOMElements.transactionTableContainer;
            if (!tableContainer.querySelector('table')) {
                tableContainer.innerHTML = `
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h2 class="text-xl font-bold">Recent Activity</h2>
                        <div class="relative flex-1 min-w-[240px] max-w-md">
                            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                            <input id="search-input" type="text" placeholder="Search transactions..." class="w-full pl-10 pr-4 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-200 dark:border-dark-border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div id="table-tabs" class="flex items-center border border-gray-200 dark:border-dark-border rounded-lg p-1 space-x-1">${['all', 'revenue', 'expense'].map(t => `<button class="table-tab-btn" data-tab="${t}">${t.charAt(0).toUpperCase() + t.slice(1)}</button>`).join('')}</div>
                    </div>
                    <div class="overflow-x-auto"><table class="w-full text-left"><thead id="table-head"></thead><tbody id="table-body"></tbody></table></div>`;
                tableContainer.querySelector('#search-input').addEventListener('input', handleSearch);
                tableContainer.querySelector('#table-tabs').addEventListener('click', handleTabClick);
                tableContainer.querySelector('#table-head').addEventListener('click', handleSortClick);
            }
            tableContainer.querySelectorAll('.table-tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === state.ui.activeTableTab));
            
            const { key, order } = state.ui.sort;
            const renderHeader = (k, t) => { const isCurr = key===k; return `<th class="p-3 font-semibold sortable ${isCurr ? `sort-${order}` : ''}" data-sort-key="${k}"><span class="flex items-center gap-2">${t}<span class="sort-indicator">${isCurr&&order==='asc'?'▲':'▼'}</span></span></th>`; };
            tableContainer.querySelector('#table-head').innerHTML = `<tr class="text-sm dark:text-dark-text-secondary border-b dark:border-dark-border">${renderHeader('itemName', 'Customer/Item')}${renderHeader('amount', 'Amount')}${renderHeader('netProfit', 'Net Profit')}${renderHeader('netMargin', 'Net Margin')}${renderHeader('date', 'Date')}${renderHeader('status', 'Status')}<th class="p-3 font-semibold">Actions</th></tr>`;
            
            const query = state.ui.searchQuery.toLowerCase();
            const filtered = data.filter(e => 
                (state.ui.activeTableTab === 'all' || e.type === state.ui.activeTableTab) && 
                (!query || [e.itemName,e.business,e.customerSource,e.status,e.sector].join(' ').toLowerCase().includes(query))
            );
            const sorted = filtered.sort((a,b) => {
                let valA, valB;
                if (key === 'netProfit') { valA = a.type==='revenue' ? a.amount - (a.fulfillmentExpense || 0) : -Infinity; valB = b.type==='revenue' ? b.amount - (b.fulfillmentExpense || 0) : -Infinity; }
                else if (key === 'netMargin') { valA = a.type==='revenue' && a.amount > 0 ? (a.amount-(a.fulfillmentExpense || 0)) / a.amount : -Infinity; valB = b.type==='revenue' && b.amount > 0 ? (b.amount - (b.fulfillmentExpense || 0)) / b.amount : -Infinity; }
                else { valA = a[key]; valB = b[key]; }
                return (valA < valB ? -1 : valA > valB ? 1 : 0) * (order === 'asc' ? 1 : -1);
            });
            
            const tbody = tableContainer.querySelector('#table-body');
            tbody.innerHTML = sorted.length ? sorted.map(renderTransactionRow).join('') : `<tr><td colspan="7" class="text-center p-8 dark:text-dark-text-secondary">No matching transactions in this date range.</td></tr>`;
            tbody.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', handleDeleteClick));
        };
        
        const renderTransactionRow = (entry) => {
            const statusColors = {'Recurring':'bg-green-500/10 text-green-400','New Customer':'bg-blue-500/10 text-blue-400','Warm Lead':'bg-yellow-500/10 text-yellow-400','Actual':'bg-gray-500/10 text-gray-400'};
            const avatarColor = (name='X') => ['bg-blue-500','bg-green-500','bg-purple-500','bg-red-500','bg-yellow-500', 'bg-pink-500'][name.charCodeAt(0) % 6];
            const netProfit = entry.type==='revenue' ? entry.amount - (entry.fulfillmentExpense || 0) : null;
            const netMargin = netProfit !== null && entry.amount > 0 ? (netProfit / entry.amount) : null;
            
            return `<tr class="border-b dark:border-dark-border hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors">
                <td class="p-3"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-white font-bold ${avatarColor(entry.itemName)}">${(entry.itemName||'X').charAt(0).toUpperCase()}</div><div><div class="font-bold">${entry.itemName}</div><div class="text-sm dark:text-dark-text-secondary">${entry.business || ''}${entry.customerSource && entry.customerSource!=='N/A' ? ` | ${entry.customerSource}`:''}</div></div></div></td>
                <td class="p-3 font-bold ${entry.type === 'revenue' ? 'text-green-400' : 'text-red-400'}">${formatCurrency(entry.amount)}</td>
                <td class="p-3 dark:text-dark-text-secondary">${netProfit!==null?formatCurrency(netProfit):'N/A'}</td>
                <td class="p-3 dark:text-dark-text-secondary">${netMargin!==null?formatPercent(netMargin):'N/A'}</td>
                <td class="p-3 dark:text-dark-text-secondary">${format(entry.dateObj, 'MMM d, yy')}</td>
                <td class="p-3"><span class="px-2.5 py-1 text-xs font-semibold rounded-full ${statusColors[entry.status] || 'bg-gray-500/10 text-gray-400'}">${entry.status}</span></td>
                <td class="p-3"><button class="text-gray-400 hover:text-red-500 delete-btn" data-id="${entry.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></td></tr>`;
        };
        
        const renderModalForm = () => {
            const type = state.ui.activeModalForm;
            DOMElements.addEntryModal.typeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.type === type));
            const base = "mt-1 block w-full px-3 py-2 bg-gray-100 dark:bg-slate-800 border border-gray-300 dark:border-dark-border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 sm:text-sm text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400";
            const field = (n, l, o={}) => {
                const {t='text', p='', note='', span='md:col-span-1'} = o;
                const label = `<label for="${n}" class="block text-sm font-medium dark:text-dark-text-secondary">${l}</label>${note?`<p class="text-xs text-gray-500">${note}</p>`:''}`;
                if (t==='select') return `<div class="${span}">${label}<select name="${n}" id="${n}" class="${base}">${o.choices.map(c=>`<option value="${c}">${c}</option>`).join('')}</select></div>`;
                if (t==='textarea') return `<div class="${span}">${label}<textarea name="${n}" id="${n}" rows="2" class="${base}" placeholder="${p}"></textarea></div>`;
                return `<div class="${span}">${label}<input type="${t}" name="${n}" id="${n}" class="${base}" placeholder="${p}" ${t==='date'?`value="${format(new Date(),'yyyy-MM-dd')}"`:''} ${o.list?`list="${o.list}"`:''} required></div>`;
            };
            const common = `${field('date','Date',{t:'date'})}${field('amount','Amount ($)',{t:'number',p:'1500.00'})}`;
            const revenue = `${field('itemName','Customer Name',{p:'John Doe'})}${field('business','Business',{p:'Web Design'})}${field('fulfillmentExpense','Fulfillment Cost ($)',{t:'number',p:'250.00'})}${field('sector','Sector/Tag',{p:'Services',list:'tags-datalist'})}${field('customerSource','Source',{p:'Referral'})}${field('status','Status',{t:'select',choices:['New Customer','Warm Lead','Recurring','N/A']})}`;
            const expense = `${field('itemName','Item/Service',{p:'Office Supplies'})}${field('business','Category',{p:'Software, Overhead'})}${field('sector','Tag',{p:'Tools, Marketing',list:'tags-datalist'})}${field('status','Status',{t:'select',choices:['Actual','Recurring','N/A']})}`;
            const fields = type==='revenue' ? `${common}${revenue}` : `${common}${expense}`;
            DOMElements.addEntryModal.form.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${fields}${field('notes','Notes',{t:'textarea',p:'Optional details...',span:'md:col-span-2'})}</div><div class="flex justify-end space-x-3 pt-4"><button type="button" class="modal-cancel px-5 py-2.5 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 dark:bg-dark-border dark:text-dark-text-primary dark:hover:bg-gray-600 font-semibold">Cancel</button><button type="submit" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Save Transaction</button></div>`;
            DOMElements.addEntryModal.form.querySelector('.modal-cancel').addEventListener('click', () => toggleModal(DOMElements.addEntryModal.modal, false));
        };
        
        const switchPage = (pageId) => {
            if (pageId === 'calendar') {
                state.ui.activeTaskView = 'calendar';
                state.ui.activePage = 'tasks';
            } else {
                 state.ui.activePage = pageId;
            }
            updateActivePage();
        };

        const updateActivePage = () => {
            Object.values(DOMElements.pages).forEach(page => page.classList.remove('active'));
            if (DOMElements.pages[state.ui.activePage]) {
                DOMElements.pages[state.ui.activePage].classList.add('active');
            }
            DOMElements.sidebarLinks.forEach(link => {
                const page = link.dataset.page;
                const isActive = (page === state.ui.activePage) || (page === 'tasks' && state.ui.activeTaskView === 'calendar' && page === 'tasks');
                link.classList.toggle('bg-blue-100', isActive);
                link.classList.toggle('dark:bg-blue-500/20', isActive);
                link.classList.toggle('text-blue-600', isActive);
                link.classList.toggle('dark:text-blue-400', isActive);
                link.classList.toggle('text-gray-500', !isActive);
                link.classList.toggle('hover:bg-gray-100', !isActive);
                link.classList.toggle('dark:hover:bg-gray-700/50', !isActive);
            });

            Object.values(state.chartInstances).forEach(chart => chart.destroy());
            state.chartInstances = {};

            if (state.ui.activePage === 'tasks') {
                renderTasks();
            } else {
                renderDashboard();
            }
        };

        // --- Event Handlers ---
        const toggleTheme = () => { 
            state.theme = state.theme === 'light' ? 'dark' : 'light'; 
            saveState();
            renderTheme(); 
        };
        const handleTabClick = (e) => { if (e.target.matches('[data-tab]')) { state.ui.activeTableTab = e.target.dataset.tab; renderDashboard(); }};
        const handleSortClick = (e) => {
            const th = e.target.closest('[data-sort-key]'); if(!th) return;
            const newKey = th.dataset.sortKey;
            state.ui.sort.order = state.ui.sort.key === newKey && state.ui.sort.order === 'desc' ? 'asc' : 'desc';
            state.ui.sort.key = newKey; renderDashboard();
        };
        const handleDeleteClick = (e) => {
            state.itemToDelete = e.target.closest('[data-id]').dataset.id;
            toggleModal(DOMElements.deleteModal.modal, true);
        };
        const confirmDelete = () => {
            state.entries = state.entries.filter(e => e.id !== state.itemToDelete);
            state.itemToDelete = null;
            toggleModal(DOMElements.deleteModal.modal, false);
            renderDashboard();
            saveState();
        };
        const handleFormSubmit = (e) => {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            if (!data.amount || !data.itemName) {
                DOMElements.addEntryModal.error.textContent = 'Please fill out at least the name and amount fields.';
                DOMElements.addEntryModal.error.classList.remove('hidden');
                return;
            }
            const newEntry = {
                id: crypto.randomUUID(),
                type: state.ui.activeModalForm,
                ...data,
                amount: parseFloat(data.amount),
                fulfillmentExpense: parseFloat(data.fulfillmentExpense || 0),
                dateObj: parseISO(data.date)
            };
            if (newEntry.type === 'expense') {
                newEntry.customerSource = 'N/A';
                newEntry.fulfillmentExpense = 0;
            }
            state.entries.unshift(newEntry);
            const newRangeStart = startOfMonth(newEntry.dateObj);
            const newRangeEnd = endOfMonth(newEntry.dateObj);
            state.ui.dateRange = { start: newRangeStart, end: newRangeEnd };
            const now = new Date();
            if (isSameDay(newRangeStart, startOfMonth(now)) && isSameDay(newRangeEnd, endOfMonth(now))) {
                state.ui.activeDatePreset = 'month';
            } else {
                state.ui.activeDatePreset = null;
            }
            if (pickerInstance) {
                pickerInstance.setDateRange(newRangeStart, newRangeEnd);
            }
            updateActiveDatePresetButtons();
            toggleModal(DOMElements.addEntryModal.modal, false);
            form.reset();
            renderDashboard();
            saveState();
        };
        const handleSearch = (e) => { state.ui.searchQuery = e.target.value; renderDashboard(); };
        const toggleModal = (modal, show) => {
            if (!modal) return;
            modal.style.display = show ? 'flex' : 'none';
            if(show && modal.id === 'add-entry-modal'){
                DOMElements.addEntryModal.error.classList.add('hidden');
                renderModalForm();
            }
        };
        
        const updateActiveDatePresetButtons = () => {
            DOMElements.datePresetsContainer.querySelectorAll('.date-preset-btn').forEach(btn => {
                const isActive = btn.dataset.range === state.ui.activeDatePreset;
                btn.classList.toggle('bg-white', isActive);
                btn.classList.toggle('dark:bg-slate-800', isActive);
                btn.classList.toggle('shadow-sm', isActive);
                btn.classList.toggle('text-gray-900', isActive);
                btn.classList.toggle('dark:text-white', isActive);
                btn.classList.toggle('text-gray-600', !isActive);
                btn.classList.toggle('dark:text-dark-text-secondary', !isActive);
            });
        };
        
        const handleDatePresetClick = (picker) => (e) => {
            const button = e.target.closest('.date-preset-btn');
            if (!button) return;

            const range = button.dataset.range;
            const now = new Date();
            let start, end;

            switch(range) {
                case 'day': start = startOfDay(now); end = endOfDay(now); break;
                case 'week': start = startOfWeek(now, { weekStartsOn: 1 }); end = endOfWeek(now, { weekStartsOn: 1 }); break;
                case 'month': start = startOfMonth(now); end = endOfMonth(now); break;
                default: return;
            }

            state.ui.dateRange = { start, end };
            state.ui.activeDatePreset = range;
            picker.setDateRange(start, end);
            updateActiveDatePresetButtons();
            renderDashboard();
        }

        const handleExportData = () => {
            const dataToExport = JSON.stringify({ entries: state.entries.map(({dateObj, ...rest}) => rest), theme: state.theme }, null, 2);
            const blob = new Blob([dataToExport], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `financial-backup-${format(new Date(), 'yyyy-MM-dd')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const handleImportData = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedState = JSON.parse(e.target.result);
                    if (!importedState.entries) { throw new Error('Invalid backup file structure.'); }
                    
                    state.entries = (importedState.entries || []).map(entry => ({...entry, dateObj: parseISO(entry.date)}));
                    state.theme = importedState.theme || 'light';

                    updateActivePage();
                    saveState();
                    alert('Financial data imported successfully!');
                } catch (error) {
                    console.error('Failed to import data:', error);
                    alert(`Import failed: ${error.message}`);
                }
            };
            reader.onerror = () => alert('Failed to read the file.');
            reader.readAsText(file);
            event.target.value = '';
        };

         const handleExportTasks = () => {
            const dataToExport = JSON.stringify({ tasks: state.tasks, projects: state.projects }, null, 2);
            const blob = new Blob([dataToExport], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tasks-backup-${format(new Date(), 'yyyy-MM-dd')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        const handleImportTasks = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!importedData.tasks || !importedData.projects) {
                        throw new Error('Invalid task backup file. It must contain "tasks" and "projects".');
                    }
                    
                    state.tasks = importedData.tasks;
                    state.projects = importedData.projects;

                    renderTasks();
                    saveState();
                    alert('Tasks imported successfully!');
                } catch (error) {
                    console.error('Failed to import tasks:', error);
                    alert(`Task import failed: ${error.message}`);
                }
            };
            reader.onerror = () => alert('Failed to read the file.');
            reader.readAsText(file);
            event.target.value = '';
        };

        const processRecurringEntries = () => {
            const lastCheck = localStorage.getItem('lastRecurringCheck-v27');
            if (lastCheck && isSameDay(parseISO(lastCheck), new Date())) return false;

            const now = new Date();
            const recurringEntries = state.entries.filter(e => e.status === 'Recurring');
            const newEntries = [];
            const groups = recurringEntries.reduce((acc, entry) => {
                const key = `${entry.itemName}-${entry.business}-${entry.type}`;
                if (!acc[key]) acc[key] = [];
                acc[key].push(entry);
                return acc;
            }, {});

            Object.values(groups).forEach(group => {
                const latestEntry = group.sort((a,b) => b.dateObj - a.dateObj)[0];
                if (!isSameMonth(latestEntry.dateObj, now)) {
                    let newDate = addMonths(latestEntry.dateObj, 1);
                    if (isAfter(newDate, now)) return;
                    const newEntry = {...latestEntry, id: crypto.randomUUID(), date: format(newDate, 'yyyy-MM-dd'), dateObj: newDate, status: 'Recurring'};
                    newEntries.push(newEntry);
                }
            });

            if (newEntries.length > 0) {
                state.entries.unshift(...newEntries);
                return true;
            }
            return false;
        };

        const toggleMobileMenu = () => {
            DOMElements.sidebar.classList.toggle('-translate-x-full');
            DOMElements.mobileMenu.overlay.classList.toggle('hidden');
        };
        
        const init = () => {
            loadState();
            
            DOMElements.themeToggle.addEventListener('click', toggleTheme);
            DOMElements.addEntryButton.addEventListener('click', () => toggleModal(DOMElements.addEntryModal.modal, true));
            DOMElements.addEntryModal.closeButton.addEventListener('click', () => toggleModal(DOMElements.addEntryModal.modal, false));
            DOMElements.addEntryModal.typeButtons.forEach(btn => btn.addEventListener('click', (e) => {
                if(e.target.matches('[data-type]')){ state.ui.activeModalForm = e.target.dataset.type; renderModalForm(); }
            }));
            DOMElements.addEntryModal.form.addEventListener('submit', handleFormSubmit);
            
            DOMElements.deleteModal.confirmButton.addEventListener('click', confirmDelete);
            DOMElements.deleteModal.cancelButton.addEventListener('click', () => toggleModal(DOMElements.deleteModal.modal, false));
            
            DOMElements.moveTaskModal.cancelButton.addEventListener('click', () => toggleModal(DOMElements.moveTaskModal.modal, false));

            DOMElements.sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchPage(link.dataset.page);
                    if (window.innerWidth < 768) toggleMobileMenu();
                });
            });

            DOMElements.mobileMenu.button.addEventListener('click', toggleMobileMenu);
            DOMElements.mobileMenu.overlay.addEventListener('click', toggleMobileMenu);
            DOMElements.mobileMenu.mobileThemeToggle.addEventListener('click', toggleTheme);
            DOMElements.mobileMenu.mobileAddEntryButton.addEventListener('click', () => {
                 if (state.ui.activePage === 'tasks') {
                    openTaskModal();
                } else {
                    toggleModal(DOMElements.addEntryModal.modal, true);
                }
            });
            
            DOMElements.tasks.addTaskButton.addEventListener('click', () => openTaskModal());
            DOMElements.tasks.detailModalClose.addEventListener('click', closeTaskModal);
            DOMElements.tasks.deleteTaskButton.addEventListener('click', deleteTask);
            DOMElements.tasks.unarchiveTaskButton.addEventListener('click', unarchiveTask);
            DOMElements.tasks.exportTasksButton.addEventListener('click', handleExportTasks);
            DOMElements.tasks.importTasksButton.addEventListener('click', () => DOMElements.tasks.importTasksInput.click());
            DOMElements.tasks.importTasksInput.addEventListener('change', handleImportTasks);


            DOMElements.tasks.viewSwitcher.addEventListener('click', (e) => {
                const view = e.target.dataset.view;
                if(view) {
                    state.ui.activeTaskView = view;
                    state.ui.expandedListTasks = {};
                    renderTasks();
                }
            });

            DOMElements.tasks.detailModalBody.addEventListener('click', e => {
                 const taskId = state.taskToDelete;
                 if(!taskId) return;

                 if (e.target.id === 'session-start-btn') {
                    const customMins = parseInt(DOMElements.tasks.detailModalBody.querySelector('#session-custom-mins').value, 10);
                    if (customMins > 0) {
                        startTimerSession(taskId, customMins);
                    }
                 } else if (e.target.matches('.session-preset-btn')) {
                     const mins = parseInt(e.target.dataset.mins, 10);
                     DOMElements.tasks.detailModalBody.querySelector('#session-custom-mins').value = mins;
                 } else if (e.target.id === 'session-pause-btn') {
                     pauseTimerSession();
                 } else if (e.target.id === 'session-resume-btn') {
                     resumeTimerSession();
                 } else if (e.target.id === 'session-stop-btn') {
                     stopTimerSession(true);
                 }
            });
            
            // Delegated event listeners for dynamic content
            DOMElements.tasks.content.addEventListener('click', e => {
                // Click on time slot to create task
                const timeSlot = e.target.closest('.time-slot');
                if (timeSlot) {
                    const hour = parseInt(timeSlot.dataset.hour, 10);
                    const newDate = set(state.ui.currentCalendarDate, { hours: hour, minutes: 0, seconds: 0, milliseconds: 0 });
                    openTaskModal(null, newDate);
                    return;
                }
                const calendarItem = e.target.closest('.calendar-task-item, .all-day-task-item, .month-task-item');
                if (calendarItem) {
                     openTaskModal(calendarItem.dataset.taskId);
                     return;
                }
                 const dayCell = e.target.closest('.calendar-day-cell');
                 if(dayCell) {
                     state.ui.currentCalendarDate = parseISO(dayCell.dataset.date);
                     state.ui.activeCalendarView = 'day';
                     renderTaskCalendarView();
                 }
                
                const todoFilterBtn = e.target.closest('.todo-filter-btn');
                if (todoFilterBtn) {
                    state.ui.todoFilter = todoFilterBtn.dataset.filter;
                    renderTaskBoard();
                     return;
                }

                 const archiveAllBtn = e.target.closest('#archive-all-done-btn');
                if(archiveAllBtn) {
                    archiveAllDoneTasks();
                    return;
                }

                const viewArchivedBtn = e.target.closest('#view-archived-btn');
                if(viewArchivedBtn) {
                    state.ui.showArchived = !state.ui.showArchived;
                    renderTaskBoard();
                    return;
                }

                 const unarchiveBoardBtn = e.target.closest('.unarchive-from-board-btn');
                 if(unarchiveBoardBtn) {
                    e.stopPropagation();
                    const taskId = unarchiveBoardBtn.dataset.taskId;
                    const task = state.tasks.find(t => t.id === taskId);
                    if(task) {
                        task.status = 'Done';
                        saveState();
                        renderTaskBoard();
                    }
                    return;
                 }


                const expandSubtasksBtn = e.target.closest('.expand-subtasks-btn');
                if (expandSubtasksBtn) {
                    const taskId = expandSubtasksBtn.dataset.taskId;
                    state.ui.expandedBoardTasks[taskId] = !state.ui.expandedBoardTasks[taskId];
                    const container = expandSubtasksBtn.closest('.task-card').querySelector('.subtasks-board-container');
                    container.classList.toggle('expanded');
                    expandSubtasksBtn.classList.toggle('expanded');
                     return;
                }
                
                const efficiencyRow = e.target.closest('.efficiency-row');
                if (efficiencyRow) {
                    openTaskModal(efficiencyRow.dataset.taskId);
                     return;
                }
            });
            
            // Add listeners for calendar drag/drop after it's rendered
            const observer = new MutationObserver((mutations) => {
              for (const mutation of mutations) {
                if (mutation.addedNodes.length > 0) {
                   if (DOMElements.tasks.content.querySelector('#calendar-scroll-container')) {
                    setupCalendarDragAndDrop();
                    // Do not disconnect, as view can change
                  }
                }
              }
            });
            observer.observe(DOMElements.tasks.content, { childList: true, subtree: true });


            DOMElements.tasks.content.addEventListener('change', e => {
                const target = e.target;
                if (target.matches('.subtask-checkbox-list') || target.matches('.subtask-checkbox-board')) {
                    const taskId = target.dataset.taskId;
                    const subtaskId = target.dataset.subtaskId;
                    const task = state.tasks.find(t => t.id === taskId);
                    if (task && task.subtasks) {
                        const subtask = task.subtasks.find(st => st.id === subtaskId);
                        if (subtask) {
                            subtask.done = target.checked;
                            saveState();
                            if(state.ui.activeTaskView === 'board') {
                                renderTaskBoard();
                            } else {
                                const span = target.nextElementSibling;
                                if (span) {
                                    span.classList.toggle('line-through', target.checked);
                                    span.classList.toggle('text-gray-500', target.checked);
                                }
                            }
                        }
                    }
                }
            });
            
            DOMElements.exportDataButton.addEventListener('click', handleExportData);
            DOMElements.importData.button.addEventListener('click', () => DOMElements.importData.input.click());
            DOMElements.importData.input.addEventListener('change', handleImportData);
            
            pickerInstance = new Litepicker({ 
                element: DOMElements.dateRangePicker,
                singleMode: false,
                numberOfMonths: 2,
                format: 'MMM D, yyyy',
                startDate: state.ui.dateRange.start,
                endDate: state.ui.dateRange.end,
                setup: (picker) => {
                    picker.on('selected', (date1, date2) => {
                        state.ui.dateRange = { start: startOfDay(date1.dateInstance), end: endOfDay(date2.dateInstance) };
                        state.ui.activeDatePreset = null;
                        updateActiveDatePresetButtons();
                        renderDashboard();
                    });
                }
            });

            DOMElements.datePresetsContainer.addEventListener('click', handleDatePresetClick(pickerInstance));

            if (processRecurringEntries()) {
                saveState();
            }

            renderTheme();
            DOMElements.loader.style.display = 'none';
            DOMElements.dashboardContent.classList.remove('hidden');
        };

        init();
    })();
    </script>
</body>
</html>
