<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reputifly | Visual Workspace</title>
    
    <link rel="icon" type="image/png" href="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            --bg-main: #0B0A14;
            --accent-primary: #E6397F;
            --accent-secondary: #FF8A00;
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(20, 20, 30, 0.7);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* --- LIQUID GLOW BUTTONS --- */
        .liquid-glow {
            background: radial-gradient(circle at top, rgba(255,255,255,0.4) 0%, transparent 60%),
                        linear-gradient(90deg, #E6397F, #FF8A00);
            box-shadow: 
                0 6px 20px rgba(230, 57, 127, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            border: none;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            color: white;
            font-weight: 700;
            border-radius: 9999px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer;
        }
        .liquid-glow:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 15px 30px rgba(255, 138, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }
        .liquid-glow.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

        .btn-glass { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #ccc; 
            border-radius: 9999px; transition: all 0.2s ease; font-weight: 600; font-size: 13px;
            display: flex; align-items: center; gap: 6px; padding: 0 18px; cursor: pointer;
        }
        .btn-glass:hover { 
            background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.3); 
        }

        /* --- INPUTS --- */
        .input-dark {
            background: #050505; 
            border: 1px solid rgba(255,255,255,0.15);
            color: white; 
            border-radius: 12px;
            padding: 14px 18px; 
            width: 100%;
            font-family: 'Inter', sans-serif; 
            font-size: 13px;
            outline: none; 
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        .input-dark:focus { 
            border-color: var(--accent-primary); 
            box-shadow: 0 0 0 1px rgba(230, 57, 127, 0.5), inset 0 2px 4px rgba(0,0,0,0.5);
        }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(5, 5, 8, 0.95); backdrop-filter: blur(10px);
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-card {
            background: #121218; 
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px; 
            padding: 40px; 
            width: 90%; max-width: 420px;
            text-align: center;
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.8);
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-overlay.active .modal-card { transform: scale(1); }

        .icon-circle {
            width: 64px; height: 64px; 
            background: rgba(255,255,255,0.03); 
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 24px auto;
        }

        /* --- NAV CAPSULE & TOGGLES --- */
        .nav-capsule {
            position: absolute; top: 24px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 1000px; height: 68px;
            background: rgba(20, 20, 30, 0.85); backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border); border-radius: 9999px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 50; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease;
        }
        
        /* Hidden State */
        .nav-capsule.nav-hidden {
            transform: translateX(-50%) translateY(-150%);
            opacity: 0; pointer-events: none;
        }

        .toggle-btn {
            position: absolute; top: 24px; z-index: 60;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(20, 20, 30, 0.9); border: 1px solid rgba(255,255,255,0.1);
            color: white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: all 0.2s ease; opacity: 0.7;
        }
        .toggle-btn:hover { opacity: 1; transform: scale(1.1); background: #E6397F; border-color: #E6397F; }
        
        #navToggleBtn { right: 24px; }
        #mobileToggleBtn { right: 74px; }

        /* Loader */
        .loader { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .pulse-ring {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            border: 1px solid var(--accent-primary); opacity: 0;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
    </style>
</head>
<body>

    <button id="mobileToggleBtn" class="toggle-btn" onclick="toggleMobileView()" title="Toggle Mobile View">
        <i data-feather="smartphone" class="w-5 h-5"></i>
    </button>
    <button id="navToggleBtn" class="toggle-btn" onclick="toggleHeader()" title="Show/Hide Header">
        <i data-feather="eye" class="w-5 h-5"></i>
    </button>

    <div id="setupScreen" class="modal-overlay active" style="z-index: 200;">
        <div class="modal-card">
            <div class="icon-circle relative">
                <div class="pulse-ring"></div>
                <i data-feather="globe" class="w-8 h-8 text-pink-500 relative z-10"></i>
            </div>
            
            <h1 class="text-2xl font-bold font-['Space_Grotesk'] mb-3 text-white">Project Setup</h1>
            <p class="text-gray-400 text-sm mb-8 leading-relaxed px-2">
                Enter the <strong>exact URL</strong> you are currently working on (e.g. your staging link). This ensures images load correctly.
            </p>
            
            <div class="text-left mb-8">
                <label class="text-[10px] uppercase font-bold text-gray-500 mb-2 block ml-1 tracking-wider">Website Domain</label>
                <input type="text" id="domainInput" class="input-dark" placeholder="e.g. staging.client-site.com">
            </div>

            <button onclick="finishSetup()" class="liquid-glow w-full py-4 text-sm shadow-lg">
                Start Project <i data-feather="arrow-right" class="w-4 h-4 ml-1"></i>
            </button>
            
            <button onclick="clearStorage()" class="mt-4 text-[10px] text-gray-600 hover:text-red-500 transition-colors">
                Reset Saved Data
            </button>
        </div>
    </div>

    <nav class="nav-capsule" id="mainHeader">
        <div class="flex items-center gap-4">
            <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png" class="h-6 w-auto brightness-125">
            <div class="h-4 w-px bg-white/10 hidden md:block"></div>
            <span class="text-xs font-bold text-gray-500 font-mono hidden md:block truncate max-w-[150px]" id="domainDisplay">...</span>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="document.getElementById('fileInput').click()" class="btn-glass h-10">
                <i data-feather="layout" class="w-4 h-4"></i> <span class="hidden sm:inline">Load HTML</span>
            </button>
            <button onclick="downloadProject()" id="saveBtn" class="liquid-glow h-10 px-5 text-xs disabled">
                <i data-feather="download-cloud" class="w-4 h-4"></i> <span class="hidden sm:inline">Download Zip</span>
            </button>
        </div>
    </nav>

    <div id="editor-frame-container" style="flex: 1; position: relative; width: 100%; height: 100%; transition: all 0.3s ease;">
        <div id="empty-state" class="absolute inset-0 z-10 bg-[#0B0A14] flex flex-col items-center justify-center">
            <div class="icon-circle mb-4">
                <i data-feather="code" class="w-8 h-8 text-gray-500"></i>
            </div>
            <h2 class="text-xl font-bold mb-2">No Page Loaded</h2>
            <p class="text-gray-500 text-sm mb-6">Upload your HTML template to begin.</p>
        </div>
        <iframe id="editorFrame" style="width: 100%; height: 100%; border: none; display: block; background: white; transition: all 0.3s ease;"></iframe>
    </div>

    <div class="modal-overlay" id="imageModal" onclick="closeModal('imageModal', event)">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold font-['Space_Grotesk']">Change Image</h3>
                <button onclick="closeModal('imageModal')" class="text-gray-500 hover:text-white"><i data-feather="x" class="w-5 h-5"></i></button>
            </div>

            <div class="border-2 border-dashed border-white/10 rounded-2xl p-8 hover:bg-white/5 hover:border-pink-500/50 cursor-pointer transition-all mb-6 group" onclick="document.getElementById('imgUpload').click()" id="dropZone">
                <div id="dropContent">
                    <div class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                        <i data-feather="image" class="w-6 h-6 text-pink-500"></i>
                    </div>
                    <p class="text-sm font-bold text-white">Upload File</p>
                    <p class="text-[10px] text-gray-400 mt-1">Auto-converts to WebP</p>
                </div>
            </div>

            <div class="relative mb-6">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div>
                <div class="relative flex justify-center text-xs uppercase"><span class="bg-[#121218] px-2 text-gray-500 font-bold">Or URL</span></div>
            </div>

            <div class="flex gap-3">
                <input type="text" id="urlInput" class="input-dark flex-grow" placeholder="https://...">
                <button onclick="applyUrl()" class="liquid-glow px-6 py-0 text-xs shadow-lg hover:shadow-pink-500/20 whitespace-nowrap">
                    Apply
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="textModal" onclick="closeModal('textModal', event)">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold font-['Space_Grotesk']">Edit Content</h3>
                <button onclick="closeModal('textModal')" class="text-gray-500 hover:text-white"><i data-feather="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="text-left mb-6">
                <label class="text-[10px] uppercase font-bold text-gray-500 mb-2 block ml-1 tracking-wider">Text Content</label>
                <textarea id="textEditorInput" class="input-dark h-32 resize-none leading-relaxed" placeholder="Type here..."></textarea>
            </div>

            <button onclick="applyTextUpdate()" class="liquid-glow w-full py-3 text-sm font-bold shadow-lg">
                Update Text
            </button>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".html" class="hidden" onchange="loadTemplate(this)">
    <input type="file" id="imgUpload" accept="image/*" class="hidden" onchange="handleImageUpload(this)">

    <script>
        feather.replace();

        // --- STATE & PERSISTENCE ---
        let projectDomain = localStorage.getItem('reputifly_domain') || "";
        let savedHTML = localStorage.getItem('reputifly_html') || "";
        let currentElement = null;
        let assetsToZip = []; 
        let headerVisible = true;
        let isMobileView = false;

        // --- INITIAL LOAD ---
        window.addEventListener('DOMContentLoaded', () => {
            if(projectDomain) {
                document.getElementById('domainInput').value = projectDomain;
                document.getElementById('domainDisplay').innerText = projectDomain;
                document.getElementById('setupScreen').classList.remove('active');
            }
            if(savedHTML) {
                loadContentIntoFrame(savedHTML);
            }
        });

        // --- VIEW CONTROLS ---
        function toggleHeader() {
            const header = document.getElementById('mainHeader');
            const btn = document.getElementById('navToggleBtn');
            headerVisible = !headerVisible;
            if(headerVisible) {
                header.classList.remove('nav-hidden');
                btn.innerHTML = '<i data-feather="eye-off" class="w-5 h-5"></i>';
                btn.style.opacity = "0.5";
            } else {
                header.classList.add('nav-hidden');
                btn.innerHTML = '<i data-feather="eye" class="w-5 h-5"></i>';
                btn.style.opacity = "1";
            }
            feather.replace();
        }

        function toggleMobileView() {
            const frameContainer = document.getElementById('editor-frame-container');
            const frame = document.getElementById('editorFrame');
            const btn = document.getElementById('mobileToggleBtn');
            
            isMobileView = !isMobileView;
            
            if(isMobileView) {
                // Mobile Mode
                frame.style.width = "375px";
                frame.style.height = "90%"; 
                frame.style.margin = "0 auto";
                frame.style.border = "4px solid #333";
                frame.style.borderRadius = "20px";
                frame.style.boxShadow = "0 20px 50px rgba(0,0,0,0.5)";
                frameContainer.style.display = "flex";
                frameContainer.style.alignItems = "center";
                frameContainer.style.justifyContent = "center";
                btn.style.background = "#E6397F";
                btn.style.borderColor = "#E6397F";
            } else {
                // Desktop Mode
                frame.style.width = "100%";
                frame.style.height = "100%";
                frame.style.margin = "0";
                frame.style.border = "none";
                frame.style.borderRadius = "0";
                frameContainer.style.display = "block";
                btn.style.background = "rgba(20, 20, 30, 0.9)";
                btn.style.borderColor = "rgba(255,255,255,0.1)";
            }
        }

        function clearStorage() {
            if(confirm("Reset all saved data?")) {
                localStorage.removeItem('reputifly_domain');
                localStorage.removeItem('reputifly_html');
                location.reload();
            }
        }

        function saveProgress() {
            const frame = document.getElementById('editorFrame');
            if(frame.contentDocument) {
                localStorage.setItem('reputifly_html', frame.contentDocument.documentElement.outerHTML);
            }
        }

        // --- SETUP & LOAD ---
        function finishSetup() {
            const input = document.getElementById('domainInput').value.trim();
            if(!input) return alert("Please enter the URL.");
            projectDomain = input.replace(/^https?:\/\//, '').replace(/\/$/, '');
            localStorage.setItem('reputifly_domain', projectDomain);
            document.getElementById('domainDisplay').innerText = projectDomain;
            document.getElementById('setupScreen').classList.remove('active');
        }

        function loadTemplate(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                let content = e.target.result;
                // --- FIX FOR INVISIBLE HEADER ---
                // Removes 'body > header { display: none }' which accidentally hides custom headers
                content = content.replace(/body\s*>\s*header\s*\{\s*display:\s*none\s*!important;?\s*\}/gi, "");
                content = content.replace(/,\s*body\s*>\s*header/gi, ""); 
                
                localStorage.setItem('reputifly_html', content);
                loadContentIntoFrame(content);
            };
            reader.readAsText(file);
        }

        function loadContentIntoFrame(htmlContent) {
            const frame = document.getElementById('editorFrame');
            frame.srcdoc = htmlContent;
            frame.onload = () => {
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('saveBtn').classList.remove('disabled');
                injectEditorScripts(frame);
            };
        }

        function injectEditorScripts(iframe) {
            const doc = iframe.contentDocument;
            const win = iframe.contentWindow;

            const style = doc.createElement('style');
            style.textContent = `
                img { cursor: pointer !important; transition: outline 0.2s ease; position: relative; }
                img:hover { outline: 3px solid #E6397F !important; z-index: 50; }
                h1:hover, h2:hover, h3:hover, p:hover, li:hover, span:hover, a:hover {
                    cursor: text; outline: 1px dashed rgba(255, 138, 0, 0.5);
                }
                a { pointer-events: auto !important; }
            `;
            doc.head.appendChild(style);

            // Scroll Logic (Auto-Hide Header)
            let lastScrollY = 0;
            win.addEventListener('scroll', () => {
                const currentScrollY = win.scrollY;
                if(currentScrollY > lastScrollY && currentScrollY > 50) {
                    if(headerVisible) toggleHeader();
                } else if (currentScrollY < lastScrollY) {
                    if(!headerVisible) toggleHeader();
                }
                lastScrollY = currentScrollY;
            });

            // Click Listeners
            doc.querySelectorAll('img').forEach(img => {
                img.addEventListener('click', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    currentElement = img;
                    openModal('imageModal');
                });
            });

            doc.body.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                let target = e.target;
                if(target.tagName === 'B' || target.tagName === 'I' || target.tagName === 'STRONG') target = target.parentElement;
                if(target.innerText && target.innerText.trim().length > 0 && target.tagName !== 'IMG') {
                    currentElement = target;
                    openTextModal(target.innerText.trim());
                }
            });

            doc.body.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (link) {
                    const href = link.getAttribute('href');
                    if (href && href !== '#' && !href.startsWith('#')) e.preventDefault();
                }
            });
        }

        // --- MODALS ---
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id, e) { 
            if(e && e.target !== document.getElementById(id) && e.type === 'click') return;
            document.getElementById(id).classList.remove('active'); 
        }
        function openTextModal(currentText) {
            document.getElementById('textEditorInput').value = currentText;
            openModal('textModal');
        }

        // --- SMART FILENAME HANDLING ---
        function getUniqueFilename(baseName) {
            let name = baseName;
            let counter = 1;
            while (assetsToZip.some(a => a.name === name)) {
                const parts = baseName.split('.');
                const ext = parts.pop();
                name = `${parts.join('.')}-${counter}.${ext}`;
                counter++;
            }
            return name;
        }

        // --- IMAGE LOGIC ---
        async function handleImageUpload(input) {
            const file = input.files[0];
            if(!file || !currentElement) return;

            const dropContent = document.getElementById('dropContent');
            const originalHTML = dropContent.innerHTML;
            dropContent.innerHTML = '<div class="loader mx-auto mb-2"></div><span class="text-xs">Processing...</span>';

            const webpBlob = await convertToWebP(file);
            
            // 1. Generate Clean Base Name
            let baseName = file.name.split('.')[0].toLowerCase().replace(/[\s_]+/g, '-').replace(/[^a-z0-9\-]/g, '') + ".webp";
            
            // 2. Ensure Uniqueness (Fix for Overwriting)
            let safeName = getUniqueFilename(baseName);

            // 3. Generate URL
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const wpUrl = `https://${projectDomain}/wp-content/uploads/${year}/${month}/${safeName}`;

            // 4. Update
            const previewUrl = URL.createObjectURL(webpBlob);
            currentElement.src = previewUrl; 
            currentElement.dataset.exportSrc = wpUrl; 
            
            // 5. Add to Zip
            addToZipQueue(safeName, webpBlob);
            saveProgress();

            dropContent.innerHTML = originalHTML;
            input.value = '';
            closeModal('imageModal');
        }

        function applyUrl() {
            const url = document.getElementById('urlInput').value;
            if(url && currentElement) {
                currentElement.src = url;
                delete currentElement.dataset.exportSrc;
                saveProgress();
                closeModal('imageModal');
            }
        }

        function applyTextUpdate() {
            const newText = document.getElementById('textEditorInput').value;
            if(currentElement) {
                currentElement.innerText = newText;
                saveProgress();
            }
            closeModal('textModal');
        }

        function convertToWebP(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if(w > 2500) { h = Math.round(h * 2500/w); w = 2500; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        canvas.toBlob((blob) => resolve(blob), 'image/webp', 0.9);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function addToZipQueue(filename, blob) {
            assetsToZip.push({ name: filename, blob: blob });
        }

        async function downloadProject() {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div> Zipping...';
            btn.classList.add('disabled');

            const zip = new JSZip();
            const doc = document.getElementById('editorFrame').contentDocument.cloneNode(true);
            
            // Final Cleanup for export
            doc.querySelectorAll('img').forEach(img => {
                if(img.dataset.exportSrc) {
                    img.src = img.dataset.exportSrc;
                    delete img.dataset.exportSrc;
                }
                img.removeAttribute('style'); 
            });
            
            const styles = doc.querySelectorAll('style');
            if(styles.length > 0) styles[styles.length - 1].remove();

            zip.file("index.html", doc.documentElement.outerHTML);
            const imgFolder = zip.folder("images_to_upload");
            assetsToZip.forEach(asset => {
                imgFolder.file(asset.name, asset.blob);
            });

            const content = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = `${projectDomain.split('.')[0]}_update.zip`;
            a.click();

            btn.innerHTML = originalText;
            btn.classList.remove('disabled');
        }
    </script>
</body>
</html>
