<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reputifly | Visual Workspace</title>
    
    <link rel="icon" type="image/png" href="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        window.firebaseApp = { initializeApp, getFirestore, doc, getDoc, setDoc, collection, addDoc };
        window.dispatchEvent(new Event('firebaseLoaded'));
    </script>

    <style>
        :root {
            --bg-main: #0B0A14;
            --accent-primary: #E6397F;
            --accent-secondary: #FF8A00;
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* --- UI COMPONENTS --- */
        .liquid-glow {
            background: radial-gradient(circle at top, rgba(255,255,255,0.4) 0%, transparent 60%),
                        linear-gradient(90deg, #E6397F, #FF8A00);
            box-shadow: 
                0 6px 20px rgba(230, 57, 127, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            border: none; position: relative; overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            color: white; font-weight: 700; border-radius: 9999px;
            display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;
        }
        .liquid-glow:hover { transform: translateY(-2px) scale(1.02); box-shadow: 0 15px 30px rgba(255, 138, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.6); }
        .liquid-glow.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .liquid-glow.small { padding: 0 16px; height: 32px; font-size: 12px; }

        .btn-glass { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #ccc; 
            border-radius: 9999px; transition: all 0.2s ease; font-weight: 600; font-size: 13px;
            display: flex; align-items: center; gap: 6px; padding: 0 18px; cursor: pointer;
        }
        .btn-glass:hover { background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.3); }
        
        .btn-share {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 9999px;
            font-weight: 600; font-size: 13px;
            height: 40px;
            padding: 0 20px;
            display: flex; align-items: center; gap: 6px;
            transition: all 0.2s;
        }
        .btn-share:hover { background: rgba(255,255,255,0.15); border-color: white; }

        .hidden-force { display: none !important; }

        .input-dark {
            background: #050505; border: 1px solid rgba(255,255,255,0.15); color: white; 
            border-radius: 12px; padding: 14px 18px; width: 100%; font-family: 'Inter', sans-serif; 
            font-size: 13px; outline: none; transition: all 0.3s ease; box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        .input-dark:focus { border-color: var(--accent-primary); box-shadow: 0 0 0 1px rgba(230, 57, 127, 0.5), inset 0 2px 4px rgba(0,0,0,0.5); }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(5, 5, 8, 0.95); backdrop-filter: blur(10px);
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-card {
            background: #121218; border: 1px solid rgba(255,255,255,0.08); border-radius: 24px; 
            padding: 40px; width: 90%; max-width: 500px; text-align: center;
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.8);
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .modal-overlay.active .modal-card { transform: scale(1); }

        .icon-circle {
            width: 64px; height: 64px; background: rgba(255,255,255,0.03); 
            border: 1px solid rgba(255,255,255,0.08); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; margin: 0 auto 24px auto;
        }

        /* --- TUTORIAL STEPS --- */
        .step-row {
            display: flex; align-items: center; gap: 16px; text-align: left;
            padding: 16px; background: rgba(255,255,255,0.02); 
            border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; margin-bottom: 12px;
        }
        .step-icon {
            width: 40px; height: 40px; background: rgba(230, 57, 127, 0.1); 
            color: #E6397F; border-radius: 10px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
        }

        /* --- RICH TEXT EDITOR STYLES --- */
        .editor-container {
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            overflow: hidden;
            background: #050505;
            text-align: left;
        }
        
        .editor-toolbar {
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding: 8px 12px;
            display: flex;
            gap: 6px;
        }

        .toolbar-btn {
            width: 32px; height: 32px;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            color: #aaa;
            transition: all 0.2s;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        .toolbar-btn:hover, .toolbar-btn.active { background: rgba(255,255,255,0.1); color: white; }
        .toolbar-btn svg { width: 16px; height: 16px; }

        .editor-content {
            padding: 16px;
            min-height: 120px;
            max-height: 200px;
            overflow-y: auto;
            color: white;
            font-size: 14px;
            line-height: 1.6;
            outline: none;
        }
        .editor-content b, .editor-content strong { font-weight: bold; color: #fff; }
        .editor-content i, .editor-content em { font-style: italic; }
        .editor-content u { text-decoration: underline; }
        .editor-content a { color: #E6397F; text-decoration: underline; cursor: pointer; }

        .link-drawer {
            background: #1a1a24;
            padding: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: none;
            animation: slideDown 0.2s ease;
        }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- NAV CAPSULE & TOGGLES --- */
        .nav-capsule {
            position: absolute; top: 24px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 1000px; height: 68px;
            background: rgba(20, 20, 30, 0.85); backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border); border-radius: 9999px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 50; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s ease;
        }
        .nav-capsule.nav-hidden { transform: translateX(-50%) translateY(-200%); opacity: 0; pointer-events: none; }

        .undo-redo-btn {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #888; border: 1px solid transparent; background: transparent;
            transition: all 0.2s; cursor: pointer;
        }
        .undo-redo-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .undo-redo-btn:disabled { opacity: 0.3; cursor: not-allowed; hover: none; }

        .toggle-btn {
            position: absolute; z-index: 60;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(20, 20, 30, 0.9); border: 1px solid rgba(255,255,255,0.1);
            color: white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: all 0.2s ease; opacity: 0.7;
        }
        .toggle-btn:hover { opacity: 1; transform: scale(1.1); background: #E6397F; border-color: #E6397F; }
        
        #navToggleBtn { top: 38px; right: 24px; }
        #mobileToggleBtn { top: 38px; right: 74px; }

        @media (max-width: 768px) {
            #mobileToggleBtn { display: none; }
            #navToggleBtn { top: auto; bottom: 24px; left: 24px; right: auto; background: rgba(230, 57, 127, 0.9); border-color: #E6397F; opacity: 1; }
        }

        .loader { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .pulse-ring {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            border: 1px solid var(--accent-primary); opacity: 0;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

        /* --- TOAST NOTIFICATION --- */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #1a1a24; border: 1px solid #E6397F;
            padding: 16px 24px; border-radius: 12px;
            display: flex; align-items: center; gap: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); z-index: 200;
            opacity: 0; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast-content h4 { color: white; font-weight: bold; font-size: 14px; margin: 0; }
        .toast-content p { color: #aaa; font-size: 12px; margin: 2px 0 0 0; }
        
        /* SHARE MODAL SPECIFIC */
        .copy-box {
            background: #050505; border: 1px solid rgba(255,255,255,0.15); 
            border-radius: 12px; padding: 12px; display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 20px; font-family: monospace; color: #E6397F; font-size: 12px;
            overflow: hidden;
        }
    </style>
</head>
<body>

    <button id="mobileToggleBtn" class="toggle-btn" onclick="toggleMobileView()" title="Toggle Mobile View">
        <i data-feather="smartphone" class="w-5 h-5"></i>
    </button>
    <button id="navToggleBtn" class="toggle-btn" onclick="toggleHeader()" title="Show/Hide Header">
        <i data-feather="eye" class="w-5 h-5"></i>
    </button>

    <div id="cloudLoader" class="modal-overlay" style="z-index: 300;">
        <div class="flex flex-col items-center">
            <div class="loader mb-4" style="width: 40px; height: 40px;"></div>
            <h2 class="text-xl font-bold">Loading Project...</h2>
        </div>
    </div>

    <div id="shareModal" class="modal-overlay" onclick="closeModal('shareModal', event)">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="icon-circle">
                <i data-feather="share-2" class="w-8 h-8 text-pink-500"></i>
            </div>
            <h1 class="text-xl font-bold font-['Space_Grotesk'] mb-2 text-white">Share Link</h1>
            <p class="text-gray-400 text-sm mb-6">Send this link to share the current progress.</p>
            
            <div class="copy-box" id="shareLinkBox">
                Generating...
            </div>
            
            <button onclick="copyShareLink()" class="liquid-glow w-full py-3 text-sm shadow-lg mb-3">
                <i data-feather="copy" class="w-4 h-4"></i> Copy Link
            </button>
            <button onclick="closeModal('shareModal')" class="text-xs text-gray-500 hover:text-white">Close</button>
        </div>
    </div>

    <div id="setupScreen" class="modal-overlay active" style="z-index: 200;">
        <div class="modal-card">
            <div class="icon-circle relative">
                <div class="pulse-ring"></div>
                <i data-feather="globe" class="w-8 h-8 text-pink-500 relative z-10"></i>
            </div>
            <h1 class="text-2xl font-bold font-['Space_Grotesk'] mb-3 text-white">Project Setup</h1>
            <p class="text-gray-400 text-sm mb-8 leading-relaxed px-2">Enter the <strong>exact URL</strong> you are currently working on.</p>
            <div class="text-left mb-8">
                <label class="text-[10px] uppercase font-bold text-gray-500 mb-2 block ml-1 tracking-wider">Website Domain</label>
                <input type="text" id="domainInput" class="input-dark" placeholder="e.g. staging.client-site.com">
            </div>
            <button onclick="finishSetup()" class="liquid-glow w-full py-4 text-sm shadow-lg">Start Project <i data-feather="arrow-right" class="w-4 h-4 ml-1"></i></button>
            <button onclick="clearStorage()" class="mt-4 text-[10px] text-gray-600 hover:text-red-500 transition-colors">Reset Saved Data</button>
        </div>
    </div>

    <div id="helpModal" class="modal-overlay" style="z-index: 150;">
        <div class="modal-card">
            <div class="icon-circle">
                <i data-feather="help-circle" class="w-8 h-8 text-pink-500"></i>
            </div>
            <h1 class="text-2xl font-bold font-['Space_Grotesk'] mb-2 text-white">How it Works</h1>
            <p class="text-gray-400 text-sm mb-8">Follow these steps to update the website.</p>
            
            <div class="step-row">
                <div class="step-icon"><i data-feather="type" class="w-5 h-5"></i></div>
                <div>
                    <h4 class="font-bold text-sm text-white">Edit Text</h4>
                    <p class="text-xs text-gray-400 mt-1">Click any text on the page to change wording, bolding, or links.</p>
                </div>
            </div>
            <div class="step-row">
                <div class="step-icon"><i data-feather="image" class="w-5 h-5"></i></div>
                <div>
                    <h4 class="font-bold text-sm text-white">Swap Images</h4>
                    <p class="text-xs text-gray-400 mt-1">Click any image to upload a replacement. We handle the formatting.</p>
                </div>
            </div>
            <div class="step-row">
                <div class="step-icon"><i data-feather="download-cloud" class="w-5 h-5"></i></div>
                <div>
                    <h4 class="font-bold text-sm text-white">Save & Send</h4>
                    <p class="text-xs text-gray-400 mt-1">When finished, click <strong>Download Zip</strong> (or Share).</p>
                </div>
            </div>

            <button onclick="closeModal('helpModal')" class="liquid-glow w-full py-4 text-sm shadow-lg mt-4">Got it, Let's Go!</button>
        </div>
    </div>

    <nav class="nav-capsule" id="mainHeader">
        <div class="flex items-center gap-3">
            <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png" class="h-6 w-auto brightness-125">
            
            <button id="navHelpBtn" onclick="openModal('helpModal')" class="hidden-force w-8 h-8 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-gray-500 hover:text-white transition-all ml-1" title="Help">
                <i data-feather="help-circle" class="w-4 h-4"></i>
            </button>

            <button id="navExitBtn" onclick="exitProject()" class="w-8 h-8 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-gray-500 hover:text-white hover:bg-red-500/20 hover:border-red-500/50 transition-all ml-1" title="Exit Project">
                <i data-feather="log-out" class="w-3.5 h-3.5"></i>
            </button>
            
            <div class="h-4 w-px bg-white/10 hidden md:block ml-2"></div>
            <span class="text-xs font-bold text-gray-500 font-mono hidden md:block truncate max-w-[150px]" id="domainDisplay">...</span>
            
            <button type="button" onclick="performUndo()" id="undoBtn" class="undo-redo-btn" disabled title="Undo (Ctrl+Z)">
                <i data-feather="arrow-left" class="w-4 h-4"></i>
            </button>
            <button type="button" onclick="performRedo()" id="redoBtn" class="undo-redo-btn" disabled title="Redo (Ctrl+Y)">
                <i data-feather="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>

        <div class="flex items-center gap-3">
            <div id="navLoadMenu" class="relative group z-50">
                <button class="btn-glass h-10 pr-4">
                    <i data-feather="layout" class="w-4 h-4"></i> 
                    <span class="hidden sm:inline">Load HTML</span>
                    <i data-feather="chevron-down" class="w-3 h-3 ml-1 opacity-50"></i>
                </button>
                
                <div class="absolute top-full left-1/2 transform -translate-x-1/2 mt-3 w-48 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 translate-y-2 group-hover:translate-y-0">
                    <div class="bg-[#121218] border border-white/10 rounded-xl shadow-[0_20px_50px_rgba(0,0,0,0.5)] overflow-hidden flex flex-col backdrop-blur-xl ring-1 ring-white/5">
                        <div class="absolute -top-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-[#121218] border-l border-t border-white/10 transform rotate-45"></div>
                        
                        <button onclick="document.getElementById('fileInput').click()" class="relative z-10 text-left px-4 py-3 text-xs font-medium text-gray-300 hover:bg-white/5 hover:text-white flex items-center gap-3 transition-colors border-b border-white/5">
                            <i data-feather="upload" class="w-4 h-4 text-pink-500"></i> Upload File
                        </button>
                        <button onclick="openModal('pasteModal'); setTimeout(() => document.getElementById('pasteInput').focus(), 100);" class="relative z-10 text-left px-4 py-3 text-xs font-medium text-gray-300 hover:bg-white/5 hover:text-white flex items-center gap-3 transition-colors">
                            <i data-feather="clipboard" class="w-4 h-4 text-orange-500"></i> Paste Code
                        </button>
                    </div>
                </div>
            </div>

            <button id="navShareBtn" onclick="createShareableLink()" class="btn-share">
                <i data-feather="share-2" class="w-4 h-4"></i> <span class="hidden sm:inline">Share</span>
            </button>
            
            <button onclick="downloadProject()" id="saveBtn" class="liquid-glow h-10 px-5 text-xs disabled">
                <i data-feather="download-cloud" class="w-4 h-4"></i> <span class="hidden sm:inline">Download Zip</span>
            </button>
        </div>
    </nav>

    <div id="editor-frame-container" style="flex: 1; position: relative; width: 100%; height: 100%; transition: all 0.3s ease;">
        <div id="empty-state" onclick="document.getElementById('fileInput').click()" class="absolute inset-0 z-10 bg-[#0B0A14] flex flex-col items-center justify-center cursor-pointer">
            <div class="relative z-20 flex flex-col items-center">
                <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mb-5 border border-white/10 shadow-2xl transition-transform duration-300 hover:scale-110">
                    <i data-feather="upload-cloud" class="w-8 h-8 text-gray-400"></i>
                </div>
                
                <h2 class="text-2xl font-bold mb-2 text-white font-['Space_Grotesk'] tracking-tight">No Page Loaded</h2>
                <p class="text-gray-500 text-sm mb-6">Click anywhere to <span class="text-white font-bold">Upload HTML</span></p>
                
                <div class="flex items-center gap-3 text-xs text-gray-700 font-bold tracking-widest uppercase my-2">
                    <span class="w-8 h-px bg-white/5"></span>
                    <span>OR</span>
                    <span class="w-8 h-px bg-white/5"></span>
                </div>
    
                <button onclick="event.stopPropagation(); openModal('pasteModal'); setTimeout(() => document.getElementById('pasteInput').focus(), 100);" class="liquid-glow mt-4 px-8 py-3 text-xs shadow-lg flex items-center gap-2">
                    <i data-feather="clipboard" class="w-3 h-3"></i> Paste Code Directly
                </button>
            </div>
        </div>
        <iframe id="editorFrame" style="width: 100%; height: 100%; border: none; display: block; background: white; transition: all 0.3s ease;"></iframe>
    </div>

    <div class="modal-overlay" id="imageModal" onclick="closeModal('imageModal', event)">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold font-['Space_Grotesk']">Change Image</h3>
                <button onclick="closeModal('imageModal')" class="text-gray-500 hover:text-white"><i data-feather="x" class="w-5 h-5"></i></button>
            </div>
            <div class="border-2 border-dashed border-white/10 rounded-2xl p-8 hover:bg-white/5 hover:border-pink-500/50 cursor-pointer transition-all mb-6 group" onclick="document.getElementById('imgUpload').click()" id="dropZone">
                <div id="dropContent">
                    <div class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                        <i data-feather="image" class="w-6 h-6 text-pink-500"></i>
                    </div>
                    <p class="text-sm font-bold text-white">Upload, Drag or Paste (Ctrl+V)</p>
                    <p class="text-[10px] text-gray-400 mt-1">Auto-converts to WebP</p>
                </div>
            </div>
            <div class="relative mb-6">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div>
                <div class="relative flex justify-center text-xs uppercase"><span class="bg-[#121218] px-2 text-gray-500 font-bold">Or URL</span></div>
            </div>
            <div class="flex gap-3">
                <input type="text" id="urlInput" class="input-dark flex-grow" placeholder="https://...">
                <button onclick="applyUrl()" class="liquid-glow px-6 py-0 text-xs shadow-lg hover:shadow-pink-500/20 whitespace-nowrap">Apply</button>
            </div>
        </div>
    </div>
    <div id="exitModal" class="modal-overlay" onclick="closeModal('exitModal', event)">
        <div class="modal-card" style="max-width: 400px;" onclick="event.stopPropagation()">
            <div class="icon-circle" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2);">
                <i data-feather="log-out" class="w-10 h-10 text-red-500"></i>
            </div>
            <h1 class="text-xl font-bold font-['Space_Grotesk'] mb-2 text-white">Exit Project?</h1>
            <p class="text-gray-400 text-sm mb-6">Any unsaved progress will be lost. This will clear the current workspace.</p>
            
            <div class="flex gap-3">
                <button onclick="confirmExit()" class="liquid-glow w-full py-3 text-sm font-bold shadow-lg" style="background: #ef4444; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);">
                    Yes, Exit
                </button>
                <button onclick="closeModal('exitModal')" class="w-full py-3 text-sm font-bold rounded-full bg-white/5 hover:bg-white/10 text-white transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    <div id="exitModal" class="modal-overlay" onclick="closeModal('exitModal', event)">
        <div class="modal-card" style="max-width: 400px;" onclick="event.stopPropagation()">
            <div class="icon-circle" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2);">
                <i data-feather="log-out" class="w-10 h-10 text-red-500"></i>
            </div>
            <h1 class="text-xl font-bold font-['Space_Grotesk'] mb-2 text-white">Exit Project?</h1>
            <p class="text-gray-400 text-sm mb-6">Any unsaved progress will be lost. This will clear the current workspace.</p>
            
            <div class="flex gap-3">
                <button onclick="confirmExit()" class="liquid-glow w-full py-3 text-sm font-bold shadow-lg" style="background: #ef4444; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);">
                    Yes, Exit
                </button>
                <button onclick="closeModal('exitModal')" class="w-full py-3 text-sm font-bold rounded-full bg-white/5 hover:bg-white/10 text-white transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    <div id="pasteModal" class="modal-overlay" onclick="closeModal('pasteModal', event)">
        <div class="modal-card" style="max-width: 600px;" onclick="event.stopPropagation()">
            <div class="icon-circle">
                <i data-feather="clipboard" class="w-8 h-8 text-pink-500"></i>
            </div>
            <h1 class="text-xl font-bold font-['Space_Grotesk'] mb-2 text-white">Paste Source Code</h1>
            <p class="text-gray-400 text-sm mb-6">Paste your raw HTML code below to load it into the editor.</p>
            
            <textarea id="pasteInput" class="input-dark font-mono text-xs mb-6 h-64 resize-none focus:ring-2 focus:ring-pink-500/50" placeholder="<!DOCTYPE html><html>..."></textarea>
            
            <button onclick="loadPastedHTML()" class="liquid-glow w-full py-3 text-sm shadow-lg mb-3">
                <i data-feather="play" class="w-4 h-4"></i> Load Project
            </button>
            <button onclick="closeModal('pasteModal')" class="text-xs text-gray-500 hover:text-white">Cancel</button>
        </div>
    </div>

    <div class="modal-overlay" id="textModal" onclick="closeModal('textModal', event)">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold font-['Space_Grotesk']">Edit Content</h3>
                <button onclick="closeModal('textModal')" class="text-gray-500 hover:text-white"><i data-feather="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="text-left mb-6">
                <label class="text-[10px] uppercase font-bold text-gray-500 mb-2 block ml-1 tracking-wider">Content</label>
                <div class="editor-container">
                    <div class="editor-toolbar">
                        <button class="toolbar-btn" onmousedown="formatDoc('bold')" title="Bold"><i data-feather="bold"></i></button>
                        <button class="toolbar-btn" onmousedown="formatDoc('italic')" title="Italic"><i data-feather="italic"></i></button>
                        <button class="toolbar-btn" onmousedown="formatDoc('underline')" title="Underline"><i data-feather="underline"></i></button>
                        <div class="w-px h-4 bg-white/20 my-auto mx-1"></div>
                        <button class="toolbar-btn" onmousedown="toggleLinkInput()" title="Link Selection"><i data-feather="link"></i></button>
                        <button class="toolbar-btn" onmousedown="formatDoc('unlink')" title="Remove Link"><i data-feather="link-2"></i></button>
                    </div>
                    <div id="inlineLinkDrawer" class="link-drawer">
                        <div class="flex gap-2">
                            <input type="text" id="inlineLinkInput" class="input-dark py-2" placeholder="https://google.com">
                            <button onclick="applyInlineLink()" class="liquid-glow small shadow-lg whitespace-nowrap" style="padding: 0 16px; height: 32px; font-size: 12px;">Add</button>
                            <button onclick="closeLinkDrawer()" class="text-gray-400 hover:text-white"><i data-feather="x" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div id="richEditor" class="editor-content" contenteditable="true"></div>
                </div>
            </div>

            <div id="blockLinkSection" class="text-left mb-6 hidden">
                <label class="text-[10px] uppercase font-bold text-gray-500 mb-2 block ml-1 tracking-wider text-pink-500">Button / Link Destination</label>
                <div class="relative">
                    <i data-feather="external-link" class="absolute left-3 top-3.5 w-4 h-4 text-gray-500"></i>
                    <input type="text" id="blockLinkInput" class="input-dark pl-10" placeholder="https://...">
                </div>
            </div>

            <button onclick="applyTextUpdate()" class="liquid-glow w-full py-3 text-sm font-bold shadow-lg">Update Content</button>
        </div>
    </div>
    <div id="successModal" class="modal-overlay" onclick="closeModal('successModal', event)">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="icon-circle" style="background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.2);">
                <i data-feather="check" class="w-10 h-10 text-green-500"></i>
            </div>
            <h1 class="text-2xl font-bold font-['Space_Grotesk'] mb-2 text-white">Download Complete!</h1>
            <div class="bg-white/5 border border-white/10 rounded-xl p-4 mb-6 text-left">
                <p class="text-gray-400 text-xs uppercase font-bold mb-2 tracking-wider">Next Step</p>
                <p class="text-sm text-white leading-relaxed">
                    Please <strong>email the ZIP file</strong> you just downloaded to our team. We need this file to publish your changes live.
                </p>
            </div>
            
            <button onclick="closeModal('successModal')" class="liquid-glow w-full py-3 text-sm font-bold shadow-lg">
                Got it, I'll send it now
            </button>
        </div>
    </div>
    
    <div id="downloadToast" class="toast">
        <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-500">
            <i data-feather="check" class="w-5 h-5"></i>
        </div>
        <div class="toast-content text-left">
            <h4>Download Started!</h4>
            <p>Please email this ZIP file to us to apply changes.</p>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".html" class="hidden" onchange="loadTemplate(this)">
    <input type="file" id="imgUpload" accept="image/*" class="hidden" onchange="handleImageUpload(this)">

    <script>
        feather.replace();
        // --- SUPER STORAGE (IndexedDB Wrapper) ---
        // Allows saving huge files (500MB+) locally
        const dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open('reputifly-db', 1);
            request.onupgradeneeded = (e) => {
                e.target.result.createObjectStore('drafts');
            };
            request.onsuccess = (e) => resolve(e.target.result);
            request.onerror = (e) => reject(e);
        });

        async function saveToBigStorage(key, value) {
            const db = await dbPromise;
            return new Promise((resolve, reject) => {
                const tx = db.transaction('drafts', 'readwrite');
                const store = tx.objectStore('drafts');
                const req = store.put(value, key);
                req.onsuccess = () => resolve();
                req.onerror = () => reject(req.error);
            });
        }

        async function loadFromBigStorage(key) {
            const db = await dbPromise;
            return new Promise((resolve, reject) => {
                const tx = db.transaction('drafts', 'readonly');
                const store = tx.objectStore('drafts');
                const req = store.get(key);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }
        async function clearBigStorage() {
        const db = await dbPromise;
        return new Promise((resolve, reject) => {
            const tx = db.transaction('drafts', 'readwrite');
            const store = tx.objectStore('drafts');
            const req = store.clear(); // Wipes the database
            req.onsuccess = () => resolve();
            req.onerror = () => reject(req.error);
        });
    }

        // --- FIREBASE CONFIG (INTEGRATED) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDqpzqEVtrEtQvvmcMie_Et7xiNh8QU_Ao",
            authDomain: "reputifly-editor.firebaseapp.com",
            projectId: "reputifly-editor",
            storageBucket: "reputifly-editor.firebasestorage.app",
            messagingSenderId: "455384979132",
            appId: "1:455384979132:web:9079ec81182115b16622b9"
        };

        let db = null;
        let isCloudMode = false;
        let currentProjectId = null;
        
        window.addEventListener('firebaseLoaded', () => {
            try {
                if(window.firebaseApp) {
                    const app = window.firebaseApp.initializeApp(firebaseConfig);
                    db = window.firebaseApp.getFirestore(app);
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    if(urlParams.get('id')) {
                        checkUrlForProject();
                    }
                }
            } catch(e) { console.error("Firebase init error", e); }
        });

        let projectDomain = localStorage.getItem('reputifly_domain') || "";
        let savedHTML = localStorage.getItem('reputifly_html') || "";
        let currentElement = null; 
        let assetsToZip = []; 
        let headerLocked = false;
        let isMobileView = false;
        let savedSelection = null;
        let restoreScrollY = 0; 
        
        let historyStack = [];
        let historyIndex = -1;

        // --- CORE HTML CLEANING FUNCTION (UPDATED TO PRESERVE STYLES) ---
        function getCleanHTML() {
            if(!document.getElementById('editorFrame').contentDocument) return "";
            
            const docClone = document.getElementById('editorFrame').contentDocument.cloneNode(true);
            
            // Clean GSAP inline styles
            const dirtyElements = docClone.querySelectorAll('*[style]');
            dirtyElements.forEach(el => {
                const style = el.getAttribute('style');
                if (style && (style.includes('opacity') || style.includes('transform') || style.includes('visibility'))) {
                    el.style.removeProperty('opacity');
                    el.style.removeProperty('transform');
                    el.style.removeProperty('translate');
                    el.style.removeProperty('rotate');
                    el.style.removeProperty('scale');
                    el.style.removeProperty('visibility'); 
                    if (el.getAttribute('style') === '') el.removeAttribute('style');
                }
            });

            // FIX: Only remove the style tag with our specific ID
            const editorStyle = docClone.getElementById('reputifly-editor-css');
            if(editorStyle) editorStyle.remove();

            return docClone.documentElement.outerHTML;
        }

        // --- CLOUD LOGIC ---
        async function checkUrlForProject() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');
            
            if(projectId && db) {
                isCloudMode = true;
                currentProjectId = projectId; 
                
                document.getElementById('cloudLoader').classList.add('active');
        document.getElementById('setupScreen').classList.remove('active');
        
        // Hide the Load/Paste menu for clients
        const loadMenu = document.getElementById('navLoadMenu');
        if(loadMenu) loadMenu.style.display = 'none';
        
        // Fallback for safety
        const oldBtn = document.getElementById('loadHtmlBtn');
        if(oldBtn) oldBtn.style.display = 'none';
                
                // --- SAFE UI UPDATES (Prevents Crash) ---
                const loadBtn = document.getElementById('loadHtmlBtn') || document.getElementById('loadNavWrapper');
                if(loadBtn) loadBtn.style.display = 'none'; 
                
                const exitBtn = document.getElementById('navExitBtn');
                if(exitBtn) exitBtn.style.display = 'none';
                
                const helpBtn = document.getElementById('navHelpBtn');
                if(helpBtn) helpBtn.classList.remove('hidden-force');
                
                const shareBtn = document.getElementById('navShareBtn');
                if(shareBtn) shareBtn.style.display = 'none';
                // ----------------------------------------

                // 1. CHECK LOCAL STORAGE SAFELY
                let localDraft = null;
                try {
                    localDraft = await loadFromBigStorage(`reputifly_draft_${projectId}`);
                } catch(e) { console.warn("BigStorage error:", e); }
                
                // Fallback to standard storage
                if(!localDraft) localDraft = localStorage.getItem(`reputifly_draft_${projectId}`);
                
                if(localDraft) {
                    console.log("Restoring from local draft...");
                    try {
                        const docRef = window.firebaseApp.doc(db, "projects", projectId);
                        const docSnap = await window.firebaseApp.getDoc(docRef);
                        if(docSnap.exists()) {
                            projectDomain = docSnap.data().domain;
                            const displayEl = document.getElementById('domainDisplay');
                            if(displayEl) displayEl.innerText = projectDomain;
                            localStorage.setItem('reputifly_domain', projectDomain);
                        }
                    } catch(e) { console.error("Background fetch failed", e); }
                    
                    loadContentIntoFrame(localDraft);
                    pushHistory(localDraft);
                    document.getElementById('cloudLoader').classList.remove('active');
                    setTimeout(() => { openModal('helpModal'); }, 500);
                    return; 
                }
                
                // 2. IF NO LOCAL DRAFT, FETCH FROM DB
                try {
                    const docRef = window.firebaseApp.doc(db, "projects", projectId);
                    const docSnap = await window.firebaseApp.getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        projectDomain = data.domain;
                        
                        const displayEl = document.getElementById('domainDisplay');
                        if(displayEl) displayEl.innerText = projectDomain;
                        
                        localStorage.setItem('reputifly_domain', projectDomain); 
                        loadContentIntoFrame(data.html);
                        pushHistory(data.html);
                        
                        setTimeout(() => { openModal('helpModal'); }, 500);
                    } else {
                        alert("Project not found or expired.");
                    }
                } catch(e) {
                    console.error(e);
                    alert("Error loading project.");
                } finally {
                    document.getElementById('cloudLoader').classList.remove('active');
                }
            }
        }

        async function createShareableLink() {
            if(!db) return alert("Firebase not configured properly.");
            if(!document.getElementById('editorFrame').contentDocument) return alert("Load a page first.");
            
            const btn = document.getElementById('navShareBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "Saving...";
            
            try {
                const html = getCleanHTML();
                
                const docRef = await window.firebaseApp.addDoc(window.firebaseApp.collection(db, "projects"), {
                    domain: projectDomain,
                    html: html,
                    createdAt: new Date()
                });
                
                const link = window.location.origin + window.location.pathname + "?id=" + docRef.id;
                document.getElementById('shareLinkBox').innerText = link;
                openModal('shareModal');
            } catch(e) {
                console.error(e);
                alert("Error saving to cloud. See console.");
            }
            btn.innerHTML = originalText;
        }

        function copyShareLink() {
            const text = document.getElementById('shareLinkBox').innerText;
            navigator.clipboard.writeText(text);
            const btn = document.querySelector('#shareModal .liquid-glow');
            const oldHtml = btn.innerHTML;
            btn.innerHTML = "Copied!";
            setTimeout(() => btn.innerHTML = oldHtml, 2000);
        }

        // --- GLOBAL PASTE LISTENER ---
        document.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            const isImageModalOpen = document.getElementById('imageModal').classList.contains('active');
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image/')) {
                    if (isImageModalOpen) {
                        e.preventDefault();
                        processNewImage(item.getAsFile()); 
                        return;
                    }
                }
            }
        });

        // --- DRAG & DROP HTML LOADER ---
        const emptyState = document.getElementById('empty-state');
        emptyState.addEventListener('dragover', (e) => {
            e.preventDefault();
            emptyState.style.background = '#1a1a24';
            emptyState.style.borderColor = '#E6397F';
        });
        emptyState.addEventListener('dragleave', (e) => {
            e.preventDefault();
            emptyState.style.background = '#0B0A14';
        });
        emptyState.addEventListener('drop', (e) => {
            e.preventDefault();
            emptyState.style.background = '#0B0A14';
            
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (file.name.endsWith('.html')) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        let content = ev.target.result;
                        content = content.replace(/body\s*>\s*header\s*\{\s*display:\s*none\s*!important;?\s*\}/gi, "");
                        content = content.replace(/,\s*body\s*>\s*header/gi, ""); 
                        localStorage.setItem('reputifly_html', content);
                        loadContentIntoFrame(content);
                        pushHistory(content); 
                    };
                    reader.readAsText(file);
                } else {
                    alert("Please drop an HTML file.");
                }
            }
        });
        
        document.getElementById('richEditor').addEventListener('paste', function(e) {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text');
            document.execCommand('insertText', false, text);
        });

        window.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('id')) {
                return; // Cloud loader handles this
            }

            // --- UX FIX: Show "Restoring..." while we check the database ---
            const emptyState = document.getElementById('empty-state');
            const originalEmptyContent = emptyState.innerHTML; // Save the "Upload" UI for later
            
            // Show a temporary spinner so you know it's working
            emptyState.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full">
                    <div class="loader mb-6" style="width: 40px; height: 40px;"></div>
                    <h2 class="text-xl font-bold text-white font-['Space_Grotesk']">Restoring Workspace...</h2>
                    <p class="text-gray-500 text-sm mt-2">Reading from Super Storage</p>
                </div>
            `;
            // -------------------------------------------------------------

            if(projectDomain) {
                document.getElementById('domainInput').value = projectDomain;
                const displayEl = document.getElementById('domainDisplay');
                if(displayEl) displayEl.innerText = projectDomain;
                document.getElementById('setupScreen').classList.remove('active');
            }

            // --- SAFELY LOAD CONTENT ---
            let contentToLoad = null;

            // 1. Try Big Storage
            try {
                // Artificial delay of 100ms helps prevent race conditions on some browsers
                await new Promise(r => setTimeout(r, 100)); 
                contentToLoad = await loadFromBigStorage('reputifly_html');
            } catch(e) {
                console.warn("Big Storage unavailable, skipping...");
            }
            
            // 2. Fallback to Standard Storage
            if(!contentToLoad) {
                contentToLoad = localStorage.getItem('reputifly_html');
            }
            
            // 3. Load whatever we found
            if(contentToLoad) {
                loadContentIntoFrame(contentToLoad);
                pushHistory(contentToLoad); 
                // The empty-state div will be hidden by loadContentIntoFrame automatically
            } else {
                // 4. NOTHING FOUND: Put the "Upload" UI back
                emptyState.innerHTML = originalEmptyContent;
                feather.replace(); // Re-render the icons we just put back
            }
        });

        // --- HISTORY MANAGEMENT ---
        function pushHistory(htmlContent) {
            if (historyIndex < historyStack.length - 1) {
                historyStack = historyStack.slice(0, historyIndex + 1);
            }
            historyStack.push(htmlContent);
            historyIndex++;
            updateUndoRedoUI();
        }

        function performUndo() {
            if (historyIndex > 0) {
                const frame = document.getElementById('editorFrame');
                if(frame.contentWindow) restoreScrollY = frame.contentWindow.scrollY;

                historyIndex--;
                const prevHTML = historyStack[historyIndex];
                loadContentIntoFrame(prevHTML);
                localStorage.setItem('reputifly_html', prevHTML); 
                updateUndoRedoUI();
            }
        }

        function performRedo() {
            if (historyIndex < historyStack.length - 1) {
                const frame = document.getElementById('editorFrame');
                if(frame.contentWindow) restoreScrollY = frame.contentWindow.scrollY;

                historyIndex++;
                const nextHTML = historyStack[historyIndex];
                loadContentIntoFrame(nextHTML);
                localStorage.setItem('reputifly_html', nextHTML);
                updateUndoRedoUI();
            }
        }

        function updateUndoRedoUI() {
            document.getElementById('undoBtn').disabled = (historyIndex <= 0);
            document.getElementById('redoBtn').disabled = (historyIndex >= historyStack.length - 1);
        }

        // --- RICH TEXT ---
        function formatDoc(cmd, value = null) {
            document.execCommand(cmd, false, value);
            document.getElementById('richEditor').focus();
        }
        function saveSelection() {
            if (window.getSelection) {
                const sel = window.getSelection();
                if (sel.getRangeAt && sel.rangeCount) return sel.getRangeAt(0);
            }
            return null;
        }
        function restoreSelection(range) {
            if (range && window.getSelection) {
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
        function toggleLinkInput() {
            const drawer = document.getElementById('inlineLinkDrawer');
            if (drawer.style.display === 'block') {
                closeLinkDrawer();
            } else {
                savedSelection = saveSelection(); 
                if(!savedSelection || savedSelection.toString().length === 0) {
                    alert("Please select some text first.");
                    return;
                }
                drawer.style.display = 'block';
                document.getElementById('inlineLinkInput').focus();
            }
        }
        function closeLinkDrawer() {
            document.getElementById('inlineLinkDrawer').style.display = 'none';
            document.getElementById('inlineLinkInput').value = '';
        }
        function applyInlineLink() {
            const url = document.getElementById('inlineLinkInput').value;
            if (url && savedSelection) {
                restoreSelection(savedSelection);
                formatDoc('createLink', url);
                closeLinkDrawer();
            }
        }
        document.querySelectorAll('.toolbar-btn').forEach(btn => {
            btn.addEventListener('click', (e) => e.preventDefault());
        });

        // --- VIEW CONTROLS ---
        window.parentAutoShow = function() {
            if(headerLocked) return; 
            document.getElementById('mainHeader').classList.remove('nav-hidden');
        }
        window.parentAutoHide = function() {
            if(headerLocked) return;
            document.getElementById('mainHeader').classList.add('nav-hidden');
        }

        function toggleHeader() {
            const header = document.getElementById('mainHeader');
            const btn = document.getElementById('navToggleBtn');
            headerLocked = !headerLocked; 
            if(headerLocked) {
                header.classList.add('nav-hidden');
                btn.innerHTML = '<i data-feather="eye" class="w-5 h-5"></i>';
                btn.style.opacity = "1";
            } else {
                header.classList.remove('nav-hidden');
                btn.innerHTML = '<i data-feather="eye-off" class="w-5 h-5"></i>';
                btn.style.opacity = "0.5";
            }
            feather.replace();
        }

        function toggleMobileView() {
            const frameContainer = document.getElementById('editor-frame-container');
            const frame = document.getElementById('editorFrame');
            const btn = document.getElementById('mobileToggleBtn');
            isMobileView = !isMobileView;
            if(isMobileView) {
                frame.style.width = "375px"; frame.style.height = "90%"; 
                frame.style.margin = "0 auto"; frame.style.border = "4px solid #333";
                frame.style.borderRadius = "20px"; frame.style.boxShadow = "0 20px 50px rgba(0,0,0,0.5)";
                frameContainer.style.display = "flex"; frameContainer.style.alignItems = "center";
                frameContainer.style.justifyContent = "center";
                btn.style.background = "#E6397F"; btn.style.borderColor = "#E6397F";
            } else {
                frame.style.width = "100%"; frame.style.height = "100%";
                frame.style.margin = "0"; frame.style.border = "none";
                frame.style.borderRadius = "0";
                frameContainer.style.display = "block";
                btn.style.background = "rgba(20, 20, 30, 0.9)"; btn.style.borderColor = "rgba(255,255,255,0.1)";
            }
        }

        function exitProject() {
            // Open the custom modal instead of the browser popup
            openModal('exitModal');
        }

        async function confirmExit() {
            const btn = document.querySelector('#exitModal .liquid-glow');
            if(btn) btn.innerHTML = "Clearing...";
            
            try {
                // 1. Clear Small Storage
                localStorage.removeItem('reputifly_domain');
                localStorage.removeItem('reputifly_html');
                localStorage.removeItem('reputifly_tutorial_seen');
                
                // 2. Clear Super Storage (IndexedDB) - CRITICAL
                await clearBigStorage(); 
            } catch(e) { 
                console.error("DB Clear Error", e); 
            }
            
            // 3. Reload Page
            window.location.href = window.location.pathname; 
        }

        // Updated clearStorage to use the same logic
        function clearStorage() {
             openModal('exitModal'); // Re-use the nice modal
        }

        async function saveProgress() {
            const html = getCleanHTML();
            if(html) {
                try {
                    // 1. Try Big Storage (Unlimited)
                    await saveToBigStorage('reputifly_html', html);
                    
                    // If Cloud Mode, save to specific draft ID
                    if(currentProjectId) {
                        await saveToBigStorage(`reputifly_draft_${currentProjectId}`, html);
                    }
                } catch(e) { console.error("IndexedDB Save Failed", e); }

                // 2. Try Standard Storage (Backup - might fail if >5MB)
                try {
                    localStorage.setItem('reputifly_html', html);
                    if(currentProjectId) {
                        localStorage.setItem(`reputifly_draft_${currentProjectId}`, html);
                    }
                } catch(e) {
                    // Ignore quota errors here since we likely saved to BigStorage successfully above
                }

                // 3. Visual Feedback
                pushHistory(html); 
            }
        }

        // --- SETUP & LOAD ---
        function finishSetup() {
            const input = document.getElementById('domainInput').value.trim();
            if(!input) return alert("Please enter the URL.");
            projectDomain = input.replace(/^https?:\/\//, '').replace(/\/$/, '');
            localStorage.setItem('reputifly_domain', projectDomain);
            
            const displayEl = document.getElementById('domainDisplay');
            if(displayEl) displayEl.innerText = projectDomain;
            
            document.getElementById('setupScreen').classList.remove('active');
        }
        function loadPastedHTML() {
            let content = document.getElementById('pasteInput').value;
            if(!content || !content.trim()) return alert("Please paste some HTML code first.");
            
            // Clean the HTML (Standard Protocol)
            content = content.replace(/body\s*>\s*header\s*\{\s*display:\s*none\s*!important;?\s*\}/gi, "");
            content = content.replace(/,\s*body\s*>\s*header/gi, ""); 
            
            // Save Safely
            try {
                saveToBigStorage('reputifly_html', content);
            } catch(e) {}
            localStorage.setItem('reputifly_html', content);
            
            loadContentIntoFrame(content);
            pushHistory(content);
            
            document.getElementById('pasteInput').value = ""; 
            closeModal('pasteModal');
        }

        function loadTemplate(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                let content = e.target.result;
                content = content.replace(/body\s*>\s*header\s*\{\s*display:\s*none\s*!important;?\s*\}/gi, "");
                content = content.replace(/,\s*body\s*>\s*header/gi, ""); 
                localStorage.setItem('reputifly_html', content);
                loadContentIntoFrame(content);
                pushHistory(content); 
            };
            reader.readAsText(file);
        }

        function loadContentIntoFrame(htmlContent) {
            const frame = document.getElementById('editorFrame');
            frame.srcdoc = htmlContent;
            frame.onload = () => {
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('saveBtn').classList.remove('disabled');
                
                if(restoreScrollY > 0) {
                    frame.contentWindow.scrollTo(0, restoreScrollY);
                    restoreScrollY = 0; 
                }
                
                injectEditorScripts(frame);
            };
        }

        function injectEditorScripts(iframe) {
            const doc = iframe.contentDocument;
            const win = iframe.contentWindow;

            const style = doc.createElement('style');
            style.id = 'reputifly-editor-css'; // FIX: ID Added so we can remove safely later
            style.textContent = `
                img { cursor: pointer !important; transition: outline 0.2s ease; position: relative; }
                img:hover { outline: 3px solid #E6397F !important; z-index: 99999 !important; }
                
                h1:hover, h2:hover, h3:hover, h4:hover, h5:hover, h6:hover, p:hover, li:hover, a:hover, button:hover, label:hover, caption:hover {
                    cursor: text; 
                    outline: 1px dashed rgba(255, 138, 0, 0.7);
                    background: rgba(255, 138, 0, 0.05);
                }
                a { pointer-events: auto !important; }

                /* FORCE VISIBILITY FOR EDITOR ONLY */
                .tes-svc-row, [style*="opacity: 0"], [style*="visibility: hidden"] {
                    opacity: 1 !important;
                    visibility: visible !important;
                    transform: none !important;
                }
            `;
            doc.head.appendChild(style);

            let lastScrollY = 0;
            win.addEventListener('scroll', () => {
                const currentScrollY = win.scrollY;
                if(currentScrollY > lastScrollY && currentScrollY > 50) window.parent.parentAutoHide(); 
                else if (currentScrollY < lastScrollY) window.parent.parentAutoShow(); 
                lastScrollY = currentScrollY;
            });

            doc.body.addEventListener('click', (e) => {
                const link = e.target.closest('a');
                if (link) e.preventDefault();

                let target = e.target;
                if (target.tagName !== 'IMG') {
                    const elements = doc.elementsFromPoint(e.clientX, e.clientY);
                    const imgUnderneath = elements.find(el => el.tagName === 'IMG');
                    if (imgUnderneath) target = imgUnderneath;
                }

                if (target.tagName === 'IMG') {
                    e.preventDefault(); e.stopPropagation();
                    currentElement = target;
                    // FIX: Reset Inputs when opening modal
                    document.getElementById('urlInput').value = '';
                    const defaultDrop = `
                        <div class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                            <i data-feather="image" class="w-6 h-6 text-pink-500"></i>
                        </div>
                        <p class="text-sm font-bold text-white">Upload, Drag or Paste (Ctrl+V)</p>
                        <p class="text-[10px] text-gray-400 mt-1">Auto-converts to WebP</p>`;
                    document.getElementById('dropContent').innerHTML = defaultDrop;
                    feather.replace();
                    
                    openModal('imageModal');
                    return;
                }
            });

            function handleTextEdit(e) {
                let target = e.target;
                if(target.tagName === 'IMG' || target.tagName === 'HTML' || target.tagName === 'BODY' || target.tagName === 'svg' || target.tagName === 'path') return;
                let editable = target.closest('h1, h2, h3, h4, h5, h6, p, li, a, button, label, caption, strong, em, b, u, span, div');
                if (!editable) return;

                const isContainer = Array.from(editable.children).some(child => {
                    return ['DIV', 'UL', 'OL', 'IMG', 'SECTION', 'FORM', 'TABLE', 'IFRAME', 'HEADER', 'FOOTER'].includes(child.tagName);
                });

                if ((editable.tagName === 'DIV' || editable.tagName === 'SECTION' || editable.tagName === 'A') && isContainer) return; 
                if (editable.innerText.trim().length === 0) return;

                e.preventDefault(); e.stopPropagation();
                currentElement = editable;
                openTextModal(editable);
            }

            doc.body.addEventListener('contextmenu', handleTextEdit);
            doc.body.addEventListener('dblclick', handleTextEdit);
            doc.body.addEventListener('click', (e) => {
               let t = e.target;
               if(['H1','H2','H3','H4','H5','H6','P','SPAN','A','LI'].includes(t.tagName)) {
                   handleTextEdit(e);
               }
            });
        }

        // --- MODALS & HELPERS ---
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id, e) { 
            if(e && e.target !== document.getElementById(id) && e.type === 'click') return;
            document.getElementById(id).classList.remove('active'); 
        }

        function openTextModal(element) {
            const editor = document.getElementById('richEditor');
            editor.innerHTML = element.innerHTML;
            
            const linkSection = document.getElementById('blockLinkSection');
            const linkInput = document.getElementById('blockLinkInput');
            
            const anchor = element.tagName === 'A' ? element : element.closest('a');
            
            if (anchor) {
                linkSection.classList.remove('hidden');
                linkInput.value = anchor.getAttribute('href');
                currentElement = anchor; 
            } else {
                linkSection.classList.add('hidden');
                linkInput.value = "";
            }

            closeLinkDrawer(); 
            openModal('textModal');
        }

        function applyTextUpdate() {
            if (!currentElement) return;

            const editor = document.getElementById('richEditor');
            currentElement.innerHTML = editor.innerHTML;

            const linkSection = document.getElementById('blockLinkSection');
            if (!linkSection.classList.contains('hidden')) {
                const newHref = document.getElementById('blockLinkInput').value;
                if(newHref) {
                    currentElement.setAttribute('href', newHref);
                }
            }

            saveProgress();
            closeModal('textModal');
        }

        function getUniqueFilename(baseName) {
            let name = baseName;
            let counter = 1;
            while (assetsToZip.some(a => a.name === name)) {
                const parts = baseName.split('.');
                const ext = parts.pop();
                name = `${parts.join('.')}-${counter}.${ext}`;
                counter++;
            }
            return name;
        }

        // --- ASSET LOGIC ---
        async function processNewImage(file) {
            if (!currentElement) return;
            const dropContent = document.getElementById('dropContent');
            const originalHTML = dropContent.innerHTML;
            dropContent.innerHTML = '<div class="loader mx-auto mb-2"></div><span class="text-xs">Processing...</span>';

            // 1. Get raw dimensions first to check for WordPress "Big Image" Threshold (2560px)
            const isBigImage = await checkDimensions(file);

            // 2. Compress/Convert to WebP
            let base64String = await compressImageSmart(file);
            
            let baseName = file.name.split('.')[0].toLowerCase().replace(/[\s_]+/g, '-').replace(/[^a-z0-9\-]/g, '') + ".webp";
            if (file.name === 'image.png' || file.name === 'pasted-image.png') {
                baseName = `pasted-image-${Date.now()}.webp`;
            }
            
            // 3. Store the base URL structure (we will append -scaled later if needed)
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const wpUrl = `https://${projectDomain}/wp-content/uploads/${year}/${month}/${baseName}`;

            currentElement.removeAttribute('srcset'); 
            currentElement.src = base64String; 
            
            currentElement.dataset.exportSrc = wpUrl; 
            currentElement.dataset.filename = baseName;
            
            // 4. Set the flag if it's big
            if(isBigImage) {
                currentElement.dataset.isBig = "true";
            } else {
                delete currentElement.dataset.isBig;
            }
            
            saveProgress();

            dropContent.innerHTML = originalHTML;
            document.getElementById('imgUpload').value = '';
            closeModal('imageModal');
        }

        // Helper function to check dimensions
        function checkDimensions(file) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    // WordPress threshold is 2560px
                    if(img.width > 2560 || img.height > 2560) resolve(true);
                    else resolve(false);
                    URL.revokeObjectURL(img.src);
                };
            });
        }

        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        async function handleImageUpload(input) {
            const file = input.files[0];
            if(!file) return;
            await processNewImage(file);
        }

        // FIX: Ensure URL images are NOT added to ZIP list by cleaning dataset
        function applyUrl() {
            const url = document.getElementById('urlInput').value;
            if(url && currentElement) {
                currentElement.src = url;
                currentElement.removeAttribute('srcset');
                // CLEAN DATASET so zipper ignores it
                delete currentElement.dataset.exportSrc;
                delete currentElement.dataset.filename;
                
                saveProgress();
                closeModal('imageModal');
            }
        }

        function addToZipQueue(filename, blob) {
            assetsToZip.push({ name: filename, blob: blob });
        }
        function compressImageSmart(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // FIX: Increased limit to 4000px.
                        // This preserves the "Big Image" status (>2560px) so WordPress
                        // creates the '-scaled' version as expected by your download logic.
                        const SAFE_MAX = 4000;

                        if (width > height) {
                            if (width > SAFE_MAX) {
                                height *= SAFE_MAX / width;
                                width = SAFE_MAX;
                            }
                        } else {
                            if (height > SAFE_MAX) {
                                width *= SAFE_MAX / height;
                                height = SAFE_MAX;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compress to WebP at 85% quality
                        resolve(canvas.toDataURL('image/webp', 0.85));
                    };
                };
            });
        }

        async function downloadProject() {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div> Zipping...';
            btn.classList.add('disabled');

            const zip = new JSZip();
            const cleanHTML = getCleanHTML(); 
            const parser = new DOMParser();
            const doc = parser.parseFromString(cleanHTML, "text/html");
            const imgFolder = zip.folder("images_to_upload");
            
            let usedFilenames = [];
            let hasImagesToUpload = false;

            const images = doc.querySelectorAll('img');
            
            for (let img of images) {
                if(img.dataset.exportSrc) {
                    hasImagesToUpload = true;
                    const base64Data = img.src;
                    
                    if(base64Data.startsWith('data:image')) {
                        let filename = img.dataset.filename || 'image.webp';
                        
                        // Handle duplicates
                        let counter = 1;
                        let originalName = filename.replace('.webp', '');
                        while(usedFilenames.includes(filename)) {
                            filename = `${originalName}-${counter}.webp`;
                            counter++;
                        }
                        usedFilenames.push(filename);

                        // --- WORDPRESS LOGIC FIX ---
                        const date = new Date();
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        
                        // If it was flagged as Big, add -scaled to the HTML URL
                        if(img.dataset.isBig === "true") {
                            const scaledName = filename.replace('.webp', '-scaled.webp');
                            img.dataset.exportSrc = `https://${projectDomain}/wp-content/uploads/${year}/${month}/${scaledName}`;
                        } else {
                            // Normal URL
                            img.dataset.exportSrc = `https://${projectDomain}/wp-content/uploads/${year}/${month}/${filename}`;
                        }
                        // ---------------------------

                        const response = await fetch(base64Data);
                        const blob = await response.blob();
                        
                        // Always upload the ORIGINAL filename to the zip (WordPress handles the renaming)
                        imgFolder.file(filename, blob);

                        img.src = img.dataset.exportSrc;
                    }
                    
                    // Cleanup dataset attributes so they don't appear in final code
                    delete img.dataset.exportSrc;
                    delete img.dataset.filename;
                    delete img.dataset.isBig;
                }
                
                if(img.src.includes('wp-content/uploads')) {
                     img.removeAttribute('srcset');
                }
                img.removeAttribute('style');
            }
            
            if(!hasImagesToUpload) zip.remove("images_to_upload");
            
            zip.file("index.html", doc.documentElement.outerHTML);

            const content = await zip.generateAsync({type:"blob"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = `${projectDomain.split('.')[0]}_update.zip`;
            a.click();

            openModal('successModal');
            feather.replace();

            btn.innerHTML = originalText;
            btn.classList.remove('disabled');
        }

        // Global Keyboard Shortcuts
    document.addEventListener('keydown', (e) => {
        // Undo: Ctrl+Z or Cmd+Z
        if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
            e.preventDefault();
            performUndo();
        }
        // Redo: Ctrl+Y or Cmd+Shift+Z
        if (((e.ctrlKey || e.metaKey) && e.key === 'y') || ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z')) {
            e.preventDefault();
            performRedo();
        }
    });
    </script>
</body>
</html>
