<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Review Generation - Reputifly</title>
    <link rel="icon" type="image/png" href="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        // Define the callback function in the global scope right here in the <head>.
        function initializeGoogleMaps() {
            // This function will wait for the main app object to be ready.
            if (window.reviewApp) {
                window.reviewApp.mapsApiLoaded();
            } else {
                // If the app isn't ready, wait a moment and try again.
                setTimeout(initializeGoogleMaps, 100);
            }
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXdjRQZJd9ySH5mxql4tlXCEVpDH9GGbI&libraries=places&callback=initializeGoogleMaps"></script>
    <style>
        :root {
            --bg-primary: #020010;
            --bg-secondary: #11072C;
            --accent-primary: #A855F7; /* Purple */
            --accent-secondary: #EC4899; /* Pink */
            --text-primary: #E5E7EB;
            --text-secondary: #9CA3AF;
            --border-color: rgba(168, 85, 247, 0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Animated Gradient Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 15% 25%, rgba(168, 85, 247, 0.15) 0%, transparent 40%),
                        radial-gradient(circle at 85% 75%, rgba(236, 72, 153, 0.15) 0%, transparent 40%);
            animation: background-pan 20s linear infinite;
        }

        @keyframes background-pan {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
            100% { background-position: 0% 0%; }
        }

        /* Invisible Scrollbar */
        ::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }


        /* Main Container & Card Styles */
        .polished-container, .review-item {
    background: rgba(17, 7, 44, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid var(--border-color);
    border-radius: 1rem;
    /* Limit transitions to visual-only to avoid any reflow jank */
    transition: border-color 0.3s cubic-bezier(0.25, 0.8, 0.25, 1),
                box-shadow 0.3s cubic-bezier(0.25, 0.8, 0.25, 1),
                background-color 0.3s cubic-bezier(0.25, 0.8, 0.25, 1),
                transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    position: relative;
    overflow: hidden;
}


        /* Aurora Glow Effect on Hover */
        .polished-container::after, .review-item::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(168, 85, 247, 0.2) 0%, transparent 40%);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s ease;
            z-index: 0;
            opacity: 0;
        }
        .polished-container:hover::after, .review-item:hover::after {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        .polished-container > *, .review-item > * {
            position: relative;
            z-index: 1;
        }

        .polished-container:hover {
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 20px rgba(168, 85, 247, 0.2);
        }

        /* Button Styles */
        .button-gradient {
            background-image: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
            background-size: 200% auto;
            transition: all 0.4s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: none;
            color: white;
            font-weight: 600;
        }
        .button-gradient:hover {
            background-position: right center;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4), 0 0 15px rgba(236, 72, 153, 0.3);
        }
        .button-secondary {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .button-secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
        }

        /* Input & Textarea Styles */
        input[type="text"], input[type="password"], input[type="number"], textarea, pre {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
            width: 100%;
        }
        input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.3);
            background-color: #1a0c3d;
        }

        /* Animations */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Disable screen fade for view swaps; keeps modals free to animate if you add a different class */
.fade-in-down { animation: none !important; }

        /* Notification Toast - TOP CENTER */
        #notification-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .notification-toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            border-radius: 0.75rem;
            color: white;
            font-weight: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.37);
            transform: translateY(-150%);
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.215, 0.610, 0.355, 1), opacity 0.5s ease;
        }
        .notification-toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .notification-toast.success { background: rgba(16, 185, 129, 0.5); }
        .notification-toast.error { background: rgba(239, 68, 68, 0.5); }
        .notification-toast.info { background: rgba(59, 130, 246, 0.5); }


        /* Other UI Polish */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        button:disabled, input:disabled, textarea:disabled { opacity: 0.4; cursor: not-allowed; }
        .pac-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            color: var(--text-primary);
            z-index: 10000 !important;
            font-family: 'Inter', sans-serif;
            backdrop-filter: blur(5px);
        }
        .pac-item { padding: 0.75rem; cursor: pointer; border-top: 1px solid var(--border-color); }
        .pac-item:first-child { border-top: none; }
        .pac-item:hover { background-color: rgba(168, 85, 247, 0.1); }
        .pac-item-query { font-weight: 600; color: white; }
        .sticky-header {
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 50;
            background-color: rgba(2, 0, 16, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
        }
        
        /* Glowing Progress Bar */
        .progress-bar-glow {
            background-image: linear-gradient(to right, var(--accent-primary), var(--accent-secondary), var(--accent-primary));
            background-size: 200% 200%;
            box-shadow: 0 0 10px var(--accent-primary), 0 0 15px var(--accent-secondary);
            animation: glowing-progress 3s linear infinite;
        }
        @keyframes glowing-progress {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Model Switcher */
        .model-switcher {
            display: grid;
            grid-template-columns: 1fr 1fr;
            position: relative;
            background-color: var(--bg-secondary);
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            padding: 0.25rem;
        }
        .model-switcher-bg {
            position: absolute;
            top: 0.25rem;
            height: calc(100% - 0.5rem);
            width: calc(50% - 0.25rem);
            background-image: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
            border-radius: 0.6rem;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(168, 85, 247, 0.4);
        }
        .model-switcher-bg.quality { transform: translateX(calc(100% + 0.5rem)); }
        .model-switcher-btn {
            position: relative;
            z-index: 1;
            padding: 0.6rem;
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .model-switcher-btn.active { color: white; }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="pb-40"></div>

    <!-- Modals and Notifications -->
    <div id="generic-modal-container"></div>
    <div id="notification-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                // --- STATE ---
                state: {
                    mapsInitialized: false,
                    ownerState: {
                        activeTab: 'automatic',
                        geminiApiKey: localStorage.getItem('geminiApiKey') || '',
                        geminiModel: 'flash-lite',
                        isAiGenerating: false,
                        aiProgress: 0,
                        aiLogs: [],
                        aiProgressInterval: null,
                        selectedPlace: {},
                        reviews: [],
                        bulkText: '',
                        promptGenerator: {},
                        sheetRow: {},
                        manualCompanyName: ''
                    }
                },
                // --- DOM ELEMENTS ---
                elements: {},
                // --- INITIALIZATION ---
                init() {
                    window.reviewApp = this;
                    this.resetOwnerState(false);
                    this.renderAppShell();
                    this.attachInitialListeners();
                    this.updateView();
                    setTimeout(() => this.initializeMapsForCurrentView(), 100);
                },

                mapsApiLoaded() {
                    this.state.mapsInitialized = true;
                    this.initializeMapsForCurrentView();
                },

                initializeMapsForCurrentView() {
                    if (!this.state.mapsInitialized) return;
                    this.initializeOwnerViewMaps();
                },

                // --- GOOGLE MAPS & PLACES INTEGRATION ---
                initializeOwnerViewMaps() {
                    this.initAutocomplete('owner-link-input', this.handleOwnerPlaceSelection.bind(this));
                    this.initAutocomplete('automatic-link-input', this.handleOwnerPlaceSelection.bind(this));
                },

                initAutocomplete(inputId, callback) {
                    const input = document.getElementById(inputId);
                    if (!input || input.dataset.acAttached) return;

                    const autocompleteOptions = {
                        fields: ["place_id", "name", "reviews", "user_ratings_total", "url", "types", "website", "formatted_address"],
                        types: ["establishment"]
                    };
                    const autocomplete = new google.maps.places.Autocomplete(input, autocompleteOptions);
                    input.dataset.acAttached = 'true';

                    autocomplete.addListener('place_changed', () => {
                        const place = autocomplete.getPlace();
                        callback(place);
                    });
                },

                handleOwnerPlaceSelection(place) {
                    if (!place || !place.place_id) {
                        this.showNotification("Could not retrieve company details. Please try again.", "error");
                        return;
                    }

                    const { ownerState } = this.state;
                    ownerState.selectedPlace.name = place.name || '';
                    ownerState.selectedPlace.placeId = place.place_id;
                    ownerState.selectedPlace.reviewLink = `https://search.google.com/local/writereview?placeid=${place.place_id}`;
                    ownerState.selectedPlace.startingCount = place.user_ratings_total || 0;
                    ownerState.selectedPlace.details = {
                        types: place.types || [],
                        address: place.formatted_address || '',
                        website: place.website || ''
                    };

                    if (place.reviews && place.reviews.length > 0) {
    const positiveReviews = place.reviews
        .filter(r => r.rating >= 4)
        .map(r => this.sanitizeText(r.text));
    ownerState.promptGenerator.input = positiveReviews.join('\n\n');
} else {
    ownerState.promptGenerator.input = 'No recent positive reviews found. You can paste your own points manually.';
}


                    this.showNotification(`Selected: ${place.name}`, "success");

                    if (this.state.ownerState.activeTab === 'automatic') {
                        this.runAutomaticAiGeneration(place);
                    } else {
                        this.updateView();
                    }
                },

                // --- RENDERING ---
                renderAppShell() {
                    const appEl = document.getElementById('app');
                    appEl.innerHTML = `
                        <div class="sticky-header">
                            <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
                                <div class="flex items-center justify-between py-4">
                                    <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png" alt="Reputifly Logo" class="h-8 sm:h-9">
                                    <button id="settings-btn" class="text-gray-400 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                    </button>
                                </div>
                                <nav id="main-tabs" class="-mb-px flex gap-6 overflow-x-auto sm:justify-center no-scrollbar" aria-label="Tabs">
                                </nav>
                            </div>
                        </div>
                        <div id="view-container" class="pt-10 px-4 sm:px-6 lg:px-8 max-w-screen-2xl mx-auto">
                        </div>
                    `;
                    this.elements.notificationContainer = document.getElementById('notification-container');
                },

                updateView() {
                    const { activeTab, isAiGenerating } = this.state.ownerState;
                    
                    // Update Tabs
                    const tabsContainer = document.getElementById('main-tabs');
                    tabsContainer.innerHTML = `
                        <button data-tab="automatic" class="owner-tab-btn ${activeTab === 'automatic' ? 'border-purple-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all">⭐ Automatic AI</button>
                        <button data-tab="sheetGenerator" class="owner-tab-btn ${activeTab === 'sheetGenerator' ? 'border-purple-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all">📊 Sheet Generator</button>
                        <button data-tab="submitter" class="owner-tab-btn ${activeTab === 'submitter' ? 'border-purple-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all">✍️ Manual Submitter</button>
                    `;

                    // Update Content
                    const viewContainer = document.getElementById('view-container');
                    let content = '';
                    if (isAiGenerating) {
                        content = this.renderAIGenerationView();
                    } else {
                        switch (activeTab) {
                            case 'automatic': content = this.renderOwnerAutomaticView(); break;
                            case 'sheetGenerator': content = this.renderOwnerSheetGeneratorView(); break;
                            case 'submitter': content = this.renderOwnerSubmitterView(); break;
                        }
                    }
                    viewContainer.innerHTML = content;
                    
                    setTimeout(() => this.initializeMapsForCurrentView(), 0);
                },
                
                renderAIGenerationView() {
                    const { selectedPlace, aiProgress, aiLogs } = this.state.ownerState;
                    return `
                        <div class="max-w-5xl mx-auto text-center p-8 polished-container">
                            <h2 class="text-3xl font-bold text-white mb-4">Generating Reviews...</h2>
                            <p class="text-gray-400 mb-6">The AI is crafting 50 unique reviews for <strong class="text-purple-400">${selectedPlace.name}</strong>. Please wait.</p>
                            <div class="w-full bg-gray-700 rounded-full h-2.5 my-4 shadow-inner">
                                <div class="progress-bar-glow h-2.5 rounded-full transition-all duration-500 ease-linear" style="width: ${aiProgress}%"></div>
                            </div>
                            <div id="ai-logs" class="mt-4 text-left text-xs text-gray-400 bg-black/20 p-4 rounded-lg h-40 overflow-y-auto no-scrollbar">
                                ${aiLogs.map(log => `<p>${log}</p>`).join('')}
                            </div>
                        </div>`;
                },

                renderOwnerAutomaticView() {
                    const { geminiApiKey, manualCompanyName, geminiModel } = this.state.ownerState;
                    return `
                        <div class="max-w-5xl mx-auto">
                            <div class="p-8 polished-container space-y-6">
                                <div class="text-center">
                                    <h2 class="text-3xl font-extrabold text-white">Automatic AI Review Generation</h2>
                                    <p class="text-gray-400 mt-2">Enter a short name (optional), then search for a business to begin.</p>
                                </div>
                                <div>
                                    <label for="automatic-manual-company-name" class="block text-sm font-medium text-gray-300 mb-2">Company Name (Optional)</label>
                                    <input type="text" id="automatic-manual-company-name" class="p-3" placeholder="e.g., Mike's Pizza" value="${manualCompanyName}">
                                    <p class="text-xs text-gray-500 mt-1">If you provide a name, the AI will use it. Otherwise, it will infer one.</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Select AI Model</label>
                                    <div class="model-switcher">
                                        <div class="model-switcher-bg ${geminiModel === 'flash' ? 'quality' : ''}"></div>
                                        <div class="model-switcher-btn ${geminiModel === 'flash-lite' ? 'active' : ''}" data-model="flash-lite">⚡ Quick</div>
                                        <div class="model-switcher-btn ${geminiModel === 'flash' ? 'active' : ''}" data-model="flash">💎 Quality</div>
                                    </div>
                                </div>
                                <div>
                                    <label for="automatic-link-input" class="block text-sm font-medium text-gray-300 mb-2">Search for Business</label>
                                    <div class="relative">
                                        <svg class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                        <input type="text" id="automatic-link-input" class="py-3 pr-3 pl-12" placeholder="Search for a business on Google...">
                                    </div>
                                </div>
                                ${!geminiApiKey ? '<p class="text-yellow-400 text-sm mt-2 text-center">Missing Gemini API Key. Please add it in <button id="settings-btn-inline" class="underline hover:text-yellow-200">Settings</button> to enable this feature.</p>' : ''}
                            </div>
                        </div>
                    `;
                },

                renderOwnerSubmitterView() {
                    const { selectedPlace, reviews, bulkText } = this.state.ownerState;
                    const isPlaceSelected = !!selectedPlace.placeId;
                    const areReviewsProcessed = reviews.length > 0;
                    
                    return `
                        <div class="max-w-5xl mx-auto space-y-8">
                            <div id="owner-link-section" class="p-6 polished-container">
                                 <h2 class="text-xl font-semibold text-white mb-4">Step 1: Find Business</h2>
                                 <div class="relative">
                                    <svg class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                    <input type="text" id="owner-link-input" class="py-3 pr-3 pl-12" placeholder="Search with Google..." value="${selectedPlace.name || ''}">
                                 </div>
                                 ${isPlaceSelected ? `<p class="text-sm text-green-400 mt-3">Review Link: <a href="${selectedPlace.reviewLink}" target="_blank" class="underline hover:text-green-300 break-all">${selectedPlace.reviewLink}</a></p>` : ''}
                            </div>
                            
                            ${isPlaceSelected ? `
                                <div id="owner-bulk-section" class="p-6 polished-container ${areReviewsProcessed ? 'hidden' : ''}">
                                    <h2 class="text-xl font-semibold text-white mb-4">Step 2: Paste Reviews</h2>
                                    <p class="text-sm text-gray-400 mb-3">Paste reviews here to process them manually, one per line.</p>
                                    <textarea id="owner-bulk-textarea" class="p-3 h-60 resize-y" placeholder="Example:\n\nThis place is amazing!\nGreat service and friendly staff.\nI highly recommend it.">${bulkText}</textarea>
                                    <button id="process-bulk-reviews-btn" class="mt-4 w-full button-gradient py-3 px-4 rounded-lg">Process Reviews</button>
                                </div>
                                
                                <div id="owner-reviews-section" class="p-6 polished-container ${!areReviewsProcessed ? 'hidden' : ''}">
                                    <div class="mb-6 flex flex-wrap justify-between items-center gap-4">
                                        <h2 class="text-xl font-semibold text-white">Processed Reviews (${reviews.length}) - Ready to Download</h2>
                                        <div class="flex items-center gap-3">
                                            <button id="reset-owner-reviews-btn" class="button-secondary font-bold py-2 px-4 rounded-lg">Start Over</button>
                                            <button class="download-owner-file-btn button-gradient py-2 px-4 rounded-lg" ${reviews.length === 0 ? 'disabled' : ''}>Download File</button>
                                        </div>
                                    </div>
                                    <div id="owner-reviews-container" class="max-h-[60vh] lg:max-h-[calc(100vh-250px)] overflow-y-auto pr-2 no-scrollbar">${this.renderReviewCards('owner')}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                },

                renderOwnerSheetGeneratorView() {
                    const { selectedPlace, manualCompanyName } = this.state.ownerState;
                    const isPlaceSelected = !!selectedPlace.placeId;

                    if (!isPlaceSelected) {
                        return `<div class="max-w-5xl mx-auto text-center p-8 polished-container">
                                    <h2 class="text-2xl font-bold text-white mb-2">Sheet Row Generator</h2>
                                    <p class="text-gray-400">Please select a business in the "Automatic AI" or "Manual Submitter" tab first.</p>
                                </div>`;
                    }
                    
                    const { sheetRow } = this.state.ownerState;
                    const companyNameForSheet = manualCompanyName.trim() || selectedPlace.name || '';

                    return `<div class="max-w-5xl mx-auto p-8 polished-container space-y-4">
                                <h2 class="text-2xl font-bold text-white text-center mb-2">Google Sheet Row Generator</h2>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Company Name</label>
                                        <input type="text" class="p-3" value="${companyNameForSheet}" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Starting Reviews</label>
                                        <input type="text" class="p-3" value="${selectedPlace.startingCount}" readonly>
                                    </div>
                                    <div>
                                        <label for="sheet-daily-reviews" class="block text-sm font-medium text-gray-300 mb-1">Daily Reviews</label>
                                        <input type="number" id="sheet-daily-reviews" class="p-3" value="${sheetRow.dailyReviews || '5'}">
                                    </div>
                                    <div>
                                        <label for="sheet-reviews-ordered" class="block text-sm font-medium text-gray-300 mb-1">Reviews Ordered</label>
                                        <input type="number" id="sheet-reviews-ordered" class="p-3" value="${sheetRow.reviewsOrdered || ''}">
                                    </div>
                                </div>
                                <button id="generate-sheet-row-btn" class="w-full button-gradient py-3 px-4 rounded-lg mt-4">Generate & Copy Row</button>
                                <div class="relative mt-4">
                                    <pre id="sheet-output" class="w-full p-4 pr-12 bg-black/20 border-white/10 rounded-lg whitespace-pre-wrap overflow-x-auto min-h-[6rem] text-gray-300 no-scrollbar">${sheetRow.output || 'Sheet row will appear here...'}</pre>
                                    <button id="copy-sheet-row-btn" class="absolute top-3 right-3 bg-white/10 hover:bg-white/20 p-2 rounded-lg transition-colors" title="Copy row">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>
                                    </button>
                                </div>
                            </div>`;
                },

                renderReviewCards(viewType) {
                    const { reviews } = this.state.ownerState;
                    if (reviews.length === 0) return '<p class="text-gray-400 text-center py-4">No reviews processed yet.</p>';
                    return reviews.map((review, index) => `
                        <div class="review-item p-5 mb-4">
                            <div class="flex justify-between items-start mb-3">
                                <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500">#${index + 1}</span>
                                <button data-view="${viewType}" data-index="${index}" class="remove-review-btn text-gray-500 hover:text-red-500 font-bold text-2xl leading-none p-1">&times;</button>
                            </div>
                            <textarea data-view="${viewType}" data-index="${index}" class="content-input p-3 min-h-[120px] resize-y no-scrollbar">${review.text}</textarea>
                        </div>
                    `).join('');
                },

                // --- EVENT LISTENERS & HANDLERS ---
                attachInitialListeners() {
                    const appEl = document.getElementById('app');
                    appEl.addEventListener('click', e => this.handleGenericClick(e));
                    appEl.addEventListener('input', e => this.handleGenericInput(e));
                },

                handleOwnerTabClick(tab) {
                    this.state.ownerState.activeTab = tab;
                    this.updateView();
                    if (tab === 'sheetGenerator') {
                        setTimeout(() => {
                            const input = document.getElementById('sheet-reviews-ordered');
                            if (input) input.focus();
                        }, 50);
                    }
                },

                handleGenericClick(e) {
                    const target = e.target.closest('[data-model], .owner-tab-btn, #settings-btn, #settings-btn-inline, #process-bulk-reviews-btn, #reset-owner-reviews-btn, #generate-sheet-row-btn, #copy-sheet-row-btn, .remove-review-btn, .download-owner-file-btn');
                    if (!target) return;

                    if (target.matches('[data-model]')) {
                        this.state.ownerState.geminiModel = target.dataset.model;
                        this.updateView();
                    } else if (target.matches('.owner-tab-btn')) {
                        this.handleOwnerTabClick(target.dataset.tab);
                    } else if (target.matches('#settings-btn, #settings-btn-inline')) {
                        this.showApiKeyModal();
                    } else if (target.matches('#process-bulk-reviews-btn')) {
                        this.processBulkReviews();
                    } else if (target.matches('#reset-owner-reviews-btn')) {
                        this.resetOwnerState();
                    } else if (target.matches('#generate-sheet-row-btn')) {
                        this.generateAndCopySheetRow();
                    } else if (target.matches('#copy-sheet-row-btn')) {
                        const output = document.getElementById('sheet-output').textContent;
                        if(output && output !== 'Sheet row will appear here...') {
                            this.copyToClipboard(output, 'Sheet row copied!');
                        } else { this.showNotification('Generate a row first to copy it.', 'error'); }
                    } else if (target.matches('.remove-review-btn')) {
                        this.state.ownerState.reviews.splice(target.dataset.index, 1);
                        this.updateView();
                    } else if (target.matches('.download-owner-file-btn')) {
                        const shortName = this.inferShortCompanyName(this.state.ownerState.selectedPlace.name);
                        this.triggerAutomaticDownload(shortName);
                    }
                },

                handleGenericInput(e) {
                    const target = e.target;
                    const { id, value, dataset } = target;

                    if (id === 'owner-bulk-textarea') this.state.ownerState.bulkText = value;
                    else if (id === 'automatic-manual-company-name') this.state.ownerState.manualCompanyName = value;
                    else if (id === 'sheet-daily-reviews') this.state.ownerState.sheetRow.dailyReviews = value;
                    else if (id === 'sheet-reviews-ordered') this.state.ownerState.sheetRow.reviewsOrdered = value;
                    else if (target.classList.contains('content-input')) {
                        this.state.ownerState.reviews[dataset.index].text = value;
                    }
                },

                // --- CORE LOGIC & WORKFLOWS ---
                updateAiProgress(message, percent, type = 'info') {
                    const time = `[${new Date().toLocaleTimeString()}]`;
                    let colorClass = 'text-gray-400';
                    if (type === 'success') colorClass = 'text-green-400';
                    if (type === 'error') colorClass = 'text-red-400';
                    
                    const coloredMessage = message.replace(/"(.*?)"/g, `<span class="text-purple-400">"$1"</span>`)
                                                  .replace(/(\d+%)/g, `<span class="text-pink-400">$1</span>`);

                    this.state.ownerState.aiLogs.push(`<span class="${colorClass}">${time}</span> ${coloredMessage}`);
                    
                    const logContainer = document.getElementById('ai-logs');
                    if (logContainer) {
                        logContainer.innerHTML = this.state.ownerState.aiLogs.map(log => `<p>${log}</p>`).join('');
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                },

                startSmoothProgress(targetPercent) {
                    clearInterval(this.state.ownerState.aiProgressInterval);
                    this.state.ownerState.aiProgressInterval = setInterval(() => {
                        const currentProgress = this.state.ownerState.aiProgress;
                        if (currentProgress < targetPercent) {
                            this.state.ownerState.aiProgress += 1;
                            const progressBar = document.querySelector('#view-container .progress-bar-glow');
                            if(progressBar) progressBar.style.width = `${this.state.ownerState.aiProgress}%`;
                        } else {
                            clearInterval(this.state.ownerState.aiProgressInterval);
                        }
                    }, 20); // Adjust interval for speed
                },

                async runAutomaticAiGeneration(place) {
                    const { geminiApiKey, manualCompanyName, geminiModel } = this.state.ownerState;
                    if (!geminiApiKey) {
                        this.showNotification("Cannot start: Missing Gemini API Key.", 'error');
                        return;
                    }

                    this.state.ownerState.isAiGenerating = true;
                    this.state.ownerState.aiLogs = [];
                    this.state.ownerState.aiProgress = 0;
                    this.updateView();

                    try {
                        this.updateAiProgress("Initializing generation...", 0);
                        this.startSmoothProgress(5);
                        
                        const shortName = manualCompanyName.trim() || this.inferShortCompanyName(place.name);
                        await new Promise(res => setTimeout(res, 500));
                        this.updateAiProgress(`Using company name: "${shortName}"`, 15);
                        this.startSmoothProgress(15);

                        const contextReviews = this.state.ownerState.promptGenerator.input;
                        const prompt = this.generateAutomaticPrompt(contextReviews, shortName);
                        await new Promise(res => setTimeout(res, 500));
                        this.updateAiProgress("Generated prompt for AI.", 25);
                        this.startSmoothProgress(25);

                        const model = geminiModel === 'flash-lite' ? 'gemini-2.5-flash-lite' : 'gemini-2.5-flash';
                        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${geminiApiKey}`;
                        await new Promise(res => setTimeout(res, 500));
                        this.updateAiProgress(`Sending request to "${model}"...`, 40);
                        this.startSmoothProgress(40);

                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        
                        this.updateAiProgress("Waiting for AI response...", 60);
                        this.startSmoothProgress(60);

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        await new Promise(res => setTimeout(res, 500));
                        this.updateAiProgress("Response received. Processing reviews...", 75, 'success');
                        this.startSmoothProgress(75);
                        
                        if (!data.candidates || !data.candidates[0]?.content?.parts[0]?.text) {
                            throw new Error("Invalid response structure from AI. Please try again.");
                        }
                        const aiReviewsText = data.candidates[0].content.parts[0].text;
                        
                        this.state.ownerState.bulkText = this.cleanAiResponse(aiReviewsText);
                        this.processBulkReviews(false);
                        
                        await new Promise(res => setTimeout(res, 500));
                        this.updateAiProgress("Downloading generated file...", 90);
                        this.startSmoothProgress(90);
                        
                        this.triggerAutomaticDownload(shortName);
                        
                        await new Promise(res => setTimeout(res, 500));
                        this.updateAiProgress("Generation complete!", 100, 'success');
                        this.startSmoothProgress(100);
                        
                        this.showNotification("AI Generation Complete! File downloaded.", "success");
                        
                        setTimeout(() => {
                            this.state.ownerState.isAiGenerating = false;
                            this.handleOwnerTabClick('sheetGenerator');
                        }, 1500);

                    } catch (error) {
                        clearInterval(this.state.ownerState.aiProgressInterval);
                        this.updateAiProgress(`Error: ${error.message}`, this.state.ownerState.aiProgress, 'error');
                        this.showNotification(`AI generation failed: ${error.message}`, 'error');
                        setTimeout(() => {
                            this.state.ownerState.isAiGenerating = false;
                            this.handleOwnerTabClick('automatic');
                        }, 2000);
                    }
                },

                triggerAutomaticDownload(filename) {
                    if (!filename) {
                        this.showNotification('Could not determine filename for download.', 'error');
                        return;
                    }
                    const data = { link: this.state.ownerState.selectedPlace.reviewLink, reviews: this.state.ownerState.reviews.map(r => ({text: r.text, requiresImage: false})) };
                    const dataBlob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${filename.replace(/\s+/g, '_')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },

                generateAndCopySheetRow() {
                    const { selectedPlace, manualCompanyName } = this.state.ownerState;
                    const companyNameForSheet = manualCompanyName.trim() || selectedPlace.name || '';
                    const daily = parseInt(document.getElementById('sheet-daily-reviews').value, 10) || 5;
                    const ordered = parseInt(document.getElementById('sheet-reviews-ordered').value, 10) || 0;
                    const done = 0;
                    const startingCount = selectedPlace.startingCount;
                    const endingCount = startingCount + ordered;
                    const reviewsLeft = ordered - done;
                    const output = `${companyNameForSheet}\t${daily}\t${done}\t${ordered}\t${startingCount}\t${endingCount}\t\t${reviewsLeft}`;

                    this.state.ownerState.sheetRow.output = output;
                    this.updateView();
                    this.copyToClipboard(output, 'Sheet row copied!');
                },

                inferShortCompanyName(fullName) {
                    if (!fullName) return '';
                    let name = fullName.replace(/\b(LLC|Inc|Corp|Ltd|Co|Pte)\b/gi, '').trim();
                    const parts = name.split(/[-|–—:]/);
                    let primaryName = parts[0].trim();
                    if (primaryName.length > 25) {
                        const locationKeywords = [' in ', ' at ', ' of '];
                        for (const keyword of locationKeywords) {
                            if (primaryName.toLowerCase().includes(keyword)) {
                                primaryName = primaryName.substring(0, primaryName.toLowerCase().indexOf(keyword));
                                break;
                            }
                        }
                    }
                    return primaryName.trim();
                },

                generateAutomaticPrompt(context, companyName) {
    const isQuality = this.state.ownerState.geminiModel === 'flash';

    // Optional locality (used only if it reads naturally)
    const details   = this.state.ownerState?.selectedPlace?.details || {};
    const address   = (details && details.address ? details.address : '').trim();
    const parts     = address.split(',').map(s => s.trim()).filter(Boolean);
    const cityLabel = parts.length >= 2 ? parts[parts.length - 2] : (parts[0] || '');

    // Build soft SEO hints ONLY from your inputs (no preset categories)
    const seedText = (`${companyName || ''} ${context || ''}`).toLowerCase();
    const tokens = (seedText.match(/[a-z][a-z\-]+/g) || []).filter(w => w.length > 2);
    const stop = new Set([
        'the','and','for','with','this','that','from','your','you','our','their','are','was','were','will','very','more',
        'most','much','many','about','after','before','just','out','over','under','near','in','on','to','of','at','by','it',
        'its','they','them','as','is','be','been','being','a','an','or','but','if','than','then','my','we','us','me','he',
        'she','his','her','him','hers','theirs','mine','yours','also'
    ]);
    const filtered = tokens.filter(w => !stop.has(w));

    // top unigrams
    const freq = Object.create(null);
    for (const w of filtered) freq[w] = (freq[w] || 0) + 1;
    const topWords = Object.entries(freq).sort((a,b) => b[1]-a[1]).slice(0, 8).map(([w]) => w);

    // top bigrams (captures phrase-y hints like "digital lock", "math tuition")
    const bigrams = [];
    for (let i = 0; i < filtered.length - 1; i++) {
        const a = filtered[i], b = filtered[i+1];
        if (!stop.has(a) && !stop.has(b)) bigrams.push(`${a} ${b}`);
    }
    const topBigrams = [...new Set(bigrams)].slice(0, 6);

    // compact hint set; the model is told to ignore if unnatural
    const seeds = [...new Set([...topBigrams, ...topWords])];
    const keywordPool = [...new Set(
        seeds.flatMap(k => cityLabel ? [`${k} in ${cityLabel}`, `${cityLabel} ${k}`, k] : [k])
    )].slice(0, 12);

    const companyNameInstruction = companyName
        ? `4.  **Company Name Usage:** Mention "${companyName}" in only a small, random subset of reviews (≈5–7 of 50). In all others, keep it generic ("this place", "the team", "the staff").`
        : `4.  **Company Name Usage:** Do NOT include any specific company name; use general references ("this place", "the team", "the service").`;

    // ---------- Base prompt (Quick & Quality share this core) ----------
    let prompt = `You are an expert copywriter specializing in authentic, human-like user-generated content.
TASK: Based on the CONTEXT below, craft 50 highly realistic, positive Google reviews. Each review must feel like a snapshot of a real person's genuine experience.
CONTEXT / KEYWORDS:
${(context || '').trim()}
CRITICAL REQUIREMENTS:
1.  **FORMATTING (ABSOLUTE FIRST PRIORITY):** Output ONLY the reviews. No intro/outro. Separate each review with ONE blank line (double newline). Do NOT number or bullet them.
2.  **NARRATIVE & DETAIL:** Avoid generic praise. Tell a mini-story: a situation, what happened, and the result/feeling. Use plausible, specific details consistent with the CONTEXT.
3.  **NATURAL VARIETY:** 50 different voices. Vary tone, sentence length, punctuation, and formality. Use emojis sparingly and only when natural.
${companyNameInstruction}
5.  **AUTHENTICITY & PRIVACY:** Do not invent personal data. No staff names unless present in CONTEXT. No unrealistic claims, no incentives, no insider/employee perspective.
6.  **PLAIN TEXT ONLY:** No markdown (e.g., **bold**, *italics*, __underscores__, ~~strike~~, backticks), no hashtags, no full addresses, no unit/suite numbers (e.g., "#02-3539"), no phone numbers, no emails, no URLs.`;

    // ---------- PERFECT QUALITY MODE ----------
    if (isQuality) {
        const keywordList = keywordPool.join('; ');

        prompt += `

QUALITY MODE — PERFECT VARIETY & NON-REPETITION

A) OUTPUT CONTROL
- Produce EXACTLY 50 reviews, each as one paragraph, separated by ONE blank line, no numbering/bullets.

B) RANDOMIZED STRUCTURE (NO BLOCK PATTERNS)
- For each review, RANDOMLY choose ONE structure from the catalog below.
- Do NOT use any structure more than 6 times total and NEVER more than 2 times in a row.
- Shuffle structures across the 50 outputs; avoid visible blocks (e.g., 1–10 same structure).

VARIETY CATALOG (pick 1 per review)
1) Problem → Solution → Outcome
2) Before/After transformation
3) First-time anxiety → reassurance after visit
4) Small hiccup handled gracefully → overall positive
5) Feature spotlight (one clear feature/benefit only)
6) Speed/turnaround focus (booking, response, delivery)
7) Value/price clarity (what you paid vs. benefit you got)
8) Atmosphere/ambience, comfort, cleanliness
9) Communication & follow-up (messages, calls, clarity)
10) Comparison to previous provider (no naming competitors)
11) Family/kids-friendly or elderly-friendly perspective
12) Accessibility/convenience (hours, parking/transport—not full addresses)
13) Repeat customer/loyalty angle (why you keep returning)
14) Special occasion / urgent need scenario
15) Technical/quality geek-out (one specific, accurate detail only)
16) Staff helpfulness without names (use roles like "front desk", "technician")
17) Expectations vs. reality (pleasant surprise)
18) Out-of-the-way but worth it (no addresses)
19) Booking/payment smoothness
20) Post-service follow-through (after-sales, check-ins)

C) SENTENCE & RHYTHM DIVERSITY
- Each review: 2–6 sentences total (~50–140 words).
- Vary rhythm: mix a short punchy sentence with longer ones; use occasional compound/complex sentences.
- Rotate openers. Avoid repeating the same 3-word start more than once across all 50 (e.g., not many “I was” / “We were”).

D) SEO CURATION (SUBTLE, NATURAL)
- First infer the business type & offerings ONLY from CONTEXT/company name.
- Optionally weave ONE soft phrase per review if natural; ignore if awkward. Helpful hints (optional): [${keywordList}]
- Mention locality like "${cityLabel}" at most once in some reviews (not all).

E) SPECIFICITY WITHOUT PII
- Include concrete moments (what you asked for, what you received, how staff handled a request, timing/turnaround, how the result helped).
- No addresses, unit numbers, phone, email, or URLs. If present in CONTEXT, ignore it.

F) PERSONA & INTENT ROTATION
- Rotate personas: solo, couple, parent, busy professional, student, elderly caretaker, hobbyist, first-timer, repeat customer.
- Rotate intents: urgent fix, regular maintenance/class, upgrade, gift, trial, evaluation after a prior bad experience (without naming).

G) PHRASE & LEXICAL LIMITS (ANTI-REPETITION)
- Hard limits across all 50: "highly recommend" ≤ 2; "top-notch" ≤ 1; "worth every penny" = 0; "amazing service" ≤ 2; "great experience" ≤ 2.
- Prefer synonyms and paraphrases; avoid echoing the same adjective twice in the same review.

H) QUALITY & READABILITY
- Prefer clarity over buzzwords. No keyword stuffing. Human voice > SEO.

I) FINAL SELF-CHECK (MANDATORY)
- Before returning, scan all 50: if any two reviews share the same opening 5 words, rewrite one.
- If any sentence is duplicated verbatim across reviews, rewrite one.
- If more than 2 reviews in a row use the same structure, rewrite to a different structure.
- Ensure plain text only (no markdown/hashtags/addresses/units/contacts).`;
    }

    return prompt;
},

sanitizeText(text) {
    if (!text) return '';
    let t = String(text);

    // Remove markdown (**bold**, *italics*, __underline__, ~~strike~~, `code`)
    t = t.replace(/\*\*(.*?)\*\*/g, '$1')
         .replace(/__(.*?)__/g, '$1')
         .replace(/\*(.*?)\*/g, '$1')
         .replace(/~~(.*?)~~/g, '$1')
         .replace(/`{1,3}([^`]+)`{1,3}/g, '$1');

    // Remove hashtags & unit/suite numbers (e.g., #02-3539, #123, #B1-23)
    t = t.replace(/#\s?[A-Za-z]?\d{1,5}(?:-[A-Za-z0-9]{1,5})?\b/g, '');

    // Remove "Unit/Suite/Level/Lvl/Blk/Block 02-3539" forms
    t = t.replace(/\b(?:unit|suite|level|lvl|blk|block)\s*[A-Za-z]?\d{1,5}(?:-[A-Za-z0-9]{1,5})?\b/gi, '');

    // Remove SG postal line (e.g., Singapore 123456)
    t = t.replace(/\bS(?:ingapore)?\s*\d{6}\b/gi, '');

    // Strip URLs, emails, phone numbers
    t = t.replace(/\b(?:https?:\/\/|www\.)\S+\b/gi, '')
         .replace(/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi, '')
         .replace(/\b\+?\d[\d\-\s]{6,}\b/g, '');

    // Collapse extra spaces and fix punctuation spacing
    t = t.replace(/\s*([.,!?:;])\s*/g, '$1 ').replace(/\s{2,}/g, ' ').trim();
    return t;
},


                cleanAiResponse(aiText) {
    const reviewsArray = aiText.trim().split(/\n\s*\n/);
    const firstReviewIndex = reviewsArray.findIndex(line => line.length > 25 && !/^\s*here are|sure, here|absolutely/i.test(line));
    const text = firstReviewIndex !== -1 ? reviewsArray.slice(firstReviewIndex).join('\n\n') : aiText.trim();
    return this.sanitizeText(text);
},


                processBulkReviews(shouldRender = true) {
    const { bulkText } = this.state.ownerState;
    const normalized = (bulkText || '').replace(/\r\n/g, '\n').trim();
    if (!normalized) {
        this.showNotification("No reviews found to process.", "error");
        return;
    }

    // Prefer paragraph split (blank lines). Fallback to per-line if no blank lines.
    const blocks = (/\n\s*\n/.test(normalized) ? normalized.split(/\n\s*\n/g) : normalized.split(/\n/g))
        .map(b => b.trim())
        .filter(b => b.length > 0);

    // Soft de-duplication (ignore whitespace/case)
    const seen = new Set();
    const unique = [];
    for (const b of blocks) {
        const key = b.replace(/\s+/g, ' ').toLowerCase();
        if (!seen.has(key)) {
            seen.add(key);
            unique.push(b);
        }
    }

    if (!unique.length) {
        this.showNotification("No reviews found to process.", "error");
        return;
    }

    this.state.ownerState.reviews = unique.map(text => ({ text: this.sanitizeText(text) }));
    this.showNotification(`${unique.length} unique ${unique.length === 1 ? 'review' : 'reviews'} processed.`, "success");
    if (shouldRender) this.updateView();
},


                // --- UTILITIES & MODALS ---
                resetOwnerState(shouldRender = true) {
                    this.state.ownerState = {
                        ...this.state.ownerState,
                        isAiGenerating: false,
                        selectedPlace: { name: '', reviewLink: '', startingCount: 0, placeId: '', details: null },
                        reviews: [],
                        bulkText: '',
                        promptGenerator: { input: '', output: '' },
                        sheetRow: { dailyReviews: '5', reviewsOrdered: '', output: '' },
                        manualCompanyName: ''
                    };
                    if (shouldRender) this.updateView();
                },

                showApiKeyModal() {
                    const currentKey = this.state.ownerState.geminiApiKey;
                    const modalContainer = document.getElementById('generic-modal-container');
                    modalContainer.innerHTML = `
                        <div class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-[10000] p-4 fade-in-down">
                            <form id="api-key-form" class="polished-container p-8 w-full max-w-md">
                                <h2 class="text-2xl font-bold text-white mb-4">Gemini API Key</h2>
                                <p class="text-gray-400 mb-6">Enter your Gemini API key to enable AI features. Your key is saved locally in your browser.</p>
                                <input type="password" id="modal-api-key-input" class="p-3" placeholder="Enter your API key..." value="${currentKey}">
                                <div class="flex justify-end gap-4 mt-6">
                                    <button type="button" id="modal-cancel" class="button-secondary font-bold py-2 px-6 rounded-lg">Cancel</button>
                                    <button type="submit" class="button-gradient py-2 px-6 rounded-lg">Save Key</button>
                                </div>
                            </form>
                        </div>`;
                    const form = document.getElementById('api-key-form');
                    const input = document.getElementById('modal-api-key-input');
                    input.focus();
                    document.getElementById('modal-cancel').onclick = () => modalContainer.innerHTML = '';
                    form.onsubmit = (e) => {
                        e.preventDefault();
                        const newKey = input.value.trim();
                        if (newKey) {
                            this.state.ownerState.geminiApiKey = newKey;
                            localStorage.setItem('geminiApiKey', newKey);
                            this.showNotification('API Key saved successfully!');
                            modalContainer.innerHTML = '';
                            this.updateView();
                        } else {
                            this.showNotification('API Key cannot be empty.', 'error');
                        }
                    };
                },

                copyToClipboard(text, message = "Copied to clipboard!") {
                    navigator.clipboard.writeText(text).then(() => {
                        this.showNotification(message);
                    }, () => {
                        this.showNotification("Failed to copy.", 'error');
                    });
                },

                showNotification(message, type = 'success') {
                    const id = `toast-${Date.now()}`;
                    const toast = document.createElement('div');
                    toast.id = id;
                    toast.className = `notification-toast ${type}`;

                    const icons = {
                        success: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                        error: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                        info: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`
                    };

                    toast.innerHTML = `${icons[type] || ''}<span>${message}</span>`;
                    this.elements.notificationContainer.appendChild(toast);

                    // Animate in
                    setTimeout(() => toast.classList.add('show'), 10);

                    // Animate out and remove
                    setTimeout(() => {
                        toast.classList.remove('show');
                        toast.addEventListener('transitionend', () => toast.remove());
                    }, 4000);
                }
            };

            app.init();
        });
    </script>
</body>
</html>
