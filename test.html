<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Review Generation - Reputifly</title>
    <link rel="icon" type="image/png" href="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        // Define the callback function in the global scope right here in the <head>.
        // This ensures it exists before the Google Maps script loads and tries to call it.
        function initializeGoogleMaps() {
            // This function will wait for the main app object to be ready.
            if (window.reviewApp) {
                window.reviewApp.mapsApiLoaded();
            } else {
                // If the app isn't ready, wait a moment and try again.
                setTimeout(initializeGoogleMaps, 100);
            }
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXdjRQZJd9ySH5mxql4tlXCEVpDH9GGbI&libraries=places&callback=initializeGoogleMaps"></script>
    <style>
        :root {
            --bg-primary: #020010;
            --bg-secondary: #11072C;
            --accent-primary: #A855F7; /* Purple */
            --accent-secondary: #EC4899; /* Pink */
            --text-primary: #E5E7EB;
            --text-secondary: #9CA3AF;
            --border-color: rgba(168, 85, 247, 0.2);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Animated Gradient Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(circle at 15% 25%, rgba(168, 85, 247, 0.15) 0%, transparent S40%),
                        radial-gradient(circle at 85% 75%, rgba(236, 72, 153, 0.15) 0%, transparent 40%);
            animation: background-pan 20s linear infinite;
        }

        @keyframes background-pan {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
            100% { background-position: 0% 0%; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }

        /* Main Container & Card Styles */
        .polished-container, .review-item {
            background: rgba(17, 7, 44, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        /* Aurora Glow Effect on Hover */
        .polished-container::after, .review-item::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(168, 85, 247, 0.2) 0%, transparent 40%);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s ease;
            z-index: 0;
            opacity: 0;
        }
        .polished-container:hover::after, .review-item:hover::after {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        .polished-container > *, .review-item > * {
            position: relative;
            z-index: 1;
        }

        .polished-container:hover {
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 20px rgba(168, 85, 247, 0.2);
        }

        /* Button Styles */
        .button-gradient {
            background-image: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
            background-size: 200% auto;
            transition: all 0.4s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: none;
            color: white;
            font-weight: 600;
        }
        .button-gradient:hover {
            background-position: right center;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4), 0 0 15px rgba(236, 72, 153, 0.3);
        }
        .button-secondary {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .button-secondary:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-primary);
        }

        /* Input & Textarea Styles */
        input[type="text"], input[type="password"], input[type="number"], textarea {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            color: var(--text-primary);
            transition: all 0.3s ease;
            width: 100%;
        }
        input[type="text"]:focus, input[type="password"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.3);
            background-color: #1a0c3d;
        }

        /* Animations */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-down { animation: fadeInDown 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }

        /* Notification Toast - TOP CENTER */
        #notification-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10001;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .notification-toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            border-radius: 0.75rem;
            color: white;
            font-weight: 500;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.37);
            transform: translateY(-150%);
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.215, 0.610, 0.355, 1), opacity 0.5s ease;
        }
        .notification-toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .notification-toast.success { background: rgba(16, 185, 129, 0.5); }
        .notification-toast.error { background: rgba(239, 68, 68, 0.5); }
        .notification-toast.info { background: rgba(59, 130, 246, 0.5); }


        /* Other UI Polish */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        button:disabled, input:disabled, textarea:disabled { opacity: 0.4; cursor: not-allowed; }
        .pac-container {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            color: var(--text-primary);
            z-index: 10000 !important;
            font-family: 'Inter', sans-serif;
            backdrop-filter: blur(5px);
        }
        .pac-item { padding: 0.75rem; cursor: pointer; border-top: 1px solid var(--border-color); }
        .pac-item:first-child { border-top: none; }
        .pac-item:hover { background-color: rgba(168, 85, 247, 0.1); }
        .pac-item-query { font-weight: 600; color: white; }
        .sticky-header {
            position: sticky;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 50;
            background-color: rgba(2, 0, 16, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top: 4px solid var(--accent-primary);
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Model Switcher */
        .model-switcher {
            display: grid;
            grid-template-columns: 1fr 1fr;
            position: relative;
            background-color: var(--bg-secondary);
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            padding: 0.25rem;
        }
        .model-switcher-bg {
            position: absolute;
            top: 0.25rem;
            height: calc(100% - 0.5rem);
            width: calc(50% - 0.25rem);
            background-image: linear-gradient(to right, var(--accent-primary), var(--accent-secondary));
            border-radius: 0.6rem;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(168, 85, 247, 0.4);
        }
        .model-switcher-bg.quality { transform: translateX(calc(100% + 0.5rem)); }
        .model-switcher-btn {
            position: relative;
            z-index: 1;
            padding: 0.6rem;
            text-align: center;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .model-switcher-btn.active { color: white; }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="pb-40">
        <!-- Views will be rendered here by JS -->
        <div id="owner-view"></div>
    </div>

    <!-- Modals and Notifications -->
    <div id="generic-modal-container"></div>
    <div id="notification-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const app = {
                // --- STATE ---
                state: {
                    currentView: 'owner',
                    mapsInitialized: false,
                    placesService: null,
                    ownerState: {
                        activeTab: 'automatic',
                        geminiApiKey: localStorage.getItem('geminiApiKey') || '',
                        geminiModel: 'flash-lite', // 'flash-lite' or 'flash'
                        isAiGenerating: false,
                        selectedPlace: {},
                        reviews: [],
                        bulkText: '',
                        promptGenerator: {},
                        sheetRow: {},
                        manualCompanyName: ''
                    }
                },
                // --- DOM ELEMENTS ---
                elements: {
                    app: document.getElementById('app'),
                    ownerView: document.getElementById('owner-view'),
                    genericModalContainer: document.getElementById('generic-modal-container'),
                    notificationContainer: document.getElementById('notification-container'),
                },
                // --- INITIALIZATION ---
                init() {
                    window.reviewApp = this;
                    this.resetOwnerState(false);
                    this.attachInitialListeners();
                    this.render();
                    // Delay map initialization slightly to ensure view is rendered
                    setTimeout(() => this.initializeMapsForCurrentView(), 100);
                },

                mapsApiLoaded() {
                    this.state.mapsInitialized = true;
                    this.initializeMapsForCurrentView();
                },

                initializeMapsForCurrentView() {
                    if (!this.state.mapsInitialized) return;
                    if (this.state.currentView === 'owner') this.initializeOwnerViewMaps();
                },

                // --- GOOGLE MAPS & PLACES INTEGRATION ---
                initializeOwnerViewMaps() {
                    this.initAutocomplete('owner-link-input', this.handleOwnerPlaceSelection.bind(this));
                    this.initAutocomplete('automatic-link-input', this.handleOwnerPlaceSelection.bind(this));
                },

                initAutocomplete(inputId, callback) {
                    if (!this.state.mapsInitialized) return;
                    const input = document.getElementById(inputId);
                    if (!input || input.dataset.acAttached) return;

                    const autocompleteOptions = {
                        fields: ["place_id", "name", "reviews", "user_ratings_total", "url", "types", "website", "formatted_address"],
                        types: ["establishment"]
                    };
                    const autocomplete = new google.maps.places.Autocomplete(input, autocompleteOptions);
                    input.dataset.acAttached = 'true';

                    autocomplete.addListener('place_changed', () => {
                        const place = autocomplete.getPlace();
                        callback(place);
                    });
                },

                handleOwnerPlaceSelection(place) {
                    if (!place || !place.place_id) {
                        this.showNotification("Could not retrieve company details. Please try again.", "error");
                        return;
                    }

                    const { ownerState } = this.state;
                    ownerState.selectedPlace.name = place.name || '';
                    ownerState.selectedPlace.placeId = place.place_id;
                    ownerState.selectedPlace.reviewLink = `https://search.google.com/local/writereview?placeid=${place.place_id}`;
                    ownerState.selectedPlace.startingCount = place.user_ratings_total || 0;
                    ownerState.selectedPlace.details = {
                        types: place.types || [],
                        address: place.formatted_address || '',
                        website: place.website || ''
                    };

                    if (place.reviews && place.reviews.length > 0) {
                        const positiveReviews = place.reviews.filter(r => r.rating >= 4).map(r => r.text);
                        ownerState.promptGenerator.input = positiveReviews.join('\n\n');
                    } else {
                        ownerState.promptGenerator.input = 'No recent positive reviews found. You can paste your own points manually.';
                    }

                    this.showNotification(`Selected: ${place.name}`, "success");

                    if (this.state.ownerState.activeTab === 'automatic') {
                        this.runAutomaticAiGeneration(place);
                    } else {
                        this.render();
                    }
                },

                // --- RENDERING ---
                render() {
                    if (this.state.currentView === 'owner') this.renderOwnerView();
                },

                renderOwnerView() {
                    const { activeTab } = this.state.ownerState;
                    this.elements.ownerView.innerHTML = `
                        <div class="sticky-header">
                            <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
                                <div class="flex items-center justify-between py-4">
                                    <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png" alt="Reputifly Logo" class="h-8 sm:h-9">
                                    <button id="settings-btn" class="text-gray-400 hover:text-white transition-colors p-2 rounded-full hover:bg-white/10">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                    </button>
                                </div>
                                <nav class="-mb-px flex gap-6 overflow-x-auto sm:justify-center no-scrollbar" aria-label="Tabs">
                                    <button data-tab="automatic" class="owner-tab-btn ${activeTab === 'automatic' ? 'border-purple-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all">⭐ Automatic AI</button>
                                    <button data-tab="sheetGenerator" class="owner-tab-btn ${activeTab === 'sheetGenerator' ? 'border-purple-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all">📊 Sheet Generator</button>
                                    <button data-tab="submitter" class="owner-tab-btn ${activeTab === 'submitter' ? 'border-purple-500 text-white' : 'border-transparent text-gray-400 hover:text-gray-200'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-all">✍️ Manual Submitter</button>
                                </nav>
                            </div>
                        </div>
                        <div class="pt-10 px-4 sm:px-6 lg:px-8 max-w-screen-2xl mx-auto">
                            <div id="owner-automatic-view" class="${activeTab !== 'automatic' ? 'hidden' : ''} fade-in-down">${this.renderOwnerAutomaticView()}</div>
                            <div id="owner-sheet-generator-view" class="${activeTab !== 'sheetGenerator' ? 'hidden' : ''} fade-in-down">${this.renderOwnerSheetGeneratorView()}</div>
                            <div id="owner-submitter-view" class="${activeTab !== 'submitter' ? 'hidden' : ''} fade-in-down">${this.renderOwnerSubmitterView()}</div>
                        </div>
                    `;
                    // Re-initialize maps after render
                    setTimeout(() => this.initializeOwnerViewMaps(), 0);
                },

                renderOwnerAutomaticView() {
                    const { isAiGenerating, selectedPlace, geminiApiKey, manualCompanyName, geminiModel } = this.state.ownerState;

                    if (isAiGenerating) {
                        return `
                        <div class="max-w-2xl mx-auto text-center p-8 polished-container">
                            <h2 class="text-3xl font-bold text-white mb-4">Generating Reviews...</h2>
                            <p class="text-gray-400 mb-6">The AI is crafting 50 unique reviews for <strong class="text-purple-400">${selectedPlace.name}</strong>. This may take up to a minute. Please wait.</p>
                            <div class="flex justify-center mt-8">
                                <div class="spinner"></div>
                            </div>
                        </div>`;
                    }

                    return `
                        <div class="max-w-2xl mx-auto">
                            <div class="p-8 polished-container space-y-6">
                                <div class="text-center">
                                    <h2 class="text-3xl font-extrabold text-white">Automatic AI Review Generation</h2>
                                    <p class="text-gray-400 mt-2">Enter a short name (optional), then search for a business to begin.</p>
                                </div>
                                <div>
                                    <label for="automatic-manual-company-name" class="block text-sm font-medium text-gray-300 mb-2">Company Name (Optional)</label>
                                    <input type="text" id="automatic-manual-company-name" class="p-3" placeholder="e.g., Mike's Pizza" value="${manualCompanyName}">
                                    <p class="text-xs text-gray-500 mt-1">If you provide a name, the AI will use it. Otherwise, it will infer one.</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Select AI Model</label>
                                    <div class="model-switcher">
                                        <div class="model-switcher-bg ${geminiModel === 'flash' ? 'quality' : ''}"></div>
                                        <div class="model-switcher-btn ${geminiModel === 'flash-lite' ? 'active' : ''}" data-model="flash-lite">⚡ Quick</div>
                                        <div class="model-switcher-btn ${geminiModel === 'flash' ? 'active' : ''}" data-model="flash">💎 Quality</div>
                                    </div>
                                </div>
                                <div>
                                    <label for="automatic-link-input" class="block text-sm font-medium text-gray-300 mb-2">Search for Business</label>
                                    <div class="relative">
                                        <svg class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                        <input type="text" id="automatic-link-input" class="py-3 pr-3 pl-12" placeholder="Search for a business on Google...">
                                    </div>
                                </div>
                                ${!geminiApiKey ? '<p class="text-yellow-400 text-sm mt-2 text-center">Missing Gemini API Key. Please add it in <button id="settings-btn-inline" class="underline hover:text-yellow-200">Settings</button> to enable this feature.</p>' : ''}
                            </div>
                        </div>
                    `;
                },

                renderOwnerSubmitterView() {
                    const { selectedPlace, reviews, bulkText } = this.state.ownerState;
                    const isPlaceSelected = !!selectedPlace.placeId;
                    const areReviewsProcessed = reviews.length > 0;

                    // If no place is selected yet, only show the centered search box.
                    if (!isPlaceSelected) {
                        return `
                            <div class="max-w-2xl mx-auto">
                                <div id="owner-link-section" class="p-6 polished-container">
                                     <h2 class="text-xl font-semibold text-white mb-4">Step 1: Find Business</h2>
                                     <div class="relative">
                                        <svg class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                        <input type="text" id="owner-link-input" class="py-3 pr-3 pl-12" placeholder="Search with Google..." value="">
                                     </div>
                                </div>
                            </div>
                        `;
                    }

                    // Once a place is selected, render the full two-column layout.
                    return `
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-8">
                                <div id="owner-link-section" class="p-6 polished-container">
                                     <h2 class="text-xl font-semibold text-white mb-4">Step 1: Find Business</h2>
                                     <div class="relative">
                                        <svg class="absolute left-4 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                        <input type="text" id="owner-link-input" class="py-3 pr-3 pl-12" placeholder="Search with Google..." value="${selectedPlace.name || ''}">
                                     </div>
                                     <p class="text-sm text-green-400 mt-3">Review Link: <a href="${selectedPlace.reviewLink}" target="_blank" class="underline hover:text-green-300 break-all">${selectedPlace.reviewLink}</a></p>
                                </div>
                                <div id="owner-bulk-section" class="p-6 polished-container ${areReviewsProcessed ? 'hidden' : ''}">
                                    <h2 class="text-xl font-semibold text-white mb-4">Step 2: Paste Reviews</h2>
                                    <p class="text-sm text-gray-400 mb-3">Paste reviews here to process them manually, one per line.</p>
                                    <textarea id="owner-bulk-textarea" class="p-3 h-60 resize-y" placeholder="Paste reviews here...">${bulkText}</textarea>
                                    <button id="process-bulk-reviews-btn" class="mt-4 w-full button-gradient py-3 px-4 rounded-lg">Process Reviews</button>
                                </div>
                            </div>
                            <div id="owner-reviews-section">
                                <div class="mb-6 flex flex-wrap justify-between items-center gap-4">
                                    <h2 class="text-xl font-semibold text-white">Step 3: Manage Reviews (${reviews.length})</h2>
                                    <div class="flex items-center gap-3">
                                        <button id="reset-owner-reviews-btn" class="button-secondary font-bold py-2 px-4 rounded-lg">Start Over</button>
                                        <button class="download-owner-file-btn button-gradient py-2 px-4 rounded-lg" ${reviews.length === 0 ? 'disabled' : ''}>Download File</button>
                                    </div>
                                </div>
                                <div id="owner-reviews-container" class="max-h-[60vh] lg:max-h-[calc(100vh-250px)] overflow-y-auto pr-2">${this.renderReviewCards('owner')}</div>
                            </div>
                        </div>`;
                },

                renderOwnerSheetGeneratorView() {
                    const { selectedPlace, manualCompanyName } = this.state.ownerState;
                    const isPlaceSelected = !!selectedPlace.placeId;

                    if (!isPlaceSelected) {
                        return `<div class="max-w-2xl mx-auto text-center p-8 polished-container">
                                    <h2 class="text-2xl font-bold text-white mb-2">Sheet Row Generator</h2>
                                    <p class="text-gray-400">Please select a business in the "Automatic AI" or "Manual Submitter" tab first.</p>
                                </div>`;
                    }
                    
                    const { sheetRow } = this.state.ownerState;
                    const companyNameForSheet = manualCompanyName.trim() || selectedPlace.name || '';

                    return `<div class="max-w-2xl mx-auto p-8 polished-container space-y-4">
                                <h2 class="text-2xl font-bold text-white text-center mb-2">Google Sheet Row Generator</h2>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Company Name</label>
                                        <input type="text" class="p-3" value="${companyNameForSheet}" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-1">Starting Reviews</label>
                                        <input type="text" class="p-3" value="${selectedPlace.startingCount}" readonly>
                                    </div>
                                    <div>
                                        <label for="sheet-daily-reviews" class="block text-sm font-medium text-gray-300 mb-1">Daily Reviews</label>
                                        <input type="number" id="sheet-daily-reviews" class="p-3" value="${sheetRow.dailyReviews || '5'}">
                                    </div>
                                    <div>
                                        <label for="sheet-reviews-ordered" class="block text-sm font-medium text-gray-300 mb-1">Reviews Ordered</label>
                                        <input type="number" id="sheet-reviews-ordered" class="p-3" value="${sheetRow.reviewsOrdered || ''}">
                                    </div>
                                </div>
                                <button id="generate-sheet-row-btn" class="w-full button-gradient py-3 px-4 rounded-lg mt-4">Generate & Copy Row</button>
                                <div class="relative mt-4">
                                    <pre id="sheet-output" class="w-full p-4 pr-12 bg-black/20 border border-white/10 rounded-lg whitespace-pre-wrap overflow-x-auto min-h-[6rem] text-gray-300">${sheetRow.output || 'Sheet row will appear here...'}</pre>
                                    <button id="copy-sheet-row-btn" class="absolute top-3 right-3 bg-white/10 hover:bg-white/20 p-2 rounded-lg transition-colors" title="Copy row">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>
                                    </button>
                                </div>
                            </div>`;
                },

                renderReviewCards(viewType) {
                    const { reviews } = this.state[`${viewType}State`];
                    if (reviews.length === 0) return '<p class="text-gray-400 text-center py-4">No reviews processed yet.</p>';
                    return reviews.map((review, index) => `
                        <div class="review-item p-5 mb-4">
                            <div class="flex justify-between items-start mb-3">
                                <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500">#${index + 1}</span>
                                <button data-view="${viewType}" data-index="${index}" class="remove-review-btn text-gray-500 hover:text-red-500 font-bold text-2xl leading-none p-1">&times;</button>
                            </div>
                            <textarea data-view="${viewType}" data-index="${index}" class="content-input p-3 h-24 resize-y">${review.text}</textarea>
                        </div>
                    `).join('');
                },

                // --- EVENT LISTENERS & HANDLERS ---
                attachInitialListeners() {
                    this.elements.app.addEventListener('click', e => this.handleGenericClick(e));
                    this.elements.app.addEventListener('input', e => this.handleGenericInput(e));
                },

                handleOwnerTabClick(tab) {
                    this.state.ownerState.activeTab = tab;
                    this.render();
                },

                handleGenericClick(e) {
                    const target = e.target.closest('[data-model], .owner-tab-btn, #settings-btn, #settings-btn-inline, #process-bulk-reviews-btn, #reset-owner-reviews-btn, #generate-sheet-row-btn, #copy-sheet-row-btn, .remove-review-btn, .download-owner-file-btn');
                    if (!target) return;

                    if (target.matches('[data-model]')) {
                        this.state.ownerState.geminiModel = target.dataset.model;
                        this.render();
                    } else if (target.matches('.owner-tab-btn')) {
                        this.handleOwnerTabClick(target.dataset.tab);
                    } else if (target.matches('#settings-btn, #settings-btn-inline')) {
                        this.showApiKeyModal();
                    } else if (target.matches('#process-bulk-reviews-btn')) {
                        this.processBulkReviews();
                    } else if (target.matches('#reset-owner-reviews-btn')) {
                        this.resetOwnerState();
                    } else if (target.matches('#generate-sheet-row-btn')) {
                        this.generateAndCopySheetRow();
                    } else if (target.matches('#copy-sheet-row-btn')) {
                        const output = document.getElementById('sheet-output').textContent;
                        if(output && output !== 'Sheet row will appear here...') {
                            this.copyToClipboard(output, 'Sheet row copied!');
                        } else { this.showNotification('Generate a row first to copy it.', 'error'); }
                    } else if (target.matches('.remove-review-btn')) {
                        const viewType = target.dataset.view;
                        this.state[`${viewType}State`].reviews.splice(target.dataset.index, 1);
                        this.render();
                    } else if (target.matches('.download-owner-file-btn')) {
                        const shortName = this.inferShortCompanyName(this.state.ownerState.selectedPlace.name);
                        this.triggerAutomaticDownload(shortName);
                    }
                },

                handleGenericInput(e) {
                    const target = e.target;
                    const { id, value, dataset } = target;

                    if (id === 'owner-bulk-textarea') this.state.ownerState.bulkText = value;
                    else if (id === 'automatic-manual-company-name') this.state.ownerState.manualCompanyName = value;
                    else if (id === 'sheet-daily-reviews') this.state.ownerState.sheetRow.dailyReviews = value;
                    else if (id === 'sheet-reviews-ordered') this.state.ownerState.sheetRow.reviewsOrdered = value;
                    else if (dataset.view && target.classList.contains('content-input')) {
                        this.state[`${dataset.view}State`].reviews[dataset.index].text = value;
                    }
                },

                // --- CORE LOGIC & WORKFLOWS ---
                async runAutomaticAiGeneration(place) {
                    const { geminiApiKey, manualCompanyName, geminiModel } = this.state.ownerState;
                    if (!geminiApiKey) {
                        this.showNotification("Cannot start: Missing Gemini API Key.", 'error');
                        this.state.ownerState.activeTab = 'automatic';
                        this.render();
                        return;
                    }

                    this.state.ownerState.isAiGenerating = true;
                    this.render();

                    try {
                        const shortName = manualCompanyName.trim() || this.inferShortCompanyName(place.name);
                        this.showNotification(`Generating reviews for "${shortName}"...`, 'info');

                        const contextReviews = this.state.ownerState.promptGenerator.input;
                        const prompt = this.generateAutomaticPrompt(contextReviews, shortName);

                        const model = geminiModel === 'flash-lite' ? 'gemini-2.5-flash-lite' : 'gemini-2.5-flash-preview-05-20';
                        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${geminiApiKey}`;

                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();

                        if (!data.candidates || !data.candidates[0]?.content?.parts[0]?.text) {
                            throw new Error("Invalid response structure from AI. Please try again.");
                        }
                        const aiReviewsText = data.candidates[0].content.parts[0].text;

                        this.state.ownerState.bulkText = this.cleanAiResponse(aiReviewsText);
                        this.processBulkReviews();
                        this.showNotification("AI Generation Complete! File downloaded.", "success");
                        this.triggerAutomaticDownload(shortName);
                        this.state.ownerState.activeTab = 'sheetGenerator';

                    } catch (error) {
                        this.showNotification(`AI generation failed: ${error.message}`, 'error');
                        this.state.ownerState.activeTab = 'automatic';
                    } finally {
                        this.state.ownerState.isAiGenerating = false;
                        this.render();
                    }
                },

                triggerAutomaticDownload(filename) {
                    if (!filename) {
                        this.showNotification('Could not determine filename for download.', 'error');
                        return;
                    }
                    const data = { link: this.state.ownerState.selectedPlace.reviewLink, reviews: this.state.ownerState.reviews.map(r => ({text: r.text, requiresImage: false})) };
                    const dataBlob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${filename.replace(/\s+/g, '_')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    this.showNotification(`File '${a.download}' downloaded!`);
                },

                generateAndCopySheetRow() {
                    const { selectedPlace, manualCompanyName } = this.state.ownerState;
                    const companyNameForSheet = manualCompanyName.trim() || selectedPlace.name || '';
                    const daily = parseInt(document.getElementById('sheet-daily-reviews').value, 10) || 5;
                    const ordered = parseInt(document.getElementById('sheet-reviews-ordered').value, 10) || 0;
                    const done = 0;
                    const startingCount = selectedPlace.startingCount;
                    const endingCount = startingCount + ordered;
                    const reviewsLeft = ordered - done;
                    const output = `${companyNameForSheet}\t${daily}\t${done}\t${ordered}\t${startingCount}\t${endingCount}\t\t${reviewsLeft}`;

                    this.state.ownerState.sheetRow.output = output;
                    this.render();
                    this.copyToClipboard(output, 'Sheet row copied!');
                },

                inferShortCompanyName(fullName) {
                    if (!fullName) return '';
                    let name = fullName.replace(/\b(LLC|Inc|Corp|Ltd|Co|Pte)\b/gi, '').trim();
                    const parts = name.split(/[-|–—:]/);
                    let primaryName = parts[0].trim();
                    if (primaryName.length > 25) {
                        const locationKeywords = [' in ', ' at ', ' of '];
                        for (const keyword of locationKeywords) {
                            if (primaryName.toLowerCase().includes(keyword)) {
                                primaryName = primaryName.substring(0, primaryName.toLowerCase().indexOf(keyword));
                                break;
                            }
                        }
                    }
                    return primaryName.trim();
                },

                generateAutomaticPrompt(context, companyName) {
                    let companyNameInstruction = companyName
                        ? `4.  **Company Name Usage:** Mention the specific company name, "${companyName}", in only a small, random subset of reviews (e.g., 5-7 out of 50). For all other reviews, use general terms like "this place," "the team," "the staff," or describe the experience without naming the business.`
                        : `4.  **Company Name Usage:** Do NOT mention any specific company name. Use general terms like "this place," "the team," "the service," or "they."`;

                    return `You are an expert copywriter specializing in creating authentic, human-like user-generated content.
TASK: Based on the CONTEXT below, craft 50 highly realistic, positive Google reviews. Each review must feel like a snapshot of a real person's genuine experience.
CONTEXT / KEYWORDS:
${context.trim()}
CRITICAL REQUIREMENTS:
1.  **FORMATTING (ABSOLUTE FIRST PRIORITY):** Your response MUST consist ONLY of the reviews. DO NOT include ANY introductory or concluding text. Separate each individual review with a double newline. DO NOT number the reviews or use any separators like "----".
2.  **NARRATIVE & DETAIL (HIGHEST QUALITY PRIORITY):** Avoid generic praise. Instead, TELL A STORY. A significant portion of reviews must describe a specific situation, outcome, or feeling. Invent plausible, specific details to make reviews credible.
3.  **NATURAL & VARIED LANGUAGE:** Write from 50 completely different perspectives and voices. Vary tone, emotion, sentence structure, and length extensively. AVOID repetitive sentence starters. Mimic real-world typing: use different capitalization, varied punctuation, and use emojis (like 😊, 👍, ⭐, 🎉) very sparingly.
${companyNameInstruction}
5.  **AUTHENTICITY:** To enhance realism, a few reviews can mention a minor, neutral point before giving strong praise.`;
                },

                cleanAiResponse(aiText) {
                    const reviewsArray = aiText.trim().split(/\n\s*\n/);
                    const firstReviewIndex = reviewsArray.findIndex(line => line.length > 25 && !/^\s*here are|sure, here|absolutely/i.test(line));
                    return firstReviewIndex !== -1 ? reviewsArray.slice(firstReviewIndex).join('\n\n') : aiText.trim();
                },

                processBulkReviews() {
                    const { bulkText } = this.state.ownerState;
                    const lines = bulkText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                    const uniqueLines = [...new Set(lines)];
                    if (uniqueLines.length === 0) {
                        this.showNotification("No reviews found to process.", "error");
                        return;
                    }
                    this.state.ownerState.reviews = uniqueLines.map(line => ({ text: line }));
                    this.showNotification(`${uniqueLines.length} unique reviews processed.`, "success");
                    this.render();
                },

                // --- UTILITIES & MODALS ---
                resetOwnerState(shouldRender = true) {
                    this.state.ownerState = {
                        ...this.state.ownerState,
                        // Keep activeTab, API key and model selection
                        isAiGenerating: false,
                        selectedPlace: { name: '', reviewLink: '', startingCount: 0, placeId: '', details: null },
                        reviews: [],
                        bulkText: '',
                        promptGenerator: { input: '', output: '' },
                        sheetRow: { dailyReviews: '5', reviewsOrdered: '', output: '' },
                        manualCompanyName: ''
                    };
                    if (shouldRender) this.render();
                },

                showApiKeyModal() {
                    const currentKey = this.state.ownerState.geminiApiKey;
                    this.elements.genericModalContainer.innerHTML = `
                        <div class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-[10000] p-4 fade-in-down">
                            <form id="api-key-form" class="polished-container p-8 w-full max-w-md">
                                <h2 class="text-2xl font-bold text-white mb-4">Gemini API Key</h2>
                                <p class="text-gray-400 mb-6">Enter your Gemini API key to enable AI features. Your key is saved locally in your browser.</p>
                                <input type="password" id="modal-api-key-input" class="p-3" placeholder="Enter your API key..." value="${currentKey}">
                                <div class="flex justify-end gap-4 mt-6">
                                    <button type="button" id="modal-cancel" class="button-secondary font-bold py-2 px-6 rounded-lg">Cancel</button>
                                    <button type="submit" class="button-gradient py-2 px-6 rounded-lg">Save Key</button>
                                </div>
                            </form>
                        </div>`;
                    const form = document.getElementById('api-key-form');
                    const input = document.getElementById('modal-api-key-input');
                    input.focus();
                    document.getElementById('modal-cancel').onclick = () => this.elements.genericModalContainer.innerHTML = '';
                    form.onsubmit = (e) => {
                        e.preventDefault();
                        const newKey = input.value.trim();
                        if (newKey) {
                            this.state.ownerState.geminiApiKey = newKey;
                            localStorage.setItem('geminiApiKey', newKey);
                            this.showNotification('API Key saved successfully!');
                            this.elements.genericModalContainer.innerHTML = '';
                            this.render();
                        } else {
                            this.showNotification('API Key cannot be empty.', 'error');
                        }
                    };
                },

                copyToClipboard(text, message = "Copied to clipboard!") {
                    navigator.clipboard.writeText(text).then(() => {
                        this.showNotification(message);
                    }, () => {
                        this.showNotification("Failed to copy.", 'error');
                    });
                },

                showNotification(message, type = 'success') {
                    const id = `toast-${Date.now()}`;
                    const toast = document.createElement('div');
                    toast.id = id;
                    toast.className = `notification-toast ${type}`;

                    const icons = {
                        success: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                        error: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                        info: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`
                    };

                    toast.innerHTML = `${icons[type] || ''}<span>${message}</span>`;
                    this.elements.notificationContainer.appendChild(toast);

                    // Animate in
                    setTimeout(() => toast.classList.add('show'), 10);

                    // Animate out and remove
                    setTimeout(() => {
                        toast.classList.remove('show');
                        toast.addEventListener('transitionend', () => toast.remove());
                    }, 4000);
                }
            };

            app.init();
        });
    </script>
</body>
</html>
