<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Agreement Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* 1. Global Styles & Theme */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        :root {
            --bg-dark-primary: #100c1f;    /* Deep dark purple background */
            --bg-dark-secondary: #231e39;  /* Lighter purple for containers */
            --primary-accent: #a74aff;     /* Bright purple for buttons/highlights */
            --primary-accent-hover: #b96aff;
            --text-light: #f0f0f0;         /* Light text for dark backgrounds */
            --text-secondary: #a0a0c0;     /* Muted text for labels/placeholders */
            --border-color: #3e385e;
            --document-bg: #ffffff;        /* White background for the 'paper' */
            --document-text: #333333;      /* Dark text for the 'paper' */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-dark-primary);
            color: var(--text-light);
            padding: 2rem;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* 2. Main Layout Containers */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
        }

        .form-container {
            background-color: var(--bg-dark-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            height: fit-content;
            position: sticky;
            top: 2rem; /* Sticks to the top while scrolling */
        }

        .preview-container {
            background-color: var(--bg-dark-secondary);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        /* 3. Form Styling */
        .form-container h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--text-light);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            background-color: var(--bg-dark-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="date"]:focus,
        .form-group input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px rgba(167, 74, 255, 0.3);
        }

        .form-group input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        /* Input group for % sign */
        .input-group {
            position: relative;
        }

        .input-group .suffix {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .input-group input[type="number"] {
            padding-right: 2.5rem; /* Make space for the '%' sign */
        }

        /* Button Styling */
        .download-button {
            width: 100%;
            padding: 0.875rem;
            font-size: 1rem;
            font-weight: 700;
            color: #ffffff;
            background-color: var(--primary-accent);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }

        .download-button:hover {
            background-color: var(--primary-accent-hover);
            transform: translateY(-2px);
        }

        /* 4. NEW: Signature Pad Styling */
        .label-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .clear-button {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .clear-button:hover {
            background-color: var(--border-color);
            color: var(--text-light);
        }
        
        #signature-canvas {
            width: 100%;
            height: 120px;
            background-color: var(--document-bg); /* White background */
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: crosshair;
        }
        
        /* 5. Document Preview Styling */
        .document-preview {
            background-color: var(--document-bg);
            color: var(--document-text);
            padding: 3rem;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            font-size: 10pt; /* Standard contract font size */
            line-height: 1.7;
        }

        .document-preview h1 {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 2rem;
            text-transform: uppercase;
            color: #000;
        }

        .document-preview h2 {
            font-size: 1rem;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            color: #000;
            border-bottom: 1px solid #ccc;
            padding-bottom: 0.25rem;
        }
        
        .document-preview h3 {
            font-size: 0.9rem;
            font-weight: 700;
            margin-top: 1rem;
            margin-bottom: 0.25rem;
            color: #222;
        }

        .document-preview p,
        .document-preview li {
            margin-bottom: 0.5rem;
            text-align: justify;
        }

        .document-preview strong {
            color: #000;
            font-weight: 700;
        }

        /* Placeholder for empty fields */
        .placeholder {
            font-family: monospace;
            color: #555;
            background-color: #f0f0f0;
            padding: 0 2px;
            border-radius: 2px;
            min-width: 100px;
            display: inline-block;
            text-align: center;
        }

        .section-group {
            margin-bottom: 1rem;
            border: 1px solid #eee;
            padding: 1rem;
            border-radius: 4px;
        }

        .section-group p {
            margin: 0;
            line-height: 1.8;
        }
        
        .section-group strong {
            display: block;
            margin-bottom: 0.25rem;
            color: #111;
        }
        
        .signatures {
            margin-top: 3rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            font-size: 0.9rem;
        }
        
        .sig-block {
            border-top: 1px solid #999;
            padding-top: 0.5rem;
        }
        
        .sig-block p {
            margin-bottom: 0.25rem;
        }

        /* NEW: Container for the signature image in the doc */
        .signature-image-container {
            height: 60px; /* Give it a fixed height */
            margin-bottom: 0.5rem;
            display: flex;
            align-items: flex-end; /* Signature sits on the line */
        }
        
        #developer-signature-img {
            max-width: 200px;
            max-height: 60px;
            object-fit: contain;
            /* This <img> is empty until populated by JS */
        }


        /* 6. NEW: Responsive Mobile Optimization */
        @media (max-width: 900px) {
            body {
                padding: 1rem;
            }
            .container {
                /* Stack form and preview vertically */
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            .form-container {
                /* Un-stick the form */
                position: static;
                padding: 1rem;
            }
            .preview-container {
                padding: 1rem;
            }
            .document-preview {
                /* Tighter padding for small screens */
                padding: 1.5rem;
                font-size: 9pt;
            }
            .signatures {
                /* Stack signature blocks */
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
        }
        
    </style>
</head>
<body>

    <div class="container">
        
        <aside class="form-container">
            <h2>Agreement Generator</h2>
            
            <div class="form-group">
                <label for="effective-date">Effective Date</label>
                <input type="date" id="effective-date">
            </div>

            <div class="form-group">
                <label for="client-name">Client Legal/Company Name</label>
                <input type="text" id="client-name" placeholder="e.g., Acme Inc.">
            </div>

            <div class="form-group">
                <label for="deposit-percent">Deposit Percentage</label>
                <div class="input-group">
                    <input type="number" id="deposit-percent" value="50" min="0" max="100">
                    <span class="suffix">%</span>
                </div>
            </div>
            
            <div class="form-group">
                <div class="label-group">
                    <label for="signature-canvas">Your Signature (Developer)</label>
                    <button id="clear-signature-btn" class="clear-button">Clear</button>
                </div>
                <canvas id="signature-canvas"></canvas>
            </div>
            <button id="download-btn" class="download-button">
                Generate & Download PDF
            </button>
        </aside>

        <main class="preview-container">
            <div class="document-preview" id="document-to-print">
                
                <h1>SERVICE AGREEMENT (GENERAL TEMPLATE)</h1>

                <div class="section-group">
                    <p><strong>Effective Date:</strong> 
                        <span id="dynamic-date" class="placeholder">____________________</span>
                    </p>
                </div>
                
                <div class="section-group">
                    <p><strong>Developer/Service Provider:</strong></p>
                    <p>
                        Reputifly Pte Ltd (UEN: 202531855M)<br>
                        12 Woodlands Square, #13-79, Woods Square Tower, Singapore 737715<br>
                        (“Developer”)
                    </p>
                </div>

                <div class="section-group">
                    <p><strong>Client:</strong></p>
                    <p>
                        Legal/Company Name: <span id="dynamic-client-name" class="placeholder">____________________</span><br>
                        UEN (if any): __________________<br>
                        Registered Address: __________________________________________________________<br>
                        Primary Contact & Email: ______________________________________________________<br>
                        (“Client”)
                    </p>
                </div>

                <h2>1. PURPOSE & SCOPE</h2>
                <p>Developer will provide professional services to Client as described in Section 1.1 and/or an attached Statement of Work (SOW).</p>
                <h3>1.1 Deliverables (Example Structure — customise per project)</h3>
                <p><strong>Core Deliverables:</strong> _______________________________________________________</p>
                <p><strong>Supporting Tasks:</strong> _______________________________________________________</p>
                <p><strong>Environment/Platform (if any):</strong> __________________________________________</p>
                <p><strong>Handover Items:</strong> admin credentials, documentation/guide (if applicable).</p>
                <p><i>*Unless otherwise agreed, the project is limited to the Deliverables above and reasonable industry-standard implementation.</i></p>

                <h2>2. REVISIONS</h2>
                <p>Client is entitled to <strong>three (3) full revision rounds</strong>.</p>
                <p>A <strong>“full revision round”</strong> is a consolidated list of requested changes affecting layout, styling, content, or configuration across the in‑scope work.</p>
                <p><strong>Not counted as a revision:</strong> small text edits (e.g., typos, minor copy tweaks, swapping a single image/label).</p>

                <h2>3. TIMELINE</h2>
                <p><strong>Initial Draft Target:</strong> within <strong>one (1) week</strong> from the later of (a) the Effective Date or (b) the date Developer receives all required materials and access.</p>
                <p><strong>Feedback Window:</strong> Client provides consolidated feedback <strong>within 2 business days</strong> after each milestone.</p>
                <p>Delays by Client extend the timeline day‑for‑day.</p>
                <p><strong>Target Completion/Go‑Live:</strong> promptly after final approval and any required cutover.</p>
                <p>
                    <strong>Milestones (fill in):</strong><br>
                    Draft Delivery: ______________________<br>
                    Revision 1: __________________________<br>
                    Revision 2: __________________________<br>
                    Final Approval: ______________________
                </p>

                <h2>4. CLIENT RESPONSIBILITIES</h2>
                <p>Provide timely content, brand assets, approvals, and access/credentials for relevant systems.</p>
                <p>Ensure provided materials comply with law and do not infringe third‑party rights.</p>
                <p>Nominate a single authorised point‑of‑contact for approvals and feedback.</p>

                <h2>5. FEES & PAYMENT</h2>
                <p><strong>Project Fee:</strong> <strong>S$<span id="dynamic-project-fee">590.00</span></strong> (fixed unless otherwise agreed).</p>
                
                <p><strong>Payment Schedule:</strong> 
                    <strong><span id="dynamic-deposit-percent">50</span>% deposit</strong> 
                    (S$<span id="dynamic-deposit-amount">295.00</span>) 
                    to commence; 
                    <strong><span id="dynamic-balance-percent">50</span>% balance</strong> 
                    (S$<span id="dynamic-balance-amount">295.00</span>) 
                    due upon completion/Acceptance and prior to handover or go‑live.
                </p>
                <p><strong>Third‑Party/Pass‑Through Costs (if any):</strong> e.g., domains, hosting, plugins, SaaS, payment gateways, SMS credits, stock media.</p>
                <p>Such costs are borne by Client and are <strong>non‑refundable</strong> once purchased/activated.</p>
                <p><strong>Deposit:</strong> Non‑refundable once work begins.</p>
                <p><strong>Suspension for Non‑Payment:</strong> Developer may suspend work/access for overdue invoices or material breach by Client;</p>
                <p>suspension time does not count toward deadlines.</p>

                <h2>6. CHANGE MANAGEMENT</h2>
                <p>Requests outside scope, additional features/pages/modules, or work beyond the allocated revision rounds will be handled via a <strong>Change Order</strong> with separate fees and timeline.</p>
                <p>Work proceeds upon Client’s written approval.</p>

                <h2>7. ACCEPTANCE</h2>
                <p>A deliverable is deemed <strong>Accepted</strong> when the earlier of: (i) Client’s written approval, or (ii) <strong>five (5) business days</strong> after delivery without material objection.</p>
                <p>After Acceptance, further changes are treated as change requests.</p>

                <h2>8. INTELLECTUAL PROPERTY & LICENSE</h2>
                <p><strong>Pre‑existing IP:</strong> Developer retains all rights to pre‑existing code, components, templates, libraries, frameworks, processes, and know‑how.</p>
                <p><strong>Work Product:</strong> Upon <strong>full and cleared payment</strong>, Developer grants Client a <strong>perpetual, worldwide, non‑exclusive license</strong> to use the delivered work for Client’s own business at the agreed channels/domains.</p>
                <p>Title to pre‑existing IP does not transfer.</p>
                <p><strong>Third‑Party Licenses:</strong> Any third‑party tools/themes/fonts/plugins/media/SaaS are governed by their respective licenses.</p>

                <h2>9. WARRANTY & SUPPORT</h2>
                <p><strong>Defect Remediation:</strong> For <strong>14 days</strong> after final go‑live/handover, Developer will remedy reproducible defects within the delivered scope at no additional cost.</p>
                <p><strong>Exclusions:</strong> Issues caused by third‑party outages, Client changes, incompatible or expired third‑party licenses, force majeure, or requests that constitute new features/configurations.</p>

                <h2>10. SERVICE AVAILABILITY (IF APPLICABLE)</h2>
                <p>If the Services include hosting or a managed platform, availability targets (e.g., <strong>99.99% uptime ≈ 52.6 minutes downtime/year</strong>) are defined and measured by the underlying provider’s policy.</p>
                <p>Scheduled/emergency maintenance, force majeure, upstream network issues, DDoS, and Client‑caused incidents are excluded.</p>
                <p>Any credits issued by the provider will be <strong>passed through</strong> to Client as the <strong>sole remedy</strong> for availability shortfalls.</p>

                <h2>11. TERMINATION; FAILURE TO COMPLETE; REFUNDS</h2>
                <p><strong>Client Convenience Termination:</strong> Client may terminate with <strong>7 days’ written notice</strong>;</p>
                <p>Client will pay for all work performed up to the effective termination date.</p>
                <p><strong>Termination for Cause:</strong> Either party may terminate if the other fails to cure a <strong>material breach within 7 days</strong> of written notice.</p>
                <p><strong>Developer Unable to Complete:</strong> If Developer is unable to complete the project <strong>due to Developer‑caused reasons</strong> (and Client is not in breach), Developer will <strong>refund all sums paid</strong> <em>minus</em> non‑refundable third‑party costs already incurred on Client’s behalf (e.g., domains, hosting, licenses, transaction fees).</p>
                <p>This is Client’s <strong>sole and exclusive remedy</strong> for non‑completion.</p>
                <p>Upon termination, Developer may withhold deliverables and project files until all due amounts are paid.</p>

                <h2>12. LIMITATION OF LIABILITY</h2>
                <p>To the fullest extent permitted by law, Developer’s total aggregate liability under this Agreement is <strong>capped at the total fees paid by Client to Developer for the specific project</strong>, and Developer is <strong>not liable</strong> for consequential, incidental, special, punitive, loss‑of‑profits, or data‑loss damages.</p>

                <h2>13. CONFIDENTIALITY; PUBLICITY</h2>
                <p>Each party will keep the other’s non‑public information confidential. Developer may <strong>display the project in portfolios and marketing materials</strong> (excluding sensitive data), unless Client opts out in writing before go‑live.</p>

                <h2>14. GOVERNING LAW; DISPUTE RESOLUTION</h2>
                <p>This Agreement is governed by the laws of <strong>Singapore</strong>. Parties will attempt good‑faith negotiation;</p>
                <p>failing which, disputes shall be submitted to the <strong>Singapore Mediation Centre</strong> for mediation prior to litigation.</p>

                <h2>15. MISCELLANEOUS</h2>
                <p>This is the entire agreement and supersedes prior discussions. Amendments must be in writing and signed.</p>
                <p>If any provision is held invalid, the remainder remains effective. Assignment by Client requires Developer’s consent.</p>
                
                <div class="signatures">
                    <div class="sig-block" id="client-sig-block">
                        <p><strong>SIGNED FOR AND ON BEHALF OF CLIENT</strong></p>
                        <p>Client Name: _______________________________________________</p>
                        <p>Company Name: <span id="dynamic-client-name-sig">____________________</span></p>
                        <p>UEN (if any): ________________________________________</p>
                        <p>Company Address: ________________________________________</p>
                        <br><br>
                        <p>Signature: _________________________ Date: ____________</p>
                    </div>
                    
                    <div class="sig-block">
                        <p><strong>SIGNED FOR AND ON BEHALF OF DEVELOPER</strong></p>
                        <p>Reputifly Pte Ltd (UEN: 202531855M)</p>
                        <p>12 Woodlands Square, #13-79, Woods Square Tower, Singapore 737715</p>
                        
                        <div class="signature-image-container">
                            <img id="developer-signature-img" src="" alt="" />
                        </div>
                        
                        <p>Authorised Signatory: __________________ Date: ____________</p>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 1. Define Constants & Select Elements ---
            
            // The total fee is fixed as requested
            const TOTAL_FEE = 590.00;

            // Input fields
            const dateInput = document.getElementById('effective-date');
            const nameInput = document.getElementById('client-name');
            const percentInput = document.getElementById('deposit-percent');
            
            // Dynamic <span> elements in the preview
            const dynamicDate = document.getElementById('dynamic-date');
            const dynamicClientName = document.getElementById('dynamic-client-name');
            const dynamicClientNameSig = document.getElementById('dynamic-client-name-sig');
            
            const dynamicProjectFee = document.getElementById('dynamic-project-fee');
            const dynamicDepositPercent = document.getElementById('dynamic-deposit-percent');
            const dynamicDepositAmount = document.getElementById('dynamic-deposit-amount');
            const dynamicBalancePercent = document.getElementById('dynamic-balance-percent');
            const dynamicBalanceAmount = document.getElementById('dynamic-balance-amount');

            // The download button
            const downloadBtn = document.getElementById('download-btn');
            
            // The element to print
            const documentToPrint = document.getElementById('document-to-print');

            // NEW: Signature Pad elements
            const signatureCanvas = document.getElementById('signature-canvas');
            const clearSignatureBtn = document.getElementById('clear-signature-btn');
            const devSignatureImg = document.getElementById('developer-signature-img'); // The <img> in the doc
            const signatureContext = signatureCanvas.getContext('2d');
            
            // Placeholder text
            const datePlaceholder = '____________________';
            const namePlaceholder = '____________________';
            
            // --- 2. Helper Function for Formatting ---

            // Formats a number as SGD currency
            function formatCurrency(amount) {
                return amount.toLocaleString('en-SG', {
                    style: 'currency',
                    currency: 'SGD',
                    minimumFractionDigits: 2
                }).replace('SGD', '').trim(); // Remove "SGD" prefix for cleaner integration
            }
            
            // Formats a date from 'YYYY-MM-DD' to 'DD MMMM YYYY'
            function formatDate(dateString) {
                if (!dateString) return datePlaceholder;
                try {
                    const [year, month, day] = dateString.split('-');
                    const dateObj = new Date(year, month - 1, day);
                    return dateObj.toLocaleDateString('en-GB', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                } catch (e) {
                    return datePlaceholder;
                }
            }

            // --- 3. Core Logic: Update Preview ---
            
            function updatePreview() {
                // Get raw values
                const rawDate = dateInput.value;
                const rawName = nameInput.value;
                const rawPercent = parseFloat(percentInput.value) || 0; // Default to 0 if NaN

                // Sanitize values
                const depositPercent = Math.max(0, Math.min(100, rawPercent));
                const balancePercent = 100 - depositPercent;
                
                // Calculate fees
                const depositAmount = TOTAL_FEE * (depositPercent / 100);
                const balanceAmount = TOTAL_FEE - depositAmount;

                // --- Update the DOM ---
                
                // Update Date
                const formattedDate = formatDate(rawDate);
                dynamicDate.textContent = formattedDate;
                dynamicDate.classList.toggle('placeholder', formattedDate === datePlaceholder);

                // Update Client Name
                dynamicClientName.textContent = rawName || namePlaceholder;
                dynamicClientNameSig.textContent = rawName || namePlaceholder;
                dynamicClientName.classList.toggle('placeholder', !rawName);
                dynamicClientNameSig.classList.toggle('placeholder', !rawName);
                
                // Update Fees
                // This is based on 
                dynamicProjectFee.textContent = formatCurrency(TOTAL_FEE);
                
                // This is based on 
                dynamicDepositPercent.textContent = depositPercent.toFixed(0); // No decimals for %
                dynamicDepositAmount.textContent = formatCurrency(depositAmount);
                dynamicBalancePercent.textContent = balancePercent.toFixed(0);
                dynamicBalanceAmount.textContent = formatCurrency(balanceAmount);
            }

            // --- 4. NEW: Signature Pad Logic ---
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            function setCanvasSize() {
                // Set canvas internal resolution to match its CSS-driven display size
                signatureCanvas.width = signatureCanvas.offsetWidth;
                signatureCanvas.height = signatureCanvas.offsetHeight;
                signatureContext.strokeStyle = '#000000'; // Signature color
                signatureContext.lineWidth = 2;
                signatureContext.lineCap = 'round';
            }

            function getCoords(e) {
                // Handle both mouse and touch events
                let event = e.touches ? e.touches[0] : e;
                const rect = signatureCanvas.getBoundingClientRect();
                return [
                    event.clientX - rect.left,
                    event.clientY - rect.top
                ];
            }

            function startDrawing(e) {
                e.preventDefault(); // Prevent page scroll on touch
                isDrawing = true;
                [lastX, lastY] = getCoords(e);
            }

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                
                const [currentX, currentY] = getCoords(e);
                
                signatureContext.beginPath();
                signatureContext.moveTo(lastX, lastY);
                signatureContext.lineTo(currentX, currentY);
                signatureContext.stroke();
                
                [lastX, lastY] = [currentX, currentY];
            }

            function stopDrawing() {
                isDrawing = false;
            }

            function clearSignature() {
                signatureContext.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                devSignatureImg.src = ''; // Also clear the image in the doc
            }

            // Attach signature listeners
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing); // Stop if mouse leaves canvas

            signatureCanvas.addEventListener('touchstart', startDrawing, { passive: false });
            signatureCanvas.addEventListener('touchmove', draw, { passive: false });
            signatureCanvas.addEventListener('touchend', stopDrawing);

            clearSignatureBtn.addEventListener('click', clearSignature);

            // Set initial canvas size
            setCanvasSize();
            // Adjust on window resize
            window.addEventListener('resize', setCanvasSize);


            // --- 5. Core Logic: Download PDF (UPDATED) ---
            
            function downloadPDF() {
                const clientName = nameInput.value || 'Client';
                const date = dateInput.value || new Date().toISOString().split('T')[0];
                const filename = `Service_Agreement_${clientName.replace(/[^a-z0-9]/gi, '_')}_${date}.pdf`;

                // --- Inject Signature ---
                // Check if the canvas is empty by comparing it to a blank one
                const blank = document.createElement('canvas');
                blank.width = signatureCanvas.width;
                blank.height = signatureCanvas.height;
                const isSignatureEmpty = signatureCanvas.toDataURL() === blank.toDataURL();
                
                if (!isSignatureEmpty) {
                    // Get signature as a Data URL
                    const signatureDataUrl = signatureCanvas.toDataURL('image/png');
                    // Place it in the <img> tag within the document
                    devSignatureImg.src = signatureDataUrl;
                }
                // --- End Injection ---

                const options = {
                    margin:       [0.75, 0.75, 0.75, 0.75], // top, left, bottom, right in inches
                    filename:     filename,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true }, // Higher scale for better quality
                    jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
                };

                // Use html2pdf library
                html2pdf().from(documentToPrint).set(options).save().then(() => {
                    // --- Cleanup ---
                    // After PDF is generated, clear the image src
                    // so it doesn't stay in the preview
                    if (!isSignatureEmpty) {
                        devSignatureImg.src = '';
                    }
                });
            }

            // --- 6. Attach Event Listeners ---
            
            // Update preview on any form change
            dateInput.addEventListener('input', updatePreview);
            nameInput.addEventListener('input', updatePreview);
            percentInput.addEventListener('input', updatePreview);

            // Handle the download button click
            downloadBtn.addEventListener('click', downloadPDF);

            // --- 7. Initial Run ---
            
            // Run once on load to set the default (50/50) values
            updatePreview();
        });
    </script>
</body>
</html>
