<!DOCTYPE html>
<html lang="en" class="reputify-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codex Notes Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/feather-icons"></script>

    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js' defer></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
      // Initialize Tailwind CSS custom theme
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'accent-primary': 'var(--accent-primary)',
              'accent-primary-dark': 'var(--accent-primary-dark)',
              'bg-main': 'var(--bg-main)',
              'bg-pane-light': 'var(--bg-pane-light)',
              'bg-pane-dark': 'var(--bg-pane-dark)',
              'text-primary': 'var(--text-primary)',
              'text-secondary': 'var(--text-secondary)',
              'text-tertiary': 'var(--text-tertiary)',
              'border-color': 'var(--border-color)',
            }
          }
        }
      }
    </script>

    <style type="text/tailwindcss">
        /* --- Base & Color Variables --- */
        :root {
            --bg-main: #FFFFFF;
            --bg-pane-light: #F9F9F9;
            --bg-pane-dark: #F4F4F4;
            --text-primary: #1a1a1a;
            --text-secondary: #555555;
            --text-tertiary: #888888;
            --accent-primary: #007aff;
            --accent-primary-dark: #007aff;
            --border-color: #EAEAEA;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --brand-grad-from: #007aff;
            --brand-grad-to: #007aff;
        }

        .dark {
            --bg-main: #111827;
            --bg-pane-light: #1f2937;
            --bg-pane-dark: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --accent-primary: #3898ff;
            --accent-primary-dark: #007aff;
            --border-color: #374151;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --brand-grad-from: #3898ff;
            --brand-grad-to: #3898ff;
        }

        .reputify-theme {
            --bg-main: #100F1B;
            --bg-pane-light: #181624;
            --bg-pane-dark: #211F30;
            --text-primary: #F0F0F0;
            --text-secondary: #A0A0B8;
            --text-tertiary: #6C6A7E;
            --accent-primary: #E6397F;
            --accent-primary-dark: #FF8A00;
            --border-color: #2A2837;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --brand-grad-from: #E6397F;
            --brand-grad-to: #FF8A00;
        }

        .brand-button {
            background-image: linear-gradient(to right, var(--brand-grad-from), var(--brand-grad-to));
            color: white;
            border: none;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* --- UI Polish & Animations --- */
        .pane-resizer { transition: background-color 0.2s ease; }
        .pane-resizer:hover, .pane-resizer.dragging { background-color: var(--accent-primary); }

        .collection-item .chevron { transition: transform 0.15s ease; }
        .collection-item.open > .chevron { transform: rotate(90deg); }
        .collection-item-wrapper.drop-target-folder { background-color: rgba(230, 57, 127, 0.1); }
        
        .kanban-card {
            background-color: var(--bg-main);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px -2px var(--shadow-color); }
        .kanban-card.dragging { opacity: 0.5; transform: rotate(3deg); }

        .kanban-card.pinned, .list-note-item.pinned {
            border-color: var(--accent-primary);
            box-shadow: 0 0 8px -2px var(--accent-primary);
        }
        
        .drop-indicator { height: 2px; background-color: var(--accent-primary); margin: 4px 0; pointer-events: none; }
        
        .context-menu, .dropdown-menu { transition: opacity 100ms ease, transform 100ms ease; }
        
        #note-editor-body:empty:before {
            content: attr(data-placeholder);
            color: var(--text-tertiary);
            pointer-events: none;
            display: block;
        }
        #note-editor-body a, #markdown-preview a, #summary-content a, .chat-bubble a {
            color: var(--accent-primary);
            text-decoration: underline;
            cursor: pointer;
        }
        #note-editor-body ul, #markdown-preview ul, #summary-content ul, .chat-bubble ul, .ai-summary ul { list-style: disc; padding-left: 2rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        #note-editor-body ol, #markdown-preview ol, #summary-content ol, .chat-bubble ol, .ai-summary ol { list-style: decimal; padding-left: 2rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        #note-editor-body h1, #note-editor-body h2, #note-editor-body h3,
        #markdown-preview h1, #markdown-preview h2, #markdown-preview h3 {
             font-weight: 700;
             line-height: 1.2;
             margin-top: 1em;
             margin-bottom: 0.5em;
             padding-bottom: 0.3em;
             border-bottom: 1px solid var(--border-color);
        }
        #note-editor-body h1, #markdown-preview h1 { font-size: 2rem; }
        #note-editor-body h2, #markdown-preview h2 { font-size: 1.75rem; }
        #note-editor-body h3, #markdown-preview h3 { font-size: 1.5rem; }
        #note-editor-body img, #markdown-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 0.5em 0;
            cursor: default;
        }
        #markdown-preview blockquote, #summary-content blockquote, .chat-bubble blockquote, .ai-summary blockquote {
            border-left: 4px solid var(--border-color);
            padding-left: 1em;
            margin-left: 0;
            color: var(--text-secondary);
        }
        #markdown-preview code, #summary-content code, .chat-bubble code, .ai-summary code {
            background-color: var(--bg-pane-dark);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
        }
        #markdown-preview pre, #summary-content pre, .chat-bubble pre, .ai-summary pre {
            background-color: var(--bg-pane-dark);
            padding: 1em;
            border-radius: 8px;
            overflow-x: auto;
        }
        #markdown-preview pre code, #summary-content pre code, .chat-bubble pre code, .ai-summary pre code {
            padding: 0;
            background-color: transparent;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .column-header:hover .delete-column-btn { opacity: 1; }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .chat-bubble { max-width: 80%; }
        .chat-bubble.user { background-image: linear-gradient(to right, var(--brand-grad-from), var(--brand-grad-to)); color: white; }
        .chat-bubble.model { background-color: var(--bg-pane-dark); }
        .chat-bubble.thinking {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: .5; }
        }

        .truncate-multiline {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .view-btn {
             color: var(--text-secondary);
             transition: all 0.2s ease-in-out;
        }
        .view-btn.active {
             background-color: var(--bg-main);
             color: var(--text-primary);
             box-shadow: 0 1px 3px 0 var(--shadow-color);
        }
        .reputify-theme .view-btn.active {
             box-shadow: 0 1px 5px 0 rgba(0,0,0,0.2);
        }
        
        /* Mobile Specific Optimizations */
        #notes-list-pane {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 50;
            transform: translateX(-100%);
            transition: transform 300ms ease-in-out;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            width: 85%;
            max-width: 320px;
        }
        #notes-list-pane.open { transform: translateX(0); }
        
        @media (min-width: 768px) {
            #notes-list-pane {
                position: relative;
                transform: translateX(0);
                box-shadow: none;
                width: 280px;
                max-width: none;
            }
        }
    </style>
    
    <script>
      try {
        const defaultTheme = 'reputify';
        const theme = localStorage.getItem('codex-notes-theme') || defaultTheme;
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        } else if (theme === 'reputify') {
           document.documentElement.classList.add('reputify-theme');
        }
      } catch (e) {}
    </script>
</head>
<body class="overflow-hidden">

    <div id="app-container" class="flex h-screen">
        <!-- Main Navigation Pane (Slide-out on mobile, fixed on desktop) -->
        <aside id="notes-list-pane" class="bg-bg-pane-light border-r border-border-color flex flex-col flex-shrink-0">
            <!-- Header for the slide-out menu -->
            <header class="flex justify-between items-center p-4 border-b border-border-color flex-shrink-0">
                <h1 class="font-bold text-lg">Codex Notes</h1>
                <button id="mobile-menu-close-btn" class="md:hidden p-1 text-text-secondary hover:text-text-primary">
                    <i data-feather="x"></i>
                </button>
            </header>
            
            <!-- Collections List -->
            <div class="flex-grow p-2 overflow-y-auto">
                <div class="flex justify-between items-center p-2">
                    <h2 class="font-bold text-sm uppercase tracking-wider">Collections</h2>
                    <button id="new-collection-btn" class="text-text-secondary hover:text-accent-primary transition-colors flex-shrink-0"><i data-feather="plus"></i></button>
                </div>
                <div id="collections-list-container"></div>
            </div>
            
            <!-- Footer with settings -->
            <footer class="p-2 border-t border-border-color flex-shrink-0">
                <button id="theme-toggle" class="w-full text-left px-3 py-2 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-3">
                   <i data-feather="star" id="theme-reputify-icon" class="w-4 h-4 hidden"></i>
                   <i data-feather="sun" id="theme-sun-icon" class="w-4 h-4 hidden"></i>
                   <i data-feather="moon" id="theme-moon-icon" class="w-4 h-4 hidden"></i>
                   <span id="theme-text">Change Theme</span>
                </button>
                <button data-action="import" class="w-full text-left px-3 py-2 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-3"><i data-feather="upload" class="w-4 h-4"></i>Import Data</button>
                <button data-action="export" class="w-full text-left px-3 py-2 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-3"><i data-feather="download" class="w-4 h-4"></i>Export Data</button>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
            </footer>
            <div id="pane-resizer" class="pane-resizer w-1.5 absolute top-0 right-[-3px] bottom-0 cursor-col-resize z-10 hidden md:block"></div>
        </aside>

        <main id="editor-pane" class="flex-grow bg-bg-main flex flex-col">
           <!-- Sticky Header for Mobile and Desktop -->
           <header class="sticky top-0 z-20 flex justify-between items-center p-2 md:p-4 border-b border-border-color flex-shrink-0 bg-bg-main/80 backdrop-blur-sm">
              <div class="flex items-center gap-2">
                <button id="mobile-menu-open-btn" class="md:hidden p-2"><i data-feather="menu"></i></button>
                <h2 id="current-view-title" class="text-lg font-semibold truncate"></h2>
              </div>
              
              <!-- Desktop Header Controls -->
              <div id="desktop-header-controls" class="hidden md:flex items-center gap-4">
                  <div id="list-view-controls" class="hidden items-center gap-2">
                    <label for="sort-order" class="text-sm text-text-secondary">Sort by:</label>
                    <select id="sort-order" class="bg-bg-pane-dark text-text-primary text-sm rounded-md p-1 border-0 focus:ring-2 focus:ring-accent-primary">
                        <option value="modifiedAt-desc">Last Modified</option>
                        <option value="createdAt-desc">Date Created</option>
                        <option value="name-asc">Title (A-Z)</option>
                    </select>
                  </div>
                  <div id="view-switcher-container" class="view-switcher bg-bg-pane-dark p-1 rounded-lg flex">
                      <button class="view-btn px-2.5 py-1 rounded" title="Board View" data-view="board"><i data-feather="trello" class="w-4 h-4"></i></button>
                      <button class="view-btn px-2.5 py-1 rounded" title="List View" data-view="list"><i data-feather="list" class="w-4 h-4"></i></button>
                  </div>
                  <div class="editor-toolbar flex items-center bg-bg-pane-dark p-1 rounded-lg">
                      <button id="editor-mode-toggle" class="p-2 hover:bg-bg-main rounded-l-md disabled:opacity-50 disabled:cursor-not-allowed" title="Toggle Markdown Preview"><i data-feather="eye" class="w-4 h-4"></i></button>
                      <button data-command="ocr" class="p-2 hover:bg-bg-main rounded-r-md" title="Scan Image for Text"><i data-feather="camera" class="w-4 h-4"></i></button>
                      <input type="file" id="ocr-file-input" class="hidden" accept="image/*">
                  </div>
                  <button id="desktop-new-note-btn" class="brand-button text-white px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2 hover:opacity-90 transition-opacity" title="New Note (Cmd+N)">New Note <i data-feather="plus" class="w-4 h-4"></i></button>
              </div>

              <!-- Mobile Header Controls -->
              <div id="mobile-header-controls" class="flex md:hidden items-center gap-1">
                <button id="mobile-search-button" class="p-2 rounded-full hover:bg-bg-pane-dark"><i data-feather="search"></i></button>
                <button id="mobile-more-button" class="p-2 rounded-full hover:bg-bg-pane-dark"><i data-feather="more-vertical"></i></button>
                <div id="mobile-controls-dropdown" class="dropdown-menu hidden absolute top-full right-2 mt-2 w-48 bg-bg-pane-light shadow-2xl rounded-md p-2 border border-border-color origin-top-right scale-95 opacity-0 z-10">
                </div>
              </div>
           </header>
           
           <div id="main-content-area" class="flex-grow overflow-y-auto relative flex flex-col">
                <div id="board-view" class="notes-view active flex-grow p-4 md:p-5 h-full">
                    <div id="kanban-board" class="flex flex-col md:flex-row gap-5 min-h-full"></div>
                </div>
                <div id="list-view" class="notes-view hidden flex-grow p-2 md:p-5">
                    <div id="notes-list-content" class="space-y-3"></div>
                </div>
                <div id="note-editor-view" class="notes-view hidden flex-grow flex flex-col overflow-y-auto">
                    <div class="p-4 md:p-8 pb-4 flex-shrink-0">
                        <input id="note-editor-title" type="text" placeholder="Untitled Note" class="text-3xl md:text-4xl font-bold bg-transparent focus:outline-none mb-4 w-full">
                    </div>
                    <div id="note-editor-body" contenteditable="true" class="flex-grow text-base md:text-lg leading-relaxed focus:outline-none px-4 md:px-8 pt-4 pb-8" data-placeholder="Start writing or drop an image..."></div>
                    <div id="markdown-preview" class="hidden flex-grow text-base md:text-lg leading-relaxed focus:outline-none p-4 md:p-8 prose"></div>
                    <div id="editor-footer" class="p-4 text-xs text-text-tertiary text-left border-t border-border-color flex-shrink-0">
                       <span id="word-count">0</span> Words | <span id="char-count">0</span> Characters
                    </div>
                </div>
           </div>
        </main>
    </div>
    
    <!-- FABs -->
    <button id="chatbot-fab" title="Ask Chatbot" class="brand-button fixed bottom-6 right-6 md:bottom-6 md:right-6 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center z-20 hover:opacity-90 transition-opacity">
        <i data-feather="message-square" class="w-7 h-7"></i>
    </button>
    <button id="mobile-new-note-fab" class="fixed bottom-20 right-6 brand-button text-white w-14 h-14 rounded-full shadow-lg flex md:hidden items-center justify-center z-20 hover:opacity-90 transition-opacity">
        <i data-feather="plus" class="w-8 h-8"></i>
    </button>
    
    <!-- Overlays and Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black/50 z-40 transition-opacity duration-300 opacity-0 pointer-events-none"></div>
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/30 z-40 hidden md:hidden transition-opacity duration-300 opacity-0"></div>
    
    <div id="search-modal" class="modal hidden fixed inset-0 md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 bg-bg-pane-light md:rounded-lg shadow-2xl w-full md:max-w-lg z-50 transition-all duration-300 transform scale-95 opacity-0 flex flex-col">
        <header class="p-4 border-b border-border-color flex items-center gap-2">
            <i data-feather="search" class="text-text-tertiary"></i>
            <input id="search-input" type="text" placeholder="Search notes and folders..." class="w-full bg-transparent focus:outline-none text-text-primary">
            <button id="search-close-btn" class="text-text-tertiary text-xs p-2">ESC</button>
        </header>
        <div id="search-results-list" class="flex-grow p-4 overflow-y-auto"></div>
    </div>

    <!-- Other Modals (unchanged structure, just for completeness) -->
    <div id="api-key-modal" class="modal hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-bg-pane-light p-6 rounded-lg shadow-2xl w-full max-w-md z-50 transition-all duration-300 transform scale-95 opacity-100">
        <h3 class="text-lg font-semibold mb-2">Gemini API Key Required</h3>
        <p class="text-sm text-text-secondary mb-4">Please enter your Gemini API key to enable AI features. Your key is stored only in your browser's local storage.</p>
        <label for="api-key-input" class="text-xs font-semibold text-text-secondary">API Key</label>
        <input id="api-key-input" type="password" class="w-full text-sm bg-bg-pane-dark border border-border-color rounded-md py-1 px-2 focus:ring-2 focus:ring-accent-primary focus:outline-none" placeholder="Enter your key here...">
        <p id="api-key-error" class="text-red-500 text-sm mt-1 h-5"></p>
        <div class="flex justify-end gap-3 mt-4">
            <button id="api-key-confirm-btn" class="px-4 py-2 rounded-md brand-button hover:opacity-90">Save and Continue</button>
        </div>
    </div>
    <div id="prompt-modal" class="modal hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-bg-pane-light p-6 rounded-lg shadow-2xl w-full max-w-md z-50 transition-all duration-300 transform scale-95 opacity-0">
        <h3 id="prompt-title" class="text-lg font-semibold mb-4">Input Required</h3>
        <p id="prompt-message" class="text-sm text-text-secondary mb-3"></p>
        <input id="prompt-input" type="text" class="w-full bg-bg-pane-dark border border-border-color rounded-md p-2 focus:ring-2 focus:ring-accent-primary focus:outline-none">
        <p id="prompt-error" class="text-red-500 text-sm mt-1 h-5"></p>
        <div class="flex justify-end gap-3 mt-4">
            <button id="prompt-cancel-btn" class="px-4 py-2 rounded-md bg-bg-pane-dark hover:opacity-80">Cancel</button>
            <button id="prompt-confirm-btn" class="px-4 py-2 rounded-md brand-button hover:opacity-90">Confirm</button>
        </div>
    </div>
    <div id="confirm-modal" class="modal hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-bg-pane-light p-6 rounded-lg shadow-2xl w-full max-w-md z-50 transition-all duration-300 transform scale-95 opacity-0">
        <h3 id="confirm-title" class="text-lg font-semibold mb-4">Are you sure?</h3>
        <p id="confirm-message" class="text-sm text-text-secondary mb-6"></p>
        <div class="flex justify-end gap-3 mt-4">
            <button id="confirm-cancel-btn" class="px-4 py-2 rounded-md bg-bg-pane-dark hover:opacity-80">Cancel</button>
            <button id="confirm-confirm-btn" class="px-4 py-2 rounded-md bg-red-600 text-white hover:opacity-90">Delete</button>
        </div>
    </div>
    <div id="ai-prompt-modal" class="modal hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-bg-pane-light p-6 rounded-lg shadow-2xl w-full max-w-lg z-50 transition-all duration-300 transform scale-95 opacity-0">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2"><i data-feather="sparkles" class="w-5 h-5 text-accent-primary"></i>Ask AI</h3>
        <p class="text-sm text-text-secondary mb-3">Enter your prompt below. The AI-generated content will be inserted into your note.</p>
        <textarea id="ai-prompt-input" rows="4" class="w-full bg-bg-pane-dark border border-border-color rounded-md p-2 focus:ring-2 focus:ring-accent-primary focus:outline-none" placeholder="e.g., 'Write a short poem about the moon'"></textarea>
        <p id="ai-prompt-error" class="text-red-500 text-sm mt-1 h-5"></p>
        <div class="flex justify-end gap-3 mt-4">
            <button id="ai-cancel-btn" class="px-4 py-2 rounded-md bg-bg-pane-dark hover:opacity-80">Cancel</button>
            <button id="ai-generate-btn" class="px-4 py-2 rounded-md brand-button hover:opacity-90 flex items-center gap-2">
                <i data-feather="play" class="w-4 h-4"></i>
                <span id="ai-generate-btn-text">Generate</span>
            </button>
        </div>
    </div>
    <div id="summary-modal" class="modal hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-bg-pane-light p-6 rounded-lg shadow-2xl w-full max-w-xl z-50 transition-all duration-300 transform scale-95 opacity-0">
        <h3 class="text-lg font-semibold mb-2 flex items-center gap-2"><i data-feather="align-left" class="w-5 h-5 text-accent-primary"></i>AI Summary</h3>
        <div id="summary-content" class="text-sm text-text-secondary mb-4 bg-bg-pane-dark p-4 rounded-md max-h-[50vh] overflow-y-auto"></div>
        <div class="flex justify-end gap-3 mt-4">
            <button id="summary-close-btn" class="px-4 py-2 rounded-md brand-button hover:opacity-90">Close</button>
        </div>
    </div>
    <div id="chatbot-modal" class="modal hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-bg-pane-light rounded-lg shadow-2xl w-full max-w-2xl h-[70vh] z-50 transition-all duration-300 transform scale-95 opacity-0 flex flex-col">
        <header class="p-4 border-b border-border-color flex justify-between items-center flex-shrink-0">
            <h3 class="text-lg font-semibold flex items-center gap-2"><i data-feather="message-square" class="w-5 h-5 text-accent-primary"></i>Chat with AI</h3>
            <div class="flex items-center">
                <button id="chatbot-clear-btn" class="p-2 rounded-full hover:bg-bg-pane-dark" title="Clear Chat History"><i data-feather="trash-2" class="w-5 h-5"></i></button>
                <button id="chatbot-close-btn" class="p-2 rounded-full hover:bg-bg-pane-dark"><i data-feather="x" class="w-5 h-5"></i></button>
            </div>
        </header>
        <div id="chatbot-history" class="flex-grow p-4 space-y-4 overflow-y-auto">
        </div>
        <footer class="p-4 border-t border-border-color flex-shrink-0">
            <div id="chatbot-error" class="text-red-500 text-sm mb-2 h-5"></div>
            <div class="flex items-center gap-2">
                <input id="chatbot-input" type="text" class="w-full bg-bg-pane-dark border border-border-color rounded-full py-2 px-4 focus:ring-2 focus:ring-accent-primary focus:outline-none" placeholder="Ask anything...">
                <button id="chatbot-send-btn" class="brand-button text-white rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center hover:opacity-90">
                    <i data-feather="arrow-up" class="w-5 h-5"></i>
                </button>
            </div>
        </footer>
    </div>
    
    <div id="inline-toolbar" class="absolute z-30 bg-bg-pane-dark p-1 rounded-lg shadow-md flex items-center gap-1 transition-all duration-150 transform scale-95 opacity-0" style="pointer-events: none;">
        <button data-command="bold" class="p-2 hover:bg-bg-main rounded"><i data-feather="bold" class="w-4 h-4"></i></button>
        <button data-command="italic" class="p-2 hover:bg-bg-main rounded"><i data-feather="italic" class="w-4 h-4"></i></button>
        <button data-command="createLink" class="p-2 hover:bg-bg-main rounded"><i data-feather="link" class="w-4 h-4"></i></button>
        <button data-command="insertImage" class="p-2 hover:bg-bg-main rounded"><i data-feather="image" class="w-4 h-4"></i></button>
        <button data-command="insertUnorderedList" class="p-2 hover:bg-bg-main rounded"><i data-feather="list" class="w-4 h-4"></i></button>
        <div class="w-px h-5 bg-border-color mx-1"></div>
        <button data-command="formatBlock" data-value="h1" class="p-2 hover:bg-bg-main rounded font-bold text-sm">H1</button>
        <button data-command="formatBlock" data-value="h2" class="p-2 hover:bg-bg-main rounded font-bold text-sm">H2</button>
        <button data-command="formatBlock" data-value="h3" class="p-2 hover:bg-bg-main rounded font-bold text-sm">H3</button>
    </div>

    <div id="context-menu" class="context-menu fixed z-50 bg-bg-pane-light shadow-2xl rounded-md p-2 w-48 border border-border-color hidden origin-top-left scale-95 opacity-0">
        <button data-action="new-note" class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2"><i data-feather="file-plus" class="w-4 h-4"></i>New Note</button>
        <button data-action="new-folder" class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2"><i data-feather="folder-plus" class="w-4 h-4"></i>New Folder</button>
        <hr class="my-1 border-border-color">
        <button data-action="toggle-pin" class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2"><i data-feather="paperclip" class="w-4 h-4"></i><span id="pin-action-text">Pin</span></button>
        <button data-action="duplicate" class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2"><i data-feather="copy" class="w-4 h-4"></i>Duplicate</button>
        <button data-action="rename" class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2"><i data-feather="edit-2" class="w-4 h-4"></i>Rename</button>
        <button data-action="delete" class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark text-red-500 rounded flex items-center gap-2"><i data-feather="trash-2" class="w-4 h-4"></i>Delete</button>
    </div>


    <script>
        feather.replace();

        document.addEventListener('DOMContentLoaded', () => {
            
            const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
            const API_KEY_STORAGE_ITEM = 'gemini-api-key';

            const app = {
                containers: {
                    app: document.getElementById('app-container'),
                    collectionsList: document.getElementById('collections-list-container'),
                    kanbanBoard: document.getElementById('kanban-board'),
                    notesListContent: document.getElementById('notes-list-content'),
                    noteEditor: document.getElementById('note-editor-view'),
                    toast: document.getElementById('toast-container'),
                    mainContentArea: document.getElementById('main-content-area'),
                    searchResultsList: document.getElementById('search-results-list'),
                    mobileControlsDropdown: document.getElementById('mobile-controls-dropdown'),
                    desktopHeaderControls: document.getElementById('desktop-header-controls'),
                },
                elements: {
                    notesListPane: document.getElementById('notes-list-pane'),
                    paneResizer: document.getElementById('pane-resizer'),
                    themeToggle: document.getElementById('theme-toggle'),
                    themeText: document.getElementById('theme-text'),
                    themeReputifyIcon: document.getElementById('theme-reputify-icon'),
                    themeSunIcon: document.getElementById('theme-sun-icon'),
                    themeMoonIcon: document.getElementById('theme-moon-icon'),
                    newCollectionBtn: document.getElementById('new-collection-btn'),
                    desktopNewNoteBtn: document.getElementById('desktop-new-note-btn'),
                    mobileNewNoteFab: document.getElementById('mobile-new-note-fab'),
                    chatbotFab: document.getElementById('chatbot-fab'),
                    currentViewTitle: document.getElementById('current-view-title'),
                    noteEditorTitle: document.getElementById('note-editor-title'),
                    noteEditorBody: document.getElementById('note-editor-body'),
                    markdownPreview: document.getElementById('markdown-preview'),
                    wordCount: document.getElementById('word-count'),
                    charCount: document.getElementById('char-count'),
                    mobileMenuOpenBtn: document.getElementById('mobile-menu-open-btn'),
                    mobileMenuCloseBtn: document.getElementById('mobile-menu-close-btn'),
                    mobileSidebarOverlay: document.getElementById('mobile-sidebar-overlay'),
                    sortOrderSelect: document.getElementById('sort-order'),
                    listViewControls: document.getElementById('list-view-controls'),
                    viewSwitcher: document.getElementById('view-switcher-container'),
                    importFileInput: document.getElementById('import-file-input'),
                    mobileMoreButton: document.getElementById('mobile-more-button'),
                    mobileSearchButton: document.getElementById('mobile-search-button'),
                },
                modals: {
                    backdrop: document.getElementById('modal-backdrop'),
                    apiKey: document.getElementById('api-key-modal'),
                    apiKeyInput: document.getElementById('api-key-input'),
                    apiKeyConfirmBtn: document.getElementById('api-key-confirm-btn'),
                    apiKeyError: document.getElementById('api-key-error'),
                    prompt: document.getElementById('prompt-modal'),
                    promptTitle: document.getElementById('prompt-title'),
                    promptMessage: document.getElementById('prompt-message'),
                    promptInput: document.getElementById('prompt-input'),
                    promptError: document.getElementById('prompt-error'),
                    promptConfirmBtn: document.getElementById('prompt-confirm-btn'),
                    promptCancelBtn: document.getElementById('prompt-cancel-btn'),
                    confirm: document.getElementById('confirm-modal'),
                    confirmTitle: document.getElementById('confirm-title'),
                    confirmMessage: document.getElementById('confirm-message'),
                    confirmConfirmBtn: document.getElementById('confirm-confirm-btn'),
                    confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
                    aiPrompt: document.getElementById('ai-prompt-modal'),
                    aiPromptInput: document.getElementById('ai-prompt-input'),
                    aiPromptError: document.getElementById('ai-prompt-error'),
                    aiGenerateBtn: document.getElementById('ai-generate-btn'),
                    aiCancelBtn: document.getElementById('ai-cancel-btn'),
                    aiGenerateBtnText: document.getElementById('ai-generate-btn-text'),
                    summary: document.getElementById('summary-modal'),
                    summaryContent: document.getElementById('summary-content'),
                    summaryCloseBtn: document.getElementById('summary-close-btn'),
                    chatbot: document.getElementById('chatbot-modal'),
                    chatbotHistory: document.getElementById('chatbot-history'),
                    chatbotInput: document.getElementById('chatbot-input'),
                    chatbotSendBtn: document.getElementById('chatbot-send-btn'),
                    chatbotCloseBtn: document.getElementById('chatbot-close-btn'),
                    chatbotClearBtn: document.getElementById('chatbot-clear-btn'),
                    chatbotError: document.getElementById('chatbot-error'),
                    search: document.getElementById('search-modal'),
                    searchInput: document.getElementById('search-input'),
                    searchCloseBtn: document.getElementById('search-close-btn'),
                },
                toolbar: {
                    inline: document.getElementById('inline-toolbar'),
                    editorModeToggle: document.getElementById('editor-mode-toggle'),
                    ocrBtn: document.querySelector('[data-command="ocr"]'),
                    ocrFileInput: document.getElementById('ocr-file-input'),
                },
                views: {
                    board: document.getElementById('board-view'),
                    list: document.getElementById('list-view'),
                },
                contextMenu: {
                    menu: document.getElementById('context-menu'),
                    targetId: null,
                    targetIsContainer: false,
                    pinActionText: document.getElementById('pin-action-text'),
                    togglePinBtn: document.querySelector('[data-action="toggle-pin"]'),
                    renameBtn: document.querySelector('[data-action="rename"]'),
                    deleteBtn: document.querySelector('[data-action="delete"]'),
                    duplicateBtn: document.querySelector('[data-action="duplicate"]'),
                }
            };

            let state = {};
            let editorSelectionRange = null;

            const defaultState = {
                collections: [
                    { id: 'c1', name: 'Product Design', type: 'folder', children: [
                        { id: 'n1', name: 'UI/UX Principles', type: 'note', content: '<h1>Hick\'s Law</h1><p>The time it takes to make a decision increases with the number and complexity of choices. It is a fundamental principle in user interface design that helps simplify user choices. By reducing the number of options, designers can significantly improve usability and reduce cognitive load on the user, leading to a faster and more satisfying user experience.</p>', status: 'col1', pinned: true, createdAt: new Date(Date.now() - 86400000 * 2).toISOString(), modifiedAt: new Date(Date.now() - 86400000 * 2).toISOString() },
                        { id: 'n2', name: 'Inspiration', type: 'note', content: 'Check out Dribbble, Awwwards, and Behance for design inspiration.', status: 'col2', pinned: false, createdAt: new Date(Date.now() - 86400000).toISOString(), modifiedAt: new Date().toISOString() },
                    ], expanded: true },
                    { id: 'c2', name: 'Marketing', type: 'folder', children: [], expanded: false },
                    { id: 'n3', name: 'Standalone Note', type: 'note', content: 'A standalone note, not in any project.', status: null, pinned: false, createdAt: new Date(Date.now() - 86400000 * 3).toISOString(), modifiedAt: new Date(Date.now() - 86400000).toISOString() },
                ],
                settings: {
                    theme: 'reputify',
                    activeCollectionId: 'c1',
                    activeNoteId: null,
                    paneWidth: 280,
                    activeView: 'board',
                    listSortOrder: 'modifiedAt-desc',
                    editorMode: 'editor',
                },
                kanbanColumns: {
                    'c1': [ { id: 'col1', title: 'To Do' }, { id: 'col2', title: 'In Progress' } ],
                    'c2': [ { id: 'ideas', title: 'Ideas' } ],
                },
                chatHistory: []
            };

            function saveState() {
                try {
                    localStorage.setItem('codex-notes-appState-v2', JSON.stringify(state));
                } catch (error) {
                    console.error("Failed to save state:", error);
                    showToast("Error saving data. Storage might be full.", 'error');
                }
            }
            
            function migrateState(loadedState) {
                const migrateNode = (node) => {
                    if (node.type === 'note') {
                        if (typeof node.pinned === 'undefined') node.pinned = false;
                        const now = new Date().toISOString();
                        if (typeof node.createdAt === 'undefined') node.createdAt = now;
                        if (typeof node.modifiedAt === 'undefined') node.modifiedAt = node.createdAt;
                    }
                    if (node.children) node.children.forEach(migrateNode);
                };
                if (!loadedState.settings) loadedState.settings = {};
                if (!loadedState.settings.listSortOrder) loadedState.settings.listSortOrder = 'modifiedAt-desc';
                if (!loadedState.settings.editorMode) loadedState.settings.editorMode = 'editor';
                if (!loadedState.collections) loadedState.collections = [];
                if (!loadedState.kanbanColumns) loadedState.kanbanColumns = {};
                if (!loadedState.chatHistory) loadedState.chatHistory = [];

                loadedState.collections.forEach(migrateNode);
                return loadedState;
            }

            function loadState() {
                const savedState = localStorage.getItem('codex-notes-appState-v2');
                let parsedState = savedState ? JSON.parse(savedState) : JSON.parse(JSON.stringify(defaultState));
                state = migrateState(parsedState);
                state.settings.theme = localStorage.getItem('codex-notes-theme') || 'reputify';
            }

            const generateId = (prefix = 'id') => `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            function findItem(itemId, tree = state.collections) {
                for (let i = 0; i < tree.length; i++) {
                    const item = tree[i];
                    if (item.id === itemId) return {item, parent: tree, index: i};
                    if (item.children) {
                        const result = findItem(itemId, item.children);
                        if(result) {
                           const parent = Array.isArray(result.parent) ? item : result.parent;
                           return { ...result, parent };
                        }
                    }
                }
                return null;
            }
            
            const getAllNotes = (items) => {
                let notes = [];
                for (const item of items) {
                    if (item.type === 'note') {
                        notes.push(item);
                    }
                    if (item.type === 'folder' && item.children) {
                        notes = notes.concat(getAllNotes(item.children));
                    }
                }
                return notes;
            };

            const debounce = (func, delay) => {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            };
            
            const showToast = (message, type = 'info') => {
                const id = generateId('toast');
                const toast = document.createElement('div');
                const colors = {
                    info: 'bg-bg-pane-dark text-text-primary',
                    success: 'bg-green-500 text-white',
                    error: 'bg-red-500 text-white',
                    loading: 'bg-blue-500 text-white animate-pulse'
                }
                toast.id = id;
                toast.className = `toast-item ${colors[type]} rounded-full px-4 py-2 text-sm shadow-lg transition-all duration-300 transform translate-y-[-20px] opacity-0`;
                toast.textContent = message;
                
                app.containers.toast.appendChild(toast);
                app.containers.toast.style.pointerEvents = 'auto';

                setTimeout(() => {
                    toast.classList.remove('translate-y-[-20px]', 'opacity-0');
                }, 10);
                
                if (type !== 'loading') {
                    setTimeout(() => {
                        toast.classList.add('opacity-0', 'scale-90');
                        toast.addEventListener('transitionend', () => {
                             if(toast.parentElement) toast.parentElement.removeChild(toast);
                             if (app.containers.toast.childElementCount === 0) {
                                app.containers.toast.style.pointerEvents = 'none';
                             }
                        });
                    }, 3000);
                }
                return id;
            };
            
            const dismissToast = (toastId) => {
                const toast = document.getElementById(toastId);
                if (toast) {
                    toast.classList.add('opacity-0', 'scale-90');
                    toast.addEventListener('transitionend', () => {
                         if(toast.parentElement) toast.parentElement.removeChild(toast);
                         if (app.containers.toast.childElementCount === 0) {
                            app.containers.toast.style.pointerEvents = 'none';
                         }
                    });
                }
            };

            const highlightText = (text, query) => {
                if (!query || !text) return text;
                const regex = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                return text.replace(regex, `<mark>$1</mark>`);
            };
            
            const formatDateTime = (isoString) => {
                 return new Date(isoString).toLocaleString(undefined, {
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: 'numeric', minute: '2-digit', hour12: true
                 }).replace(/, /g, ', ');
            };
            
            async function callGeminiAPI(payload, elementForError) {
                const apiKey = localStorage.getItem(API_KEY_STORAGE_ITEM);

                if (!apiKey) {
                    const errorMsg = 'Gemini API key is not set. Please set it via the chatbot.';
                    if (elementForError) elementForError.textContent = errorMsg;
                    else showToast(errorMsg, 'error');
                    openModal(app.modals.apiKey);
                    return null;
                }

                try {
                    const res = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-goog-api-key': apiKey
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) {
                        let errorDetails = `${res.status} ${res.statusText}`;
                        try {
                           const errorData = await res.json();
                           errorDetails = errorData.error?.message || errorDetails;
                        } catch (e) { /* ignore parsing error */ }
                        throw new Error(errorDetails);
                    }

                    const data = await res.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error('AI returned an empty response.');
                    return text;

                } catch (err) {
                    console.error("Gemini API Error:", err);
                    const errorMsg = `API Error: ${err.message}`;
                    if (elementForError) elementForError.textContent = errorMsg;
                    else showToast(errorMsg, 'error');
                    return null;
                }
            }

            const openModal = (modal, isBlocking = false) => {
                const backdrop = app.modals.backdrop;
                backdrop.style.pointerEvents = 'auto';
                if (isBlocking) {
                    backdrop.classList.add('bg-black/50');
                    backdrop.classList.remove('bg-black/30');
                } else {
                    backdrop.classList.add('bg-black/30');
                    backdrop.classList.remove('bg-black/50');
                }
                backdrop.style.opacity = '1';
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.remove('scale-95', 'opacity-0');
                    if (modal.id === 'search-modal') {
                        app.modals.searchInput.focus();
                    }
                }, 10);
            };

            const closeModal = (modal) => {
                const backdrop = app.modals.backdrop;
                backdrop.style.opacity = '0';
                backdrop.style.pointerEvents = 'none';

                modal.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            };

            const showPrompt = ({ title, message, initialValue = '', placeholder = '' }) => {
                return new Promise((resolve) => {
                    app.modals.promptTitle.textContent = title;
                    app.modals.promptMessage.textContent = message;
                    app.modals.promptInput.value = initialValue;
                    app.modals.promptInput.placeholder = placeholder;
                    app.modals.promptError.textContent = '';
                    
                    openModal(app.modals.prompt);
                    app.modals.promptInput.focus();
                    app.modals.promptInput.select();

                    const confirmHandler = () => {
                        const value = app.modals.promptInput.value.trim();
                        if (value) {
                            cleanup();
                            resolve(value);
                        } else {
                            app.modals.promptError.textContent = 'Input cannot be empty.';
                        }
                    };

                    const cancelHandler = () => {
                        cleanup();
                        resolve(null);
                    };

                    const cleanup = () => {
                        app.modals.promptConfirmBtn.removeEventListener('click', confirmHandler);
                        app.modals.promptCancelBtn.removeEventListener('click', cancelHandler);
                        app.modals.backdrop.removeEventListener('click', backdropHandler);
                        closeModal(app.modals.prompt);
                    };
                    
                    const backdropHandler = () => cancelHandler();

                    app.modals.promptConfirmBtn.addEventListener('click', confirmHandler);
                    app.modals.promptCancelBtn.addEventListener('click', cancelHandler);
                    app.modals.backdrop.addEventListener('click', backdropHandler);
                });
            };
            
            const showConfirm = ({ title, message, confirmText = 'Confirm', confirmClass = 'bg-red-600' }) => {
                 return new Promise((resolve) => {
                    app.modals.confirmTitle.textContent = title;
                    app.modals.confirmMessage.innerHTML = message;
                    app.modals.confirmConfirmBtn.textContent = confirmText;
                    
                    app.modals.confirmConfirmBtn.className = "px-4 py-2 rounded-md text-white hover:opacity-90";
                    if (state.settings.theme === 'reputify' && confirmClass.includes('red')) {
                        app.modals.confirmConfirmBtn.classList.add('bg-red-600');
                    } else {
                        app.modals.confirmConfirmBtn.classList.add('brand-button');
                    }

                    openModal(app.modals.confirm);

                    const confirmHandler = () => { cleanup(); resolve(true); };
                    const cancelHandler = () => { cleanup(); resolve(false); };
                    const backdropHandler = () => cancelHandler();

                    const cleanup = () => {
                        app.modals.confirmConfirmBtn.removeEventListener('click', confirmHandler);
                        app.modals.confirmCancelBtn.removeEventListener('click', cancelHandler);
                        app.modals.backdrop.removeEventListener('click', backdropHandler);
                        closeModal(app.modals.confirm);
                    };

                    app.modals.confirmConfirmBtn.addEventListener('click', confirmHandler);
                    app.modals.confirmCancelBtn.addEventListener('click', cancelHandler);
                    app.modals.backdrop.addEventListener('click', backdropHandler);
                });
            };
            
            function render() {
                renderTheme();
                renderCollectionsList();
                renderMainView();
                renderMobileControls();
                
                app.toolbar.editorModeToggle.disabled = !state.settings.activeNoteId;
                
                feather.replace(); 
            }
            
            function renderTheme() {
                const docEl = document.documentElement;
                docEl.classList.remove('reputify-theme', 'dark', 'light');
                app.elements.themeReputifyIcon.classList.add('hidden');
                app.elements.themeSunIcon.classList.add('hidden');
                app.elements.themeMoonIcon.classList.add('hidden');

                if (state.settings.theme === 'dark') {
                    docEl.classList.add('dark');
                    app.elements.themeMoonIcon.classList.remove('hidden');
                    app.elements.themeText.textContent = 'Dark Theme';
                } else if (state.settings.theme === 'reputify') {
                    docEl.classList.add('reputify-theme');
                    app.elements.themeReputifyIcon.classList.remove('hidden');
                    app.elements.themeText.textContent = 'Reputify Theme';
                } else {
                    docEl.classList.add('light');
                    app.elements.themeSunIcon.classList.remove('hidden');
                    app.elements.themeText.textContent = 'Light Theme';
                }
            }

            function renderCollectionsList(collections = state.collections, level = 0) {
                const createItemHTML = (item, currentLevel) => {
                    const isActive = item.id === state.settings.activeCollectionId || item.id === state.settings.activeNoteId;
                    const isFolder = item.type === 'folder';
                    
                    if (isFolder && item.children) {
                        item.children.sort((a, b) => {
                            if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;
                            return a.name.localeCompare(b.name);
                        });
                    }

                    return `
                        <li data-id="${item.id}" draggable="true" class="collection-item-wrapper rounded-md">
                            <a href="#" class="collection-item flex items-center gap-2 p-2 rounded-md hover:bg-bg-pane-dark ${isActive ? 'bg-bg-pane-dark font-semibold' : ''}" style="padding-left: ${8 + currentLevel * 16}px;">
                                ${isFolder ? `<i data-feather="chevron-right" class="chevron w-4 h-4 flex-shrink-0 text-text-tertiary ${item.expanded ? 'open' : ''}"></i>` : ''}
                                <i data-feather="${isFolder ? 'folder' : (item.pinned ? 'paperclip' : 'file-text')}" class="w-4 h-4 flex-shrink-0 text-text-secondary ${item.pinned ? 'text-accent-primary': ''}"></i>
                                <span class="truncate flex-grow">${item.name}</span>
                            </a>
                            ${isFolder && item.expanded && item.children ? `<ul class="collection-children">${renderCollectionsList(item.children, currentLevel + 1)}</ul>` : ''}
                        </li>
                    `;
                };
                
                collections.sort((a, b) => {
                    if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;
                    return a.name.localeCompare(b.name);
                });
                const listHTML = collections.map(item => createItemHTML(item, level)).join('');
                
                if (level === 0) {
                    app.containers.collectionsList.innerHTML = `<ul class="space-y-1">${listHTML}</ul>`;
                }
                return listHTML;
            }

            function renderMainView() {
                const activeCollection = findItem(state.settings.activeCollectionId)?.item;
                app.elements.currentViewTitle.textContent = activeCollection?.name || "All Notes";
                const isNoteActive = !!state.settings.activeNoteId;
                
                const showListControls = !isNoteActive && (state.settings.activeView === 'list' || !activeCollection);

                app.elements.viewSwitcher.style.display = isNoteActive || !activeCollection ? 'none' : 'flex';
                app.elements.listViewControls.style.display = showListControls ? 'flex' : 'none';
                
                document.querySelectorAll('.notes-view').forEach(v => v.classList.add('hidden'));

                if (isNoteActive) {
                    renderNoteEditor();
                } else if (activeCollection) {
                     document.querySelectorAll('#view-switcher-container .view-btn').forEach(b => b.classList.remove('active'));
                     document.querySelector(`#view-switcher-container .view-btn[data-view="${state.settings.activeView}"]`)?.classList.add('active');
                    
                    if (state.settings.activeView === 'board') {
                        app.views.board.classList.remove('hidden');
                        renderKanbanView();
                    } else {
                        app.views.list.classList.remove('hidden');
                        renderListView();
                    }
                } else {
                     app.views.list.classList.remove('hidden');
                     renderListView();
                }
            }
            
            function renderMobileControls() {
                const activeCollection = findItem(state.settings.activeCollectionId)?.item;
                const isNoteActive = !!state.settings.activeNoteId;

                let controlsHTML = '';
                
                if (isNoteActive) {
                    controlsHTML += `
                        <button class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2" id="mobile-editor-mode-toggle"><i data-feather="eye" class="w-4 h-4"></i><span id="mobile-editor-mode-text">Preview</span></button>
                        <button class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2" data-command="ocr"><i data-feather="camera" class="w-4 h-4"></i>Scan Image</button>
                    `;
                } else if (activeCollection) {
                    controlsHTML += `
                        <div class="text-xs text-text-tertiary px-3 pt-2 pb-1 font-semibold uppercase">View</div>
                        <button class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2 view-btn-mobile" data-view="board"><i data-feather="trello" class="w-4 h-4"></i>Board</button>
                        <button class="w-full text-left px-3 py-1.5 text-sm hover:bg-bg-pane-dark rounded flex items-center gap-2 view-btn-mobile" data-view="list"><i data-feather="list" class="w-4 h-4"></i>List</button>
                    `;
                    if (state.settings.activeView === 'list' || !activeCollection) {
                        controlsHTML += `<hr class="my-1 border-border-color">
                            <div class="text-xs text-text-tertiary px-3 pt-2 pb-1 font-semibold uppercase">Sort By</div>
                            <select id="sort-order-mobile" class="w-full bg-transparent text-text-primary text-sm rounded-md p-2 border-0 focus:ring-0">
                                <option value="modifiedAt-desc">Last Modified</option>
                                <option value="createdAt-desc">Date Created</option>
                                <option value="name-asc">Title (A-Z)</option>
                            </select>
                        `;
                    }
                } else { // All notes view
                    controlsHTML += `
                        <div class="text-xs text-text-tertiary px-3 pt-2 pb-1 font-semibold uppercase">Sort By</div>
                        <select id="sort-order-mobile" class="w-full bg-transparent text-text-primary text-sm rounded-md p-2 border-0 focus:ring-0">
                            <option value="modifiedAt-desc">Last Modified</option>
                            <option value="createdAt-desc">Date Created</option>
                            <option value="name-asc">Title (A-Z)</option>
                        </select>
                    `;
                }

                app.containers.mobileControlsDropdown.innerHTML = controlsHTML;
                
                const mobileSortSelect = document.getElementById('sort-order-mobile');
                if (mobileSortSelect) {
                    mobileSortSelect.value = state.settings.listSortOrder;
                }

                document.querySelectorAll('.view-btn-mobile').forEach(btn => {
                    if (btn.dataset.view === state.settings.activeView) {
                        btn.classList.add('bg-bg-pane-dark', 'font-semibold');
                    }
                });
                
                const mobileEditorToggle = document.getElementById('mobile-editor-mode-toggle');
                if(mobileEditorToggle) {
                    const modeText = document.getElementById('mobile-editor-mode-text');
                    modeText.textContent = state.settings.editorMode === 'editor' ? 'Preview' : 'Edit';
                }

                feather.replace();
            }

            function renderKanbanView() {
                const collectionId = state.settings.activeCollectionId;
                const collection = findItem(collectionId)?.item;

                if (!collection || collection.type !== 'folder') {
                    app.containers.kanbanBoard.innerHTML = `<div class="text-center p-10 text-text-secondary"><i data-feather="trello" class="w-12 h-12 mx-auto mb-4"></i><h3 class="font-semibold">Board View</h3><p>This view is only available for project folders.</p></div>`;
                    feather.replace();
                    return;
                }
                
                const columns = state.kanbanColumns[collectionId] || [];
                const notesInCollection = collection.children.filter(c => c.type === 'note') || [];
                
                const columnsHTML = columns.map(column => {
                    const notesInColumn = [...notesInCollection]
                        .filter(note => note.status === column.id)
                        .sort((a,b) => notesInCollection.indexOf(a) - notesInCollection.indexOf(b));
                        
                    const cardsHTML = notesInColumn.map(note => {
                            const date = new Date(note.modifiedAt).toLocaleDateString();
                            const pinnedClass = note.pinned ? 'pinned' : '';
                            return `
                                <div class="kanban-card p-3 rounded-md shadow-sm border border-border-color mb-3 cursor-pointer hover:shadow-lg transition-all ${pinnedClass}" draggable="true" data-note-id="${note.id}">
                                    <div class="pointer-events-none">
                                        <h4 class="font-semibold pointer-events-none">${note.name}</h4>
                                        <p class="text-sm text-text-secondary mt-1 pointer-events-none truncate-multiline">${note.content.replace(/<[^>]*>?/gm, '')}</p>
                                    </div>
                                    <div class="text-xs text-text-tertiary mt-2 pointer-events-none">Modified: ${date}</div>
                                </div>
                            `;
                        }).join('');

                    return `
                        <div class="kanban-column md:w-[300px] flex-shrink-0 bg-bg-pane-dark p-3 rounded-lg" data-column-id="${column.id}">
                            <div class="column-header flex justify-between items-center font-semibold mb-3 text-text-primary">
                                <span class="rename-column-btn cursor-pointer flex-grow p-1">${column.title}</span>
                                <button class="delete-column-btn text-text-tertiary hover:text-red-500 opacity-0 md:opacity-100 p-1"><i data-feather="x" class="w-4 h-4"></i></button>
                            </div>
                            <div class="cards-container min-h-[100px]">${cardsHTML}</div>
                        </div>
                    `;
                }).join('');
                
                const addColumnBtnHTML = columns.length < 5 ? `
                     <div class="md:w-[300px] flex-shrink-0">
                        <button id="add-column-btn" class="w-full bg-bg-pane-light p-3 rounded-lg text-text-secondary hover:bg-bg-main hover:text-accent-primary transition-colors">
                            <i data-feather="plus" class="inline-block mr-2"></i>Add Column
                        </button>
                    </div>` : '';

                app.containers.kanbanBoard.innerHTML = columnsHTML + addColumnBtnHTML;
            }

            function renderListView() {
                 const collectionId = state.settings.activeCollectionId;
                 const collection = findItem(collectionId)?.item;
                 const notes = collection 
                    ? collection.children.filter(c => c.type === 'note') 
                    : getAllNotes(state.collections);

                 if (notes.length === 0) {
                     app.containers.notesListContent.innerHTML = `<div class="text-center p-10 text-text-secondary"><i data-feather="inbox" class="w-12 h-12 mx-auto mb-4"></i><h3 class="font-semibold">No Notes Here</h3><p>Create a new note to get started.</p></div>`;
                     feather.replace();
                     return;
                 }
                 
                 const sortOrder = state.settings.listSortOrder;
                 const [key, direction] = sortOrder.split('-');

                 notes.sort((a,b) => {
                     let valA = a[key];
                     let valB = b[key];
                     if(key === 'name') {
                         return direction === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                     } else {
                         return direction === 'desc' ? new Date(valB) - new Date(valA) : new Date(valA) - new Date(valB);
                     }
                 });

                 app.containers.notesListContent.innerHTML = notes.map(note => {
                    const date = new Date(note.modifiedAt).toLocaleDateString();
                    const pinnedClass = note.pinned ? 'pinned' : '';
                    return `
                        <div class="list-note-item bg-bg-pane-light p-4 rounded-lg shadow-sm border border-border-color cursor-pointer hover:shadow-md transition-all relative ${pinnedClass}" data-note-id="${note.id}">
                            <div class="flex justify-between items-start">
                                <div class="flex-grow min-w-0">
                                    <h3 class="font-semibold text-lg truncate">${note.name}</h3>
                                    <p class="text-sm text-text-secondary mt-1 truncate">${note.content.replace(/<[^>]*>?/gm, '')}</p>
                                    <p class="text-xs text-text-tertiary mt-3">Last Modified: ${date}</p>
                                </div>
                                <button class="summarize-btn flex-shrink-0 ml-4 p-2 rounded-full hover:bg-bg-pane-dark text-text-secondary" title="Summarize Note with AI" data-note-id="${note.id}">
                                    <i data-feather="sparkles" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>`
                 }).join('');
            }
            
            function updateEditorStats() {
                const text = app.elements.noteEditorBody.innerText || '';
                const charCount = text.length;
                const wordCount = text.trim().split(/\s+/).filter(Boolean).length;
                app.elements.charCount.textContent = charCount;
                app.elements.wordCount.textContent = wordCount;
            }
            
            function renderNoteEditor() {
                app.containers.noteEditor.classList.remove('hidden');
                
                const note = findItem(state.settings.activeNoteId)?.item;
                if (!note) {
                    state.settings.activeNoteId = null;
                    renderMainView();
                    return;
                }

                app.elements.noteEditorTitle.value = note.name;

                if(state.settings.editorMode === 'preview') {
                    app.elements.noteEditorBody.classList.add('hidden');
                    app.elements.markdownPreview.classList.remove('hidden');
                    app.elements.markdownPreview.innerHTML = marked.parse(note.content || '');
                    app.toolbar.editorModeToggle.classList.add('active');
                } else {
                    app.elements.noteEditorBody.classList.remove('hidden');
                    app.elements.markdownPreview.classList.add('hidden');
                    app.elements.noteEditorBody.innerHTML = note.content || '';
                    app.toolbar.editorModeToggle.classList.remove('active');
                }
                updateEditorStats();
            }
            
            function renderSearchResults(query) {
                if (!query) {
                    app.containers.searchResultsList.innerHTML = `<p class="text-text-secondary text-center p-6"><i data-feather="search" class="w-12 h-12 mx-auto mb-4"></i><br>Start typing to search for notes.</p>`;
                    feather.replace();
                    return;
                }

                const results = [];
                const searchPool = (items, parentName = null) => {
                    for (const item of items) {
                        if (item.type === 'note') {
                            const noteName = item.name || '';
                            const noteContent = item.content || '';
                            const plainContent = noteContent.replace(/<[^>]*>?/gm, '');
                            
                            const queryRegex = new RegExp(query, 'i');
                            if (queryRegex.test(noteName) || queryRegex.test(plainContent)) {
                                const excerptMatch = plainContent.match(new RegExp(`.{0,50}${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}.{0,50}`, 'i'));
                                const excerpt = excerptMatch ? `...${highlightText(excerptMatch[0], query)}...` : highlightText(plainContent.substring(0, 100) + '...', query);
                                results.push({
                                    noteId: item.id,
                                    projectName: parentName,
                                    noteName: noteName,
                                    excerpt: excerpt
                                });
                            }
                        }
                        if (item.type === 'folder' && item.children) {
                            searchPool(item.children, item.name);
                        }
                    }
                };

                searchPool(state.collections);
                
                if(results.length === 0) {
                     app.containers.searchResultsList.innerHTML = `<p class="text-text-secondary text-center p-6"><i data-feather="x-circle" class="w-12 h-12 mx-auto mb-4"></i><br>No results found for "${query}".</p>`;
                     feather.replace();
                     return;
                }

                app.containers.searchResultsList.innerHTML = results.map(res => `
                    <div class="search-result-item p-4 mb-3 rounded-lg hover:bg-bg-pane-dark cursor-pointer border border-transparent hover:border-border-color" data-note-id="${res.noteId}">
                        <div class="font-semibold text-text-secondary text-sm">
                            ${res.projectName ? `${highlightText(res.projectName, query)} / ` : ''}<span class="text-text-primary">${highlightText(res.noteName, query)}</span>
                        </div>
                        <p class="text-text-primary mt-2 text-sm">${res.excerpt}</p>
                    </div>
                `).join('');
            }
            
            function renderChatHistory() {
                app.modals.chatbotHistory.innerHTML = state.chatHistory.map(msg => {
                    const bubbleClass = msg.role === 'user'
                        ? 'user'
                        : 'model';
                    const formattedHtml = marked.parse(msg.text);
                    return `
                        <div class="chat-bubble w-fit rounded-lg px-3 py-2 self-${msg.role === 'user' ? 'end' : 'start'} ${bubbleClass}">
                            ${formattedHtml}
                        </div>`;
                }).join('');
                app.modals.chatbotHistory.scrollTop = app.modals.chatbotHistory.scrollHeight;
            }
            
            const createNewNote = (andSwitchToIt = true) => {
                let parentCollection;
                let targetArray;
                let parentId = state.settings.activeCollectionId;

                const parentResult = findItem(parentId);

                if (parentResult && parentResult.item.type === 'folder') {
                    parentCollection = parentResult.item;
                    targetArray = parentCollection.children;
                } else if(parentResult) {
                    const parentOfNote = findItem(parentResult.parent.id);
                    parentId = parentOfNote ? parentOfNote.item.id : null;
                    parentCollection = parentOfNote ? parentOfNote.item : null;
                    targetArray = parentCollection ? parentCollection.children : state.collections;
                } else {
                    parentId = null;
                    targetArray = state.collections;
                }
                
                if (parentCollection) {
                    parentCollection.expanded = true;
                }

                const now = new Date().toISOString();
                const newNote = {
                    id: generateId('n'), name: 'Untitled Note', type: 'note', content: '',
                    status: parentId ? state.kanbanColumns[parentId]?.[0]?.id || null : null,
                    createdAt: now,
                    modifiedAt: now,
                    pinned: false
                };
                targetArray.unshift(newNote);
                
                if(andSwitchToIt) {
                    state.settings.activeNoteId = newNote.id;
                }
                
                saveState();
                render();
                return newNote;
            };

            function init() {
                loadState();
                
                const savedApiKey = localStorage.getItem(API_KEY_STORAGE_ITEM);
                if (savedApiKey) {
                    app.modals.apiKey.classList.add('hidden');
                    app.modals.backdrop.classList.add('hidden');
                    app.modals.backdrop.style.opacity = '0';
                    app.modals.backdrop.style.pointerEvents = 'none';
                } else {
                    openModal(app.modals.apiKey, true);
                }

                app.modals.apiKeyConfirmBtn.addEventListener('click', () => {
                    const apiKey = app.modals.apiKeyInput.value.trim();
                    if (apiKey) {
                        localStorage.setItem(API_KEY_STORAGE_ITEM, apiKey);
                        closeModal(app.modals.apiKey);
                    } else {
                        app.modals.apiKeyError.textContent = 'API Key cannot be empty.';
                    }
                });

                app.elements.notesListPane.style.width = `${state.settings.paneWidth}px`;
                app.elements.sortOrderSelect.value = state.settings.listSortOrder;
                
                app.elements.themeToggle.addEventListener('click', () => {
                    const themes = ['reputify', 'light', 'dark'];
                    const currentThemeIndex = themes.indexOf(state.settings.theme);
                    state.settings.theme = themes[(currentThemeIndex + 1) % themes.length];
                    localStorage.setItem('codex-notes-theme', state.settings.theme); 
                    saveState();
                    renderTheme();
                    feather.replace();
                });
                
                app.elements.paneResizer.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    app.elements.paneResizer.classList.add('dragging');
                    document.body.style.cursor = 'col-resize';
                    const startX = e.clientX;
                    const startWidth = app.elements.notesListPane.offsetWidth;
                    const doDrag = (e) => {
                        let newWidth = startWidth + e.clientX - startX;
                        newWidth = Math.max(240, Math.min(newWidth, 500)); 
                        app.elements.notesListPane.style.width = `${newWidth}px`;
                    };
                    const stopDrag = () => {
                        app.elements.paneResizer.classList.remove('dragging');
                        document.body.style.cursor = 'default';
                        state.settings.paneWidth = app.elements.notesListPane.offsetWidth;
                        saveState();
                        document.removeEventListener('mousemove', doDrag);
                        document.removeEventListener('mouseup', stopDrag);
                    };
                    document.addEventListener('mousemove', doDrag);
                    document.addEventListener('mouseup', stopDrag);
                });

                const toggleMobileSidebar = (open) => {
                    const overlay = app.elements.mobileSidebarOverlay;
                    if (open) {
                        app.elements.notesListPane.classList.add('open');
                        overlay.classList.remove('hidden');
                        setTimeout(() => overlay.style.opacity = '1', 10);
                    } else {
                        app.elements.notesListPane.classList.remove('open');
                        overlay.style.opacity = '0';
                        setTimeout(() => overlay.classList.add('hidden'), 300);
                    }
                };
                
                app.elements.mobileMenuOpenBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleMobileSidebar(true);
                });
                app.elements.mobileMenuCloseBtn.addEventListener('click', () => toggleMobileSidebar(false));
                app.elements.mobileSidebarOverlay.addEventListener('click', () => toggleMobileSidebar(false));

                app.containers.collectionsList.addEventListener('click', (e) => {
                    const itemLink = e.target.closest('.collection-item');
                    if (!itemLink) return;
                    e.preventDefault();

                    const wrapper = itemLink.closest('.collection-item-wrapper');
                    const id = wrapper.dataset.id;
                    const { item } = findItem(id);

                    if (item.type === 'folder') {
                        state.settings.activeCollectionId = id;
                        state.settings.activeNoteId = null;
                        item.expanded = !item.expanded;
                    } else if (item.type === 'note') {
                         state.settings.activeNoteId = id;
                         const { parent } = findItem(id);
                         state.settings.activeCollectionId = (Array.isArray(parent)) ? null : parent.id;
                    }
                    saveState();
                    render();
                    if (window.innerWidth < 768) {
                        toggleMobileSidebar(false);
                    }
                });

                let draggedItemId = null;
                app.containers.collectionsList.addEventListener('dragstart', (e) => {
                    const wrapper = e.target.closest('.collection-item-wrapper');
                    if(wrapper) {
                        draggedItemId = wrapper.dataset.id;
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', draggedItemId);
                        setTimeout(() => wrapper.classList.add('opacity-50'), 0);
                    }
                });

                app.containers.collectionsList.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.drop-target-folder').forEach(el => el.classList.remove('drop-target-folder'));
                    document.querySelectorAll('.drop-indicator').forEach(el => el.remove());

                    const targetWrapper = e.target.closest('.collection-item-wrapper');
                    if (!targetWrapper || targetWrapper.dataset.id === draggedItemId) return;
                    
                    const { item: targetItem } = findItem(targetWrapper.dataset.id);
                    const indicator = document.createElement('div');
                    indicator.className = 'drop-indicator';

                    if (targetItem.type === 'folder') {
                        targetWrapper.classList.add('drop-target-folder');
                    }
                    
                    const rect = targetWrapper.getBoundingClientRect();
                    const isAfter = e.clientY > rect.top + rect.height / 2;
                    targetWrapper.insertAdjacentElement(isAfter ? 'afterend' : 'beforebegin', indicator);
                });

                app.containers.collectionsList.addEventListener('dragend', (e) => {
                    document.querySelectorAll('.collection-item-wrapper.opacity-50').forEach(el => el.classList.remove('opacity-50'));
                     document.querySelectorAll('.drop-indicator, .drop-target-folder').forEach(el => {
                        el.classList.remove('drop-target-folder');
                        if (el.classList.contains('drop-indicator')) el.remove();
                    });
                    draggedItemId = null;
                });

                app.containers.collectionsList.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const droppedOnWrapper = e.target.closest('.collection-item-wrapper');
                    if (!draggedItemId || !droppedOnWrapper) return;

                    const dragResult = findItem(draggedItemId);
                    const dropResult = findItem(droppedOnWrapper.dataset.id);

                    if (!dragResult || !dropResult || dragResult.item.id === dropResult.item.id || findItem(dropResult.item.id, [dragResult.item])) return;
                    
                    const sourceParent = dragResult.parent;
                    const sourceArray = Array.isArray(sourceParent) ? sourceParent : sourceParent.children;
                    const [draggedItem] = sourceArray.splice(dragResult.index, 1);
                    
                    const dropTargetIsFolder = dropResult.item.type === 'folder' && droppedOnWrapper.classList.contains('drop-target-folder');

                    if (dropTargetIsFolder) {
                        if (!dropResult.item.children) dropResult.item.children = [];
                        dropResult.item.children.unshift(draggedItem);
                        dropResult.item.expanded = true;
                    } else {
                        const dropParent = findItem(dropResult.item.id).parent;
                        const targetArray = Array.isArray(dropParent) ? dropParent : dropParent.children;
                        let finalDropIndex = targetArray.indexOf(dropResult.item);

                        const rect = droppedOnWrapper.getBoundingClientRect();
                        const isAfter = e.clientY > rect.top + rect.height / 2;
                        if (isAfter) finalDropIndex++;
                        
                        targetArray.splice(finalDropIndex, 0, draggedItem);
                    }
                    
                    if (draggedItem.type === 'note') {
                         const newParentResult = findItem(draggedItem.id);
                         const newParentId = newParentResult.parent?.id || null;
                         const newProjectColumns = state.kanbanColumns[newParentId];
                         if (newProjectColumns && newProjectColumns.length > 0) {
                             draggedItem.status = newProjectColumns[0].id;
                         } else {
                             draggedItem.status = null;
                         }
                    }

                    saveState();
                    render();
                });
                
                app.containers.kanbanBoard.addEventListener('click', async e => {
                    const addBtn = e.target.closest('#add-column-btn');
                    const renameBtn = e.target.closest('.rename-column-btn');
                    const deleteBtn = e.target.closest('.delete-column-btn');

                    const collectionId = state.settings.activeCollectionId;
                    if (!collectionId) return;

                    if (addBtn) {
                        const newName = await showPrompt({ title: 'New Column', message: 'Enter a name for the new column:', placeholder: 'e.g. Done' });
                        if (newName) {
                            if(!state.kanbanColumns[collectionId]) state.kanbanColumns[collectionId] = [];
                            state.kanbanColumns[collectionId].push({ id: generateId('col'), title: newName });
                            saveState();
                            render();
                        }
                    } else if (renameBtn) {
                        const columnEl = renameBtn.closest('.kanban-column');
                        const columnId = columnEl.dataset.columnId;
                        const column = state.kanbanColumns[collectionId].find(c => c.id === columnId);
                        const newName = await showPrompt({ title: 'Rename Column', message: `Enter a new name for "${column.title}":`, initialValue: column.title });
                        if(newName) {
                            column.title = newName;
                            saveState();
                            render();
                        }
                    } else if (deleteBtn) {
                        const columnEl = deleteBtn.closest('.kanban-column');
                        const columnId = columnEl.dataset.columnId;
                        const confirmed = await showConfirm({ title: 'Delete Column', message: 'Are you sure you want to delete this column? Notes inside will be moved to the first column.', confirmText: 'Delete' });
                        if (confirmed) {
                            const columns = state.kanbanColumns[collectionId];
                            const columnIndex = columns.findIndex(c => c.id === columnId);
                            const notesToMove = findItem(collectionId).item.children.filter(n => n.status === columnId);
                            
                            columns.splice(columnIndex, 1);

                            if(columns.length > 0) {
                                notesToMove.forEach(n => n.status = columns[0].id);
                            } else {
                                notesToMove.forEach(n => n.status = null);
                            }

                            saveState();
                            render();
                        }
                    }
                });
                
                let draggedKanbanNoteId = null;
                app.containers.kanbanBoard.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('kanban-card')) {
                        draggedKanbanNoteId = e.target.dataset.noteId;
                        e.dataTransfer.setData('text/plain', draggedKanbanNoteId);
                        setTimeout(() => e.target.classList.add('dragging'), 0);
                    }
                });

                app.containers.kanbanBoard.addEventListener('dragend', (e) => {
                    if (e.target.classList.contains('kanban-card')) {
                        e.target.classList.remove('dragging');
                    }
                    document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
                    draggedKanbanNoteId = null;
                });

                app.containers.kanbanBoard.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const column = e.target.closest('.kanban-column');
                    if (column) {
                        document.querySelectorAll('.drop-indicator').forEach(el => el.remove());

                        const cardsContainer = column.querySelector('.cards-container');
                        const afterElement = [...cardsContainer.querySelectorAll('.kanban-card:not(.dragging)')].reduce((closest, child) => {
                            const box = child.getBoundingClientRect();
                            const offset = e.clientY - box.top - box.height / 2;
                            if (offset < 0 && offset > closest.offset) {
                                return { offset: offset, element: child };
                            } else {
                                return closest;
                            }
                        }, { offset: Number.NEGATIVE_INFINITY }).element;
                        
                        const indicator = document.createElement('div');
                        indicator.className = 'drop-indicator';

                        if (afterElement == null) {
                            cardsContainer.appendChild(indicator);
                        } else {
                            cardsContainer.insertBefore(indicator, afterElement);
                        }
                    }
                });
                
                app.containers.kanbanBoard.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const columnEl = e.target.closest('.kanban-column');
                    if (columnEl && draggedKanbanNoteId) {
                        const newColumnId = columnEl.dataset.columnId;
                        const collectionId = state.settings.activeCollectionId;
                        const collectionResult = findItem(collectionId);
                        const collectionNotes = collectionResult.item.children;

                        const dragResult = findItem(draggedKanbanNoteId);
                        const [draggedNote] = collectionNotes.splice(collectionNotes.indexOf(dragResult.item), 1);
                        draggedNote.status = newColumnId;
                        
                        const dropIndicator = columnEl.querySelector('.drop-indicator');
                        if (dropIndicator) {
                            const nextCard = dropIndicator.nextElementSibling;
                            if (nextCard) {
                                const nextNoteId = nextCard.dataset.noteId;
                                const nextNote = findItem(nextNoteId).item;
                                const targetIndex = collectionNotes.indexOf(nextNote);
                                collectionNotes.splice(targetIndex, 0, draggedNote);
                            } else {
                                collectionNotes.push(draggedNote);
                            }
                            dropIndicator.remove();
                        } else {
                            collectionNotes.push(draggedNote);
                        }
                        
                        saveState();
                        renderKanbanView();
                        feather.replace();
                    }
                });
                
                app.elements.viewSwitcher.addEventListener('click', (e) => {
                    const button = e.target.closest('.view-btn');
                    if(button && !button.classList.contains('active')) {
                        state.settings.activeView = button.dataset.view;
                        saveState();
                        renderMainView();
                        renderMobileControls();
                        feather.replace();
                    }
                });

                app.containers.mobileControlsDropdown.addEventListener('click', (e) => {
                    const button = e.target.closest('.view-btn-mobile');
                    if (button) {
                        state.settings.activeView = button.dataset.view;
                        saveState();
                        renderMainView();
                        renderMobileControls();
                    }
                    const mobileEditorToggle = e.target.closest('#mobile-editor-mode-toggle');
                    if(mobileEditorToggle) {
                         if (!state.settings.activeNoteId) return;
                        state.settings.editorMode = state.settings.editorMode === 'editor' ? 'preview' : 'editor';
                        saveState();
                        renderNoteEditor();
                        renderMobileControls();
                    }
                    const ocrBtn = e.target.closest('[data-command="ocr"]');
                    if(ocrBtn) {
                        app.toolbar.ocrFileInput.click();
                    }
                });
                 app.containers.mobileControlsDropdown.addEventListener('change', (e) => {
                    if (e.target.id === 'sort-order-mobile') {
                        state.settings.listSortOrder = e.target.value;
                        app.elements.sortOrderSelect.value = e.target.value;
                        saveState();
                        renderListView();
                        feather.replace();
                    }
                });
                
                app.elements.sortOrderSelect.addEventListener('change', (e) => {
                    state.settings.listSortOrder = e.target.value;
                    saveState();
                    renderListView();
                    feather.replace();
                });
                
                app.containers.mainContentArea.addEventListener('click', (e) => {
                    const summarizeBtn = e.target.closest('.summarize-btn');
                    if (summarizeBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        const noteId = summarizeBtn.dataset.noteId;
                        const { item: note } = findItem(noteId);
                        const noteItemEl = summarizeBtn.closest('.list-note-item');
                        const plainContent = (note.content || '').replace(/<[^>]*>?/gm, '').trim();
                        if (!plainContent) {
                            showToast("Note is empty, nothing to summarize.", "info");
                            return;
                        }
                        handleSummarize(plainContent, noteItemEl);
                        return;
                    }
                    
                    const card = e.target.closest('.kanban-card, .list-note-item');
                    if (card) {
                        state.settings.activeNoteId = card.dataset.noteId;
                        const { parent } = findItem(state.settings.activeNoteId);
                        state.settings.activeCollectionId = (Array.isArray(parent)) ? null : parent.id;
                        saveState();
                        render();
                        return;
                    }
                    
                    const link = e.target.closest('a');
                    if (link && link.href && (app.elements.noteEditorBody.contains(link) || app.elements.markdownPreview.contains(link))) {
                        e.preventDefault();
                        window.open(link.href, '_blank');
                    }
                });
                
                app.containers.searchResultsList.addEventListener('click', (e) => {
                    const card = e.target.closest('.search-result-item');
                    if (card) {
                        state.settings.activeNoteId = card.dataset.noteId;
                        const { parent } = findItem(state.settings.activeNoteId);
                        state.settings.activeCollectionId = (Array.isArray(parent)) ? null : parent.id;
                        saveState();
                        render();
                        closeModal(app.modals.search);
                        return;
                    }
                });

                const saveNoteContent = debounce(() => {
                    if (!state.settings.activeNoteId) return;
                    const {item: note} = findItem(state.settings.activeNoteId);
                    if(note) {
                        const newName = app.elements.noteEditorTitle.value;
                        const newContent = app.elements.noteEditorBody.innerHTML;
                        
                        if(note.name !== newName || note.content !== newContent) {
                            note.name = newName;
                            note.content = newContent;
                            note.modifiedAt = new Date().toISOString();
                            saveState();
                            renderCollectionsList();
                        }
                    }
                }, 500);

                const updateStatsDebounced = debounce(updateEditorStats, 250);

                app.elements.noteEditorTitle.addEventListener('input', saveNoteContent);
                app.elements.noteEditorBody.addEventListener('input', () => {
                    saveNoteContent();
                    updateStatsDebounced();
                });
                
                const handleImageFile = (file) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const imgHTML = `<img src="${e.target.result}" alt="Pasted image">`;
                            document.execCommand('insertHTML', false, imgHTML);
                            saveNoteContent();
                        };
                        reader.readAsDataURL(file);
                        return true;
                    }
                    return false;
                };

                app.elements.noteEditorBody.addEventListener('paste', (e) => {
                    const files = e.clipboardData.files;
                    for (const file of files) {
                        if (handleImageFile(file)) {
                            e.preventDefault();
                        }
                    }
                });

                app.elements.noteEditorBody.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const files = e.dataTransfer.files;
                    for (const file of files) {
                        handleImageFile(file);
                    }
                });
                
                app.elements.noteEditorBody.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                app.toolbar.ocrBtn.addEventListener('click', () => app.toolbar.ocrFileInput.click());
                app.toolbar.ocrFileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    if (!state.settings.activeNoteId) {
                        createNewNote();
                    }
                    
                    const toastId = showToast('Recognizing text...', 'loading');
                    try {
                        const { data: { text } } = await Tesseract.recognize(file, 'eng');
                        const formattedText = `<p>${text.replace(/\n/g, '</p><p>')}</p>`;
                        app.elements.noteEditorBody.focus();
                        document.execCommand('insertHTML', false, formattedText);
                        saveNoteContent();
                        showToast('Text inserted!', 'success');
                    } catch (err) {
                        console.error(err);
                        showToast('Could not recognize text.', 'error');
                    } finally {
                        dismissToast(toastId);
                        app.toolbar.ocrFileInput.value = '';
                    }
                });
                
                app.modals.aiCancelBtn.addEventListener('click', () => closeModal(app.modals.aiPrompt));
                app.modals.aiGenerateBtn.addEventListener('click', async () => {
                    const prompt = app.modals.aiPromptInput.value.trim();
                    if (!prompt) {
                        app.modals.aiPromptError.textContent = 'Please enter a prompt.';
                        return;
                    }
                    
                    if (!state.settings.activeNoteId) {
                        createNewNote();
                    }
                    
                    app.modals.aiGenerateBtn.disabled = true;
                    app.modals.aiGenerateBtnText.textContent = 'Generating...';

                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const generatedText = await callGeminiAPI(payload, app.modals.aiPromptError);

                    if (generatedText) {
                        app.elements.noteEditorBody.focus();
                        if (editorSelectionRange) {
                            const selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(editorSelectionRange);
                        }
                        const formattedHtml = marked.parse(generatedText).trim();
                        document.execCommand('insertHTML', false, formattedHtml);
                        saveNoteContent();
                        closeModal(app.modals.aiPrompt);
                        showToast('AI content inserted!', 'success');
                    }
                    
                    app.modals.aiGenerateBtn.disabled = false;
                    app.modals.aiGenerateBtnText.textContent = 'Generate';
                });

                const handleSummarize = async (noteContent, noteItemEl) => {
                    const toastId = showToast('Summarizing...', 'loading');
                    const prompt = `Summarize the following text into a single, concise paragraph:\n\n---\n\n${noteContent}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const summaryText = await callGeminiAPI(payload);

                    dismissToast(toastId);
                    if (summaryText && noteItemEl) {
                        const existingSummary = noteItemEl.querySelector('.ai-summary');
                        if (existingSummary) existingSummary.remove();

                        const summaryEl = document.createElement('div');
                        summaryEl.className = 'ai-summary mt-3 p-3 bg-bg-pane-dark rounded-md border border-border-color text-sm text-text-secondary';
                        summaryEl.innerHTML = marked.parse(summaryText).trim();
                        noteItemEl.appendChild(summaryEl);
                        showToast('Summary generated!', 'success');
                    } else if (!summaryText) {
                         showToast('Could not generate summary.', 'error');
                    }
                };
                app.modals.summaryCloseBtn.addEventListener('click', () => closeModal(app.modals.summary));

                app.elements.chatbotFab.addEventListener('click', () => {
                    renderChatHistory();
                    openModal(app.modals.chatbot);
                    app.modals.chatbotInput.focus();
                    feather.replace();
                });
                app.modals.chatbotCloseBtn.addEventListener('click', () => closeModal(app.modals.chatbot));
                app.modals.chatbotClearBtn.addEventListener('click', async () => {
                    const confirmed = await showConfirm({
                        title: 'Clear Chat History',
                        message: 'Are you sure you want to delete the entire conversation?',
                        confirmText: 'Clear',
                        confirmClass: 'bg-red-500'
                    });
                    if (confirmed) {
                        state.chatHistory = [];
                        saveState();
                        renderChatHistory();
                        showToast('Chat history cleared', 'success');
                    }
                });

                const handleChatSubmit = async () => {
                    const userInput = app.modals.chatbotInput.value.trim();
                    if (!userInput) return;
                    
                    app.modals.chatbotError.textContent = '';
                    app.modals.chatbotInput.value = '';
                    app.modals.chatbotSendBtn.disabled = true;

                    state.chatHistory.push({ role: 'user', text: userInput });
                    renderChatHistory();
                    
                    const thinkingBubble = document.createElement('div');
                    thinkingBubble.className = 'chat-bubble thinking w-fit rounded-lg px-3 py-2 self-start model';
                    thinkingBubble.innerHTML = '● ● ●';
                    app.modals.chatbotHistory.appendChild(thinkingBubble);
                    app.modals.chatbotHistory.scrollTop = app.modals.chatbotHistory.scrollHeight;

                    const payload = {
                        contents: state.chatHistory.map(msg => ({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.text }]
                        }))
                    };

                    const modelResponse = await callGeminiAPI(payload, app.modals.chatbotError);
                    
                    thinkingBubble.remove();

                    if (modelResponse) {
                        state.chatHistory.push({ role: 'model', text: modelResponse });
                        renderChatHistory();
                    }
                    saveState();
                    app.modals.chatbotSendBtn.disabled = false;
                    app.modals.chatbotInput.focus();
                };

                app.modals.chatbotSendBtn.addEventListener('click', handleChatSubmit);
                app.modals.chatbotInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleChatSubmit();
                    }
                });

                app.elements.newCollectionBtn.addEventListener('click', async () => {
                    const name = await showPrompt({ title: 'New Collection', message: 'Enter a name for your new collection:', placeholder: 'e.g. Project Phoenix' });
                    if (name) {
                        const newCollection = {
                            id: generateId('c'), name, type: 'folder', children: [], expanded: true
                        };
                        state.collections.push(newCollection);
                        state.kanbanColumns[newCollection.id] = [{ id: generateId('col'), title: 'To Do' }];
                        state.settings.activeCollectionId = newCollection.id;
                        saveState();
                        render();
                    }
                });

                app.elements.desktopNewNoteBtn.addEventListener('click', () => createNewNote());
                app.elements.mobileNewNoteFab.addEventListener('click', () => {
                    const newNote = createNewNote();
                    if (window.innerWidth < 768) {
                        toggleMobileSidebar(false);
                    }
                });

                app.elements.mobileSearchButton.addEventListener('click', () => {
                    openModal(app.modals.search);
                    renderSearchResults('');
                });
                app.modals.searchCloseBtn.addEventListener('click', () => closeModal(app.modals.search));
                app.modals.searchInput.addEventListener('input', () => {
                    renderSearchResults(app.modals.searchInput.value);
                });

                app.toolbar.editorModeToggle.addEventListener('click', () => {
                    if (!state.settings.activeNoteId) return;
                    state.settings.editorMode = state.settings.editorMode === 'editor' ? 'preview' : 'editor';
                    saveState();
                    renderNoteEditor();
                });

                document.addEventListener('selectionchange', () => {
                    if (document.activeElement !== app.elements.noteEditorBody) {
                        app.toolbar.inline.style.opacity = '0';
                        app.toolbar.inline.style.pointerEvents = 'none';
                        return;
                    }
                    const selection = window.getSelection();

                    if (selection.isCollapsed) {
                        app.toolbar.inline.style.opacity = '0';
                        app.toolbar.inline.style.pointerEvents = 'none';
                        return;
                    }

                    if (selection.rangeCount > 0) {
                        editorSelectionRange = selection.getRangeAt(0).cloneRange();
                    }

                    const range = selection.getRangeAt(0);
                    const rect = range.getBoundingClientRect();
                    const toolbarRect = app.toolbar.inline.getBoundingClientRect();
                    app.toolbar.inline.style.top = `${window.scrollY + rect.top - toolbarRect.height - 8}px`;
                    app.toolbar.inline.style.left = `${window.scrollX + rect.left + (rect.width / 2) - (toolbarRect.width / 2)}px`;
                    app.toolbar.inline.style.opacity = '1';
                    app.toolbar.inline.style.transform = 'scale(1)';
                    app.toolbar.inline.style.pointerEvents = 'auto';
                });
                
                app.toolbar.inline.addEventListener('mousedown', async (e) => {
                    e.preventDefault();
                    const button = e.target.closest('button');
                    if(!button) return;
                    
                    const command = button.dataset.command;
                    const value = button.dataset.value;

                    const restoreSelectionAndExec = (execFn) => {
                        app.elements.noteEditorBody.focus();
                        if (editorSelectionRange) {
                            const selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(editorSelectionRange);
                        }
                        execFn();
                        saveNoteContent();
                        if (window.getSelection().rangeCount > 0) {
                           editorSelectionRange = window.getSelection().getRangeAt(0).cloneRange();
                        }
                    };

                    if (command === 'createLink') {
                        app.elements.noteEditorBody.focus();
                        if (editorSelectionRange) {
                            const selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(editorSelectionRange);
                        }

                        const selection = window.getSelection();
                        const parentEl = selection.anchorNode?.parentNode.closest('a');

                        if(parentEl) {
                            restoreSelectionAndExec(() => {
                                document.execCommand('unlink');
                            });
                        } else {
                            const selectedText = selection.toString().trim();
                            const url = await showPrompt({ title: 'Insert Link', message: 'Enter the URL:', placeholder: 'https://example.com' });
                            if (url) {
                                restoreSelectionAndExec(() => {
                                    let finalUrl = url;
                                    if (!/^(https?:\/\/|mailto:|ftp:\/\/)/i.test(finalUrl)) {
                                        finalUrl = 'https://' + finalUrl;
                                    }
                                    const linkHTML = `<a href="${finalUrl}" target="_blank" rel="noopener noreferrer">${selectedText || finalUrl}</a>`;
                                    document.execCommand('insertHTML', false, linkHTML);
                                });
                            }
                        }
                    } else if (command === 'insertImage') {
                        const url = await showPrompt({ title: 'Insert Image', message: 'Enter the image URL:', placeholder: 'https://example.com/image.png' });
                        if (url) {
                           restoreSelectionAndExec(() => document.execCommand('insertHTML', false, `<img src="${url}" alt="Image">`));
                        }
                    } else if (command === 'formatBlock') {
                         restoreSelectionAndExec(() => {
                            const selection = window.getSelection();
                            let parentEl = selection.getRangeAt(0).commonAncestorContainer;
                            parentEl = parentEl.nodeType === 3 ? parentEl.parentNode : parentEl;
                            const currentTag = parentEl.closest('h1, h2, h3');
                            if (currentTag && currentTag.tagName.toLowerCase() === value) {
                                document.execCommand('formatBlock', false, 'p');
                            } else {
                                document.execCommand(command, false, value);
                            }
                        });
                    } else {
                        restoreSelectionAndExec(() => document.execCommand(command, false, null));
                    }
                });

                app.elements.notesListPane.addEventListener('contextmenu', e => {
                    const itemWrapper = e.target.closest('.collection-item-wrapper');
                    
                    app.contextMenu.togglePinBtn.style.display = 'none';
                    app.contextMenu.renameBtn.style.display = 'none';
                    app.contextMenu.deleteBtn.style.display = 'none';
                    app.contextMenu.duplicateBtn.style.display = 'none';

                    if (!itemWrapper && e.target.closest('#collections-list-container')) {
                        app.contextMenu.targetId = null;
                        app.contextMenu.targetIsContainer = true;
                    } else if (itemWrapper) {
                        e.preventDefault();
                        app.contextMenu.targetId = itemWrapper.dataset.id;
                        app.contextMenu.targetIsContainer = false;
                        const { item } = findItem(app.contextMenu.targetId);
                        
                        app.contextMenu.renameBtn.style.display = 'flex';
                        app.contextMenu.deleteBtn.style.display = 'flex';
                        app.contextMenu.duplicateBtn.style.display = 'flex';

                        if (item && item.type === 'note') {
                            app.contextMenu.togglePinBtn.style.display = 'flex';
                            app.contextMenu.pinActionText.textContent = item.pinned ? 'Unpin' : 'Pin';
                        }
                    } else {
                        return;
                    }

                    app.contextMenu.menu.style.top = `${e.clientY}px`;
                    app.contextMenu.menu.style.left = `${e.clientX}px`;
                    app.contextMenu.menu.classList.remove('hidden');
                    setTimeout(() => app.contextMenu.menu.classList.remove('scale-95', 'opacity-0'), 10);
                    feather.replace();
                });

                const duplicateItem = (sourceItem) => {
                    const newItem = JSON.parse(JSON.stringify(sourceItem));
                    newItem.id = generateId(sourceItem.type[0]);
                    newItem.name = `${sourceItem.name} (copy)`;
                    
                    const now = new Date().toISOString();
                    if (newItem.type === 'note') {
                        newItem.createdAt = now;
                        newItem.modifiedAt = now;
                    }

                    if (newItem.type === 'folder' && newItem.children) {
                        newItem.children = newItem.children.map(child => duplicateItem(child));
                        if (state.kanbanColumns[sourceItem.id]) {
                            state.kanbanColumns[newItem.id] = JSON.parse(JSON.stringify(state.kanbanColumns[sourceItem.id]));
                        }
                    }
                    return newItem;
                };

                app.contextMenu.menu.addEventListener('click', async e => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const action = button.dataset.action;
                    const id = app.contextMenu.targetId;
                    
                    let findResult, targetItem, parent, parentArray;

                    if (id) {
                        findResult = findItem(id);
                        targetItem = findResult.item;
                        parent = findResult.parent;
                        parentArray = Array.isArray(parent) ? parent : parent.children;
                    }

                    const createNewItem = (type) => {
                        const name = type === 'note' ? 'Untitled Note' : 'New Folder';
                        const now = new Date().toISOString();
                        const newItem = {
                            id: generateId(type[0]), name, type,
                            ...(type === 'note' && { content: '', status: null, createdAt: now, modifiedAt: now, pinned: false }),
                            ...(type === 'folder' && { children: [], expanded: true })
                        };

                        let destinationArray = state.collections;
                        let parentFolder = null;
                        
                        if (targetItem) {
                            if (targetItem.type === 'folder') {
                                destinationArray = targetItem.children;
                                targetItem.expanded = true;
                                parentFolder = targetItem;
                            } else {
                                destinationArray = parentArray;
                                parentFolder = parent;
                            }
                        }
                        
                        if (newItem.type === 'note' && parentFolder?.id) {
                            newItem.status = state.kanbanColumns[parentFolder.id]?.[0]?.id || null;
                        }
                        
                        destinationArray.unshift(newItem);
                        
                        if (type === 'note') {
                            state.settings.activeNoteId = newItem.id;
                        } else {
                           state.kanbanColumns[newItem.id] = [{ id: generateId('col'), title: 'To Do' }];
                        }
                        
                        saveState();
                        render();
                    };

                    switch(action) {
                        case 'new-note': createNewItem('note'); break;
                        case 'new-folder': createNewItem('folder'); break;
                        case 'delete':
                            const confirmed = await showConfirm({ title: `Delete "${targetItem.name}"`, message: 'This action cannot be undone.', confirmText: 'Delete', confirmClass: 'bg-red-600' });
                            if (confirmed) {
                               const index = parentArray.findIndex(i => i.id === id);
                               parentArray.splice(index, 1);
                               showToast(`"${targetItem.name}" deleted.`);
                               if (state.settings.activeNoteId === id) state.settings.activeNoteId = null;
                               if (state.settings.activeCollectionId === id) state.settings.activeCollectionId = null;
                               saveState();
                               render();
                            }
                            break;
                        case 'rename':
                            const newName = await showPrompt({ title: 'Rename', message: `Enter a new name for "${targetItem.name}":`, initialValue: targetItem.name });
                            if (newName) {
                                targetItem.name = newName;
                                saveState();
                                render();
                            }
                            break;
                        case 'toggle-pin':
                            if(targetItem && targetItem.type === 'note') {
                                targetItem.pinned = !targetItem.pinned;
                                showToast(targetItem.pinned ? `Pinned "${targetItem.name}"` : `Unpinned "${targetItem.name}"`);
                                saveState();
                                render();
                            }
                            break;
                        case 'duplicate':
                            if (!targetItem) return;
                            const newItem = duplicateItem(targetItem);
                            parentArray.splice(findResult.index + 1, 0, newItem);
                            showToast(`Duplicated "${targetItem.name}"`);
                            saveState();
                            render();
                            break;
                    }
                    closeContextMenu();
                });
                
                const closeContextMenu = () => {
                    app.contextMenu.menu.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => app.contextMenu.menu.classList.add('hidden'), 100);
                };
                
                app.elements.notesListPane.addEventListener('click', async e => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const action = button.dataset.action;

                    if (action === 'export') {
                        const dataStr = JSON.stringify(state, null, 2);
                        const dataBlob = new Blob([dataStr], {type: "application/json"});
                        const url = URL.createObjectURL(dataBlob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `codex-notes-backup-${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        showToast('Data exported successfully!', 'success');
                    } else if (action === 'import') {
                        app.elements.importFileInput.click();
                    }
                });

                app.elements.importFileInput.addEventListener('change', async e => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const confirmed = await showConfirm({
                        title: 'Import Data',
                        message: 'This will <strong>overwrite all current data</strong> in the app. Are you sure you want to continue?',
                        confirmText: 'Overwrite and Import',
                        confirmClass: 'bg-orange-500'
                    });
                    if (!confirmed) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const importedState = JSON.parse(event.target.result);
                            state = migrateState(importedState);
                            saveState();
                            showToast('Data imported successfully!', 'success');
                            location.reload();
                        } catch (err) {
                            console.error("Import error:", err);
                            showToast('Invalid or corrupted data file.', 'error');
                        }
                    };
                    reader.readAsText(file);
                    app.elements.importFileInput.value = '';
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeModal(app.modals.search);
                        closeContextMenu();
                        if (app.elements.notesListPane.classList.contains('open')) {
                            toggleMobileSidebar(false);
                        }
                    }
                    if ((e.metaKey || e.ctrlKey) && !e.shiftKey) {
                        if (e.key === 'f') { e.preventDefault(); openModal(app.modals.search); }
                        if (e.key === 'n') { e.preventDefault(); createNewNote(); }
                    }
                });
                
                document.addEventListener('click', (e) => {
                    if(!app.contextMenu.menu.contains(e.target)) closeContextMenu();
                    if(!app.containers.mobileControlsDropdown.contains(e.target) && !app.elements.mobileMoreButton.contains(e.target)) {
                        const dropdown = app.containers.mobileControlsDropdown;
                        dropdown.classList.add('scale-95', 'opacity-0');
                        setTimeout(() => dropdown.classList.add('hidden'), 100);
                    }
                });
                
                app.elements.mobileMoreButton.addEventListener('click', () => {
                    const dropdown = app.containers.mobileControlsDropdown;
                    const isHidden = dropdown.classList.contains('hidden');
                    if (isHidden) {
                        dropdown.classList.remove('hidden');
                        setTimeout(() => dropdown.classList.remove('scale-95', 'opacity-0'), 10);
                    } else {
                        dropdown.classList.add('scale-95', 'opacity-0');
                        setTimeout(() => dropdown.classList.add('hidden'), 100);
                    }
                });

                render();
            }

            init();
        });
    </script>

</body>
</html>
