<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Reputifly – Maps Extractor</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg1:#1e1e2f; --bg2:#141422;
      --panel:#1c1e26; --input:#23252e;
      --bd:#2f3038; --fg:#e1e4e8; --fg2:#8b94a6;
      --p1:#6e7ff9; --p2:#9c64f9;
      --r:8px; --s:16px; --ff:'Inter',sans-serif;
    }
    * { box-sizing:border-box; margin:0; padding:0; font-family:var(--ff) }
    html, body {
      width:100%; height:100%;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--fg); overflow:hidden;
    }
    a { color:var(--p1); text-decoration:none }
    a:hover { text-decoration:underline }

    #container { display:flex; flex-direction:column; height:100% }

    .header {
      display:flex; align-items:center; justify-content:space-between;
      padding:var(--s); background:var(--panel); border-bottom:1px solid var(--bd);
    }
    .header-left { display:flex; align-items:center }
    .header img { width:32px; height:32px; margin-right:12px }
    .header h1 { font-size:20px; font-weight:600; color:var(--fg) }

    .body { flex:1; overflow-y:auto; padding:var(--s) }
    .section-title { font-size:16px; font-weight:500; margin-bottom:8px }

    .button-row { display:flex; gap:12px; margin-bottom:var(--s) }
    .btn {
      font-size:14px; font-weight:500; padding:10px 20px;
      border-radius:var(--r); cursor:pointer; border:1px solid transparent;
      transition:background .2s,box-shadow .2s;
    }
    .btn + .btn { margin-left:12px }
    .btn-primary {
      background:linear-gradient(45deg,var(--p1),var(--p2));
      color:#fff; box-shadow:0 0 8px rgba(156,100,249,0.6);
    }
    .btn-primary:hover { box-shadow:0 0 12px rgba(156,100,249,0.8); }
    .btn-secondary {
      background:none; color:var(--fg); border-color:var(--bd);
    }
    .btn-secondary:hover { background:rgba(255,255,255,0.05); }

    textarea {
      width:100%; background:var(--input); border:1px solid var(--bd);
      border-radius:var(--r); padding:var(--s); color:var(--fg);
      font-size:14px; resize:vertical; height:140px;
    }

    .progress-info {
      font-size:14px; font-weight:500; color:var(--fg2);
      margin-bottom:4px; display:none;
    }
    .progress-container {
      width:100%; height:8px; background:var(--input);
      border:1px solid var(--bd); border-radius:4px;
      overflow:hidden; display:none; margin-bottom:var(--s);
    }
    .progress-bar {
      height:100%; width:0;
      background:linear-gradient(90deg,var(--p1),var(--p2));
      transition:width .2s;
    }

    .filter-row {
      display:flex; align-items:center; gap:12px;
      margin-bottom:var(--s); font-size:14px; color:var(--fg);
    }
    .filter-row select {
      background:var(--input); border:1px solid var(--bd);
      border-radius:4px; color:var(--fg); padding:4px 8px;
    }

    .sub-tabs {
      display:flex; gap:8px; margin-bottom:var(--s);
    }
    .sub-tab {
      flex:1; padding:8px; text-align:center;
      background:var(--input); border:1px solid var(--bd);
      border-radius:var(--r); cursor:pointer;
      color:var(--fg2); font-weight:500;
      transition:background .2s,color .2s;
    }
    .sub-tab.active {
      background:var(--panel); color:var(--fg);
      border-color:var(--p1);
    }
    .sub-tab:hover { background:rgba(255,255,255,0.05); }

    .data-preview {
      background:var(--panel); border:1px solid var(--bd);
      border-radius:var(--r); padding:var(--s);
      max-height:300px; overflow-y:auto;
    }
    .data-preview .row {
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 0; border-bottom:1px solid var(--bd); font-size:14px;
    }
    .data-preview .row:last-child { border-bottom:none }
    .data-preview .left {
      display:flex; align-items:center; gap:12px; flex:1; min-width:0;
    }
    .data-preview .left input { transform:scale(1.2) }

    .info { display:flex; flex-direction:column; gap:2px; }

    /* inline name + add-note link */
    .line1-row {
      display:flex; align-items:center; justify-content:space-between;
    }
    .line1 {
      font-weight:500;
      max-width:200px; /* always truncate */
      overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
    }
    .add-note {
      margin-left:8px; color:var(--p1); cursor:pointer; font-size:14px;
    }
    .line2 { color:var(--fg2); }
    .note {
      font-size:12px; color:var(--fg2); margin-top:4px;
    }

    .data-preview .right a {
      font-weight:500; color:var(--p1);
    }

    .popup-overlay {
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      display:none; align-items:center; justify-content:center;
      z-index:1000;
    }
    .popup {
      position:relative;
      background:var(--panel); border:1px solid var(--bd);
      border-radius:var(--r); padding:var(--s); width:400px;
      box-shadow:0 8px 24px rgba(0,0,0,0.6);
    }
    .popup h2 { font-size:18px; margin-bottom:12px; color:var(--fg) }
    .popup textarea {
      width:100%; background:var(--input); border:1px solid var(--bd);
      border-radius:var(--r); padding:8px; color:var(--fg);
      margin-bottom:12px; font-size:14px; min-height:120px;
    }
    .popup .guide {
      font-size:13px; color:var(--fg2); margin-bottom:8px;
    }
    .popup-buttons {
      display:flex; justify-content:flex-end;
    }
    .popup-buttons .btn + .btn { margin-left:12px }

    /* upload icon bottom-left */
    .upload-icon {
      position:absolute; bottom:var(--s); left:var(--s);
      width:24px; height:24px; cursor:pointer; opacity:0.8;
    }
    .upload-icon:hover { opacity:1; }

    @media (max-width:600px) {
      .data-preview .row {
        flex-direction:column; align-items:flex-start;
      }
      .data-preview .right { margin-top:8px }
      .data-preview .left { flex-wrap:wrap; gap:8px }
      .line1 { max-width:140px; }
      .popup { width:90%; }
    }
  </style>
</head>
<body>
  <div id="container">
    <div class="header">
      <div class="header-left">
        <img src="https://reputifly.com/wp-content/uploads/2025/05/reputifly-new-e1746390492876.png" alt="Reputifly">
        <h1>Maps Extractor</h1>
      </div>
      <button id="btn-importexport" class="btn btn-secondary">Import / Export Data</button>
    </div>

    <div class="body">
      <div class="section-title">Maps Extractor</div>
      <div class="button-row">
        <button id="btn-customize" class="btn btn-secondary">Customize Message</button>
        <button id="btn-extract" class="btn btn-primary">Extract Filtered Phone Numbers</button>
      </div>

      <textarea id="raw-input" placeholder="Paste raw Google Maps snippet…"></textarea>

      <div id="progress-info" class="progress-info"></div>
      <div id="progress-wrap" class="progress-container">
        <div id="progress-bar" class="progress-bar"></div>
      </div>

      <div class="filter-row">
        Min Rating:
        <select id="rating-filter">
          <option value="0">All</option>
          <option value="3.0">3.0+</option>
          <option value="3.5">3.5+</option>
          <option value="4.0">4.0+</option>
          <option value="4.5">4.5+</option>
          <option value="5.0">5.0</option>
        </select>
        Sort:
        <select id="sort-filter">
          <option value="desc">Highest→Lowest</option>
          <option value="asc">Lowest→Highest</option>
        </select>
      </div>

      <div class="sub-tabs">
        <div id="tab-all" class="sub-tab active">All Numbers (<span id="cnt-all">0</span>)</div>
        <div id="tab-yes" class="sub-tab">All Texted (<span id="cnt-yes">0</span>)</div>
        <div id="tab-no"  class="sub-tab">All Untexted (<span id="cnt-no">0</span>)</div>
      </div>

      <div id="data-div" class="data-preview"></div>
    </div>

    <!-- Customize Message Popup -->
    <div id="popup-custom" class="popup-overlay">
      <div class="popup">
        <h2>Customize Message Template</h2>
        <textarea id="tmpl-text" placeholder="Use %business and %rating…"></textarea>
        <div class="guide">
          Placeholders:<br>
          • %business → Business Name<br>
          • %rating   → Rating
        </div>
        <div class="popup-buttons">
          <button id="btn-cancel" class="btn btn-secondary">Cancel</button>
          <button id="btn-save" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>

    <!-- Import/Export Popup -->
    <div id="popup-io" class="popup-overlay">
      <div class="popup">
        <h2>Import / Export Data</h2>
        <textarea id="export-data" readonly placeholder="Exported JSON will appear here…"></textarea>
        <div class="popup-buttons">
          <button id="btn-download" class="btn btn-primary">Download JSON</button>
        </div>
        <hr style="border-color:var(--bd);margin:12px 0;">
        <textarea id="import-data" placeholder="Or paste JSON here to import…"></textarea>
        <input type="file" id="import-file" accept="application/json" style="display:none">
        <img src="https://cdn-icons-png.flaticon.com/512/564/564834.png"
             id="upload-icon" class="upload-icon" title="Upload JSON file">
        <div class="popup-buttons">
          <button id="btn-import" class="btn btn-secondary">Import JSON</button>
          <button id="btn-close-io" class="btn btn-primary">Close</button>
        </div>
      </div>
    </div>

    <!-- Note Popup -->
    <div id="popup-note" class="popup-overlay">
      <div class="popup">
        <h2>Add / Edit Note</h2>
        <textarea id="note-text" placeholder="Enter note…"></textarea>
        <div class="popup-buttons">
          <button id="note-delete" class="btn btn-secondary">Delete</button>
          <button id="note-cancel" class="btn btn-secondary">Cancel</button>
          <button id="note-save" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Storage
    const loadAll   = ()=> JSON.parse(localStorage.getItem('mapsAll')||'[]');
    const saveAll   = arr=> localStorage.setItem('mapsAll', JSON.stringify(arr));
    const loadTxt   = ()=> new Set(JSON.parse(localStorage.getItem('mapsTxt')||'[]'));
    const saveTxt   = s=> localStorage.setItem('mapsTxt', JSON.stringify([...s]));
    const loadNotes = ()=> JSON.parse(localStorage.getItem('mapsNotes')||'{}');
    const saveNotes = o=> localStorage.setItem('mapsNotes', JSON.stringify(o));

    // Refs
    const rawInput     = document.getElementById('raw-input'),
          progInfo     = document.getElementById('progress-info'),
          progWrap     = document.getElementById('progress-wrap'),
          progBar      = document.getElementById('progress-bar'),
          ratingFilter = document.getElementById('rating-filter'),
          sortFilter   = document.getElementById('sort-filter'),
          tabAll       = document.getElementById('tab-all'),
          tabYes       = document.getElementById('tab-yes'),
          tabNo        = document.getElementById('tab-no'),
          cntAll       = document.getElementById('cnt-all'),
          cntYes       = document.getElementById('cnt-yes'),
          cntNo        = document.getElementById('cnt-no'),
          dataDiv      = document.getElementById('data-div'),
          popupCustom  = document.getElementById('popup-custom'),
          popupIO      = document.getElementById('popup-io'),
          popupNote    = document.getElementById('popup-note'),
          tmplText     = document.getElementById('tmpl-text'),
          exportTA     = document.getElementById('export-data'),
          importTA     = document.getElementById('import-data'),
          importFile   = document.getElementById('import-file'),
          uploadIcon   = document.getElementById('upload-icon'),
          noteTextTA   = document.getElementById('note-text'),
          btnImportExp = document.getElementById('btn-importexport');

    let msgTpl = 'Hi %business, your rating is %rating stars.';
    let currentNotePhone = null;

    function updateCounts(){
      const all = loadAll(), t = loadTxt();
      cntAll.textContent = all.length;
      const y = all.filter(o=>t.has(o.phone)).length;
      cntYes.textContent = y;
      cntNo.textContent  = all.length - y;
    }

    function clearActive(){
      [tabAll,tabYes,tabNo].forEach(t=>t.classList.remove('active'));
    }

    function render(){
      dataDiv.innerHTML = '';
      let list = loadAll(), t=loadTxt(), notes=loadNotes();

      if(tabYes.classList.contains('active'))    list=list.filter(o=>t.has(o.phone));
      else if(tabNo.classList.contains('active'))list=list.filter(o=>!t.has(o.phone));

      list = list.filter(o=>parseFloat(o.rating)>=parseFloat(ratingFilter.value));

      list.sort((a,b)=>{
        const ra=parseFloat(a.rating), rb=parseFloat(b.rating);
        return sortFilter.value==='asc'? ra-rb: rb-ra;
      });

      list.forEach(o=>{
        const row = document.createElement('div'); row.className='row';
        const left = document.createElement('div'); left.className='left';

        const cb = document.createElement('input'); cb.type='checkbox';
        cb.checked = t.has(o.phone);
        cb.onchange = ()=>{
          const s=loadTxt();
          cb.checked? s.add(o.phone): s.delete(o.phone);
          saveTxt(s);
          updateCounts(); render();
        };
        left.appendChild(cb);

        const info = document.createElement('div'); info.className='info';

        const line1row = document.createElement('div'); line1row.className='line1-row';
        const l1 = document.createElement('div'); l1.className='line1';
        l1.textContent = o.business;
        line1row.appendChild(l1);
        const addNote = document.createElement('span'); addNote.className='add-note';
        addNote.textContent = '| Add Customer Note';
        addNote.onclick = ()=>{
          currentNotePhone = o.phone;
          noteTextTA.value = notes[o.phone]||'';
          popupNote.style.display = 'flex';
        };
        line1row.appendChild(addNote);
        info.appendChild(line1row);

        const l2 = document.createElement('div'); l2.className='line2';
        l2.textContent = `(${o.rating} ☆) | +65 ${o.phone.slice(-8,-4)} ${o.phone.slice(-4)}`;
        info.appendChild(l2);

        if(notes[o.phone]){
          const n = document.createElement('div'); n.className='note';
          n.textContent = '📌 '+notes[o.phone];
          info.appendChild(n);
        }

        left.appendChild(info);
        row.appendChild(left);

        const right = document.createElement('div'); right.className='right';
        const a = document.createElement('a'); a.textContent='Send Custom WhatsApp Message';
        const msg = msgTpl.replace(/%business/g,o.business).replace(/%rating/g,o.rating);
        a.href = `https://api.whatsapp.com/send?phone=${o.phone.replace('+','')}&text=${encodeURIComponent(msg)}`;
        a.target='_blank';
        right.appendChild(a);
        row.appendChild(right);

        dataDiv.appendChild(row);
      });
    }

    // Tabs & filters
    tabAll.onclick = ()=>{ clearActive(); tabAll.classList.add('active'); render(); };
    tabYes.onclick = ()=>{ clearActive(); tabYes.classList.add('active'); render(); };
    tabNo.onclick  = ()=>{ clearActive(); tabNo.classList.add('active'); render(); };
    ratingFilter.onchange = render;
    sortFilter.onchange   = render;

    // Customize popup
    document.getElementById('btn-customize').onclick = ()=>{
      tmplText.value=msgTpl; popupCustom.style.display='flex';
    };
    document.getElementById('btn-cancel').onclick = ()=> popupCustom.style.display='none';
    document.getElementById('btn-save').onclick = ()=>{
      msgTpl=tmplText.value.trim()||msgTpl;
      popupCustom.style.display='none'; render();
    };

    // Import/Export popup
    btnImportExp.onclick = ()=>{
      const d={ all:loadAll(), texted:[...loadTxt()], notes:loadNotes() };
      exportTA.value=JSON.stringify(d,null,2);
      importTA.value=''; importFile.value=null;
      popupIO.style.display='flex';
    };
    document.getElementById('btn-download').onclick = ()=>{
      const blob=new Blob([exportTA.value],{type:'application/json'}),url=URL.createObjectURL(blob),a=document.createElement('a');
      a.href=url; a.download='data.json'; a.click(); URL.revokeObjectURL(url);
    };
    uploadIcon.onclick = ()=> importFile.click();
    importFile.onchange = e=>{
      const f=e.target.files[0]; if(!f)return;
      const r=new FileReader(); r.onload=()=>importTA.value=r.result; r.readAsText(f);
    };
    document.getElementById('btn-import').onclick = ()=>{
      const txt=importTA.value.trim();
      try{
        const obj=JSON.parse(txt);
        if(!Array.isArray(obj.all)||!Array.isArray(obj.texted)||typeof obj.notes!=='object') throw '';
        saveAll(obj.all); saveTxt(new Set(obj.texted)); saveNotes(obj.notes);
        popupIO.style.display='none'; updateCounts(); render(); alert('Import successful');
      }catch{ alert('Invalid JSON'); }
    };
    document.getElementById('btn-close-io').onclick = ()=> popupIO.style.display='none';

    // Note popup
    document.getElementById('note-save').onclick = ()=>{
      const notes=loadNotes(),txt=noteTextTA.value.trim();
      if(txt) notes[currentNotePhone]=txt; else delete notes[currentNotePhone];
      saveNotes(notes); popupNote.style.display='none'; render();
    };
    document.getElementById('note-delete').onclick = ()=>{
      const notes=loadNotes(); delete notes[currentNotePhone];
      saveNotes(notes); popupNote.style.display='none'; render();
    };
    document.getElementById('note-cancel').onclick = ()=> popupNote.style.display='none';

    // Extract
    document.getElementById('btn-extract').onclick = async ()=>{
      const lines=rawInput.value.split('\n'), entries=[]; 
      for(let i=0;i<lines.length;i++){
        const m=lines[i].match(/(\d{4})\s*(\d{4})/);
        if(m){
          const num=m[1]+m[2]; if(num[0]==='6') continue;
          const phone='+65'+num;
          let rating='',ridx=-1;
          for(let j=i-1;j>=0;j--){
            const rm=lines[j].match(/([\d.]+)\(\d+\)/);
            if(rm){ rating=rm[1]; ridx=j; break; }
          }
          let business='Business';
          for(let k=(ridx>=0?ridx-1:i-1);k>=0;k--){
            const t=lines[k].trim();
            if(t&&!/\d/.test(t)){ business=t; break; }
          }
          entries.push({phone,business,rating:rating||'0.0'});
        }
      }
      let all=loadAll();
      entries.forEach(o=>{ if(!all.find(x=>x.phone===o.phone)) all.push(o) });
      saveAll(all);
      rawInput.value=''; progInfo.style.display='block'; progWrap.style.display='block';
      for(let i=1;i<=30;i++){
        const p=Math.round(i/30*100), s=Math.round(entries.length*(i/30));
        progInfo.textContent=`${p}% Complete | Scanned: ${s}`;
        progBar.style.width=`${p}%`;
        await new Promise(r=>setTimeout(r,100));
      }
      progInfo.textContent=`100% Complete | Scanned: ${entries.length}`;
      await new Promise(r=>setTimeout(r,300));
      progWrap.style.display='none';
      updateCounts(); render();
    };

    // Initialize
    updateCounts(); render();
  </script>
</body>
</html>
