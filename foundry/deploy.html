<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reputifly | Deployment Engine</title>

    <link rel="icon" type="image/png"
        href="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug">
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // Force Tailwind to use Inter natively
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        };
    </script>

    <style>
        :root {
            --bg-deep: #05050A;
            --accent-primary: #E6397F;
            --accent-secondary: #FF8A00;
        }

        body {
            background-color: #05050A;
            background-image: radial-gradient(circle at 50% 0%, #160D1E 0%, #05050A 70%);
            background-attachment: fixed;
            font-family: 'Inter', sans-serif;
            color: #F0F0F0;
            -webkit-font-smoothing: antialiased;
        }

        h1,
        h2,
        h3,
        h4 {
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -0.02em;
        }

        ::selection {
            background: var(--accent-primary);
            color: white;
        }

        /* Premium Liquid Glass */
        .glass-panel {
            background: rgba(15, 15, 20, 0.6);
            backdrop-filter: blur(32px);
            -webkit-backdrop-filter: blur(32px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.8), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.12);
        }

        /* LIQUID BUTTONS */
        .btn-liquid-glow {
            background: radial-gradient(circle at top, rgba(255, 255, 255, 0.4) 0%, transparent 60%),
                linear-gradient(90deg, #E6397F, #FF8A00);
            box-shadow:
                0 10px 30px -10px rgba(230, 57, 127, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -2px 0 rgba(0, 0, 0, 0.2);
            border: none;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 9999px;
            color: white;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn-liquid-glow:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.01);
            box-shadow:
                0 20px 40px -10px rgba(255, 138, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .btn-liquid-glow:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(50%);
            transform: none;
            box-shadow: none;
        }

        .btn-hero-glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 9999px;
            color: #D1D5DB;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn-hero-glass:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            color: white;
            box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.5);
        }

        .btn-hero-glass:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Modern Sidebar */
        #sidebar {
            background: rgba(10, 10, 15, 0.6);
            backdrop-filter: blur(40px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sidebar-tab {
            transition: all 0.2s ease-out;
            border: 1px solid transparent;
            color: #9CA3AF;
        }

        .sidebar-tab:hover {
            background: rgba(255, 255, 255, 0.03);
            color: #E5E7EB;
        }

        .sidebar-tab.active {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0) 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-left: 3px solid #E6397F;
            /* Accent line */
            color: white;
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.3);
        }

        /* Fix Mobile Toggle Ugly Wrap */
        .toggle-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            width: 100%;
        }

        @media (min-width: 640px) {
            .toggle-grid {
                display: flex;
                width: auto;
            }
        }

        /* Inputs */
        .input-dark {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #F0F0F0;
            transition: all 0.3s ease;
        }

        .input-dark:focus {
            border-color: var(--accent-primary);
            background: rgba(0, 0, 0, 0.6);
            outline: none;
            box-shadow: 0 0 0 4px rgba(230, 57, 127, 0.15);
        }

        /* Select Styling */
        select.input-dark option {
            background: #0B0A14;
            color: white;
        }

        /* Tabs & Animations */
        .tab-content {
            display: none;
            opacity: 0;
        }

        .tab-content.active {
            display: block;
            animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            transition: background 0.3s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Enterprise Toast Notifications */
        #toastContainer {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 99999;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            pointer-events: none;
        }

        .toast {
            min-width: 320px;
            max-width: 400px;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.25rem;
            padding: 1rem 1.25rem;
            color: white;
            display: flex;
            align-items: flex-start;
            gap: 0.85rem;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: auto;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.error {
            border-left: 4px solid #EF4444;
        }

        .toast.success {
            border-left: 4px solid #10B981;
        }

        .toast.info {
            border-left: 4px solid #3B82F6;
        }

        /* Code editor shell fixes */
        .code-editor-shell {
            overflow: hidden;
            isolation: isolate;
            border-radius: 2.5rem;
        }

        /* Avoid double background/sharp corner artifact in editor */
        .code-editor-header {
            border-top-left-radius: inherit !important;
            border-top-right-radius: inherit !important;
            background: rgba(0, 0, 0, 0.5);
        }

        .code-editor-textarea {
            border: none !important;
            border-radius: 0 !important;
            background-clip: padding-box;
            display: block;
        }

        /* Repository list mobile polish */
        .repo-actions-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .repo-actions-scroll::-webkit-scrollbar {
            display: none;
        }

        .repo-mobile-only {
            display: none !important;
        }

        .repo-desktop-only {
            display: inline-flex;
        }

        .repo-actions-modal-item {
            transition: border-color .2s ease, background-color .2s ease, transform .2s ease;
        }

        .repo-actions-modal-item:hover {
            border-color: rgba(255, 255, 255, 0.16);
            background: rgba(255, 255, 255, 0.04);
            transform: translateY(-1px);
        }

        .repo-table-scroll {
            overflow-x: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .repo-table-scroll::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .repo-table-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.16);
            border-radius: 999px;
        }

        .repo-table-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 999px;
        }

        .repo-mobile-base-actions .repo-actions-scroll>*,
        .repo-version-actions>* {
            flex: 0 0 auto;
        }

        @media (max-width: 1024px) {

            .repo-version-actions a[href*="github.dev"],
            .repo-mobile-base-actions a[href*="github.dev"],
            .repo-desktop-base-actions a[href*="github.dev"] {
                display: none !important;
            }
        }

        @media (max-width: 640px) {

            html,
            body {
                overflow-x: hidden !important;
            }

            main {
                padding: 0.65rem !important;
                overflow-x: hidden !important;
            }

            /* Remove outer tab containers on mobile to reclaim screen space */
            .tab-content.glass-panel {
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                padding: 1.05rem 0 0.5rem !important;
                overflow: visible !important;
            }

            #deployTab>.absolute,
            #revisionTab>.absolute,
            #manageTab>.absolute,
            #helpTab>.absolute,
            #adminTab>.absolute {
                display: none !important;
            }

            /* Add breathing room for top headings/subtitles across tabs */
            .deploy-topbar,
            .revision-topbar,
            #manageTab .manage-topbar,
            #helpTab .relative.z-10>.flex.flex-col.lg\:flex-row.lg\:items-end.justify-between.gap-6.mb-10,
            #adminTab>.mb-12 {
                margin-top: 0.35rem !important;
            }

            #manageTab {
                padding: 1.05rem 0 0.5rem !important;
                border-radius: 0 !important;
            }

            #manageTab>.absolute {
                opacity: 0.05 !important;
            }

            #manageTab .manage-topbar {
                margin-bottom: 0.9rem !important;
                padding-bottom: 0.9rem !important;
                gap: 0.75rem !important;
            }

            #manageTab .manage-topbar h2 {
                font-size: 2rem !important;
                line-height: 1.95rem !important;
                margin-bottom: 0.35rem !important;
            }

            #manageTab .manage-topbar p {
                font-size: 0.95rem !important;
                line-height: 1.3rem !important;
            }

            #manageTab .manage-topbar #syncBtn {
                width: 100%;
                justify-content: center;
                padding: 0.9rem 1rem !important;
                border-radius: 1rem !important;
            }

            #manageTab .repo-board {
                border-radius: 1rem !important;
            }

            #manageTab .repo-board-header {
                padding: 0.75rem 0.9rem !important;
                font-size: 10px !important;
            }

            #manageTab .repo-table-scroll {
                max-height: calc(100vh - 270px) !important;
                border-top: 1px solid rgba(255, 255, 255, 0.03);
                overflow-x: hidden !important;
                /* no horizontal scroll on mobile */
            }

            /* Mobile-fit rows; actions now use popup so no wide row required */
            #samplesList {
                min-width: 0 !important;
                width: 100% !important;
                padding: 0.35rem !important;
                background: rgba(0, 0, 0, 0.12) !important;
            }

            .repo-card-header {
                padding: 0.75rem !important;
                align-items: center !important;
                gap: 0.6rem !important;
            }

            .repo-card-title {
                font-size: 1rem !important;
                line-height: 1.1rem !important;
                gap: 0.45rem !important;
                flex-wrap: nowrap !important;
            }

            .repo-card-icon {
                width: 2.1rem !important;
                height: 2.1rem !important;
                border-radius: 0.8rem !important;
            }

            .repo-card-meta {
                gap: 0.25rem !important;
            }

            .repo-card-meta .revs-pill {
                font-size: 10px !important;
                padding: 0.22rem 0.45rem !important;
                white-space: nowrap;
            }

            .repo-card-meta>button,
            .repo-card-meta>i {
                flex: 0 0 auto;
            }

            .repo-version-row {
                padding: 0.65rem 0.75rem !important;
                gap: 0.55rem !important;
            }

            .repo-version-left {
                padding-left: 0.55rem !important;
                gap: 0.4rem !important;
            }

            .repo-version-actions {
                width: 100%;
                gap: 0.45rem !important;
                flex-wrap: nowrap !important;
            }

            .repo-version-actions .btn-hero-glass,
            .repo-version-actions .btn-liquid-glow,
            .repo-mobile-base-actions .btn-hero-glass,
            .repo-mobile-base-actions .btn-liquid-glow {
                padding: 0.62rem 0.85rem !important;
                font-size: 12px !important;
                line-height: 1 !important;
                border-radius: 0.85rem !important;
                white-space: nowrap;
                min-height: 2.45rem;
            }

            .repo-version-actions .btn-liquid-glow,
            .repo-mobile-base-actions .btn-liquid-glow {
                min-width: 7.25rem;
                justify-content: center;
            }

            .repo-mobile-base-actions {
                display: flex !important;
                padding: 0 0.75rem 0.65rem !important;
            }

            .repo-mobile-base-actions .repo-actions-scroll {
                width: 100%;
                gap: 0.45rem !important;
                padding-bottom: 0.1rem;
            }

            .repo-desktop-base-actions {
                display: none !important;
            }

            /* Tighten surrounding cards in other tabs too */
            .glass-panel {
                border-radius: 1.35rem !important;
            }

            #deployTab,
            #revisionTab,
            #helpTab,
            #adminTab {
                padding: 0.95rem !important;
                border-radius: 1.35rem !important;
            }

            .deploy-topbar h1 {
                margin-bottom: 0.55rem !important;
                line-height: 1.02 !important;
            }

            .deploy-topbar p {
                line-height: 1.35 !important;
            }

            .revision-topbar {
                margin-bottom: 1.1rem !important;
                padding-bottom: 0.95rem !important;
                gap: 0.85rem !important;
            }

            .revision-topbar h2 {
                margin-bottom: 0.5rem !important;
                line-height: 1.02 !important;
            }

            .revision-topbar p {
                margin-top: 0.15rem !important;
                line-height: 1.35 !important;
            }

            /* Better title/subtitle spacing on mobile */
            .deploy-topbar h1,
            .revision-topbar h2,
            #manageTab .manage-topbar h2,
            #helpTab h2,
            #adminTab h2 {
                margin-bottom: 0.65rem !important;
            }

            .deploy-topbar p,
            .revision-topbar p,
            #manageTab .manage-topbar p,
            #helpTab p.text-sm,
            #helpTab p.text-base,
            #adminTab>.mb-12 p {
                margin-top: 0.12rem !important;
                line-height: 1.4 !important;
            }

            .repo-mobile-only {
                display: inline-flex !important;
            }

            .repo-version-actions-wrap {
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }

            .repo-mobile-actions-trigger {
                align-items: center;
                justify-content: center;
                width: 42px;
                height: 42px;
                border-radius: 14px;
                background: rgba(255, 255, 255, 0.04);
                border: 1px solid rgba(255, 255, 255, 0.10);
                color: #E5E7EB;
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
            }

            .repo-mobile-actions-trigger:hover {
                background: rgba(255, 255, 255, 0.08);
                border-color: rgba(255, 255, 255, 0.16);
                color: #fff;
            }

            .repo-version-actions {
                display: none !important;
            }

            .repo-mobile-base-actions {
                display: none !important;
            }

            .repo-card-meta {
                gap: 0.4rem !important;
            }

            .repo-board .btn-liquid-glow {
                min-height: 42px;
            }

            .code-editor-shell {
                background: rgba(4, 6, 14, 0.96) !important;
                border-radius: 1.1rem !important;
            }

            .code-editor-header {
                padding: 0.85rem 0.95rem !important;
            }

            .code-editor-textarea {
                padding: 0.95rem !important;
            }
        }
    </style>
</head>

<body class="bg-[#05050A] text-[#F0F0F0] font-sans antialiased overflow-hidden flex h-screen">

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-40 hidden xl:hidden"
        onclick="toggleSidebar()"></div>

    <aside id="sidebar"
        class="fixed xl:static inset-y-0 left-0 z-50 w-[280px] flex flex-col transform -translate-x-full xl:translate-x-0 transition-transform duration-300 ease-[cubic-bezier(0.2,0,0,1)]">

        <div class="p-8 pb-4 flex items-center justify-between">
            <img src="https://reputifly.com/wp-content/uploads/2026/02/ChatGPT-Image-Feb-12-2026-07_47_26-PM-e1770896902562.png"
                class="h-6 opacity-90 hover:opacity-100 transition-opacity" alt="Reputifly">
            <button onclick="toggleSidebar()"
                class="xl:hidden p-2 bg-white/5 rounded-full hover:bg-white/10 transition-colors text-white"><i
                    data-feather="x" class="w-4 h-4"></i></button>
        </div>

        <div class="px-6 py-4">
            <div
                class="p-4 rounded-2xl bg-gradient-to-br from-white/5 to-transparent border border-white/5 flex items-center gap-3.5 shadow-lg">
                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-[#FF8A00] to-[#E6397F] p-[1px]">
                    <div class="w-full h-full rounded-full bg-[#0A0A0F] flex items-center justify-center">
                        <i data-feather="shield" class="w-4 h-4 text-[#FF8A00]"></i>
                    </div>
                </div>
                <div class="min-w-0">
                    <p class="text-[9px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">Logged In</p>
                    <p class="text-xs font-bold text-white truncate" id="userBadge">...</p>
                </div>
            </div>
        </div>

        <div class="h-px bg-gradient-to-r from-transparent via-white/10 to-transparent mx-6 mb-4"></div>

        <nav class="flex-1 px-4 space-y-1.5 overflow-y-auto hide-scrollbar">
            <button onclick="switchTab('deploy')" id="nav-deploy"
                class="sidebar-tab active w-full flex items-center gap-3.5 px-5 py-3.5 rounded-xl text-sm font-semibold group">
                <i data-feather="zap" class="w-4 h-4 text-[#E6397F] group-hover:scale-110 transition-transform"></i>
                <span>Deploy Sample</span>
            </button>
            <button onclick="switchTab('revision')" id="nav-revision"
                class="sidebar-tab w-full flex items-center gap-3.5 px-5 py-3.5 rounded-xl text-sm font-semibold group">
                <i data-feather="layers"
                    class="w-4 h-4 group-hover:text-purple-400 group-hover:scale-110 transition-transform"></i>
                <span>Deploy Revision</span>
            </button>
            <button onclick="switchTab('overwrite')" id="nav-overwrite"
                class="sidebar-tab w-full flex items-center gap-3.5 px-5 py-3.5 rounded-xl text-sm font-semibold group">
                <i data-feather="edit-2"
                    class="w-4 h-4 group-hover:text-purple-400 group-hover:scale-110 transition-transform"></i>
                <span>Overwrite Revision</span>
            </button>
            <button onclick="switchTab('manage')" id="nav-manage"
                class="sidebar-tab w-full flex items-center gap-3.5 px-5 py-3.5 rounded-xl text-sm font-semibold group">
                <i data-feather="server"
                    class="w-4 h-4 group-hover:text-blue-400 group-hover:scale-110 transition-transform"></i>
                <span>Staging Repo</span>
            </button>
            <button onclick="switchTab('help')" id="nav-help"
                class="sidebar-tab w-full flex items-center gap-3.5 px-5 py-3.5 rounded-xl text-sm font-semibold group">
                <i data-feather="help-circle"
                    class="w-4 h-4 group-hover:text-amber-400 group-hover:scale-110 transition-transform"></i>
                <span>Help Guide</span>
            </button>
            <button id="navAdminBtn" onclick="switchTab('admin')"
                class="hidden sidebar-tab w-full flex items-center gap-3.5 px-5 py-3.5 rounded-xl text-sm font-semibold group mt-4">
                <i data-feather="lock" class="w-4 h-4 text-[#E6397F] group-hover:scale-110 transition-transform"></i>
                <span>Access Control</span>
            </button>
        </nav>

        <div class="p-6">
            <button id="logoutBtn"
                class="w-full flex items-center justify-center gap-2.5 px-5 py-3.5 rounded-xl text-xs font-bold text-gray-400 hover:text-white bg-white/5 hover:bg-red-500/10 hover:border-red-500/20 border border-transparent transition-all">
                <i data-feather="log-out" class="w-4 h-4"></i> Sign Out
            </button>
        </div>
    </aside>

    <div class="flex-1 h-screen overflow-y-auto overflow-x-hidden relative scroll-smooth bg-[#05050A]">

        <header
            class="xl:hidden sticky top-0 z-30 bg-[#0A0A0F]/80 backdrop-blur-xl border-b border-white/5 px-6 py-4 flex items-center justify-between">
            <img src="https://reputifly.com/wp-content/uploads/2026/02/ChatGPT-Image-Feb-12-2026-07_47_26-PM-e1770896902562.png"
                class="h-6" alt="Reputifly">
            <button onclick="toggleSidebar()"
                class="text-white p-2.5 bg-white/5 hover:bg-white/10 rounded-xl border border-white/10 transition-colors"><i
                    data-feather="menu" class="w-5 h-5"></i></button>
        </header>

        <main class="p-4 sm:p-6 lg:p-8 w-full max-w-[1600px] mx-auto relative pb-24">

            <div id="deployTab" class="tab-content active relative w-full">
                <div
                    class="deploy-topbar flex flex-col md:flex-row justify-between md:items-end mb-6 gap-6 relative z-10 border-b border-white/5 pb-6">
                    <div>
                        <h1 class="text-4xl sm:text-5xl font-bold mb-4 tracking-tight">Deploy Sample</h1>
                        <p class="text-gray-400 text-sm sm:text-base max-w-lg leading-relaxed">Push a brand new AI
                            sample directly to the root global edge network.</p>
                    </div>
                    <div
                        class="bg-black/40 p-1 rounded-2xl border border-white/10 grid grid-cols-2 gap-1 text-[11px] sm:text-sm font-bold backdrop-blur-xl w-full sm:w-auto">
                        <button id="modeZipBtn"
                            class="flex-1 justify-center px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 shadow-lg transition-all flex items-center gap-2 whitespace-nowrap"><i
                                data-feather="package" class="w-3.5 h-3.5"></i> Prompt Pack</button>
                        <button id="modeCodeBtn"
                            class="flex-1 justify-center px-4 py-3 rounded-xl text-gray-500 hover:text-white hover:bg-white/5 border border-transparent transition-all flex items-center gap-2 whitespace-nowrap"><i
                                data-feather="code" class="w-3.5 h-3.5"></i> Code Only</button>
                    </div>
                </div>

                <form id="deployForm" class="grid grid-cols-1 lg:grid-cols-12 gap-8 relative z-10">
                    <div class="lg:col-span-4 flex flex-col gap-6">
                        <div id="manualNameBox" class="hidden glass-card rounded-[2rem] p-6">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Target
                                Client Directory</label>
                            <input type="text" id="manualFolderName" placeholder="e.g. eagle-eye"
                                class="w-full input-dark rounded-xl p-4 font-mono text-sm">
                        </div>

                        <div id="zipUploadBox" class="relative group flex-grow min-h-[250px]">
                            <div onclick="document.getElementById('zipInput').click()"
                                class="cursor-pointer glass-card border-dashed border-2 border-white/10 hover:border-[#E6397F]/50 rounded-[2rem] p-8 text-center transition-all duration-300 h-full flex flex-col items-center justify-center">
                                <input type="file" id="zipInput"
                                    accept=".html,.css,.js,.json,.svg,.png,.jpg,.jpeg,.gif,.webp,.zip,.mp4,.webm,.pdf,.woff,.woff2,.ttf,.otf,.csv,.xml,.txt,.md,.ico"
                                    multiple class="hidden">
                                <input type="file" id="baseFolderInput" webkitdirectory directory multiple
                                    class="hidden">
                                <div id="uploadPrompt" class="flex flex-col items-center">
                                    <div
                                        class="w-20 h-20 rounded-full bg-gradient-to-br from-white/5 to-white/10 border border-white/10 flex items-center justify-center mb-6 group-hover:scale-110 group-hover:shadow-[0_0_40px_rgba(230,57,127,0.3)] transition-all duration-500">
                                        <i data-feather="download-cloud" class="w-8 h-8 text-[#E6397F]"></i>
                                    </div>
                                    <p class="font-bold text-xl text-white mb-2">Drop Files, Folder or .ZIP Pack</p>
                                    <p class="text-xs text-gray-400 px-4 mb-6">Auto-extracts client directory and assets
                                    </p>
                                    <div class="flex gap-4">
                                        <button type="button"
                                            onclick="event.stopPropagation(); document.getElementById('zipInput').click()"
                                            class="btn-hero-glass py-2 px-4 text-xs z-10 relative border-[#E6397F]/30 hover:border-[#E6397F]"><i
                                                data-feather="file-plus" class="w-3.5 h-3.5 text-[#E6397F]"></i> Browse
                                            Files / ZIP</button>
                                        <button type="button"
                                            onclick="event.stopPropagation(); document.getElementById('baseFolderInput').click()"
                                            class="btn-hero-glass py-2 px-4 text-xs z-10 relative border-blue-500/30 hover:border-blue-500"><i
                                                data-feather="folder" class="w-3.5 h-3.5 text-blue-400"></i> Browse
                                            Folder</button>
                                    </div>
                                </div>
                                <div id="zipStatus"
                                    class="hidden w-full bg-black/50 border border-white/5 rounded-2xl p-6 flex flex-col items-center gap-4">
                                    <div class="text-center w-full">
                                        <p class="text-gray-500 text-[10px] uppercase tracking-widest font-bold mb-2">
                                            Extracted Target</p>
                                        <p id="clientNameDisplay"
                                            class="font-mono text-base font-bold text-white bg-white/5 py-2 px-4 rounded-xl border border-white/10 inline-block">
                                        </p>
                                    </div>
                                    <div id="logoStatusDisplay" class="w-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-8 flex flex-col gap-6">
                        <div
                            class="glass-card code-editor-shell rounded-[2.5rem] overflow-hidden flex flex-col flex-grow min-h-[400px] shadow-2xl">
                            <div
                                class="code-editor-header flex justify-between items-center px-8 py-5 bg-black/40 border-b border-white/5 backdrop-blur-md">
                                <div class="flex items-center gap-3 text-sm font-bold text-gray-300">
                                    <i data-feather="code" class="w-5 h-5 text-[#FF8A00]"></i> index.html
                                </div>
                                <button type="button" id="previewBtn"
                                    class="text-xs font-bold text-white flex items-center gap-2 hover:bg-white/20 transition-colors bg-white/10 border border-white/10 px-4 py-2 rounded-full"><i
                                        data-feather="monitor" class="w-3 h-3 text-[#FF8A00]"></i> Preview</button>
                            </div>
                            <textarea id="htmlContent" placeholder=""
                                class="code-editor-textarea w-full h-full min-h-[350px] bg-transparent text-gray-300 p-8 font-mono text-[13px] leading-relaxed focus:outline-none focus:bg-white/[0.02] transition-colors resize-none rounded-none"></textarea>
                        </div>
                        <button type="submit" id="submitBtn" class="btn-liquid-glow w-full py-6 text-xl">
                            <i data-feather="zap" class="w-6 h-6"></i> <span id="btnText">Deploy Base Build</span>
                        </button>
                    </div>
                </form>

                <div id="resultBox"
                    class="hidden mt-8 p-16 rounded-[3rem] bg-gradient-to-b from-green-500/10 to-transparent border border-green-500/20 text-center backdrop-blur-xl relative z-20">
                    <div
                        class="w-24 h-24 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-8 border border-green-500/30 shadow-[0_0_60px_rgba(34,197,94,0.4)]">
                        <i data-feather="check" class="w-12 h-12 text-green-400"></i>
                    </div>
                    <h2 class="text-white font-bold text-4xl mb-4">Sample Live</h2>
                    <div class="flex flex-col sm:flex-row justify-center gap-6 mt-10">
                        <a id="liveLink" href="#" target="_blank"
                            class="btn-hero-glass px-8 py-5 text-lg hover:text-[#FF8A00] transition-colors">View Live
                            Link <i data-feather="external-link" class="w-5 h-5"></i></a>
                        <button id="copyLinkBtn" class="btn-liquid-glow px-8 py-5 text-lg"><i data-feather="copy"
                                class="w-5 h-5"></i> Copy Link</button>
                    </div>
                    <button onclick="resetDeployer()"
                        class="mt-12 text-sm font-bold text-gray-500 hover:text-white flex items-center justify-center gap-2 mx-auto transition-colors"><i
                            data-feather="rotate-ccw" class="w-4 h-4"></i> Deploy Another</button>
                </div>
            </div>

            <div id="revisionTab" class="tab-content relative w-full">
                <div
                    class="revision-topbar flex flex-col md:flex-row justify-between md:items-start mb-6 gap-6 relative z-10 border-b border-white/5 pb-6">
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-3xl sm:text-4xl font-bold tracking-tight">Deploy Revision</h2>
                            <button type="button" onclick="loadSamples(true)"
                                class="btn-hero-glass px-4 py-2 text-xs sm:text-sm"><i data-feather="refresh-cw"
                                    class="w-3.5 h-3.5 text-purple-400"></i> <span
                                    class="hidden sm:inline">Refresh</span></button>
                        </div>
                        <p class="text-sm text-gray-400 mb-6 max-w-2xl">Select a client and upload or paste multiple
                            files. We will auto-create the next version branch.</p>

                        <div
                            class="bg-black/40 p-1 rounded-2xl border border-white/10 grid grid-cols-2 gap-1 text-[11px] sm:text-sm font-bold backdrop-blur-xl w-full sm:w-auto">
                            <button id="revModeUploadBtn" type="button"
                                class="flex-1 justify-center px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 shadow-lg transition-all flex items-center gap-2 whitespace-nowrap"><i
                                    data-feather="upload-cloud" class="w-3.5 h-3.5"></i> Upload Mode</button>
                            <button id="revModePasteBtn" type="button"
                                class="flex-1 justify-center px-4 py-3 rounded-xl text-gray-500 hover:text-white hover:bg-white/5 border border-transparent transition-all flex items-center gap-2 whitespace-nowrap"><i
                                    data-feather="code" class="w-3.5 h-3.5"></i> Paste Mode</button>
                        </div>
                    </div>
                </div>

                <form id="revForm" class="space-y-8 relative z-10">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

                        <div class="lg:col-span-4 flex flex-col gap-6">
                            <div class="glass-card rounded-[2rem] p-6 flex flex-col h-full max-h-[500px]">
                                <label
                                    class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Select
                                    Target Client</label>

                                <input type="hidden" id="revClientSelect" required>

                                <div id="revClientListContainer"
                                    class="flex-1 overflow-y-auto pr-2 space-y-2 hide-scrollbar">
                                    <div class="text-sm text-gray-500 text-center py-4">Loading clients...</div>
                                </div>

                                <div class="mt-4 pt-4 border-t border-white/10">
                                    <p id="revNextVersionText"
                                        class="text-[11px] font-bold text-purple-400 bg-purple-500/10 px-3 py-2 rounded-lg border border-purple-500/20 text-center uppercase tracking-widest block">
                                        Awaiting selection...</p>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-8 flex flex-col gap-6">

                            <div id="revUploadModeBox" onclick="document.getElementById('revFileInput').click()"
                                class="cursor-pointer glass-card rounded-[2rem] p-8 relative group border-dashed border-2 border-white/10 hover:border-purple-500/50 transition-all flex flex-col items-center justify-center text-center min-h-[300px] flex-1">
                                <input type="file" id="revFileInput"
                                    accept=".html,.css,.js,.json,.svg,.png,.jpg,.jpeg,.gif,.webp,.zip,.mp4,.webm,.pdf,.woff,.woff2,.ttf,.otf,.csv,.xml,.txt,.md,.ico"
                                    multiple class="hidden">
                                <input type="file" id="revFolderInput" webkitdirectory directory multiple
                                    class="hidden">
                                <div
                                    class="w-16 h-16 bg-purple-500/10 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform shadow-[0_0_20px_rgba(168,85,247,0.15)] border border-purple-500/20">
                                    <i data-feather="folder-plus" class="w-8 h-8 text-purple-400"></i>
                                </div>
                                <p class="font-bold text-white text-xl mb-2">Drop Files, Folder or .ZIP Pack</p>
                                <p class="text-xs text-gray-400 mb-6">Drag & drop anywhere here, or select below:</p>

                                <div class="flex gap-4">
                                    <button type="button"
                                        onclick="event.stopPropagation(); document.getElementById('revFileInput').click()"
                                        class="btn-hero-glass py-2 px-4 text-xs z-10 relative border-purple-500/30 hover:border-purple-500"><i
                                            data-feather="file-plus" class="w-3.5 h-3.5 text-purple-400"></i> Browse
                                        Files / ZIP</button>
                                    <button type="button"
                                        onclick="event.stopPropagation(); document.getElementById('revFolderInput').click()"
                                        class="btn-hero-glass py-2 px-4 text-xs z-10 relative border-blue-500/30 hover:border-blue-500"><i
                                            data-feather="folder" class="w-3.5 h-3.5 text-blue-400"></i> Browse
                                        Folder</button>
                                </div>

                                <div id="revFilesList"
                                    class="hidden w-full mt-6 bg-black/50 border border-white/5 rounded-2xl p-4 text-left"
                                    onclick="event.stopPropagation()">
                                </div>
                            </div>

                            <div id="revPasteModeBox" class="hidden flex-col gap-4 flex-1">
                                <div id="revPasteContainer" class="space-y-4">
                                    <div
                                        class="glass-card code-editor-shell rounded-[2rem] overflow-hidden flex flex-col shadow-lg rev-paste-block mb-4">
                                        <div
                                            class="code-editor-header flex justify-between items-center px-6 py-4 bg-black/40 border-b border-white/5 backdrop-blur-md gap-4">
                                            <div class="flex items-center gap-3 w-full max-w-sm">
                                                <i data-feather="file" class="w-4 h-4 text-purple-400 shrink-0"></i>
                                                <input type="text"
                                                    class="rev-paste-filename input-dark w-full rounded-lg px-3 py-1.5 text-sm font-mono text-white bg-black/50 border-white/10 focus:border-purple-500"
                                                    placeholder="e.g. index.html" value="index.html">
                                            </div>
                                            <button type="button"
                                                class="text-gray-500 hover:text-red-400 p-2 rounded-xl hover:bg-red-500/10 border border-transparent hover:border-red-500/20 transition-all hidden rev-paste-remove"
                                                title="Remove File"
                                                onclick="this.closest('.rev-paste-block').remove(); updateRevSubmitState();"><i
                                                    data-feather="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                        <textarea placeholder="Paste HTML/CSS/JS code here..."
                                            class="rev-paste-content code-editor-textarea w-full h-[300px] bg-black/20 text-gray-300 p-6 font-mono text-[13px] leading-relaxed focus:outline-none focus:bg-white/[0.02] transition-colors resize-none rounded-none"></textarea>
                                    </div>
                                </div>

                                <button type="button" id="addPasteBlockBtn"
                                    class="btn-hero-glass py-4 w-full border-dashed border border-white/20 hover:border-purple-500/50 hover:bg-purple-500/5 text-gray-400 hover:text-purple-300">
                                    <i data-feather="plus" class="w-4 h-4"></i> Add Another File
                                </button>
                            </div>

                        </div>
                    </div>

                    <button type="submit" id="revSubmitBtn" disabled
                        class="btn-liquid-glow w-full py-6 text-xl shadow-[0_10px_40px_-10px_rgba(168,85,247,0.5)] bg-gradient-to-r from-purple-600 to-blue-600 before:hidden hover:from-purple-500 hover:to-blue-500">
                        <i data-feather="git-branch" class="w-6 h-6"></i> <span id="revBtnText">Deploy Revision</span>
                    </button>
                </form>

                <div id="revResultBox"
                    class="hidden mt-8 p-12 rounded-[3rem] bg-gradient-to-b from-purple-500/10 to-transparent border border-purple-500/20 backdrop-blur-xl relative z-20">
                    <div class="text-center mb-8">
                        <div
                            class="w-20 h-20 bg-purple-500/20 rounded-full flex items-center justify-center mx-auto mb-6 border border-purple-500/30">
                            <i data-feather="check-circle" class="w-10 h-10 text-purple-400"></i>
                        </div>
                        <h2 class="text-white font-bold text-3xl mb-2">Revision Successfully Deployed</h2>
                        <p class="text-gray-400">Copy the formatted message below to send to your client.</p>
                    </div>

                    <div class="bg-black/50 border border-white/10 rounded-2xl p-6 mb-8 text-left">
                        <div id="revLinksOutput" class="space-y-3 text-sm font-mono text-gray-300">
                        </div>
                    </div>

                    <div class="flex justify-center gap-6">
                        <button id="revCopyBtn"
                            class="btn-liquid-glow px-8 py-4 bg-gradient-to-r from-purple-600 to-blue-600"><i
                                data-feather="copy" class="w-5 h-5"></i> Copy Links for WhatsApp</button>
                        <button onclick="resetRevision()" class="btn-hero-glass px-8 py-4"><i data-feather="rotate-ccw"
                                class="w-4 h-4"></i> Done</button>
                    </div>
                </div>
            </div>

            <div id="overwriteTab" class="tab-content relative w-full">
                <div
                    class="overwrite-topbar flex flex-col md:flex-row justify-between md:items-start mb-6 gap-6 relative z-10 border-b border-white/5 pb-6">
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-3xl sm:text-4xl font-bold tracking-tight">Overwrite Revision</h2>
                            <button type="button" onclick="loadSamples(true)"
                                class="btn-hero-glass px-4 py-2 text-xs sm:text-sm"><i data-feather="refresh-cw"
                                    class="w-3.5 h-3.5 text-purple-400"></i> <span
                                    class="hidden sm:inline">Refresh</span></button>
                        </div>
                        <p class="text-sm text-gray-400 mb-6 max-w-2xl">Select a client and upload or paste multiple
                            files. We will overwrite the selected existing version branch.</p>

                        <div
                            class="bg-black/40 p-1 rounded-2xl border border-white/10 grid grid-cols-2 gap-1 text-[11px] sm:text-sm font-bold backdrop-blur-xl w-full sm:w-auto">
                            <button id="owModeUploadBtn" type="button"
                                class="flex-1 justify-center px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 shadow-lg transition-all flex items-center gap-2 whitespace-nowrap"><i
                                    data-feather="upload-cloud" class="w-3.5 h-3.5"></i> Upload Mode</button>
                            <button id="owModePasteBtn" type="button"
                                class="flex-1 justify-center px-4 py-3 rounded-xl text-gray-500 hover:text-white hover:bg-white/5 border border-transparent transition-all flex items-center gap-2 whitespace-nowrap"><i
                                    data-feather="code" class="w-3.5 h-3.5"></i> Paste Mode</button>
                        </div>
                    </div>
                </div>

                <form id="owForm" class="space-y-8 relative z-10">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

                        <div class="lg:col-span-4 flex flex-col gap-6">
                            <div class="glass-card rounded-[2rem] p-6 flex flex-col h-full max-h-[500px]">
                                <label
                                    class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Select
                                    Target Client</label>

                                <input type="hidden" id="owClientSelect" required>

                                <div id="owClientListContainer"
                                    class="flex-1 overflow-y-auto pr-2 space-y-2 hide-scrollbar">
                                    <div class="text-sm text-gray-500 text-center py-4">Loading clients...</div>
                                </div>

                                <div class="mt-4 pt-4 border-t border-white/10">
                                    <select id="owVersionSelect"
                                        class="w-full input-dark rounded-xl p-3 text-sm font-bold cursor-pointer border border-purple-500/30 bg-purple-500/5 focus:border-purple-500 text-purple-400">
                                        <option value="">-- Select Version --</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-8 flex flex-col gap-6">

                            <div id="owUploadModeBox" onclick="document.getElementById('owFileInput').click()"
                                class="cursor-pointer glass-card rounded-[2rem] p-8 relative group border-dashed border-2 border-white/10 hover:border-purple-500/50 transition-all flex flex-col items-center justify-center text-center min-h-[300px] flex-1">
                                <input type="file" id="owFileInput"
                                    accept=".html,.css,.js,.json,.svg,.png,.jpg,.jpeg,.gif,.webp,.zip,.mp4,.webm,.pdf,.woff,.woff2,.ttf,.otf,.csv,.xml,.txt,.md,.ico"
                                    multiple class="hidden">
                                <input type="file" id="owFolderInput" webkitdirectory directory multiple class="hidden">
                                <div
                                    class="w-16 h-16 bg-purple-500/10 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform shadow-[0_0_20px_rgba(168,85,247,0.15)] border border-purple-500/20">
                                    <i data-feather="folder-plus" class="w-8 h-8 text-purple-400"></i>
                                </div>
                                <p class="font-bold text-white text-xl mb-2">Drop Files, Folder or .ZIP Pack</p>
                                <p class="text-xs text-gray-400 mb-6">Drag & drop anywhere here, or select below:</p>

                                <div class="flex gap-4">
                                    <button type="button"
                                        onclick="event.stopPropagation(); document.getElementById('owFileInput').click()"
                                        class="btn-hero-glass py-2 px-4 text-xs z-10 relative border-purple-500/30 hover:border-purple-500"><i
                                            data-feather="file-plus" class="w-3.5 h-3.5 text-purple-400"></i> Browse
                                        Files / ZIP</button>
                                    <button type="button"
                                        onclick="event.stopPropagation(); document.getElementById('owFolderInput').click()"
                                        class="btn-hero-glass py-2 px-4 text-xs z-10 relative border-blue-500/30 hover:border-blue-500"><i
                                            data-feather="folder" class="w-3.5 h-3.5 text-blue-400"></i> Browse
                                        Folder</button>
                                </div>

                                <div id="owFilesList"
                                    class="hidden w-full mt-6 bg-black/50 border border-white/5 rounded-2xl p-4 text-left"
                                    onclick="event.stopPropagation()">
                                </div>
                            </div>

                            <div id="owPasteModeBox" class="hidden flex-col gap-4 flex-1">
                                <div id="owPasteContainer" class="space-y-4">
                                    <div
                                        class="glass-card code-editor-shell rounded-[2rem] overflow-hidden flex flex-col shadow-lg ow-paste-block mb-4">
                                        <div
                                            class="code-editor-header flex justify-between items-center px-6 py-4 bg-black/40 border-b border-white/5 backdrop-blur-md gap-4">
                                            <div class="flex items-center gap-3 w-full max-w-sm">
                                                <i data-feather="file" class="w-4 h-4 text-purple-400 shrink-0"></i>
                                                <input type="text"
                                                    class="ow-paste-filename input-dark w-full rounded-lg px-3 py-1.5 text-sm font-mono text-white bg-black/50 border-white/10 focus:border-purple-500"
                                                    placeholder="e.g. index.html" value="index.html">
                                            </div>
                                            <button type="button"
                                                class="text-gray-500 hover:text-red-400 p-2 rounded-xl hover:bg-red-500/10 border border-transparent hover:border-red-500/20 transition-all hidden ow-paste-remove"
                                                title="Remove File"
                                                onclick="this.closest('.ow-paste-block').remove(); updateOwSubmitState();"><i
                                                    data-feather="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                        <textarea placeholder="Paste HTML/CSS/JS code here..."
                                            class="ow-paste-content code-editor-textarea w-full h-[300px] bg-black/20 text-gray-300 p-6 font-mono text-[13px] leading-relaxed focus:outline-none focus:bg-white/[0.02] transition-colors resize-none rounded-none"></textarea>
                                    </div>
                                </div>

                                <button type="button" id="owAddPasteBlockBtn"
                                    class="btn-hero-glass py-4 w-full border-dashed border border-white/20 hover:border-purple-500/50 hover:bg-purple-500/5 text-gray-400 hover:text-purple-300">
                                    <i data-feather="plus" class="w-4 h-4"></i> Add Another File
                                </button>
                            </div>

                        </div>
                    </div>

                    <button type="submit" id="owSubmitBtn" disabled
                        class="btn-liquid-glow w-full py-6 text-xl shadow-[0_10px_40px_-10px_rgba(168,85,247,0.5)] bg-gradient-to-r from-purple-600 to-blue-600 before:hidden hover:from-purple-500 hover:to-blue-500">
                        <i data-feather="git-branch" class="w-6 h-6"></i> <span id="owBtnText">Overwrite Revision</span>
                    </button>
                </form>

                <div id="owResultBox"
                    class="hidden mt-8 p-12 rounded-[3rem] bg-gradient-to-b from-purple-500/10 to-transparent border border-purple-500/20 backdrop-blur-xl relative z-20">
                    <div class="text-center mb-8">
                        <div
                            class="w-20 h-20 bg-purple-500/20 rounded-full flex items-center justify-center mx-auto mb-6 border border-purple-500/30">
                            <i data-feather="check-circle" class="w-10 h-10 text-purple-400"></i>
                        </div>
                        <h2 class="text-white font-bold text-3xl mb-2">Revision Successfully Overwritten</h2>
                        <p class="text-gray-400">Copy the formatted message below to send to your client.</p>
                    </div>

                    <div class="bg-black/50 border border-white/10 rounded-2xl p-6 mb-8 text-left">
                        <div id="owLinksOutput" class="space-y-3 text-sm font-mono text-gray-300">
                        </div>
                    </div>

                    <div class="flex justify-center gap-6">
                        <button id="owCopyBtn"
                            class="btn-liquid-glow px-8 py-4 bg-gradient-to-r from-purple-600 to-blue-600"><i
                                data-feather="copy" class="w-5 h-5"></i> Copy Links for WhatsApp</button>
                        <button onclick="resetOverwrite()" class="btn-hero-glass px-8 py-4"><i data-feather="rotate-ccw"
                                class="w-4 h-4"></i> Done</button>
                    </div>
                </div>
            </div>



            <div id="manageTab" class="tab-content relative w-full">
                <div
                    class="manage-topbar flex flex-col sm:flex-row justify-between sm:items-end mb-6 gap-4 border-b border-white/5 pb-6 relative z-10">
                    <div>
                        <h2 class="text-4xl font-bold mb-3 tracking-tight">Staging Repository</h2>
                        <p class="text-base text-gray-400">Manage live client directories and branch revisions.</p>
                    </div>
                    <button onclick="loadSamples()" id="syncBtn" class="btn-hero-glass px-6 py-3"><i
                            data-feather="refresh-cw" class="w-4 h-4 text-blue-400"></i> Sync Network</button>
                </div>

                <div
                    class="repo-board glass-card rounded-[24px] sm:rounded-[32px] overflow-hidden shadow-2xl relative z-10">
                    <div
                        class="repo-board-header bg-black/60 px-4 sm:px-8 py-4 sm:py-5 border-b border-white/5 flex text-[10px] sm:text-[11px] font-bold text-gray-500 uppercase tracking-widest">
                        <div class="w-full">Client Directories & Versions</div>
                    </div>
                    <div
                        class="repo-table-scroll max-h-[68vh] sm:max-h-[70vh] overflow-y-auto overflow-x-auto pr-0 sm:pr-1 hide-scrollbar">
                        <div id="samplesList"
                            class="repo-list-inner flex flex-col bg-black/20 p-2 sm:p-3 min-w-[760px] sm:min-w-0">
                        </div>
                    </div>
                </div>
            </div>


            <div id="helpTab" class="tab-content relative w-full">
                <div class="relative z-10">
                    <div
                        class="flex flex-col lg:flex-row lg:items-end justify-between gap-6 mb-6 border-b border-white/5 pb-6">
                        <div>
                            <h2 class="text-3xl sm:text-4xl font-bold mb-3 tracking-tight flex items-center gap-3">
                                <i data-feather="book-open" class="w-7 h-7 text-amber-400"></i>
                                Standard Operating Procedure
                            </h2>
                            <p class="text-sm sm:text-base text-gray-400 max-w-2xl">
                                Strict workflow rules for pushing initial samples and executing client revisions via
                                Cursor AI.
                            </p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" onclick="switchTab('deploy')"
                                class="btn-hero-glass px-4 py-2.5 text-xs sm:text-sm">
                                <i data-feather="zap" class="w-4 h-4 text-pink-400"></i> New Sample
                            </button>
                            <button type="button" onclick="switchTab('revision')"
                                class="btn-hero-glass px-4 py-2.5 text-xs sm:text-sm">
                                <i data-feather="layers" class="w-4 h-4 text-purple-400"></i> Push Revision
                            </button>
                            <button type="button" onclick="switchTab('overwrite')"
                                class="btn-hero-glass px-4 py-2.5 text-xs sm:text-sm">
                                <i data-feather="edit-2" class="w-4 h-4 text-purple-400"></i> Overwrite
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-5 sm:gap-6">
                        <div class="glass-card rounded-[24px] p-5 sm:p-6 border-t border-pink-500/30">
                            <div
                                class="w-12 h-12 rounded-2xl bg-pink-500/10 border border-pink-500/20 flex items-center justify-center mb-4">
                                <i data-feather="zap" class="w-5 h-5 text-pink-400"></i>
                            </div>
                            <h3 class="font-bold text-xl mb-3">1. Initial Base Sample</h3>
                            <p class="text-xs text-gray-400 mb-4 uppercase tracking-widest font-bold">First Pitch /
                                Mockup</p>
                            <ol class="space-y-3 text-sm text-gray-300 leading-relaxed list-decimal pl-5">
                                <li>Base samples are usually <b class="text-white">Home Pages only</b> (index.html).
                                </li>
                                <li>Go to <b class="text-white">Deploy Sample</b>.</li>
                                <li>Use <b class="text-white">Code Only</b> or just <b class="text-white">Drop your
                                        Project Folder/ZIP</b>. No need to manually zip anymore!</li>
                                <li>Hit <b class="text-white">Deploy Base Build</b> to push directly to the network.
                                </li>
                            </ol>
                        </div>

                        <div class="glass-card rounded-[24px] p-5 sm:p-6 border-t border-purple-500/30">
                            <div
                                class="w-12 h-12 rounded-2xl bg-purple-500/10 border border-purple-500/20 flex items-center justify-center mb-4">
                                <i data-feather="layers" class="w-5 h-5 text-purple-400"></i>
                            </div>
                            <h3 class="font-bold text-xl mb-3">2. Deploy Revision</h3>
                            <p class="text-xs text-gray-400 mb-4 uppercase tracking-widest font-bold">Create New Branch
                            </p>
                            <ol class="space-y-3 text-sm text-gray-300 leading-relaxed list-decimal pl-5">
                                <li>Use this when a client requests changes and you want to <b class="text-white">keep
                                        the history</b> (creates v1, v2, v3).</li>
                                <li>Go to <b class="text-white">Deploy Revision</b> and select the target client.</li>
                                <li>Drop your <b class="text-white">entire updated folder or multiple files.</b></li>
                                <li>The system will <b class="text-white">auto-generate the next version branch.</b>
                                </li>
                            </ol>
                        </div>

                        <div class="glass-card rounded-[24px] p-5 sm:p-6 border-t border-purple-500/30">
                            <div
                                class="w-12 h-12 rounded-2xl bg-purple-500/10 border border-purple-500/20 flex items-center justify-center mb-4">
                                <i data-feather="edit-2" class="w-5 h-5 text-purple-400"></i>
                            </div>
                            <h3 class="font-bold text-xl mb-3">3. Overwrite Revision</h3>
                            <p class="text-xs text-gray-400 mb-4 uppercase tracking-widest font-bold">Fixes & Overrides
                            </p>
                            <ol class="space-y-3 text-sm text-gray-300 leading-relaxed list-decimal pl-5">
                                <li>Use this when you made a small mistake or typo and want to <b
                                        class="text-white">replace an existing version</b> without creating a new
                                    branch.</li>
                                <li>Go to <b class="text-white">Overwrite Revision</b>.</li>
                                <li>Select the Client AND the <b class="text-purple-400">specific Version</b> you wish
                                    to replace.</li>
                                <li>Upload the fixed files to override it instantly.</li>
                            </ol>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5 sm:gap-6 mt-6">
                        <div class="glass-card rounded-[24px] p-5 sm:p-6 bg-red-500/5 border-red-500/10">
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-red-400"><i
                                    data-feather="alert-triangle" class="w-5 h-5"></i> Critical Rules & Tracking</h3>
                            <ul class="space-y-3 text-sm text-gray-300 leading-relaxed">
                                <li> <b class="text-red-300">Admin Tracking Enabled:</b> All logins, deployments,
                                    deletions, client creations, and branch duplication actions are logged and directly
                                    forwarded to the Super Admin via Telegram in real-time.</li>
                                <li> <b class="text-white">Use Relative Links:</b> When linking pages (e.g. Home to
                                    About), use <code
                                        class="bg-black/50 border border-white/10 px-1.5 py-0.5 rounded text-red-300">href="about.html"</code>.
                                    Do <b>NOT</b> use absolute paths like <code
                                        class="bg-black/50 border border-white/10 px-1.5 py-0.5 rounded text-red-300">href="/about.html"</code>.
                                </li>
                                <li> <b class="text-white">Test Locally First:</b> Use Cursor's Live Server to QA your
                                    work before packaging the folder for upload.</li>
                            </ul>
                        </div>

                        <div class="glass-card rounded-[24px] p-5 sm:p-6">
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i data-feather="link-2"
                                    class="w-5 h-5 text-amber-400"></i> System Links</h3>
                            <div class="space-y-3 text-sm">
                                <a id="vsCodeHelpLink" href="https://github.dev/aakiraakira/reputifly-samples"
                                    target="_blank"
                                    class="hidden items-center justify-between gap-3 px-4 py-3.5 rounded-2xl bg-black/40 border border-white/5 hover:border-white/15 hover:bg-white/5 transition-colors">
                                    <span class="text-gray-200 font-bold">Admin: GitHub VS Code</span><i
                                        data-feather="external-link" class="w-4 h-4 text-gray-400"></i>
                                </a>
                                <button type="button" onclick="switchTab('manage')"
                                    class="w-full text-left flex items-center justify-between gap-3 px-4 py-3.5 rounded-2xl bg-black/40 border border-white/5 hover:border-white/15 hover:bg-white/5 transition-colors">
                                    <span class="text-gray-200 font-bold">Go to Staging Repository</span><i
                                        data-feather="chevrons-right" class="w-4 h-4 text-gray-400"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="adminTab" class="tab-content relative w-full">
                <div class="mb-6 relative z-10">
                    <h2 class="text-4xl font-bold mb-3 tracking-tight">Security & Access</h2>
                    <p class="text-base text-gray-400">Provision roles and manage authorization for the infrastructure.
                    </p>
                </div>

                <div class="flex gap-6 mb-8 border-b border-white/10 pb-4">
                    <button id="adminTabStaffBtn" onclick="switchAdminTab('staff')"
                        class="text-white font-bold border-b-2 border-pink-500 pb-2 px-2 transition-all">Staff
                        Management</button>
                    <button id="adminTabClientBtn" onclick="switchAdminTab('client')"
                        class="text-gray-500 font-bold hover:text-gray-300 border-b-2 border-transparent pb-2 px-2 transition-all">Client
                        Portals</button>
                </div>

                <div id="adminStaffSection" class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                    <div class="flex flex-col gap-8">
                        <div class="glass-card p-10 rounded-[32px]">
                            <div
                                class="w-16 h-16 bg-pink-500/10 rounded-full flex items-center justify-center mb-8 border border-pink-500/20 shadow-[0_0_30px_rgba(236,72,153,0.15)]">
                                <i data-feather="user-plus" class="w-7 h-7 text-pink-400"></i>
                            </div>
                            <h3 class="font-bold text-2xl mb-8">Provision Account</h3>
                            <form id="createUserForm" class="space-y-6">
                                <div>
                                    <label
                                        class="block text-[11px] font-bold text-gray-500 mb-2 uppercase tracking-widest">Work
                                        Email</label>
                                    <input type="email" id="newEmail" required
                                        class="w-full input-dark rounded-2xl p-4 text-sm">
                                </div>
                                <div>
                                    <label
                                        class="block text-[11px] font-bold text-gray-500 mb-2 uppercase tracking-widest">Temporary
                                        Password</label>
                                    <input type="password" id="newPassword" required
                                        class="w-full input-dark rounded-2xl p-4 text-sm">
                                </div>
                                <label class="flex items-center gap-3 mt-4 cursor-pointer">
                                    <input type="checkbox" id="notifyStaffEmail" checked
                                        class="w-5 h-5 rounded border-gray-600 bg-black/50 cursor-pointer text-pink-500 focus:ring-pink-500">
                                    <span class="text-sm text-gray-400 font-bold">Email Credentials to Employee</span>
                                </label>
                                <button type="submit"
                                    class="w-full btn-hero-glass justify-center py-5 text-sm mt-4 text-white border-white/20"><i
                                        data-feather="shield" class="w-4 h-4 text-green-400"></i> Authorize
                                    Access</button>
                            </form>
                        </div>
                    </div>

                    <div class="flex flex-col gap-8">
                        <div class="glass-card p-10 rounded-[32px] flex flex-col flex-1 min-h-[350px]">
                            <div class="flex justify-between items-center mb-8">
                                <div class="flex items-center gap-4">
                                    <div
                                        class="w-16 h-16 bg-blue-500/10 rounded-full flex items-center justify-center border border-blue-500/20 shadow-[0_0_30px_rgba(59,130,246,0.15)]">
                                        <i data-feather="users" class="w-7 h-7 text-blue-400"></i>
                                    </div>
                                    <h3 class="font-bold text-2xl">Active Staff</h3>
                                </div>
                                <button onclick="loadUsers()" class="p-3 btn-hero-glass rounded-full"><i
                                        data-feather="refresh-cw" class="w-5 h-5 text-gray-400"></i></button>
                            </div>
                            <div id="staffList" class="flex-1 space-y-3 overflow-y-auto pr-2 hide-scrollbar"></div>
                        </div>
                    </div>
                </div>

                <div id="adminClientSection" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-10">
                    <div class="flex flex-col gap-8">
                        <div class="glass-card p-10 rounded-[32px]">
                            <div
                                class="w-16 h-16 bg-amber-500/10 rounded-full flex items-center justify-center mb-8 border border-amber-500/20 shadow-[0_0_30px_rgba(245,158,11,0.15)]">
                                <i data-feather="monitor" class="w-7 h-7 text-amber-400"></i>
                            </div>
                            <h3 class="font-bold text-2xl mb-8">Create Client Account</h3>
                            <form id="createClientForm" class="space-y-6">
                                <div>
                                    <label
                                        class="block text-[11px] font-bold text-gray-500 mb-2 uppercase tracking-widest">Client
                                        Email</label>
                                    <input type="email" id="portalClientEmail" placeholder="client@company.com" required
                                        class="w-full input-dark rounded-2xl p-4 text-sm">
                                </div>
                                <div>
                                    <label
                                        class="block text-[11px] font-bold text-gray-500 mb-2 uppercase tracking-widest flex items-center gap-2">Set
                                        Password <span class="text-red-500 text-lg leading-none">*</span></label>
                                    <input type="text" id="portalClientPassword" required
                                        placeholder="Required for client login"
                                        class="w-full input-dark rounded-2xl p-4 text-sm">
                                </div>
                                <div>
                                    <label
                                        class="block text-[11px] font-bold text-gray-500 mb-2 uppercase tracking-widest">Assign
                                        Project</label>
                                    <select id="portalClientSelect" required
                                        class="w-full input-dark rounded-2xl p-4 text-sm font-bold cursor-pointer">
                                        <option value="">Loading projects...</option>
                                    </select>
                                </div>
                                <label class="flex items-center gap-3 mt-4 cursor-pointer">
                                    <input type="checkbox" id="notifyClientEmail" checked
                                        class="w-5 h-5 rounded border-gray-600 bg-black/50 cursor-pointer text-amber-500 focus:ring-amber-500">
                                    <span class="text-sm text-gray-400 font-bold">Email Credentials to Client</span>
                                </label>
                                <button type="submit"
                                    class="w-full btn-hero-glass justify-center py-5 text-sm mt-4 text-white border-white/20"><i
                                        data-feather="user-plus" class="w-4 h-4 text-amber-400"></i> Create
                                    Account</button>
                            </form>
                        </div>
                    </div>

                    <div class="flex flex-col gap-8">
                        <div class="glass-card p-10 rounded-[32px] flex flex-col flex-1 min-h-[350px]">
                            <div class="flex justify-between items-center mb-8">
                                <div class="flex items-center gap-4">
                                    <div
                                        class="w-16 h-16 bg-amber-500/10 rounded-full flex items-center justify-center border border-amber-500/20 shadow-[0_0_30px_rgba(245,158,11,0.15)]">
                                        <i data-feather="users" class="w-7 h-7 text-amber-400"></i>
                                    </div>
                                    <h3 class="font-bold text-2xl">Active Clients</h3>
                                </div>
                                <button onclick="loadUsers()" class="p-3 btn-hero-glass rounded-full"><i
                                        data-feather="refresh-cw" class="w-5 h-5 text-gray-400"></i></button>
                            </div>
                            <div id="clientsList" class="flex-1 space-y-3 overflow-y-auto pr-2 hide-scrollbar"></div>
                        </div>
                    </div>
                </div>

                <div id="accessModal"
                    class="fixed inset-0 z-[100] flex items-center justify-center hidden bg-black/80 backdrop-blur-sm transition-opacity">
                    <div
                        class="glass-panel rounded-[2.5rem] p-8 max-w-2xl w-full mx-4 border border-blue-500/30 shadow-[0_0_50px_rgba(59,130,246,0.15)] flex flex-col max-h-[80vh] min-h-0">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-2xl font-bold text-white mb-1">Manage Permissions</h3>
                                <p class="text-gray-400 text-sm font-mono" id="accessModalUser">user@example.com</p>
                            </div>
                            <button onclick="closeAccessModal()"
                                class="p-2 bg-white/5 hover:bg-white/10 rounded-xl transition-colors"><i
                                    data-feather="x" class="w-5 h-5 text-gray-400"></i></button>
                        </div>
                        <div
                            class="overflow-y-auto flex-1 min-h-0 pr-2 bg-black/20 rounded-[1.5rem] p-2 border border-white/5">
                            <div id="clientPermissionsGrid" class="grid grid-cols-1 sm:grid-cols-2 gap-2"></div>
                        </div>
                        <div class="mt-6 pt-6 border-t border-white/10 flex justify-end gap-4">
                            <button onclick="closeAccessModal()" class="btn-hero-glass px-6 py-3">Cancel</button>
                            <button id="savePermissionsBtn" class="btn-liquid-glow px-8 py-3">Save
                                Access</button>
                        </div>
                    </div>
                </div>

                <div id="clientAccessModal"
                    class="fixed inset-0 z-[100] flex items-center justify-center hidden bg-black/80 backdrop-blur-sm transition-opacity">
                    <div
                        class="glass-panel rounded-[2.5rem] p-8 max-w-md w-full mx-4 border border-amber-500/30 shadow-[0_0_50px_rgba(245,158,11,0.15)] flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <div class="min-w-0 pr-4">
                                <h3 class="text-2xl font-bold text-white mb-1">Assign Project</h3>
                                <p class="text-amber-400 text-sm font-mono truncate" id="clientAccessModalUser">
                                    client@example.com</p>
                            </div>
                            <button onclick="closeClientAccessModal()"
                                class="p-2 bg-white/5 hover:bg-white/10 rounded-xl transition-colors shrink-0"><i
                                    data-feather="x" class="w-5 h-5 text-gray-400"></i></button>
                        </div>
                        <div class="mb-6">
                            <label
                                class="block text-[11px] font-bold text-gray-500 mb-2 uppercase tracking-widest">Select
                                Target Client</label>
                            <select id="modalClientSelect"
                                class="w-full input-dark rounded-2xl p-4 text-sm font-bold cursor-pointer">
                                <option value="NONE">-- No Project Set Yet --</option>
                            </select>
                        </div>
                        <div class="pt-6 border-t border-white/10 flex justify-end gap-4">
                            <button onclick="closeClientAccessModal()" class="btn-hero-glass px-6 py-3">Cancel</button>
                            <button id="saveClientAccessBtn" class="btn-liquid-glow px-8 py-3">Save Access</button>
                        </div>
                    </div>
                </div>

                <div id="credentialsModal"
                    class="fixed inset-0 z-[120] flex items-center justify-center hidden bg-black/80 backdrop-blur-sm transition-opacity p-4">
                    <div
                        class="glass-panel rounded-[2rem] p-8 max-w-md w-full border border-white/10 shadow-[0_0_50px_rgba(0,0,0,0.5)]">
                        <div
                            class="w-16 h-16 bg-green-500/10 rounded-full flex items-center justify-center mb-6 mx-auto border border-green-500/20 shadow-[0_0_30px_rgba(34,197,94,0.2)]">
                            <i data-feather="check" class="w-8 h-8 text-green-400"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-center mb-2 text-white">Account Created</h3>
                        <p class="text-gray-400 text-center text-sm mb-6">Send these credentials to the user.</p>

                        <div class="bg-black/40 border border-white/5 rounded-2xl p-5 space-y-4 mb-8">
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-1">Login
                                    Portal</p>
                                <p id="credLink" class="text-sm font-mono text-blue-400 break-all"></p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-1">Email</p>
                                <p id="credEmail" class="text-sm font-bold text-white break-all"></p>
                            </div>
                            <div>
                                <p class="text-[10px] text-gray-500 uppercase tracking-widest font-bold mb-1">Password
                                </p>
                                <p id="credPassword" class="text-sm font-mono text-gray-300 break-all"></p>
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button onclick="closeCredentialsModal()"
                                class="flex-1 btn-hero-glass py-4 text-sm justify-center">Done</button>
                            <button id="copyCredsBtn"
                                class="flex-1 btn-liquid-glow py-4 text-sm justify-center bg-gradient-to-r from-green-500 to-emerald-500 shadow-[0_10px_30px_-10px_rgba(34,197,94,0.4)]">Copy
                                Details</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <div id="repoActionsModal"
            class="fixed inset-0 z-[115] hidden items-end sm:items-center justify-center bg-black/75 backdrop-blur-sm p-3 sm:p-4">
            <div id="repoActionsModalPanel"
                class="w-full max-w-xl glass-panel border border-white/10 rounded-[1.6rem] sm:rounded-[2rem] shadow-2xl overflow-hidden">
                <div
                    class="px-5 sm:px-6 py-4 sm:py-5 border-b border-white/10 bg-white/[0.02] flex items-start justify-between gap-3">
                    <div class="min-w-0">
                        <p class="text-[11px] uppercase tracking-widest font-bold text-gray-500">Quick Actions</p>
                        <h3 id="repoActionsTitle" class="text-lg sm:text-xl font-bold text-white truncate mt-1">/client
                             v1</h3>
                        <p id="repoActionsSubtitle" class="text-xs sm:text-sm text-gray-400 mt-1">Choose what to do for
                            this branch.</p>
                    </div>
                    <button type="button" onclick="closeRepoActionsModal()"
                        class="p-2 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-gray-400 hover:text-white transition-colors shrink-0"><i
                            data-feather="x" class="w-4 h-4"></i></button>
                </div>
                <div id="repoActionsList" class="p-4 sm:p-5 space-y-2.5 max-h-[65vh] overflow-y-auto hide-scrollbar">
                </div>
                <div class="px-4 sm:px-5 pb-4 sm:pb-5">
                    <button type="button" onclick="closeRepoActionsModal()"
                        class="w-full btn-hero-glass justify-center py-3.5 text-sm">Close</button>
                </div>
            </div>
        </div>
        <div id="dangerModal"
            class="fixed inset-0 z-[130] items-center justify-center hidden bg-black/90 backdrop-blur-md transition-opacity px-4">
            <div
                class="glass-panel rounded-[2.5rem] p-8 max-w-sm w-full border border-red-500/30 shadow-[0_0_60px_rgba(239,68,68,0.2)] transform scale-100 transition-transform">
                <div
                    class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mb-6 mx-auto border border-red-500/20 shadow-[0_0_30px_rgba(239,68,68,0.15)]">
                    <i data-feather="alert-triangle" class="w-8 h-8 text-red-500"></i>
                </div>
                <h3 class="text-2xl font-bold text-center mb-3 text-white">Are you sure?</h3>
                <p id="dangerModalText" class="text-gray-400 text-center text-sm mb-8 leading-relaxed">This action
                    cannot be undone.</p>
                <div class="flex gap-3">
                    <button onclick="closeDangerModal()"
                        class="flex-1 btn-hero-glass py-3.5 text-sm font-bold justify-center rounded-xl">Cancel</button>
                    <button id="dangerConfirmBtn"
                        class="flex-1 btn-liquid-glow py-3.5 text-sm font-bold justify-center rounded-xl bg-gradient-to-r from-red-600 to-orange-600 shadow-[0_10px_30px_-10px_rgba(239,68,68,0.5)]">Yes,
                        Proceed</button>
                </div>
            </div>
        </div>

        <div id="cloneModal"
            class="fixed inset-0 z-[100] items-center justify-center hidden bg-black/80 backdrop-blur-sm transition-opacity">
            <div class="glass-panel rounded-[2rem] p-8 max-w-md w-full mx-4 border border-[#FF8A00]/30 shadow-[0_0_50px_rgba(255,138,0,0.15)] transform scale-95 transition-transform"
                id="cloneModalContent">
                <div
                    class="w-16 h-16 bg-[#FF8A00]/20 rounded-full flex items-center justify-center mb-6 mx-auto border border-[#FF8A00]/30">
                    <i data-feather="git-branch" class="w-8 h-8 text-[#FF8A00]"></i>
                </div>
                <h3 class="text-2xl font-bold text-center mb-2 text-white">Create New Revision</h3>
                <p class="text-gray-400 text-center text-sm mb-8" id="cloneModalText">Branching from v1 to v2...</p>

                <div class="flex gap-4">
                    <button onclick="closeCloneModal()"
                        class="flex-1 btn-hero-glass py-4 text-sm justify-center">Cancel</button>
                    <button id="confirmCloneBtn" class="flex-1 btn-liquid-glow py-4 text-sm justify-center">Confirm
                        Clone</button>
                </div>
            </div>
        </div>

        <div id="deployConfirmModal"
            class="fixed inset-0 z-[140] items-center justify-center hidden bg-black/90 backdrop-blur-md transition-opacity px-4">
            <div
                class="glass-panel rounded-[2.5rem] p-8 max-w-md w-full border border-purple-500/30 shadow-[0_0_60px_rgba(168,85,247,0.2)] transform scale-100 transition-transform">
                <div
                    class="w-16 h-16 bg-purple-500/10 rounded-full flex items-center justify-center mb-6 mx-auto border border-purple-500/20 shadow-[0_0_30px_rgba(168,85,247,0.15)]">
                    <i data-feather="upload-cloud" class="w-8 h-8 text-purple-500"></i>
                </div>
                <h3 class="text-2xl font-bold text-center mb-3 text-white">Confirm Deployment</h3>
                <p id="deployConfirmModalText" class="text-gray-400 text-center text-sm mb-6 leading-relaxed">Please
                    review the details below before pushing.</p>
                <div id="deployConfirmNameGroup" class="mb-4 hidden">
                    <label class="block text-[11px] font-bold text-gray-400 mb-2 uppercase tracking-widest">Target
                        Client Directory</label>
                    <input type="text" id="deployConfirmName"
                        class="w-full input-dark rounded-2xl p-4 text-sm font-mono" placeholder="e.g. eagle-eye">
                </div>
                <div class="mb-6">
                    <label class="block text-[11px] font-bold text-gray-400 mb-2 uppercase tracking-widest">Deployment
                        Notes (Mandatory) <span class="text-red-500">*</span></label>
                    <textarea id="deployCommitMsg" rows="3" placeholder="Briefly describe your changes..."
                        class="w-full input-dark rounded-2xl p-4 text-sm resize-none"></textarea>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeDeployConfirmModal()"
                        class="flex-1 btn-hero-glass py-3.5 text-sm font-bold justify-center rounded-xl">Cancel</button>
                    <button id="deployConfirmBtn"
                        class="flex-1 btn-liquid-glow py-3.5 text-sm font-bold justify-center rounded-xl shadow-[0_10px_30px_-10px_rgba(168,85,247,0.5)]">Yes,
                        Deploy</button>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // FIREBASE SECRETS
        const firebaseConfig = {
            apiKey: "AIzaSyB4_6wJOcQddUFz8BemeG9HQgbuZtoHp20",
            authDomain: "reputifly-automation.firebaseapp.com",
            projectId: "reputifly-automation",
            storageBucket: "reputifly-automation.firebasestorage.app",
            messagingSenderId: "1095726999398",
            appId: "1:1095726999398:web:4e26ec90770da0244c0aa7"
        };

        // BACKEND URLS (Multi-File supported)
        const API_DEPLOY = "https://githubdeployer-5resuz4f5a-as.a.run.app";
        const API_LIST = "https://listsamples-5resuz4f5a-as.a.run.app";
        const API_DELETE = "https://deletesample-5resuz4f5a-as.a.run.app";
        const API_CLONE = "https://asia-southeast1-reputifly-automation.cloudfunctions.net/cloneVersion";
        const API_ADMIN = "https://manageteam-5resuz4f5a-as.a.run.app";

        const SUPER_ADMIN_UID = "wyeWdXkzCNf4ghrLxmoyvVbURAv2";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        let currentIdToken = null;
        window.repoData = {}; // Global store for branch calculation
        window.currentUserEmail = null;
        window.currentUserUid = null;
        window.isSuperAdmin = false;
        feather.replace();

        onAuthStateChanged(auth, async (user) => {
            if (!user) { window.location.href = 'index.html'; return; }
            currentIdToken = await user.getIdToken();
            window.currentUserEmail = (user.email || '').toLowerCase();
            window.currentUserUid = user.uid;
            window.isSuperAdmin = user.uid === SUPER_ADMIN_UID;
            document.getElementById('userBadge').innerText = user.email.split('@')[0];
            if (user.uid === SUPER_ADMIN_UID) {
                document.getElementById('navAdminBtn').classList.remove('hidden');
                const vsCodeLink = document.getElementById('vsCodeHelpLink');
                if (vsCodeLink) {
                    vsCodeLink.classList.remove('hidden');
                    vsCodeLink.classList.add('flex');
                }
            }

            // Preload repo data so Access Control / Revision dropdown always has all projects
            try {
                await loadSamples(true);
            } catch (e) {
                console.error("Initial repo preload failed:", e);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

        // SIDEBAR TOGGLE
        window.toggleSidebar = (forceClose = false) => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (forceClose || !sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            } else {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            }
        };

        // DEPLOY CONFIRM MODAL
        window.deployConfirmAction = null;
        window.openDeployConfirmModal = (msgHtml, confirmCallback, initialName = null) => {
            const modal = document.getElementById('deployConfirmModal');
            document.getElementById('deployConfirmModalText').innerHTML = msgHtml;
            document.getElementById('deployCommitMsg').value = ''; // clear previous

            const nameGroup = document.getElementById('deployConfirmNameGroup');
            const nameInput = document.getElementById('deployConfirmName');
            if (initialName !== null) {
                nameGroup.classList.remove('hidden');
                nameInput.value = initialName;
            } else {
                nameGroup.classList.add('hidden');
                nameInput.value = '';
            }

            console.log("Confirm modal opened with message:", msgHtml); // Debug log
            window.deployConfirmAction = confirmCallback;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };
        window.closeDeployConfirmModal = () => {
            const modal = document.getElementById('deployConfirmModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            window.deployConfirmAction = null;
        };
        document.getElementById('deployConfirmBtn').addEventListener('click', () => {
            const commitMsg = document.getElementById('deployCommitMsg').value.trim();
            if (!commitMsg) {
                window.showToast("Deployment notes are mandatory!", "error");
                return;
            }

            const nameGroup = document.getElementById('deployConfirmNameGroup');
            let finalName = null;
            if (!nameGroup.classList.contains('hidden')) {
                finalName = document.getElementById('deployConfirmName').value.toLowerCase().replace(/[^a-z0-9-]/g, '');
                if (!finalName) {
                    window.showToast("Target Client Directory is mandatory!", "error");
                    return;
                }
            }

            if (window.deployConfirmAction) {
                window.deployConfirmAction(commitMsg, finalName);
                closeDeployConfirmModal();
            }
        });

        // TAB UI
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-tab').forEach(btn => {
                btn.classList.remove('active');
                const svg = btn.querySelector('svg');
                if (svg) svg.classList.remove('text-[#E6397F]', 'text-purple-400', 'text-blue-400', 'text-amber-400', 'text-amber-500');
            });

            document.getElementById(tab + 'Tab').classList.add('active');

            const activeBtn = document.getElementById('nav-' + tab);
            if (activeBtn) {
                activeBtn.classList.add('active');
                if (tab === 'deploy') activeBtn.querySelector('svg').classList.add('text-[#E6397F]');
                if (tab === 'revision') activeBtn.querySelector('svg').classList.add('text-purple-400');
                if (tab === 'overwrite') activeBtn.querySelector('svg').classList.add('text-purple-400');
                if (tab === 'manage') activeBtn.querySelector('svg').classList.add('text-blue-400');
                if (tab === 'help') activeBtn.querySelector('svg').classList.add('text-amber-400');
            }

            if (window.innerWidth < 1280) window.toggleSidebar(true); // Auto close sidebar on mobile

            if (tab === 'manage') loadSamples();
            if (tab === 'revision') loadSamples(true);
            if (tab === 'overwrite') loadSamples(true);
            if (tab === 'admin') loadUsers();
        };

        // ==========================================
        // TAB 1: DEPLOY BASE (Single File / Zip)
        // ==========================================
        let isZipMode = true;
        let parsedFolderName = "";
        let parsedLogoBase64 = null;

        const setMode = (zip) => {
            isZipMode = zip;
            document.getElementById('zipUploadBox').style.display = zip ? 'block' : 'none';
            document.getElementById('manualNameBox').style.display = zip ? 'none' : 'block';

            const activeClass = "flex-1 justify-center px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 shadow-[0_0_15px_rgba(255,255,255,0.05)] transition-all flex items-center gap-2 whitespace-nowrap";
            const inactiveClass = "flex-1 justify-center px-4 py-3 rounded-xl text-gray-500 hover:text-white hover:bg-white/5 border border-transparent transition-all flex items-center gap-2 whitespace-nowrap";

            document.getElementById('modeZipBtn').className = zip ? activeClass : inactiveClass;
            document.getElementById('modeCodeBtn').className = !zip ? activeClass : inactiveClass;
            document.getElementById('manualFolderName').required = !zip;
        };
        document.getElementById('modeZipBtn').addEventListener('click', (e) => { e.preventDefault(); setMode(true); });
        document.getElementById('modeCodeBtn').addEventListener('click', (e) => { e.preventDefault(); setMode(false); });

        const handleBaseUpload = async (files) => {
            if (files.length === 0) return;
            const file = files[0];
            document.getElementById('uploadPrompt').classList.add('hidden');
            document.getElementById('zipStatus').classList.remove('hidden');
            document.getElementById('logoStatusDisplay').innerHTML = '<div class="w-full bg-white/5 py-3 rounded-xl text-center"><i data-feather="loader" class="w-5 h-5 animate-spin text-[#FF8A00] inline"></i></div>';
            feather.replace();

            try {
                parsedLogoBase64 = null;
                let extractedHtml = "";
                window.baseZipFiles = [];
                parsedFolderName = file.name ? file.name.split('-manual-pack')[0].replace('.zip', '').toLowerCase().replace(/[^a-z0-9-]/g, '') : "new-project";

                if (file.name && file.name.endsWith('.zip')) {
                    const zip = new JSZip();
                    const contents = await zip.loadAsync(file);

                    document.getElementById('clientNameDisplay').innerText = `/${parsedFolderName}`;

                    // Smart Directory Flattening (Finds index.html to dynamically determine root path)
                    let rootPath = "";
                    for (const relPath of Object.keys(contents.files)) {
                        if (relPath.endsWith('index.html') && !relPath.includes('__MACOSX')) {
                            rootPath = relPath.replace('index.html', '');
                            break;
                        }
                    }

                    for (const [relativePath, zipEntry] of Object.entries(contents.files)) {
                        if (zipEntry.dir || relativePath.includes('__MACOSX')) continue;
                        if (!relativePath.startsWith(rootPath)) continue;

                        const cleanPath = relativePath.substring(rootPath.length);
                        if (!cleanPath) continue; // Skip empty paths

                        // Handle extensionless files and add ts/tsx/jsx support
                        const nameParts = cleanPath.split('.');
                        const ext = nameParts.length > 1 ? nameParts.pop().toLowerCase() : '';
                        const isText = /^(html|css|js|json|md|txt|svg|xml|csv|ts|tsx|jsx)$/i.test(ext);

                        if (cleanPath.match(/^logo\.(png|jpg|jpeg|webp|svg)$/i)) {
                            parsedLogoBase64 = await zipEntry.async("base64");
                        }
                        if (cleanPath === 'index.html' && !extractedHtml) {
                            extractedHtml = await zipEntry.async("string");
                        }

                        if (isText) {
                            const text = await zipEntry.async("string");
                            window.baseZipFiles.push({ name: cleanPath, content: text, isBinary: false });
                        } else {
                            const base64Data = await zipEntry.async("base64");
                            window.baseZipFiles.push({ name: cleanPath, content: base64Data, isBinary: true });
                        }
                    }
                } else {
                    // Folder approach
                    let commonPrefix = "";
                    if (files[0].webkitRelativePath) {
                        const parts = files[0].webkitRelativePath.split('/');
                        if (parts.length > 1) {
                            commonPrefix = parts[0] + '/';
                            parsedFolderName = parts[0].toLowerCase().replace(/[^a-z0-9-]/g, '');
                        }
                    }
                    if (!parsedFolderName) parsedFolderName = "new-client";
                    document.getElementById('clientNameDisplay').innerText = `/${parsedFolderName}`;

                    for (const f of files) {
                        let cleanPath = f.webkitRelativePath || f.name;
                        if (commonPrefix && cleanPath.startsWith(commonPrefix)) {
                            cleanPath = cleanPath.substring(commonPrefix.length);
                        }
                        if (!cleanPath) continue;

                        const nameParts = cleanPath.split('.');
                        const ext = nameParts.length > 1 ? nameParts.pop().toLowerCase() : '';
                        const isText = /^(html|css|js|json|md|txt|svg|xml|csv|ts|tsx|jsx)$/i.test(ext);

                        if (cleanPath.match(/^logo\.(png|jpg|jpeg|webp|svg)$/i)) {
                            parsedLogoBase64 = await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                                reader.readAsDataURL(f);
                            });
                        }

                        if (cleanPath === 'index.html' && !extractedHtml) {
                            extractedHtml = await f.text();
                        }

                        if (isText) {
                            const text = await f.text();
                            window.baseZipFiles.push({ name: cleanPath, content: text, isBinary: false });
                        } else {
                            const base64Data = await new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onload = (e) => resolve(e.target.result.split(',')[1]);
                                reader.readAsDataURL(f);
                            });
                            window.baseZipFiles.push({ name: cleanPath, content: base64Data, isBinary: true });
                        }
                    }
                }

                if (extractedHtml) {
                    document.getElementById('htmlContent').value = extractedHtml;
                }

                document.getElementById('logoStatusDisplay').innerHTML = `
                    <div class="flex flex-col gap-2 w-full">
                        <div class="w-full ${extractedHtml ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-400' : 'bg-amber-500/10 border-amber-500/20 text-amber-400'} py-2.5 rounded-xl border text-center flex items-center justify-center gap-2">
                            <i data-feather="${extractedHtml ? 'code' : 'alert-circle'}" class="w-4 h-4"></i>
                            <span class="text-[11px] font-bold uppercase tracking-wider">${extractedHtml ? 'HTML Auto-Loaded' : 'No HTML Found'}</span>
                        </div>
                        <div class="w-full ${parsedLogoBase64 ? 'bg-green-500/10 border-green-500/20 text-green-400' : 'bg-gray-500/10 border-gray-500/20 text-gray-400'} py-2.5 rounded-xl border text-center flex items-center justify-center gap-2">
                            <i data-feather="${parsedLogoBase64 ? 'image' : 'type'}" class="w-4 h-4"></i>
                            <span class="text-[11px] font-bold uppercase tracking-wider">${parsedLogoBase64 ? 'Logo Extracted' : 'Text Logo Enabled'}</span>
                        </div>
                        <div class="text-[10px] text-gray-500 mt-1 uppercase tracking-widest font-bold w-full text-center">${window.baseZipFiles.length} files queued</div>
                    </div>
                `;
                feather.replace();
            } catch (err) { alert("Pack Extraction Error."); console.error(err); }
        };

        document.getElementById('zipInput').addEventListener('change', (e) => handleBaseUpload(Array.from(e.target.files)));
        document.getElementById('baseFolderInput').addEventListener('change', (e) => handleBaseUpload(Array.from(e.target.files)));

        const zipUploadBox = document.getElementById('zipUploadBox');
        if (zipUploadBox) {
            zipUploadBox.addEventListener('dragover', (e) => {
                e.preventDefault();
                zipUploadBox.classList.add('opacity-70', 'border-[#E6397F]', 'bg-[#E6397F]/5');
            });
            zipUploadBox.addEventListener('dragleave', (e) => {
                e.preventDefault();
                zipUploadBox.classList.remove('opacity-70', 'border-[#E6397F]', 'bg-[#E6397F]/5');
            });
            zipUploadBox.addEventListener('drop', (e) => {
                e.preventDefault();
                zipUploadBox.classList.remove('opacity-70', 'border-[#E6397F]', 'bg-[#E6397F]/5');
                if (e.dataTransfer.files.length > 0) {
                    handleBaseUpload(Array.from(e.dataTransfer.files));
                }
            });
        }

        document.getElementById('previewBtn').addEventListener('click', () => {
            const code = document.getElementById('htmlContent').value;
            if (!code) return window.showToast("Paste HTML code first!", "info");
            window.open(URL.createObjectURL(new Blob([code], { type: 'text/html' })), '_blank');
        });

        document.getElementById('deployForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const htmlContent = document.getElementById('htmlContent').value;
            const originalFolderName = isZipMode ? parsedFolderName : document.getElementById('manualFolderName').value.toLowerCase().replace(/[^a-z0-9-]/g, '');
            const version = window.currentEditVersion || "base"; // Auto routes to /base

            if (!originalFolderName || !htmlContent || !currentIdToken) return window.showToast("Missing required data!", "error");

            if (version === "base" && !window.currentEditVersion && window.repoData && window.repoData[originalFolderName]) {
                return window.showToast(`A project named "/${originalFolderName}" already exists! Please choose a unique name.`, "error");
            }

            const confirmMsg = `Deploying <b>Base build</b>. Please verify the target client directory below.<br><br><span class="text-xs text-gray-400 uppercase tracking-widest font-bold">${isZipMode && window.baseZipFiles ? window.baseZipFiles.length : 1} File(s) Queued</span>`;

            window.openDeployConfirmModal(confirmMsg, async (commitMsg, updatedFolderName) => {
                const finalFolderName = updatedFolderName || originalFolderName;

                if (version === "base" && !window.currentEditVersion && window.repoData && window.repoData[finalFolderName]) {
                    return window.showToast(`A project named "/${finalFolderName}" already exists! Please choose a unique name.`, "error");
                }

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                document.getElementById('btnText').innerText = "Compiling & Pushing...";

                try {
                    currentIdToken = await auth.currentUser.getIdToken();
                    const payload = { folderName: finalFolderName, version, htmlContent };
                    if (isZipMode && window.baseZipFiles && window.baseZipFiles.length > 0) {
                        payload.files = window.baseZipFiles;
                        // Sync editor changes back to the main HTML file before sending
                        const htmlIndex = payload.files.findIndex(f => f.name.endsWith('.html') || f.name === 'index.html');
                        if (htmlIndex > -1 && htmlContent) {
                            payload.files[htmlIndex].content = htmlContent;
                        } else if (htmlContent) {
                            payload.files.push({ name: 'index.html', content: htmlContent, isBinary: false });
                        }
                    } else if (isZipMode && parsedLogoBase64) {
                        payload.logoBase64 = parsedLogoBase64;
                        if (htmlContent) payload.htmlContent = htmlContent;
                    }

                    const response = await fetch(API_DEPLOY, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentIdToken}` },
                        body: JSON.stringify(payload)
                    });

                    const rawText = await response.text();
                    let result = {};
                    try { result = rawText ? JSON.parse(rawText) : {}; } catch (_) { result = { error: rawText || `HTTP ${response.status}` }; }

                    if (!response.ok || !result.success) {
                        throw new Error(result.error || `HTTP ${response.status}`);
                    }

                    // Admin Telegram Notification
                    fetch('https://asia-southeast1-b2b-software.cloudfunctions.net/reputifly', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            _to: 'runikojane@gmail.com',
                            _subject: `Deployment Base: /${finalFolderName}`,
                            _sender_name: 'Reputifly System Logs',
                            Action: 'Base Build Deployed',
                            Project: `/${finalFolderName}`,
                            FilesQueued: isZipMode && window.baseZipFiles ? window.baseZipFiles.length : 1,
                            DeployedBy: window.currentUserEmail || 'Unknown',
                            CommitMessage: commitMsg,
                            LiveURL: result.liveUrl,
                            Timestamp: new Date().toLocaleString()
                        })
                    }).catch(() => { }); // silent fail

                    document.getElementById('deployForm').classList.add('hidden');
                    document.getElementById('resultBox').classList.remove('hidden');
                    document.getElementById('liveLink').href = result.liveUrl;

                    const copyBtn = document.getElementById('copyLinkBtn');
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(result.liveUrl);
                        copyBtn.innerHTML = '<i data-feather="check" class="w-5 h-5"></i> Copied!';
                        feather.replace();
                        setTimeout(() => { copyBtn.innerHTML = '<i data-feather="copy" class="w-5 h-5"></i> Copy Link'; feather.replace(); }, 2000);
                    };
                } catch (err) {
                    window.showToast("Error: " + (err.message || "Network Error."), "error");
                } finally {
                    submitBtn.disabled = false;
                    document.getElementById('btnText').innerText = "Deploy Base Build";
                }
            }, isZipMode ? originalFolderName : null);
        });

        window.resetDeployer = () => {
            document.getElementById('deployForm').reset();
            window.currentEditVersion = "base";
            document.getElementById('deployForm').classList.remove('hidden');
            document.getElementById('resultBox').classList.add('hidden');
            document.getElementById('uploadPrompt').classList.remove('hidden');
            document.getElementById('zipStatus').classList.add('hidden');
            parsedFolderName = ""; parsedLogoBase64 = null;
        };

        // ==========================================
        // TAB 2: DEPLOY REVISION (MULTI-FILE MAGIC)
        // ==========================================
        let revisionFiles = [];
        let calculatedNextVersion = "v1";

        // Read multiple files OR smartly extract ZIPs
        const handleRevisionFiles = async (files) => {
            if (files.length === 0) return;

            const listDiv = document.getElementById('revFilesList');
            listDiv.innerHTML = '<div class="text-center py-4"><i data-feather="loader" class="animate-spin text-purple-400 mx-auto w-5 h-5 mb-2"></i><p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Processing Assets...</p></div>';
            listDiv.classList.remove('hidden');
            feather.replace();

            revisionFiles = [];

            // If a whole folder is selected, it will have a common prefix root folder path that we should strip.
            let commonPrefix = "";
            let folderMapped = false;
            if (files.length > 0 && files[0].webkitRelativePath) {
                const parts = files[0].webkitRelativePath.split('/');
                if (parts.length > 1) {
                    commonPrefix = parts[0] + '/';
                    folderMapped = true;
                }
            }

            for (const f of files) {
                if (f.name.endsWith('.zip')) {
                    try {
                        const zip = new JSZip();
                        const contents = await zip.loadAsync(f);

                        // Smart Directory Flattening (Finds index.html to dynamically determine the root path)
                        let rootPath = "";
                        for (const relPath of Object.keys(contents.files)) {
                            if (relPath.endsWith('index.html') && !relPath.includes('__MACOSX')) {
                                rootPath = relPath.replace('index.html', '');
                                break;
                            }
                        }

                        // Extract valid assets relative to that root (stripping the zip's outer wrapper folder)
                        for (const [relPath, zipEntry] of Object.entries(contents.files)) {
                            if (zipEntry.dir || relPath.includes('__MACOSX')) continue;
                            if (relPath.startsWith(rootPath)) {
                                const cleanPath = relPath.substring(rootPath.length);
                                if (!cleanPath) continue; // Skip empty paths

                                // Safe extraction for files lacking an extension
                                const nameParts = cleanPath.split('.');
                                const ext = nameParts.length > 1 ? nameParts.pop().toLowerCase() : '';

                                const isText = /^(html|css|js|json|md|txt|svg|xml|csv|ts|tsx|jsx)$/i.test(ext);

                                if (isText) {
                                    const text = await zipEntry.async("string");
                                    revisionFiles.push({ name: cleanPath, content: text, isBinary: false });
                                } else {
                                    const base64Data = await zipEntry.async("base64");
                                    revisionFiles.push({ name: cleanPath, content: base64Data, isBinary: true });
                                }
                            }
                        }
                    } catch (err) { window.showToast("ZIP parsing error.", "error"); }
                } else {
                    // Handle loose file uploads
                    const ext = f.name.split('.').pop().toLowerCase();
                    const isText = /^(html|css|js|json|md|txt|xml|csv|svg|ts|tsx|jsx)$/i.test(ext);

                    let cleanPath = f.webkitRelativePath || f.name;
                    if (folderMapped && cleanPath.startsWith(commonPrefix)) {
                        cleanPath = cleanPath.substring(commonPrefix.length);
                    }

                    if (!isText) {
                        const base64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result.split(',')[1]); // Strip prefix
                            reader.readAsDataURL(f);
                        });
                        revisionFiles.push({ name: cleanPath, content: base64, isBinary: true });
                    } else {
                        const text = await f.text();
                        revisionFiles.push({ name: cleanPath, content: text, isBinary: false });
                    }
                }
            }

            // Render the extracted files with smooth UI
            listDiv.innerHTML = '<p class="text-[11px] font-bold text-gray-500 mb-3 uppercase tracking-widest pl-2">Ready to Push (' + revisionFiles.length + ' files)</p><div class="max-h-[200px] overflow-y-auto pr-2 space-y-2 hide-scrollbar" id="revExtractedList"></div>';
            const innerList = document.getElementById('revExtractedList');

            revisionFiles.forEach(fileObj => {
                const ext = fileObj.name.split('.').pop().toLowerCase();
                let iconColor = 'text-gray-400';
                let iconName = 'file';

                if (ext === 'html') iconColor = 'text-purple-400';
                else if (ext === 'css') iconColor = 'text-blue-400';
                else if (ext === 'js') iconColor = 'text-yellow-400';
                else if (['png', 'jpg', 'jpeg', 'webp', 'gif', 'svg', 'ico'].includes(ext)) {
                    iconColor = 'text-pink-400';
                    iconName = 'image';
                } else if (ext === 'json') {
                    iconColor = 'text-green-400';
                }

                innerList.innerHTML += `
                    <div class="flex items-center gap-3 bg-black/40 p-3.5 rounded-[14px] border border-white/5 shadow-inner">
                        <i data-feather="${iconName}" class="w-4 h-4 ${iconColor}"></i>
                        <span class="text-sm font-semibold text-gray-200 truncate">${fileObj.name}</span>
                    </div>`;
            });
            feather.replace();

            updateRevSubmitState();
        };

        // UI Event Listeners for Revision Uploads
        document.getElementById('revFileInput').addEventListener('change', (e) => handleRevisionFiles(Array.from(e.target.files)));
        document.getElementById('revFolderInput').addEventListener('change', (e) => handleRevisionFiles(Array.from(e.target.files)));

        const revUploadBox = document.getElementById('revUploadModeBox');
        if (revUploadBox) {
            revUploadBox.addEventListener('dragover', (e) => {
                e.preventDefault();
                revUploadBox.classList.add('border-purple-500', 'bg-purple-500/10');
            });
            revUploadBox.addEventListener('dragleave', (e) => {
                e.preventDefault();
                revUploadBox.classList.remove('border-purple-500', 'bg-purple-500/10');
            });
            revUploadBox.addEventListener('drop', (e) => {
                e.preventDefault();
                revUploadBox.classList.remove('border-purple-500', 'bg-purple-500/10');
                if (e.dataTransfer.files.length > 0) {
                    handleRevisionFiles(Array.from(e.dataTransfer.files));
                }
            });
        }

        let isRevPasteMode = false;

        window.updateRevSubmitState = () => {
            const client = document.getElementById('revClientSelect').value;
            const btn = document.getElementById('revSubmitBtn');
            if (!client) { btn.disabled = true; return; }
            if (isRevPasteMode) btn.disabled = false;
            else btn.disabled = (revisionFiles.length === 0);
        };

        // Client List Selection -> Calculate Next Version
        window.selectRevClient = (client, btnElement) => {
            document.getElementById('revClientSelect').value = client;

            document.querySelectorAll('.rev-client-btn').forEach(b => {
                b.classList.remove('bg-purple-500/10', 'border-purple-500/50', 'shadow-[0_0_20px_rgba(168,85,247,0.1)]');
                b.classList.add('bg-white/[0.02]', 'border-white/5');
                b.querySelector('span.truncate').classList.remove('text-white');
                b.querySelector('span.truncate').classList.add('text-gray-400');

                // Safety check for icon
                const icon = b.querySelector('i');
                if (icon) {
                    icon.classList.remove('text-purple-400');
                    icon.classList.add('text-gray-500');
                }

                const radioFill = b.querySelector('.rev-client-radio-fill');
                const radioBorder = b.querySelector('.rev-client-radio');
                if (radioFill) radioFill.classList.remove('opacity-100');
                if (radioBorder) { radioBorder.classList.remove('border-purple-500', 'bg-purple-500/10'); radioBorder.classList.add('border-white/10', 'bg-black/40'); }
            });

            if (btnElement) {
                btnElement.classList.remove('bg-white/[0.02]', 'border-white/5');
                btnElement.classList.add('bg-purple-500/10', 'border-purple-500/50', 'shadow-[0_0_20px_rgba(168,85,247,0.1)]');
                btnElement.querySelector('span.truncate').classList.remove('text-gray-400');
                btnElement.querySelector('span.truncate').classList.add('text-white');

                // Safety check for icon
                const icon = btnElement.querySelector('i');
                if (icon) {
                    icon.classList.remove('text-gray-500');
                    icon.classList.add('text-purple-400');
                }

                const radioFill = btnElement.querySelector('.rev-client-radio-fill');
                const radioBorder = btnElement.querySelector('.rev-client-radio');
                if (radioFill) radioFill.classList.add('opacity-100');
                if (radioBorder) { radioBorder.classList.remove('border-white/10', 'bg-black/40'); radioBorder.classList.add('border-purple-500', 'bg-purple-500/10'); }
            }

            const textEl = document.getElementById('revNextVersionText');
            if (!client) {
                textEl.innerText = "Awaiting selection...";
                updateRevSubmitState();
                return;
            }

            const existingVersions = window.repoData[client] || [];
            let nextNum = 1;
            const vNums = existingVersions.filter(v => v.startsWith('v')).map(v => parseInt(v.replace('v', '')));
            if (vNums.length > 0) nextNum = Math.max(...vNums) + 1;

            calculatedNextVersion = `v${nextNum}`;
            textEl.innerHTML = `Deploying to: <b class="text-white">/${calculatedNextVersion}/</b>`;
            updateRevSubmitState();
        };

        // Mode Switchers
        const revModeUploadBtn = document.getElementById('revModeUploadBtn');
        const revModePasteBtn = document.getElementById('revModePasteBtn');
        const revUploadModeBox = document.getElementById('revUploadModeBox');
        const revPasteModeBox = document.getElementById('revPasteModeBox');

        if (revModeUploadBtn && revModePasteBtn) {
            const activeClass = "flex-1 justify-center px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 shadow-[0_0_15px_rgba(255,255,255,0.05)] transition-all flex items-center gap-2 whitespace-nowrap";
            const inactiveClass = "flex-1 justify-center px-4 py-3 rounded-xl text-gray-500 hover:text-white hover:bg-white/5 border border-transparent transition-all flex items-center gap-2 whitespace-nowrap";

            revModeUploadBtn.addEventListener('click', () => {
                isRevPasteMode = false;
                revModeUploadBtn.className = activeClass;
                revModePasteBtn.className = inactiveClass;
                revUploadModeBox.classList.remove('hidden'); revUploadModeBox.classList.add('flex');
                revPasteModeBox.classList.add('hidden'); revPasteModeBox.classList.remove('flex');
                updateRevSubmitState();
            });

            revModePasteBtn.addEventListener('click', () => {
                isRevPasteMode = true;
                revModePasteBtn.className = activeClass;
                revModeUploadBtn.className = inactiveClass;
                revPasteModeBox.classList.remove('hidden'); revPasteModeBox.classList.add('flex');
                revUploadModeBox.classList.add('hidden'); revUploadModeBox.classList.remove('flex');
                updateRevSubmitState();
            });
        }

        // Add Paste Block
        const addPasteBlockBtn = document.getElementById('addPasteBlockBtn');
        const revPasteContainer = document.getElementById('revPasteContainer');
        if (addPasteBlockBtn) {
            addPasteBlockBtn.addEventListener('click', () => {
                const block = document.createElement('div');
                block.className = 'glass-card code-editor-shell rounded-[2rem] overflow-hidden flex flex-col shadow-lg rev-paste-block animate-fade-in mb-4';
                block.innerHTML = `
                    <div class="code-editor-header flex justify-between items-center px-6 py-4 bg-black/40 border-b border-white/5 backdrop-blur-md gap-4">
                        <div class="flex items-center gap-3 w-full max-w-sm">
                            <i data-feather="file" class="w-4 h-4 text-purple-400 shrink-0"></i>
                            <input type="text" class="rev-paste-filename input-dark w-full rounded-lg px-3 py-1.5 text-sm font-mono text-white bg-black/50 border-white/10 focus:border-purple-500" placeholder="e.g. about.html">
                        </div>
                        <button type="button" class="text-gray-500 hover:text-red-400 p-2 rounded-xl hover:bg-red-500/10 border border-transparent hover:border-red-500/20 transition-all rev-paste-remove" title="Remove File" onclick="this.closest('.rev-paste-block').remove(); updateRevSubmitState();"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <textarea placeholder="Paste HTML/CSS/JS code here..." class="rev-paste-content code-editor-textarea w-full h-[300px] bg-black/20 text-gray-300 p-6 font-mono text-[13px] leading-relaxed focus:outline-none focus:bg-white/[0.02] transition-colors resize-none rounded-none"></textarea>
                `;
                revPasteContainer.appendChild(block);
                feather.replace();
                document.querySelectorAll('.rev-paste-remove').forEach(el => el.classList.remove('hidden'));
                updateRevSubmitState();
            });
        }

        // Submit Revision
        document.getElementById('revForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const client = document.getElementById('revClientSelect').value;
            if (!client) return;

            let finalRevisionFiles = [];

            if (isRevPasteMode) {
                const blocks = document.querySelectorAll('.rev-paste-block');
                blocks.forEach(block => {
                    const name = block.querySelector('.rev-paste-filename').value.trim();
                    const content = block.querySelector('.rev-paste-content').value;
                    if (name && content) finalRevisionFiles.push({ name, content });
                });
                if (finalRevisionFiles.length === 0) return window.showToast("Please provide valid filenames and content.", "error");
            } else {
                if (revisionFiles.length === 0) return window.showToast("Please upload files first.", "error");
                finalRevisionFiles = revisionFiles;
            }

            const confirmMsg = `Deploying Revision <span class="text-purple-400 font-bold">${calculatedNextVersion}</span> to <span class="text-white font-mono">/${client}</span><br><br><span class="text-xs text-gray-400 uppercase tracking-widest font-bold">${finalRevisionFiles.length} File(s) Queued</span>`;

            window.openDeployConfirmModal(confirmMsg, async (commitMsg) => {
                const btn = document.getElementById('revSubmitBtn');
                btn.disabled = true;
                document.getElementById('revBtnText').innerText = "Pushing Branch...";

                try {
                    if (auth.currentUser) currentIdToken = await auth.currentUser.getIdToken();
                    const response = await fetch(API_DEPLOY, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentIdToken}` },
                        body: JSON.stringify({ folderName: client, version: calculatedNextVersion, files: finalRevisionFiles })
                    });
                    const result = await response.json();

                    if (result.success) {
                        // Admin Telegram Notification
                        fetch('https://asia-southeast1-b2b-software.cloudfunctions.net/reputifly', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                _to: 'runikojane@gmail.com',
                                _subject: `Deployment Revision: /${client} (${calculatedNextVersion})`,
                                _sender_name: 'Reputifly System Logs',
                                Action: 'Revision Deployed',
                                Project: `/${client}`,
                                Version: calculatedNextVersion,
                                FilesQueued: finalRevisionFiles.length,
                                DeployedBy: window.currentUserEmail || 'Unknown',
                                CommitMessage: commitMsg,
                                Timestamp: new Date().toLocaleString()
                            })
                        }).catch(() => { }); // silent fail

                        document.getElementById('revForm').classList.add('hidden');
                        const resBox = document.getElementById('revResultBox');
                        resBox.classList.remove('hidden');

                        let outputHtml = '';
                        let copyText = '';

                        // Only generate shareable links for HTML files
                        const htmlFiles = finalRevisionFiles.filter(f => f.name.toLowerCase().endsWith('.html'));

                        if (htmlFiles.length === 0) {
                            // Fallback: If no HTML files are found, just provide the root directory link
                            const rootUrl = `https://samples.reputifly.org/${client}/${calculatedNextVersion}/`;
                            outputHtml = `<div class="mb-2"><span class="text-purple-400 font-bold">App Root Directory:</span> <br><a href="${rootUrl}" target="_blank" class="text-blue-400 hover:underline break-all">${rootUrl}</a></div>`;
                            copyText = `App Root Directory:\n${rootUrl}\n\n`;
                        } else {
                            htmlFiles.forEach(f => {
                                let title = f.name;
                                if (title.toLowerCase() === 'index.html') title = 'Home Page';
                                else {
                                    // Strip folder paths if they exist (e.g. pages/about.html -> about)
                                    const nameParts = title.split('/');
                                    title = nameParts[nameParts.length - 1].replace('.html', '');
                                    title = title.charAt(0).toUpperCase() + title.slice(1) + ' Page';
                                }
                                const url = `https://samples.reputifly.org/${client}/${calculatedNextVersion}/${f.name === 'index.html' ? '' : f.name}`;

                                outputHtml += `<div class="mb-2"><span class="text-purple-400 font-bold">${title}:</span> <br><a href="${url}" target="_blank" class="text-blue-400 hover:underline break-all">${url}</a></div>`;
                                copyText += `${title}:\n${url}\n\n`;
                            });
                        }

                        document.getElementById('revLinksOutput').innerHTML = outputHtml;

                        document.getElementById('revCopyBtn').onclick = () => {
                            navigator.clipboard.writeText(copyText.trim());
                            document.getElementById('revCopyBtn').innerHTML = '<i data-feather="check" class="w-5 h-5"></i> Copied Format!';
                            feather.replace();
                            setTimeout(() => { document.getElementById('revCopyBtn').innerHTML = '<i data-feather="copy" class="w-5 h-5"></i> Copy Links for WhatsApp'; feather.replace(); }, 2000);
                        };
                    } else window.showToast("Error: " + result.error, "error");
                } catch (err) { window.showToast("Network Error.", "error"); }
            });
        });

        window.resetRevision = () => {
            document.getElementById('revForm').reset();
            document.getElementById('revForm').classList.remove('hidden');
            document.getElementById('revResultBox').classList.add('hidden');
            document.getElementById('revFilesList').classList.add('hidden');
            document.getElementById('revNextVersionText').innerText = "Awaiting selection...";
            document.getElementById('revClientSelect').value = "";

            document.querySelectorAll('.rev-client-btn').forEach(b => {
                b.classList.remove('bg-purple-500/20', 'border-purple-500/50');
                b.classList.add('bg-black/40', 'border-white/5');
                b.querySelector('span').classList.remove('text-white');
                b.querySelector('span').classList.add('text-gray-300');
            });

            document.getElementById('revSubmitBtn').disabled = true;
            revisionFiles = [];

            const container = document.getElementById('revPasteContainer');
            if (container) {
                container.innerHTML = `
                    <div class="glass-card code-editor-shell rounded-[2rem] overflow-hidden flex flex-col shadow-lg rev-paste-block mb-4">
                        <div class="code-editor-header flex justify-between items-center px-6 py-4 bg-black/40 border-b border-white/5 backdrop-blur-md gap-4">
                            <div class="flex items-center gap-3 w-full max-w-sm">
                                <i data-feather="file" class="w-4 h-4 text-purple-400 shrink-0"></i>
                                <input type="text" class="rev-paste-filename input-dark w-full rounded-lg px-3 py-1.5 text-sm font-mono text-white bg-black/50 border-white/10 focus:border-purple-500" placeholder="e.g. index.html" value="index.html">
                            </div>
                            <button type="button" class="text-gray-500 hover:text-red-400 p-2 rounded-xl hover:bg-red-500/10 border border-transparent hover:border-red-500/20 transition-all hidden rev-paste-remove" title="Remove File" onclick="this.closest('.rev-paste-block').remove(); updateRevSubmitState();"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        <textarea placeholder="Paste HTML/CSS/JS code here..." class="rev-paste-content code-editor-textarea w-full h-[300px] bg-black/20 text-gray-300 p-6 font-mono text-[13px] leading-relaxed focus:outline-none focus:bg-white/[0.02] transition-colors resize-none rounded-none"></textarea>
                    </div>
                `;
            }
            if (window.feather) feather.replace();
        };

        // ==========================================
        // TAB 2.5: OVERWRITE REVISION (MULTI-FILE MAGIC)
        // ==========================================
        let overwriteFiles = [];
        let selectedOwVersion = "v1";

        // Read multiple files OR smartly extract ZIPs
        const handleOverwriteFiles = async (files) => {
            if (files.length === 0) return;

            const listDiv = document.getElementById('owFilesList');
            listDiv.innerHTML = '<div class="text-center py-4"><i data-feather="loader" class="animate-spin text-purple-400 mx-auto w-5 h-5 mb-2"></i><p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Processing Assets...</p></div>';
            listDiv.classList.remove('hidden');
            feather.replace();

            overwriteFiles = [];

            // If a whole folder is selected, it will have a common prefix root folder path that we should strip.
            let commonPrefix = "";
            let folderMapped = false;
            if (files.length > 0 && files[0].webkitRelativePath) {
                const parts = files[0].webkitRelativePath.split('/');
                if (parts.length > 1) {
                    commonPrefix = parts[0] + '/';
                    folderMapped = true;
                }
            }

            for (const f of files) {
                if (f.name.endsWith('.zip')) {
                    try {
                        const zip = new JSZip();
                        const contents = await zip.loadAsync(f);

                        // Smart Directory Flattening (Finds index.html to dynamically determine the root path)
                        let rootPath = "";
                        for (const relPath of Object.keys(contents.files)) {
                            if (relPath.endsWith('index.html') && !relPath.includes('__MACOSX')) {
                                rootPath = relPath.replace('index.html', '');
                                break;
                            }
                        }

                        // Extract valid assets relative to that root (stripping the zip's outer wrapper folder)
                        for (const [relPath, zipEntry] of Object.entries(contents.files)) {
                            if (zipEntry.dir || relPath.includes('__MACOSX')) continue;
                            if (relPath.startsWith(rootPath)) {
                                const cleanPath = relPath.substring(rootPath.length);
                                if (!cleanPath) continue; // Skip empty paths

                                // Safe extraction for files lacking an extension
                                const nameParts = cleanPath.split('.');
                                const ext = nameParts.length > 1 ? nameParts.pop().toLowerCase() : '';

                                const isText = /^(html|css|js|json|md|txt|svg|xml|csv|ts|tsx|jsx)$/i.test(ext);

                                if (isText) {
                                    const text = await zipEntry.async("string");
                                    overwriteFiles.push({ name: cleanPath, content: text, isBinary: false });
                                } else {
                                    const base64Data = await zipEntry.async("base64");
                                    overwriteFiles.push({ name: cleanPath, content: base64Data, isBinary: true });
                                }
                            }
                        }
                    } catch (err) { window.showToast("ZIP parsing error.", "error"); }
                } else {
                    // Handle loose file uploads
                    const ext = f.name.split('.').pop().toLowerCase();
                    const isText = /^(html|css|js|json|md|txt|xml|csv|svg|ts|tsx|jsx)$/i.test(ext);

                    let cleanPath = f.webkitRelativePath || f.name;
                    if (folderMapped && cleanPath.startsWith(commonPrefix)) {
                        cleanPath = cleanPath.substring(commonPrefix.length);
                    }

                    if (!isText) {
                        const base64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result.split(',')[1]); // Strip prefix
                            reader.readAsDataURL(f);
                        });
                        overwriteFiles.push({ name: cleanPath, content: base64, isBinary: true });
                    } else {
                        const text = await f.text();
                        overwriteFiles.push({ name: cleanPath, content: text, isBinary: false });
                    }
                }
            }

            // Render the extracted files with smooth UI
            listDiv.innerHTML = '<p class="text-[11px] font-bold text-gray-500 mb-3 uppercase tracking-widest pl-2">Ready to Push (' + overwriteFiles.length + ' files)</p><div class="max-h-[200px] overflow-y-auto pr-2 space-y-2 hide-scrollbar" id="owExtractedList"></div>';
            const innerList = document.getElementById('owExtractedList');

            overwriteFiles.forEach(fileObj => {
                const ext = fileObj.name.split('.').pop().toLowerCase();
                let iconColor = 'text-gray-400';
                let iconName = 'file';

                if (ext === 'html') iconColor = 'text-purple-400';
                else if (ext === 'css') iconColor = 'text-blue-400';
                else if (ext === 'js') iconColor = 'text-yellow-400';
                else if (['png', 'jpg', 'jpeg', 'webp', 'gif', 'svg', 'ico'].includes(ext)) {
                    iconColor = 'text-pink-400';
                    iconName = 'image';
                } else if (ext === 'json') {
                    iconColor = 'text-green-400';
                }

                innerList.innerHTML += `
                    <div class="flex items-center gap-3 bg-black/40 p-3.5 rounded-[14px] border border-white/5 shadow-inner">
                        <i data-feather="${iconName}" class="w-4 h-4 ${iconColor}"></i>
                        <span class="text-sm font-semibold text-gray-200 truncate">${fileObj.name}</span>
                    </div>`;
            });
            feather.replace();

            updateOwSubmitState();
        };

        // UI Event Listeners for Revision Uploads
        document.getElementById('owFileInput').addEventListener('change', (e) => handleOverwriteFiles(Array.from(e.target.files)));
        document.getElementById('owFolderInput').addEventListener('change', (e) => handleOverwriteFiles(Array.from(e.target.files)));

        const owUploadBox = document.getElementById('owUploadModeBox');
        if (owUploadBox) {
            owUploadBox.addEventListener('dragover', (e) => {
                e.preventDefault();
                owUploadBox.classList.add('border-amber-500', 'bg-amber-500/10');
            });
            owUploadBox.addEventListener('dragleave', (e) => {
                e.preventDefault();
                owUploadBox.classList.remove('border-amber-500', 'bg-amber-500/10');
            });
            owUploadBox.addEventListener('drop', (e) => {
                e.preventDefault();
                owUploadBox.classList.remove('border-amber-500', 'bg-amber-500/10');
                if (e.dataTransfer.files.length > 0) {
                    handleOverwriteFiles(Array.from(e.dataTransfer.files));
                }
            });
        }

        let isOwPasteMode = false;

        window.updateOwSubmitState = () => {
            const client = document.getElementById('owClientSelect').value;
            const version = document.getElementById('owVersionSelect').value;
            const btn = document.getElementById('owSubmitBtn');
            if (!client || !version) { btn.disabled = true; return; }
            if (isOwPasteMode) btn.disabled = false;
            else btn.disabled = (overwriteFiles.length === 0);
        };

        // Client List Selection & Populate Dropdown
        window.selectOwClient = (client, btnElement) => {
            document.getElementById('owClientSelect').value = client;

            document.querySelectorAll('.ow-client-btn').forEach(b => {
                b.classList.remove('bg-purple-500/10', 'border-purple-500/50', 'shadow-[0_0_20px_rgba(168,85,247,0.1)]');
                b.classList.add('bg-white/[0.02]', 'border-white/5');
                b.querySelector('span.truncate').classList.remove('text-white');
                b.querySelector('span.truncate').classList.add('text-gray-400');

                const icon = b.querySelector('i');
                if (icon) {
                    icon.classList.remove('text-purple-400');
                    icon.classList.add('text-gray-500');
                }

                const radioFill = b.querySelector('.ow-client-radio-fill');
                const radioBorder = b.querySelector('.ow-client-radio');
                if (radioFill) radioFill.classList.remove('opacity-100');
                if (radioBorder) { radioBorder.classList.remove('border-purple-500', 'bg-purple-500/10'); radioBorder.classList.add('border-white/10', 'bg-black/40'); }
            });

            if (btnElement) {
                btnElement.classList.remove('bg-white/[0.02]', 'border-white/5');
                btnElement.classList.add('bg-purple-500/10', 'border-purple-500/50', 'shadow-[0_0_20px_rgba(168,85,247,0.1)]');
                btnElement.querySelector('span.truncate').classList.remove('text-gray-400');
                btnElement.querySelector('span.truncate').classList.add('text-white');

                const icon = btnElement.querySelector('i');
                if (icon) {
                    icon.classList.remove('text-gray-500');
                    icon.classList.add('text-purple-400');
                }

                const radioFill = btnElement.querySelector('.ow-client-radio-fill');
                const radioBorder = btnElement.querySelector('.ow-client-radio');
                if (radioFill) radioFill.classList.add('opacity-100');
                if (radioBorder) { radioBorder.classList.remove('border-white/10', 'bg-black/40'); radioBorder.classList.add('border-purple-500', 'bg-purple-500/10'); }
            }

            const textEl = document.getElementById('owVersionSelect');
            textEl.innerHTML = '<option value="">-- Select Version --</option>';
            if (client) {
                const existingVersions = window.repoData[client] || [];
                existingVersions.forEach(v => {
                    textEl.innerHTML += `<option value="${v}">${v === 'base' ? 'Original (base)' : v.toUpperCase()}</option>`;
                });
            }
            window.updateOwSubmitState();
        };

        window.resetOverwrite = () => {
            document.getElementById('owForm').reset();
            document.getElementById('owForm').classList.remove('hidden');
            document.getElementById('owResultBox').classList.add('hidden');
            document.getElementById('owFilesList').classList.add('hidden');
            document.getElementById('owVersionSelect').innerText = "Awaiting selection...";
            document.getElementById('owClientSelect').value = "";

            document.querySelectorAll('.ow-client-btn').forEach(b => {
                b.classList.remove('bg-purple-500/20', 'border-purple-500/50');
                b.classList.add('bg-black/40', 'border-white/5');
                b.querySelector('span').classList.remove('text-white');
                b.querySelector('span').classList.add('text-gray-300');
            });

            document.getElementById('owSubmitBtn').disabled = true;
            overwriteFiles = [];

            const container = document.getElementById('owPasteContainer');
            if (container) {
                container.innerHTML = `
                    <div class="glass-card code-editor-shell rounded-[2rem] overflow-hidden flex flex-col shadow-lg ow-paste-block mb-4">
                        <div class="code-editor-header flex justify-between items-center px-6 py-4 bg-black/40 border-b border-white/5 backdrop-blur-md gap-4">
                            <div class="flex items-center gap-3 w-full max-w-sm">
                                <i data-feather="file" class="w-4 h-4 text-purple-400 shrink-0"></i>
                                <input type="text" class="ow-paste-filename input-dark w-full rounded-lg px-3 py-1.5 text-sm font-mono text-white bg-black/50 border-white/10 focus:border-purple-500" placeholder="e.g. index.html" value="index.html">
                            </div>
                            <button type="button" class="text-gray-500 hover:text-red-400 p-2 rounded-xl hover:bg-red-500/10 border border-transparent hover:border-red-500/20 transition-all hidden ow-paste-remove" title="Remove File" onclick="this.closest('.ow-paste-block').remove(); updateOwSubmitState();"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        <textarea placeholder="Paste HTML/CSS/JS code here..." class="ow-paste-content code-editor-textarea w-full h-[300px] bg-black/20 text-gray-300 p-6 font-mono text-[13px] leading-relaxed focus:outline-none focus:bg-white/[0.02] transition-colors resize-none rounded-none"></textarea>
                    </div>
                `;
            }
            if (window.feather) feather.replace();
        };
        document.getElementById('owVersionSelect').addEventListener('change', window.updateOwSubmitState);


        // Mode Switchers
        const owModeUploadBtn = document.getElementById('owModeUploadBtn');
        const owModePasteBtn = document.getElementById('owModePasteBtn');
        const owUploadModeBox = document.getElementById('owUploadModeBox');
        const owPasteModeBox = document.getElementById('owPasteModeBox');

        if (owModeUploadBtn && owModePasteBtn) {
            const activeClass = "flex-1 justify-center px-4 py-3 rounded-xl bg-white/10 text-white border border-white/20 shadow-[0_0_15px_rgba(255,255,255,0.05)] transition-all flex items-center gap-2 whitespace-nowrap";
            const inactiveClass = "flex-1 justify-center px-4 py-3 rounded-xl text-gray-500 hover:text-white hover:bg-white/5 border border-transparent transition-all flex items-center gap-2 whitespace-nowrap";

            owModeUploadBtn.addEventListener('click', () => {
                isOwPasteMode = false;
                owModeUploadBtn.className = activeClass;
                owModePasteBtn.className = inactiveClass;
                owUploadModeBox.classList.remove('hidden'); owUploadModeBox.classList.add('flex');
                owPasteModeBox.classList.add('hidden'); owPasteModeBox.classList.remove('flex');
                updateOwSubmitState();
            });

            owModePasteBtn.addEventListener('click', () => {
                isOwPasteMode = true;
                owModePasteBtn.className = activeClass;
                owModeUploadBtn.className = inactiveClass;
                owPasteModeBox.classList.remove('hidden'); owPasteModeBox.classList.add('flex');
                owUploadModeBox.classList.add('hidden'); owUploadModeBox.classList.remove('flex');
                updateOwSubmitState();
            });
        }

        // Add Paste Block
        const owAddPasteBlockBtn = document.getElementById('owAddPasteBlockBtn');
        const owPasteContainer = document.getElementById('owPasteContainer');
        if (owAddPasteBlockBtn) {
            owAddPasteBlockBtn.addEventListener('click', () => {
                const block = document.createElement('div');
                block.className = 'glass-card code-editor-shell rounded-[2rem] overflow-hidden flex flex-col shadow-lg ow-paste-block animate-fade-in mb-4';
                block.innerHTML = `
                    <div class="code-editor-header flex justify-between items-center px-6 py-4 bg-black/40 border-b border-white/5 backdrop-blur-md gap-4">
                        <div class="flex items-center gap-3 w-full max-w-sm">
                            <i data-feather="file" class="w-4 h-4 text-amber-400 shrink-0"></i>
                            <input type="text" class="ow-paste-filename input-dark w-full rounded-lg px-3 py-1.5 text-sm font-mono text-white bg-black/50 border-white/10 focus:border-amber-500" placeholder="e.g. about.html">
                        </div>
                        <button type="button" class="text-gray-500 hover:text-red-400 p-2 rounded-xl hover:bg-red-500/10 border border-transparent hover:border-red-500/20 transition-all ow-paste-remove" title="Remove File" onclick="this.closest('.ow-paste-block').remove(); updateOwSubmitState();"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                    </div>
                    <textarea placeholder="Paste HTML/CSS/JS code here..." class="ow-paste-content code-editor-textarea w-full h-[300px] bg-black/20 text-gray-300 p-6 font-mono text-[13px] leading-relaxed focus:outline-none focus:bg-white/[0.02] transition-colors resize-none rounded-none"></textarea>
                `;
                owPasteContainer.appendChild(block);
                feather.replace();
                document.querySelectorAll('.ow-paste-remove').forEach(el => el.classList.remove('hidden'));
                updateOwSubmitState();
            });
        }

        // Submit Revision
        document.getElementById('owForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const client = document.getElementById('owClientSelect').value;
            const version = document.getElementById('owVersionSelect').value;
            if (!client) return;

            let finalRevisionFiles = [];

            if (isOwPasteMode) {
                const blocks = document.querySelectorAll('.ow-paste-block');
                blocks.forEach(block => {
                    const name = block.querySelector('.ow-paste-filename').value.trim();
                    const content = block.querySelector('.ow-paste-content').value;
                    if (name && content) finalRevisionFiles.push({ name, content });
                });
                if (finalRevisionFiles.length === 0) return window.showToast("Please provide valid filenames and content.", "error");
            } else {
                if (overwriteFiles.length === 0) return window.showToast("Please upload files first.", "error");
                finalRevisionFiles = overwriteFiles;
            }

            const selectedOwVersion = document.getElementById('owVersionSelect').value;
            const confirmMsg = `OVERWRITING <span class="text-amber-400 font-bold">${selectedOwVersion === 'base' ? 'Original (base)' : selectedOwVersion.toUpperCase()}</span> in <span class="text-white font-mono">/${client}</span><br><br><span class="text-xs text-gray-400 uppercase tracking-widest font-bold">${finalRevisionFiles.length} File(s) Queued</span>`;

            window.openDeployConfirmModal(confirmMsg, async (commitMsg) => {
                const btn = document.getElementById('owSubmitBtn');
                btn.disabled = true;
                document.getElementById('owBtnText').innerText = "Overwriting Branch...";

                try {
                    if (auth.currentUser) currentIdToken = await auth.currentUser.getIdToken();
                    const response = await fetch(API_DEPLOY, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentIdToken}` },
                        body: JSON.stringify({ folderName: client, version: selectedOwVersion, files: finalRevisionFiles })
                    });
                    const result = await response.json();

                    if (result.success) {
                        // Admin Telegram Notification
                        fetch('https://asia-southeast1-b2b-software.cloudfunctions.net/reputifly', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                _to: 'runikojane@gmail.com',
                                _subject: `Deployment Revision: /${client} (${selectedOwVersion})`,
                                _sender_name: 'Reputifly System Logs',
                                Action: 'Revision Deployed',
                                Project: `/${client}`,
                                Version: selectedOwVersion,
                                FilesQueued: finalRevisionFiles.length,
                                DeployedBy: window.currentUserEmail || 'Unknown',
                                CommitMessage: commitMsg,
                                Timestamp: new Date().toLocaleString()
                            })
                        }).catch(() => { }); // silent fail

                        document.getElementById('owForm').classList.add('hidden');
                        const resBox = document.getElementById('owResultBox');
                        resBox.classList.remove('hidden');

                        let outputHtml = '';
                        let copyText = '';

                        // Only generate shareable links for HTML files
                        const htmlFiles = finalRevisionFiles.filter(f => f.name.toLowerCase().endsWith('.html'));

                        if (htmlFiles.length === 0) {
                            // Fallback: If no HTML files are found, just provide the root directory link
                            const rootUrl = `https://samples.reputifly.org/${client}/${selectedOwVersion}/`;
                            outputHtml = `<div class="mb-2"><span class="text-amber-400 font-bold">App Root Directory:</span> <br><a href="${rootUrl}" target="_blank" class="text-blue-400 hover:underline break-all">${rootUrl}</a></div>`;
                            copyText = `App Root Directory:\n${rootUrl}\n\n`;
                        } else {
                            htmlFiles.forEach(f => {
                                let title = f.name;
                                if (title.toLowerCase() === 'index.html') title = 'Home Page';
                                else {
                                    // Strip folder paths if they exist (e.g. pages/about.html -> about)
                                    const nameParts = title.split('/');
                                    title = nameParts[nameParts.length - 1].replace('.html', '');
                                    title = title.charAt(0).toUpperCase() + title.slice(1) + ' Page';
                                }
                                const url = `https://samples.reputifly.org/${client}/${selectedOwVersion}/${f.name === 'index.html' ? '' : f.name}`;

                                outputHtml += `<div class="mb-2"><span class="text-amber-400 font-bold">${title}:</span> <br><a href="${url}" target="_blank" class="text-blue-400 hover:underline break-all">${url}</a></div>`;
                                copyText += `${title}:\n${url}\n\n`;
                            });
                        }

                        document.getElementById('owLinksOutput').innerHTML = outputHtml;

                        document.getElementById('owCopyBtn').onclick = () => {
                            navigator.clipboard.writeText(copyText.trim());
                            document.getElementById('owCopyBtn').innerHTML = '<i data-feather="check" class="w-5 h-5"></i> Copied Format!';
                            feather.replace();
                            setTimeout(() => { document.getElementById('owCopyBtn').innerHTML = '<i data-feather="copy" class="w-5 h-5"></i> Copy Links for WhatsApp'; feather.replace(); }, 2000);
                        };
                    } else window.showToast("Error: " + result.error, "error");
                } catch (err) { window.showToast("Network Error.", "error"); }
            });
        });

        window.resetOverwrite = () => {
            document.getElementById('owForm').reset();
            document.getElementById('owForm').classList.remove('hidden');
            document.getElementById('owResultBox').classList.add('hidden');
            document.getElementById('owFilesList').classList.add('hidden');
            document.getElementById('owVersionSelect').innerText = "Awaiting selection...";
            document.getElementById('owClientSelect').value = "";

            document.querySelectorAll('.ow-client-btn').forEach(b => {
                b.classList.remove('bg-amber-500/20', 'border-amber-500/50');
                b.classList.add('bg-black/40', 'border-white/5');
                b.querySelector('span').classList.remove('text-white');
                b.querySelector('span').classList.add('text-gray-300');
            });

            document.getElementById('owSubmitBtn').disabled = true;
            overwriteFiles = [];

            const container = document.getElementById('owPasteContainer');
            if (container) {
                container.innerHTML = `
                    <div class="glass-card code-editor-shell rounded-[2rem] overflow-hidden flex flex-col shadow-lg ow-paste-block mb-4">
                        <div class="code-editor-header flex justify-between items-center px-6 py-4 bg-black/40 border-b border-white/5 backdrop-blur-md gap-4">
                            <div class="flex items-center gap-3 w-full max-w-sm">
                                <i data-feather="file" class="w-4 h-4 text-amber-400 shrink-0"></i>
                                <input type="text" class="ow-paste-filename input-dark w-full rounded-lg px-3 py-1.5 text-sm font-mono text-white bg-black/50 border-white/10 focus:border-amber-500" placeholder="e.g. index.html" value="index.html">
                            </div>
                            <button type="button" class="text-gray-500 hover:text-red-400 p-2 rounded-xl hover:bg-red-500/10 border border-transparent hover:border-red-500/20 transition-all hidden ow-paste-remove" title="Remove File" onclick="this.closest('.ow-paste-block').remove(); updateOwSubmitState();"><i data-feather="trash-2" class="w-4 h-4"></i></button>
                        </div>
                        <textarea placeholder="Paste HTML/CSS/JS code here..." class="ow-paste-content code-editor-textarea w-full h-[300px] bg-black/20 text-gray-300 p-6 font-mono text-[13px] leading-relaxed focus:outline-none focus:bg-white/[0.02] transition-colors resize-none rounded-none"></textarea>
                    </div>
                `;
            }
            if (window.feather) feather.replace();
        };

        // ==========================================

        // TAB 3: STAGING REPOSITORY & ACCORDION
        // ==========================================
        window.toggleAccordion = (client) => {
            const div = document.getElementById(`versions-${client}`);
            const icon = document.getElementById(`icon-${client}`);
            if (div.classList.contains('hidden')) {
                div.classList.remove('hidden'); div.classList.add('flex');
                icon.style.transform = 'rotate(180deg)';
            } else {
                div.classList.add('hidden'); div.classList.remove('flex');
                icon.style.transform = 'rotate(0deg)';
            }
        };

        window.loadSamples = async (silent = false) => {
            const grid = document.getElementById('samplesList');
            const syncBtn = document.getElementById('syncBtn');
            const dropdown = document.getElementById('revClientSelect');

            if (!silent) {
                syncBtn.innerHTML = '<i data-feather="loader" class="animate-spin w-4 h-4 text-blue-400"></i> Syncing...'; feather.replace();
            }

            try {
                if (auth.currentUser) currentIdToken = await auth.currentUser.getIdToken();
                if (!currentIdToken) return; // FIX: Prevent 500 API crash if token is slightly delayed

                const res = await fetch(API_LIST, { headers: { 'Authorization': `Bearer ${currentIdToken}` } });
                const data = await res.json();

                if (data.success) {
                    // CRITICAL SECURITY: Boot non-staff out of the admin portal
                    if (data.userRole === 'client' || data.userRole === 'none') {
                        window.location.href = 'client.html';
                        return;
                    }

                    const folders = data.folders || {};
                    if (typeof data.isSuperAdmin === 'boolean') {
                        window.isSuperAdmin = data.isSuperAdmin;
                    }
                    window.repoData = folders; // Save for dropdown / permissions

                    // Update Revision Client List & Portal Dropdowns
                    const revListContainer = document.getElementById('revClientListContainer');
                    const owListContainer = document.getElementById('owClientListContainer');
                    const portalDropdown = document.getElementById('portalClientSelect');
                    const modalClientSelect = document.getElementById('modalClientSelect');

                    if (revListContainer) revListContainer.innerHTML = '';
                    if (owListContainer) owListContainer.innerHTML = '';
                    if (portalDropdown) portalDropdown.innerHTML = '<option value="NONE">-- No Project Set Yet --</option>';
                    if (modalClientSelect) modalClientSelect.innerHTML = '<option value="NONE">-- No Project Set Yet --</option>';

                    let hasClients = false;
                    Object.keys(folders).forEach(client => {
                        if (client.toLowerCase() !== 'index.html') {
                            hasClients = true;
                            if (portalDropdown) portalDropdown.innerHTML += `<option value="${client}">${client}</option>`;
                            if (modalClientSelect) modalClientSelect.innerHTML += `<option value="${client}">${client}</option>`;

                            if (revListContainer) {
                                revListContainer.innerHTML += `
                                    <button type="button" class="rev-client-btn w-full text-left px-5 py-4 rounded-2xl border border-white/5 bg-white/[0.02] hover:bg-white/[0.05] hover:border-purple-500/30 transition-all flex items-center justify-between group mb-2.5" data-client="${client}" onclick="selectRevClient('${client}', this)">
                                        <div class="flex items-center gap-3 min-w-0">
                                            <span class="font-bold text-gray-400 group-hover:text-white text-sm truncate font-mono transition-colors pl-2">/${client}</span>
                                        </div>
                                        <div class="w-5 h-5 rounded-full border-2 border-white/10 group-hover:border-purple-500/50 transition-colors rev-client-radio flex items-center justify-center shrink-0 bg-black/40">
                                            <div class="w-2.5 h-2.5 rounded-full bg-purple-500 opacity-0 transition-opacity rev-client-radio-fill shadow-[0_0_10px_rgba(168,85,247,0.8)]"></div>
                                        </div>
                                    </button>
                                `;
                            }
                            if (owListContainer) {
                                owListContainer.innerHTML += `
                                    <button type="button" class="ow-client-btn w-full text-left px-5 py-4 rounded-2xl border border-white/5 bg-white/[0.02] hover:bg-white/[0.05] hover:border-purple-500/30 transition-all flex items-center justify-between group mb-2.5" data-client="${client}" onclick="selectOwClient('${client}', this)">
                                        <div class="flex items-center gap-3 min-w-0">
                                            <span class="font-bold text-gray-400 group-hover:text-white text-sm truncate font-mono transition-colors pl-2">/${client}</span>
                                        </div>
                                        <div class="w-5 h-5 rounded-full border-2 border-white/10 group-hover:border-purple-500/50 transition-colors ow-client-radio flex items-center justify-center shrink-0 bg-black/40">
                                            <div class="w-2.5 h-2.5 rounded-full bg-purple-500 opacity-0 transition-opacity ow-client-radio-fill shadow-[0_0_10px_rgba(168,85,247,0.8)]"></div>
                                        </div>
                                    </button>
                                `;
                            }
                        }
                    });

                    if (!hasClients) {
                        if (revListContainer) revListContainer.innerHTML = '<div class="text-sm text-gray-500 text-center py-4">No clients available.</div>';
                        if (owListContainer) owListContainer.innerHTML = '<div class="text-sm text-gray-500 text-center py-4">No clients available.</div>';
                    }

                    if (silent) return; // Stop UI update if just fetching for dropdown

                    grid.innerHTML = '';
                    const validClients = Object.keys(folders).filter(c => c.toLowerCase() !== 'index.html');

                    if (validClients.length === 0) {
                        grid.innerHTML = '<div class="p-12 text-center text-gray-500 font-medium">Repository is empty.</div>';
                    } else {
                        for (const client of validClients) {
                            const versions = folders[client];
                            let versionsHtml = '';
                            const revisions = versions.filter(v => v !== 'base');

                            if (revisions.length === 0) {
                                versionsHtml = '<div class="px-8 py-5 text-sm text-gray-500 font-medium italic">No current revisions. Click "New Branch" to create v1.</div>';
                            } else {
                                revisions.forEach((ver, index) => {
                                    const isLatest = index === revisions.length - 1;
                                    const urlPath = `${client}/${ver}`;

                                    versionsHtml += `
                                        <div class="repo-version-row flex flex-row items-center justify-between gap-3 py-4 px-4 sm:px-6 bg-white/[0.02] border-t border-white/5 hover:bg-white/5 transition-colors group/ver">
                                            <div class="repo-version-left flex items-center gap-3 sm:gap-4 pl-4 sm:pl-6 border-l-2 ${isLatest ? 'border-[#FF8A00]' : 'border-white/10'} min-w-0">
                                                <span class="font-mono text-xs sm:text-sm font-bold ${isLatest ? 'text-[#FF8A00]' : 'text-gray-400'}">${ver.toUpperCase()}</span>
                                                ${isLatest ? '<span class="text-[9px] bg-[#FF8A00]/20 text-[#FF8A00] px-2 py-0.5 rounded-full uppercase font-bold tracking-widest border border-[#FF8A00]/20">Active</span>' : ''}
                                            </div>
                                            <div class="repo-version-actions-wrap flex items-center justify-end">
                                                <button type="button" class="w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 text-gray-400 hover:text-white transition-colors flex items-center justify-center tooltip shadow-sm" title="Branch actions" onclick="event.stopPropagation(); openRepoActionsModalFromButton(this)" data-scope="version" data-client="${client}" data-ver="${ver}">
                                                    <i data-feather="edit-3" class="w-4 h-4 sm:w-5 sm:h-5"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                });
                            }

                            grid.innerHTML += `
                                <div class="flex flex-col group/client bg-black/40 border border-white/5 rounded-[18px] sm:rounded-[24px] mb-2 sm:mb-3 overflow-hidden shadow-lg">
                                    <div class="repo-card-header px-4 sm:px-8 py-4 sm:py-5 flex items-start sm:items-center justify-between gap-3 hover:bg-white/5 transition-colors cursor-pointer" onclick="toggleAccordion('${client}')">
                                        <div class="flex items-center gap-3 sm:gap-4 min-w-0">
                                            <div class="repo-card-icon w-10 h-10 sm:w-12 sm:h-12 rounded-2xl bg-gradient-to-tr from-blue-500/10 to-purple-500/10 border border-blue-500/20 flex items-center justify-center shrink-0">
                                                <i data-feather="folder" class="w-4 h-4 sm:w-5 sm:h-5 text-blue-400"></i>
                                            </div>
                                            <p class="repo-card-title font-bold text-base sm:text-xl text-white flex items-center gap-3 min-w-0">
                                                <span class="truncate">/${client}</span>
                                                <span class="hidden sm:inline-flex items-center justify-center px-3 py-1 text-[10px] font-extrabold uppercase tracking-wider text-[#FF8A00] bg-[#FF8A00]/10 border border-[#FF8A00]/20 rounded-full shadow-[0_0_10px_rgba(255,138,0,0.1)]">Sample</span>
                                            </p>
                                        </div>
                                        <div class="repo-card-meta flex items-center gap-2 sm:gap-4 shrink-0">
                                            <span class="revs-pill text-[10px] sm:text-xs text-gray-500 font-bold bg-white/5 px-3 py-1.5 rounded-full border border-white/5">${revisions.length} revs</span>
                                            <button type="button" class="w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 text-gray-400 hover:text-white transition-colors flex items-center justify-center tooltip shadow-lg" title="Manage Sample" onclick="event.stopPropagation(); openRepoActionsModalFromButton(this)" data-scope="base" data-client="${client}">
                                                <i data-feather="more-horizontal" class="w-5 h-5"></i>
                                            </button>
                                            <i data-feather="chevron-down" id="icon-${client}" class="w-5 h-5 sm:w-6 sm:h-6 text-gray-600 transition-transform"></i>
                                        </div>
                                    </div>

                                    <div id="versions-${client}" class="hidden flex-col bg-black/60 border-t border-white/5">
                                        ${versionsHtml}
                                    </div>
                                </div>
                            `;
                        }
                    }
                } else {
                    if (!silent) grid.innerHTML = `<div class="p-12 text-center text-red-400 font-bold">API Error: ${data.error}</div>`;
                }
            } catch (e) {
                if (!silent) grid.innerHTML = `<div class="p-12 text-center text-red-400 font-bold">Failed to sync. Check console.</div>`;
            }

            if (!silent) {
                syncBtn.innerHTML = '<i data-feather="refresh-cw" class="w-4 h-4 text-blue-400"></i> Sync Network';
                feather.replace();
            }
        };


        const repoActionsModal = document.getElementById('repoActionsModal');
        const repoActionsTitleEl = document.getElementById('repoActionsTitle');
        const repoActionsSubtitleEl = document.getElementById('repoActionsSubtitle');
        const repoActionsListEl = document.getElementById('repoActionsList');

        window.closeRepoActionsModal = () => {
            if (!repoActionsModal) return;
            repoActionsModal.classList.add('hidden');
            repoActionsModal.classList.remove('flex');
            if (repoActionsListEl) repoActionsListEl.innerHTML = '';
        };

        const repoActionItemHtml = ({ label, desc, icon = 'chevron-right', kind = 'button', href = null, onClick = null, tone = 'default', extraClass = '' }) => {
            const toneClass = tone === 'danger'
                ? 'text-red-300 border-red-500/20 bg-red-500/5'
                : tone === 'primary'
                    ? 'text-white border-[#FF8A00]/20 bg-[#FF8A00]/5'
                    : 'text-gray-200 border-white/10 bg-white/[0.02]';

            const baseFlex = extraClass ? extraClass : 'flex';
            const iconColor = tone === 'danger' ? 'text-red-400' : tone === 'primary' ? 'text-[#FF8A00]' : 'text-gray-400';

            if (kind === 'link') {
                return `<a href="${href}" target="_blank" class="repo-actions-modal-item w-full ${baseFlex} items-start gap-3 rounded-2xl border ${toneClass} px-4 py-3.5"><span class="shrink-0 mt-0.5 w-9 h-9 rounded-xl bg-black/30 border border-white/5 flex items-center justify-center"><i data-feather="${icon}" class="w-4 h-4 ${iconColor}"></i></span><span class="min-w-0 text-left"><span class="block font-bold text-sm">${label}</span><span class="block text-xs text-gray-400 leading-relaxed mt-1">${desc}</span></span><i data-feather="external-link" class="w-4 h-4 text-gray-500 ml-auto mt-1"></i></a>`;
            }
            return `<button type="button" onclick="${onClick}" class="repo-actions-modal-item w-full ${baseFlex} items-start gap-3 rounded-2xl border ${toneClass} px-4 py-3.5 text-left"><span class="shrink-0 mt-0.5 w-9 h-9 rounded-xl bg-black/30 border border-white/5 flex items-center justify-center"><i data-feather="${icon}" class="w-4 h-4 ${iconColor}"></i></span><span class="min-w-0"><span class="block font-bold text-sm">${label}</span><span class="block text-xs text-gray-400 leading-relaxed mt-1">${desc}</span></span></button>`;
        };

        window.openRepoActionsModalFromButton = (btn) => {
            if (!btn) return;
            const client = btn.dataset.client;
            const scope = btn.dataset.scope;
            const ver = btn.dataset.ver || 'base';
            if (!client || !scope) return;

            const isBase = scope === 'base';
            const labelTarget = isBase ? `/${client}` : `/${client}  ${ver.toUpperCase()}`;
            repoActionsTitleEl.textContent = labelTarget;
            repoActionsSubtitleEl.textContent = isBase
                ? 'Base sample actions for this client directory. (VS Code hidden on mobile to keep it clean)'
                : `Branch actions for ${ver.toUpperCase()}. Pick what you need.`;

            const path = isBase ? `${client}` : `${client}/${ver}`;
            const items = [];
            items.push(repoActionItemHtml({
                kind: 'link',
                label: 'Open Live',
                desc: isBase ? 'View the <b class="text-white">base sample URL</b> in a new tab.' : 'Open this <b class="text-white">revision branch URL</b> for QA / preview.',
                icon: 'external-link',
                href: `https://samples.reputifly.org/${path}/`
            }));

            if (window.isSuperAdmin) {
                items.push(repoActionItemHtml({
                    kind: 'link',
                    label: 'Open in VS Code',
                    desc: 'Open this specific folder directly in <b class="text-white">GitHub VS Code</b> editor.',
                    icon: 'monitor',
                    href: `https://github.dev/aakiraakira/reputifly-samples/tree/main/${path}`,
                    extraClass: 'hidden sm:flex'
                }));
            }

            items.push(repoActionItemHtml({
                kind: 'button',
                label: 'Download ZIP',
                desc: isBase ? 'Download the base sample as a ZIP for handoff or backup.' : 'Download this exact revision as a ZIP for employee/client use.',
                icon: 'download',
                onClick: `closeRepoActionsModal(); downloadVersionZip('${client}', '${ver}')`
            }));

            if (isBase) {
                items.push(repoActionItemHtml({
                    kind: 'button',
                    label: 'Create New Branch',
                    desc: 'Create the next revision branch from the base sample.',
                    icon: 'git-branch',
                    tone: 'primary',
                    onClick: `closeRepoActionsModal(); cloneVersion('${client}', 'base')`
                }));
                items.push(repoActionItemHtml({
                    kind: 'button',
                    label: 'Delete Client Directory',
                    desc: 'Deletes the client folder and all revision branches. Use with caution.',
                    icon: 'trash-2',
                    tone: 'danger',
                    onClick: `closeRepoActionsModal(); deleteSample('${client}')`
                }));
            } else {
                items.push(repoActionItemHtml({
                    kind: 'button',
                    label: 'Overwrite Revision',
                    desc: 'Open editor and replace this specific version with updated code.',
                    icon: 'edit-2',
                    onClick: `closeRepoActionsModal(); editSample('${client}', '${ver}')`
                }));
                items.push(repoActionItemHtml({
                    kind: 'button',
                    label: 'Duplicate Revision',
                    desc: 'Clone this version to create the next branch (quick branching).',
                    icon: 'copy',
                    tone: 'primary',
                    onClick: `closeRepoActionsModal(); cloneVersion('${client}', '${ver}')`
                }));
                items.push(repoActionItemHtml({
                    kind: 'button',
                    label: 'Delete Revision',
                    desc: 'Delete only this branch version. Do this only if it is no longer needed.',
                    icon: 'trash-2',
                    tone: 'danger',
                    onClick: `closeRepoActionsModal(); deleteSample('${client}', '${ver}')`
                }));
            }

            repoActionsListEl.innerHTML = items.join('');
            repoActionsModal.classList.remove('hidden');
            repoActionsModal.classList.add('flex');
            feather.replace();
        };

        repoActionsModal?.addEventListener('click', (e) => {
            if (e.target === repoActionsModal) closeRepoActionsModal();
        });

        const triggerBlobDownload = (blob, filename) => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(a.href), 2000);
        };

        const addFolderToZipFromGitHub = async (zip, repoPath, zipFolder) => {
            const apiUrl = `https://api.github.com/repos/aakiraakira/reputifly-samples/contents/${repoPath}`;
            const res = await fetch(apiUrl);
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error((data && data.message) || `GitHub API ${res.status}`);
            if (!Array.isArray(data)) throw new Error('Unexpected GitHub response for folder listing.');

            for (const item of data) {
                if (item.type === 'dir') {
                    const childFolder = zipFolder.folder(item.name);
                    await addFolderToZipFromGitHub(zip, item.path, childFolder);
                } else if (item.type === 'file') {
                    const fileRes = await fetch(item.download_url);
                    if (!fileRes.ok) throw new Error(`Failed to fetch ${item.path}`);
                    const fileBlob = await fileRes.blob();
                    zipFolder.file(item.name, fileBlob);
                }
            }
        };

        window.downloadVersionZip = async (client, ver = 'base') => {
            const targetPath = ver === 'base' ? client : `${client}/${ver}`;
            const pretty = ver === 'base' ? `${client}-sample` : `${client}-${ver}`;
            const loadingId = `dl-${client}-${ver}`;
            const btns = Array.from(document.querySelectorAll(`[data-download-id="${loadingId}"]`));
            btns.forEach(btn => {
                btn.disabled = true;
                btn.dataset.prevHtml = btn.innerHTML;
                btn.innerHTML = '<i data-feather="loader" class="w-3.5 h-3.5 animate-spin"></i><span class="hidden sm:inline">Zipping...</span>';
            });
            feather.replace();

            try {
                const zip = new JSZip();
                const root = zip.folder(pretty);
                await addFolderToZipFromGitHub(zip, targetPath, root);
                const blob = await zip.generateAsync({ type: 'blob' });
                triggerBlobDownload(blob, `${pretty}.zip`);

                // Admin Telegram Notification
                fetch('https://asia-southeast1-b2b-software.cloudfunctions.net/reputifly', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        _to: 'runikojane@gmail.com',
                        _subject: `Files Downloaded: /${targetPath}`,
                        _sender_name: 'Reputifly System Logs',
                        Action: 'Source Code Downloaded',
                        Project: `/${targetPath}`,
                        DownloadedBy: window.currentUserEmail || 'Unknown',
                        Timestamp: new Date().toLocaleString()
                    })
                }).catch(() => { });

            } catch (e) {
                alert(`ZIP download failed: ${e.message || 'Unknown error.'}`);
            } finally {
                btns.forEach(btn => {
                    btn.disabled = false;
                    if (btn.dataset.prevHtml) btn.innerHTML = btn.dataset.prevHtml;
                });
                feather.replace();
            }
        };

        window.editSample = (folder, ver) => {
            // 1. Switch to the new Overwrite tab
            switchTab('overwrite');

            // 2. Find the correct client button and trigger the selection
            const clientBtn = document.querySelector(`.ow-client-btn[data-client="${folder}"]`);
            selectOwClient(folder, clientBtn);

            // 3. Auto-select the version in the dropdown (slight delay to let the DOM populate)
            setTimeout(() => {
                const versionSelect = document.getElementById('owVersionSelect');
                if (versionSelect) {
                    versionSelect.value = ver;
                    window.updateOwSubmitState();
                }
            }, 50);
        };

        let pendingClone = null;

        window.cloneVersion = (client, sourceVer) => {
            const existingVersions = window.repoData[client] || [];
            let nextNum = 1;
            const vNums = existingVersions.filter(v => v.startsWith('v')).map(v => parseInt(v.replace('v', '')));
            if (vNums.length > 0) nextNum = Math.max(...vNums) + 1;
            const targetVer = `v${nextNum}`;

            pendingClone = { client, sourceVer, targetVer };

            const displaySource = sourceVer === 'base' ? 'Original Sample' : sourceVer.toUpperCase();
            document.getElementById('cloneModalText').innerHTML = `Duplicating <b class="text-white">${displaySource}</b> into a new branch: <b class="text-[#FF8A00]">${targetVer.toUpperCase()}</b>`;

            const modal = document.getElementById('cloneModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => document.getElementById('cloneModalContent').classList.remove('scale-95'), 10);
            feather.replace();
        };

        window.closeCloneModal = () => {
            document.getElementById('cloneModalContent').classList.add('scale-95');
            setTimeout(() => {
                const modal = document.getElementById('cloneModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 200);
            pendingClone = null;
        };

        document.getElementById('confirmCloneBtn').addEventListener('click', async () => {
            if (!pendingClone) return;
            const { client, sourceVer, targetVer } = pendingClone;

            const btn = document.getElementById('confirmCloneBtn');
            btn.innerHTML = '<i data-feather="loader" class="animate-spin w-4 h-4"></i> Cloning...';
            feather.replace();

            try {
                if (auth.currentUser) currentIdToken = await auth.currentUser.getIdToken();
                const res = await fetch(API_CLONE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentIdToken}` },
                    body: JSON.stringify({ folderName: client, sourceVersion: sourceVer, targetVersion: targetVer })
                });
                const data = await res.json();
                if (data.success) {
                    // Admin Telegram Notification
                    fetch('https://asia-southeast1-b2b-software.cloudfunctions.net/reputifly', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            _to: 'runikojane@gmail.com',
                            _subject: `Branch Cloned: /${client}`,
                            _sender_name: 'Reputifly System Logs',
                            Action: 'Revision Branch Duplicated',
                            Project: `/${client}`,
                            Source: sourceVer,
                            Target: targetVer,
                            InitiatedBy: window.currentUserEmail || 'Unknown',
                            Timestamp: new Date().toLocaleString()
                        })
                    }).catch(() => { });

                    closeCloneModal();
                    loadSamples();
                    window.showToast("Branch successfully cloned!", "success");
                } else {
                    window.showToast("Clone Error: " + data.error, "error");
                    closeCloneModal();
                }
            } catch (e) {
                window.showToast("Network error during clone.", "error");
                closeCloneModal();
            }
            btn.innerHTML = 'Confirm Clone';
        });

        window.deleteSample = (client, ver = null) => {
            const msg = ver ? `Delete revision <b>${ver.toUpperCase()}</b> for <b>${client}</b>?` : `DANGER: Delete entire client folder <b>/${client}</b> and ALL revisions?`;

            window.openDangerModal(msg, async () => {
                try {
                    if (auth.currentUser) currentIdToken = await auth.currentUser.getIdToken();
                    const res = await fetch(API_DELETE, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentIdToken}` },
                        body: JSON.stringify({ folderName: client, version: ver })
                    });
                    const data = await res.json().catch(() => ({}));
                    if (res.ok && data.success) {
                        // Admin Telegram Notification
                        fetch('https://asia-southeast1-b2b-software.cloudfunctions.net/reputifly', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                _to: 'runikojane@gmail.com',
                                _subject: `Data Deleted: /${client}`,
                                _sender_name: 'Reputifly System Logs',
                                Action: ver ? 'Revision Deleted' : 'Base Folder & Revisions Deleted (DANGER)',
                                Project: `/${client}`,
                                VersionDeleted: ver || 'ALL VERSIONS',
                                DeletedBy: window.currentUserEmail || 'Unknown',
                                Timestamp: new Date().toLocaleString()
                            })
                        }).catch(() => { });

                        loadSamples();
                        window.showToast("Deletion successful.", "success");
                    }
                    else window.showToast(data.error || `Delete failed (HTTP ${res.status})`, "error");
                } catch (e) { window.showToast("Delete failed.", "error"); }
            });
        };

        // ADMIN LOGIC
        window.switchAdminTab = (tab) => {
            document.getElementById('adminStaffSection').classList.add('hidden');
            document.getElementById('adminClientSection').classList.add('hidden');
            document.getElementById('adminTabStaffBtn').className = "text-gray-500 font-bold hover:text-gray-300 border-b-2 border-transparent pb-2 px-2 transition-all";
            document.getElementById('adminTabClientBtn').className = "text-gray-500 font-bold hover:text-gray-300 border-b-2 border-transparent pb-2 px-2 transition-all";

            if (tab === 'staff') {
                document.getElementById('adminStaffSection').classList.remove('hidden');
                document.getElementById('adminTabStaffBtn').className = "text-white font-bold border-b-2 border-pink-500 pb-2 px-2 transition-all";
            } else {
                document.getElementById('adminClientSection').classList.remove('hidden');
                document.getElementById('adminTabClientBtn').className = "text-white font-bold border-b-2 border-amber-500 pb-2 px-2 transition-all";
            }
        };

        window.loadUsers = async () => {
            const staffDiv = document.getElementById('staffList');
            const clientDiv = document.getElementById('clientsList');
            if (staffDiv) staffDiv.innerHTML = '<div class="text-sm text-gray-400 p-4">Loading staff...</div>';
            if (clientDiv) clientDiv.innerHTML = '<div class="text-sm text-gray-400 p-4">Loading clients...</div>';

            try {
                currentIdToken = await auth.currentUser.getIdToken();
                const res = await fetch(API_ADMIN, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentIdToken}` },
                    body: JSON.stringify({ action: "list" })
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.success) throw new Error(data.error || `HTTP ${res.status}`);

                if (staffDiv) staffDiv.innerHTML = '';
                if (clientDiv) clientDiv.innerHTML = '';

                let staffCount = 0;
                let clientCount = 0;

                (data.users || []).forEach(u => {
                    if (u.isStaff) {
                        staffCount++;
                        const isSuper = u.uid === SUPER_ADMIN_UID;
                        staffDiv.innerHTML += `
                            <div class="flex justify-between items-center p-5 bg-white/5 rounded-2xl border border-white/5 text-sm transition-all hover:border-white/10 mb-3">
                                <div class="flex items-center gap-4 min-w-0">
                                    <div class="w-10 h-10 rounded-full bg-blue-500/10 border border-blue-500/20 flex items-center justify-center shrink-0"><i data-feather="user" class="w-5 h-5 text-blue-400"></i></div>
                                    <span class="text-base ${isSuper ? 'text-[#FF8A00] font-bold' : 'text-gray-200 font-medium'} truncate">${u.email} ${isSuper ? '<span class="ml-2 text-[9px] bg-[#FF8A00]/20 text-[#FF8A00] px-2 py-0.5 rounded-full border border-[#FF8A00]/30 tracking-widest">OWNER</span>' : ''}</span>
                                </div>
                                ${!isSuper ? `
                                <div class="flex items-center gap-2 shrink-0">
                                    <button onclick="openAccessModal('${u.email}')" class="text-blue-400 hover:text-blue-300 bg-blue-500/10 p-2.5 rounded-xl border border-blue-500/20 transition-colors tooltip" title="Manage Folders"><i data-feather="sliders" class="w-5 h-5"></i></button>
                                    <button onclick="deleteUser('${u.uid}','${u.email}')" class="text-red-400 hover:text-red-300 bg-red-500/10 p-2.5 rounded-xl border border-red-500/20 transition-colors tooltip" title="Revoke User"><i data-feather="user-minus" class="w-5 h-5"></i></button>
                                </div>
                                ` : ''}
                            </div>`;
                    } else {
                        clientCount++;
                        clientDiv.innerHTML += `
                            <div class="flex justify-between items-center p-5 bg-white/5 rounded-2xl border border-white/5 text-sm transition-all hover:border-white/10 mb-3">
                                <div class="flex items-center gap-4 min-w-0">
                                    <div class="w-10 h-10 rounded-full bg-amber-500/10 border border-amber-500/20 flex items-center justify-center shrink-0"><i data-feather="monitor" class="w-5 h-5 text-amber-400"></i></div>
                                    <div class="flex flex-col min-w-0">
                                        <span class="text-base text-gray-200 font-medium truncate">${u.email}</span>
                                        <span class="text-xs text-amber-400 font-mono mt-0.5 truncate">${u.clientProject ? '/' + u.clientProject : 'No Project Assigned'}</span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 shrink-0">
                                    <button onclick="openClientAccessModal('${u.email}', '${u.clientProject || 'NONE'}')" class="text-amber-400 hover:text-amber-300 bg-amber-500/10 p-2.5 rounded-xl border border-amber-500/20 transition-colors tooltip" title="Assign Project"><i data-feather="edit-2" class="w-5 h-5"></i></button>
                                    <button onclick="deleteUser('${u.uid}','${u.email}')" class="text-red-400 hover:text-red-300 bg-red-500/10 p-2.5 rounded-xl border border-red-500/20 transition-colors tooltip" title="Delete Client Account"><i data-feather="user-minus" class="w-5 h-5"></i></button>
                                </div>
                            </div>`;
                    }
                });

                if (staffCount === 0 && staffDiv) staffDiv.innerHTML = '<div class="text-sm text-gray-400 p-4">No staff accounts found.</div>';
                if (clientCount === 0 && clientDiv) clientDiv.innerHTML = '<div class="text-sm text-gray-400 p-4">No client accounts found.</div>';

                feather.replace();
            } catch (e) {
                if (staffDiv) staffDiv.innerHTML = `<div class="text-sm text-red-400 p-4">Failed to load: ${e.message}</div>`;
            }
        };

        window.deleteUser = (uid, email = null) => {
            window.openDangerModal(
                `Revoke access for <b>${email}</b>? This cannot be undone.`,
                async () => {
                    try {
                        currentIdToken = await auth.currentUser.getIdToken();
                        const res = await fetch(API_ADMIN, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentIdToken}` },
                            body: JSON.stringify({ action: "delete", targetUid: uid, email })
                        });
                        const data = await res.json().catch(() => ({}));
                        if (!res.ok || !data.success) throw new Error(data.error || `HTTP ${res.status}`);

                        // Admin Telegram Notification
                        fetch('https://asia-southeast1-b2b-software.cloudfunctions.net/reputifly', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                _to: 'runikojane@gmail.com',
                                _subject: `User Revoked: ${email}`,
                                _sender_name: 'Reputifly System Logs',
                                Action: 'User Access Revoked',
                                TargetEmail: email,
                                TargetUid: uid,
                                RevokedBy: window.currentUserEmail || 'Unknown',
                                Timestamp: new Date().toLocaleString()
                            })
                        }).catch(() => { });

                        await loadUsers();
                        window.showToast("User access revoked.", "success");
                    } catch (e) {
                        window.showToast("Delete user error: " + e.message, "error");
                    }
                }
            );
        };
        window.currentManageEmail = null;

        window.openAccessModal = async (email) => {
            window.currentManageEmail = (email || '').toLowerCase();
            document.getElementById('accessModalUser').innerText = window.currentManageEmail;
            const grid = document.getElementById('clientPermissionsGrid');
            grid.innerHTML = '<div class="col-span-full p-8 text-center text-gray-400 text-sm">Loading projects...</div>';

            let assigned = [];
            try {
                // Refresh repo list so modal always includes all current folders
                await loadSamples(true);

                currentIdToken = await auth.currentUser.getIdToken();
                const permsRes = await fetch(API_ADMIN, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentIdToken}` },
                    body: JSON.stringify({ action: "getProjects", email: window.currentManageEmail })
                });
                const permsData = await permsRes.json().catch(() => ({}));
                if (permsRes.ok && permsData.success) assigned = permsData.projects || [];
            } catch (e) {
                console.error("Failed to preload permissions:", e);
            }

            const assignedSet = new Set((assigned || []).map(x => String(x)));
            grid.innerHTML = '';
            const clients = Object.keys(window.repoData || {}).filter(c => c.toLowerCase() !== 'index.html');

            if (clients.length === 0) {
                grid.innerHTML = '<div class="col-span-full p-8 text-center text-gray-400 text-sm">No clients found in staging repository.</div>';
            } else {
                clients.forEach(client => {
                    const checked = assignedSet.has(client) ? 'checked' : '';
                    grid.innerHTML += `
                <label class="flex items-center justify-between p-4 bg-white/[0.02] border border-white/5 rounded-2xl cursor-pointer hover:bg-white/5 transition-all">
                    <div class="flex items-center gap-3 min-w-0">
                        <i data-feather="folder" class="w-4 h-4 text-blue-400 shrink-0"></i>
                        <span class="font-bold text-gray-200 text-sm truncate">/${client}</span>
                    </div>
                    <input type="checkbox" value="${client}" ${checked} class="client-checkbox w-5 h-5 rounded border-gray-600 bg-black/50 cursor-pointer shrink-0">
                </label>
            `;
                });
            }

            document.getElementById('accessModal').classList.remove('hidden');
            feather.replace();
        };

        window.closeAccessModal = () => {
            document.getElementById('accessModal').classList.add('hidden');
            window.currentManageEmail = null;
        };

        document.getElementById('savePermissionsBtn').addEventListener('click', async () => {
            if (!window.currentManageEmail) return;

            const btn = document.getElementById('savePermissionsBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-feather="loader" class="animate-spin w-4 h-4"></i> Saving...';
            feather.replace();

            const checkboxes = document.querySelectorAll('.client-checkbox');
            const selectedProjects = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            try {
                currentIdToken = await auth.currentUser.getIdToken();

                const payload = {
                    action: "setProjects",
                    email: window.currentManageEmail,
                    projects: selectedProjects
                };

                console.log("Saving permissions payload:", payload);

                const res = await fetch(API_ADMIN, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentIdToken}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json().catch(() => ({}));
                console.log("Save permissions response:", res.status, data);

                if (!res.ok || !data.success) {
                    throw new Error(data.error || `HTTP ${res.status}`);
                }

                closeAccessModal();
                await loadUsers();
                await loadSamples(true);
            } catch (e) {
                alert("Permissions save error: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                feather.replace();
            }
        });

        document.getElementById('createClientForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i data-feather="loader" class="animate-spin w-4 h-4 text-amber-400"></i> Creating...';
            feather.replace();

            const projectId = document.getElementById('portalClientSelect').value;
            const clientEmail = document.getElementById('portalClientEmail').value.trim();
            const clientPassword = document.getElementById('portalClientPassword').value;
            const notifyClient = document.getElementById('notifyClientEmail').checked;

            try {
                if (auth.currentUser) currentIdToken = await auth.currentUser.getIdToken();
                const res = await fetch(API_ADMIN, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentIdToken}` },
                    body: JSON.stringify({ action: "setClientEmail", projectId, clientEmail, clientPassword, notifyUser: notifyClient })
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.success) throw new Error(data.error || `HTTP ${res.status}`);

                // Admin Telegram Notification
                fetch('https://asia-southeast1-b2b-software.cloudfunctions.net/reputifly', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        _to: 'runikojane@gmail.com',
                        _subject: `New Client: ${clientEmail}`,
                        _sender_name: 'Reputifly System Logs',
                        Action: 'Client Account Created',
                        Email: clientEmail,
                        ProjectAssigned: projectId,
                        CreatedBy: window.currentUserEmail || 'Unknown',
                        Timestamp: new Date().toLocaleString()
                    })
                }).catch(() => { });

                document.getElementById('createClientForm').reset();
                await loadUsers();
                showCredentialsModal(clientEmail, clientPassword, 'client');
            } catch (err) {
                window.showToast("Creation error: " + err.message, 'error');
            } finally {
                btn.innerHTML = originalHtml;
                feather.replace();
            }
        });

        // Client Access Modal Logic
        window.currentEditClientEmail = null;

        window.openClientAccessModal = (email, currentProject) => {
            window.currentEditClientEmail = email;
            document.getElementById('clientAccessModalUser').innerText = email;
            document.getElementById('modalClientSelect').value = currentProject || 'NONE';
            document.getElementById('clientAccessModal').classList.remove('hidden');
        };

        window.closeClientAccessModal = () => {
            document.getElementById('clientAccessModal').classList.add('hidden');
            window.currentEditClientEmail = null;
        };

        document.getElementById('saveClientAccessBtn')?.addEventListener('click', async () => {
            if (!window.currentEditClientEmail) return;

            const btn = document.getElementById('saveClientAccessBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-feather="loader" class="animate-spin w-4 h-4"></i> Saving...';
            feather.replace();

            const projectId = document.getElementById('modalClientSelect').value;

            try {
                if (auth.currentUser) currentIdToken = await auth.currentUser.getIdToken();
                const res = await fetch(API_ADMIN, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentIdToken}` },
                    // Password not sent here so it doesn't overwrite anything
                    body: JSON.stringify({ action: "setClientEmail", projectId, clientEmail: window.currentEditClientEmail })
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.success) throw new Error(data.error || `HTTP ${res.status}`);

                window.showToast(projectId === 'NONE' ? `Project revoked for ${window.currentEditClientEmail}` : `Assigned /${projectId} to ${window.currentEditClientEmail}`, 'success');

                closeClientAccessModal();
                await loadUsers();
            } catch (err) {
                window.showToast("Update error: " + err.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                feather.replace();
            }
        });

        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalHtml = btn.innerHTML;
            btn.innerText = "Provisioning...";

            const newEmail = document.getElementById('newEmail').value.trim();
            const newPassword = document.getElementById('newPassword').value;

            try {
                currentIdToken = await auth.currentUser.getIdToken();
                const res = await fetch(API_ADMIN, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentIdToken}` },
                    body: JSON.stringify({
                        action: "create",
                        email: newEmail,
                        password: newPassword
                    })
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.success) {
                    throw new Error(data.error || `HTTP ${res.status}`);
                }

                // Admin Telegram Notification
                fetch('https://asia-southeast1-b2b-software.cloudfunctions.net/reputifly', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        _to: 'runikojane@gmail.com',
                        _subject: `New Employee: ${newEmail}`,
                        _sender_name: 'Reputifly System Logs',
                        Action: 'Staff Account Created',
                        Email: newEmail,
                        CreatedBy: window.currentUserEmail || 'Unknown',
                        Timestamp: new Date().toLocaleString()
                    })
                }).catch(() => { });

                document.getElementById('createUserForm').reset();
                await loadUsers();
                showCredentialsModal(newEmail, newPassword, 'admin');
            } catch (e) {
                alert("Create user error: " + e.message);
            } finally {
                btn.innerHTML = originalHtml;
                feather.replace();
            }
        });

        // Credentials Modal Logic
        let lastGeneratedCreds = "";

        window.showCredentialsModal = (email, password, type) => {
            const link = type === 'client' ? 'https://reputifly.org/foundry/client' : 'https://reputifly.org/foundry/';

            document.getElementById('credLink').innerText = link;
            document.getElementById('credEmail').innerText = email;
            document.getElementById('credPassword').innerText = password;

            lastGeneratedCreds = `*Your Reputifly Access*\n\nLogin Portal: ${link}\nEmail: ${email}\nPassword: ${password}`;

            document.getElementById('credentialsModal').classList.remove('hidden');
        };

        window.closeCredentialsModal = () => {
            document.getElementById('credentialsModal').classList.add('hidden');
        };

        document.getElementById('copyCredsBtn')?.addEventListener('click', () => {
            navigator.clipboard.writeText(lastGeneratedCreds);
            const btn = document.getElementById('copyCredsBtn');
            btn.innerHTML = '<i data-feather="check" class="w-4 h-4"></i> Copied!';
            feather.replace();
            setTimeout(() => {
                btn.innerText = 'Copy Details';
            }, 2000);
        });
    </script>
    </script>

    <div id="toastContainer"></div>
    <script>
        // Danger Modal Logic
        let pendingDangerAction = null;

        window.openDangerModal = (htmlText, action) => {
            document.getElementById('dangerModalText').innerHTML = htmlText;
            pendingDangerAction = action;
            document.getElementById('dangerModal').classList.remove('hidden');
        };

        window.closeDangerModal = () => {
            document.getElementById('dangerModal').classList.add('hidden');
            pendingDangerAction = null;
        };

        document.getElementById('dangerConfirmBtn').addEventListener('click', () => {
            if (pendingDangerAction) pendingDangerAction();
            closeDangerModal();
        });


        // Global Toast System
        window.showToast = (message, type = 'error') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            let icon = 'info';
            let iconColor = 'text-blue-400';
            if (type === 'error') { icon = 'alert-circle'; iconColor = 'text-red-400'; }
            if (type === 'success') { icon = 'check-circle'; iconColor = 'text-green-400'; }

            toast.innerHTML = `
                <i data-feather="${icon}" class="w-5 h-5 mt-0.5 ${iconColor} shrink-0"></i>
                <p class="text-sm font-medium text-gray-200 leading-relaxed">${message}</p>
            `;

            container.appendChild(toast);
            if (window.feather) feather.replace();

            // Trigger slide-in animation
            requestAnimationFrame(() => {
                setTimeout(() => toast.classList.add('show'), 10);
            });

            // Auto-remove after 4 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400); // Wait for transition
            }, 4000);
        };

        // Override the default browser alert globally
        window.alert = function (message) {
            window.showToast(message, 'error');
        };
    </script>
</body>

</html>
