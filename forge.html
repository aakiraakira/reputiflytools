<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reputifly | Brand Forge</title>
    <link rel="icon" type="image/png"
        href="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Cropper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lato:wght@400;700&family=Merriweather:wght@400;700&family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&family=Oswald:wght@500;700&family=Playfair+Display:wght@700&family=Poppins:wght@400;600;700&family=Raleway:wght@400;700&family=Roboto:wght@400;700&family=Source+Sans+3:wght@400;600&family=Space+Grotesk:wght@500;700&family=Work+Sans:wght@400;600&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-deep: #0B0A14;
            --panel-bg: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
            --accent: #E6397F;
            --accent-glow: #FF8A00;
        }

        body {
            background-color: var(--bg-deep);
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            color: #F0F0F0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow: hidden;
        }

        h1,
        h2,
        h3,
        .brand-font {
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -0.02em;
        }

        /* --- FIX: DROPDOWN VISIBILITY --- */
        select option {
            background-color: #050507;
            /* Dark Background */
            color: #F0F0F0;
            /* Light Text */
            padding: 10px;
        }

        /* --- UI: LUXURY SCROLLBAR --- */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            transition: background 0.2s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
            /* Pink on hover */
        }

        /* Preview Vars */
        #livePreview {
            --p-primary: #3b82f6;
            --p-accent: #E6397F;
            --p-bg: #ffffff;
            --p-text: #1e293b;
            --p-font-head: 'Inter';
            --p-font-body: 'Inter';
            --p-radius: 8px;
            --p-btn-radius: 8px;
            /* Separate var for buttons */
            /* New Vars */
            --p-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --p-blur: none;
            --p-card-bg: rgba(128, 128, 128, 0.05);
        }

        /* MOBILE FIX: Prevent zoom on input focus */
        @media screen and (max-width: 768px) {

            input,
            select,
            textarea {
                font-size: 16px !important;
            }
        }

        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px -5px rgba(230, 57, 127, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            color: #ccc;
            padding: 8px 16px;
            border-radius: 9999px;
            /* Pill */
            font-size: 13px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .input-glass {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 12px;
            /* Increased rounding */
            color: white;
            transition: 0.2s;
        }

        .input-glass:focus {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.05);
            outline: none;
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            transition: 0.2s;
            background: rgba(255, 255, 255, 0.02);
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: rgba(230, 57, 127, 0.05);
        }

        /* Preview Styles */
        .preview-frame {
            background: var(--p-bg);
            color: var(--p-text);
            font-family: var(--p-font-body);
            transition: 0.3s;
            transition-property: background, color, font-family, width, box-shadow;
        }

        .preview-h {
            font-family: var(--p-font-head);
        }

        .preview-btn {
            background: var(--p-primary);
            color: var(--p-on-primary);
            /* DYNAMIC TEXT COLOR */
            border-radius: var(--p-btn-radius);
            font-weight: 600;
        }

        .preview-card {
            background: var(--p-card-bg);
            backdrop-filter: var(--p-blur);
            box-shadow: var(--p-shadow);
            border: 1px solid var(--p-border);
            border-radius: var(--p-radius);
        }

        /* Semantic Token Usage in Preview */
        .preview-btn {
            background: var(--p-primary);
            color: white;
            border-radius: var(--p-btn-radius);
        }

        .preview-btn:hover {
            background: var(--p-primary-hover);
        }

        .preview-muted {
            color: var(--p-muted);
        }

        .preview-surface {
            background: var(--p-surface);
            border: 1px solid var(--p-border);
        }

        input[type="color"] {
            -webkit-appearance: none;
            appearance: none;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }

        .accent-text-gradient {
            background: var(--p-accent);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            -webkit-text-fill-color: transparent;
            display: inline-block;
            /* Helps with clipping sometimes */
        }

        /* UI ANIMATIONS */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-in {
            animation-duration: 0.3s;
            animation-fill-mode: both;
        }

        .fade-in {
            animation-name: fadeIn;
        }

        .slide-in-from-left-2 {
            animation-name: slideInLeft;
        }

        .slide-in-from-right-4 {
            animation-name: slideInRight;
        }

        .zoom-in {
            animation-name: zoomIn;
        }
    </style>
</head>

<body class="flex flex-col md:flex-row h-screen overflow-hidden bg-black text-white relative">

    <!-- Mobile Backdrop -->
    <div id="mobileBackdrop" onclick="toggleSidebar()"
        class="fixed inset-0 bg-black/80 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <!-- SIDEBAR -->
    <div id="sidebar"
        class="fixed inset-y-0 left-0 w-[85%] max-w-[400px] md:static md:w-[400px] flex-shrink-0 bg-[#0B0A14] border-r border-white/10 flex flex-col z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-[cubic-bezier(0.16,1,0.3,1)] shadow-2xl md:shadow-none h-full max-h-screen">

        <!-- Header -->
        <div class="p-6 border-b border-white/10 bg-[#0B0A14]/90 backdrop-blur shrink-0 z-10">
            <div class="flex items-center justify-center py-2">
                <img id="sidebarAgencyLogo"
                    src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png"
                    alt="Reputifly" class="h-10 w-auto object-contain hover:opacity-90 transition">
            </div>
            <div class="flex items-center justify-between mt-2">
                <span class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Brand Design</span>
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-white transition p-1">
                    <i data-feather="settings" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
            <div>
                <div class="flex justify-between mb-4">
                    <label class="text-xs font-bold text-gray-500 uppercase">Input Source</label>
                    <span id="aiBadge" class="text-[10px] text-gray-600 border border-gray-700 px-1 rounded">Offline
                        Mode</span>
                </div>

                <!-- TABS -->
                <div class="flex border-b border-white/10 mb-6">
                    <button id="tabLogo" onclick="switchTab('logo')"
                        class="flex-1 py-2 text-xs font-bold text-pink-400 border-b-2 border-pink-400 transition-colors">Logo
                        Available</button>
                    <button id="tabNoLogo" onclick="switchTab('nologo')"
                        class="flex-1 py-2 text-xs font-bold text-gray-500 hover:text-white border-b-2 border-transparent transition-colors">No
                        Logo</button>
                </div>

                <!-- TAB CONTENT: LOGO -->
                <div id="contentLogo">
                    <!-- Standard Upload -->
                    <div class="upload-zone p-6 text-center relative group mb-4 focus:outline-none focus:border-pink-500 transition-colors"
                        id="uploadZone" tabindex="0" onclick="document.getElementById('fileInput').click()"
                        onpaste="handleLogoPaste(event)">
                        <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleImage(this)">
                        <div id="uploadPlaceholder">
                            <i data-feather="image" class="w-8 h-8 mx-auto text-gray-600 mb-2"></i>
                            <p class="text-sm text-gray-400">Drop Logo (Click or Paste)</p>
                        </div>
                        <!-- Final Preview Image -->
                        <img id="previewImg" class="hidden max-h-32 mx-auto rounded shadow-lg object-contain">
                        <div
                            class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-xs text-white">
                            Change Image</div>
                    </div>

                    <!-- Cropper Container (Hidden by default) -->
                    <div id="cropperContainer" class="hidden flex flex-col gap-2 mb-4">
                        <div class="h-64 w-full bg-black/50 rounded overflow-hidden">
                            <img id="cropperImg" class="max-w-full">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="confirmCrop()" class="btn-primary w-full text-xs py-2">Confirm
                                Crop</button>
                            <button onclick="cancelCrop()"
                                class="btn-secondary w-full text-xs text-red-400 border-red-400/30">Cancel</button>
                        </div>
                    </div>

                    <!-- Detected Palette UI -->
                    <div id="detectedPaletteBox" class="hidden mb-4 p-3 bg-white/5 rounded-lg border border-white/5">
                        <p class="text-[10px] text-gray-500 uppercase font-bold mb-2">Colors Found in Image</p>
                        <div id="detectedSwatches" class="flex flex-wrap gap-2">
                            <!-- Swatches injected here -->
                        </div>
                    </div>
                </div>

                <!-- TAB CONTENT: NO LOGO -->
                <div id="contentNoLogo" class="hidden">
                    <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Brand Description /
                        Context</label>
                    <textarea id="brandContext" rows="3"
                        class="w-full input-glass px-3 py-2 text-xs text-gray-300 placeholder-gray-600"
                        placeholder="e.g. A futuristic fintech startup for Gen Z..."></textarea>
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-500 uppercase mb-3 block">Brand Palette
                    (Auto-Detected)</label>
                <!-- CONTRAST CHECKS -->
                <div class="grid grid-cols-1 gap-3">
                    <!-- Primary Row -->
                    <div class="bg-white/5 p-3 rounded-lg border border-white/5 relative group">
                        <div class="flex items-center gap-3 mb-2">
                            <input type="color" id="colPrimary" value="#3b82f6" data-original="#3b82f6"
                                oninput="updatePreview()">
                            <div class="flex-1">
                                <p class="text-[10px] text-gray-500 uppercase">Primary</p>
                                <p id="hexPrimary"
                                    class="text-xs font-mono cursor-pointer hover:text-pink-400 transition"
                                    onclick="copyHexToClipboard('#3b82f6', 'hexPrimary')" title="Click to copy">#3b82f6
                                </p>
                            </div>
                            <button onclick="resetColor('colPrimary')"
                                class="text-gray-600 hover:text-white opacity-0 group-hover:opacity-100 transition"
                                title="Reset Color"><i data-feather="refresh-cw" class="w-3 h-3"></i></button>
                            <button onclick="openColorModal('colPrimary', 'Primary')"
                                class="text-gray-500 hover:text-blue-400 opacity-0 group-hover:opacity-100 transition"
                                title="Pick from Image"><i data-feather="droplet" class="w-3 h-3"></i></button>
                        </div>
                        <div id="warnPrimary"
                            class="hidden flex items-center justify-between text-[10px] bg-red-400/10 text-red-400 px-2 py-1 rounded">
                            <span class="flex items-center gap-1"><i data-feather="alert-circle" class="w-3 h-3"></i>
                                Low Contrast (Text)</span>
                            <button onclick="fixContrast('primary')" class="underline hover:text-white">Fix</button>
                        </div>
                    </div>

                    <!-- Accent Row -->
                    <div class="bg-white/5 p-3 rounded-lg border border-white/5 relative group">
                        <div class="flex items-center gap-3 mb-2">
                            <input type="color" id="colAccent" value="#E6397F" data-original="#E6397F"
                                oninput="updatePreview()">
                            <div class="flex-1">
                                <p class="text-[10px] text-gray-500 uppercase">Accent</p>
                                <p id="hexAccent"
                                    class="text-xs font-mono cursor-pointer hover:text-pink-400 transition"
                                    onclick="copyHexToClipboard(this.innerText, 'hexAccent')" title="Click to copy">
                                    #E6397F</p>
                            </div>
                            <button onclick="resetColor('colAccent')"
                                class="text-gray-600 hover:text-white opacity-0 group-hover:opacity-100 transition"
                                title="Reset Color"><i data-feather="refresh-cw" class="w-3 h-3"></i></button>
                            <button onclick="openColorModal('colAccent', 'Accent')"
                                class="text-gray-500 hover:text-pink-400 opacity-0 group-hover:opacity-100 transition"
                                title="Pick from Image"><i data-feather="droplet" class="w-3 h-3"></i></button>
                        </div>
                        <!-- We typically check accent against BG for visibility -->
                        <div id="warnAccent"
                            class="hidden flex items-center justify-between text-[10px] bg-red-400/10 text-red-400 px-2 py-1 rounded">
                            <span class="flex items-center gap-1"><i data-feather="alert-circle" class="w-3 h-3"></i>
                                Hard to read on BG</span>
                            <button onclick="fixContrast('accent')" class="underline hover:text-white">Fix</button>
                        </div>
                    </div>

                    <!-- Bg & Text Pair -->
                    <div class="bg-white/5 p-3 rounded-lg border border-white/5 space-y-3 relative group">
                        <div class="flex items-center gap-3">
                            <input type="color" id="colBg" value="#FFFFFF" data-original="#FFFFFF"
                                oninput="updatePreview()">
                            <div class="flex-1">
                                <p class="text-[10px] text-gray-500 uppercase">Background</p>
                                <p id="hexBg" class="text-xs font-mono cursor-pointer hover:text-pink-400 transition"
                                    onclick="copyHexToClipboard(this.innerText, 'hexBg')" title="Click to copy">#FFFFFF
                                </p>
                            </div>
                            <button onclick="resetColor('colBg')"
                                class="text-gray-600 hover:text-white opacity-0 group-hover:opacity-100 transition"
                                title="Reset Color"><i data-feather="refresh-cw" class="w-3 h-3"></i></button>
                            <button onclick="openColorModal('colBg', 'Background')"
                                class="text-gray-500 hover:text-yellow-400 opacity-0 group-hover:opacity-100 transition"
                                title="Pick from Image"><i data-feather="droplet" class="w-3 h-3"></i></button>
                        </div>
                        <div class="flex items-center gap-3">
                            <input type="color" id="colText" value="#1e293b" data-original="#1e293b"
                                oninput="updatePreview()">
                            <div class="flex-1">
                                <p class="text-[10px] text-gray-500 uppercase">Text</p>
                                <p id="hexText" class="text-xs font-mono cursor-pointer hover:text-pink-400 transition"
                                    onclick="copyHexToClipboard(this.innerText, 'hexText')" title="Click to copy">
                                    #1e293b</p>
                            </div>
                            <button onclick="resetColor('colText')"
                                class="text-gray-600 hover:text-white opacity-0 group-hover:opacity-100 transition"
                                title="Reset Color"><i data-feather="refresh-cw" class="w-3 h-3"></i></button>
                            <button onclick="openColorModal('colText', 'Text')"
                                class="text-gray-500 hover:text-gray-400 opacity-0 group-hover:opacity-100 transition"
                                title="Pick from Image"><i data-feather="droplet" class="w-3 h-3"></i></button>
                        </div>
                        <div id="warnText"
                            class="hidden flex items-center justify-between text-[10px] bg-red-400/10 text-red-400 px-2 py-1 rounded">
                            <span class="flex items-center gap-1"><i data-feather="alert-circle" class="w-3 h-3"></i>
                                Unreadable Text</span>
                            <button onclick="fixContrast('text')" class="underline hover:text-white">Fix</button>
                        </div>
                        <!-- THEME TOGGLE -->
                        <button onclick="invertTheme()"
                            class="w-full mt-1 bg-white/5 border border-white/10 rounded py-1.5 text-xs text-gray-400 hover:text-white flex items-center justify-center gap-2 transition">
                            <i data-feather="sun" class="w-3 h-3"></i> Invert Light/Dark
                        </button>
                    </div>
                </div>
            </div>

            <div class="relative">
                <div class="flex justify-between mb-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">Typography & Shape</label>
                    <button onclick="askAI()" id="aiBtn"
                        class="text-[10px] flex items-center gap-1 text-pink-400 hover:text-pink-300 transition hidden border border-pink-500/30 px-2 py-0.5 rounded backdrop-blur-md bg-pink-500/10"><i
                            data-feather="zap" class="w-3 h-3"></i> Refine with AI</button>
                </div>

                <div class="space-y-3">
                    <select id="fontHead" class="w-full input-glass px-3 py-2 text-sm text-gray-300"
                        onchange="updatePreview()">
                        <option value="'Inter', sans-serif">Inter (Modern Sans)</option>
                        <option value="'Space Grotesk', sans-serif">Space Grotesk (Tech)</option>
                        <option value="'Playfair Display', serif">Playfair Display (Luxury Serif)</option>
                        <option value="'Roboto', sans-serif">Roboto (Clean)</option>
                        <option value="'Poppins', sans-serif">Poppins (Friendly)</option>
                        <option value="'Montserrat', sans-serif">Montserrat (Geometric)</option>
                        <option value="'Oswald', sans-serif">Oswald (Bold Condensed)</option>
                        <option value="'Raleway', sans-serif">Raleway (Elegant)</option>
                        <option value="'Merriweather', serif">Merriweather (Classic Serif)</option>
                        <option value="'Work Sans', sans-serif">Work Sans (Minimal)</option>
                    </select>

                    <select id="fontBody" class="w-full input-glass px-3 py-2 text-sm text-gray-300"
                        onchange="updatePreview()">
                        <option value="'Inter', sans-serif">Body: Inter</option>
                        <option value="'Roboto', sans-serif">Body: Roboto</option>
                    </select>

                    <div class="bg-white/5 p-3 rounded-lg border border-white/5">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] text-gray-500 uppercase font-bold">Base Radius</span>
                            <span id="radiusVal" class="text-[10px] font-mono text-pink-400">8px</span>
                        </div>
                        <input type="range" id="radiusInput" min="0" max="24" value="8"
                            class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer mb-3"
                            oninput="updateRadiusFromSlider(this.value)">

                        <div class="flex items-center gap-2 border-t border-white/5 pt-2">
                            <input type="checkbox" id="pillToggle" class="accent-pink-500 w-3 h-3"
                                onchange="togglePill(this.checked)">
                            <label for="pillToggle" class="text-xs text-gray-400 select-none cursor-pointer">Force Pill
                                Buttons</label>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 pt-2">
                        <div>
                            <span class="text-[10px] text-gray-500 uppercase mb-1 block">Shadows</span>
                            <select id="uiShadow" class="w-full input-glass px-2 py-1 text-xs text-gray-300"
                                onchange="updatePreview()">
                                <option value="none">Flat</option>
                                <option value="0 4px 6px -1px rgba(0, 0, 0, 0.1)">Soft</option>
                                <option
                                    value="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)">
                                    Heavy</option>
                                <option value="4px 4px 0px 0px rgba(0,0,0,1)">Retro</option>
                            </select>
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500 uppercase mb-1 block">Glass</span>
                            <select id="uiGlass" class="w-full input-glass px-2 py-1 text-xs text-gray-300"
                                onchange="updatePreview()">
                                <option value="none">Solid</option>
                                <option value="blur(12px)">Frosted</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agency Branding (Stamp) -->
            <div class="mb-4 pt-4 border-t border-white/10">
                <label class="text-xs font-bold text-gray-500 uppercase mb-2 block flex justify-between items-center">
                    Report Stamp
                    <span class="text-[10px] text-gray-600 font-normal normal-case">(Click or Paste)</span>
                </label>
                <div class="upload-zone p-3 text-center relative group focus:outline-none focus:border-pink-500 transition-colors"
                    id="stampZone" tabindex="0" onclick="document.getElementById('stampInput').click()"
                    onpaste="handleStampPaste(event)">
                    <input type="file" id="stampInput" class="hidden" accept="image/*"
                        onchange="handleStampUpload(this)">

                    <div id="stampPlaceholder" class="flex items-center justify-center gap-2 text-gray-500 py-1">
                        <i data-feather="award" class="w-4 h-4"></i>
                        <span class="text-xs">Upload Agency Logo</span>
                    </div>

                    <img id="stampPreview"
                        class="hidden h-10 mx-auto object-contain p-1.5 bg-[#0B0A14] rounded border border-white/10 shadow-sm">
                    <button id="clearStampBtn" onclick="clearStamp(event)"
                        class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hidden hover:bg-red-600 shadow-md transform hover:scale-110 transition">
                        <i data-feather="x" class="w-2 h-2"></i>
                    </button>
                </div>
            </div>

            <!-- FOOTER ACTIONS -->
            <div class="border-t border-white/10 pt-4 space-y-2">

                <!-- Main Exports -->
                <!-- Main Exports -->
                <button onclick="openAIPackager()"
                    class="btn-primary w-full h-12 flex items-center justify-center gap-2 rounded-xl text-sm font-semibold shadow-lg shadow-pink-500/20 hover:shadow-pink-500/40 transition-all mb-2 animate-pulse bg-gradient-to-r from-pink-500 to-orange-400 border-none">
                    <i data-feather="zap" class="w-4 h-4"></i> Generate AI Design Pack
                </button>
                <button onclick="openExportModal()"
                    class="btn-primary w-full h-12 flex items-center justify-center gap-2 rounded-xl text-sm font-semibold shadow-lg shadow-pink-500/20 hover:shadow-pink-500/40 transition-all">
                    <i data-feather="image" class="w-4 h-4"></i> Download Brand Kit
                </button>
                <button onclick="downloadJSON()"
                    class="btn-secondary w-full h-12 flex items-center justify-center gap-2 rounded-xl text-sm font-medium hover:bg-white/10 transition-all border border-white/10">
                    <i data-feather="code" class="w-4 h-4"></i> Download JSON
                </button>

                <!-- Advanced Toggle -->
                <div class="relative">
                    <button onclick="document.getElementById('advOptions').classList.toggle('hidden')"
                        class="w-full text-center text-[10px] text-gray-500 hover:text-white uppercase tracking-widest mt-2 cursor-pointer">
                        Advanced Options
                    </button>

                    <!-- Advanced Menu -->
                    <div id="advOptions"
                        class="hidden mt-2 space-y-2 bg-[#0B0A14] border border-white/10 p-2 rounded-lg">
                        <button onclick="exportSystemPrompt()"
                            class="btn-secondary w-full flex justify-center text-xs text-pink-300 border-pink-500/30">
                            <i data-feather="cpu" class="w-3 h-3"></i> AI Prompt
                        </button>
                        <button onclick="copyJSON()" class="btn-secondary w-full flex justify-center text-xs"
                            title="Copy JSON">
                            <i data-feather="copy" class="w-3 h-3"></i> Copy JSON to Clipboard
                        </button>
                        <button onclick="exportPrompt()" class="btn-secondary w-full flex justify-center text-xs"
                            title="Copy CSS">
                            <i data-feather="hash" class="w-3 h-3"></i> Copy CSS Variables
                        </button>
                    </div>
                </div>

            </div>
            <!-- Mobile Close -->
            <button onclick="toggleSidebar()"
                class="md:hidden w-full mt-4 bg-white/5 py-3 rounded text-sm text-gray-400">Close Menu</button>
        </div>
    </div>
    </div>

    </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal"
        class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-[#0B0A14] border border-white/10 rounded-xl p-6 w-[90%] max-w-sm shadow-2xl relative">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i
                    data-feather="x" class="w-5 h-5"></i></button>

            <h2 class="text-lg font-bold brand-font mb-6 flex items-center gap-2"><i data-feather="settings"
                    class="w-5 h-5 text-pink-500"></i> Settings</h2>

            <div class="space-y-4">
                <!-- Project Management -->
                <div class="space-y-2">
                    <p class="text-xs font-bold text-gray-500 uppercase">Project</p>
                    <div class="flex gap-2">
                        <button onclick="saveProject()"
                            class="btn-secondary flex-1 flex items-center justify-center gap-2"><i data-feather="save"
                                class="w-3 h-3"></i> Save</button>
                        <label class="btn-secondary flex-1 flex items-center justify-center gap-2 cursor-pointer">
                            <i data-feather="upload" class="w-3 h-3"></i> Load
                            <input type="file" id="loadInputModal" class="hidden" accept=".brand"
                                onchange="loadProject(this)">
                        </label>
                    </div>
                </div>

                <!-- API Key -->
                <div class="space-y-2">
                    <p class="text-xs font-bold text-gray-500 uppercase">AI Configuration</p>
                    <input type="password" id="apiKeyInputModal" placeholder="Paste Gemini API Key..."
                        class="w-full input-glass px-3 py-2 text-xs">
                    <button onclick="saveKey()" class="w-full btn-primary text-xs py-2">Save API Key</button>
                </div>

                <div class="border-t border-white/10 my-4"></div>

                <!-- Reset -->
                <button onclick="resetMemory()"
                    class="w-full text-xs text-red-400 hover:bg-red-400/10 py-2 rounded transition flex items-center justify-center gap-2 border border-red-400/20">
                    <i data-feather="trash-2" class="w-3 h-3"></i> Clear Memory & Reset Tool
                </button>
            </div>
        </div>
    </div>

    <!-- AI PACKAGER MODAL -->
    <div id="aiPackagerModal"
        class="fixed inset-0 bg-black/80 z-[70] hidden flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div
            class="bg-[#0B0A14] border border-pink-500/30 rounded-xl p-6 w-[90%] max-w-lg shadow-[0_0_30px_rgba(230,57,127,0.15)] relative">
            <button onclick="closeAIPackager()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i
                    data-feather="x" class="w-5 h-5"></i></button>

            <h2 class="text-xl font-bold brand-font mb-2 flex items-center gap-2">
                <i data-feather="zap" class="w-5 h-5 text-pink-500"></i> AI Website Packager
            </h2>
            <p class="text-xs text-gray-400 mb-6">Describe the website you want to build. Our AI will map the sitemap,
                design the layouts, and package it perfectly with your current Brand tokens.</p>

            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-widest flex justify-between">
                        Business & Scope Description <span class="text-red-400">*</span>
                    </label>
                    <textarea id="aiScopeInput" rows="4"
                        class="w-full input-glass px-3 py-2 text-sm text-gray-300 placeholder-gray-600"
                        placeholder="e.g. A luxury dental clinic in Singapore targeting high-end clientele. Need a Home, Services, About, and Contact page. Keep it very premium."></textarea>
                </div>

                <div id="aiPackagerLogArea"
                    class="bg-black/50 border border-white/5 rounded-lg p-3 font-mono text-[10px] text-gray-500 overflow-y-auto h-24 hidden flex flex-col gap-1">
                    > Waiting to start...
                </div>

                <div class="pt-4 border-t border-white/10">
                    <button id="btnGenerateAI" onclick="generateAIWebsitePack()"
                        class="btn-primary w-full h-12 text-sm font-bold bg-gradient-to-r from-pink-500 to-orange-400 border-none">
                        Generate & Download ZIP
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- DEVICE CONTROLS (Overlay) -->

    <!-- PREVIEW AREA (With Width Control) -->
    <div id="livePreviewWrapper" class="flex-1 bg-[#1e1e1e] relative overflow-hidden flex flex-col">

        <!-- Toolbar -->
        <!-- Toolbar (Removed) -->
        <!-- Mobile Toolbar -->
        <div
            class="h-14 bg-[#0B0A14] border-b border-white/10 flex items-center justify-between px-4 z-20 shrink-0 md:hidden">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white p-1">
                    <i data-feather="menu" class="w-5 h-5"></i>
                </button>
                <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png"
                    alt="Reputifly" class="h-6 w-auto object-contain">
            </div>
        </div>

        <!-- The Resizable Frame -->
        <div id="livePreview"
            class="flex-1 w-full mx-auto transition-all duration-500 ease-out flex flex-col justify-center items-center p-4 md:p-10 relative overflow-y-auto no-scrollbar preview-frame"
            style="max-width: 100%;">
            <!-- Noise BG -->
            <div
                class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 pointer-events-none fixed-bg">
            </div>

            <div class="max-w-4xl w-full z-10">
                <div class="flex items-center justify-between mb-12 opacity-80">
                    <div class="flex items-center gap-2">
                        <img id="navLogo" class="h-8 w-auto object-contain hidden" alt="Brand Logo">
                        <span id="navText" class="font-bold text-2xl preview-h tracking-tight hidden">BRAND.</span>
                    </div>
                    <button class="preview-btn px-6 py-2 text-sm font-bold shadow-md">Get Started</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
                    <div>
                        <span
                            class="text-xs font-bold uppercase tracking-widest opacity-50 mb-4 block accent-text-gradient">Est.
                            2026</span>
                        <h1 class="text-4xl md:text-6xl font-bold mb-6 leading-tight preview-h">
                            Design that <span class="accent-text-gradient">converts.</span>
                        </h1>
                        <p class="text-lg opacity-70 mb-8 leading-relaxed">
                            Strict design tokens ensure your brand never drifts. We build consistency into the code
                            itself.
                        </p>
                        <div class="flex flex-col md:flex-row gap-4">
                            <button
                                class="preview-btn px-8 py-3 text-base font-bold shadow-lg hover:opacity-90 transition">Start
                                Project</button>
                            <button
                                class="px-8 py-3 text-base font-bold border border-current rounded-[var(--p-btn-radius)] hover:bg-black/5 transition">Learn
                                More</button>
                        </div>
                    </div>

                    <div class="space-y-4 mt-8 md:mt-0">
                        <div class="preview-card p-6 flex items-center gap-4 shadow-sm">
                            <div class="w-12 h-12 rounded flex items-center justify-center p-primary-bg"
                                style="background: var(--p-primary); color: var(--p-on-primary)">
                                <i data-feather="check"></i>
                            </div>
                            <div>
                                <h3 class="font-bold preview-h">Consistent</h3>
                                <p class="text-xs preview-muted">Never off-brand</p>
                            </div>
                        </div>
                        <div class="preview-card p-6 flex items-center gap-4 shadow-sm"
                            style="border-left: 4px solid var(--p-accent)">
                            <div class="w-12 h-12 rounded flex items-center justify-center text-white"
                                style="background: var(--p-accent)">
                                <i data-feather="zap"></i>
                            </div>
                            <div>
                                <h3 class="font-bold preview-h">Fast</h3>
                                <p class="text-xs preview-muted">Instant Extraction</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST CONTAINER (Moved to top for availability) -->
    <div id="toast-container"
        class="fixed top-5 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col gap-2 pointer-events-none w-full max-w-sm items-center">
    </div>

    <script>
        feather.replace();
        const colorThief = new ColorThief();
        let currentRadius = '8px';
        let isPillMode = false;
        let activeTab = 'logo';
        let cropper = null;

        // Gradient State (Global)
        window.gradientMap = {
            primary: null,
            accent: null,
            bg: null,
            text: null
        };

        function switchTab(mode) {
            activeTab = mode;
            const logoBtn = document.getElementById('tabLogo');
            const noLogoBtn = document.getElementById('tabNoLogo');
            const logoContent = document.getElementById('contentLogo');
            const noLogoContent = document.getElementById('contentNoLogo');

            if (mode === 'logo') {
                logoBtn.classList.add('text-pink-400', 'border-pink-400');
                logoBtn.classList.remove('text-gray-500', 'border-transparent');
                noLogoBtn.classList.add('text-gray-500', 'border-transparent');
                noLogoBtn.classList.remove('text-pink-400', 'border-pink-400');

                logoContent.classList.remove('hidden');
                noLogoContent.classList.add('hidden');
            } else {
                noLogoBtn.classList.add('text-pink-400', 'border-pink-400');
                noLogoBtn.classList.remove('text-gray-500', 'border-transparent');
                logoBtn.classList.add('text-gray-500', 'border-transparent');
                logoBtn.classList.remove('text-pink-400', 'border-pink-400');

                noLogoContent.classList.remove('hidden');
                logoContent.classList.add('hidden');
            }
        }


        function updateRadiusFromSlider(val) {
            currentRadius = val + 'px';
            document.getElementById('radiusVal').innerText = currentRadius;
            updatePreview();
        }

        function togglePill(checked) {
            isPillMode = checked;
            updatePreview();
        }

        // Helper for Export
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `rgb(${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)})` : null;
        }

        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }

        function blendColors(color1, color2, percentage) {
            const rgb1 = hexToRgbVals(color1);
            const rgb2 = hexToRgbVals(color2);
            if (!rgb1 || !rgb2) return color1;

            const r = Math.round(rgb1[0] * (1 - percentage) + rgb2[0] * percentage);
            const g = Math.round(rgb1[1] * (1 - percentage) + rgb2[1] * percentage);
            const b = Math.round(rgb1[2] * (1 - percentage) + rgb2[2] * percentage);
            return rgbToHex(r, g, b);
        }

        function adjustBrightness(hex, percent) {
            const rgb = hexToRgbVals(hex);
            if (!rgb) return hex;

            const r = Math.min(255, Math.max(0, rgb[0] + (rgb[0] * percent / 100)));
            const g = Math.min(255, Math.max(0, rgb[1] + (rgb[1] * percent / 100)));
            const b = Math.min(255, Math.max(0, rgb[2] + (rgb[2] * percent / 100)));
            return rgbToHex(r, g, b);
        }

        function generateSemanticTokens({ primary, accent, background, text }) {
            const bgLum = getLuminance(...hexToRgbVals(background));
            const isBgDark = bgLum < 0.5;

            // 1. DYNAMIC BUTTON TEXT (on-primary)
            // Decide if text on top of primary should be White or Black
            const primLum = getLuminance(...hexToRgbVals(primary));
            const onPrimary = primLum > 0.6 ? '#000000' : '#ffffff';

            // 2. SAFER HOVER LOGIC
            // User Rule: "If hover and button becomes same colour as text, that is wrong"
            // We modify primary to get hover.

            // Strategy: Darken or Lighten based on BG? 
            // Usually, if we are in Dark Mode, we lighten the button on hover? Or darken?
            // Standard: Darken is often safer for "pressed" feel, Lighten for "shine".
            // Let's try 15% darken by default.
            let hoverColor = adjustBrightness(primary, -15);

            // Check Contrast: Hover vs onPrimary
            let hoverContrast = getContrastRatio(hoverColor, onPrimary);

            // If bad contrast (e.g. Dark Button becomes Black on Hover, and Text is Black) -> Bad.
            if (hoverContrast < 3) {
                // Try Lightening instead
                const lightHover = adjustBrightness(primary, 20);
                const lightContrast = getContrastRatio(lightHover, onPrimary);

                if (lightContrast > hoverContrast) {
                    hoverColor = lightHover;
                } else {
                    // If both suck, force a tinted black/white
                    hoverColor = isBgDark ? '#ffffff' : '#000000'; // Extreme fallback
                }
            }

            // DOUBLE CHECK: Did we accidentally make the hover color == onPrimary?
            // (e.g. Button is White, Text is Black, Hover becomes Gray... might be ok).
            // (e.g. Button is Dark Gray, Text White. Hover becomes Black. Contrast is OK.)
            // The user specific concern: "hover and button becomes same colour as text"
            // means (HoverColor == onPrimary).
            // Visual check:
            if (getContrastRatio(hoverColor, onPrimary) < 1.5) {
                // FORCE DIFFERENCE
                hoverColor = adjustBrightness(primary, isBgDark ? 30 : -30);
            }

            return {
                surface: isBgDark ? blendColors(background, '#ffffff', 0.05) : blendColors(background, '#000000', 0.02),
                border: isBgDark ? blendColors(background, '#ffffff', 0.1) : blendColors(background, '#000000', 0.1),
                mutedText: isBgDark ? blendColors(text, '#ffffff', 0.5) : blendColors(text, '#000000', 0.3),
                primaryHover: hoverColor,
                onPrimary: onPrimary,
                focusRing: blendColors(primary, background, 0.5)
            };
        }

        // --- PERSISTENCE & EXPORT ---
        function getProjectState() {
            return {
                colors: {
                    primary: document.getElementById('colPrimary').value,
                    accent: document.getElementById('colAccent').value,
                    bg: document.getElementById('colBg').value,
                    text: document.getElementById('colText').value,
                    gradients: gradientMap, // Save Gradients
                    gradientDetails: window.gradientDetails || {} // Save Detail Metadata (Start/End)
                },
                typography: {
                    head: document.getElementById('fontHead').value,
                    body: document.getElementById('fontBody').value
                },
                ui: {
                    radius: document.getElementById('radiusInput').value,
                    pill: document.getElementById('pillToggle').checked,
                    shadow: document.getElementById('uiShadow').value,
                    glass: document.getElementById('uiGlass').value
                },
                meta: {
                    context: document.getElementById('brandContext').value,
                    image: document.getElementById('previewImg').src
                }
            };
        }

        function saveProject() {
            const state = getProjectState();
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `brand-${Date.now()}.brand`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadProject(input) {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const state = JSON.parse(e.target.result);

                    // Restore Colors
                    document.getElementById('colPrimary').value = state.colors.primary;
                    document.getElementById('colAccent').value = state.colors.accent;
                    document.getElementById('colBg').value = state.colors.bg;
                    document.getElementById('colText').value = state.colors.text;

                    // Restore Gradients
                    if (state.colors.gradients) {
                        gradientMap = state.colors.gradients;
                    } else {
                        gradientMap = { primary: null, accent: null, bg: null, text: null };
                    }

                    // Restore Gradient Details (Start/End)
                    if (state.colors.gradientDetails) {
                        window.gradientDetails = state.colors.gradientDetails;
                    } else {
                        window.gradientDetails = {};
                    }

                    // Restore Type
                    document.getElementById('fontHead').value = state.typography.head;
                    document.getElementById('fontBody').value = state.typography.body;

                    // Restore UI
                    document.getElementById('radiusInput').value = state.ui.radius;
                    updateRadiusFromSlider(state.ui.radius);
                    document.getElementById('pillToggle').checked = state.ui.pill;
                    togglePill(state.ui.pill);
                    document.getElementById('uiShadow').value = state.ui.shadow;
                    document.getElementById('uiGlass').value = state.ui.glass;

                    // Restore Meta
                    document.getElementById('brandContext').value = state.meta.context || "";
                    if (state.meta.image && state.meta.image.length > 50) {
                        document.getElementById('previewImg').src = state.meta.image;
                        document.getElementById('previewImg').classList.remove('hidden');
                        document.getElementById('uploadPlaceholder').classList.add('hidden');
                        switchTab('logo'); // Auto switch
                    } else if (state.meta.context) {
                        switchTab('nologo');
                    }

                    updateColorInputs(state.colors.primary, state.colors.accent, state.colors.bg, state.colors.text);
                    showToast("Project Loaded Successfully!", "success");

                } catch (err) {
                    console.error(err);
                    showToast("Invalid .brand file!", "error");
                }
            };
            reader.readAsText(input.files[0]);
        }

        function copyJSON() {
            const data = getBrandData();
            navigator.clipboard.writeText(JSON.stringify(data, null, 2));
            showToast("Brand Data copied to clipboard!", "success");
        }

        // TAILWIND REMOVED PER REQUEST


        function exportSystemPrompt() {
            const state = getProjectState();
            const semantic = generateSemanticTokens({
                primary: state.colors.primary,
                accent: state.colors.accent,
                background: state.colors.bg,
                text: state.colors.text
            });

            const prompt = `
### ROLE
You are a Senior Frontend Engineer / Design System Architect.
Your goal is to build a pixel-perfect implementation using **plain HTML/CSS/JS** (or requested framework) that STRICTLY follows the Brand Identity below.

### 0. CRITICAL INSTRUCTION
You must generally **extend** frameworks with these tokens.
HOWEVER: If you detect **obvious visual bugs** (e.g. invalid contrast, 4px illegible font size, or broken layout) using these strict tokens, you are **AUTHORIZED TO INNOVATE**.
- Fix contrast issues automatically (e.g. darken a color if text is unreadable).
- Adjust spacing/sizing if the strict values break the design.
- **Goal**: Strict adherence to Brand Identity, but **perfect utilization** of it. Do not blindly follow broken rules.

### 1. STRICT DESIGN TOKENS(JSON)
        \`\`\`json
{
  "colors": {
    "primary": "${state.colors.primary}",
    "on_primary": "${semantic.onPrimary}",
    "primary_hover": "${semantic.primaryHover}",
    "accent": "${state.colors.accent}",
    "background": "${state.colors.bg}",
    "text": "${state.colors.text}",
    "surface": "${semantic.surface}",
    "border": "${semantic.border}",
    "muted": "${semantic.mutedText}"
  },
  "typography": {
    "heading_font": "${state.typography.head}",
    "body_font": "${state.typography.body}"
  },
  "ui": {
    "radius": "${state.ui.pill ? '9999px' : state.ui.radius + 'px'}",
    "shadow": "${state.ui.shadow}",
    "glass": ${state.ui.glass === 'none' ? false : true}
  }
}
\`\`\`

### 2. IMPLEMENTATION RULES
1. **NEVER Hardcode Hex Values**: Always use CSS variables (see Mapping below).
2. **Primary Utility**: Use \`bg-[var(--primary)]\` and \`text-[var(--on-primary)]\` for main actions.
3. **Hover Safety**: You MUST use the provided \`primary_hover\` color for hover states. 
   - CSS: \`:hover { background: var(--primary-hover); }\`
   - CHECK: Ensure that text contrast remains legible on hover.
4. **Typography**: Use the specified Google Fonts.
5. **Spacing**: Use \`rem\` for all layout spacing.

### 3. CSS VARIABLE MAPPING
:root {
  --primary: ${state.colors.primary};
  --primary-hover: ${semantic.primaryHover};
  --on-primary: ${semantic.onPrimary};
  --bg: ${state.colors.bg};
  --text: ${state.colors.text};
  --radius: ${state.ui.pill ? '9999px' : state.ui.radius + 'px'};
}
`;
            navigator.clipboard.writeText(prompt);
            showToast("Strict System Prompt copied!", "success");
        }

        // --- COPY HEX TO CLIPBOARD ---
        function copyHexToClipboard(hex, elementId) {
            // Ensure hex format is correct
            const cleanHex = hex.trim().toUpperCase();

            navigator.clipboard.writeText(cleanHex).then(() => {
                showToast(`Copied ${cleanHex}`, "success");

                // Visual feedback: briefly highlight the element
                const element = elementId ? document.getElementById(elementId) : null;
                if (element) {
                    element.classList.add('text-pink-400');
                    setTimeout(() => {
                        element.classList.remove('text-pink-400');
                    }, 300);
                }
            }).catch(err => {
                showToast("Failed to copy to clipboard", "error");
                console.error('Copy failed:', err);
            });
        }

        // --- UI FUNCTIONS ---
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const bd = document.getElementById('mobileBackdrop');
            const isClosed = sb.classList.contains('-translate-x-full');

            if (isClosed) {
                sb.classList.remove('-translate-x-full');
                bd.classList.remove('hidden');
            } else {
                sb.classList.add('-translate-x-full');
                bd.classList.add('hidden');
            }
        }

        // Device Switcher Removed

        // RESET FUNCTION
        function resetMemory() {
            showConfirm("Reset Everything?", "This will clear all saved data, API keys, and reload the page.")
                .then(ok => {
                    if (ok) {
                        localStorage.removeItem('reputifly_gemini_key');
                        localStorage.removeItem('reputifly_autosave');
                        window.location.reload();
                    }
                });
        }

        // Auto-Save simple hook
        setInterval(() => {
            const state = getProjectState();
            localStorage.setItem('reputifly_autosave', JSON.stringify(state));
        }, 30000); // Every 30s

        function handleImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    // Show Cropper Interface
                    document.getElementById('uploadZone').classList.add('hidden');
                    document.getElementById('cropperContainer').classList.remove('hidden');

                    const cropImg = document.getElementById('cropperImg');
                    cropImg.src = e.target.result;

                    // Destroy old if exists
                    if (cropper) cropper.destroy();

                    // Init Cropper
                    cropper = new Cropper(cropImg, {
                        aspectRatio: NaN, // Free crop
                        viewMode: 1,
                        autoCropArea: 0.8,
                    });
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleLogoPaste(e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            let found = false;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image')) {
                    e.preventDefault(); // Only prevent if we found an image
                    const blob = item.getAsFile();

                    // Create a synthetic file input change event to reuse handleImage logic
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(new File([blob], "pasted-image.png", { type: blob.type }));

                    const fileInput = document.getElementById('fileInput');
                    fileInput.files = dataTransfer.files;

                    // Trigger handleImage
                    handleImage(fileInput);

                    found = true;
                    showToast("Image pasted successfully!", "success");
                    break;
                }
            }
            if (!found && e.clipboardData && e.clipboardData.items.length > 0) {
                // They pasted something but not an image
                showToast("Please paste an image file", "error");
            }
        }


        // --- DRAG & DROP HANDLERS FOR LOGO ---
        (function initLogoDragDrop() {
            const uploadZone = document.getElementById('uploadZone');

            // Prevent default drag behaviors on the zone
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            // Visual feedback on drag enter/over
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadZone.addEventListener(eventName, () => {
                    uploadZone.classList.add('border-pink-500', 'bg-pink-500/10');
                }, false);
            });

            // Remove visual feedback on drag leave
            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('border-pink-500', 'bg-pink-500/10');
            }, false);

            // Handle dropped files
            uploadZone.addEventListener('drop', (e) => {
                uploadZone.classList.remove('border-pink-500', 'bg-pink-500/10');

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];

                    // Check if it's an image
                    if (file.type.startsWith('image/')) {
                        const fileInput = document.getElementById('fileInput');
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        fileInput.files = dataTransfer.files;

                        handleImage(fileInput);
                        showToast("Image dropped successfully!", "success");
                    } else {
                        showToast("Please drop an image file", "error");
                    }
                }
            }, false);
        })();


        function confirmCrop() {
            if (!cropper) return;
            // Get cropped canvas
            const canvas = cropper.getCroppedCanvas();
            const croppedDataUrl = canvas.toDataURL();

            // Store result in preview
            const img = document.getElementById('previewImg');
            img.src = croppedDataUrl;
            img.classList.remove('hidden');
            document.getElementById('uploadPlaceholder').classList.add('hidden');

            // Reset UI
            document.getElementById('cropperContainer').classList.add('hidden');
            document.getElementById('uploadZone').classList.remove('hidden');

            // Cleanup
            cropper.destroy();
            cropper = null;

            // Wait for image load then extract colors
            img.onload = () => extractColorsLocally(img);
        }

        function cancelCrop() {
            if (cropper) cropper.destroy();
            document.getElementById('cropperContainer').classList.add('hidden');
            document.getElementById('uploadZone').classList.remove('hidden');
            // Clear input value to allow re-selecting same file
            document.getElementById('fileInput').value = '';
        }


        // MANUAL COLOR PICKER LOGIC
        let activePickerTarget = null;

        function openColorPicker(targetId) {
            const img = document.getElementById('cropperImg');
            // If no image is visible/uploaded, confuse user less by saying so.
            // But 'cropperImg' is always there, empty or not?
            if (!img.src || img.src === window.location.href) {
                // If the user hasn't uploaded a logo, maybe try to use the raw fileInput if possible?
                // Or just error out.
                if (!cropper) {
                    showToast("Please upload an image first!", "error");
                    return;
                }
            }

            activePickerTarget = targetId;
            const modal = document.getElementById('colorPickerModal');
            const canvas = document.getElementById('pickerCanvas');
            const ctx = canvas.getContext('2d');

            // Use the image source (could be base64 cropped or original)
            // We prefer the 'cropperImg' because that's what the user sees
            const imageObj = new Image();
            imageObj.src = img.src;

            imageObj.onload = () => {
                // Resize logic for canvas to fit screen
                const maxW = window.innerWidth * 0.8;
                const maxH = window.innerHeight * 0.7;
                let scale = 1;

                if (imageObj.naturalWidth > maxW || imageObj.naturalHeight > maxH) {
                    scale = Math.min(maxW / imageObj.naturalWidth, maxH / imageObj.naturalHeight);
                }

                canvas.width = imageObj.naturalWidth * scale;
                canvas.height = imageObj.naturalHeight * scale;

                ctx.drawImage(imageObj, 0, 0, canvas.width, canvas.height);
                modal.classList.remove('hidden');
            }
        }

        function handleCanvasClick(e) {
            if (!activePickerTarget) return;

            const canvas = document.getElementById('pickerCanvas');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();

            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const p = ctx.getImageData(x, y, 1, 1).data;
            const hex = rgbToHex(p[0], p[1], p[2]);

            // Apply
            const input = document.getElementById(activePickerTarget);
            input.value = hex;

            // Trigger updates
            updatePreview();

            // Also update the Hex Label text if exists
            // ID pattern: colPrimary -> hexPrimary
            const labelId = activePickerTarget.replace('col', 'hex');
            const label = document.getElementById(labelId);
            if (label) label.innerText = hex;

            showToast(`Color Picked: ${hex}`, 'success');
            closeColorPicker();
        }

        function closeColorPicker() {
            document.getElementById('colorPickerModal').classList.add('hidden');
            activePickerTarget = null;
        }

        // --- Helper --- 
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        function extractColorsLocally(img) {
            try {
                // Get Dominant Color (Natural Primary)
                const dom = colorThief.getColor(img);
                // Get Detailed Palette (up to 10 colors for better discovery)
                const palette = colorThief.getPalette(img, 10);
                window.extractedPalette = palette; // Save for Modal

                // Helper: Get Saturation (0-100)
                const getSat = (rgb) => {
                    const r = rgb[0] / 255, g = rgb[1] / 255, b = rgb[2] / 255;
                    const max = Math.max(r, g, b), min = Math.min(r, g, b);
                    return (max === 0) ? 0 : (max - min) / max * 100;
                };

                // Helper: Is Grayscale? (Low saturation)
                const isGray = (rgb) => getSat(rgb) < 10;

                // STRATEGY:
                // 1. Identify the "Best" Colorful color in the palette
                // Sort by Saturation
                const sortedBySat = [...palette].sort((a, b) => getSat(b) - getSat(a));
                const mostVibrant = sortedBySat[0];
                const vibrantSat = getSat(mostVibrant);

                let primaryRgb = dom;
                let accentRgb = palette[1] || dom;

                // 2. Logic: If Dominant is boring (Black/White/Gray) AND we found a very vibrant color,
                // Promote the vibrant color to Primary (or at least used).
                // Many logos are "Red text on White BG". Dominant = White. We want Red.
                if (isGray(dom) && vibrantSat > 30) {
                    // Dominant is boring, found something fun.
                    primaryRgb = mostVibrant;

                    // Try to find a secondary color for accent?
                    // Maybe the second most vibrant, or the original dominant (to keep contrast)?
                    // Let's set Accent to the 2nd vibrant one, or just keep it distinct.
                    accentRgb = sortedBySat[1] || dom;
                } else {
                    // Dominant is colorful! Use it. 
                    // Set accent to something contrasting if possible?
                    // For now, standard palette logic is ok.
                    accentRgb = palette[1] || dom;
                }

                // Convert to Hex
                const primaryHex = rgbToHex(...primaryRgb);
                const accentHex = rgbToHex(...accentRgb);

                // BG/Text Logic (Standard)
                const bgHex = isLight(primaryRgb) ? '#ffffff' : '#0B0A14';
                const textHex = isLight(primaryRgb) ? '#0B0A14' : '#FFFFFF';

                // Apply to UI
                updateColorInputs(primaryHex, accentHex, bgHex, textHex);

                // --- UI: RENDER DETECTED PALETTE ---
                const box = document.getElementById('detectedPaletteBox');
                const swatches = document.getElementById('detectedSwatches');
                swatches.innerHTML = ''; // Clear
                box.classList.remove('hidden');

                // Render Top 8 colors
                // We show them all so user can pick "That Red"
                palette.slice(0, 8).forEach(rgb => {
                    const hex = rgbToHex(...rgb);

                    // Container for the swatch
                    const wrapper = document.createElement('div');
                    wrapper.className = "relative group";

                    const btn = document.createElement('button');
                    btn.className = "w-8 h-8 rounded-full border border-white/20 hover:scale-110 transition shadow-sm relative";
                    btn.style.backgroundColor = hex;
                    btn.title = `Left-click: Set as Primary | Right-click: Copy ${hex}`;
                    btn.onclick = (e) => {
                        if (e.ctrlKey || e.metaKey) {
                            // Ctrl/Cmd + Click = Copy
                            copyHexToClipboard(hex);
                        } else {
                            // Normal click = Set as Primary
                            document.getElementById('colPrimary').value = hex;
                            updatePreview();
                            document.getElementById('hexPrimary').innerText = hex;
                            showToast(`Primary Color updated to ${hex}`, 'success');
                        }
                    }
                    // Right-click to copy
                    btn.oncontextmenu = (e) => {
                        e.preventDefault();
                        copyHexToClipboard(hex);
                    }


                    // Delete Button (X)
                    const delBtn = document.createElement('button');
                    delBtn.className = "absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] opacity-0 group-hover:opacity-100 transition shadow-lg z-10";
                    delBtn.innerHTML = '<i data-feather="x" class="w-2 h-2"></i>';
                    delBtn.onclick = (e) => {
                        e.stopPropagation(); // Stop it from triggering the color pick
                        wrapper.remove(); // Remove this swatch
                    };

                    wrapper.appendChild(btn);
                    wrapper.appendChild(delBtn);

                    // Tooltip (Optional, can be messy with key overlap, removing for cleaner UI or keep simple)
                    // const tooltip = document.createElement('span');
                    // tooltip.className = "absolute -top-6 left-1/2 -translate-x-1/2 bg-black text-[10px] text-white px-2 py-0.5 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none z-20";
                    // tooltip.innerText = "Use as Primary";
                    // wrapper.appendChild(tooltip);

                    swatches.appendChild(wrapper);
                });

                // Re-init feather for the new X icons
                feather.replace();


                // Show AI Option if Key exists
                if (localStorage.getItem('reputifly_gemini_key')) {
                    document.getElementById('aiBtn').classList.remove('hidden');
                }

            } catch (e) {
                console.error("Color Extraction Failed", e);
                showToast("Could not extract colors. Please pick manually.", "error");
            }
        }

        function isLight(rgb) {
            // Brightness formula
            return ((rgb[0] * 299 + rgb[1] * 587 + rgb[2] * 114) / 1000) > 125;
        }

        // --- 2. AI LOGIC (GEMINI 2.5 FLASH) ---
        async function askAI() {
            const key = localStorage.getItem('reputifly_gemini_key');
            if (!key) return showToast("Please save API Key first!", "error");

            const img = document.getElementById('previewImg');
            const contextText = document.getElementById('brandContext').value;

            // Check if we have input
            const hasImage = !img.classList.contains('hidden') && img.src;
            const hasText = contextText && contextText.trim().length > 0; // Fix: check exists first

            if (!hasImage && !hasText) return showToast("Missing Input: Image or Description required.", "error");

            const btn = document.getElementById('aiBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-feather="loader" class="w-3 h-3 animate-spin"></i> Dreaming...';
            feather.replace();


            try {
                // Get Current State for Context
                const currentState = getProjectState();
                const colorsContext = JSON.stringify(currentState.colors);

                // Determine Intent from Active Tab
                let prompt = "";


                if (activeTab === 'logo') {
                    if (!img.src || img.classList.contains('hidden')) return showToast("Please upload a logo first.", "error");
                    prompt = `You are a Senior Brand Designer. Analyze this logo. 
                        Extract the TRUE brand colors. Ignore container backgrounds.
                        
                        IMPORTANT: The user currently has these colors selected: ${colorsContext}.
                        If these current colors seem intentional or specific (e.g. a specific shade of Red), prioritize respecting them or finding a harmonious match to them.
                        
                        Predict the best 'Background' and 'Text' colors for a high-end web design.
                        Return strictly raw JSON (no markdown).`;
                } else {
                    if (contextText.trim().length === 0) return showToast("Please enter a brand description.", "error");
                    prompt = `You are a Senior Brand Designer. Create a complete brand identity from scratch for this business: "${contextText}".
                        
                        IMPORTANT: The user currently has these colors selected: ${colorsContext}.
                        Use this as a strong hint for their preference. If they selected a specific Red (#FF0000), assume they want Red in the identity.
                        
                        Generate a color palette, typography and UI vibe that perfectly fits this description.
                        Return strictly raw JSON (no markdown).`;
                }

                // Append Schema
                // Append Schema with Gradient Support
                prompt += `
                Structure:
                {
                  "colors": { "primary": "#hex", "accent": "#hex", "background": "#hex", "text": "#hex" },
                  "gradients": {
                     "primary": { "start": "#hex", "end": "#hex" }, 
                     "accent": { "start": "#hex", "end": "#hex" } 
                  },
                  "typography": { "heading": "FontName", "body": "FontName" },
                  "ui": { "radius": "0|2|8|16|24", "shadow": "none|soft|heavy|retro", "glass": "none|blur(12px)" },
                  "reasoning": "One short sentence explaining the design choice."
                }
                
                Note: "gradients" is optional. If a color should be a gradient, provide start/end. If solid, set to null.
                For "Cyberpunk" or "Modern" styles, use gradients freely. For "Minimalist", avoid them.
                Valid Fonts: 'Inter', 'Playfair Display', 'Space Grotesk', 'Roboto'.
                Valid Shadows: 'none' (Flat), 'soft', 'heavy', 'retro'.
                `;

                const parts = [{ text: prompt }];
                if (activeTab === 'logo' && hasImage) {
                    const base64 = img.src.split(',')[1];
                    parts.push({ inline_data: { mime_type: "image/jpeg", data: base64 } });
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: parts }] })
                });

                const data = await response.json();
                if (!data.candidates) throw new Error("No candidates received");

                let text = data.candidates[0].content.parts[0].text;
                // Clean markdown if present
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const json = JSON.parse(text);

                console.log("AI Analysis:", json);

                // Apply Colors
                document.getElementById('colPrimary').value = json.colors.primary;
                document.getElementById('colAccent').value = json.colors.accent;
                document.getElementById('colBg').value = json.colors.background;
                document.getElementById('colText').value = json.colors.text;

                // Apply Gradients
                if (json.gradients) {
                    ['primary', 'accent'].forEach(key => {
                        const gradObj = json.gradients[key];
                        if (gradObj && gradObj.start && gradObj.end) {
                            // Construct CSS Linear Gradient
                            const css = `linear-gradient(135deg, ${gradObj.start} 0%, ${gradObj.end} 100%)`;

                            // Save to Global Maps
                            if (!window.gradientMap) window.gradientMap = {};
                            if (!window.gradientDetails) window.gradientDetails = {};

                            window.gradientMap[key] = css;
                            window.gradientDetails[key] = { start: gradObj.start, end: gradObj.end };
                        } else {
                            // Clear if previously set but AI says solid
                            if (window.gradientMap) window.gradientMap[key] = null;
                            if (window.gradientDetails) delete window.gradientDetails[key];
                        }
                    });
                }

                // Apply Typography
                const setSelect = (id, val) => {
                    const sel = document.getElementById(id);
                    for (let i = 0; i < sel.options.length; i++) {
                        if (sel.options[i].value.includes(val)) { sel.selectedIndex = i; break; }
                    }
                };
                setSelect('fontHead', json.typography.heading);
                setSelect('fontBody', json.typography.body);

                // Apply UI
                document.getElementById('radiusInput').value = json.ui.radius;
                updateRadiusFromSlider(json.ui.radius);

                // Shadow map
                const shadowMap = {
                    'none': 'none',
                    'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                    'heavy': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    'retro': '4px 4px 0px 0px rgba(0,0,0,1)'
                };
                const shadowVal = shadowMap[json.ui.shadow] || 'none';
                document.getElementById('uiShadow').value = shadowVal;

                // Glass
                document.getElementById('uiGlass').value = json.ui.glass === 'blur(12px)' ? 'blur(12px)' : 'none';

                // Trigger Updates
                updateColorInputs(json.colors.primary, json.colors.accent, json.colors.background, json.colors.text);

                showToast(` AI Refined: ${json.reasoning}`, "success");

            } catch (e) {
                console.error(e);
                showToast("AI Error: " + e.message, "error");
            }
            btn.innerHTML = originalText;
            feather.replace();
        }

        // --- 3. SHARED LOGIC ---
        function updateColorInputs(p, a, b, t) {
            document.getElementById('colPrimary').value = p; document.getElementById('hexPrimary').innerText = p;
            document.getElementById('colAccent').value = a; document.getElementById('hexAccent').innerText = a;
            document.getElementById('colBg').value = b; document.getElementById('hexBg').innerText = b;
            document.getElementById('colText').value = t; document.getElementById('hexText').innerText = t;
            updatePreview();
        }

        function updatePreview() {
            const root = document.getElementById('livePreview');
            const p = document.getElementById('colPrimary').value;
            const a = document.getElementById('colAccent').value;
            const b = document.getElementById('colBg').value;
            const t = document.getElementById('colText').value;

            // 1. Colors & Type
            // Use Gradient if exists, else Hex
            root.style.setProperty('--p-primary', gradientMap.primary || p);
            root.style.setProperty('--p-accent', gradientMap.accent || a);
            // BG often stays solid for readability, but let's allow it
            root.style.setProperty('--p-bg', gradientMap.bg || b);
            root.style.setProperty('--p-text', gradientMap.text || t);

            const fh = document.getElementById('fontHead').value.split(',')[0].replace(/'/g, "");
            const fb = document.getElementById('fontBody').value.split(',')[0].replace(/'/g, "");
            root.style.setProperty('--p-font-head', fh);
            root.style.setProperty('--p-font-body', fb);

            // 2. Radius Logic (Sync or Pill)
            root.style.setProperty('--p-radius', currentRadius);
            root.style.setProperty('--p-btn-radius', isPillMode ? '999px' : currentRadius);

            // 3. Logo Injection Logic
            const uploadedImg = document.getElementById('previewImg');
            const navLogo = document.getElementById('navLogo');
            const navText = document.getElementById('navText');

            if (!uploadedImg.classList.contains('hidden') && uploadedImg.src) {
                navLogo.src = uploadedImg.src;
                navLogo.classList.remove('hidden');
                navText.classList.add('hidden');
            } else {
                navLogo.classList.add('hidden');
                navText.classList.remove('hidden');
            }

            // 4. Shadow & Glass Logic
            const shadow = document.getElementById('uiShadow') ? document.getElementById('uiShadow').value : 'none';
            const glass = document.getElementById('uiGlass') ? document.getElementById('uiGlass').value : 'none';

            root.style.setProperty('--p-shadow', shadow);
            if (glass && glass !== 'none') {
                root.style.setProperty('--p-card-bg', 'rgba(255,255,255,0.5)');
                root.style.setProperty('--p-blur', glass);
            } else {
                root.style.setProperty('--p-card-bg', 'rgba(128,128,128,0.05)');
                root.style.setProperty('--p-blur', 'none');
            }

            // 5. Semantic Tokens
            const semantic = generateSemanticTokens({ primary: p, accent: a, background: b, text: t });
            root.style.setProperty('--p-surface', semantic.surface);
            root.style.setProperty('--p-border', semantic.border);
            root.style.setProperty('--p-muted', semantic.mutedText);
            root.style.setProperty('--p-primary-hover', semantic.primaryHover);
            root.style.setProperty('--p-on-primary', semantic.onPrimary); // NEW
            root.style.setProperty('--p-focus-ring', semantic.focusRing);


            // 6. Accessibility Checks
            checkContrast(p, a, b, t);
        }

        // --- PREVIEW INTERACTIONS (DELEGATION) ---
        function initPreviewInteractions() {
            const preview = document.getElementById('livePreview');

            // Add hover cursor for everything interactive
            const style = document.createElement('style');
            style.innerHTML = `
                #livePreview * { cursor: default; }
                #livePreview button, #livePreview .preview-btn { cursor: pointer; outline: 3px solid transparent; transition: outline 0.2s; }
                #livePreview h1, #livePreview h2, #livePreview h3, #livePreview p, #livePreview span { cursor: pointer; }
                #livePreview .preview-card { cursor: pointer; }
                #livePreview:hover { cursor: crosshair; } 

                #livePreview *:hover { 
                    /* subtle highlight on hover to show interactivity */
                    /* Note: This might conflict with actual visual design, so keeps it minimal */
                }
            `;
            document.head.appendChild(style);

            preview.addEventListener('click', (e) => {
                // Prevent real links/buttons if needed, though here we want to trigger the color picker
                // e.preventDefault(); 
                e.stopPropagation();

                const target = e.target;

                // 1. Buttons / Primary (Check classes or tag)
                if (target.classList.contains('preview-btn') ||
                    target.closest('.preview-btn') ||
                    getComputedStyle(target).backgroundColor === document.getElementById('colPrimary').value) {

                    showToast("Editing Primary Color...", "info");
                    openColorModal('colPrimary', 'Primary');
                    return;
                }

                // 2. Headings / Text
                if (['H1', 'H2', 'H3', 'P', 'SPAN'].includes(target.tagName)) {
                    // Check if it's explicitly accent text (detects style OR the new gradient class)
                    const isAccent = (target.style.color && target.style.color.includes('var(--p-accent)')) ||
                        target.classList.contains('accent-text-gradient');

                    if (isAccent) {
                        showToast("Editing Accent Color...", "info");
                        openColorModal('colAccent', 'Accent');
                        return;
                    }

                    showToast("Editing Text Color...", "info");
                    openColorModal('colText', 'Text');
                    return;
                }

                // 3. Cards / Surface (Check specific class)
                if (target.classList.contains('preview-card') || target.closest('.preview-card')) {
                    // Usually surface color, but we might not have a specific picker for surface?
                    // We generate surface from background. So maybe open Background picker?
                    showToast("Surface depends on Background. Editing Background...", "info");
                    openColorModal('colBg', 'Background');
                    return;
                }

                // 4. Fallback: Background
                if (target === preview || target.classList.contains('fixed-bg')) {
                    showToast("Editing Background Color...", "info");
                    openColorModal('colBg', 'Background');
                    return;
                }

                // If element has specific styles matching our vars
                const computed = getComputedStyle(target);
                if (computed.color === document.getElementById('colAccent').value) {
                    document.getElementById('colAccent').click();
                    return;
                }
            });
        }

        // Call init
        initPreviewInteractions();

        // --- ACCESSIBILITY LOGIC ---
        function getLuminance(r, g, b) {
            var a = [r, g, b].map(function (v) {
                v /= 255;
                return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
            });
            return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
        }

        function getContrastRatio(hex1, hex2) {
            const rgb1 = hexToRgbVals(hex1);
            const rgb2 = hexToRgbVals(hex2);
            if (!rgb1 || !rgb2) return 0;
            const lum1 = getLuminance(rgb1[0], rgb1[1], rgb1[2]);
            const lum2 = getLuminance(rgb2[0], rgb2[1], rgb2[2]);
            const brightest = Math.max(lum1, lum2);
            const darkest = Math.min(lum1, lum2);
            return (brightest + 0.05) / (darkest + 0.05);
        }

        function hexToRgbVals(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : null;
        }

        function checkContrast(p, a, b, t) {
            // 1. Primary Button Logic 
            // We now use dynamic text color (onPrimary) so we check that.
            // But for the WARN UI, we want to know if the user *needs* to fix something manually?
            // Actually, we are fixing the button text color AUTOMATICALLY now.
            // So we mainly need to warn if the Primary is so weird that neither black nor white works? (Rare)

            // Let's check contrast of Primary against Background instead (Visibility of button shape)
            const ratioPrimBg = getContrastRatio(p, b);
            const warnPrimVal = document.getElementById('warnPrimary');

            // Warn if button blends into background too much (Ghost button risk)
            if (ratioPrimBg < 1.5) {
                warnPrimVal.classList.remove('hidden');
                warnPrimVal.querySelector('span').innerHTML = '<i data-feather="alert-circle" class="w-3 h-3"></i> Blends with BG';
            } else {
                warnPrimVal.classList.add('hidden');
            }

            // 2. Accent Visibility (Accent vs BG)
            const ratioAccent = getContrastRatio(a, b);
            const warnAccentVal = document.getElementById('warnAccent');
            if (ratioAccent < 3) { // Graphic elements need 3:1
                warnAccentVal.classList.remove('hidden');
            } else {
                warnAccentVal.classList.add('hidden');
            }

            // 3. Body Text (Text vs BG)
            const ratioText = getContrastRatio(t, b);
            const warnTextVal = document.getElementById('warnText');
            if (ratioText < 4.5) {
                warnTextVal.classList.remove('hidden');
            } else {
                warnTextVal.classList.add('hidden');
            }
            feather.replace();
        }

        function fixContrast(type) {
            const b = document.getElementById('colBg').value;

            if (type === 'text') {
                // Determine if BG is dark or light, set text to white/black
                const bgLum = getLuminance(...hexToRgbVals(b));
                const newText = bgLum > 0.5 ? '#1e293b' : '#f8fafc';
                document.getElementById('colText').value = newText;
            } else if (type === 'primary') {
                // darkening Primary until it passes against white
                // OR flip text color? For now, let's just darken the primary if it's too light for white text
                let p = document.getElementById('colPrimary').value;
                // Simple hack: if too light, just set to a safe blue
                document.getElementById('colPrimary').value = '#2563eb';
            } else if (type === 'accent') {
                // Adjust accent to separate from BG
                // If bg is light, darken accent. If bg is dark, lighten accent.
                const bgLum = getLuminance(...hexToRgbVals(b));
                const newAccent = bgLum > 0.5 ? '#be185d' : '#f472b6';
                document.getElementById('colAccent').value = newAccent;
            }

            // Update UI
            updateColorInputs(
                document.getElementById('colPrimary').value,
                document.getElementById('colAccent').value,
                document.getElementById('colBg').value,
                document.getElementById('colText').value
            );
        }
        function invertTheme() {
            const bg = document.getElementById('colBg').value;
            const tx = document.getElementById('colText').value;
            let p = document.getElementById('colPrimary').value;
            let a = document.getElementById('colAccent').value;

            // 1. Swap BG and Text
            const newBg = tx;
            const newText = bg;

            // 2. Smart Adjust Primary & Accent
            // Check if Primary contrasts well with NEW BG
            const pContrast = getContrastRatio(p, newBg);
            if (pContrast < 3) { // 3:1 is absolute minimum for UI components
                // It's bad. We need to flip its brightness.
                const isDark = getLuminance(...hexToRgbVals(newBg)) < 0.5;
                // If BG is Dark, make Primary Lighter. If Bright, make Darker.
                // We shift by 40% to be safe.
                p = adjustBrightness(p, isDark ? 40 : -40);
            }

            // Check Accent
            const aContrast = getContrastRatio(a, newBg);
            if (aContrast < 3) {
                const isDark = getLuminance(...hexToRgbVals(newBg)) < 0.5;
                a = adjustBrightness(a, isDark ? 40 : -40);
            }

            // 3. Apply
            document.getElementById('colBg').value = newBg;
            document.getElementById('colText').value = newText;
            document.getElementById('colPrimary').value = p;
            document.getElementById('colAccent').value = a;

            // Update UI
            updateColorInputs(p, a, newBg, newText);

            showToast("Theme Inverted & Colors Adapted", "success");
        }

        function setRadius(r) { currentRadius = r; updatePreview(); }

        function saveKey() {
            const input = document.getElementById('apiKeyInputModal');
            const k = input ? input.value : '';

            if (k) {
                localStorage.setItem('reputifly_gemini_key', k);

                const box = document.getElementById('apiKeyBox');
                if (box) box.classList.add('hidden');

                showToast("Key Saved! AI Mode Unlocked.", "success");

                const badge = document.getElementById('aiBadge');
                if (badge) {
                    badge.innerText = "AI Active";
                    badge.classList.replace('text-gray-600', 'text-pink-400');
                    badge.classList.replace('border-gray-700', 'border-pink-500');
                }
            } else {
                showToast("Please enter an API Key.", "error");
            }
        }

        function getBrandData() {
            return {
                colors: {
                    primary: document.getElementById('colPrimary').value,
                    accent: document.getElementById('colAccent').value,
                    background: document.getElementById('colBg').value,
                    text: document.getElementById('colText').value,
                    gradients: gradientMap,
                    gradientDetails: window.gradientDetails || {} // Include details
                },
                typography: {
                    heading: document.getElementById('fontHead').value.split(',')[0].replace(/'/g, ""),
                    body: document.getElementById('fontBody').value.split(',')[0].replace(/'/g, "")
                },
                ui: {
                    radius: currentRadius,
                    shadow: document.getElementById('uiShadow').value,
                    glass: document.getElementById('uiGlass').value
                },
                semantic: generateSemanticTokens({
                    primary: document.getElementById('colPrimary').value,
                    accent: document.getElementById('colAccent').value,
                    background: document.getElementById('colBg').value,
                    text: document.getElementById('colText').value
                })
            };
        }

        function downloadJSON() {
            const data = getBrandData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "brand_dna.json";
            a.click();
        }

        function exportPrompt() {
            exportSystemPrompt(); // Default to the strict one now? No, user might want just CSS.
            // Let's keep this as 'Copy CSS'
            const d = getBrandData();
            let css = `:root { 
    /* Base Colors */
    --primary: ${d.colors.primary};
    --on-primary: ${d.semantic.onPrimary};
    --primary-hover: ${d.semantic.primaryHover};
    --accent: ${d.colors.accent}; 
    --bg: ${d.colors.background}; 
    --text: ${d.colors.text}; 

    /* Semantic Tokens */
    --surface: ${d.semantic.surface};
    --border: ${d.semantic.border};
    --muted: ${d.semantic.mutedText};
    --primary-hover: ${d.semantic.primaryHover};
    --focus-ring: ${d.semantic.focusRing};

    /* Typography & UI */
    --font-head: ${d.typography.heading}; 
    --font-body: ${d.typography.body}; 
    --radius: ${d.ui.radius}; 
    --shadow: ${d.ui.shadow}; 
}`;
            navigator.clipboard.writeText(css);
            showToast("CSS Variables copied to clipboard!", "success");
        }

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                // Sync load button in modal
            } else {
                modal.classList.add('hidden');
            }
        }

        function resetColor(id) {
            const el = document.getElementById(id);
            const original = el.getAttribute('data-original');
            if (original) {
                el.value = original;
                updatePreview();

                // Update text display
                const type = id.replace('col', ''); // Primary, Accent, etc
                const hexDisplay = document.getElementById('hex' + type);
                if (hexDisplay) hexDisplay.innerText = original;
            }
        }

        // --- AGENCY STAMP LOGIC ---
        let agencyStampData = null;

        function handleStampUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => setStamp(e.target.result);
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleStampPaste(e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            let found = false;
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.includes('image')) {
                    e.preventDefault(); // Only prevent if we found an image
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => setStamp(event.target.result);
                    reader.readAsDataURL(blob);
                    found = true;
                }
            }
            if (!found) {
                // Optional: Show toast if they pasted text?
            }
        }

        function setStamp(base64) {
            agencyStampData = base64;
            const img = document.getElementById('stampPreview');
            const ph = document.getElementById('stampPlaceholder');
            const clr = document.getElementById('clearStampBtn');

            img.src = base64;
            img.classList.remove('hidden');
            ph.classList.add('hidden');
            clr.classList.remove('hidden');

            // Auto-focus the zone removed to avoid scrolling jump, just notify
            showToast("Agency Stamp Set!", "success");

            // Save to Local Storage
            localStorage.setItem('reputifly_stamp', base64);
        }

        function clearStamp(e) {
            if (e) e.stopPropagation();
            agencyStampData = null;
            document.getElementById('stampPreview').classList.add('hidden');
            document.getElementById('stampPlaceholder').classList.remove('hidden');
            document.getElementById('clearStampBtn').classList.add('hidden');
            document.getElementById('stampInput').value = "";
            localStorage.removeItem('reputifly_stamp');
        }

        // Init Agency Stamp from Memory
        (function initStamp() {
            const saved = localStorage.getItem('reputifly_stamp');
            if (saved) {
                setStamp(saved);
            }
        })();

        function openExportModal() {
            document.getElementById('exportModal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function startPdfExport() {
            const client = document.getElementById('exportClientName').value || "Brand";
            const file = document.getElementById('exportFileName').value || "Brand_Identity_Kit";
            closeExportModal();
            downloadVisualKit(client, file);
        }

        function downloadVisualKit(clientName = "Valued Client", fileName = "Brand_Identity_Kit") {
            // Button loading state
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-feather="loader" class="w-4 h-4 animate-spin"></i> Generating PDF...`;
            feather.replace();

            const d = getBrandData();

            // PROJECT LOGO (Top Right)
            const logoSrc = document.getElementById('previewImg').src;
            const logoHTML = (!document.getElementById('previewImg').classList.contains('hidden'))
                ? `<img src="${logoSrc}" style="height: 80px; object-fit:contain;">`
                : `<h1 style="font-size: 30px; font-family:${d.typography.heading}; margin:0;">BRAND.</h1>`;

            // AGENCY STAMP (Top Left)
            // Use Reputifly default if no stamp uploaded
            const defaultAgencyLogo = "https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png";
            const agencySrc = agencyStampData || defaultAgencyLogo;

            const agencyHTML = `<img src="${agencySrc}" style="height: 40px; margin-bottom: 15px; display: block; object-fit: contain;">`;

            // Create temporary container
            const container = document.createElement('div');
            // FIX: Use fixed positioning to ensure it starts exactly at 0,0 of the viewport
            // This prevents scroll offsets or body margins from shifting the capture
            container.style.position = 'fixed';
            container.style.top = '0';
            container.style.left = '0';
            container.style.margin = '0';
            container.style.padding = '0';
            container.style.zIndex = '-9999'; // Hide behind everything
            container.style.width = '794px'; // A4 Width at 96 DPI
            container.style.height = 'auto'; // allow expansion
            container.style.background = '#ffffff';

            // Prevent body scroll interference during capture
            const originalOverflow = document.body.style.overflow;
            document.body.style.overflow = 'hidden';
            window.scrollTo(0, 0); // Force scroll to top

            document.body.appendChild(container);

            const fontHead = d.typography.heading;
            const fontBody = d.typography.body;
            const fontLink = `https://fonts.googleapis.com/css2?family=${fontHead.replace(/ /g, '+')}:wght@400;600;700&family=${fontBody.replace(/ /g, '+')}:wght@400;600;700&display=swap`;

            // Dark Mode Logic for PDF elements
            const bgLum = getLuminance(...hexToRgbVals(d.colors.background));
            const isDark = bgLum < 0.5;
            const uiCardBg = isDark ? d.semantic.surface : '#ffffff';
            const uiInputBg = isDark ? 'rgba(255,255,255,0.05)' : '#ffffff';
            const uiBorderColor = isDark ? 'rgba(255,255,255,0.1)' : d.semantic.border;
            let uiTextColor = d.colors.text;

            const textLum = getLuminance(...hexToRgbVals(uiTextColor));
            if (isDark && textLum < 0.6) uiTextColor = '#ffffff';
            if (!isDark && textLum > 0.4) uiTextColor = '#000000';

            // Render content
            container.innerHTML = `
                <!-- Inject Font Link specifically for the export container -->
                <link href="${fontLink}" rel="stylesheet">
                <div class="pdf-wrapper" style="font-family: ${d.typography.body}; background: white; color: black; padding: 40px; width: 100%; box-sizing: border-box;">
                    <style>
                        .pdf-page { width: 100%; min-height: 100vh; } 
                        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 60px; border-bottom: 1px solid #eee; padding-bottom: 40px; }
                        .agency-col { text-align: left; }
                        .client-info { font-family: 'Inter', sans-serif; font-size: 12px; color: #666; margin-top: 5px; }
                        .client-name { font-weight: 700; color: black; font-size: 14px; display: block; margin-bottom: 2px; }
                        
                        /* Keeping existing styles */
                        h1, h2, h3 { font-family: ${d.typography.heading}; margin: 0; font-weight: 700; }
                        h1 { font-size: 36px; line-height: 1.2; }
                        .section-title { font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; color: ${d.colors.accent}; margin-bottom: 30px; border-top: 1px solid #ccc; padding-top: 20px; margin-top: 60px; page-break-after: avoid; }
                        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; page-break-inside: avoid; }
                        .swatch-card { page-break-inside: avoid; }
                        .swatch { height: 100px; border-radius: ${d.ui.radius}; margin-bottom: 15px; border: 1px solid #eee; }
                        .color-meta h3 { font-size: 14px; margin-bottom: 4px; }
                        .color-meta p { font-size: 10px; opacity: 0.5; font-family: monospace; }
                        .token-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; page-break-inside: avoid; }
                        .token-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #eee; page-break-inside: avoid; }
                        .token-swatch { width: 30px; height: 30px; border-radius: 50%; margin: 0 auto 8px auto; border: 1px solid #ddd; }
                        .token-name { font-size: 10px; opacity: 0.7; }
                        .type-row { display: grid; grid-template-columns: 150px 1fr; gap: 40px; margin-bottom: 40px; page-break-inside: avoid; }
                        .type-label { font-size: 11px; opacity: 1.0; font-weight: 600; color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px; align-self: start; }
                        .ui-showcase { background: ${d.semantic.surface}; border: 1px solid ${d.semantic.border}; border-radius: 20px; padding: 40px; display: flex; flex-wrap: wrap; gap: 40px; justify-content: center; align-items: center; page-break-inside: avoid; }
                        .mock-card { background: ${uiCardBg}; border: 1px solid ${uiBorderColor}; border-radius: ${d.ui.radius}; padding: 25px; width: 260px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); display: flex; flex-direction: column; gap: 15px; page-break-inside: avoid; color: ${uiTextColor}; }
                        .mock-line { height: 8px; background: ${uiTextColor}; opacity: 0.1; border-radius: 4px; width: 100%; }
                        .mock-btn { background: ${d.colors.gradients && d.colors.gradients.primary ? d.colors.gradients.primary : d.colors.primary}; color: ${d.semantic.onPrimary}; border-radius: ${d.ui.radius === '99px' || isPillMode ? '999px' : d.ui.radius}; padding: 12px 24px; font-size: 13px; font-weight: 600; border: none; cursor: pointer; display: inline-block; text-align: center; width: 100%; }
                        .mock-input-group { width: 100%; }
                        .mock-label { font-size: 11px; font-weight: 600; color: ${uiTextColor}; margin-bottom: 6px; display: block; opacity: 0.8; }
                        .mock-input { width: 100%; border: 1px solid ${uiBorderColor}; border-radius: ${d.ui.radius}; padding: 10px 12px; font-size: 13px; color: ${uiTextColor}; background: ${uiInputBg}; box-sizing: border-box; }
                        .mock-input.active { border-color: ${d.colors.primary}; box-shadow: 0 0 0 3px ${d.semantic.focusRing}; }
                        .mock-row { display: flex; gap: 15px; align-items: center; width: 100%; }
                        .mock-toggle { width: 44px; height: 24px; background: ${uiBorderColor}; border-radius: 99px; position: relative; }
                        .mock-toggle.active { background: ${d.colors.gradients && d.colors.gradients.accent ? d.colors.gradients.accent : d.colors.accent}; }
                        .mock-toggle-circle { width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
                        .mock-toggle.active .mock-toggle-circle { left: auto; right: 2px; }
                        .mock-tag { padding: 4px 12px; font-size: 11px; font-weight: bold; border-radius: 99px; }
                        .tag-primary { background: ${d.colors.primary}20; color: ${d.colors.primary}; }
                        .tag-accent { background: ${d.colors.accent}20; color: ${d.colors.accent}; }
                        .mock-avatar { width: 40px; height: 40px; border-radius: 50%; background: ${d.colors.gradients && d.colors.gradients.primary ? d.colors.gradients.primary : d.colors.primary}; color: white; display: flex; items-center: center; justify-content: center; font-size: 14px; font-weight: bold; }
                        .mock-alert { background: ${d.colors.accent}10; border: 1px solid ${d.colors.accent}30; color: ${d.colors.accent}; padding: 16px; border-radius: ${d.ui.radius}; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 12px; width: 100%; box-sizing: border-box; }
                        .mock-dot { width: 8px; height: 8px; background: currentColor; border-radius: 50%; flex-shrink: 0; }
                    </style>

                    <div class="pdf-page">
                    <div class="pdf-page">
                        <div class="header">
                            <!-- Left: Agency Branding & Client Logic -->
                            <div class="agency-col">
                                ${agencyHTML}
                                <div class="client-info">
                                    <span class="client-name">Brand Kit Generated For: ${clientName}</span>
                                    <span>${new Date().toLocaleDateString()}</span>
                                </div>
                            </div>

                            <!-- Right: Project Reference (High Up) -->
                            <div style="text-align:right;">
                                ${logoHTML}
                            </div>
                        </div>


                        <div class="section-title">01. Core Palette</div>
                        <div class="color-grid">
                            <div class="swatch-card">
                                <div class="swatch" style="background:${d.colors.gradients && d.colors.gradients.primary ? d.colors.gradients.primary : d.colors.primary}"></div>
                                <div class="color-meta">
                                    <h3>${d.colors.gradientDetails && d.colors.gradientDetails.primary ? 'Primary (Gradient)' : 'Primary'}</h3>
                                    <p>${d.colors.gradientDetails && d.colors.gradientDetails.primary
                    ? `<span style="font-size: 11px;">${d.colors.gradientDetails.primary.start}</span> <span style="color: #999;"></span> <span style="font-size: 11px;">${d.colors.gradientDetails.primary.end}</span>`
                    : d.colors.primary}</p>
                                </div>
                            </div>
                            <div class="swatch-card">
                                <div class="swatch" style="background:${d.colors.gradients && d.colors.gradients.accent ? d.colors.gradients.accent : d.colors.accent}"></div>
                                <div class="color-meta">
                                    <h3>${d.colors.gradientDetails && d.colors.gradientDetails.accent ? 'Accent (Gradient)' : 'Accent'}</h3>
                                    <p>${d.colors.gradientDetails && d.colors.gradientDetails.accent
                    ? `<span style="font-size: 11px;">${d.colors.gradientDetails.accent.start}</span> <span style="color: #999;"></span> <span style="font-size: 11px;">${d.colors.gradientDetails.accent.end}</span>`
                    : d.colors.accent}</p>
                                </div>
                            </div>
                            <div class="swatch-card"><div class="swatch" style="background:${d.colors.background}; border: 1px solid #ddd;"></div><div class="color-meta"><h3>Background</h3><p>${d.colors.background}</p></div></div>
                            <div class="swatch-card"><div class="swatch" style="background:${d.colors.text}; border: 1px solid #ddd;"></div><div class="color-meta"><h3>Text</h3><p>${d.colors.text}</p></div></div>
                        </div>

                        <div class="section-title">02. Semantic Tokens</div>
                        <div class="token-grid">
                             <div class="token-card"><div class="token-swatch" style="background:${d.semantic.surface}"></div><div class="token-name">Surface</div></div>
                             <div class="token-card"><div class="token-swatch" style="background:${d.semantic.border}"></div><div class="token-name">Border</div></div>
                             <div class="token-card"><div class="token-swatch" style="background:${d.semantic.mutedText}"></div><div class="token-name">Muted</div></div>
                             <div class="token-card"><div class="token-swatch" style="background:${d.semantic.primaryHover}"></div><div class="token-name">Primary Hover</div></div>
                             <div class="token-card"><div class="token-swatch" style="background:${d.semantic.focusRing}"></div><div class="token-name">Focus Ring</div></div>
                        </div>

                        <div class="section-title">03. Typography</div>
                        <div class="type-row">
                            <div class="type-label">Headings<br>${d.typography.heading}</div>
                            <div class="type-example"><h1 style="font-family:${d.typography.heading}">Strategic Design.<br>Brand Consistency.</h1></div>
                        </div>
                        <div class="type-row">
                            <div class="type-label">Body Copy<br>${d.typography.body}</div>
                            <div class="type-example"><p style="font-family:${d.typography.body}">Consistency builds trust. This typography system is designed to ensure optimal readability.</p></div>
                        </div>

                        <div class="div-spacer" style="margin-bottom: 40px;"></div>
                        
                        <!-- Forced Page Break before UI Elements: html2pdf specific class -->
                        <div class="html2pdf__page-break" style="height:0; clear:both; display:block;"></div>
                        <div class="section-title" style="margin-top: 0; padding-top: 40px; border-top: none;">04. UI Elements</div>
                        <div class="ui-showcase">
                            <!-- Card 1: App Card -->
                            <div class="mock-card">
                                <div class="mock-row">
                                    <div class="mock-avatar" style="display:flex; align-items:center; justify-content:center;">AB</div>
                                    <div style="flex:1">
                                        <div class="mock-line" style="width: 60%; height: 10px; margin-bottom: 5px; background: ${d.colors.text}; opacity: 0.8;"></div>
                                        <div class="mock-line" style="width: 40%; height: 8px;"></div>
                                    </div>
                                </div>
                                <div class="mock-line" style="width: 100%; margin-top: 10px;"></div>
                                <div class="mock-line" style="width: 90%"></div>
                                <div class="mock-row" style="margin-top: 10px;">
                                    <div class="mock-tag tag-primary">New</div>
                                    <div class="mock-tag tag-accent">Pro</div>
                                </div>
                                <button class="mock-btn">Get Started</button>
                            </div>

                            <!-- Card 2: Form Elements -->
                            <div class="mock-card">
                                <div class="mock-input-group">
                                    <span class="mock-label">Email Address</span>
                                    <div class="mock-input active">user@example.com</div>
                                </div>
                                
                                <div class="mock-row" style="justify-content: space-between;">
                                    <span class="mock-label" style="margin:0">Notifications</span>
                                    <div class="mock-toggle active"><div class="mock-toggle-circle"></div></div>
                                </div>

                                <div class="mock-alert">
                                     <div class="mock-dot"></div>
                                     <span>Changes Saved</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;

            // Config for html2pdf
            // Config for html2pdf
            const opt = {
                margin: 0,
                filename: fileName + '.pdf',
                image: { type: 'jpeg', quality: 1.0 }, // Max quality
                html2canvas: {
                    scale: 4, // Higher Scale for crisp text
                    useCORS: true,
                    // FIX: Explicitly set capture coordinates to 0,0
                    x: 0,
                    y: 0,
                    scrollX: 0,
                    scrollY: 0,
                    logging: true,
                    letterRendering: true,
                    windowWidth: 794 // Force Desktop width logic even on mobile
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Generate with a slight delay to ensure rendering
            setTimeout(() => {
                html2pdf().from(container.querySelector('.pdf-wrapper')).set(opt).save()
                    .then(() => {
                        document.body.removeChild(container);
                        document.body.style.overflow = originalOverflow; // Restore
                        btn.innerHTML = originalText;
                        showToast("PDF Downloaded Successfully!", "success");
                    })
                    .catch(err => {
                        console.error(err);
                        showToast("Error generating PDF. Check console.", "error");
                        // cleanup even on fail
                        if (document.body.contains(container)) document.body.removeChild(container);
                        document.body.style.overflow = originalOverflow; // Restore
                        btn.innerHTML = originalText;
                    });
            }, 500); // 500ms delay for DOM stabilisation
        }

        // --- PRETTIER NOTIFICATIONS ---
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            let colors = 'bg-gray-800 text-white border-gray-700';
            let icon = 'info';

            if (type === 'success' || msg.toLowerCase().includes('success') || msg.toLowerCase().includes('saved') || msg.toLowerCase().includes('copied')) {
                colors = 'bg-[#052e16] text-[#4ade80] border-[#4ade80]/30 shadow-[0_0_15px_rgba(74,222,128,0.1)]';
                icon = 'check-circle';
                if (type === 'info') type = 'success'; // Auto-detect override
            }
            if (type === 'error' || msg.toLowerCase().includes('error') || msg.toLowerCase().includes('failed') || msg.toLowerCase().includes('invalid') || msg.toLowerCase().includes('please')) {
                colors = 'bg-[#2e0505] text-[#f87171] border-[#f87171]/30 shadow-[0_0_15px_rgba(248,113,113,0.1)]';
                icon = 'alert-octagon';
                if (type === 'info') type = 'error';
            }

            toast.className = `pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl border backdrop-blur-md shadow-2xl transform transition-all duration-500 ease-out translate-y-[-20px] opacity-0 ${colors}`;
            toast.innerHTML = `<i data-feather="${icon}" class="w-4 h-4 shrink-0"></i> <span class="text-xs font-bold tracking-wide">${msg}</span>`;

            container.appendChild(toast);
            feather.replace();

            // Animate In
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-[-20px]', 'opacity-0');
            });

            // Animate Out
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-[-20px]');
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        let currentModalResolve = null;

        function closeModal() {
            const el = document.getElementById('customModal');
            const content = document.getElementById('customModalContent');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => el.classList.add('hidden'), 200);
            if (currentModalResolve) currentModalResolve(false);
            currentModalResolve = null;
        }

        function showConfirm(title, msg) {
            return new Promise((resolve) => {
                const el = document.getElementById('customModal');
                const content = document.getElementById('customModalContent');

                document.getElementById('modalTitle').innerText = title;
                document.getElementById('modalMessage').innerText = msg;

                const btn = document.getElementById('modalConfirmBtn');
                // Remove old listeners by cloning
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);

                newBtn.onclick = () => {
                    // Manually resolve true, close modal
                    if (currentModalResolve) currentModalResolve = null; // Clear global to prevent double resolve
                    const el = document.getElementById('customModal');
                    const content = document.getElementById('customModalContent');
                    content.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => el.classList.add('hidden'), 200);
                    resolve(true);
                };

                // Override global resolve for cancel case (click outside/cancel btn)
                currentModalResolve = resolve;

                el.classList.remove('hidden');
                // Animation
                requestAnimationFrame(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                });
            });
        }

        // Init
        if (localStorage.getItem('reputifly_gemini_key')) {
            document.getElementById('aiBadge').innerText = "AI Active";
            document.getElementById('aiBadge').className = "text-[10px] text-pink-400 border border-pink-500 px-1 rounded";
        }
    </script>
    <!-- TOAST CONTAINER MOVED UP -->

    <!-- CUSTOM MODAL -->
    <div id="customModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="bg-[#0B0A14] border border-white/10 rounded-2xl shadow-2xl p-6 w-full max-w-sm relative transform scale-95 opacity-0 transition-all duration-200"
            id="customModalContent">
            <h3 class="text-lg font-bold text-white mb-2" id="modalTitle">Confirm Action</h3>
            <p class="text-sm text-gray-400 mb-6 leading-relaxed" id="modalMessage">Are you sure you want to proceed?
            </p>
            <div class="flex gap-3 justify-end">
                <button onclick="closeModal()"
                    class="px-4 py-2 text-xs font-bold text-gray-500 hover:text-white transition rounded-lg hover:bg-white/5">Cancel</button>
                <button id="modalConfirmBtn"
                    class="px-4 py-2 text-xs font-bold bg-white text-black rounded-lg hover:bg-gray-200 transition shadow-lg hover:shadow-xl hover:-translate-y-0.5 transform">Confirm</button>
            </div>
        </div>
    </div>
    <!-- EXPORT MODAL -->
    <div id="exportModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeExportModal()">
        </div>
        <div
            class="bg-[#0B0A14] border border-white/10 rounded-2xl shadow-2xl p-6 w-full max-w-sm relative transform transition-all duration-200">
            <h3 class="text-lg font-bold text-white mb-4 brand-font">Export Brand Kit</h3>

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Client Name</label>
                    <input type="text" id="exportClientName" placeholder="e.g. Acme Corp"
                        class="w-full input-glass px-3 py-2 text-sm text-white placeholder-gray-600">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">PDF Filename</label>
                    <input type="text" id="exportFileName" placeholder="brand-identity-v1"
                        class="w-full input-glass px-3 py-2 text-sm text-white placeholder-gray-600">
                </div>
            </div>

            <div class="flex gap-3 justify-end mt-6">
                <button onclick="closeExportModal()"
                    class="px-4 py-2 text-xs font-bold text-gray-500 hover:text-white transition rounded-lg hover:bg-white/5">Cancel</button>
                <button onclick="startPdfExport()"
                    class="px-4 py-2 text-xs font-bold bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition shadow-lg hover:shadow-pink-500/20">Download
                    PDF</button>
            </div>
        </div>
    </div>

    <!-- CUSTOM COLOR PICKER MODAL -->
    <div id="colorModal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div
            class="bg-[#0B0A14] border border-white/10 rounded-xl w-[95%] max-w-md max-h-[90vh] shadow-2xl transform transition-all scale-100 relative overflow-hidden flex flex-col">

            <!-- Modal Header -->
            <div class="flex items-center justify-between p-4 border-b border-white/10 flex-shrink-0">
                <h3 id="colorModalTitle" class="text-white font-bold text-lg brand-font">Edit Color</h3>
                <button onclick="closeColorModal()" class="text-gray-500 hover:text-white transition p-1">
                    <i data-feather="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-white/10 flex-shrink-0">
                <button onclick="switchModalTab('manual')" id="tabModalManual"
                    class="flex-1 py-3 text-sm font-bold text-center transition-colors tab-active relative">
                    Manual
                </button>
                <button onclick="switchModalTab('image')" id="tabModalImage"
                    class="flex-1 py-3 text-sm font-bold text-center transition-colors tab-inactive relative">
                    From Image
                </button>
            </div>

            <!-- Content -->
            <div class="p-4 sm:p-6 min-h-[250px] overflow-y-auto flex-1">

                <!-- MANUAL TAB -->
                <!-- MANUAL TAB -->
                <!-- MANUAL TAB (Main View) -->
                <div id="modalContentManual" class="space-y-6">

                    <!-- View 1: Main Control Panel -->
                    <div id="mainView" class="space-y-6">
                        <!-- Hidden State Inputs -->
                        <input type="hidden" id="modalColorInput" value="#000000">
                        <input type="hidden" id="modalSecondColorInput" value="#000000">

                        <!-- VISUALIZER AREA -->
                        <div id="visualizerContainer"
                            class="flex items-center justify-center gap-3 sm:gap-4 min-h-[110px] sm:min-h-[120px] transition-all duration-300 px-2">

                            <!-- START COLOR (Always Visible) -->
                            <div class="flex flex-col items-center gap-1.5 flex-shrink-0">
                                <div class="relative group cursor-pointer active:scale-95 hover:scale-105 transition-transform duration-300 w-16 h-16 sm:w-20 sm:h-20"
                                    onclick="openPickerView('start')">
                                    <!-- Visual -->
                                    <div id="modalColorPreview"
                                        class="w-full h-full rounded-full border-[3px] border-white/10 shadow-xl flex items-center justify-center bg-blue-500 transition-all z-10 group-hover:border-white/30 active:border-white/40">
                                        <i data-feather="edit-2"
                                            class="w-4 h-4 sm:w-5 sm:h-5 text-white/40 group-hover:text-white group-hover:scale-125 transition-all duration-200"></i>
                                    </div>
                                </div>
                                <p class="text-[9px] text-gray-500 font-semibold uppercase tracking-wide">Start</p>
                                <!-- Start Hex Display -->
                                <div class="relative w-16 sm:w-20">
                                    <span
                                        class="absolute left-1.5 top-1/2 -translate-y-1/2 text-gray-500 font-mono text-[9px]">#</span>
                                    <input type="text" id="modalHexInput" maxlength="7"
                                        class="w-full bg-white/5 border border-white/10 rounded py-1 pl-4 pr-1 text-white font-mono text-[10px] text-center focus:border-pink-500 outline-none transition uppercase"
                                        placeholder="FFFFFF" oninput="updateModalFromHex(this.value)">
                                </div>
                            </div>

                            <!-- ARROW 1 -->
                            <div id="arrow1"
                                class="hidden text-gray-500 animate-in fade-in slide-in-from-left-2 flex-shrink-0">
                                <i data-feather="arrow-right" class="w-4 h-4"></i>
                            </div>

                            <!-- RESULT GRADIENT BOX (Preview Only) -->
                            <div id="gradientResultPreview"
                                class="hidden flex-col items-center gap-1 animate-in fade-in zoom-in duration-300 flex-shrink-0">
                                <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-2xl shadow-inner border-[3px] border-white/10"
                                    id="gradientResultBox"></div>
                                <p class="text-[9px] text-pink-400 font-semibold uppercase tracking-wide">Result</p>
                            </div>

                            <!-- ARROW 2 -->
                            <div id="arrow2"
                                class="hidden text-gray-500 animate-in fade-in slide-in-from-left-2 flex-shrink-0">
                                <i data-feather="arrow-right" class="w-4 h-4"></i>
                            </div>

                            <!-- END COLOR -->
                            <div id="endColorGroupName"
                                class="hidden flex-col items-center gap-1.5 animate-in fade-in slide-in-from-right-4 duration-300 flex-shrink-0">
                                <div class="relative group cursor-pointer active:scale-95 hover:scale-105 transition-transform duration-300 w-16 h-16 sm:w-20 sm:h-20"
                                    onclick="openPickerView('end')">
                                    <!-- Visual -->
                                    <div id="modalSecondColorPreview"
                                        class="w-full h-full rounded-full border-[3px] border-white/10 shadow-xl flex items-center justify-center bg-gray-500 transition-all z-10 group-hover:border-white/30 active:border-white/40">
                                        <i data-feather="edit-2"
                                            class="w-4 h-4 sm:w-5 sm:h-5 text-white/40 group-hover:text-white group-hover:scale-125 transition-all duration-200"></i>
                                    </div>
                                </div>
                                <p class="text-[9px] text-gray-500 font-semibold uppercase tracking-wide">End</p>
                                <!-- End Hex Display -->
                                <div id="modalSecondHexContainer" class="relative w-16 sm:w-20">
                                    <span
                                        class="absolute left-1.5 top-1/2 -translate-y-1/2 text-gray-500 font-mono text-[9px]">#</span>
                                    <input type="text" id="modalSecondHexInput" maxlength="7"
                                        class="w-full bg-white/5 border border-white/10 rounded py-1 pl-4 pr-1 text-white font-mono text-[10px] text-center focus:border-pink-500 outline-none transition uppercase"
                                        placeholder="FFFFFF" oninput="updateGradientSecondHex(this.value)">
                                </div>
                            </div>
                        </div>

                        <!-- ENABLE GRADIENT TOGGLE -->
                        <div class="w-full pt-4 border-t border-white/10 flex items-center justify-between">
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Enable
                                Gradient</span>
                            <label class="relative inline-flex items-center cursor-pointer group">
                                <input type="checkbox" id="gradientToggle" class="sr-only peer"
                                    onchange="toggleModalGradient(this.checked)">
                                <div
                                    class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-pink-500/50 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500 shadow-inner">
                                </div>
                            </label>
                        </div>
                    </div>


                    <!-- View 2: PICKER OVERLAY (Hidden initially) -->
                    <div id="secondaryView"
                        class="hidden flex flex-col items-center justify-center space-y-4 animate-in fade-in zoom-in duration-200">
                        <div class="flex items-center justify-between w-full border-b border-white/10 pb-2 mb-2">
                            <button onclick="closePickerView()"
                                class="text-gray-400 hover:text-white flex items-center gap-1 text-xs font-bold uppercase tracking-wider">
                                <i data-feather="arrow-left" class="w-4 h-4"></i> Back
                            </button>
                            <span id="pickerTitle"
                                class="text-xs font-bold text-pink-400 uppercase tracking-widest">Pick Color</span>
                            <div class="w-10"></div> <!-- Spacer -->
                        </div>

                        <!-- IRO CONTAINER -->
                        <div id="iroPickerContainer"
                            class="p-2 sm:p-4 bg-white/5 rounded-full border border-white/10 shadow-2xl touch-none">
                        </div>

                        <!-- CONFIRM SELECTION BTN -->
                        <button onclick="closePickerView()"
                            class="w-full bg-white text-black font-bold py-3 rounded-lg hover:bg-gray-200 transition shadow-lg text-xs uppercase tracking-wider">
                            Done
                        </button>
                    </div>

                </div>

                <!-- IMAGE TAB -->
                <div id="modalContentImage" class="hidden">
                    <p class="text-xs text-gray-500 mb-4 uppercase font-bold text-center">Extracted from Uploaded Image
                    </p>
                    <div id="modalPaletteGrid" class="grid grid-cols-5 gap-3">
                        <!-- Swatches injected here -->
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-white/10 bg-white/5 rounded-b-xl flex justify-end gap-2">
                <button onclick="closeColorModal()"
                    class="px-4 py-2 text-xs font-bold text-gray-400 hover:text-white transition rounded-lg hover:bg-white/5">Cancel</button>
                <button onclick="applyColorFromModal()"
                    class="btn-primary px-6 py-2 text-xs font-bold shadow-lg shadow-pink-500/20">Apply Change</button>
            </div>
        </div>
    </div>

    <style>
        .tab-active {
            color: #E6397F;
            border-bottom: 2px solid #E6397F;
            background: linear-gradient(to bottom, transparent, rgba(230, 57, 127, 0.05));
        }

        .tab-inactive {
            color: #6b7280;
            border-bottom: 2px solid transparent;
        }

        .tab-inactive:hover {
            color: #d1d5db;
            background: rgba(255, 255, 255, 0.02);
        }
    </style>

    <script>
        // --- CUSTOM COLOR MODAL LOGIC ---
        let activeColorTargetId = null; // 'colPrimary', 'colText' etc.
        let activeColorTargetName = ''; // 'Primary', 'Text' etc.
        let currentModalColor = '#000000';
        let currentModalGradient = null; // Temp store
        let activeModalChannel = 'start'; // 'start' or 'end'
        let colorPicker = null; // iro.js instance
        window.extractedPalette = []; // Store globally

        function switchModalTab(tab) {
            const manBtn = document.getElementById('tabModalManual');
            const imgBtn = document.getElementById('tabModalImage');
            const manContent = document.getElementById('modalContentManual');
            const imgContent = document.getElementById('modalContentImage');

            if (tab === 'manual') {
                manBtn.classList.add('tab-active');
                manBtn.classList.remove('tab-inactive');
                imgBtn.classList.remove('tab-active');
                imgBtn.classList.add('tab-inactive');

                manContent.classList.remove('hidden');
                imgContent.classList.add('hidden');
            } else {
                imgBtn.classList.add('tab-active');
                imgBtn.classList.remove('tab-inactive');
                manBtn.classList.remove('tab-active');
                manBtn.classList.add('tab-inactive');

                imgContent.classList.remove('hidden');
                manContent.classList.add('hidden');
            }
        }

        function openColorModal(targetId, targetName) {
            activeColorTargetId = targetId;
            activeColorTargetName = targetName;

            // Map ID to Key (colPrimary -> primary)
            const key = targetId.replace('col', '').toLowerCase();

            // Get current value
            const currentVal = document.getElementById(targetId).value;
            currentModalColor = currentVal;

            // Reset Gradient UI
            const gm = window.gradientMap || {};
            currentModalGradient = gm[key] || null;

            const toggle = document.getElementById('gradientToggle');
            const secondContainer = document.getElementById('gradientSecondColorContainer');

            if (currentModalGradient) {
                toggle.checked = true;

                // SHOW UI Flow
                toggleModalGradient(true); // Reuse the logic

                // Load existing end color if available
                let endColor = '#000000';
                if (window.gradientDetails && window.gradientDetails[key] && window.gradientDetails[key].end) {
                    endColor = window.gradientDetails[key].end;
                } else {
                    // Fallback parse?
                    endColor = generateDeepColor(currentModalColor);
                }
                updateSecondColorInputs(endColor);
            } else {
                toggle.checked = false;
                toggleModalGradient(false);
            }

            // Prep UI
            document.getElementById('colorModalTitle').innerText = `Edit ${targetName} Color`;
            document.getElementById('modalHexInput').value = currentVal.replace('#', '').toUpperCase();

            // Set Channel Start
            activeModalChannel = 'start';
            updateModalPreviewUI();

            // Init or Update Picker
            if (!colorPicker) {
                // Responsive size based on screen width
                const pickerWidth = window.innerWidth < 640 ? Math.min(window.innerWidth - 100, 200) : 220;

                colorPicker = new iro.ColorPicker("#iroPickerContainer", {
                    width: pickerWidth,
                    color: currentVal,
                    borderWidth: 2,
                    borderColor: "#fff",
                    layout: [
                        { component: iro.ui.Wheel, options: {} },
                        { component: iro.ui.Slider, options: { sliderType: 'value', margin: 20 } },
                    ]
                });
                colorPicker.on('color:change', function (color) {
                    if (activeModalChannel === 'start') {
                        updateModalManual(color.hexString);
                    } else {
                        updateGradientManual(color.hexString);
                    }
                });
            }

            // Ensure Main View is active and Picker View closed
            closePickerView();

            // Highlight Active Channel UI (Virtual)
            // setActiveChannel('start'); // Deprecated visual call, just set state
            activeModalChannel = 'start';

            // Reset Tab to Manual defaults
            switchModalTab('manual');

            // Render Palette (Generic)
            renderModalPalette();

            // Show
            const modal = document.getElementById('colorModal');
            modal.classList.remove('hidden');
            feather.replace();
        }

        // --- SUB-VIEW LOGIC ---
        function openPickerView(channel) {
            activeModalChannel = channel;

            // Sync Picker color to current channel color
            if (colorPicker) {
                const hex = (channel === 'start')
                    ? currentModalColor
                    : (document.getElementById('modalSecondColorInput').value || currentModalColor);
                colorPicker.color.hexString = hex;
            }

            // Update Header Title
            const title = (channel === 'start') ? "Picking Start Color" : "Picking End Color";
            document.getElementById('pickerTitle').innerText = title;

            // Switch Views
            document.getElementById('mainView').classList.add('hidden');
            document.getElementById('secondaryView').classList.remove('hidden');
            document.getElementById('secondaryView').classList.add('flex');
        }

        function closePickerView() {
            document.getElementById('secondaryView').classList.add('hidden');
            document.getElementById('secondaryView').classList.remove('flex');
            document.getElementById('mainView').classList.remove('hidden');
            feather.replace();
        }

        function setActiveChannel(channel) {
            openPickerView(channel);
        }

        function closeColorModal() {
            const modal = document.getElementById('colorModal');
            modal.classList.add('hidden');
        }

        // Initialize Global Gradient Metadata
        if (!window.gradientDetails) window.gradientDetails = {};

        // --- GRADIENT GENERATOR ---
        function toggleModalGradient(isActive) {
            // UI FOR NEW FLOW
            const arrow1 = document.getElementById('arrow1');
            const arrow2 = document.getElementById('arrow2');
            const resultBox = document.getElementById('gradientResultPreview');
            const endGroup = document.getElementById('endColorGroupName');
            const secondHexParams = document.getElementById('modalSecondHexContainer');
            const container = document.getElementById('visualizerContainer');

            if (isActive) {
                arrow1.classList.remove('hidden');
                arrow2.classList.remove('hidden');
                resultBox.classList.remove('hidden');
                resultBox.classList.add('flex');
                endGroup.classList.remove('hidden');
                endGroup.classList.add('flex');
                secondHexParams.classList.remove('hidden');

                // Container stays centered - no justify manipulation needed


                // If no gradient exists, generate default "Deep" gradient
                if (!currentModalGradient || typeof currentModalGradient !== 'string' || !currentModalGradient.includes('linear-gradient')) {
                    const defaultEnd = generateDeepColor(currentModalColor);
                    currentModalGradient = `linear-gradient(135deg, ${currentModalColor} 0%, ${defaultEnd} 100%)`;

                    // CRITICAL: Store gradient details for PDF export
                    window.tempGradient = { start: currentModalColor, end: defaultEnd };

                    // Init Second Color Inputs
                    updateSecondColorInputs(defaultEnd);
                } else {
                    // If exists, try to parse end color or just default
                    // Ideally we'd parse, but for MVP let's just ensure input is synced if we have metadata
                    if (window.tempGradient && window.tempGradient.end) {
                        updateSecondColorInputs(window.tempGradient.end);
                    }
                }
            } else {
                arrow1.classList.add('hidden');
                arrow2.classList.add('hidden');
                resultBox.classList.add('hidden');
                resultBox.classList.remove('flex');
                endGroup.classList.add('hidden');
                endGroup.classList.remove('flex');
                secondHexParams.classList.add('hidden');

                // Container stays centered - no changes needed

                currentModalGradient = null;
                window.tempGradient = null;
            }
            updateModalPreviewUI();
        }

        function generateDeepColor(hex) {
            const rgb = hexToRgbVals(hex);
            if (!rgb) return hex;
            const hsl = rgbToHsl(rgb[0], rgb[1], rgb[2]);
            const h2 = (hsl[0] + 15) % 360;
            const s2 = Math.min(100, hsl[1] + 10);
            let l2 = Math.max(5, hsl[2] - 25);
            if (hsl[2] > 90) l2 = hsl[2] - 10;
            const rgb2 = hslToRgb(h2, s2, l2);
            return rgbToHex(...rgb2);
        }

        // Logic split: generateGradient is now just for automatic "Deep" calc
        function generateGradient(hex) {
            const end = generateDeepColor(hex);
            window.tempGradient = { start: hex, end: end };
            // Also update UI for second color since start changed
            updateSecondColorInputs(end);
            return `linear-gradient(135deg, ${hex} 0%, ${end} 100%)`;
        }

        function updateSecondColorInputs(hex) {
            document.getElementById('modalSecondColorInput').value = hex;
            document.getElementById('modalSecondColorPreview').style.backgroundColor = hex;
            document.getElementById('modalSecondHexInput').value = hex.replace('#', '').toUpperCase();
        }

        function updateGradientManual(val) {
            // User manually changed the Second Color
            const endHex = val;
            const startHex = currentModalColor;

            currentModalGradient = `linear-gradient(135deg, ${startHex} 0%, ${endHex} 100%)`;
            window.tempGradient = { start: startHex, end: endHex };

            updateSecondColorInputs(endHex);
            updateModalPreviewUI();
        }

        function updateGradientSecondHex(val) {
            if (val.length === 6) {
                const hex = '#' + val;
                if (/^#[0-9A-F]{6}$/i.test(hex)) {
                    updateGradientManual(hex);
                }
            }
        }

        function updateModalManual(val) {
            currentModalColor = val;
            document.getElementById('modalHexInput').value = val.replace('#', '').toUpperCase();

            // Regenerate gradient if active
            const isGradient = document.getElementById('gradientToggle').checked;
            if (isGradient) {
                // If user changes Start Color, do we keep End Color or Shift it?
                // Let's Keep End Color for manual control, OR Shift if they haven't touched it? 
                // Simple approach: Keep End Color fixed if they set it, but for smooth feel, let's keep the *Relationship*?
                // Actually user requested "select the other gradient colour". So if they change Start, End should stay as is unless they change it?
                // existing logic was "Make Gradient" auto-generated.
                // Let's use the current value of the Second Input as the End Color.

                const currentEnd = document.getElementById('modalSecondColorInput').value;
                currentModalGradient = `linear-gradient(135deg, ${val} 0%, ${currentEnd} 100%)`;
                window.tempGradient = { start: val, end: currentEnd };
            }
            updateModalPreviewUI();
        }

        // --- COLOR UTILS (HSL) ---
        function rgbToHsl(r, g, b) {
            r /= 255, g /= 255, b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0; // achromatic
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [h * 360, s * 100, l * 100];
        }

        function hslToRgb(h, s, l) {
            let r, g, b;
            h /= 360; s /= 100; l /= 100;

            if (s === 0) {
                r = g = b = l; // achromatic
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1 / 6) return p + (q - p) * 6 * t;
                    if (t < 1 / 2) return q;
                    if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1 / 3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1 / 3);
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }

        function updateModalPreviewUI() {
            // 1. Update Start Ring
            document.getElementById('modalColorPreview').style.background = currentModalColor;

            // 2. Update Result Box (if Gradient)
            const resultBox = document.getElementById('gradientResultBox');
            if (currentModalGradient) {
                resultBox.style.background = currentModalGradient;
            } else {
                resultBox.style.background = currentModalColor;
            }
        }



        function updateModalFromHex(val) {
            if (val.length === 6) {
                const hex = '#' + val;
                // Simple regex check
                if (/^#[0-9A-F]{6}$/i.test(hex)) {
                    // Use updateModalManual to ensure gradient details are saved
                    updateModalManual(hex);
                    if (colorPicker && activeModalChannel === 'start') colorPicker.color.hexString = hex;
                }
            }
        }

        function selectPaletteColor(hex) {
            // document.getElementById('modalColorInput').value = hex; // Removed
            if (colorPicker) colorPicker.color.hexString = hex; // Sync picker
            updateModalManual(hex);
            showToast(`Selected ${hex}`, 'info');
            switchModalTab('manual');
        }

        function applyColorFromModal() {
            if (activeColorTargetId) {
                const input = document.getElementById(activeColorTargetId);
                input.value = currentModalColor;

                // Map ID to Key for Gradient Storage
                const key = activeColorTargetId.replace('col', '').toLowerCase();

                // Update Gradient Map
                if (!window.gradientMap) window.gradientMap = {};
                if (!window.gradientDetails) window.gradientDetails = {};

                window.gradientMap[key] = currentModalGradient; // null or string

                // Store Gradient Details (Start/End) or Clean up
                if (currentModalGradient && window.tempGradient) {
                    window.gradientDetails[key] = window.tempGradient;
                } else {
                    delete window.gradientDetails[key];
                }

                // Update text label (hexPrimary etc.)
                const labelId = input.id.replace('col', 'hex'); // colPrimary -> hexPrimary
                const label = document.getElementById(labelId);
                if (label) label.innerText = currentModalColor; // We keep hex as the "Code"

                // If Gradient, show toast
                if (currentModalGradient) showToast("Gradient Applied!", "success");
                else showToast(`${activeColorTargetName} updated!`, "success");

                updatePreview();
            }
            closeColorModal();
        }

        function renderModalPalette() {
            const grid = document.getElementById('modalPaletteGrid');
            grid.innerHTML = '';

            if (!window.extractedPalette || window.extractedPalette.length === 0) {
                grid.innerHTML = '<div class="col-span-5 text-center py-8 text-gray-600 italic text-xs">No image uploaded or extracted colors found.</div>';
                return;
            }

            window.extractedPalette.forEach(rgb => {
                const hex = rgbToHex(...rgb);
                const btn = document.createElement('button');
                btn.className = "w-10 h-10 rounded-full border border-white/20 hover:scale-110 transition shadow-sm relative group bg-cover";
                btn.style.backgroundColor = hex;
                btn.onclick = () => selectPaletteColor(hex);

                // Tooltip
                btn.innerHTML = `<span class="absolute -top-6 left-1/2 -translate-x-1/2 bg-black text-[10px] text-white px-2 py-0.5 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap pointer-events-none z-10">${hex}</span>`;

                grid.appendChild(btn);
            });
        }

        // --- AI PACKAGER LOGIC ---
        function openAIPackager() {
            document.getElementById('aiPackagerModal').classList.remove('hidden');
            document.getElementById('aiPackagerLogArea').classList.add('hidden');
            document.getElementById('aiPackagerLogArea').innerHTML = `> Waiting to start...`;
            document.getElementById('btnGenerateAI').disabled = false;
            document.getElementById('btnGenerateAI').innerHTML = "Generate & Download ZIP";
        }
        function closeAIPackager() {
            document.getElementById('aiPackagerModal').classList.add('hidden');
        }

        async function generateAIWebsitePack() {
            const scopeDesc = document.getElementById('aiScopeInput').value.trim();
            const logArea = document.getElementById('aiPackagerLogArea');
            const btn = document.getElementById('btnGenerateAI');

            // Check API Key
            let apiKey = document.getElementById('apiKeyInputModal').value;
            if (!apiKey) apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                showToast("Please save your Gemini API Key in Settings first!", "error");
                toggleSettings();
                return;
            }

            if (!scopeDesc) {
                showToast("Please describe your website scope.", "error"); return;
            }

            // UI Loading
            logArea.classList.remove('hidden');
            btn.disabled = true;
            btn.innerHTML = `<i data-feather="loader" class="w-4 h-4 animate-spin"></i> Planning Architecture...`;
            feather.replace();

            function addLog(msg, type = 'text-gray-400') {
                logArea.innerHTML += `<div class="${type}">${msg}</div>`;
                logArea.scrollTop = logArea.scrollHeight;
            }

            try {
                addLog("> Synthesizing Brand Tokens...");
                const brandData = getBrandData();

                // Construct Gemini Prompt
                const systemInstruction = `You are an Expert UI/UX Architect and Technical Planner. Your job is to define the Layout and Structure for a website based on the user's description.
You must output a highly structured JSON array of \"Pages\", where each page has \"Sections\".
For each section, define:
1. "section_name": (e.g. Hero, Features, Testimonials)
2. "purpose": What this section achieves.
3. "layout_design": Highly specific layout instructions (e.g. "Split screen 50/50. Left side contains typography, right side contains a 3D glassmorphic card overlapping a circular gradient."). Do NOT be generic. Be creative but professional. Avoid generic descriptions like "A nice clean layout".`;

                const userPrompt = `Based on this business: "${scopeDesc}", generate a complete recommended Sitemap and detailed layout design for every section on every page. Output ONLY valid JSON matching the schema logic requested.`;

                addLog("> Contacting Gemini 2.5 Flash API...");
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        systemInstruction: { parts: [{ text: systemInstruction }] },
                        contents: [{ parts: [{ text: userPrompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) throw new Error("API Request Failed");

                const data = await response.json();
                const aiResponseText = data.candidates[0].content.parts[0].text;
                const layoutJson = JSON.parse(aiResponseText);

                addLog(">  Received AI Layout Plan.");
                addLog("> Generating Markdown & Prompt files...");

                // Save formatted plan for the zip file
                let generatedLayoutPlan = `# Website Architecture & Layout Plan\n\n**Scope:** ${scopeDesc}\n\n`;
                layoutJson.forEach((page, i) => {
                    const pageName = page.page_name || page.page || `Page ${i + 1}`;
                    generatedLayoutPlan += `## Page: ${pageName}\n`;
                    (page.sections || []).forEach(sec => {
                        const secName = sec.section_name || sec.name || "Section";
                        const purp = sec.purpose || "";
                        const lay = sec.layout_design || sec.layout || "";
                        generatedLayoutPlan += `### ${secName}\n**Purpose:** ${purp}\n**Layout Structure:** ${lay}\n\n`;
                    });
                    generatedLayoutPlan += `---\n`;
                });

                // Assemble Mega Prompt
                const semantic = generateSemanticTokens({
                    primary: brandData.colors.primary, accent: brandData.colors.accent,
                    background: brandData.colors.background, text: brandData.colors.text
                });
                const megaPrompt = assembleMegaPromptForge(layoutJson, brandData, semantic);

                addLog("> Zipping Package...");
                const zip = new JSZip();
                zip.file("_START_HERE_PROMPT.txt", megaPrompt);
                zip.file("Architecture_Layout_Plan.md", generatedLayoutPlan);
                zip.file("brand_tokens.json", JSON.stringify(brandData, null, 2));
                zip.file("site_structure.json", JSON.stringify(layoutJson, null, 2));

                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `Design_Pack_${Date.now()}.zip`);

                addLog(">  Successfully Downloaded!", "text-green-400");
                showToast("Design Pack Downloaded!", "success");

                setTimeout(() => closeAIPackager(), 2500);

            } catch (error) {
                addLog(`>  Failure: ${error.message}`, 'text-red-400');
                console.error(error);
                btn.disabled = false;
                btn.innerHTML = "Retry Generation";
            }
            feather.replace();
        }

        function assembleMegaPromptForge(layoutPlan, b, semantic) {
            return `### SYSTEM ROLE
You are a Senior Frontend Engineer / Design System Architect.
Your objective is to build a complete, pixel-perfect, interactive website using pure HTML, Vanilla CSS, and JavaScript based *exactly* on the specifications provided below.
Output all code in a single generic file or break it up if requested, but it MUST be production-ready.

---
### PART 1: BRAND IDENTITY & DESIGN TOKENS (STRICT)
You MUST map these values into :root CSS variables and use them exclusively. Do not hardcode random hex values.

**Colors:**
- Primary: ${b.colors.primary}
- Primary Hover: ${semantic.primaryHover}
- On Primary (Text on Primary Bg): ${semantic.onPrimary}
- Accent: ${b.colors.accent}
- Background: ${b.colors.background}
- Text: ${b.colors.text}
- Surface/Card Bg: ${semantic.surface}
- Border: ${semantic.border}

**Typography:**
- Heading Font: ${b.typography.heading}
- Body Font: ${b.typography.body}

**UI DNA:**
- Border Radius Base: ${b.ui.radius}
- Shadows: ${b.ui.shadow}

---
### PART 2: ARCHITECTURE & LAYOUT PLAN
Implement the following architecture accurately. Read the Layout Design instructions carefully to understand the structure of each section.

\`\`\`json
${JSON.stringify(layoutPlan, null, 2)}
\`\`\`

---
### PART 3: IMPLEMENTATION DIRECTIVES
1. Ensure sufficient padding (use padding utilities like py-20 for sections).
2. Responsiveness: Everything must look perfect on Mobile (stacked) and Desktop (grid/flex).
3. Ensure hover states on buttons and links are visually distinct using the provided primaryHover token.

Begin your output.`;
        }
    </script>
</body>

</html>
