<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reputifly | Brand Forge</title>
    <link rel="icon" type="image/png"
        href="https://media.licdn.com/dms/image/v2/D560BAQEScnUkJITXAg/company-logo_200_200/B56ZajOckKHsAI-/0/1746495195792?e=2147483647&v=beta&t=Z7yQpp5jSwm-De46D45WIC5fY_2w0GVgEWLoEOM1aug">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lato:wght@400;700&family=Merriweather:wght@400;700&family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;600&family=Oswald:wght@500;700&family=Playfair+Display:wght@700&family=Poppins:wght@400;600;700&family=Raleway:wght@400;700&family=Roboto:wght@400;700&family=Source+Sans+3:wght@400;600&family=Space+Grotesk:wght@500;700&family=Work+Sans:wght@400;600&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-deep: #0B0A14;
            --panel-bg: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
            --accent: #E6397F;
            --accent-glow: #FF8A00;
        }

        body {
            background-color: var(--bg-deep);
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            color: #F0F0F0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow: hidden;
        }

        h1,
        h2,
        h3,
        .brand-font {
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -0.02em;
        }

        /* --- FIX: DROPDOWN VISIBILITY --- */
        select option {
            background-color: #050507;
            /* Dark Background */
            color: #F0F0F0;
            /* Light Text */
            padding: 10px;
        }

        /* --- UI: LUXURY SCROLLBAR --- */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            transition: background 0.2s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
            /* Pink on hover */
        }

        /* Preview Vars */
        #livePreview {
            --p-primary: #3b82f6;
            --p-accent: #E6397F;
            --p-bg: #ffffff;
            --p-text: #1e293b;
            --p-font-head: 'Inter';
            --p-font-body: 'Inter';
            --p-radius: 8px;
            --p-btn-radius: 8px;
            /* Separate var for buttons */
            /* New Vars */
            --p-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --p-blur: none;
            --p-card-bg: rgba(128, 128, 128, 0.05);
        }

        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px -5px rgba(230, 57, 127, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            color: #ccc;
            padding: 8px 16px;
            border-radius: 9999px;
            /* Pill */
            font-size: 13px;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .input-glass {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 12px;
            /* Increased rounding */
            color: white;
            transition: 0.2s;
        }

        .input-glass:focus {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.05);
            outline: none;
        }

        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 12px;
            transition: 0.2s;
            background: rgba(255, 255, 255, 0.02);
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: rgba(230, 57, 127, 0.05);
        }

        /* Preview Styles */
        .preview-frame {
            background-color: var(--p-bg);
            color: var(--p-text);
            font-family: var(--p-font-body);
            transition: 0.3s;
            transition-property: background-color, color, font-family, width, box-shadow;
        }

        .preview-h {
            font-family: var(--p-font-head);
        }

        .preview-btn {
            background-color: var(--p-primary);
            color: var(--p-on-primary);
            /* DYNAMIC TEXT COLOR */
            border-radius: var(--p-btn-radius);
            font-weight: 600;
        }

        .preview-card {
            background-color: var(--p-card-bg);
            backdrop-filter: var(--p-blur);
            box-shadow: var(--p-shadow);
            border: 1px solid var(--p-border);
            border-radius: var(--p-radius);
        }

        /* Semantic Token Usage in Preview */
        .preview-btn {
            background-color: var(--p-primary);
            color: white;
            border-radius: var(--p-btn-radius);
        }

        .preview-btn:hover {
            background-color: var(--p-primary-hover);
        }

        .preview-muted {
            color: var(--p-muted);
        }

        .preview-surface {
            background-color: var(--p-surface);
            border: 1px solid var(--p-border);
        }

        input[type="color"] {
            -webkit-appearance: none;
            appearance: none;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }
    </style>
</head>

<body class="flex flex-col md:flex-row h-screen overflow-hidden bg-black text-white relative">

    <!-- Mobile Backdrop -->
    <div id="mobileBackdrop" onclick="toggleSidebar()"
        class="fixed inset-0 bg-black/80 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <!-- SIDEBAR -->
    <div id="sidebar"
        class="fixed inset-y-0 left-0 w-[85%] max-w-[400px] md:static md:w-[400px] flex-shrink-0 bg-[#0B0A14] border-r border-white/10 flex flex-col z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-[cubic-bezier(0.16,1,0.3,1)] shadow-2xl md:shadow-none h-full max-h-screen">

        <!-- Header -->
        <div class="p-6 border-b border-white/10 bg-[#0B0A14]/90 backdrop-blur shrink-0 z-10">
            <div class="flex items-center justify-center py-2">
                <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png"
                    alt="Reputifly" class="h-10 w-auto object-contain hover:opacity-90 transition">
            </div>
            <div class="flex items-center justify-between mt-2">
                <span class="text-[10px] text-gray-500 uppercase tracking-widest font-bold">Brand Design</span>
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-white transition p-1">
                    <i data-feather="settings" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
            <div>
                <div class="flex justify-between mb-4">
                    <label class="text-xs font-bold text-gray-500 uppercase">Input Source</label>
                    <span id="aiBadge" class="text-[10px] text-gray-600 border border-gray-700 px-1 rounded">Offline
                        Mode</span>
                </div>

                <!-- TABS -->
                <div class="flex border-b border-white/10 mb-6">
                    <button id="tabLogo" onclick="switchTab('logo')"
                        class="flex-1 py-2 text-xs font-bold text-pink-400 border-b-2 border-pink-400 transition-colors">Logo
                        Available</button>
                    <button id="tabNoLogo" onclick="switchTab('nologo')"
                        class="flex-1 py-2 text-xs font-bold text-gray-500 hover:text-white border-b-2 border-transparent transition-colors">No
                        Logo</button>
                </div>

                <!-- TAB CONTENT: LOGO -->
                <div id="contentLogo">
                    <div class="upload-zone p-6 text-center relative group mb-4"
                        onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" class="hidden" accept="image/*" onchange="handleImage(this)">
                        <div id="uploadPlaceholder">
                            <i data-feather="image" class="w-8 h-8 mx-auto text-gray-600 mb-2"></i>
                            <p class="text-sm text-gray-400">Drop Logo (Auto-Extract)</p>
                        </div>
                        <img id="previewImg" class="hidden max-h-32 mx-auto rounded shadow-lg object-contain">
                        <div
                            class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-xs text-white">
                            Change Image</div>
                    </div>
                </div>

                <!-- TAB CONTENT: NO LOGO -->
                <div id="contentNoLogo" class="hidden">
                    <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Brand Description /
                        Context</label>
                    <textarea id="brandContext" rows="3"
                        class="w-full input-glass px-3 py-2 text-xs text-gray-300 placeholder-gray-600"
                        placeholder="e.g. A futuristic fintech startup for Gen Z..."></textarea>
                </div>
            </div>

            <div>
                <label class="text-xs font-bold text-gray-500 uppercase mb-3 block">Brand Palette
                    (Auto-Detected)</label>
                <!-- CONTRAST CHECKS -->
                <div class="grid grid-cols-1 gap-3">
                    <!-- Primary Row -->
                    <div class="bg-white/5 p-3 rounded-lg border border-white/5 relative group">
                        <div class="flex items-center gap-3 mb-2">
                            <input type="color" id="colPrimary" value="#3b82f6" data-original="#3b82f6"
                                oninput="updatePreview()">
                            <div class="flex-1">
                                <p class="text-[10px] text-gray-500 uppercase">Primary</p>
                                <p id="hexPrimary" class="text-xs font-mono">#3b82f6</p>
                            </div>
                            <button onclick="resetColor('colPrimary')"
                                class="text-gray-600 hover:text-white opacity-0 group-hover:opacity-100 transition"
                                title="Reset Color"><i data-feather="refresh-cw" class="w-3 h-3"></i></button>
                        </div>
                        <div id="warnPrimary"
                            class="hidden flex items-center justify-between text-[10px] bg-red-400/10 text-red-400 px-2 py-1 rounded">
                            <span class="flex items-center gap-1"><i data-feather="alert-circle" class="w-3 h-3"></i>
                                Low Contrast (Text)</span>
                            <button onclick="fixContrast('primary')" class="underline hover:text-white">Fix</button>
                        </div>
                    </div>

                    <!-- Accent Row -->
                    <div class="bg-white/5 p-3 rounded-lg border border-white/5 relative group">
                        <div class="flex items-center gap-3 mb-2">
                            <input type="color" id="colAccent" value="#E6397F" data-original="#E6397F"
                                oninput="updatePreview()">
                            <div class="flex-1">
                                <p class="text-[10px] text-gray-500 uppercase">Accent</p>
                                <p id="hexAccent" class="text-xs font-mono">#E6397F</p>
                            </div>
                            <button onclick="resetColor('colAccent')"
                                class="text-gray-600 hover:text-white opacity-0 group-hover:opacity-100 transition"
                                title="Reset Color"><i data-feather="refresh-cw" class="w-3 h-3"></i></button>
                        </div>
                        <!-- We typically check accent against BG for visibility -->
                        <div id="warnAccent"
                            class="hidden flex items-center justify-between text-[10px] bg-red-400/10 text-red-400 px-2 py-1 rounded">
                            <span class="flex items-center gap-1"><i data-feather="alert-circle" class="w-3 h-3"></i>
                                Hard to read on BG</span>
                            <button onclick="fixContrast('accent')" class="underline hover:text-white">Fix</button>
                        </div>
                    </div>

                    <!-- Bg & Text Pair -->
                    <div class="bg-white/5 p-3 rounded-lg border border-white/5 space-y-3 relative group">
                        <div class="flex items-center gap-3">
                            <input type="color" id="colBg" value="#FFFFFF" data-original="#FFFFFF"
                                oninput="updatePreview()">
                            <div class="flex-1">
                                <p class="text-[10px] text-gray-500 uppercase">Background</p>
                                <p id="hexBg" class="text-xs font-mono">#FFFFFF</p>
                            </div>
                            <button onclick="resetColor('colBg')"
                                class="text-gray-600 hover:text-white opacity-0 group-hover:opacity-100 transition"
                                title="Reset Color"><i data-feather="refresh-cw" class="w-3 h-3"></i></button>
                        </div>
                        <div class="flex items-center gap-3">
                            <input type="color" id="colText" value="#1e293b" data-original="#1e293b"
                                oninput="updatePreview()">
                            <div class="flex-1">
                                <p class="text-[10px] text-gray-500 uppercase">Text</p>
                                <p id="hexText" class="text-xs font-mono">#1e293b</p>
                            </div>
                            <button onclick="resetColor('colText')"
                                class="text-gray-600 hover:text-white opacity-0 group-hover:opacity-100 transition"
                                title="Reset Color"><i data-feather="refresh-cw" class="w-3 h-3"></i></button>
                        </div>
                        <div id="warnText"
                            class="hidden flex items-center justify-between text-[10px] bg-red-400/10 text-red-400 px-2 py-1 rounded">
                            <span class="flex items-center gap-1"><i data-feather="alert-circle" class="w-3 h-3"></i>
                                Unreadable Text</span>
                            <button onclick="fixContrast('text')" class="underline hover:text-white">Fix</button>
                        </div>
                        <!-- THEME TOGGLE -->
                        <button onclick="invertTheme()"
                            class="w-full mt-1 bg-white/5 border border-white/10 rounded py-1.5 text-xs text-gray-400 hover:text-white flex items-center justify-center gap-2 transition">
                            <i data-feather="sun" class="w-3 h-3"></i> Invert Light/Dark
                        </button>
                    </div>
                </div>
            </div>

            <div class="relative">
                <div class="flex justify-between mb-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">Typography & Shape</label>
                    <button onclick="askAI()" id="aiBtn"
                        class="text-[10px] flex items-center gap-1 text-pink-400 hover:text-pink-300 transition hidden border border-pink-500/30 px-2 py-0.5 rounded backdrop-blur-md bg-pink-500/10"><i
                            data-feather="zap" class="w-3 h-3"></i> Refine with AI</button>
                </div>

                <div class="space-y-3">
                    <select id="fontHead" class="w-full input-glass px-3 py-2 text-sm text-gray-300"
                        onchange="updatePreview()">
                        <option value="'Inter', sans-serif">Inter (Modern Sans)</option>
                        <option value="'Space Grotesk', sans-serif">Space Grotesk (Tech)</option>
                        <option value="'Playfair Display', serif">Playfair Display (Luxury Serif)</option>
                        <option value="'Roboto', sans-serif">Roboto (Clean)</option>
                        <option value="'Poppins', sans-serif">Poppins (Friendly)</option>
                        <option value="'Montserrat', sans-serif">Montserrat (Geometric)</option>
                        <option value="'Oswald', sans-serif">Oswald (Bold Condensed)</option>
                        <option value="'Raleway', sans-serif">Raleway (Elegant)</option>
                        <option value="'Merriweather', serif">Merriweather (Classic Serif)</option>
                        <option value="'Work Sans', sans-serif">Work Sans (Minimal)</option>
                    </select>

                    <select id="fontBody" class="w-full input-glass px-3 py-2 text-sm text-gray-300"
                        onchange="updatePreview()">
                        <option value="'Inter', sans-serif">Body: Inter</option>
                        <option value="'Roboto', sans-serif">Body: Roboto</option>
                    </select>

                    <div class="bg-white/5 p-3 rounded-lg border border-white/5">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] text-gray-500 uppercase font-bold">Base Radius</span>
                            <span id="radiusVal" class="text-[10px] font-mono text-pink-400">8px</span>
                        </div>
                        <input type="range" id="radiusInput" min="0" max="24" value="8"
                            class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer mb-3"
                            oninput="updateRadiusFromSlider(this.value)">

                        <div class="flex items-center gap-2 border-t border-white/5 pt-2">
                            <input type="checkbox" id="pillToggle" class="accent-pink-500 w-3 h-3"
                                onchange="togglePill(this.checked)">
                            <label for="pillToggle" class="text-xs text-gray-400 select-none cursor-pointer">Force Pill
                                Buttons</label>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 pt-2">
                        <div>
                            <span class="text-[10px] text-gray-500 uppercase mb-1 block">Shadows</span>
                            <select id="uiShadow" class="w-full input-glass px-2 py-1 text-xs text-gray-300"
                                onchange="updatePreview()">
                                <option value="none">Flat</option>
                                <option value="0 4px 6px -1px rgba(0, 0, 0, 0.1)">Soft</option>
                                <option
                                    value="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)">
                                    Heavy</option>
                                <option value="4px 4px 0px 0px rgba(0,0,0,1)">Retro</option>
                            </select>
                        </div>
                        <div>
                            <span class="text-[10px] text-gray-500 uppercase mb-1 block">Glass</span>
                            <select id="uiGlass" class="w-full input-glass px-2 py-1 text-xs text-gray-300"
                                onchange="updatePreview()">
                                <option value="none">Solid</option>
                                <option value="blur(12px)">Frosted</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FOOTER ACTIONS -->
            <div class="border-t border-white/10 pt-4 space-y-2">

                <!-- Main Exports -->
                <!-- Main Exports -->
                <button onclick="downloadVisualKit()"
                    class="btn-primary w-full h-12 flex items-center justify-center gap-2 rounded-xl text-sm font-semibold shadow-lg shadow-pink-500/20 hover:shadow-pink-500/40 transition-all">
                    <i data-feather="image" class="w-4 h-4"></i> Download Brand Kit
                </button>
                <button onclick="downloadJSON()"
                    class="btn-secondary w-full h-12 flex items-center justify-center gap-2 rounded-xl text-sm font-medium hover:bg-white/10 transition-all border border-white/10">
                    <i data-feather="code" class="w-4 h-4"></i> Download JSON
                </button>

                <!-- Advanced Toggle -->
                <div class="relative">
                    <button onclick="document.getElementById('advOptions').classList.toggle('hidden')"
                        class="w-full text-center text-[10px] text-gray-500 hover:text-white uppercase tracking-widest mt-2 cursor-pointer">
                        Advanced Options
                    </button>

                    <!-- Advanced Menu -->
                    <div id="advOptions"
                        class="hidden mt-2 space-y-2 bg-[#0B0A14] border border-white/10 p-2 rounded-lg">
                        <button onclick="exportSystemPrompt()"
                            class="btn-secondary w-full flex justify-center text-xs text-pink-300 border-pink-500/30">
                            <i data-feather="cpu" class="w-3 h-3"></i> AI Prompt
                        </button>
                        <button onclick="copyJSON()" class="btn-secondary w-full flex justify-center text-xs"
                            title="Copy JSON">
                            <i data-feather="copy" class="w-3 h-3"></i> Copy JSON to Clipboard
                        </button>
                        <button onclick="exportPrompt()" class="btn-secondary w-full flex justify-center text-xs"
                            title="Copy CSS">
                            <i data-feather="hash" class="w-3 h-3"></i> Copy CSS Variables
                        </button>
                    </div>
                </div>

            </div>
            <!-- Mobile Close -->
            <button onclick="toggleSidebar()"
                class="md:hidden w-full mt-4 bg-white/5 py-3 rounded text-sm text-gray-400">Close Menu</button>
        </div>
    </div>
    </div>

    </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal"
        class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-[#0B0A14] border border-white/10 rounded-xl p-6 w-[90%] max-w-sm shadow-2xl relative">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i
                    data-feather="x" class="w-5 h-5"></i></button>

            <h2 class="text-lg font-bold brand-font mb-6 flex items-center gap-2"><i data-feather="settings"
                    class="w-5 h-5 text-pink-500"></i> Settings</h2>

            <div class="space-y-4">
                <!-- Project Management -->
                <div class="space-y-2">
                    <p class="text-xs font-bold text-gray-500 uppercase">Project</p>
                    <div class="flex gap-2">
                        <button onclick="saveProject()"
                            class="btn-secondary flex-1 flex items-center justify-center gap-2"><i data-feather="save"
                                class="w-3 h-3"></i> Save</button>
                        <label class="btn-secondary flex-1 flex items-center justify-center gap-2 cursor-pointer">
                            <i data-feather="upload" class="w-3 h-3"></i> Load
                            <input type="file" id="loadInputModal" class="hidden" accept=".brand"
                                onchange="loadProject(this)">
                        </label>
                    </div>
                </div>

                <!-- API Key -->
                <div class="space-y-2">
                    <p class="text-xs font-bold text-gray-500 uppercase">AI Configuration</p>
                    <input type="password" id="apiKeyInputModal" placeholder="Paste Gemini API Key..."
                        class="w-full input-glass px-3 py-2 text-xs">
                    <button onclick="saveKey()" class="w-full btn-primary text-xs py-2">Save API Key</button>
                </div>

                <div class="border-t border-white/10 my-4"></div>

                <!-- Reset -->
                <button onclick="resetMemory()"
                    class="w-full text-xs text-red-400 hover:bg-red-400/10 py-2 rounded transition flex items-center justify-center gap-2 border border-red-400/20">
                    <i data-feather="trash-2" class="w-3 h-3"></i> Clear Memory & Reset Tool
                </button>
            </div>
        </div>
    </div>

    <!-- DEVICE CONTROLS (Overlay) -->
    <!-- DEVICE CONTROLS (Overlay) - REMOVED (Duplicate) -->

    <!-- PREVIEW AREA (With Width Control) -->
    <div id="livePreviewWrapper" class="flex-1 bg-[#1e1e1e] relative overflow-hidden flex flex-col">

        <!-- Toolbar -->
        <!-- Toolbar (Removed) -->
        <!-- Mobile Toolbar -->
        <div
            class="h-14 bg-[#0B0A14] border-b border-white/10 flex items-center justify-between px-4 z-20 shrink-0 md:hidden">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="text-gray-400 hover:text-white p-1">
                    <i data-feather="menu" class="w-5 h-5"></i>
                </button>
                <img src="https://reputifly.com/wp-content/uploads/2025/05/cropped-reputifly-new-e1746390492876.png"
                    alt="Reputifly" class="h-6 w-auto object-contain">
            </div>
        </div>

        <!-- The Resizable Frame -->
        <div id="livePreview"
            class="flex-1 w-full mx-auto transition-all duration-500 ease-out flex flex-col justify-center items-center p-4 md:p-10 relative overflow-y-auto no-scrollbar preview-frame"
            style="max-width: 100%;">
            <!-- Noise BG -->
            <div
                class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 pointer-events-none fixed-bg">
            </div>

            <div class="max-w-4xl w-full z-10">
                <div class="flex items-center justify-between mb-12 opacity-80">
                    <div class="flex items-center gap-2">
                        <img id="navLogo" class="h-8 w-auto object-contain hidden" alt="Brand Logo">
                        <span id="navText" class="font-bold text-2xl preview-h tracking-tight">BRAND.</span>
                    </div>
                    <button class="preview-btn px-6 py-2 text-sm font-bold shadow-md">Get Started</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
                    <div>
                        <span class="text-xs font-bold uppercase tracking-widest opacity-50 mb-4 block"
                            style="color: var(--p-accent)">Est. 2026</span>
                        <h1 class="text-4xl md:text-6xl font-bold mb-6 leading-tight preview-h">
                            Design that <span style="color: var(--p-accent)">converts.</span>
                        </h1>
                        <p class="text-lg opacity-70 mb-8 leading-relaxed">
                            Strict design tokens ensure your brand never drifts. We build consistency into the code
                            itself.
                        </p>
                        <div class="flex flex-col md:flex-row gap-4">
                            <button
                                class="preview-btn px-8 py-3 text-base font-bold shadow-lg hover:opacity-90 transition">Start
                                Project</button>
                            <button
                                class="px-8 py-3 text-base font-bold border border-current rounded-[var(--p-btn-radius)] hover:bg-black/5 transition">Learn
                                More</button>
                        </div>
                    </div>

                    <div class="space-y-4 mt-8 md:mt-0">
                        <div class="preview-card p-6 flex items-center gap-4 shadow-sm">
                            <div class="w-12 h-12 rounded bg-[var(--p-primary)] flex items-center justify-center"
                                style="color: var(--p-on-primary)">
                                <i data-feather="check"></i>
                            </div>
                            <div>
                                <h3 class="font-bold preview-h">Consistent</h3>
                                <p class="text-xs preview-muted">Never off-brand</p>
                            </div>
                        </div>
                        <div class="preview-card p-6 flex items-center gap-4 shadow-sm"
                            style="border-left: 4px solid var(--p-accent)">
                            <div
                                class="w-12 h-12 rounded bg-[var(--p-accent)] flex items-center justify-center text-white">
                                <i data-feather="zap"></i>
                            </div>
                            <div>
                                <h3 class="font-bold preview-h">Fast</h3>
                                <p class="text-xs preview-muted">Instant Extraction</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        feather.replace();
        const colorThief = new ColorThief();
        let currentRadius = '8px';
        let isPillMode = false;
        let activeTab = 'logo';

        function switchTab(mode) {
            activeTab = mode;
            const logoBtn = document.getElementById('tabLogo');
            const noLogoBtn = document.getElementById('tabNoLogo');
            const logoContent = document.getElementById('contentLogo');
            const noLogoContent = document.getElementById('contentNoLogo');

            if (mode === 'logo') {
                logoBtn.classList.add('text-pink-400', 'border-pink-400');
                logoBtn.classList.remove('text-gray-500', 'border-transparent');
                noLogoBtn.classList.add('text-gray-500', 'border-transparent');
                noLogoBtn.classList.remove('text-pink-400', 'border-pink-400');

                logoContent.classList.remove('hidden');
                noLogoContent.classList.add('hidden');
            } else {
                noLogoBtn.classList.add('text-pink-400', 'border-pink-400');
                noLogoBtn.classList.remove('text-gray-500', 'border-transparent');
                logoBtn.classList.add('text-gray-500', 'border-transparent');
                logoBtn.classList.remove('text-pink-400', 'border-pink-400');

                noLogoContent.classList.remove('hidden');
                logoContent.classList.add('hidden');
            }
        }


        function updateRadiusFromSlider(val) {
            currentRadius = val + 'px';
            document.getElementById('radiusVal').innerText = currentRadius;
            updatePreview();
        }

        function togglePill(checked) {
            isPillMode = checked;
            updatePreview();
        }

        // Helper for Export
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `rgb(${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)})` : null;
        }

        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            }).join('');
        }

        function blendColors(color1, color2, percentage) {
            const rgb1 = hexToRgbVals(color1);
            const rgb2 = hexToRgbVals(color2);
            if (!rgb1 || !rgb2) return color1;

            const r = Math.round(rgb1[0] * (1 - percentage) + rgb2[0] * percentage);
            const g = Math.round(rgb1[1] * (1 - percentage) + rgb2[1] * percentage);
            const b = Math.round(rgb1[2] * (1 - percentage) + rgb2[2] * percentage);
            return rgbToHex(r, g, b);
        }

        function adjustBrightness(hex, percent) {
            const rgb = hexToRgbVals(hex);
            if (!rgb) return hex;

            const r = Math.min(255, Math.max(0, rgb[0] + (rgb[0] * percent / 100)));
            const g = Math.min(255, Math.max(0, rgb[1] + (rgb[1] * percent / 100)));
            const b = Math.min(255, Math.max(0, rgb[2] + (rgb[2] * percent / 100)));
            return rgbToHex(r, g, b);
        }

        function generateSemanticTokens({ primary, accent, background, text }) {
            const bgLum = getLuminance(...hexToRgbVals(background));
            const isBgDark = bgLum < 0.5;

            // 1. DYNAMIC BUTTON TEXT (on-primary)
            // Decide if text on top of primary should be White or Black
            const primLum = getLuminance(...hexToRgbVals(primary));
            const onPrimary = primLum > 0.6 ? '#000000' : '#ffffff';

            // 2. SAFER HOVER LOGIC
            // User Rule: "If hover and button becomes same colour as text, that is wrong"
            // We modify primary to get hover.

            // Strategy: Darken or Lighten based on BG? 
            // Usually, if we are in Dark Mode, we lighten the button on hover? Or darken?
            // Standard: Darken is often safer for "pressed" feel, Lighten for "shine".
            // Let's try 15% darken by default.
            let hoverColor = adjustBrightness(primary, -15);

            // Check Contrast: Hover vs onPrimary
            let hoverContrast = getContrastRatio(hoverColor, onPrimary);

            // If bad contrast (e.g. Dark Button becomes Black on Hover, and Text is Black) -> Bad.
            if (hoverContrast < 3) {
                // Try Lightening instead
                const lightHover = adjustBrightness(primary, 20);
                const lightContrast = getContrastRatio(lightHover, onPrimary);

                if (lightContrast > hoverContrast) {
                    hoverColor = lightHover;
                } else {
                    // If both suck, force a tinted black/white
                    hoverColor = isBgDark ? '#ffffff' : '#000000'; // Extreme fallback
                }
            }

            // DOUBLE CHECK: Did we accidentally make the hover color == onPrimary?
            // (e.g. Button is White, Text is Black, Hover becomes Gray... might be ok).
            // (e.g. Button is Dark Gray, Text White. Hover becomes Black. Contrast is OK.)
            // The user specific concern: "hover and button becomes same colour as text"
            // means (HoverColor == onPrimary).
            // Visual check:
            if (getContrastRatio(hoverColor, onPrimary) < 1.5) {
                // FORCE DIFFERENCE
                hoverColor = adjustBrightness(primary, isBgDark ? 30 : -30);
            }

            return {
                surface: isBgDark ? blendColors(background, '#ffffff', 0.05) : blendColors(background, '#000000', 0.02),
                border: isBgDark ? blendColors(background, '#ffffff', 0.1) : blendColors(background, '#000000', 0.1),
                mutedText: isBgDark ? blendColors(text, '#ffffff', 0.5) : blendColors(text, '#000000', 0.3),
                primaryHover: hoverColor,
                onPrimary: onPrimary,
                focusRing: blendColors(primary, background, 0.5)
            };
        }

        // --- PERSISTENCE & EXPORT ---
        function getProjectState() {
            return {
                colors: {
                    primary: document.getElementById('colPrimary').value,
                    accent: document.getElementById('colAccent').value,
                    bg: document.getElementById('colBg').value,
                    text: document.getElementById('colText').value
                },
                typography: {
                    head: document.getElementById('fontHead').value,
                    body: document.getElementById('fontBody').value
                },
                ui: {
                    radius: document.getElementById('radiusInput').value,
                    pill: document.getElementById('pillToggle').checked,
                    shadow: document.getElementById('uiShadow').value,
                    glass: document.getElementById('uiGlass').value
                },
                meta: {
                    context: document.getElementById('brandContext').value,
                    image: document.getElementById('previewImg').src
                }
            };
        }

        function saveProject() {
            const state = getProjectState();
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `brand-${Date.now()}.brand`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadProject(input) {
            if (!input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const state = JSON.parse(e.target.result);

                    // Restore Colors
                    document.getElementById('colPrimary').value = state.colors.primary;
                    document.getElementById('colAccent').value = state.colors.accent;
                    document.getElementById('colBg').value = state.colors.bg;
                    document.getElementById('colText').value = state.colors.text;

                    // Restore Type
                    document.getElementById('fontHead').value = state.typography.head;
                    document.getElementById('fontBody').value = state.typography.body;

                    // Restore UI
                    document.getElementById('radiusInput').value = state.ui.radius;
                    updateRadiusFromSlider(state.ui.radius);
                    document.getElementById('pillToggle').checked = state.ui.pill;
                    togglePill(state.ui.pill);
                    document.getElementById('uiShadow').value = state.ui.shadow;
                    document.getElementById('uiGlass').value = state.ui.glass;

                    // Restore Meta
                    document.getElementById('brandContext').value = state.meta.context || "";
                    if (state.meta.image && state.meta.image.length > 50) {
                        document.getElementById('previewImg').src = state.meta.image;
                        document.getElementById('previewImg').classList.remove('hidden');
                        document.getElementById('uploadPlaceholder').classList.add('hidden');
                        switchTab('logo'); // Auto switch
                    } else if (state.meta.context) {
                        switchTab('nologo');
                    }

                    updateColorInputs(state.colors.primary, state.colors.accent, state.colors.bg, state.colors.text);
                    alert("Project Loaded Successfully!");

                } catch (err) {
                    console.error(err);
                    alert("Invalid .brand file!");
                }
            };
            reader.readAsText(input.files[0]);
        }

        function copyJSON() {
            const data = getBrandData();
            navigator.clipboard.writeText(JSON.stringify(data, null, 2));
            alert("Brand Data copied to clipboard!");
        }

        // TAILWIND REMOVED PER REQUEST


        function exportSystemPrompt() {
            const state = getProjectState();
            const semantic = generateSemanticTokens({
                primary: state.colors.primary,
                accent: state.colors.accent,
                background: state.colors.bg,
                text: state.colors.text
            });

            const prompt = `
### ROLE
You are a Senior Frontend Engineer / Design System Architect.
Your goal is to build a pixel-perfect implementation using **plain HTML/CSS/JS** (or requested framework) that STRICTLY follows the Brand Identity below.

### 0. CRITICAL INSTRUCTION
You must generally **extend** frameworks with these tokens.
HOWEVER: If you detect **obvious visual bugs** (e.g. invalid contrast, 4px illegible font size, or broken layout) using these strict tokens, you are **AUTHORIZED TO INNOVATE**.
- Fix contrast issues automatically (e.g. darken a color if text is unreadable).
- Adjust spacing/sizing if the strict values break the design.
- **Goal**: Strict adherence to Brand Identity, but **perfect utilization** of it. Do not blindly follow broken rules.

### 1. STRICT DESIGN TOKENS(JSON)
        \`\`\`json
{
  "colors": {
    "primary": "${state.colors.primary}",
    "on_primary": "${semantic.onPrimary}",
    "primary_hover": "${semantic.primaryHover}",
    "accent": "${state.colors.accent}",
    "background": "${state.colors.bg}",
    "text": "${state.colors.text}",
    "surface": "${semantic.surface}",
    "border": "${semantic.border}",
    "muted": "${semantic.mutedText}"
  },
  "typography": {
    "heading_font": "${state.typography.head}",
    "body_font": "${state.typography.body}"
  },
  "ui": {
    "radius": "${state.ui.pill ? '9999px' : state.ui.radius + 'px'}",
    "shadow": "${state.ui.shadow}",
    "glass": ${state.ui.glass === 'none' ? false : true}
  }
}
\`\`\`

### 2. IMPLEMENTATION RULES
1. **NEVER Hardcode Hex Values**: Always use CSS variables (see Mapping below).
2. **Primary Utility**: Use \`bg-[var(--primary)]\` and \`text-[var(--on-primary)]\` for main actions.
3. **Hover Safety**: You MUST use the provided \`primary_hover\` color for hover states. 
   - CSS: \`:hover { background: var(--primary-hover); }\`
   - CHECK: Ensure that text contrast remains legible on hover.
4. **Typography**: Use the specified Google Fonts.
5. **Spacing**: Use \`rem\` for all layout spacing.

### 3. CSS VARIABLE MAPPING
:root {
  --primary: ${state.colors.primary};
  --primary-hover: ${semantic.primaryHover};
  --on-primary: ${semantic.onPrimary};
  --bg: ${state.colors.bg};
  --text: ${state.colors.text};
  --radius: ${state.ui.pill ? '9999px' : state.ui.radius + 'px'};
}
`;
            navigator.clipboard.writeText(prompt);
            alert("Strict System Prompt copied! (Includes JSON Schema & Safety Rules)");
        }

        // --- UI FUNCTIONS ---
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const bd = document.getElementById('mobileBackdrop');
            const isClosed = sb.classList.contains('-translate-x-full');

            if (isClosed) {
                sb.classList.remove('-translate-x-full');
                bd.classList.remove('hidden');
            } else {
                sb.classList.add('-translate-x-full');
                bd.classList.add('hidden');
            }
        }

        // Device Switcher Removed

        // RESET FUNCTION
        function resetMemory() {
            if (confirm("Are you sure? This will clear all saved data, API keys, and reload the page.")) {
                localStorage.removeItem('reputifly_gemini_key');
                localStorage.removeItem('reputifly_autosave');
                window.location.reload();
            }
        }

        // Auto-Save simple hook
        setInterval(() => {
            const state = getProjectState();
            localStorage.setItem('reputifly_autosave', JSON.stringify(state));
        }, 30000); // Every 30s

        function handleImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('previewImg');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('uploadPlaceholder').classList.add('hidden');

                    // Wait for image load then extract colors
                    img.onload = () => extractColorsLocally(img);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function extractColorsLocally(img) {
            try {
                // Get Dominant Color (Primary)
                const dom = colorThief.getColor(img);
                const palette = colorThief.getPalette(img, 5); // Get 5 colors

                const primaryHex = rgbToHex(...dom);
                // Simple logic: Accent is the color most different from Primary in the palette
                const accentHex = rgbToHex(...(palette[1] || dom));
                const bgHex = isLight(dom) ? '#ffffff' : '#0f172a'; // Guess BG based on Primary brightness
                const textHex = isLight(dom) ? '#1e293b' : '#f8fafc';

                // Apply to UI
                updateColorInputs(primaryHex, accentHex, bgHex, textHex);

                // Show AI Option if Key exists
                if (localStorage.getItem('reputifly_gemini_key')) {
                    document.getElementById('aiBtn').classList.remove('hidden');
                }

            } catch (e) {
                console.error("Color Extraction Failed", e);
                alert("Could not extract colors automatically. Please pick manually.");
            }
        }

        function isLight(rgb) {
            // Brightness formula
            return ((rgb[0] * 299 + rgb[1] * 587 + rgb[2] * 114) / 1000) > 125;
        }

        // --- 2. AI LOGIC (GEMINI 2.5 FLASH) ---
        async function askAI() {
            const key = localStorage.getItem('reputifly_gemini_key');
            if (!key) return alert("Please save API Key first!");

            const img = document.getElementById('previewImg');
            const contextText = document.getElementById('brandContext').value;

            // Check if we have input
            const hasImage = !img.classList.contains('hidden') && img.src;
            const hasText = contextText && contextText.trim().length > 0; // Fix: check exists first

            if (!hasImage && !hasText) return alert("Please upload an image OR enter a brand description!");

            const btn = document.getElementById('aiBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-feather="loader" class="w-3 h-3 animate-spin"></i> Dreaming...';
            feather.replace();

            try {
                // Determine Intent from Active Tab
                let prompt = "";

                if (activeTab === 'logo') {
                    if (!img.src || img.classList.contains('hidden')) return alert("Please upload a logo in 'Logo Available' mode.");
                    prompt = `You are a Senior Brand Designer. Analyze this logo. 
                        Extract the TRUE brand colors. Ignore container backgrounds.
                        Predict the best 'Background' and 'Text' colors for a high-end web design.
                        Return strictly raw JSON (no markdown).`;
                } else {
                    if (contextText.trim().length === 0) return alert("Please enter a description in 'Start from Scratch' mode.");
                    prompt = `You are a Senior Brand Designer. Create a complete brand identity from scratch for this business: "${contextText}".
                        Generate a color palette, typography and UI vibe that perfectly fits this description.
                        Return strictly raw JSON (no markdown).`;
                }

                // Append Schema
                prompt += `
                Structure:
                {
                  "colors": { "primary": "#hex", "accent": "#hex", "background": "#hex", "text": "#hex" },
                  "typography": { "heading": "FontName", "body": "FontName" },
                  "ui": { "radius": "0|2|8|16|24", "shadow": "none|soft|heavy|retro", "glass": "none|blur(12px)" },
                  "reasoning": "One short sentence explaining the design choice."
                }
                Valid Fonts: 'Inter', 'Playfair Display', 'Space Grotesk', 'Roboto'.
                Valid Shadows: 'none' (Flat), 'soft', 'heavy', 'retro'.
                `;

                const parts = [{ text: prompt }];
                if (activeTab === 'logo' && hasImage) {
                    const base64 = img.src.split(',')[1];
                    parts.push({ inline_data: { mime_type: "image/jpeg", data: base64 } });
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: parts }] })
                });

                const data = await response.json();
                if (!data.candidates) throw new Error("No candidates received");

                let text = data.candidates[0].content.parts[0].text;
                // Clean markdown if present
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const json = JSON.parse(text);

                console.log("AI Analysis:", json);

                // Apply Colors
                document.getElementById('colPrimary').value = json.colors.primary;
                document.getElementById('colAccent').value = json.colors.accent;
                document.getElementById('colBg').value = json.colors.background;
                document.getElementById('colText').value = json.colors.text;

                // Apply Typography
                const setSelect = (id, val) => {
                    const sel = document.getElementById(id);
                    for (let i = 0; i < sel.options.length; i++) {
                        if (sel.options[i].value.includes(val)) { sel.selectedIndex = i; break; }
                    }
                };
                setSelect('fontHead', json.typography.heading);
                setSelect('fontBody', json.typography.body);

                // Apply UI
                document.getElementById('radiusInput').value = json.ui.radius;
                updateRadiusFromSlider(json.ui.radius);

                // Shadow map
                const shadowMap = {
                    'none': 'none',
                    'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                    'heavy': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    'retro': '4px 4px 0px 0px rgba(0,0,0,1)'
                };
                const shadowVal = shadowMap[json.ui.shadow] || 'none';
                document.getElementById('uiShadow').value = shadowVal;

                // Glass
                document.getElementById('uiGlass').value = json.ui.glass === 'blur(12px)' ? 'blur(12px)' : 'none';

                // Trigger Updates
                updateColorInputs(json.colors.primary, json.colors.accent, json.colors.background, json.colors.text);

                alert(` AI Refined: ${json.reasoning}`);

            } catch (e) {
                console.error(e);
                alert("AI Error: " + e.message);
            }
            btn.innerHTML = originalText;
            feather.replace();
        }

        // --- 3. SHARED LOGIC ---
        function updateColorInputs(p, a, b, t) {
            document.getElementById('colPrimary').value = p; document.getElementById('hexPrimary').innerText = p;
            document.getElementById('colAccent').value = a; document.getElementById('hexAccent').innerText = a;
            document.getElementById('colBg').value = b; document.getElementById('hexBg').innerText = b;
            document.getElementById('colText').value = t; document.getElementById('hexText').innerText = t;
            updatePreview();
        }

        function updatePreview() {
            const root = document.getElementById('livePreview');
            const p = document.getElementById('colPrimary').value;
            const a = document.getElementById('colAccent').value;
            const b = document.getElementById('colBg').value;
            const t = document.getElementById('colText').value;

            // 1. Colors & Type
            root.style.setProperty('--p-primary', p);
            root.style.setProperty('--p-accent', a);
            root.style.setProperty('--p-bg', b);
            root.style.setProperty('--p-text', t);

            const fh = document.getElementById('fontHead').value.split(',')[0].replace(/'/g, "");
            const fb = document.getElementById('fontBody').value.split(',')[0].replace(/'/g, "");
            root.style.setProperty('--p-font-head', fh);
            root.style.setProperty('--p-font-body', fb);

            // 2. Radius Logic (Sync or Pill)
            root.style.setProperty('--p-radius', currentRadius);
            root.style.setProperty('--p-btn-radius', isPillMode ? '999px' : currentRadius);

            // 3. Logo Injection Logic
            const uploadedImg = document.getElementById('previewImg');
            const navLogo = document.getElementById('navLogo');
            const navText = document.getElementById('navText');

            if (!uploadedImg.classList.contains('hidden') && uploadedImg.src) {
                navLogo.src = uploadedImg.src;
                navLogo.classList.remove('hidden');
                navText.classList.add('hidden');
            } else {
                navLogo.classList.add('hidden');
                navText.classList.remove('hidden');
            }

            // 4. Shadow & Glass Logic
            const shadow = document.getElementById('uiShadow') ? document.getElementById('uiShadow').value : 'none';
            const glass = document.getElementById('uiGlass') ? document.getElementById('uiGlass').value : 'none';

            root.style.setProperty('--p-shadow', shadow);
            if (glass && glass !== 'none') {
                root.style.setProperty('--p-card-bg', 'rgba(255,255,255,0.5)');
                root.style.setProperty('--p-blur', glass);
            } else {
                root.style.setProperty('--p-card-bg', 'rgba(128,128,128,0.05)');
                root.style.setProperty('--p-blur', 'none');
            }

            // 5. Semantic Tokens
            const semantic = generateSemanticTokens({ primary: p, accent: a, background: b, text: t });
            root.style.setProperty('--p-surface', semantic.surface);
            root.style.setProperty('--p-border', semantic.border);
            root.style.setProperty('--p-muted', semantic.mutedText);
            root.style.setProperty('--p-primary-hover', semantic.primaryHover);
            root.style.setProperty('--p-on-primary', semantic.onPrimary); // NEW
            root.style.setProperty('--p-focus-ring', semantic.focusRing);


            // 6. Accessibility Checks
            checkContrast(p, a, b, t);
        }

        // --- ACCESSIBILITY LOGIC ---
        function getLuminance(r, g, b) {
            var a = [r, g, b].map(function (v) {
                v /= 255;
                return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
            });
            return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
        }

        function getContrastRatio(hex1, hex2) {
            const rgb1 = hexToRgbVals(hex1);
            const rgb2 = hexToRgbVals(hex2);
            if (!rgb1 || !rgb2) return 0;
            const lum1 = getLuminance(rgb1[0], rgb1[1], rgb1[2]);
            const lum2 = getLuminance(rgb2[0], rgb2[1], rgb2[2]);
            const brightest = Math.max(lum1, lum2);
            const darkest = Math.min(lum1, lum2);
            return (brightest + 0.05) / (darkest + 0.05);
        }

        function hexToRgbVals(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : null;
        }

        function checkContrast(p, a, b, t) {
            // 1. Primary Button Logic 
            // We now use dynamic text color (onPrimary) so we check that.
            // But for the WARN UI, we want to know if the user *needs* to fix something manually?
            // Actually, we are fixing the button text color AUTOMATICALLY now.
            // So we mainly need to warn if the Primary is so weird that neither black nor white works? (Rare)

            // Let's check contrast of Primary against Background instead (Visibility of button shape)
            const ratioPrimBg = getContrastRatio(p, b);
            const warnPrimVal = document.getElementById('warnPrimary');

            // Warn if button blends into background too much (Ghost button risk)
            if (ratioPrimBg < 1.5) {
                warnPrimVal.classList.remove('hidden');
                warnPrimVal.querySelector('span').innerHTML = '<i data-feather="alert-circle" class="w-3 h-3"></i> Blends with BG';
            } else {
                warnPrimVal.classList.add('hidden');
            }

            // 2. Accent Visibility (Accent vs BG)
            const ratioAccent = getContrastRatio(a, b);
            const warnAccentVal = document.getElementById('warnAccent');
            if (ratioAccent < 3) { // Graphic elements need 3:1
                warnAccentVal.classList.remove('hidden');
            } else {
                warnAccentVal.classList.add('hidden');
            }

            // 3. Body Text (Text vs BG)
            const ratioText = getContrastRatio(t, b);
            const warnTextVal = document.getElementById('warnText');
            if (ratioText < 4.5) {
                warnTextVal.classList.remove('hidden');
            } else {
                warnTextVal.classList.add('hidden');
            }
            feather.replace();
        }

        function fixContrast(type) {
            const b = document.getElementById('colBg').value;

            if (type === 'text') {
                // Determine if BG is dark or light, set text to white/black
                const bgLum = getLuminance(...hexToRgbVals(b));
                const newText = bgLum > 0.5 ? '#1e293b' : '#f8fafc';
                document.getElementById('colText').value = newText;
            } else if (type === 'primary') {
                // darkening Primary until it passes against white
                // OR flip text color? For now, let's just darken the primary if it's too light for white text
                let p = document.getElementById('colPrimary').value;
                // Simple hack: if too light, just set to a safe blue
                document.getElementById('colPrimary').value = '#2563eb';
            } else if (type === 'accent') {
                // Adjust accent to separate from BG
                // If bg is light, darken accent. If bg is dark, lighten accent.
                const bgLum = getLuminance(...hexToRgbVals(b));
                const newAccent = bgLum > 0.5 ? '#be185d' : '#f472b6';
                document.getElementById('colAccent').value = newAccent;
            }

            // Update UI
            updateColorInputs(
                document.getElementById('colPrimary').value,
                document.getElementById('colAccent').value,
                document.getElementById('colBg').value,
                document.getElementById('colText').value
            );
        }
        function invertTheme() {
            const bg = document.getElementById('colBg').value;
            const tx = document.getElementById('colText').value;

            // Simple Swap
            document.getElementById('colBg').value = tx;
            document.getElementById('colText').value = bg;

            // Update UI
            updateColorInputs(
                document.getElementById('colPrimary').value,
                document.getElementById('colAccent').value,
                tx, // New BG is Old Text
                bg  // New Text is Old BG
            );
        }

        function setRadius(r) { currentRadius = r; updatePreview(); }

        function saveKey() {
            const k = document.getElementById('apiKeyInput').value;
            if (k) { localStorage.setItem('reputifly_gemini_key', k); document.getElementById('apiKeyBox').classList.add('hidden'); alert("Key Saved! AI Mode Unlocked."); document.getElementById('aiBadge').innerText = "AI Active"; document.getElementById('aiBadge').classList.replace('text-gray-600', 'text-pink-400'); document.getElementById('aiBadge').classList.replace('border-gray-700', 'border-pink-500'); }
        }

        function getBrandData() {
            return {
                colors: {
                    primary: document.getElementById('colPrimary').value,
                    accent: document.getElementById('colAccent').value,
                    background: document.getElementById('colBg').value,
                    text: document.getElementById('colText').value
                },
                typography: {
                    heading: document.getElementById('fontHead').value.split(',')[0].replace(/'/g, ""),
                    body: document.getElementById('fontBody').value.split(',')[0].replace(/'/g, "")
                },
                ui: {
                    radius: currentRadius,
                    shadow: document.getElementById('uiShadow').value,
                    glass: document.getElementById('uiGlass').value
                },
                semantic: generateSemanticTokens({
                    primary: document.getElementById('colPrimary').value,
                    accent: document.getElementById('colAccent').value,
                    background: document.getElementById('colBg').value,
                    text: document.getElementById('colText').value
                })
            };
        }

        function downloadJSON() {
            const data = getBrandData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "brand_dna.json";
            a.click();
        }

        function exportPrompt() {
            exportSystemPrompt(); // Default to the strict one now? No, user might want just CSS.
            // Let's keep this as 'Copy CSS'
            const d = getBrandData();
            let css = `:root { 
    /* Base Colors */
    --primary: ${d.colors.primary};
    --on-primary: ${d.semantic.onPrimary};
    --primary-hover: ${d.semantic.primaryHover};
    --accent: ${d.colors.accent}; 
    --bg: ${d.colors.background}; 
    --text: ${d.colors.text}; 

    /* Semantic Tokens */
    --surface: ${d.semantic.surface};
    --border: ${d.semantic.border};
    --muted: ${d.semantic.mutedText};
    --primary-hover: ${d.semantic.primaryHover};
    --focus-ring: ${d.semantic.focusRing};

    /* Typography & UI */
    --font-head: ${d.typography.heading}; 
    --font-body: ${d.typography.body}; 
    --radius: ${d.ui.radius}; 
    --shadow: ${d.ui.shadow}; 
}`;
            navigator.clipboard.writeText(css);
            alert("CSS Variables copied to clipboard!");
        }

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                // Sync load button in modal
            } else {
                modal.classList.add('hidden');
            }
        }

        function resetColor(id) {
            const el = document.getElementById(id);
            const original = el.getAttribute('data-original');
            if (original) {
                el.value = original;
                updatePreview();

                // Update text display
                const type = id.replace('col', ''); // Primary, Accent, etc
                const hexDisplay = document.getElementById('hex' + type);
                if (hexDisplay) hexDisplay.innerText = original;
            }
        }

        function downloadVisualKit() {
            // Button loading state
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-feather="loader" class="w-4 h-4 animate-spin"></i> Generating PDF...`;
            feather.replace();

            const d = getBrandData();
            const logoSrc = document.getElementById('previewImg').src;
            const logoHTML = (!document.getElementById('previewImg').classList.contains('hidden'))
                ? `<img src="${logoSrc}" style="height: 60px; object-fit:contain;">`
                : `<h1 style="font-size: 40px; font-family:${d.typography.heading}; margin:0;">BRAND.</h1>`;

            // Create temporary container
            const container = document.createElement('div');
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            container.style.top = '0';
            container.style.width = '800px';
            document.body.appendChild(container);

            const fontHead = d.typography.heading;
            const fontBody = d.typography.body;
            const fontLink = `https://fonts.googleapis.com/css2?family=${fontHead.replace(/ /g, '+')}:wght@400;600;700&family=${fontBody.replace(/ /g, '+')}:wght@400;600;700&display=swap`;

            // Render content
            container.innerHTML = `
                <!-- Inject Font Link specifically for the export container -->
                <link href="${fontLink}" rel="stylesheet">
                <div class="pdf-wrapper" style="font-family: ${d.typography.body}; background: white; color: black; padding: 40px; width: 800px;">
                    <style>
                        .pdf-page { width: 100%; min-height: 100vh; } 
                        .header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 60px; border-bottom: 1px solid #eee; padding-bottom: 40px; }
                        .meta { font-family: monospace; font-size: 10px; text-transform: uppercase; opacity: 0.6; text-align: right; }
                        h1, h2, h3 { font-family: ${d.typography.heading}; margin: 0; font-weight: 700; }
                        h1 { font-size: 36px; line-height: 1.2; }
                        h2 { font-size: 28px; line-height: 1.3; }
                        h3 { font-size: 20px; line-height: 1.4; }
                        .section-title { font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; color: ${d.colors.accent}; margin-bottom: 30px; border-top: 1px solid #ccc; padding-top: 20px; margin-top: 60px; }
                        .color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
                        .swatch { height: 100px; border-radius: ${d.ui.radius}; margin-bottom: 15px; border: 1px solid #eee; }
                        .color-meta h3 { font-size: 14px; margin-bottom: 4px; }
                        .color-meta p { font-size: 10px; opacity: 0.5; font-family: monospace; }
                        .token-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; }
                        .token-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
                        .token-swatch { width: 30px; height: 30px; border-radius: 50%; margin: 0 auto 8px auto; border: 1px solid #ddd; }
                        .token-name { font-size: 10px; opacity: 0.7; }
                        /* Type */
                        .type-row { display: grid; grid-template-columns: 150px 1fr; gap: 40px; margin-bottom: 40px; page-break-inside: avoid; }
                        /* Increased visibility for Type Labels */
                        .type-label { font-size: 11px; opacity: 1.0; font-weight: 600; color: #555; border-bottom: 1px solid #ddd; padding-bottom: 5px; align-self: start; }
                        
                        /* Mock UI */
                        .ui-showcase { 
                            background: ${d.semantic.surface};
                            border: 1px solid ${d.semantic.border};
                            border-radius: 20px;
                            padding: 40px;
                            display: flex;
                            flex-wrap: wrap;
                            gap: 40px;
                            justify-content: center;
                            align-items: center;
                            page-break-inside: avoid; /* Prevent slicing */
                        }

                        /* Force Page Break */
                        .force-break { page-break-before: always; }

                        .mock-card { background: white; border: 1px solid #ddd; border-radius: ${d.ui.radius}; padding: 20px; width: 240px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
                        .mock-line { height: 10px; background: #eee; border-radius: 100px; margin-bottom: 10px; width: 100%; }
                        .mock-btn { background: ${d.colors.primary}; color: #fff; border-radius: ${d.ui.radius === '99px' || isPillMode ? '999px' : d.ui.radius}; padding: 10px 20px; font-size: 12px; font-weight: bold; border: none; display: block; width: 100%; margin-top: 15px; text-align: center; }
                         .mock-alert { background: ${d.colors.accent}15; border: 1px solid ${d.colors.accent}40; color: ${d.colors.accent}; padding: 15px 20px; border-radius: ${d.ui.radius}; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 10px; }
                         .mock-dot { width: 8px; height: 8px; background: currentColor; border-radius: 50%; }
                        
                        /* Hide original body content styles if leaked */
                        /* But since we are in a container, we just use specific classes */
                    </style>

                    <div class="pdf-page">
                        <div class="header">
                            <div>${logoHTML}</div>
                            <div class="meta">Brand Identity System<br>Generated by Reputifly<br>${new Date().toLocaleDateString()}</div>
                        </div>

                        <div class="section-title">01. Core Palette</div>
                        <div class="color-grid">
                            <div class="swatch-card"><div class="swatch" style="background:${d.colors.primary}"></div><div class="color-meta"><h3>Primary</h3><p>${d.colors.primary}</p></div></div>
                            <div class="swatch-card"><div class="swatch" style="background:${d.colors.accent}"></div><div class="color-meta"><h3>Accent</h3><p>${d.colors.accent}</p></div></div>
                            <div class="swatch-card"><div class="swatch" style="background:${d.colors.background}; border: 1px solid #ddd;"></div><div class="color-meta"><h3>Background</h3><p>${d.colors.background}</p></div></div>
                            <div class="swatch-card"><div class="swatch" style="background:${d.colors.text}; border: 1px solid #ddd;"></div><div class="color-meta"><h3>Text</h3><p>${d.colors.text}</p></div></div>
                        </div>

                        <div class="section-title">02. Semantic Tokens</div>
                        <div class="token-grid">
                             <div class="token-card"><div class="token-swatch" style="background:${d.semantic.surface}"></div><div class="token-name">Surface</div></div>
                             <div class="token-card"><div class="token-swatch" style="background:${d.semantic.border}"></div><div class="token-name">Border</div></div>
                             <div class="token-card"><div class="token-swatch" style="background:${d.semantic.mutedText}"></div><div class="token-name">Muted</div></div>
                             <div class="token-card"><div class="token-swatch" style="background:${d.semantic.primaryHover}"></div><div class="token-name">Primary Hover</div></div>
                             <div class="token-card"><div class="token-swatch" style="background:${d.semantic.focusRing}"></div><div class="token-name">Focus Ring</div></div>
                        </div>

                        <div class="section-title">03. Typography</div>
                        <div class="type-row">
                            <div class="type-label">Headings<br>${d.typography.heading}</div>
                            <div class="type-example"><h1 style="font-family:${d.typography.heading}">Strategic Design.<br>Brand Consistency.</h1></div>
                        </div>
                        <div class="type-row">
                            <div class="type-label">Body Copy<br>${d.typography.body}</div>
                            <div class="type-example"><p style="font-family:${d.typography.body}">Consistency builds trust. This typography system is designed to ensure optimal readability.</p></div>
                        </div>

                        <div class="div-spacer" style="margin-bottom: 40px;"></div>
                        
                        <!-- Forced Page Break before UI Elements: html2pdf specific class -->
                        <div class="html2pdf__page-break"></div>
                        <div class="section-title" style="margin-top: 0; padding-top: 40px; border-top: none;">04. UI Elements</div>
                        <div class="ui-showcase">
                            <div class="mock-card">
                                <div class="mock-line" style="width: 30px; height: 30px; border-radius: 50%; margin-bottom: 15px; background: #eee;"></div>
                                <div class="mock-line" style="width: 60%"></div>
                                <div class="mock-line" style="width: 80%"></div>
                                <button class="mock-btn">Primary Action</button>
                            </div>
                            <div class="mock-alert">
                                 <div class="mock-dot"></div>
                                 <span>System Access Granted</span>
                            </div>
                        </div>
                    </div>
                </div>`;

            // Config for html2pdf
            const opt = {
                margin: 0,
                filename: 'Brand_Identity_Kit.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Generate
            html2pdf().from(container.querySelector('.pdf-wrapper')).set(opt).save()
                .then(() => {
                    document.body.removeChild(container);
                    btn.innerHTML = originalText;
                })
                .catch(err => {
                    console.error(err);
                    alert("Error generating PDF. Please ensure your logo is valid.");
                    document.body.removeChild(container);
                    btn.innerHTML = originalText;
                });
        }

        // Init
        if (localStorage.getItem('reputifly_gemini_key')) {
            document.getElementById('aiBadge').innerText = "AI Active";
            document.getElementById('aiBadge').className = "text-[10px] text-pink-400 border border-pink-500 px-1 rounded";
        }
    </script>
</body>

</html>
